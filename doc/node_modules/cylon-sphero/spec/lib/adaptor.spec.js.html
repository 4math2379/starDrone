<!DOCTYPE html>
<html>
<head>
  <title>adaptor.spec.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../";
    var thisFile = "node_modules/cylon-sphero/spec/lib/adaptor.spec.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>adaptor.spec.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-keyword">var</span> Adaptor = lib(<span class="hljs-string">"adaptor"</span>),
    Commands = lib(<span class="hljs-string">"commands"</span>);

<span class="hljs-keyword">var</span> Cylon = <span class="hljs-built_in">require</span>(<span class="hljs-string">"cylon"</span>);

describe(<span class="hljs-string">"Adaptor"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> sphero, opts;

  beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    opts = { <span class="hljs-attr">port</span>: <span class="hljs-string">"/dev/rfcomm0"</span> };
    sphero = <span class="hljs-keyword">new</span> Adaptor(opts);
    Cylon.Logger = {
      <span class="hljs-attr">info</span>: stub(),
      <span class="hljs-attr">error</span>: stub()
    };
  });

  afterEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  });

  describe(<span class="hljs-string">"constructor"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      opts = { <span class="hljs-attr">port</span>: <span class="hljs-string">"/dev/rfcomm0"</span>, <span class="hljs-attr">locatorOpts</span>: <span class="hljs-string">"opts"</span> };
      stub(Adaptor.prototype, <span class="hljs-string">"proxyMethods"</span>);
      sphero = <span class="hljs-keyword">new</span> Adaptor(opts);
    });

    afterEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      Adaptor.prototype.proxyMethods.restore();
    });

    it(<span class="hljs-string">"sets @sphero to a sphero.js instance"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      expect(sphero.sphero).to.not.be.null;
    });

    it(<span class="hljs-string">"sets @connector to the Sphero instance"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      expect(sphero.connector).to.not.be.null;
    });

    it(<span class="hljs-string">"sets @locatorOpts to the provided options"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      expect(sphero.locatorOpts).to.be.eql(<span class="hljs-string">"opts"</span>);
    });

    it(<span class="hljs-string">"sets two bitmasks to 0x00000000"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      expect(sphero.mask1).to.be.eql(<span class="hljs-number">0x00000000</span>);
      expect(sphero.mask2).to.be.eql(<span class="hljs-number">0x00000000</span>);
    });

    it(<span class="hljs-string">"proxies Sphero commands from the Adaptor to the Sphero"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      expect(sphero.proxyMethods).to.be.calledWith(
        Commands,
        sphero.sphero,
        sphero
      );
    });

    context(<span class="hljs-string">"if opts are NOT provided"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      it(<span class="hljs-string">"throws an error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> fn = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Adaptor(); };
        expect(fn).to.throw(
          <span class="hljs-string">"No port specified for Sphero adaptor 'undefined'. Cannot proceed"</span>
        );
      });
    });

    context(<span class="hljs-string">"if no port is specified"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      it(<span class="hljs-string">"throws an error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> fn = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Adaptor({ <span class="hljs-attr">name</span>: <span class="hljs-string">"hi"</span> }); };
        expect(fn).to.throw(
          <span class="hljs-string">"No port specified for Sphero adaptor 'hi'. Cannot proceed"</span>
        );
      });
    });
  });

  describe(<span class="hljs-string">"#commands"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    it(<span class="hljs-string">"is an array of Sphero commands"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      expect(sphero.commands).to.be.eql(Commands);
    });
  });

  describe(<span class="hljs-string">"#connect"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> emitter, callback;

    beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      callback = spy();
      emitter = { <span class="hljs-attr">on</span>: stub(), <span class="hljs-attr">connect</span>: stub() };
      sphero.connector = sphero.sphero = emitter;
      sphero.sphero.connect.yields();
      sphero.emit = spy();

      stub(sphero, <span class="hljs-string">"defineAdaptorEvent"</span>);
    });

    afterEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      sphero.defineAdaptorEvent.restore();
    });

    context(<span class="hljs-string">"when the Sphero connection opens"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        emitter.on.withArgs(<span class="hljs-string">"open"</span>).yields();
      });

      it(<span class="hljs-string">"triggers the provided callback"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        sphero.connect(callback);
        expect(callback).to.be.called;
      });
    });

    it(<span class="hljs-string">"defines adaptor events"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> d = sphero.defineAdaptorEvent;

      sphero.connect(callback);

      expect(d).to.be.calledWith({ <span class="hljs-attr">event</span>: <span class="hljs-string">"open"</span>, <span class="hljs-attr">targetEvent</span>: <span class="hljs-string">"connect"</span> });
      expect(d).to.be.calledWith(<span class="hljs-string">"connect"</span>);
      expect(d).to.be.calledWith(<span class="hljs-string">"disconnect"</span>);
      expect(d).to.be.calledWith(<span class="hljs-string">"error"</span>);
      expect(d).to.be.calledWith(<span class="hljs-string">"response"</span>);
      expect(d).to.be.calledWith(<span class="hljs-string">"async"</span>);
      expect(d).to.be.calledWith(<span class="hljs-string">"data"</span>);
      expect(d).to.be.calledWith(<span class="hljs-string">"collision"</span>);
      expect(d).to.be.calledWith(<span class="hljs-string">"version"</span>);
      expect(d).to.be.calledWith(<span class="hljs-string">"bluetoothInfo"</span>);
      expect(d).to.be.calledWith(<span class="hljs-string">"powerStateInfo"</span>);
      expect(d).to.be.calledWith(<span class="hljs-string">"readLocator"</span>);
      expect(d).to.be.calledWith(<span class="hljs-string">"battery"</span>);
      expect(d).to.be.calledWith(<span class="hljs-string">"dataStreaming"</span>);
    });

    it(<span class="hljs-string">"opens a connection to the Sphero"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      sphero.connect(callback);
      expect(sphero.connector.connect).to.be.calledOnce;
      expect(callback).to.be.calledOnce;
    });

    context(<span class="hljs-string">"if an error occurs while connecting to the Sphero"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> err = { <span class="hljs-attr">error</span>: <span class="hljs-string">"something bad happened"</span> };

      beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        sphero.sphero.connect.yields(err);
      });

      it(<span class="hljs-string">"emits a 'err' event with the error object"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        sphero.connect(callback);
        expect(sphero.emit).to.be.calledWith(<span class="hljs-string">"error"</span>, err);
      });
    });
  });

  describe(<span class="hljs-string">"#disconnect"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> callback;

    beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      callback = spy();
      sphero.sphero = { <span class="hljs-attr">disconnect</span>: stub(), <span class="hljs-attr">roll</span>: spy() };
      sphero.sphero.disconnect.yields();
      sphero.sphero.once = sphero.sphero.disconnect;
    });

    it(<span class="hljs-string">"closes the connection to the Sphero"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      sphero.disconnect(callback);
      expect(sphero.sphero.disconnect).to.be.called;
    });

    it(<span class="hljs-string">"stops the sphero"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      sphero.disconnect(callback);
      expect(callback).to.be.calledOnce;
    });
  });

  describe(<span class="hljs-string">"setDataStreaming"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> sds;

    beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      sphero.sphero = { <span class="hljs-attr">setDataStreaming</span>: stub() };
      sds = sphero.sphero.setDataStreaming;
    });

    it(<span class="hljs-string">"sends data to the Sphero's setDataStreaming method"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      sphero.setDataStreaming({
        <span class="hljs-attr">dataSources</span>: [<span class="hljs-string">"odometer"</span>, <span class="hljs-string">"velocity"</span>]
      });
      expect(sds).to.be.calledWith({
        <span class="hljs-attr">dataSources</span>: [<span class="hljs-string">"odometer"</span>, <span class="hljs-string">"velocity"</span>],
        <span class="hljs-attr">mask1</span>: <span class="hljs-number">0x00000000</span>,
        <span class="hljs-attr">mask2</span>: <span class="hljs-number">0x0D800000</span>,
      });
    });

    context(<span class="hljs-string">"With no dataSources passed"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      it(<span class="hljs-string">"sends data to the Sphero's setDataStreaming method"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        sphero.setDataStreaming();
        expect(sds).to.be.calledWith({}, <span class="hljs-literal">undefined</span>);
      });
    });
  });
});

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>api.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "node_modules/cylon-api-http/lib/api.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>api.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<div class="dox">
<div class="summary">
<p>Cylon API
cylonjs.com</p>
</div>
<div class="body">
<p>Copyright (c) 2013-2015 The Hybrid Group
Licensed under the Apache 2.0 license.</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-comment">/* eslint no-sync: 0 */</span>
<span class="hljs-meta">
"use strict"</span>;

<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>),
    path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);

<span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>),
    bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">"body-parser"</span>),
    _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">"lodash"</span>);

<span class="hljs-keyword">var</span> defaults = {
  <span class="hljs-attr">host</span>: <span class="hljs-string">"127.0.0.1"</span>,
  <span class="hljs-attr">port</span>: <span class="hljs-string">"3000"</span>,
  <span class="hljs-attr">auth</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">CORS</span>: <span class="hljs-string">""</span>,
  <span class="hljs-attr">serveDir</span>: path.join(__dirname, <span class="hljs-string">"/../node_modules/robeaux/"</span>),
  <span class="hljs-attr">ssl</span>: {
    <span class="hljs-attr">key</span>: path.join(__dirname, <span class="hljs-string">"/../ssl/server.key"</span>),
    <span class="hljs-attr">cert</span>: path.join(__dirname, <span class="hljs-string">"/../ssl/server.crt"</span>)
  }
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>handle the flattened location for dependencies using npm 3.x</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">if</span> (!fs.existsSync(defaults.serveDir)) {
  defaults.serveDir = path.join(__dirname, <span class="hljs-string">"/../../robeaux"</span>);
}

<span class="hljs-keyword">var</span> API = <span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">API</span>(<span class="hljs-params">opts</span>) </span>{
  opts = opts || {};

  <span class="hljs-keyword">this</span>.mcp = opts.mcp;

  _.forEach(defaults, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">def, name</span>) </span>{
    <span class="hljs-keyword">this</span>[name] = _.has(opts, name) ? opts[name] : def;
  }, <span class="hljs-keyword">this</span>);

  <span class="hljs-keyword">this</span>.createServer();
  <span class="hljs-keyword">this</span>.configureMiddleware();
  <span class="hljs-keyword">this</span>.loadRoutes();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>error handling</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>.express.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, req, res, next</span>) </span>{
    res.status(<span class="hljs-number">500</span>).json({ <span class="hljs-attr">error</span>: err.message || <span class="hljs-string">"An error occured."</span>});
    next();
  });
};

API.prototype.createServer = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createServer</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>.express = express();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>configure ssl if requested</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.ssl &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.ssl === <span class="hljs-string">"object"</span>) {
    <span class="hljs-keyword">var</span> https = <span class="hljs-built_in">require</span>(<span class="hljs-string">"https"</span>);

    <span class="hljs-keyword">this</span>.server = https.createServer({
      <span class="hljs-attr">key</span>: fs.readFileSync(<span class="hljs-keyword">this</span>.ssl.key),
      <span class="hljs-attr">cert</span>: fs.readFileSync(<span class="hljs-keyword">this</span>.ssl.cert)
    }, <span class="hljs-keyword">this</span>.express);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"API using insecure connection."</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"We recommend using an SSL certificate with Cylon."</span>);
    <span class="hljs-keyword">this</span>.server = <span class="hljs-keyword">this</span>.express;
  }
};

API.prototype.configureMiddleware = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">configureMiddleware</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>auth</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>.express.use(<span class="hljs-keyword">this</span>.setupAuth());

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>parse request bodies</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>.express.use(bodyParser.json());
  <span class="hljs-keyword">this</span>.express.use(bodyParser.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> }));

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>serve static content</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>.express.use(express.static(<span class="hljs-keyword">this</span>.serveDir));

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>set CORS headers for API requests</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>.express.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    res.set(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-keyword">this</span>.CORS || <span class="hljs-string">"*"</span>);
    res.set(<span class="hljs-string">"Access-Control-Allow-Headers"</span>, <span class="hljs-string">"Content-Type"</span>);
    res.set(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json"</span>);

    <span class="hljs-keyword">if</span> (req.method === <span class="hljs-string">"OPTIONS"</span>) {
      <span class="hljs-keyword">return</span> res.sendStatus(<span class="hljs-number">200</span>);
    }

    <span class="hljs-keyword">return</span> next();
  }.bind(<span class="hljs-keyword">this</span>));

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>extracts command params from request</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>.express.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    req.commandParams = _.values(req.body);
    <span class="hljs-keyword">return</span> next();
  });

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>set Cylon/MCP in request</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>.express.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    req.mcp = <span class="hljs-keyword">this</span>.mcp;
    <span class="hljs-keyword">return</span> next();
  }.bind(<span class="hljs-keyword">this</span>));
};

API.prototype.loadRoutes = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadRoutes</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>.express.use(<span class="hljs-string">"/api"</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes"</span>));
};

API.prototype.setupAuth = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupAuth</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> authfn = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">auth</span>(<span class="hljs-params">req, res, next</span>) </span>{ next(); };

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.auth || !<span class="hljs-keyword">this</span>.auth.type) { <span class="hljs-keyword">return</span> authfn; }

  <span class="hljs-keyword">var</span> type = <span class="hljs-keyword">this</span>.auth.type,
      <span class="hljs-built_in">module</span> = <span class="hljs-string">"./auth/"</span> + type,
      filename = path.join(__dirname, <span class="hljs-built_in">module</span> + <span class="hljs-string">".js"</span>),
      exists = fs.existsSync(filename);

  <span class="hljs-keyword">if</span> (exists) {
    authfn = <span class="hljs-built_in">require</span>(filename)(<span class="hljs-keyword">this</span>.auth);
  }

  <span class="hljs-keyword">return</span> authfn;
};

API.prototype.start = API.prototype.listen = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> protocol = <span class="hljs-keyword">this</span>.ssl ? <span class="hljs-string">"https"</span> : <span class="hljs-string">"http"</span>,
      host = <span class="hljs-keyword">this</span>.host,
      port = <span class="hljs-keyword">this</span>.port;

  <span class="hljs-keyword">this</span>.server.listen(<span class="hljs-keyword">this</span>.port, <span class="hljs-keyword">this</span>.host, <span class="hljs-literal">null</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Cylon HTTP API server is now online."</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Listening at %s://%s:%s"</span>, protocol, host, port);
  });
};

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

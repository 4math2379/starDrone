<!DOCTYPE html>
<html>
<head>
  <title>api.spec.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../";
    var thisFile = "node_modules/cylon-api-http/spec/lib/api.spec.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>api.spec.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-keyword">var</span> https = <span class="hljs-built_in">require</span>(<span class="hljs-string">"https"</span>),
    path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);

<span class="hljs-keyword">var</span> API = lib(<span class="hljs-string">"api"</span>);

<span class="hljs-keyword">var</span> MockRequest = support(<span class="hljs-string">"mock_request"</span>),
    MockResponse = support(<span class="hljs-string">"mock_response"</span>);

describe(<span class="hljs-string">"API"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> api;

  beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    api = <span class="hljs-keyword">new</span> API();
    stub(<span class="hljs-built_in">console</span>, <span class="hljs-string">"log"</span>);
  });

  afterEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-built_in">console</span>.log.restore();
  });

  describe(<span class="hljs-string">"constructor"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> mod;

    beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      mod = <span class="hljs-keyword">new</span> API({
        <span class="hljs-attr">host</span>: <span class="hljs-string">"0.0.0.0"</span>,
        <span class="hljs-attr">port</span>: <span class="hljs-string">"1234"</span>
      });
    });

    it(<span class="hljs-string">"sets @express to an Express instance"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      expect(api.express.listen).to.be.a(<span class="hljs-string">"function"</span>);
    });

    it(<span class="hljs-string">"sets default values"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      expect(api.host).to.be.eql(<span class="hljs-string">"127.0.0.1"</span>);
      expect(api.port).to.be.eql(<span class="hljs-string">"3000"</span>);
    });

    it(<span class="hljs-string">"overrides default values if passed to constructor"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      expect(mod.host).to.be.eql(<span class="hljs-string">"0.0.0.0"</span>);
      expect(mod.port).to.be.eql(<span class="hljs-string">"1234"</span>);
    });
  });

  describe(<span class="hljs-string">"default"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    it(<span class="hljs-string">"host"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      expect(api.host).to.be.eql(<span class="hljs-string">"127.0.0.1"</span>);
    });

    it(<span class="hljs-string">"port"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      expect(api.port).to.be.eql(<span class="hljs-string">"3000"</span>);
    });

    it(<span class="hljs-string">"auth"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      expect(api.auth).to.be.eql(<span class="hljs-literal">false</span>);
    });

    it(<span class="hljs-string">"CORS"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      expect(api.CORS).to.be.eql(<span class="hljs-string">""</span>);
    });

    it(<span class="hljs-string">"ssl"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> sslDir = path.join(__dirname, <span class="hljs-string">"/../../ssl/"</span>);
      expect(api.ssl.key).to.be.eql(sslDir + <span class="hljs-string">"server.key"</span>);
      expect(api.ssl.cert).to.be.eql(sslDir + <span class="hljs-string">"server.crt"</span>);
    });
  });

  describe(<span class="hljs-string">"#createServer"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    it(<span class="hljs-string">"sets @express to an express server"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      api.express = <span class="hljs-literal">null</span>;
      api.createServer();
      expect(api.express).to.be.a(<span class="hljs-string">"function"</span>);
    });

    context(<span class="hljs-string">"if SSL is configured"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      it(<span class="hljs-string">"sets @server to a https.Server instance"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        api.createServer();
        expect(api.server).to.be.an.instanceOf(https.Server);
      });
    });

    context(<span class="hljs-string">"if SSL is not configured"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        api.ssl = <span class="hljs-literal">false</span>;
        api.createServer();
      });

      it(<span class="hljs-string">"logs that the API is insecure"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        expect(<span class="hljs-built_in">console</span>.log).to.be.calledWithMatch(<span class="hljs-string">"insecure connection"</span>);
      });

      it(<span class="hljs-string">"sets @server to @express"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        expect(api.server).to.be.eql(api.express);
      });
    });
  });

  describe(<span class="hljs-string">"#setupAuth"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    context(<span class="hljs-string">"when auth.type is basic"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        api.auth = { <span class="hljs-attr">type</span>: <span class="hljs-string">"basic"</span>, <span class="hljs-attr">user</span>: <span class="hljs-string">"user"</span>, <span class="hljs-attr">pass</span>: <span class="hljs-string">"pass"</span> };
      });

      it(<span class="hljs-string">"returns a basic auth middleware function"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> fn = api.setupAuth(),
            req = <span class="hljs-keyword">new</span> MockRequest(),
            res = <span class="hljs-keyword">new</span> MockResponse(),
            next = spy();

        <span class="hljs-keyword">var</span> auth = <span class="hljs-string">"Basic "</span> + <span class="hljs-keyword">new</span> Buffer(<span class="hljs-string">"user:pass"</span>).toString(<span class="hljs-string">"base64"</span>);

        req.headers.authorization = auth;

        fn(req, res, next);
        expect(next).to.be.called;
      });
    });

    context(<span class="hljs-string">"when auth is null"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        api.auth = <span class="hljs-literal">null</span>;
      });

      it(<span class="hljs-string">"returns a pass-through middleware function"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> fn = api.setupAuth(),
            next = spy();

        fn(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, next);
        expect(next).to.be.called;
      });
    });
  });

  describe(<span class="hljs-string">"#listen"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>we create a plain HTTP server to avoid a log message from Node</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      api.ssl = <span class="hljs-literal">false</span>;
      api.createServer();

      stub(api.server, <span class="hljs-string">"listen"</span>).yields();

      api.listen();
    });

    afterEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      api.server.listen.restore();
    });

    it(<span class="hljs-string">"listens on the configured host and port"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      expect(api.server.listen).to.be.calledWith(<span class="hljs-string">"3000"</span>, <span class="hljs-string">"127.0.0.1"</span>);
    });

    context(<span class="hljs-string">"when the server is running"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      it(<span class="hljs-string">"logs that it's online and listening"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        expect(<span class="hljs-built_in">console</span>.log).to.be.calledWith(
          <span class="hljs-string">"Cylon HTTP API server is now online."</span>
        );

        expect(<span class="hljs-built_in">console</span>.log).to.be.calledWith(
          <span class="hljs-string">"Listening at %s://%s:%s"</span>, <span class="hljs-string">"http"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-string">"3000"</span>
        );
      });
    });
  });
});

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

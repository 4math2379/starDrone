<!DOCTYPE html>
<html>
<head>
  <title>loader.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/cylon-api-http/spec/lib/middleware/loader.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>loader.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-keyword">var</span> loader = lib(<span class="hljs-string">"middleware/loader"</span>);

<span class="hljs-keyword">var</span> MockRequest = support(<span class="hljs-string">"mock_request"</span>),
    MockResponse = support(<span class="hljs-string">"mock_response"</span>);

describe(<span class="hljs-string">"Loader middleware"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> req, res, next, robot, connection, device;

  beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    req = <span class="hljs-keyword">new</span> MockRequest();
    res = <span class="hljs-keyword">new</span> MockResponse();

    req.mcp = {
      <span class="hljs-attr">robots</span>: {
        <span class="hljs-attr">Ultron</span>: {
          <span class="hljs-attr">name</span>: <span class="hljs-string">"Ultron"</span>,

          <span class="hljs-attr">connections</span>: {
            <span class="hljs-attr">arduino</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"arduino"</span> }
          },

          <span class="hljs-attr">devices</span>: {
            <span class="hljs-attr">led</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"led"</span> }
          }
        }
      }
    };

    robot = req.mcp.robots.Ultron;
    connection = robot.connections.arduino;
    device = robot.devices.led;

    next = spy();
  });

  context(<span class="hljs-string">"with 'robot' param"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    context(<span class="hljs-string">"if the specified robot exists"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        req.params.robot = <span class="hljs-string">"Ultron"</span>;
        loader(req, res, next);
      });

      it(<span class="hljs-string">"sets the robot as a request property"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        expect(req.robot).to.be.eql(robot);
      });

      it(<span class="hljs-string">"calls the next request handler"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        expect(next).to.be.called;
      });
    });

    context(<span class="hljs-string">"if the specified robot doesn't exist"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        req.params.robot = <span class="hljs-string">"Vision"</span>;
        loader(req, res, next);
      });

      it(<span class="hljs-string">"returns a JSON error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        expect(res.statuscode).to.be.eql(<span class="hljs-number">404</span>);
        expect(res.body).to.be.eql({
          <span class="hljs-attr">error</span>: <span class="hljs-string">"No robot found with the name Vision"</span>
        });
      });

      it(<span class="hljs-string">"does not call the next request handler"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        expect(next).to.not.be.called;
      });
    });
  });

  context(<span class="hljs-string">"with 'robot' and 'device' params"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      req.params.robot = <span class="hljs-string">"Ultron"</span>;
    });

    context(<span class="hljs-string">"if the specified device exists"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        req.params.device = <span class="hljs-string">"led"</span>;
        loader(req, res, next);
      });

      it(<span class="hljs-string">"sets the device as a request property"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        expect(req.device).to.be.eql(device);
      });

      it(<span class="hljs-string">"calls the next request handler"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        expect(next).to.be.called;
      });
    });

    context(<span class="hljs-string">"if the specified device doesn't exist"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        req.params.device = <span class="hljs-string">"button"</span>;
        loader(req, res, next);
      });

      it(<span class="hljs-string">"returns a JSON error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        expect(res.statuscode).to.be.eql(<span class="hljs-number">404</span>);
        expect(res.body).to.be.eql({
          <span class="hljs-attr">error</span>: <span class="hljs-string">"No device found with the name button"</span>
        });
      });

      it(<span class="hljs-string">"does not call the next request handler"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        expect(next).to.not.be.called;
      });
    });
  });

  context(<span class="hljs-string">"with 'robot' and 'connection' params"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      req.params.robot = <span class="hljs-string">"Ultron"</span>;
    });

    context(<span class="hljs-string">"if the specified connection exists"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        req.params.connection = <span class="hljs-string">"arduino"</span>;
        loader(req, res, next);
      });

      it(<span class="hljs-string">"sets the connection as a request property"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        expect(req.connection).to.be.eql(connection);
      });

      it(<span class="hljs-string">"calls the next request handler"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        expect(next).to.be.called;
      });
    });

    context(<span class="hljs-string">"if the specified connection doesn't exist"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        req.params.connection = <span class="hljs-string">"loopback"</span>;
        loader(req, res, next);
      });

      it(<span class="hljs-string">"returns a JSON error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        expect(res.statuscode).to.be.eql(<span class="hljs-number">404</span>);
        expect(res.body).to.be.eql({
          <span class="hljs-attr">error</span>: <span class="hljs-string">"No connection found with the name loopback"</span>
        });
      });

      it(<span class="hljs-string">"does not call the next request handler"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        expect(next).to.not.be.called;
      });
    });
  });
});

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

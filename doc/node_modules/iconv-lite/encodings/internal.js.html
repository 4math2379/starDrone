<!DOCTYPE html>
<html>
<head>
  <title>internal.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "node_modules/iconv-lite/encodings/internal.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>internal.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Export Node.js internal encodings.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-built_in">module</span>.exports = {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Encodings</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    utf8:   { <span class="hljs-attr">type</span>: <span class="hljs-string">"_internal"</span>, <span class="hljs-attr">bomAware</span>: <span class="hljs-literal">true</span>},
    <span class="hljs-attr">cesu8</span>:  { <span class="hljs-attr">type</span>: <span class="hljs-string">"_internal"</span>, <span class="hljs-attr">bomAware</span>: <span class="hljs-literal">true</span>},
    <span class="hljs-attr">unicode11utf8</span>: <span class="hljs-string">"utf8"</span>,

    <span class="hljs-attr">ucs2</span>:   { <span class="hljs-attr">type</span>: <span class="hljs-string">"_internal"</span>, <span class="hljs-attr">bomAware</span>: <span class="hljs-literal">true</span>},
    <span class="hljs-attr">utf16le</span>: <span class="hljs-string">"ucs2"</span>,

    <span class="hljs-attr">binary</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"_internal"</span> },
    <span class="hljs-attr">base64</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"_internal"</span> },
    <span class="hljs-attr">hex</span>:    { <span class="hljs-attr">type</span>: <span class="hljs-string">"_internal"</span> },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>Codec.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    _internal: InternalCodec,
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">InternalCodec</span>(<span class="hljs-params">codecOptions, iconv</span>) </span>{
    <span class="hljs-keyword">this</span>.enc = codecOptions.encodingName;
    <span class="hljs-keyword">this</span>.bomAware = codecOptions.bomAware;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.enc === <span class="hljs-string">"base64"</span>)
        <span class="hljs-keyword">this</span>.encoder = InternalEncoderBase64;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.enc === <span class="hljs-string">"cesu8"</span>) {
        <span class="hljs-keyword">this</span>.enc = <span class="hljs-string">"utf8"</span>; <span class="hljs-comment">// Use utf8 for decoding.</span>
        <span class="hljs-keyword">this</span>.encoder = InternalEncoderCesu8;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Add decoder for versions of Node not supporting CESU-8</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span> Buffer(<span class="hljs-string">"eda080"</span>, <span class="hljs-string">'hex'</span>).toString().length == <span class="hljs-number">3</span>) {
            <span class="hljs-keyword">this</span>.decoder = InternalDecoderCesu8;
            <span class="hljs-keyword">this</span>.defaultCharUnicode = iconv.defaultCharUnicode;
        }
    }
}

InternalCodec.prototype.encoder = InternalEncoder;
InternalCodec.prototype.decoder = InternalDecoder;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>We use node.js internal decoder. Its signature is the same as ours.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> StringDecoder = <span class="hljs-built_in">require</span>(<span class="hljs-string">'string_decoder'</span>).StringDecoder;

<span class="hljs-keyword">if</span> (!StringDecoder.prototype.end) <span class="hljs-comment">// Node v0.8 doesn't have this method.</span>
    StringDecoder.prototype.end = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{};


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">InternalDecoder</span>(<span class="hljs-params">options, codec</span>) </span>{
    StringDecoder.call(<span class="hljs-keyword">this</span>, codec.enc);
}

InternalDecoder.prototype = StringDecoder.prototype;


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<hr>
<p>Encoder is mostly trivial</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">InternalEncoder</span>(<span class="hljs-params">options, codec</span>) </span>{
    <span class="hljs-keyword">this</span>.enc = codec.enc;
}

InternalEncoder.prototype.write = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">str</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Buffer(str, <span class="hljs-keyword">this</span>.enc);
}

InternalEncoder.prototype.end = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
}


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<hr>
<p>Except base64 encoder, which must keep its state.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">InternalEncoderBase64</span>(<span class="hljs-params">options, codec</span>) </span>{
    <span class="hljs-keyword">this</span>.prevStr = <span class="hljs-string">''</span>;
}

InternalEncoderBase64.prototype.write = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">str</span>) </span>{
    str = <span class="hljs-keyword">this</span>.prevStr + str;
    <span class="hljs-keyword">var</span> completeQuads = str.length - (str.length % <span class="hljs-number">4</span>);
    <span class="hljs-keyword">this</span>.prevStr = str.slice(completeQuads);
    str = str.slice(<span class="hljs-number">0</span>, completeQuads);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Buffer(str, <span class="hljs-string">"base64"</span>);
}

InternalEncoderBase64.prototype.end = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Buffer(<span class="hljs-keyword">this</span>.prevStr, <span class="hljs-string">"base64"</span>);
}


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<hr>
<p>CESU-8 encoder is also special.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">InternalEncoderCesu8</span>(<span class="hljs-params">options, codec</span>) </span>{
}

InternalEncoderCesu8.prototype.write = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">str</span>) </span>{
    <span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">new</span> Buffer(str.length * <span class="hljs-number">3</span>), bufIdx = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; str.length; i++) {
        <span class="hljs-keyword">var</span> charCode = str.charCodeAt(i);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>Naive implementation, but it works because CESU-8 is especially easy
to convert from UTF-16 (which all JS strings are encoded in).</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (charCode &lt; <span class="hljs-number">0x80</span>)
            buf[bufIdx++] = charCode;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (charCode &lt; <span class="hljs-number">0x800</span>) {
            buf[bufIdx++] = <span class="hljs-number">0xC0</span> + (charCode &gt;&gt;&gt; <span class="hljs-number">6</span>);
            buf[bufIdx++] = <span class="hljs-number">0x80</span> + (charCode &amp; <span class="hljs-number">0x3f</span>);
        }
        <span class="hljs-keyword">else</span> { <span class="hljs-comment">// charCode will always be &lt; 0x10000 in javascript.</span>
            buf[bufIdx++] = <span class="hljs-number">0xE0</span> + (charCode &gt;&gt;&gt; <span class="hljs-number">12</span>);
            buf[bufIdx++] = <span class="hljs-number">0x80</span> + ((charCode &gt;&gt;&gt; <span class="hljs-number">6</span>) &amp; <span class="hljs-number">0x3f</span>);
            buf[bufIdx++] = <span class="hljs-number">0x80</span> + (charCode &amp; <span class="hljs-number">0x3f</span>);
        }
    }
    <span class="hljs-keyword">return</span> buf.slice(<span class="hljs-number">0</span>, bufIdx);
}

InternalEncoderCesu8.prototype.end = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<hr>
<p>CESU-8 decoder is not implemented in Node v4.0+</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">InternalDecoderCesu8</span>(<span class="hljs-params">options, codec</span>) </span>{
    <span class="hljs-keyword">this</span>.acc = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.contBytes = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.accBytes = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.defaultCharUnicode = codec.defaultCharUnicode;
}

InternalDecoderCesu8.prototype.write = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">buf</span>) </span>{
    <span class="hljs-keyword">var</span> acc = <span class="hljs-keyword">this</span>.acc, contBytes = <span class="hljs-keyword">this</span>.contBytes, accBytes = <span class="hljs-keyword">this</span>.accBytes, 
        res = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; buf.length; i++) {
        <span class="hljs-keyword">var</span> curByte = buf[i];
        <span class="hljs-keyword">if</span> ((curByte &amp; <span class="hljs-number">0xC0</span>) !== <span class="hljs-number">0x80</span>) { <span class="hljs-comment">// Leading byte</span>
            <span class="hljs-keyword">if</span> (contBytes &gt; <span class="hljs-number">0</span>) { <span class="hljs-comment">// Previous code is invalid</span>
                res += <span class="hljs-keyword">this</span>.defaultCharUnicode;
                contBytes = <span class="hljs-number">0</span>;
            }

            <span class="hljs-keyword">if</span> (curByte &lt; <span class="hljs-number">0x80</span>) { <span class="hljs-comment">// Single-byte code</span>
                res += <span class="hljs-built_in">String</span>.fromCharCode(curByte);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (curByte &lt; <span class="hljs-number">0xE0</span>) { <span class="hljs-comment">// Two-byte code</span>
                acc = curByte &amp; <span class="hljs-number">0x1F</span>;
                contBytes = <span class="hljs-number">1</span>; accBytes = <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (curByte &lt; <span class="hljs-number">0xF0</span>) { <span class="hljs-comment">// Three-byte code</span>
                acc = curByte &amp; <span class="hljs-number">0x0F</span>;
                contBytes = <span class="hljs-number">2</span>; accBytes = <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// Four or more are not supported for CESU-8.</span>
                res += <span class="hljs-keyword">this</span>.defaultCharUnicode;
            }
        } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// Continuation byte</span>
            <span class="hljs-keyword">if</span> (contBytes &gt; <span class="hljs-number">0</span>) { <span class="hljs-comment">// We're waiting for it.</span>
                acc = (acc &lt;&lt; <span class="hljs-number">6</span>) | (curByte &amp; <span class="hljs-number">0x3f</span>);
                contBytes--; accBytes++;
                <span class="hljs-keyword">if</span> (contBytes === <span class="hljs-number">0</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>Check for overlong encoding, but support Modified UTF-8 (encoding NULL as C0 80)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                    <span class="hljs-keyword">if</span> (accBytes === <span class="hljs-number">2</span> &amp;&amp; acc &lt; <span class="hljs-number">0x80</span> &amp;&amp; acc &gt; <span class="hljs-number">0</span>)
                        res += <span class="hljs-keyword">this</span>.defaultCharUnicode;
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (accBytes === <span class="hljs-number">3</span> &amp;&amp; acc &lt; <span class="hljs-number">0x800</span>)
                        res += <span class="hljs-keyword">this</span>.defaultCharUnicode;
                    <span class="hljs-keyword">else</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>Actually add character.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                        res += <span class="hljs-built_in">String</span>.fromCharCode(acc);
                }
            } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// Unexpected continuation byte</span>
                res += <span class="hljs-keyword">this</span>.defaultCharUnicode;
            }
        }
    }
    <span class="hljs-keyword">this</span>.acc = acc; <span class="hljs-keyword">this</span>.contBytes = contBytes; <span class="hljs-keyword">this</span>.accBytes = accBytes;
    <span class="hljs-keyword">return</span> res;
}

InternalDecoderCesu8.prototype.end = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> res = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.contBytes &gt; <span class="hljs-number">0</span>)
        res += <span class="hljs-keyword">this</span>.defaultCharUnicode;
    <span class="hljs-keyword">return</span> res;
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

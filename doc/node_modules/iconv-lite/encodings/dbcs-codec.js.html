<!DOCTYPE html>
<html>
<head>
  <title>dbcs-codec.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "node_modules/iconv-lite/encodings/dbcs-codec.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>dbcs-codec.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Multibyte codec. In this scheme, a character is represented by 1 or more bytes.
Our codec supports UTF-16 surrogates, extensions for GB18030 and unicode sequences.
To save memory and loading time, we read table files only when requested.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
exports._dbcs = DBCSCodec;

<span class="hljs-keyword">var</span> UNASSIGNED = <span class="hljs-number">-1</span>,
    GB18030_CODE = <span class="hljs-number">-2</span>,
    SEQ_START  = <span class="hljs-number">-10</span>,
    NODE_START = <span class="hljs-number">-1000</span>,
    UNASSIGNED_NODE = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-number">0x100</span>),
    DEF_CHAR = <span class="hljs-number">-1</span>;

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100</span>; i++)
    UNASSIGNED_NODE[i] = UNASSIGNED;


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Class DBCSCodec reads and initializes mapping tables.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DBCSCodec</span>(<span class="hljs-params">codecOptions, iconv</span>) </span>{
    <span class="hljs-keyword">this</span>.encodingName = codecOptions.encodingName;
    <span class="hljs-keyword">if</span> (!codecOptions)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"DBCS codec is called without the data."</span>)
    <span class="hljs-keyword">if</span> (!codecOptions.table)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Encoding '"</span> + <span class="hljs-keyword">this</span>.encodingName + <span class="hljs-string">"' has no data."</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>Load tables.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> mappingTable = codecOptions.table();


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Decode tables: MBCS -&gt; Unicode.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>decodeTables is a trie, encoded as an array of arrays of integers. Internal arrays are trie nodes and all have len = 256.
Trie root is decodeTables[0].
Values: &gt;=  0 -&gt; unicode character code. can be &gt; 0xFFFF
== UNASSIGNED -&gt; unknown/unassigned sequence.
== GB18030_CODE -&gt; this is the end of a GB18030 4-byte sequence.
&lt;= NODE_START -&gt; index of the next node in our trie to process next byte.
&lt;= SEQ_START  -&gt; index of the start of a character code sequence, in decodeTableSeq.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">this</span>.decodeTables = [];
    <span class="hljs-keyword">this</span>.decodeTables[<span class="hljs-number">0</span>] = UNASSIGNED_NODE.slice(<span class="hljs-number">0</span>); <span class="hljs-comment">// Create root node.</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Sometimes a MBCS char corresponds to a sequence of unicode chars. We store them as arrays of integers here.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">this</span>.decodeTableSeq = [];

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Actual mapping tables consist of chunks. Use them to fill up decode tables.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; mappingTable.length; i++)
        <span class="hljs-keyword">this</span>._addDecodeChunk(mappingTable[i]);

    <span class="hljs-keyword">this</span>.defaultCharUnicode = iconv.defaultCharUnicode;

    
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>Encode tables: Unicode -&gt; DBCS.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p><code>encodeTable</code> is array mapping from unicode char to encoded char. All its values are integers for performance.
Because it can be sparse, it is represented as array of buckets by 256 chars each. Bucket can be null.
Values: &gt;=  0 -&gt; it is a normal char. Write the value (if &lt;=256 then 1 byte, if &lt;=65536 then 2 bytes, etc.).
== UNASSIGNED -&gt; no conversion found. Output a default char.
&lt;= SEQ_START  -&gt; it's an index in encodeTableSeq, see below. The character starts a sequence.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">this</span>.encodeTable = [];
    
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p><code>encodeTableSeq</code> is used when a sequence of unicode characters is encoded as a single code. We use a tree of
objects where keys correspond to characters in sequence and leafs are the encoded dbcs values. A special DEF_CHAR key
means end of sequence (needed when one sequence is a strict subsequence of another).
Objects are kept separately from encodeTable to increase performance.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">this</span>.encodeTableSeq = [];

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>Some chars can be decoded, but need not be encoded.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> skipEncodeChars = {};
    <span class="hljs-keyword">if</span> (codecOptions.encodeSkipVals)
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; codecOptions.encodeSkipVals.length; i++) {
            <span class="hljs-keyword">var</span> val = codecOptions.encodeSkipVals[i];
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> val === <span class="hljs-string">'number'</span>)
                skipEncodeChars[val] = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = val.from; j &lt;= val.to; j++)
                    skipEncodeChars[j] = <span class="hljs-literal">true</span>;
        }
        
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>Use decode trie to recursively fill out encode tables.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">this</span>._fillEncodeTable(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, skipEncodeChars);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>Add more encoding pairs when needed.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (codecOptions.encodeAdd) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> uChar <span class="hljs-keyword">in</span> codecOptions.encodeAdd)
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(codecOptions.encodeAdd, uChar))
                <span class="hljs-keyword">this</span>._setEncodeChar(uChar.charCodeAt(<span class="hljs-number">0</span>), codecOptions.encodeAdd[uChar]);
    }

    <span class="hljs-keyword">this</span>.defCharSB  = <span class="hljs-keyword">this</span>.encodeTable[<span class="hljs-number">0</span>][iconv.defaultCharSingleByte.charCodeAt(<span class="hljs-number">0</span>)];
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.defCharSB === UNASSIGNED) <span class="hljs-keyword">this</span>.defCharSB = <span class="hljs-keyword">this</span>.encodeTable[<span class="hljs-number">0</span>][<span class="hljs-string">'?'</span>];
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.defCharSB === UNASSIGNED) <span class="hljs-keyword">this</span>.defCharSB = <span class="hljs-string">"?"</span>.charCodeAt(<span class="hljs-number">0</span>);


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>Load &amp; create GB18030 tables when needed.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> codecOptions.gb18030 === <span class="hljs-string">'function'</span>) {
        <span class="hljs-keyword">this</span>.gb18030 = codecOptions.gb18030(); <span class="hljs-comment">// Load GB18030 ranges.</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>Add GB18030 decode tables.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">var</span> thirdByteNodeIdx = <span class="hljs-keyword">this</span>.decodeTables.length;
        <span class="hljs-keyword">var</span> thirdByteNode = <span class="hljs-keyword">this</span>.decodeTables[thirdByteNodeIdx] = UNASSIGNED_NODE.slice(<span class="hljs-number">0</span>);

        <span class="hljs-keyword">var</span> fourthByteNodeIdx = <span class="hljs-keyword">this</span>.decodeTables.length;
        <span class="hljs-keyword">var</span> fourthByteNode = <span class="hljs-keyword">this</span>.decodeTables[fourthByteNodeIdx] = UNASSIGNED_NODE.slice(<span class="hljs-number">0</span>);

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0x81</span>; i &lt;= <span class="hljs-number">0xFE</span>; i++) {
            <span class="hljs-keyword">var</span> secondByteNodeIdx = NODE_START - <span class="hljs-keyword">this</span>.decodeTables[<span class="hljs-number">0</span>][i];
            <span class="hljs-keyword">var</span> secondByteNode = <span class="hljs-keyword">this</span>.decodeTables[secondByteNodeIdx];
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0x30</span>; j &lt;= <span class="hljs-number">0x39</span>; j++)
                secondByteNode[j] = NODE_START - thirdByteNodeIdx;
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0x81</span>; i &lt;= <span class="hljs-number">0xFE</span>; i++)
            thirdByteNode[i] = NODE_START - fourthByteNodeIdx;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0x30</span>; i &lt;= <span class="hljs-number">0x39</span>; i++)
            fourthByteNode[i] = GB18030_CODE
    }        
}

DBCSCodec.prototype.encoder = DBCSEncoder;
DBCSCodec.prototype.decoder = DBCSDecoder;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>Decoder helpers</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">DBCSCodec.prototype._getDecodeTrieNode = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">addr</span>) </span>{
    <span class="hljs-keyword">var</span> bytes = [];
    <span class="hljs-keyword">for</span> (; addr &gt; <span class="hljs-number">0</span>; addr &gt;&gt;= <span class="hljs-number">8</span>)
        bytes.push(addr &amp; <span class="hljs-number">0xFF</span>);
    <span class="hljs-keyword">if</span> (bytes.length == <span class="hljs-number">0</span>)
        bytes.push(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">var</span> node = <span class="hljs-keyword">this</span>.decodeTables[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = bytes.length<span class="hljs-number">-1</span>; i &gt; <span class="hljs-number">0</span>; i--) { <span class="hljs-comment">// Traverse nodes deeper into the trie.</span>
        <span class="hljs-keyword">var</span> val = node[bytes[i]];

        <span class="hljs-keyword">if</span> (val == UNASSIGNED) { <span class="hljs-comment">// Create new node.</span>
            node[bytes[i]] = NODE_START - <span class="hljs-keyword">this</span>.decodeTables.length;
            <span class="hljs-keyword">this</span>.decodeTables.push(node = UNASSIGNED_NODE.slice(<span class="hljs-number">0</span>));
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (val &lt;= NODE_START) { <span class="hljs-comment">// Existing node.</span>
            node = <span class="hljs-keyword">this</span>.decodeTables[NODE_START - val];
        }
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Overwrite byte in "</span> + <span class="hljs-keyword">this</span>.encodingName + <span class="hljs-string">", addr: "</span> + addr.toString(<span class="hljs-number">16</span>));
    }
    <span class="hljs-keyword">return</span> node;
}


DBCSCodec.prototype._addDecodeChunk = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">chunk</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>First element of chunk is the hex mbcs code where we start.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> curAddr = <span class="hljs-built_in">parseInt</span>(chunk[<span class="hljs-number">0</span>], <span class="hljs-number">16</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>Choose the decoding node where we'll write our chars.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> writeTable = <span class="hljs-keyword">this</span>._getDecodeTrieNode(curAddr);
    curAddr = curAddr &amp; <span class="hljs-number">0xFF</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>Write all other elements of the chunk to the table.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k = <span class="hljs-number">1</span>; k &lt; chunk.length; k++) {
        <span class="hljs-keyword">var</span> part = chunk[k];
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> part === <span class="hljs-string">"string"</span>) { <span class="hljs-comment">// String, write as-is.</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> l = <span class="hljs-number">0</span>; l &lt; part.length;) {
                <span class="hljs-keyword">var</span> code = part.charCodeAt(l++);
                <span class="hljs-keyword">if</span> (<span class="hljs-number">0xD800</span> &lt;= code &amp;&amp; code &lt; <span class="hljs-number">0xDC00</span>) { <span class="hljs-comment">// Decode surrogate</span>
                    <span class="hljs-keyword">var</span> codeTrail = part.charCodeAt(l++);
                    <span class="hljs-keyword">if</span> (<span class="hljs-number">0xDC00</span> &lt;= codeTrail &amp;&amp; codeTrail &lt; <span class="hljs-number">0xE000</span>)
                        writeTable[curAddr++] = <span class="hljs-number">0x10000</span> + (code - <span class="hljs-number">0xD800</span>) * <span class="hljs-number">0x400</span> + (codeTrail - <span class="hljs-number">0xDC00</span>);
                    <span class="hljs-keyword">else</span>
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Incorrect surrogate pair in "</span>  + <span class="hljs-keyword">this</span>.encodingName + <span class="hljs-string">" at chunk "</span> + chunk[<span class="hljs-number">0</span>]);
                }
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0x0FF0</span> &lt; code &amp;&amp; code &lt;= <span class="hljs-number">0x0FFF</span>) { <span class="hljs-comment">// Character sequence (our own encoding used)</span>
                    <span class="hljs-keyword">var</span> len = <span class="hljs-number">0xFFF</span> - code + <span class="hljs-number">2</span>;
                    <span class="hljs-keyword">var</span> seq = [];
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> m = <span class="hljs-number">0</span>; m &lt; len; m++)
                        seq.push(part.charCodeAt(l++)); <span class="hljs-comment">// Simple variation: don't support surrogates or subsequences in seq.</span>

                    writeTable[curAddr++] = SEQ_START - <span class="hljs-keyword">this</span>.decodeTableSeq.length;
                    <span class="hljs-keyword">this</span>.decodeTableSeq.push(seq);
                }
                <span class="hljs-keyword">else</span>
                    writeTable[curAddr++] = code; <span class="hljs-comment">// Basic char</span>
            }
        } 
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> part === <span class="hljs-string">"number"</span>) { <span class="hljs-comment">// Integer, meaning increasing sequence starting with prev character.</span>
            <span class="hljs-keyword">var</span> charCode = writeTable[curAddr - <span class="hljs-number">1</span>] + <span class="hljs-number">1</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> l = <span class="hljs-number">0</span>; l &lt; part; l++)
                writeTable[curAddr++] = charCode++;
        }
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Incorrect type '"</span> + <span class="hljs-keyword">typeof</span> part + <span class="hljs-string">"' given in "</span>  + <span class="hljs-keyword">this</span>.encodingName + <span class="hljs-string">" at chunk "</span> + chunk[<span class="hljs-number">0</span>]);
    }
    <span class="hljs-keyword">if</span> (curAddr &gt; <span class="hljs-number">0xFF</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Incorrect chunk in "</span>  + <span class="hljs-keyword">this</span>.encodingName + <span class="hljs-string">" at addr "</span> + chunk[<span class="hljs-number">0</span>] + <span class="hljs-string">": too long"</span> + curAddr);
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>Encoder helpers</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">DBCSCodec.prototype._getEncodeBucket = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">uCode</span>) </span>{
    <span class="hljs-keyword">var</span> high = uCode &gt;&gt; <span class="hljs-number">8</span>; <span class="hljs-comment">// This could be &gt; 0xFF because of astral characters.</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.encodeTable[high] === <span class="hljs-literal">undefined</span>)
        <span class="hljs-keyword">this</span>.encodeTable[high] = UNASSIGNED_NODE.slice(<span class="hljs-number">0</span>); <span class="hljs-comment">// Create bucket on demand.</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.encodeTable[high];
}

DBCSCodec.prototype._setEncodeChar = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">uCode, dbcsCode</span>) </span>{
    <span class="hljs-keyword">var</span> bucket = <span class="hljs-keyword">this</span>._getEncodeBucket(uCode);
    <span class="hljs-keyword">var</span> low = uCode &amp; <span class="hljs-number">0xFF</span>;
    <span class="hljs-keyword">if</span> (bucket[low] &lt;= SEQ_START)
        <span class="hljs-keyword">this</span>.encodeTableSeq[SEQ_START-bucket[low]][DEF_CHAR] = dbcsCode; <span class="hljs-comment">// There's already a sequence, set a single-char subsequence of it.</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bucket[low] == UNASSIGNED)
        bucket[low] = dbcsCode;
}

DBCSCodec.prototype._setEncodeSequence = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">seq, dbcsCode</span>) </span>{
    
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>Get the root of character tree according to first character of the sequence.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> uCode = seq[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">var</span> bucket = <span class="hljs-keyword">this</span>._getEncodeBucket(uCode);
    <span class="hljs-keyword">var</span> low = uCode &amp; <span class="hljs-number">0xFF</span>;

    <span class="hljs-keyword">var</span> node;
    <span class="hljs-keyword">if</span> (bucket[low] &lt;= SEQ_START) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>There's already a sequence with  - use it.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        node = <span class="hljs-keyword">this</span>.encodeTableSeq[SEQ_START-bucket[low]];
    }
    <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>There was no sequence object - allocate a new one.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        node = {};
        <span class="hljs-keyword">if</span> (bucket[low] !== UNASSIGNED) node[DEF_CHAR] = bucket[low]; <span class="hljs-comment">// If a char was set before - make it a single-char subsequence.</span>
        bucket[low] = SEQ_START - <span class="hljs-keyword">this</span>.encodeTableSeq.length;
        <span class="hljs-keyword">this</span>.encodeTableSeq.push(node);
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>Traverse the character tree, allocating new nodes as needed.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">1</span>; j &lt; seq.length<span class="hljs-number">-1</span>; j++) {
        <span class="hljs-keyword">var</span> oldVal = node[uCode];
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> oldVal === <span class="hljs-string">'object'</span>)
            node = oldVal;
        <span class="hljs-keyword">else</span> {
            node = node[uCode] = {}
            <span class="hljs-keyword">if</span> (oldVal !== <span class="hljs-literal">undefined</span>)
                node[DEF_CHAR] = oldVal
        }
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>Set the leaf to given dbcsCode.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    uCode = seq[seq.length<span class="hljs-number">-1</span>];
    node[uCode] = dbcsCode;
}

DBCSCodec.prototype._fillEncodeTable = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">nodeIdx, prefix, skipEncodeChars</span>) </span>{
    <span class="hljs-keyword">var</span> node = <span class="hljs-keyword">this</span>.decodeTables[nodeIdx];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100</span>; i++) {
        <span class="hljs-keyword">var</span> uCode = node[i];
        <span class="hljs-keyword">var</span> mbCode = prefix + i;
        <span class="hljs-keyword">if</span> (skipEncodeChars[mbCode])
            <span class="hljs-keyword">continue</span>;

        <span class="hljs-keyword">if</span> (uCode &gt;= <span class="hljs-number">0</span>)
            <span class="hljs-keyword">this</span>._setEncodeChar(uCode, mbCode);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (uCode &lt;= NODE_START)
            <span class="hljs-keyword">this</span>._fillEncodeTable(NODE_START - uCode, mbCode &lt;&lt; <span class="hljs-number">8</span>, skipEncodeChars);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (uCode &lt;= SEQ_START)
            <span class="hljs-keyword">this</span>._setEncodeSequence(<span class="hljs-keyword">this</span>.decodeTableSeq[SEQ_START - uCode], mbCode);
    }
}



</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>== Encoder ==================================================================</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DBCSEncoder</span>(<span class="hljs-params">options, codec</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>Encoder state</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">this</span>.leadSurrogate = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">this</span>.seqObj = <span class="hljs-literal">undefined</span>;
    
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>Static data</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">this</span>.encodeTable = codec.encodeTable;
    <span class="hljs-keyword">this</span>.encodeTableSeq = codec.encodeTableSeq;
    <span class="hljs-keyword">this</span>.defaultCharSingleByte = codec.defCharSB;
    <span class="hljs-keyword">this</span>.gb18030 = codec.gb18030;
}

DBCSEncoder.prototype.write = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">str</span>) </span>{
    <span class="hljs-keyword">var</span> newBuf = <span class="hljs-keyword">new</span> Buffer(str.length * (<span class="hljs-keyword">this</span>.gb18030 ? <span class="hljs-number">4</span> : <span class="hljs-number">3</span>)), 
        leadSurrogate = <span class="hljs-keyword">this</span>.leadSurrogate,
        seqObj = <span class="hljs-keyword">this</span>.seqObj, nextChar = <span class="hljs-number">-1</span>,
        i = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<ol start="0">
<li>Get next character.</li>
</ol>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (nextChar === <span class="hljs-number">-1</span>) {
            <span class="hljs-keyword">if</span> (i == str.length) <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">var</span> uCode = str.charCodeAt(i++);
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> uCode = nextChar;
            nextChar = <span class="hljs-number">-1</span>;    
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<ol>
<li>Handle surrogates.</li>
</ol>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (<span class="hljs-number">0xD800</span> &lt;= uCode &amp;&amp; uCode &lt; <span class="hljs-number">0xE000</span>) { <span class="hljs-comment">// Char is one of surrogates.</span>
            <span class="hljs-keyword">if</span> (uCode &lt; <span class="hljs-number">0xDC00</span>) { <span class="hljs-comment">// We've got lead surrogate.</span>
                <span class="hljs-keyword">if</span> (leadSurrogate === <span class="hljs-number">-1</span>) {
                    leadSurrogate = uCode;
                    <span class="hljs-keyword">continue</span>;
                } <span class="hljs-keyword">else</span> {
                    leadSurrogate = uCode;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>Double lead surrogate found.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                    uCode = UNASSIGNED;
                }
            } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// We've got trail surrogate.</span>
                <span class="hljs-keyword">if</span> (leadSurrogate !== <span class="hljs-number">-1</span>) {
                    uCode = <span class="hljs-number">0x10000</span> + (leadSurrogate - <span class="hljs-number">0xD800</span>) * <span class="hljs-number">0x400</span> + (uCode - <span class="hljs-number">0xDC00</span>);
                    leadSurrogate = <span class="hljs-number">-1</span>;
                } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>Incomplete surrogate pair - only trail surrogate found.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                    uCode = UNASSIGNED;
                }
                
            }
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (leadSurrogate !== <span class="hljs-number">-1</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>Incomplete surrogate pair - only lead surrogate found.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            nextChar = uCode; uCode = UNASSIGNED; <span class="hljs-comment">// Write an error, then current char.</span>
            leadSurrogate = <span class="hljs-number">-1</span>;
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<ol start="2">
<li>Convert uCode character.</li>
</ol>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">var</span> dbcsCode = UNASSIGNED;
        <span class="hljs-keyword">if</span> (seqObj !== <span class="hljs-literal">undefined</span> &amp;&amp; uCode != UNASSIGNED) { <span class="hljs-comment">// We are in the middle of the sequence</span>
            <span class="hljs-keyword">var</span> resCode = seqObj[uCode];
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> resCode === <span class="hljs-string">'object'</span>) { <span class="hljs-comment">// Sequence continues.</span>
                seqObj = resCode;
                <span class="hljs-keyword">continue</span>;

            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> resCode == <span class="hljs-string">'number'</span>) { <span class="hljs-comment">// Sequence finished. Write it.</span>
                dbcsCode = resCode;

            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resCode == <span class="hljs-literal">undefined</span>) { <span class="hljs-comment">// Current character is not part of the sequence.</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<p>Try default character for this sequence</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                resCode = seqObj[DEF_CHAR];
                <span class="hljs-keyword">if</span> (resCode !== <span class="hljs-literal">undefined</span>) {
                    dbcsCode = resCode; <span class="hljs-comment">// Found. Write it.</span>
                    nextChar = uCode; <span class="hljs-comment">// Current character will be written too in the next iteration.</span>

                } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>TODO: What if we have no default? (resCode == undefined)
Then, we should write first char of the sequence as-is and try the rest recursively.
Didn't do it for now because no encoding has this situation yet.
Currently, just skip the sequence and write current char.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                }
            }
            seqObj = <span class="hljs-literal">undefined</span>;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (uCode &gt;= <span class="hljs-number">0</span>) {  <span class="hljs-comment">// Regular character</span>
            <span class="hljs-keyword">var</span> subtable = <span class="hljs-keyword">this</span>.encodeTable[uCode &gt;&gt; <span class="hljs-number">8</span>];
            <span class="hljs-keyword">if</span> (subtable !== <span class="hljs-literal">undefined</span>)
                dbcsCode = subtable[uCode &amp; <span class="hljs-number">0xFF</span>];
            
            <span class="hljs-keyword">if</span> (dbcsCode &lt;= SEQ_START) { <span class="hljs-comment">// Sequence start</span>
                seqObj = <span class="hljs-keyword">this</span>.encodeTableSeq[SEQ_START-dbcsCode];
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-keyword">if</span> (dbcsCode == UNASSIGNED &amp;&amp; <span class="hljs-keyword">this</span>.gb18030) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<p>Use GB18030 algorithm to find character(s) to write.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                <span class="hljs-keyword">var</span> idx = findIdx(<span class="hljs-keyword">this</span>.gb18030.uChars, uCode);
                <span class="hljs-keyword">if</span> (idx != <span class="hljs-number">-1</span>) {
                    <span class="hljs-keyword">var</span> dbcsCode = <span class="hljs-keyword">this</span>.gb18030.gbChars[idx] + (uCode - <span class="hljs-keyword">this</span>.gb18030.uChars[idx]);
                    newBuf[j++] = <span class="hljs-number">0x81</span> + <span class="hljs-built_in">Math</span>.floor(dbcsCode / <span class="hljs-number">12600</span>); dbcsCode = dbcsCode % <span class="hljs-number">12600</span>;
                    newBuf[j++] = <span class="hljs-number">0x30</span> + <span class="hljs-built_in">Math</span>.floor(dbcsCode / <span class="hljs-number">1260</span>); dbcsCode = dbcsCode % <span class="hljs-number">1260</span>;
                    newBuf[j++] = <span class="hljs-number">0x81</span> + <span class="hljs-built_in">Math</span>.floor(dbcsCode / <span class="hljs-number">10</span>); dbcsCode = dbcsCode % <span class="hljs-number">10</span>;
                    newBuf[j++] = <span class="hljs-number">0x30</span> + dbcsCode;
                    <span class="hljs-keyword">continue</span>;
                }
            }
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39"></a>
</div>
<ol start="3">
<li>Write dbcsCode character.</li>
</ol>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (dbcsCode === UNASSIGNED)
            dbcsCode = <span class="hljs-keyword">this</span>.defaultCharSingleByte;
        
        <span class="hljs-keyword">if</span> (dbcsCode &lt; <span class="hljs-number">0x100</span>) {
            newBuf[j++] = dbcsCode;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dbcsCode &lt; <span class="hljs-number">0x10000</span>) {
            newBuf[j++] = dbcsCode &gt;&gt; <span class="hljs-number">8</span>;   <span class="hljs-comment">// high byte</span>
            newBuf[j++] = dbcsCode &amp; <span class="hljs-number">0xFF</span>; <span class="hljs-comment">// low byte</span>
        }
        <span class="hljs-keyword">else</span> {
            newBuf[j++] = dbcsCode &gt;&gt; <span class="hljs-number">16</span>;
            newBuf[j++] = (dbcsCode &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>;
            newBuf[j++] = dbcsCode &amp; <span class="hljs-number">0xFF</span>;
        }
    }

    <span class="hljs-keyword">this</span>.seqObj = seqObj;
    <span class="hljs-keyword">this</span>.leadSurrogate = leadSurrogate;
    <span class="hljs-keyword">return</span> newBuf.slice(<span class="hljs-number">0</span>, j);
}

DBCSEncoder.prototype.end = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.leadSurrogate === <span class="hljs-number">-1</span> &amp;&amp; <span class="hljs-keyword">this</span>.seqObj === <span class="hljs-literal">undefined</span>)
        <span class="hljs-keyword">return</span>; <span class="hljs-comment">// All clean. Most often case.</span>

    <span class="hljs-keyword">var</span> newBuf = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">10</span>), j = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.seqObj) { <span class="hljs-comment">// We're in the sequence.</span>
        <span class="hljs-keyword">var</span> dbcsCode = <span class="hljs-keyword">this</span>.seqObj[DEF_CHAR];
        <span class="hljs-keyword">if</span> (dbcsCode !== <span class="hljs-literal">undefined</span>) { <span class="hljs-comment">// Write beginning of the sequence.</span>
            <span class="hljs-keyword">if</span> (dbcsCode &lt; <span class="hljs-number">0x100</span>) {
                newBuf[j++] = dbcsCode;
            }
            <span class="hljs-keyword">else</span> {
                newBuf[j++] = dbcsCode &gt;&gt; <span class="hljs-number">8</span>;   <span class="hljs-comment">// high byte</span>
                newBuf[j++] = dbcsCode &amp; <span class="hljs-number">0xFF</span>; <span class="hljs-comment">// low byte</span>
            }
        } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40"></a>
</div>
<p>See todo above.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        }
        <span class="hljs-keyword">this</span>.seqObj = <span class="hljs-literal">undefined</span>;
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.leadSurrogate !== <span class="hljs-number">-1</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41"></a>
</div>
<p>Incomplete surrogate pair - only lead surrogate found.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        newBuf[j++] = <span class="hljs-keyword">this</span>.defaultCharSingleByte;
        <span class="hljs-keyword">this</span>.leadSurrogate = <span class="hljs-number">-1</span>;
    }
    
    <span class="hljs-keyword">return</span> newBuf.slice(<span class="hljs-number">0</span>, j);
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42"></a>
</div>
<p>Export for testing</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">DBCSEncoder.prototype.findIdx = findIdx;


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43"></a>
</div>
<p>== Decoder ==================================================================</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DBCSDecoder</span>(<span class="hljs-params">options, codec</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44"></a>
</div>
<p>Decoder state</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">this</span>.nodeIdx = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.prevBuf = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">0</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45"></a>
</div>
<p>Static data</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">this</span>.decodeTables = codec.decodeTables;
    <span class="hljs-keyword">this</span>.decodeTableSeq = codec.decodeTableSeq;
    <span class="hljs-keyword">this</span>.defaultCharUnicode = codec.defaultCharUnicode;
    <span class="hljs-keyword">this</span>.gb18030 = codec.gb18030;
}

DBCSDecoder.prototype.write = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">buf</span>) </span>{
    <span class="hljs-keyword">var</span> newBuf = <span class="hljs-keyword">new</span> Buffer(buf.length*<span class="hljs-number">2</span>),
        nodeIdx = <span class="hljs-keyword">this</span>.nodeIdx, 
        prevBuf = <span class="hljs-keyword">this</span>.prevBuf, prevBufOffset = <span class="hljs-keyword">this</span>.prevBuf.length,
        seqStart = -<span class="hljs-keyword">this</span>.prevBuf.length, <span class="hljs-comment">// idx of the start of current parsed sequence.</span>
        uCode;

    <span class="hljs-keyword">if</span> (prevBufOffset &gt; <span class="hljs-number">0</span>) <span class="hljs-comment">// Make prev buf overlap a little to make it easier to slice later.</span>
        prevBuf = Buffer.concat([prevBuf, buf.slice(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>)]);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>; i &lt; buf.length; i++) {
        <span class="hljs-keyword">var</span> curByte = (i &gt;= <span class="hljs-number">0</span>) ? buf[i] : prevBuf[i + prevBufOffset];

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46"></a>
</div>
<p>Lookup in current trie node.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">var</span> uCode = <span class="hljs-keyword">this</span>.decodeTables[nodeIdx][curByte];

        <span class="hljs-keyword">if</span> (uCode &gt;= <span class="hljs-number">0</span>) { 
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47"></a>
</div>
<p>Normal character, just use it.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (uCode === UNASSIGNED) { <span class="hljs-comment">// Unknown char.</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48"></a>
</div>
<p>TODO: Callback with seq.
var curSeq = (seqStart &gt;= 0) ? buf.slice(seqStart, i+1) : prevBuf.slice(seqStart + prevBufOffset, i+1 + prevBufOffset);</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            i = seqStart; <span class="hljs-comment">// Try to parse again, after skipping first byte of the sequence ('i' will be incremented by 'for' cycle).</span>
            uCode = <span class="hljs-keyword">this</span>.defaultCharUnicode.charCodeAt(<span class="hljs-number">0</span>);
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (uCode === GB18030_CODE) {
            <span class="hljs-keyword">var</span> curSeq = (seqStart &gt;= <span class="hljs-number">0</span>) ? buf.slice(seqStart, i+<span class="hljs-number">1</span>) : prevBuf.slice(seqStart + prevBufOffset, i+<span class="hljs-number">1</span> + prevBufOffset);
            <span class="hljs-keyword">var</span> ptr = (curSeq[<span class="hljs-number">0</span>]<span class="hljs-number">-0x81</span>)*<span class="hljs-number">12600</span> + (curSeq[<span class="hljs-number">1</span>]<span class="hljs-number">-0x30</span>)*<span class="hljs-number">1260</span> + (curSeq[<span class="hljs-number">2</span>]<span class="hljs-number">-0x81</span>)*<span class="hljs-number">10</span> + (curSeq[<span class="hljs-number">3</span>]<span class="hljs-number">-0x30</span>);
            <span class="hljs-keyword">var</span> idx = findIdx(<span class="hljs-keyword">this</span>.gb18030.gbChars, ptr);
            uCode = <span class="hljs-keyword">this</span>.gb18030.uChars[idx] + ptr - <span class="hljs-keyword">this</span>.gb18030.gbChars[idx];
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (uCode &lt;= NODE_START) { <span class="hljs-comment">// Go to next trie node.</span>
            nodeIdx = NODE_START - uCode;
            <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (uCode &lt;= SEQ_START) { <span class="hljs-comment">// Output a sequence of chars.</span>
            <span class="hljs-keyword">var</span> seq = <span class="hljs-keyword">this</span>.decodeTableSeq[SEQ_START - uCode];
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k = <span class="hljs-number">0</span>; k &lt; seq.length - <span class="hljs-number">1</span>; k++) {
                uCode = seq[k];
                newBuf[j++] = uCode &amp; <span class="hljs-number">0xFF</span>;
                newBuf[j++] = uCode &gt;&gt; <span class="hljs-number">8</span>;
            }
            uCode = seq[seq.length<span class="hljs-number">-1</span>];
        }
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"iconv-lite internal error: invalid decoding table value "</span> + uCode + <span class="hljs-string">" at "</span> + nodeIdx + <span class="hljs-string">"/"</span> + curByte);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49"></a>
</div>
<p>Write the character to buffer, handling higher planes using surrogate pair.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (uCode &gt; <span class="hljs-number">0xFFFF</span>) { 
            uCode -= <span class="hljs-number">0x10000</span>;
            <span class="hljs-keyword">var</span> uCodeLead = <span class="hljs-number">0xD800</span> + <span class="hljs-built_in">Math</span>.floor(uCode / <span class="hljs-number">0x400</span>);
            newBuf[j++] = uCodeLead &amp; <span class="hljs-number">0xFF</span>;
            newBuf[j++] = uCodeLead &gt;&gt; <span class="hljs-number">8</span>;

            uCode = <span class="hljs-number">0xDC00</span> + uCode % <span class="hljs-number">0x400</span>;
        }
        newBuf[j++] = uCode &amp; <span class="hljs-number">0xFF</span>;
        newBuf[j++] = uCode &gt;&gt; <span class="hljs-number">8</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50"></a>
</div>
<p>Reset trie node.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        nodeIdx = <span class="hljs-number">0</span>; seqStart = i+<span class="hljs-number">1</span>;
    }

    <span class="hljs-keyword">this</span>.nodeIdx = nodeIdx;
    <span class="hljs-keyword">this</span>.prevBuf = (seqStart &gt;= <span class="hljs-number">0</span>) ? buf.slice(seqStart) : prevBuf.slice(seqStart + prevBufOffset);
    <span class="hljs-keyword">return</span> newBuf.slice(<span class="hljs-number">0</span>, j).toString(<span class="hljs-string">'ucs2'</span>);
}

DBCSDecoder.prototype.end = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> ret = <span class="hljs-string">''</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51"></a>
</div>
<p>Try to parse all remaining chars.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">this</span>.prevBuf.length &gt; <span class="hljs-number">0</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52"></a>
</div>
<p>Skip 1 character in the buffer.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        ret += <span class="hljs-keyword">this</span>.defaultCharUnicode;
        <span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">this</span>.prevBuf.slice(<span class="hljs-number">1</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53"></a>
</div>
<p>Parse remaining as usual.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">this</span>.prevBuf = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">this</span>.nodeIdx = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (buf.length &gt; <span class="hljs-number">0</span>)
            ret += <span class="hljs-keyword">this</span>.write(buf);
    }

    <span class="hljs-keyword">this</span>.nodeIdx = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> ret;
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54"></a>
</div>
<p>Binary search for GB18030. Returns largest i such that table[i] &lt;= val.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findIdx</span>(<span class="hljs-params">table, val</span>) </span>{
    <span class="hljs-keyword">if</span> (table[<span class="hljs-number">0</span>] &gt; val)
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;

    <span class="hljs-keyword">var</span> l = <span class="hljs-number">0</span>, r = table.length;
    <span class="hljs-keyword">while</span> (l &lt; r<span class="hljs-number">-1</span>) { <span class="hljs-comment">// always table[l] &lt;= val &lt; table[r]</span>
        <span class="hljs-keyword">var</span> mid = l + <span class="hljs-built_in">Math</span>.floor((r-l+<span class="hljs-number">1</span>)/<span class="hljs-number">2</span>);
        <span class="hljs-keyword">if</span> (table[mid] &lt;= val)
            l = mid;
        <span class="hljs-keyword">else</span>
            r = mid;
    }
    <span class="hljs-keyword">return</span> l;
}


</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

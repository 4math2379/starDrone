<!DOCTYPE html>
<html>
<head>
  <title>enumser.cpp</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../";
    var thisFile = "node_modules/serialport/src/win/enumser.cpp";
    var defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>enumser.cpp</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<div class="dox">
<div class="summary">
<p>Module : enumser.cpp
Purpose: Implementation for a class to enumerate the serial ports installed on a PC using a number
of different approaches.
Created: PJN / 03-10-1998
History: PJN / 23-02-1999 Code now uses QueryDosDevice if running on NT to determine
which serial ports are available. This avoids having to open
the ports at all. It should operate a lot faster in addition.
PJN / 12-12-1999 Fixed a problem in the Win9x code path when trying to detect
deactivated IRDA-ports. When trying to open those, you will
get the error-code ERROR_GEN_FAILURE.ï¿½
PJN / 17-05-2000 Code now uses GetDefaultCommConfig in all cases to detect
the ports.
PJN / 29-03-2001 1. Reverted code to use CreateFile or QueryDosDevice as it is
much faster than using the GetDefaultCommConfig method</p>
<ol start="2">
<li>Updated copyright message
PJN / 25-06-2001 1. Guess what, You now have the choice of using the GetDefaultCommConfig
thro the use of three versions of the function. You take your pick.</li>
<li>Fixed problem where port fails to be reported thro the CreateFile
mechanism when the error code is ERROR_SHARING_VIOLATION i.e. someone
has the port already open
PJN / 11-08-2001 1. Made code path which uses QueryDosDevice more robust by checking to
make sure the device name is of the form &quot;COMxyz..&quot; where xyz are numeric
PJN / 13-08-2001 1. Made the code in IsNumeric more robust when sent an empty string</li>
<li>Optimized the code in EnumerateSerialPorts2 somewhat. Thanks to Dennis
Lim for these suggestions.
PJN / 22-05-2003 1. Updated copyright details.</li>
<li>Addition of a &quot;EnumerateSerialPorts4&quot; which uses Device Manager API
PJN / 20-09-2003 1. Addition of a &quot;EnumerateSerialPorts5&quot; method. This method (hopefully
the last method!) uses EnumPorts and was provided by Andi Martin.
PJN / 12-12-2003 1. Updated the sample app to VC 6.</li>
<li>Addition of a &quot;EnumerateSerialPorts6&quot; (See Note 4 below) which uses WMI.</li>
<li>You can now optionally exclude each function using preprocessor defines
of the form &quot;NO_ENUMSERIAL_USING_XYX&quot;.</li>
<li>Made the functions members of a C++ class and renamed them to
use more meaningful names
PJN / 13-05-2004 1. Extended CEnumerateSerial::UsingSetupAPI to now also return the friendly
name of the port. Thanks to Jay C. Howard for prompting this update.
PJN / 08-07-2006 1. Updated copyright details.</li>
<li>Addition of a CENUMERATESERIAL_EXT_CLASS macro to allow the code to be
easily added to an extension dll.</li>
<li>Code now uses newer C++ style casts instead of C style casts.</li>
<li>Updated the code to clean compile on VC 2005.</li>
<li>Updated the documentation to use the same style as the web site.
PJN / 08-11-2006 1. Extended CEnumerateSerial::UsingWMI to now also return the friendly
name of the port. Thanks to Giovanni Bajo for providing this update.</li>
<li>Fixed a bug where CEnumerateSerial::UsingSetupAPI forget to empty out
the Friendly name array on start.</li>
<li>VariantInit is now called for the 2 VARIANT structs used in the UsingWMI
method code.
PJN / 29-01-2007 1. Updated copyright details.</li>
<li>UsingSetupAPI code now uses the GUID_DEVINTERFACE_COMPORT guid to enumerate
COM ports. Thanks to David McMinn for reporting this nice addition.</li>
<li>Detection code which uses CreateFile call, now treats the error code
of ERROR_SEM_TIMEOUT as indication that a port is present.
PJN / 09-06-2007 1. Following feedback from John Miles, it looks like my previous change of the
29 January 2007 to use GUID_DEVINTERFACE_COMPORT in the UsingSetupAPI method
had the unintended consequence of causing this method not to work on any
versions of Windows prior to Windows 2000. What I have now done is reinstate
the old mechanism using the name UsingSetupAPI2 so that you can continue to use
this approach if you need to support NT 4 and Windows 9x. The new approach of
using GUID_DEVINTERFACE_COMPORT has been renamed to UsingSetupAPI1.
PJN / 05-07-2007 1. Updated the code to work if the code does not include MFC. In this case,
CUIntArray parameters becomes the ATL class CSimpleArray<UINT> and CStringArray
parameters become the ATL class CSimpleArray<CString>. Please note that this
support requires a recentish copy of Visual Studio and will not support Visual
C++ 6.0 as the code makes use of the ATL CString class. Thanks to Michael Venus
for prompting this update.</li>
<li>CEnumerateSerial::UsingWMI method now uses ATL smart pointers to improve
robustness of the code.
PJN / 20-03-2008 1. Updated copyright details</li>
<li>Updates to preprocessor logic to correctly include UsingSetupAPI1 and
UsingSetupAPI2 functionality</li>
<li>Updated sample app to clean compile on VC 2008
PJN / 23-11-2008 1. Updated code to compile correctly using _ATL_CSTRING_EXPLICIT_CONSTRUCTORS define</li>
<li>The code now only supports VC 2005 or later.</li>
<li>Code now compiles cleanly using Code Analysis (/analyze)</li>
<li>Yes, Addition of another method called &quot;UsingComDB&quot; to enumerate serial ports!.
This function uses the so called &quot;COM Database&quot; functions which are part of the
Windows DDK which device drivers can use to support claiming an unused port number
when the device driver is being installed. Please note that the list returning from
this function will only report used port numbers. The device may or may not be
actually present, just that the associated port number is currently &quot;claimed&quot;.
Thanks to Dmitry Nikitin for prompting this very nice addition. The code now
supports a total of 8 different ways to enumerate serial ports!
PJN / 29-11-2008 1. Addition of a ninth and hopefully final method to enumerate serial ports. The
function is called &quot;UsingRegistry&quot; and enumerates the ports by examining the
registry location at HKEY_LOCAL_MACHINE\HARDWARE\DEVICEMAP\SERIALCOMM. Thanks to
Martin Oberhuber for prompting this update.</li>
<li>Fixed a bug where the last error value was not being preserved in
CEnumerateSerial::UsingComDB.
PJN / 30-04-2009 1. Updated copyright details.</li>
<li>Updated the sample app's project settings to more modern default values.</li>
<li>Updated the sample app to log the time taken for the various methods.
PJN / 27-03-2010 1. Updated copyright details.</li>
<li>Code can now optionally use STL instead of MFC or ATL in the API. To use STL
containers instead of MFC or ATL versions, please define CENUMERATESERIAL_USE_STL before
you include enumser in your project. Please note that the code still internally uses ATL
in the UsingWMI method, but the other functions do not. This means that the class should
now be partly compilable on VC Express (2005, 2008 or 2010) as none of these have support
for ATL or MFC. I do not personally have VC Express installed so people's feedback on
this would be appreciated. Thanks to Bill Adair for providing this update.
PJN / 28-03-2011 1. Updated copyright details.</li>
<li>Updated the UsingComDB method to fix an off by one issue. This resulting in the list of
ports this function reported being incorrect. Thanks to &quot;Jar, Min, Jeong&quot; for reporting
this issue.</li>
<li>Updated sample app to compile cleanly on VC 2010
PJN / 14-10-2012 1. Updated copyright details.</li>
<li>Code no longer uses LoadLibrary without an absolute path when loading SETUPAPI and
MSPORTS dlls. This avoids DLL planting security issues.</li>
<li>Added a new internal CAutoHandle and CAutoHModule classes which makes the implementation
for CEnumerateSerial simpler</li>
<li>Code now uses an internal RegQueryValueString method to ensure that data returned
from raw Win32 API call RegQueryValueEx is null terminated before it is treated as such
in the code. Thanks to Jeffrey Walton for reporting this security issue.</li>
<li>Updated the code to clean compile on VC 2012
PJN / 10-01-2013 1. Updated copyright details</li>
<li>Spun off CAutoHModule class into its own header file</li>
<li>Spun off CAutoHandle class into its own header file</li>
<li>Addition of a new CAutoHeapAlloc class which encapsulates HeapAlloc / HeapFree calls
in a C++ class.</li>
<li>Removed ATL usage completely from UsingQueryDevice, UsingSetupAPI2 and UsingEnumPorts.
This should allow these methods to support compilers which do not have support for ATL such
as VC Express SKUs.
PJN /28-07-2013 1. Did some very light cleanup of the code to reduce dependencies when #defining out parts of
the code. Thanks to Jay Beavers for providing this update.</li>
</ol>
<p>Copyright (c) 1998 - 2013 by PJ Naughter (Web: www.naughter.com, Email: pjna@naughter.com)</p>
<p>All rights reserved.</p>
<p>Copyright / Usage Details:</p>
<p>You are allowed to include the source code in any product (commercial, shareware, freeware or otherwise)
when your product is released in binary form. You are allowed to modify the source code in any way you want
except you cannot modify the copyright details at the top of each module. If you want to distribute source
code with your application, then you are only allowed to distribute versions released by the author. This is
to maintain a single distribution point for the source code.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="cpp">

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>///////////////////////////////  Includes  //////////////////////////////////</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"stdafx.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"enumser.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"AutoHModule.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"AutoHandle.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"AutoHeapAlloc.h"</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> NO_ENUMSERIAL_USING_WMI</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> __ATLBASE_H__</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;atlbase.h&gt;</span></span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> message(<span class="hljs-meta-string">"To avoid this message, please put atlbase.h in your pre compiled header (normally stdafx.h)"</span>)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>///////////////////////////// Macros / Defines //////////////////////////////</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> !defined(NO_ENUMSERIAL_USING_SETUPAPI1) || !defined(NO_ENUMSERIAL_USING_SETUPAPI2)</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> _INC_SETUPAPI</span>
    <span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> message(<span class="hljs-meta-string">"To avoid this message, please put setupapi.h in your pre compiled header (normally stdafx.h)"</span>)</span>
    <span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;setupapi.h&gt;</span></span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

  <span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> GUID_DEVINTERFACE_COMPORT</span>
    DEFINE_GUID(GUID_DEVINTERFACE_COMPORT, <span class="hljs-number">0x86E0D1E0</span>L, <span class="hljs-number">0x8089</span>, <span class="hljs-number">0x11D0</span>, <span class="hljs-number">0x9C</span>, <span class="hljs-number">0xE4</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x3E</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x1F</span>, <span class="hljs-number">0x73</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
  
  <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">HKEY</span> <span class="hljs-params">(__stdcall SETUPDIOPENDEVREGKEY)</span><span class="hljs-params">(HDEVINFO, PSP_DEVINFO_DATA, DWORD, DWORD, DWORD, REGSAM)</span></span>;
  <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span> <span class="hljs-params">(__stdcall SETUPDICLASSGUIDSFROMNAME)</span><span class="hljs-params">(LPCTSTR, LPGUID, DWORD, PDWORD)</span></span>;
  <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span> <span class="hljs-params">(__stdcall SETUPDIDESTROYDEVICEINFOLIST)</span><span class="hljs-params">(HDEVINFO)</span></span>;
  <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span> <span class="hljs-params">(__stdcall SETUPDIENUMDEVICEINFO)</span><span class="hljs-params">(HDEVINFO, DWORD, PSP_DEVINFO_DATA)</span></span>;
  <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">HDEVINFO</span> <span class="hljs-params">(__stdcall SETUPDIGETCLASSDEVS)</span><span class="hljs-params">(LPGUID, LPCTSTR, HWND, DWORD)</span></span>;
  <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span> <span class="hljs-params">(__stdcall SETUPDIGETDEVICEREGISTRYPROPERTY)</span><span class="hljs-params">(HDEVINFO, PSP_DEVINFO_DATA, DWORD, PDWORD, PBYTE, DWORD, PDWORD)</span></span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> NO_ENUMSERIAL_USING_ENUMPORTS</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> _WINSPOOL_</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> message(<span class="hljs-meta-string">"To avoid this message, please put winspool.h in your pre compiled header (normally stdafx.h)"</span>)</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;winspool.h&gt;</span></span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> NO_ENUMSERIAL_USING_WMI</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> __IWbemLocator_FWD_DEFINED__</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> message(<span class="hljs-meta-string">"To avoid this message, please put WBemCli.h in your pre compiled header (normally stdafx.h)"</span>)</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;WbemCli.h&gt;</span></span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
  
  <span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> _INC_COMDEF</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> message(<span class="hljs-meta-string">"To avoid this message, please put comdef.h in your pre compiled header (normally stdafx.h)"</span>)</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;comdef.h&gt;</span></span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

  <span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> __ATLBASE_H__</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> message(<span class="hljs-meta-string">"EnumSerialPorts as of v1.16 requires ATL support to implement its functionality. If your project is MFC only, then you need to update it to include ATL support"</span>)</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
  
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>Automatically pull in the library WbemUuid.Lib since we need the WBem Guids</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  <span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> comment(lib, <span class="hljs-meta-string">"WbemUuid.Lib"</span>)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> NO_ENUMSERIAL_USING_COMDB</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> HCOMDB</span>
    DECLARE_HANDLE(HCOMDB);
    <span class="hljs-keyword">typedef</span> HCOMDB *PHCOMDB;
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
  
  <span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> CDB_REPORT_BYTES</span>
    <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CDB_REPORT_BYTES 0x1  </span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
  
  <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">LONG</span> <span class="hljs-params">(__stdcall COMDBOPEN)</span><span class="hljs-params">(PHCOMDB)</span></span>;
  <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">LONG</span> <span class="hljs-params">(__stdcall COMDBCLOSE)</span><span class="hljs-params">(HCOMDB)</span></span>;
  <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">LONG</span> <span class="hljs-params">(__stdcall COMDBGETCURRENTPORTUSAGE)</span><span class="hljs-params">(HCOMDB, PBYTE, DWORD, ULONG, LPDWORD)</span></span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>/////////////////////////// Implementation //////////////////////////////////</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> NO_ENUMSERIAL_USING_CREATEFILE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
BOOL CEnumerateSerial::UsingCreateFile(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;UINT&gt;&amp; ports)
<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> defined _AFX</span>
BOOL CEnumerateSerial::UsingCreateFile(CUIntArray&amp; ports)
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
BOOL CEnumerateSerial::UsingCreateFile(CSimpleArray&lt;UINT&gt;&amp; ports)
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Make sure we clear out any elements which may already be in the array</p>

        </td>
        <td class="code highlight">
          <pre class="cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
  ports.clear();
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
  ports.RemoveAll();
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Up to 255 COM ports are supported so we iterate through all of them seeing
if we can open them or if we fail to open them, get an access denied or general error error.
Both of these cases indicate that there is a COM port at that number.</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  <span class="hljs-keyword">for</span> (UINT i=<span class="hljs-number">1</span>; i&lt;<span class="hljs-number">256</span>; i++)
  {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Form the Raw device name</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    CString sPort;
    sPort.Format(_T(<span class="hljs-string">"\\\\.\\COM%u"</span>), i);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>Try to open the port</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    BOOL bSuccess = FALSE;
    CAutoHandle port(CreateFile(sPort, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0));
    if (port == INVALID_HANDLE_VALUE)
    {
      DWORD dwError = GetLastError();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>Check to see if the error was because some other app had the port open or a general failure</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">      <span class="hljs-keyword">if</span> (dwError == ERROR_ACCESS_DENIED || dwError == ERROR_GEN_FAILURE || dwError == ERROR_SHARING_VIOLATION || dwError == ERROR_SEM_TIMEOUT)
        bSuccess = TRUE;
    }
    <span class="hljs-keyword">else</span>
    {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>The port was opened successfully</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">      bSuccess = TRUE;
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>Add the port number to the array which will be returned</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    <span class="hljs-keyword">if</span> (bSuccess)
    {
    <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
      ports.push_back(i);
    <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
      ports.Add(i);
    <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>
    }
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>Return the success indicator</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  <span class="hljs-keyword">return</span> TRUE;
}
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> !defined(NO_ENUMSERIAL_USING_SETUPAPI1) || !defined(NO_ENUMSERIAL_USING_SETUPAPI2) || !defined(NO_ENUMSERIAL_USING_COMDB)</span>
HMODULE CEnumerateSerial::LoadLibraryFromSystem32(LPCTSTR lpFileName)
{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>Get the Windows System32 directory</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  TCHAR szFullPath[_MAX_PATH];
  szFullPath[<span class="hljs-number">0</span>] = _T(<span class="hljs-string">'\0'</span>);
  <span class="hljs-keyword">if</span> (GetSystemDirectory(szFullPath, _countof(szFullPath)) == <span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>Setup the full path and delegate to LoadLibrary</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  _tcscat_s(szFullPath, _countof(szFullPath), _T(<span class="hljs-string">"\\"</span>));
  _tcscat_s(szFullPath, _countof(szFullPath), lpFileName);
  <span class="hljs-keyword">return</span> LoadLibrary(szFullPath);
}
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> !defined(NO_ENUMSERIAL_USING_SETUPAPI1) || !defined(NO_ENUMSERIAL_USING_SETUPAPI2)</span>
BOOL CEnumerateSerial::RegQueryValueString(HKEY kKey, LPCTSTR lpValueName, LPTSTR&amp; pszValue)
{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>Initialize the output parameter</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  pszValue = <span class="hljs-literal">NULL</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>First query for the size of the registry value</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  DWORD dwType = <span class="hljs-number">0</span>;
  DWORD dwDataSize = <span class="hljs-number">0</span>;
  LONG nError = RegQueryValueEx(kKey, lpValueName, <span class="hljs-literal">NULL</span>, &amp;dwType, <span class="hljs-literal">NULL</span>, &amp;dwDataSize);
  <span class="hljs-keyword">if</span> (nError != ERROR_SUCCESS)
  {
    SetLastError(nError);
    <span class="hljs-keyword">return</span> FALSE;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>Ensure the value is a string</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  <span class="hljs-keyword">if</span> (dwType != REG_SZ)
  {
    SetLastError(ERROR_INVALID_DATA);
    <span class="hljs-keyword">return</span> FALSE;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>Allocate enough bytes for the return value</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  DWORD dwAllocatedSize = dwDataSize + <span class="hljs-keyword">sizeof</span>(TCHAR); <span class="hljs-comment">//+sizeof(TCHAR) is to allow us to NULL terminate the data if it is not null terminated in the registry</span>
  pszValue = <span class="hljs-keyword">reinterpret_cast</span>&lt;LPTSTR&gt;(LocalAlloc(LMEM_FIXED, dwAllocatedSize)); 
  <span class="hljs-keyword">if</span> (pszValue == <span class="hljs-literal">NULL</span>)
    <span class="hljs-keyword">return</span> FALSE;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>Recall RegQueryValueEx to return the data</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  pszValue[<span class="hljs-number">0</span>] = _T(<span class="hljs-string">'\0'</span>);
  DWORD dwReturnedSize = dwAllocatedSize;
  nError = RegQueryValueEx(kKey, lpValueName, <span class="hljs-literal">NULL</span>, &amp;dwType, <span class="hljs-keyword">reinterpret_cast</span>&lt;LPBYTE&gt;(pszValue), &amp;dwReturnedSize);
  <span class="hljs-keyword">if</span> (nError != ERROR_SUCCESS)
  {
    LocalFree(pszValue);
    pszValue = <span class="hljs-literal">NULL</span>;
    SetLastError(nError);
    <span class="hljs-keyword">return</span> FALSE;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>Handle the case where the data just returned is the same size as the allocated size. This could occur where the data
has been updated in the registry with a non null terminator between the two calls to ReqQueryValueEx above. Rather than
return a potentially non-null terminated block of data, just fail the method call</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  <span class="hljs-keyword">if</span> (dwReturnedSize &gt;= dwAllocatedSize)
  {
    SetLastError(ERROR_INVALID_DATA);
    <span class="hljs-keyword">return</span> FALSE;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>NULL terminate the data if it was not returned NULL terminated because it is not stored null terminated in the registry</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  <span class="hljs-keyword">if</span> (pszValue[dwReturnedSize/<span class="hljs-keyword">sizeof</span>(TCHAR) - <span class="hljs-number">1</span>] != _T(<span class="hljs-string">'\0'</span>))
    pszValue[dwReturnedSize/<span class="hljs-keyword">sizeof</span>(TCHAR)] = _T(<span class="hljs-string">'\0'</span>);

  <span class="hljs-keyword">return</span> TRUE;
}

BOOL CEnumerateSerial::QueryRegistryPortName(HKEY hDeviceKey, <span class="hljs-keyword">int</span>&amp; nPort)
{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>What will be the return value from the method (assume the worst)</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  BOOL bAdded = FALSE;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>Read in the name of the port</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  LPTSTR pszPortName = <span class="hljs-literal">NULL</span>;
  <span class="hljs-keyword">if</span> (RegQueryValueString(hDeviceKey, _T(<span class="hljs-string">"PortName"</span>), pszPortName))
  {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>If it looks like &quot;COMX&quot; then
add it to the array which will be returned</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    <span class="hljs-keyword">size_t</span> nLen = _tcslen(pszPortName);
    <span class="hljs-keyword">if</span> (nLen &gt; <span class="hljs-number">3</span>)
    {
      <span class="hljs-keyword">if</span> ((_tcsnicmp(pszPortName, _T(<span class="hljs-string">"COM"</span>), <span class="hljs-number">3</span>) == <span class="hljs-number">0</span>) &amp;&amp; IsNumeric((pszPortName + <span class="hljs-number">3</span>), FALSE))
      {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>Work out the port number</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">        nPort = _ttoi(pszPortName + <span class="hljs-number">3</span>);

        bAdded = TRUE;
      }
    }
    LocalFree(pszPortName);
  }

  <span class="hljs-keyword">return</span> bAdded;
}
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span> <span class="hljs-comment">//#if !defined(NO_ENUMSERIAL_USING_SETUPAPI1) || !defined(NO_ENUMSERIAL_USING_SETUPAPI2)</span></span>

BOOL CEnumerateSerial::IsNumeric(LPCSTR pszString, BOOL bIgnoreColon)
{
  <span class="hljs-keyword">size_t</span> nLen = <span class="hljs-built_in">strlen</span>(pszString);
  <span class="hljs-keyword">if</span> (nLen == <span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> FALSE;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>What will be the return value from this function (assume the best)</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  BOOL bNumeric = TRUE;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i=<span class="hljs-number">0</span>; i&lt;nLen &amp;&amp; bNumeric; i++)
  {
    bNumeric = (<span class="hljs-built_in">isdigit</span>(<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">int</span>&gt;(pszString[i])) != <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (bIgnoreColon &amp;&amp; (pszString[i] == <span class="hljs-string">':'</span>))
      bNumeric = TRUE;
  }

  <span class="hljs-keyword">return</span> bNumeric;
}

BOOL CEnumerateSerial::IsNumeric(LPCWSTR pszString, BOOL bIgnoreColon)
{
  <span class="hljs-keyword">size_t</span> nLen = wcslen(pszString);
  <span class="hljs-keyword">if</span> (nLen == <span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> FALSE;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>What will be the return value from this function (assume the best)</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  BOOL bNumeric = TRUE;

  for (size_t i=0; i&lt;nLen &amp;&amp; bNumeric; i++)
  {
    bNumeric = (iswdigit(pszString[i]) != 0);
    if (bIgnoreColon &amp;&amp; (pszString[i] == L':'))
      bNumeric = TRUE;
  }

  return bNumeric;
}

#ifndef NO_ENUMSERIAL_USING_QUERYDOSDEVICE
#if defined CENUMERATESERIAL_USE_STL
BOOL CEnumerateSerial::UsingQueryDosDevice(std::vector&lt;UINT&gt;&amp; ports)
#elif defined _AFX
BOOL CEnumerateSerial::UsingQueryDosDevice(CUIntArray&amp; ports)
#else
BOOL CEnumerateSerial::UsingQueryDosDevice(CSimpleArray&lt;UINT&gt;&amp; ports)
#endif
{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>What will be the return value from this function (assume the worst)</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  BOOL bSuccess = FALSE;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>Make sure we clear out any elements which may already be in the array</p>

        </td>
        <td class="code highlight">
          <pre class="cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
  ports.clear();
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
  ports.RemoveAll();
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>Determine what OS we are running on</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  OSVERSIONINFO osvi;
  osvi.dwOSVersionInfoSize = <span class="hljs-keyword">sizeof</span>(OSVERSIONINFO);
  BOOL bGetVer = GetVersionEx(&amp;osvi);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>On NT use the QueryDosDevice API</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  <span class="hljs-keyword">if</span> (bGetVer &amp;&amp; (osvi.dwPlatformId == VER_PLATFORM_WIN32_NT))
  {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>Use QueryDosDevice to look for all devices of the form COMx. Since QueryDosDevice does
not consitently report the required size of buffer, lets start with a reasonable buffer size
of 4096 characters and go from there</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    <span class="hljs-keyword">int</span> nChars = <span class="hljs-number">4096</span>;
    BOOL bWantStop = FALSE;
    <span class="hljs-keyword">while</span> (nChars &amp;&amp; !bWantStop)
    {
      CAutoHeapAlloc devices;
      <span class="hljs-keyword">if</span> (devices.Allocate(nChars * <span class="hljs-keyword">sizeof</span>(TCHAR)))
      {
        LPTSTR pszDevices = <span class="hljs-keyword">static_cast</span>&lt;LPTSTR&gt;(devices.m_pData);
        DWORD dwChars = QueryDosDevice(<span class="hljs-literal">NULL</span>, pszDevices, nChars);
        <span class="hljs-keyword">if</span> (dwChars == <span class="hljs-number">0</span>)
        {
          DWORD dwError = GetLastError();
          <span class="hljs-keyword">if</span> (dwError == ERROR_INSUFFICIENT_BUFFER)
          {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>Expand the buffer and  loop around again</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">            nChars *= <span class="hljs-number">2</span>;
          }
          <span class="hljs-keyword">else</span>
            bWantStop = TRUE;
        }
        <span class="hljs-keyword">else</span>
        {
          bSuccess = TRUE;
          bWantStop = TRUE;
          <span class="hljs-keyword">size_t</span> i=<span class="hljs-number">0</span>;
          
          <span class="hljs-keyword">while</span> (pszDevices[i] != _T(<span class="hljs-string">'\0'</span>))
          {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>Get the current device name</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">            TCHAR* pszCurrentDevice = &amp;(pszDevices[i]);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<p>If it looks like &quot;COMX&quot; then
add it to the array which will be returned</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">            <span class="hljs-keyword">size_t</span> nLen = _tcslen(pszCurrentDevice);
            <span class="hljs-keyword">if</span> (nLen &gt; <span class="hljs-number">3</span>)
            {
              <span class="hljs-keyword">if</span> ((_tcsnicmp(pszCurrentDevice, _T(<span class="hljs-string">"COM"</span>), <span class="hljs-number">3</span>) == <span class="hljs-number">0</span>) &amp;&amp; IsNumeric(&amp;(pszCurrentDevice[<span class="hljs-number">3</span>]), FALSE))
              {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>Work out the port number</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">                <span class="hljs-keyword">int</span> nPort = _ttoi(&amp;pszCurrentDevice[<span class="hljs-number">3</span>]);
              <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
                ports.push_back(nPort);
              <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
                ports.Add(nPort);
              <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>
              }
            }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<p>Go to next device name</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">            i += (nLen + <span class="hljs-number">1</span>);
          }
        }
      }
      <span class="hljs-keyword">else</span>
      {
        bWantStop = TRUE;
        SetLastError(ERROR_OUTOFMEMORY);        
      }
    }
  }
  <span class="hljs-keyword">else</span>
    SetLastError(ERROR_CALL_NOT_IMPLEMENTED);

  <span class="hljs-keyword">return</span> bSuccess;
}
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> NO_ENUMSERIAL_USING_GETDEFAULTCOMMCONFIG</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
BOOL CEnumerateSerial::UsingGetDefaultCommConfig(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;UINT&gt;&amp; ports)
<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> defined _AFX</span>
BOOL CEnumerateSerial::UsingGetDefaultCommConfig(CUIntArray&amp; ports)
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
BOOL CEnumerateSerial::UsingGetDefaultCommConfig(CSimpleArray&lt;UINT&gt;&amp; ports)
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39"></a>
</div>
<p>Make sure we clear out any elements which may already be in the array</p>

        </td>
        <td class="code highlight">
          <pre class="cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
  ports.clear();
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
  ports.RemoveAll();
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40"></a>
</div>
<p>Up to 255 COM ports are supported so we iterate through all of them seeing
if we can get the default configuration</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  <span class="hljs-keyword">for</span> (UINT i=<span class="hljs-number">1</span>; i&lt;<span class="hljs-number">256</span>; i++)
  {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41"></a>
</div>
<p>Form the Raw device name</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    CString sPort;
    sPort.Format(_T(<span class="hljs-string">"COM%u"</span>), i);

    COMMCONFIG cc;
    DWORD dwSize = <span class="hljs-keyword">sizeof</span>(COMMCONFIG);
    <span class="hljs-keyword">if</span> (GetDefaultCommConfig(sPort, &amp;cc, &amp;dwSize))
    {
    <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
      ports.push_back(i);
    <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
      ports.Add(i);
    <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>
    }
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42"></a>
</div>
<p>Return the success indicator</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  <span class="hljs-keyword">return</span> TRUE;
}
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> NO_ENUMSERIAL_USING_SETUPAPI1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined _UNICODE</span>
BOOL CEnumerateSerial::UsingSetupAPI1(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;UINT&gt;&amp; ports, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::wstring&gt;&amp; friendlyNames)
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
BOOL CEnumerateSerial::UsingSetupAPI1(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;UINT&gt;&amp; ports, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&gt;&amp; friendlyNames)
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> defined _AFX</span>
BOOL CEnumerateSerial::UsingSetupAPI1(CUIntArray&amp; ports, CStringArray&amp; friendlyNames)
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
BOOL CEnumerateSerial::UsingSetupAPI1(CSimpleArray&lt;UINT&gt;&amp; ports, CSimpleArray&lt;CString&gt;&amp; friendlyNames)
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43"></a>
</div>
<p>Make sure we clear out any elements which may already be in the array(s)</p>

        </td>
        <td class="code highlight">
          <pre class="cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
  ports.clear();
  friendlyNames.clear();
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
  ports.RemoveAll();
  friendlyNames.RemoveAll();
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44"></a>
</div>
<p>Get the various function pointers we require from setupapi.dll</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  CAutoHModule setupAPI(LoadLibraryFromSystem32(_T("SETUPAPI.DLL")));
  if (setupAPI == NULL)
    return FALSE;

  SETUPDIOPENDEVREGKEY* lpfnLPSETUPDIOPENDEVREGKEY = reinterpret_cast&lt;SETUPDIOPENDEVREGKEY*&gt;(GetProcAddress(setupAPI, "SetupDiOpenDevRegKey"));
#if defined _UNICODE
  SETUPDIGETCLASSDEVS* lpfnSETUPDIGETCLASSDEVS = reinterpret_cast&lt;SETUPDIGETCLASSDEVS*&gt;(GetProcAddress(setupAPI, "SetupDiGetClassDevsW"));
  SETUPDIGETDEVICEREGISTRYPROPERTY* lpfnSETUPDIGETDEVICEREGISTRYPROPERTY = reinterpret_cast&lt;SETUPDIGETDEVICEREGISTRYPROPERTY*&gt;(GetProcAddress(setupAPI, "SetupDiGetDeviceRegistryPropertyW"));
#else
  SETUPDIGETCLASSDEVS* lpfnSETUPDIGETCLASSDEVS = reinterpret_cast&lt;SETUPDIGETCLASSDEVS*&gt;(GetProcAddress(setupAPI, "SetupDiGetClassDevsA"));
  SETUPDIGETDEVICEREGISTRYPROPERTY* lpfnSETUPDIGETDEVICEREGISTRYPROPERTY = reinterpret_cast&lt;SETUPDIGETDEVICEREGISTRYPROPERTY*&gt;(GetProcAddress(setupAPI, "SetupDiGetDeviceRegistryPropertyA"));
#endif
  SETUPDIDESTROYDEVICEINFOLIST* lpfnSETUPDIDESTROYDEVICEINFOLIST = reinterpret_cast&lt;SETUPDIDESTROYDEVICEINFOLIST*&gt;(GetProcAddress(setupAPI, "SetupDiDestroyDeviceInfoList"));
  SETUPDIENUMDEVICEINFO* lpfnSETUPDIENUMDEVICEINFO = reinterpret_cast&lt;SETUPDIENUMDEVICEINFO*&gt;(GetProcAddress(setupAPI, "SetupDiEnumDeviceInfo"));

  if ((lpfnLPSETUPDIOPENDEVREGKEY == NULL) || (lpfnSETUPDIDESTROYDEVICEINFOLIST == NULL) ||
      (lpfnSETUPDIENUMDEVICEINFO == NULL) || (lpfnSETUPDIGETCLASSDEVS == NULL) || (lpfnSETUPDIGETDEVICEREGISTRYPROPERTY == NULL))
  {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45"></a>
</div>
<p>Set the error to report</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    setupAPI.m_dwError = ERROR_CALL_NOT_IMPLEMENTED;

    <span class="hljs-keyword">return</span> FALSE;
  }
  
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46"></a>
</div>
<p>Now create a &quot;device information set&quot; which is required to enumerate all the ports</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  GUID guid = GUID_DEVINTERFACE_COMPORT;
  HDEVINFO hDevInfoSet = lpfnSETUPDIGETCLASSDEVS(&amp;guid, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, DIGCF_PRESENT | DIGCF_DEVICEINTERFACE);
  <span class="hljs-keyword">if</span> (hDevInfoSet == INVALID_HANDLE_VALUE)
  {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47"></a>
</div>
<p>Set the error to report</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    setupAPI.m_dwError = GetLastError();
  
    <span class="hljs-keyword">return</span> FALSE;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48"></a>
</div>
<p>Finally do the enumeration</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  BOOL bMoreItems = TRUE;
  <span class="hljs-keyword">int</span> nIndex = <span class="hljs-number">0</span>;
  SP_DEVINFO_DATA devInfo;
  <span class="hljs-keyword">while</span> (bMoreItems)
  {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49"></a>
</div>
<p>Enumerate the current device</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    devInfo.cbSize = <span class="hljs-keyword">sizeof</span>(SP_DEVINFO_DATA);
    bMoreItems = lpfnSETUPDIENUMDEVICEINFO(hDevInfoSet, nIndex, &amp;devInfo);
    <span class="hljs-keyword">if</span> (bMoreItems)
    {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50"></a>
</div>
<p>Did we find a serial port for this device</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">      BOOL bAdded = FALSE;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51"></a>
</div>
<p>Get the registry key which stores the ports settings</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">      HKEY hDeviceKey = lpfnLPSETUPDIOPENDEVREGKEY(hDevInfoSet, &amp;devInfo, DICS_FLAG_GLOBAL, <span class="hljs-number">0</span>, DIREG_DEV, KEY_QUERY_VALUE);
      <span class="hljs-keyword">if</span> (hDeviceKey)
      {
        <span class="hljs-keyword">int</span> nPort = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (QueryRegistryPortName(hDeviceKey, nPort))
        {
        <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
          ports.push_back(nPort);
        <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
          ports.Add(nPort);
        <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>
          bAdded = TRUE;
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52"></a>
</div>
<p>Close the key now that we are finished with it</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">        RegCloseKey(hDeviceKey);
      }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53"></a>
</div>
<p>If the port was a serial port, then also try to get its friendly name</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">      <span class="hljs-keyword">if</span> (bAdded)
      {
        TCHAR szFriendlyName[<span class="hljs-number">1024</span>];
        szFriendlyName[<span class="hljs-number">0</span>] = _T(<span class="hljs-string">'\0'</span>);
        DWORD dwSize = <span class="hljs-keyword">sizeof</span>(szFriendlyName);
        DWORD dwType = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (lpfnSETUPDIGETDEVICEREGISTRYPROPERTY(hDevInfoSet, &amp;devInfo, SPDRP_DEVICEDESC, &amp;dwType, <span class="hljs-keyword">reinterpret_cast</span>&lt;PBYTE&gt;(szFriendlyName), dwSize, &amp;dwSize) &amp;&amp; (dwType == REG_SZ))
        {
        <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
          friendlyNames.push_back(szFriendlyName);
        <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
          friendlyNames.Add(szFriendlyName);
        <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>
        }
        <span class="hljs-keyword">else</span>
        {
        #<span class="hljs-keyword">if</span> defined CENUMERATESERIAL_USE_STL
          friendlyNames.push_back(_T(<span class="hljs-string">""</span>));
        <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
          friendlyNames.Add(_T(<span class="hljs-string">""</span>));
        <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>
        }
      }
    }

    ++nIndex;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54"></a>
</div>
<p>Free up the &quot;device information set&quot; now that we are finished with it</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  lpfnSETUPDIDESTROYDEVICEINFOLIST(hDevInfoSet);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55"></a>
</div>
<p>Return the success indicator</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  <span class="hljs-keyword">return</span> TRUE;
}
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> NO_ENUMSERIAL_USING_SETUPAPI2</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined _UNICODE</span>
BOOL CEnumerateSerial::UsingSetupAPI2(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;UINT&gt;&amp; ports, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::wstring&gt;&amp; friendlyNames)
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
BOOL CEnumerateSerial::UsingSetupAPI2(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;UINT&gt;&amp; ports, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&gt;&amp; friendlyNames)
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> defined _AFX</span>
BOOL CEnumerateSerial::UsingSetupAPI2(CUIntArray&amp; ports, CStringArray&amp; friendlyNames)
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
BOOL CEnumerateSerial::UsingSetupAPI2(CSimpleArray&lt;UINT&gt;&amp; ports, CSimpleArray&lt;CString&gt;&amp; friendlyNames)
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56"></a>
</div>
<p>Make sure we clear out any elements which may already be in the array(s)</p>

        </td>
        <td class="code highlight">
          <pre class="cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
  ports.clear();
  friendlyNames.clear();
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
  ports.RemoveAll();
  friendlyNames.RemoveAll();
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57"></a>
</div>
<p>Get the function pointers to &quot;SetupDiGetClassDevs&quot;, &quot;SetupDiGetClassDevs&quot;, &quot;SetupDiEnumDeviceInfo&quot;, &quot;SetupDiOpenDevRegKey&quot;
and &quot;SetupDiDestroyDeviceInfoList&quot; in setupapi.dll</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  CAutoHModule setupAPI(LoadLibraryFromSystem32(_T("SETUPAPI.DLL")));
  if (setupAPI == NULL)
    return FALSE;

  SETUPDIOPENDEVREGKEY* lpfnLPSETUPDIOPENDEVREGKEY = reinterpret_cast&lt;SETUPDIOPENDEVREGKEY*&gt;(GetProcAddress(setupAPI, "SetupDiOpenDevRegKey"));
#if defined _UNICODE
  SETUPDICLASSGUIDSFROMNAME* lpfnSETUPDICLASSGUIDSFROMNAME = reinterpret_cast&lt;SETUPDICLASSGUIDSFROMNAME*&gt;(GetProcAddress(setupAPI, "SetupDiClassGuidsFromNameW"));
  SETUPDIGETCLASSDEVS* lpfnSETUPDIGETCLASSDEVS = reinterpret_cast&lt;SETUPDIGETCLASSDEVS*&gt;(GetProcAddress(setupAPI, "SetupDiGetClassDevsW"));
  SETUPDIGETDEVICEREGISTRYPROPERTY* lpfnSETUPDIGETDEVICEREGISTRYPROPERTY = reinterpret_cast&lt;SETUPDIGETDEVICEREGISTRYPROPERTY*&gt;(GetProcAddress(setupAPI, "SetupDiGetDeviceRegistryPropertyW"));
#else
  SETUPDICLASSGUIDSFROMNAME* lpfnSETUPDICLASSGUIDSFROMNAME = reinterpret_cast&lt;SETUPDICLASSGUIDSFROMNAME*&gt;(GetProcAddress(setupAPI, "SetupDiClassGuidsFromNameA"));
  SETUPDIGETCLASSDEVS* lpfnSETUPDIGETCLASSDEVS = reinterpret_cast&lt;SETUPDIGETCLASSDEVS*&gt;(GetProcAddress(setupAPI, "SetupDiGetClassDevsA"));
  SETUPDIGETDEVICEREGISTRYPROPERTY* lpfnSETUPDIGETDEVICEREGISTRYPROPERTY = reinterpret_cast&lt;SETUPDIGETDEVICEREGISTRYPROPERTY*&gt;(GetProcAddress(setupAPI, "SetupDiGetDeviceRegistryPropertyA"));
#endif
  SETUPDIDESTROYDEVICEINFOLIST* lpfnSETUPDIDESTROYDEVICEINFOLIST = reinterpret_cast&lt;SETUPDIDESTROYDEVICEINFOLIST*&gt;(GetProcAddress(setupAPI, "SetupDiDestroyDeviceInfoList"));
  SETUPDIENUMDEVICEINFO* lpfnSETUPDIENUMDEVICEINFO = reinterpret_cast&lt;SETUPDIENUMDEVICEINFO*&gt;(GetProcAddress(setupAPI, "SetupDiEnumDeviceInfo"));

  if ((lpfnLPSETUPDIOPENDEVREGKEY == NULL) || (lpfnSETUPDICLASSGUIDSFROMNAME == NULL) || (lpfnSETUPDIDESTROYDEVICEINFOLIST == NULL) ||
      (lpfnSETUPDIENUMDEVICEINFO == NULL) || (lpfnSETUPDIGETCLASSDEVS == NULL) || (lpfnSETUPDIGETDEVICEREGISTRYPROPERTY == NULL))
  {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-58" id="section-58"></a>
</div>
<p>Set the error to report</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    setupAPI.m_dwError = ERROR_CALL_NOT_IMPLEMENTED;

    <span class="hljs-keyword">return</span> FALSE;
  }
  
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59"></a>
</div>
<p>First need to convert the name &quot;Ports&quot; to a GUID using SetupDiClassGuidsFromName</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  DWORD dwGuids = <span class="hljs-number">0</span>;
  lpfnSETUPDICLASSGUIDSFROMNAME(_T(<span class="hljs-string">"Ports"</span>), <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;dwGuids);
  <span class="hljs-keyword">if</span> (dwGuids == <span class="hljs-number">0</span>)
  {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60"></a>
</div>
<p>Set the error to report</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    setupAPI.m_dwError = GetLastError();

    <span class="hljs-keyword">return</span> FALSE;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61"></a>
</div>
<p>Allocate the needed memory</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  CAutoHeapAlloc guids;
  <span class="hljs-keyword">if</span> (!guids.Allocate(dwGuids * <span class="hljs-keyword">sizeof</span>(GUID)))
  {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62"></a>
</div>
<p>Set the error to report</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    setupAPI.m_dwError = ERROR_OUTOFMEMORY;

    <span class="hljs-keyword">return</span> FALSE;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63"></a>
</div>
<p>Call the function again</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  GUID* pGuids = <span class="hljs-keyword">static_cast</span>&lt;GUID*&gt;(guids.m_pData);
  <span class="hljs-keyword">if</span> (!lpfnSETUPDICLASSGUIDSFROMNAME(_T(<span class="hljs-string">"Ports"</span>), pGuids, dwGuids, &amp;dwGuids))
  {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-64" id="section-64"></a>
</div>
<p>Set the error to report</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    setupAPI.m_dwError = GetLastError();

    <span class="hljs-keyword">return</span> FALSE;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-65" id="section-65"></a>
</div>
<p>Now create a &quot;device information set&quot; which is required to enumerate all the ports</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  HDEVINFO hDevInfoSet = lpfnSETUPDIGETCLASSDEVS(pGuids, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, DIGCF_PRESENT);
  <span class="hljs-keyword">if</span> (hDevInfoSet == INVALID_HANDLE_VALUE)
  {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66"></a>
</div>
<p>Set the error to report</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    setupAPI.m_dwError = GetLastError();

    <span class="hljs-keyword">return</span> FALSE;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67"></a>
</div>
<p>Finally do the enumeration</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  BOOL bMoreItems = TRUE;
  <span class="hljs-keyword">int</span> nIndex = <span class="hljs-number">0</span>;
  SP_DEVINFO_DATA devInfo;
  <span class="hljs-keyword">while</span> (bMoreItems)
  {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-68" id="section-68"></a>
</div>
<p>Enumerate the current device</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    devInfo.cbSize = <span class="hljs-keyword">sizeof</span>(SP_DEVINFO_DATA);
    bMoreItems = lpfnSETUPDIENUMDEVICEINFO(hDevInfoSet, nIndex, &amp;devInfo);
    <span class="hljs-keyword">if</span> (bMoreItems)
    {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-69" id="section-69"></a>
</div>
<p>Did we find a serial port for this device</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">      BOOL bAdded = FALSE;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-70" id="section-70"></a>
</div>
<p>Get the registry key which stores the ports settings</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">      HKEY hDeviceKey = lpfnLPSETUPDIOPENDEVREGKEY(hDevInfoSet, &amp;devInfo, DICS_FLAG_GLOBAL, <span class="hljs-number">0</span>, DIREG_DEV, KEY_QUERY_VALUE);
      <span class="hljs-keyword">if</span> (hDeviceKey)
      {
        <span class="hljs-keyword">int</span> nPort = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (QueryRegistryPortName(hDeviceKey, nPort))
        {
        <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
          ports.push_back(nPort);
        <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
          ports.Add(nPort);
        <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>
          bAdded = TRUE;
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-71" id="section-71"></a>
</div>
<p>Close the key now that we are finished with it</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">        RegCloseKey(hDeviceKey);
      }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-72" id="section-72"></a>
</div>
<p>If the port was a serial port, then also try to get its friendly name</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">      <span class="hljs-keyword">if</span> (bAdded)
      {
        TCHAR szFriendlyName[<span class="hljs-number">1024</span>];
        szFriendlyName[<span class="hljs-number">0</span>] = _T(<span class="hljs-string">'\0'</span>);
        DWORD dwSize = <span class="hljs-keyword">sizeof</span>(szFriendlyName);
        DWORD dwType = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (lpfnSETUPDIGETDEVICEREGISTRYPROPERTY(hDevInfoSet, &amp;devInfo, SPDRP_DEVICEDESC, &amp;dwType, <span class="hljs-keyword">reinterpret_cast</span>&lt;PBYTE&gt;(szFriendlyName), dwSize, &amp;dwSize) &amp;&amp; (dwType == REG_SZ))
        {
        <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
          friendlyNames.push_back(szFriendlyName);
        <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
          friendlyNames.Add(szFriendlyName);
        <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>
        }
        <span class="hljs-keyword">else</span>
        {
        #<span class="hljs-keyword">if</span> defined CENUMERATESERIAL_USE_STL
          friendlyNames.push_back(_T(<span class="hljs-string">""</span>));
        <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
          friendlyNames.Add(_T(<span class="hljs-string">""</span>));
        <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>
        }
      }
    }

    ++nIndex;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-73" id="section-73"></a>
</div>
<p>Free up the &quot;device information set&quot; now that we are finished with it</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  lpfnSETUPDIDESTROYDEVICEINFOLIST(hDevInfoSet);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-74" id="section-74"></a>
</div>
<p>Return the success indicator</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  <span class="hljs-keyword">return</span> TRUE;
}
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> NO_ENUMSERIAL_USING_ENUMPORTS</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
BOOL CEnumerateSerial::UsingEnumPorts(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;UINT&gt;&amp; ports)
<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> defined _AFX</span>
BOOL CEnumerateSerial::UsingEnumPorts(CUIntArray&amp; ports)
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
BOOL CEnumerateSerial::UsingEnumPorts(CSimpleArray&lt;UINT&gt;&amp; ports)
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-75" id="section-75"></a>
</div>
<p>Make sure we clear out any elements which may already be in the array</p>

        </td>
        <td class="code highlight">
          <pre class="cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
  ports.clear();
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
  ports.RemoveAll();
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-76" id="section-76"></a>
</div>
<p>Call the first time to determine the size of the buffer to allocate</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  DWORD cbNeeded = <span class="hljs-number">0</span>;
  DWORD dwPorts = <span class="hljs-number">0</span>;
  EnumPorts(<span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;cbNeeded, &amp;dwPorts);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-77" id="section-77"></a>
</div>
<p>What will be the return value</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  BOOL bSuccess = FALSE;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-78" id="section-78"></a>
</div>
<p>Allocate the buffer and recall</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  CAutoHeapAlloc portsBuffer;
  <span class="hljs-keyword">if</span> (portsBuffer.Allocate(cbNeeded))
  {
    BYTE* pPorts = <span class="hljs-keyword">static_cast</span>&lt;BYTE*&gt;(portsBuffer.m_pData);
    bSuccess = EnumPorts(<span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, pPorts, cbNeeded, &amp;cbNeeded, &amp;dwPorts);
    <span class="hljs-keyword">if</span> (bSuccess)
    {
      PORT_INFO_1* pPortInfo = <span class="hljs-keyword">reinterpret_cast</span>&lt;PORT_INFO_1*&gt;(pPorts);
      <span class="hljs-keyword">for</span> (DWORD i=<span class="hljs-number">0</span>; i&lt;dwPorts; i++)
      {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-79" id="section-79"></a>
</div>
<p>If it looks like &quot;COMX&quot; then
add it to the array which will be returned</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">        <span class="hljs-keyword">size_t</span> nLen = _tcslen(pPortInfo-&gt;pName);
        <span class="hljs-keyword">if</span> (nLen &gt; <span class="hljs-number">3</span>)
        {
          <span class="hljs-keyword">if</span> ((_tcsnicmp(pPortInfo-&gt;pName, _T(<span class="hljs-string">"COM"</span>), <span class="hljs-number">3</span>) == <span class="hljs-number">0</span>) &amp;&amp; IsNumeric(&amp;(pPortInfo-&gt;pName[<span class="hljs-number">3</span>]), TRUE))
          {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-80" id="section-80"></a>
</div>
<p>Work out the port number</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">            <span class="hljs-keyword">int</span> nPort = _ttoi(&amp;(pPortInfo-&gt;pName[<span class="hljs-number">3</span>]));
          <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
            ports.push_back(nPort);
          <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
            ports.Add(nPort);
          <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>
          }
        }

        pPortInfo++;
      }
    }
  }
  <span class="hljs-keyword">else</span>
    SetLastError(ERROR_OUTOFMEMORY);        
  
  <span class="hljs-keyword">return</span> bSuccess;
}
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> NO_ENUMSERIAL_USING_WMI</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined _UNICODE</span>
BOOL CEnumerateSerial::UsingWMI(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;UINT&gt;&amp; ports, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::wstring&gt;&amp; friendlyNames)
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
BOOL CEnumerateSerial::UsingWMI(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;UINT&gt;&amp; ports, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&gt;&amp; friendlyNames)
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> defined _AFX</span>
BOOL CEnumerateSerial::UsingWMI(CUIntArray&amp; ports, CStringArray&amp; friendlyNames)
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
BOOL CEnumerateSerial::UsingWMI(CSimpleArray&lt;UINT&gt;&amp; ports, CSimpleArray&lt;CString&gt;&amp; friendlyNames)
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-81" id="section-81"></a>
</div>
<p>Make sure we clear out any elements which may already be in the array(s)</p>

        </td>
        <td class="code highlight">
          <pre class="cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
  ports.clear();
  friendlyNames.clear();
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
  ports.RemoveAll();
  friendlyNames.RemoveAll();
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-82" id="section-82"></a>
</div>
<p>What will be the return value</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  BOOL bSuccess = FALSE;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-83" id="section-83"></a>
</div>
<p>Create the WBEM locator</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  ATL::CComPtr&lt;IWbemLocator&gt; locator;
  HRESULT hr = CoCreateInstance(CLSID_WbemLocator, <span class="hljs-literal">NULL</span>, CLSCTX_INPROC_SERVER, IID_IWbemLocator, <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">void</span>**&gt;(&amp;locator));
  <span class="hljs-keyword">if</span> (SUCCEEDED(hr))
  {
    ATL::CComPtr&lt;IWbemServices&gt; services;
    hr = locator-&gt;ConnectServer(<span class="hljs-keyword">_bstr_t</span>(<span class="hljs-string">"\\\\.\\root\\cimv2"</span>), <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;services);
    <span class="hljs-keyword">if</span> (SUCCEEDED(hr))
    {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-84" id="section-84"></a>
</div>
<p>Execute the query</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">      ATL::CComPtr&lt;IEnumWbemClassObject&gt; classObject;
      hr = services-&gt;CreateInstanceEnum(<span class="hljs-keyword">_bstr_t</span>(<span class="hljs-string">"Win32_SerialPort"</span>), WBEM_FLAG_RETURN_WBEM_COMPLETE, <span class="hljs-literal">NULL</span>, &amp;classObject);
      <span class="hljs-keyword">if</span> (SUCCEEDED(hr))
      {
        bSuccess = TRUE;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-85" id="section-85"></a>
</div>
<p>Now enumerate all the ports</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">        hr = WBEM_S_NO_ERROR;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-86" id="section-86"></a>
</div>
<p>Final Next will return WBEM_S_FALSE</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">        <span class="hljs-keyword">while</span> (hr == WBEM_S_NO_ERROR)
        {
          ULONG uReturned = <span class="hljs-number">0</span>;
          ATL::CComPtr&lt;IWbemClassObject&gt; apObj[<span class="hljs-number">10</span>];
          hr = classObject-&gt;Next(WBEM_INFINITE, <span class="hljs-number">10</span>, <span class="hljs-keyword">reinterpret_cast</span>&lt;IWbemClassObject**&gt;(apObj), &amp;uReturned);
          <span class="hljs-keyword">if</span> (SUCCEEDED(hr))
          {
            <span class="hljs-keyword">for</span> (ULONG n=<span class="hljs-number">0</span>; n&lt;uReturned; n++)
            {
              ATL::CComVariant varProperty1;
              HRESULT hrGet = Nan::Get(apObj[n], <span class="hljs-string">L"DeviceID"</span>, <span class="hljs-number">0</span>, &amp;varProperty1, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);
              <span class="hljs-keyword">if</span> (SUCCEEDED(hrGet) &amp;&amp; (varProperty1.vt == VT_BSTR) &amp;&amp; (wcslen(varProperty1.bstrVal) &gt; <span class="hljs-number">3</span>))
              {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-87" id="section-87"></a>
</div>
<p>If it looks like &quot;COMX&quot; then add it to the array which will be returned</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">                <span class="hljs-keyword">if</span> ((_wcsnicmp(varProperty1.bstrVal, <span class="hljs-string">L"COM"</span>, <span class="hljs-number">3</span>) == <span class="hljs-number">0</span>) &amp;&amp; IsNumeric(&amp;(varProperty1.bstrVal[<span class="hljs-number">3</span>]), TRUE))
                {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-88" id="section-88"></a>
</div>
<p>Work out the port number</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">                  <span class="hljs-keyword">int</span> nPort = _wtoi(&amp;(varProperty1.bstrVal[<span class="hljs-number">3</span>]));
                <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
                  ports.push_back(nPort);
                <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
                  ports.Add(nPort);
                <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-89" id="section-89"></a>
</div>
<p>Also get the friendly name of the port</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">                  ATL::CComVariant varProperty2;
                  if Nan::Get((SUCCEEDED(apObj[n], L"Name", 0, &amp;varProperty2, NULL, NULL)) &amp;&amp; (varProperty2.vt == VT_BSTR))
                  {  
                #if defined CENUMERATESERIAL_USE_STL
                  #if defined _UNICODE  
                    std::wstring szName(varProperty2.bstrVal);
                  #else
                    std::string szName(ATL::CW2A(varProperty2.bstrVal));
                  #endif
                    friendlyNames.push_back(szName);
                  #else
                    friendlyNames.Add(CString(varProperty2.bstrVal));    
                  #endif
                  }
                  else
                  {
                  #if defined CENUMERATESERIAL_USE_STL
                    friendlyNames.push_back(_T(""));
                  #else
                    friendlyNames.Add(_T(""));
                  #endif  
                  }
                }
              }
            }
          }
        }
      }
    }
  }
  
  return bSuccess;
}
#endif

#ifndef NO_ENUMSERIAL_USING_COMDB
#if defined CENUMERATESERIAL_USE_STL
BOOL CEnumerateSerial::UsingComDB(std::vector&lt;UINT&gt;&amp; ports)
#elif defined _AFX
BOOL CEnumerateSerial::UsingComDB(CUIntArray&amp; ports)
#else
BOOL CEnumerateSerial::UsingComDB(CSimpleArray&lt;UINT&gt;&amp; ports)
#endif
{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-90" id="section-90"></a>
</div>
<p>Make sure we clear out any elements which may already be in the array(s)</p>

        </td>
        <td class="code highlight">
          <pre class="cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
  ports.clear();
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
  ports.RemoveAll();
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-91" id="section-91"></a>
</div>
<p>What will be the return value from this function (assume the worst)</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  BOOL bSuccess = FALSE;
  
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-92" id="section-92"></a>
</div>
<p>Get the function pointers to &quot;ComDBOpen&quot;, &quot;ComDBClose&quot; &amp; &quot;ComDBGetCurrentPortUsage&quot; in msports.dll</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  CAutoHModule msPorts(LoadLibraryFromSystem32(_T("MSPORTS.DLL")));
  if (msPorts == NULL)
    return FALSE;

  COMDBOPEN* lpfnLPCOMDBOPEN = reinterpret_cast&lt;COMDBOPEN*&gt;(GetProcAddress(msPorts, "ComDBOpen"));
  COMDBCLOSE* lpfnLPCOMDBCLOSE = reinterpret_cast&lt;COMDBCLOSE*&gt;(GetProcAddress(msPorts, "ComDBClose"));
  COMDBGETCURRENTPORTUSAGE* lpfnCOMDBGETCURRENTPORTUSAGE = reinterpret_cast&lt;COMDBGETCURRENTPORTUSAGE*&gt;(GetProcAddress(msPorts, "ComDBGetCurrentPortUsage"));
  if ((lpfnLPCOMDBOPEN != NULL) &amp;&amp; (lpfnLPCOMDBCLOSE != NULL) &amp;&amp; (lpfnCOMDBGETCURRENTPORTUSAGE != NULL))
  {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-93" id="section-93"></a>
</div>
<p>First need to open up the DB</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    HCOMDB hComDB;
    DWORD dwComOpen = lpfnLPCOMDBOPEN(&amp;hComDB);
    <span class="hljs-keyword">if</span> (dwComOpen == ERROR_SUCCESS)
    {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-94" id="section-94"></a>
</div>
<p>Work out the size of the buffer required</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">      DWORD dwMaxPortsReported = <span class="hljs-number">0</span>;
      DWORD dwPortUsage = lpfnCOMDBGETCURRENTPORTUSAGE(hComDB, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, CDB_REPORT_BYTES, &amp;dwMaxPortsReported);
      <span class="hljs-keyword">if</span> (dwPortUsage == ERROR_SUCCESS)
      {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-95" id="section-95"></a>
</div>
<p>Allocate some heap space and recall the function</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">        CAutoHeapAlloc portBytes;
        <span class="hljs-keyword">if</span> (portBytes.Allocate(dwMaxPortsReported))
        {
          bSuccess = TRUE;

          PBYTE pPortBytes = <span class="hljs-keyword">static_cast</span>&lt;PBYTE&gt;(portBytes.m_pData);
          <span class="hljs-keyword">if</span> (lpfnCOMDBGETCURRENTPORTUSAGE(hComDB, pPortBytes, dwMaxPortsReported, CDB_REPORT_BYTES, &amp;dwMaxPortsReported) == ERROR_SUCCESS)
          {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-96" id="section-96"></a>
</div>
<p>Work thro the byte bit array for ports which are in use</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">            <span class="hljs-keyword">for</span> (DWORD i=<span class="hljs-number">0</span>; i&lt;dwMaxPortsReported; i++)
            {
              <span class="hljs-keyword">if</span> (pPortBytes[i])
              {
              <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
                ports.push_back(i + <span class="hljs-number">1</span>);
              <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
                ports.Add(i + <span class="hljs-number">1</span>);
              <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
              }
            }
          }
        }
        <span class="hljs-keyword">else</span>
          msPorts.m_dwError = ERROR_OUTOFMEMORY;
      }
      <span class="hljs-keyword">else</span>
        msPorts.m_dwError = dwPortUsage;
    
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-97" id="section-97"></a>
</div>
<p>Close the DB</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">      lpfnLPCOMDBCLOSE(hComDB);
    }
    <span class="hljs-keyword">else</span>
      msPorts.m_dwError = dwComOpen;
  }
  <span class="hljs-keyword">else</span>
    msPorts.m_dwError = ERROR_CALL_NOT_IMPLEMENTED;

  <span class="hljs-keyword">return</span> bSuccess;
}
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> NO_ENUMSERIAL_USING_REGISTRY</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined _UNICODE</span>
BOOL CEnumerateSerial::UsingRegistry(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::wstring&gt;&amp; ports)
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
BOOL CEnumerateSerial::UsingRegistry(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&gt;&amp; ports)
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> defined _AFX</span>
BOOL CEnumerateSerial::UsingRegistry(CStringArray&amp; ports)
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
BOOL CEnumerateSerial::UsingRegistry(CSimpleArray&lt;CString&gt;&amp; ports)
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-98" id="section-98"></a>
</div>
<p>Make sure we clear out any elements which may already be in the array(s)</p>

        </td>
        <td class="code highlight">
          <pre class="cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
  ports.clear();
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
  ports.RemoveAll();
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  </span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-99" id="section-99"></a>
</div>
<p>What will be the return value from this function (assume the worst)</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  BOOL bSuccess = FALSE;

  HKEY hSERIALCOMM;
  <span class="hljs-keyword">if</span> (RegOpenKeyEx(HKEY_LOCAL_MACHINE, _T(<span class="hljs-string">"HARDWARE\\DEVICEMAP\\SERIALCOMM"</span>), <span class="hljs-number">0</span>, KEY_QUERY_VALUE, &amp;hSERIALCOMM) == ERROR_SUCCESS)
  {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-100" id="section-100"></a>
</div>
<p>Get the max value name and max value lengths</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    DWORD dwMaxValueNameLen;
    DWORD dwMaxValueLen;
    DWORD dwQueryInfo = RegQueryInfoKey(hSERIALCOMM, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;dwMaxValueNameLen, &amp;dwMaxValueLen, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (dwQueryInfo == ERROR_SUCCESS)
    {
      DWORD dwMaxValueNameSizeInChars = dwMaxValueNameLen + <span class="hljs-number">1</span>; <span class="hljs-comment">//Include space for the NULL terminator</span>
      DWORD dwMaxValueNameSizeInBytes = dwMaxValueNameSizeInChars * <span class="hljs-keyword">sizeof</span>(TCHAR);
      DWORD dwMaxValueDataSizeInChars = dwMaxValueLen/<span class="hljs-keyword">sizeof</span>(TCHAR) + <span class="hljs-number">1</span>; <span class="hljs-comment">//Include space for the NULL terminator</span>
      DWORD dwMaxValueDataSizeInBytes = dwMaxValueDataSizeInChars * <span class="hljs-keyword">sizeof</span>(TCHAR);
    
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-101" id="section-101"></a>
</div>
<p>Allocate some space for the value name and value data</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">      CAutoHeapAlloc valueName;
      CAutoHeapAlloc valueData;
      <span class="hljs-keyword">if</span> (valueName.Allocate(dwMaxValueNameSizeInBytes) &amp;&amp; valueData.Allocate(dwMaxValueDataSizeInBytes))
      {
        bSuccess = TRUE;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-102" id="section-102"></a>
</div>
<p>Enumerate all the values underneath HKEY_LOCAL_MACHINE\HARDWARE\DEVICEMAP\SERIALCOMM</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">        DWORD dwIndex = <span class="hljs-number">0</span>;
        DWORD dwType;
        DWORD dwValueNameSize = dwMaxValueNameSizeInChars;
        DWORD dwDataSize = dwMaxValueDataSizeInBytes;
        <span class="hljs-built_in">memset</span>(valueName.m_pData, <span class="hljs-number">0</span>, dwMaxValueNameSizeInBytes);
        <span class="hljs-built_in">memset</span>(valueData.m_pData, <span class="hljs-number">0</span>, dwMaxValueDataSizeInBytes);
        TCHAR* szValueName = <span class="hljs-keyword">static_cast</span>&lt;TCHAR*&gt;(valueName.m_pData);
        BYTE* byValue = <span class="hljs-keyword">static_cast</span>&lt;BYTE*&gt;(valueData.m_pData);
        LONG nEnum = RegEnumValue(hSERIALCOMM, dwIndex, szValueName, &amp;dwValueNameSize, <span class="hljs-literal">NULL</span>, &amp;dwType, byValue, &amp;dwDataSize);
        <span class="hljs-keyword">while</span> (nEnum == ERROR_SUCCESS)
        {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-103" id="section-103"></a>
</div>
<p>If the value is of the correct type, then add it to the array</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">          <span class="hljs-keyword">if</span> (dwType == REG_SZ)
          {
            TCHAR* szPort = <span class="hljs-keyword">reinterpret_cast</span>&lt;TCHAR*&gt;(byValue);
          <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined CENUMERATESERIAL_USE_STL</span>
            ports.push_back(szPort);
          <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
            ports.Add(szPort);
          <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  						</span>
          }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-104" id="section-104"></a>
</div>
<p>Prepare for the next time around</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">          dwValueNameSize = dwMaxValueNameSizeInChars;
          dwDataSize = dwMaxValueDataSizeInBytes;
          <span class="hljs-built_in">memset</span>(valueName.m_pData, <span class="hljs-number">0</span>, dwMaxValueNameSizeInBytes);
          <span class="hljs-built_in">memset</span>(valueData.m_pData, <span class="hljs-number">0</span>, dwMaxValueDataSizeInBytes);
          ++dwIndex;
          nEnum = RegEnumValue(hSERIALCOMM, dwIndex, szValueName, &amp;dwValueNameSize, <span class="hljs-literal">NULL</span>, &amp;dwType, byValue, &amp;dwDataSize);
        }
      }
      <span class="hljs-keyword">else</span>
        SetLastError(ERROR_OUTOFMEMORY);
    }
    
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-105" id="section-105"></a>
</div>
<p>Close the registry key now that we are finished with it</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    RegCloseKey(hSERIALCOMM);
    
    <span class="hljs-keyword">if</span> (dwQueryInfo != ERROR_SUCCESS)
      SetLastError(dwQueryInfo);
  }
  
  <span class="hljs-keyword">return</span> bSuccess;
}
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

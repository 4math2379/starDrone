<!DOCTYPE html>
<html>
<head>
  <title>serialport_unix.cpp</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "node_modules/serialport/src/serialport_unix.cpp";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>serialport_unix.cpp</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"./serialport.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"./serialport_poller.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;termios.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __APPLE__</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;AvailabilityMacros.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/param.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;IOKit/IOKitLib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;IOKit/IOCFPlugIn.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;IOKit/usb/IOUSBLib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;IOKit/serial/IOSerialKeys.h&gt;</span></span>

<span class="hljs-keyword">uv_mutex_t</span> list_mutex;
Boolean lockInitialised = FALSE;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(MAC_OS_X_VERSION_10_4) &amp;&amp; (MAC_OS_X_VERSION_MIN_REQUIRED &gt;= MAC_OS_X_VERSION_10_4)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;IOKit/serial/ioss.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__OpenBSD__)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__linux__)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/serial.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-keyword">struct</span> UnixPlatformOptions : OpenBatonPlatformOptions {
  <span class="hljs-keyword">uint8_t</span> vmin;
  <span class="hljs-keyword">uint8_t</span> vtime;
};

<span class="hljs-function">OpenBatonPlatformOptions* <span class="hljs-title">ParsePlatformOptions</span><span class="hljs-params">(<span class="hljs-keyword">const</span> v8::Local&lt;v8::Object&gt;&amp; options)</span> </span>{
  Nan::HandleScope scope;

  UnixPlatformOptions* result = <span class="hljs-keyword">new</span> UnixPlatformOptions();
  result-&gt;vmin = Nan::Get(options, Nan::New&lt;v8::String&gt;(<span class="hljs-string">"vmin"</span>).ToLocalChecked()).ToLocalChecked()-&gt;ToInt32()-&gt;Int32Value();
  result-&gt;vtime = Nan::Get(options, Nan::New&lt;v8::String&gt;(<span class="hljs-string">"vtime"</span>).ToLocalChecked()).ToLocalChecked()-&gt;ToInt32()-&gt;Int32Value();

  <span class="hljs-keyword">return</span> result;
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">ToBaudConstant</span><span class="hljs-params">(<span class="hljs-keyword">int</span> baudRate)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">ToDataBitsConstant</span><span class="hljs-params">(<span class="hljs-keyword">int</span> dataBits)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">ToStopBitsConstant</span><span class="hljs-params">(SerialPortStopBits stopBits)</span></span>;

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">AfterOpenSuccess</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, Nan::Callback* dataCallback, Nan::Callback* disconnectedCallback, Nan::Callback* errorCallback)</span> </span>{
  <span class="hljs-keyword">delete</span> dataCallback;
  <span class="hljs-keyword">delete</span> errorCallback;
  <span class="hljs-keyword">delete</span> disconnectedCallback;
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">ToBaudConstant</span><span class="hljs-params">(<span class="hljs-keyword">int</span> baudRate)</span> </span>{
  <span class="hljs-keyword">switch</span> (baudRate) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: <span class="hljs-keyword">return</span> B0;
    <span class="hljs-keyword">case</span> <span class="hljs-number">50</span>: <span class="hljs-keyword">return</span> B50;
    <span class="hljs-keyword">case</span> <span class="hljs-number">75</span>: <span class="hljs-keyword">return</span> B75;
    <span class="hljs-keyword">case</span> <span class="hljs-number">110</span>: <span class="hljs-keyword">return</span> B110;
    <span class="hljs-keyword">case</span> <span class="hljs-number">134</span>: <span class="hljs-keyword">return</span> B134;
    <span class="hljs-keyword">case</span> <span class="hljs-number">150</span>: <span class="hljs-keyword">return</span> B150;
    <span class="hljs-keyword">case</span> <span class="hljs-number">200</span>: <span class="hljs-keyword">return</span> B200;
    <span class="hljs-keyword">case</span> <span class="hljs-number">300</span>: <span class="hljs-keyword">return</span> B300;
    <span class="hljs-keyword">case</span> <span class="hljs-number">600</span>: <span class="hljs-keyword">return</span> B600;
    <span class="hljs-keyword">case</span> <span class="hljs-number">1200</span>: <span class="hljs-keyword">return</span> B1200;
    <span class="hljs-keyword">case</span> <span class="hljs-number">1800</span>: <span class="hljs-keyword">return</span> B1800;
    <span class="hljs-keyword">case</span> <span class="hljs-number">2400</span>: <span class="hljs-keyword">return</span> B2400;
    <span class="hljs-keyword">case</span> <span class="hljs-number">4800</span>: <span class="hljs-keyword">return</span> B4800;
    <span class="hljs-keyword">case</span> <span class="hljs-number">9600</span>: <span class="hljs-keyword">return</span> B9600;
    <span class="hljs-keyword">case</span> <span class="hljs-number">19200</span>: <span class="hljs-keyword">return</span> B19200;
    <span class="hljs-keyword">case</span> <span class="hljs-number">38400</span>: <span class="hljs-keyword">return</span> B38400;
    <span class="hljs-keyword">case</span> <span class="hljs-number">57600</span>: <span class="hljs-keyword">return</span> B57600;
    <span class="hljs-keyword">case</span> <span class="hljs-number">115200</span>: <span class="hljs-keyword">return</span> B115200;
    <span class="hljs-keyword">case</span> <span class="hljs-number">230400</span>: <span class="hljs-keyword">return</span> B230400;
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__linux__)</span>
    <span class="hljs-keyword">case</span> <span class="hljs-number">460800</span>: <span class="hljs-keyword">return</span> B460800;
    <span class="hljs-keyword">case</span> <span class="hljs-number">500000</span>: <span class="hljs-keyword">return</span> B500000;
    <span class="hljs-keyword">case</span> <span class="hljs-number">576000</span>: <span class="hljs-keyword">return</span> B576000;
    <span class="hljs-keyword">case</span> <span class="hljs-number">921600</span>: <span class="hljs-keyword">return</span> B921600;
    <span class="hljs-keyword">case</span> <span class="hljs-number">1000000</span>: <span class="hljs-keyword">return</span> B1000000;
    <span class="hljs-keyword">case</span> <span class="hljs-number">1152000</span>: <span class="hljs-keyword">return</span> B1152000;
    <span class="hljs-keyword">case</span> <span class="hljs-number">1500000</span>: <span class="hljs-keyword">return</span> B1500000;
    <span class="hljs-keyword">case</span> <span class="hljs-number">2000000</span>: <span class="hljs-keyword">return</span> B2000000;
    <span class="hljs-keyword">case</span> <span class="hljs-number">2500000</span>: <span class="hljs-keyword">return</span> B2500000;
    <span class="hljs-keyword">case</span> <span class="hljs-number">3000000</span>: <span class="hljs-keyword">return</span> B3000000;
    <span class="hljs-keyword">case</span> <span class="hljs-number">3500000</span>: <span class="hljs-keyword">return</span> B3500000;
    <span class="hljs-keyword">case</span> <span class="hljs-number">4000000</span>: <span class="hljs-keyword">return</span> B4000000;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
}

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __APPLE__</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> SerialDevice {
    <span class="hljs-keyword">char</span> port[MAXPATHLEN];
    <span class="hljs-keyword">char</span> locationId[MAXPATHLEN];
    <span class="hljs-keyword">char</span> vendorId[MAXPATHLEN];
    <span class="hljs-keyword">char</span> productId[MAXPATHLEN];
    <span class="hljs-keyword">char</span> manufacturer[MAXPATHLEN];
    <span class="hljs-keyword">char</span> serialNumber[MAXPATHLEN];
} stSerialDevice;

<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> DeviceListItem {
    <span class="hljs-keyword">struct</span> SerialDevice value;
    <span class="hljs-keyword">struct</span> DeviceListItem *next;
    <span class="hljs-keyword">int</span>* length;
} stDeviceListItem;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">ToDataBitsConstant</span><span class="hljs-params">(<span class="hljs-keyword">int</span> dataBits)</span> </span>{
  <span class="hljs-keyword">switch</span> (dataBits) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">8</span>: <span class="hljs-keyword">default</span>: <span class="hljs-keyword">return</span> CS8;
    <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>: <span class="hljs-keyword">return</span> CS7;
    <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>: <span class="hljs-keyword">return</span> CS6;
    <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>: <span class="hljs-keyword">return</span> CS5;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">EIO_Open</span><span class="hljs-params">(<span class="hljs-keyword">uv_work_t</span>* req)</span> </span>{
  OpenBaton* data = <span class="hljs-keyword">static_cast</span>&lt;OpenBaton*&gt;(req-&gt;data);

  <span class="hljs-keyword">int</span> flags = (O_RDWR | O_NOCTTY | O_NONBLOCK | O_CLOEXEC | O_SYNC);
  <span class="hljs-keyword">int</span> fd = open(data-&gt;path, flags);

  <span class="hljs-keyword">if</span> (<span class="hljs-number">-1</span> == fd) {
    <span class="hljs-built_in">snprintf</span>(data-&gt;errorString, <span class="hljs-keyword">sizeof</span>(data-&gt;errorString), <span class="hljs-string">"Cannot open %s"</span>, data-&gt;path);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-number">-1</span> == setup(fd, data)) {
    close(fd);
    <span class="hljs-keyword">return</span>;
  }

  data-&gt;result = fd;
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">EIO_Update</span><span class="hljs-params">(<span class="hljs-keyword">uv_work_t</span>* req)</span> </span>{
  OpenBaton* data = <span class="hljs-keyword">static_cast</span>&lt;OpenBaton*&gt;(req-&gt;data);

  <span class="hljs-keyword">int</span> fd = data-&gt;fd;

  <span class="hljs-keyword">if</span> (<span class="hljs-number">-1</span> == setup(fd, data)) {
    <span class="hljs-keyword">return</span>;
  }

  data-&gt;result = fd;
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">setup</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, OpenBaton *data)</span> </span>{
  UnixPlatformOptions* platformOptions = <span class="hljs-keyword">static_cast</span>&lt;UnixPlatformOptions*&gt;(data-&gt;platformOptions);

  <span class="hljs-keyword">int</span> baudRate = ToBaudConstant(data-&gt;baudRate);
  <span class="hljs-keyword">int</span> dataBits = ToDataBitsConstant(data-&gt;dataBits);
  <span class="hljs-keyword">if</span> (dataBits == <span class="hljs-number">-1</span>) {
    <span class="hljs-built_in">snprintf</span>(data-&gt;errorString, <span class="hljs-keyword">sizeof</span>(data-&gt;errorString), <span class="hljs-string">"Invalid data bits setting %d"</span>, data-&gt;dataBits);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Snow Leopard doesn't have O_CLOEXEC</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  <span class="hljs-keyword">int</span> cloexec = fcntl(fd, F_SETFD, FD_CLOEXEC);
  <span class="hljs-keyword">if</span> (cloexec == <span class="hljs-number">-1</span>) {
    <span class="hljs-built_in">snprintf</span>(data-&gt;errorString, <span class="hljs-keyword">sizeof</span>(data-&gt;errorString), <span class="hljs-string">"Cannot open %s"</span>, data-&gt;path);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>struct sigaction saio;
saio.sa_handler = sigio_handler;
sigemptyset(&amp;saio.sa_mask);
saio.sa_flags = 0;
sigaction(SIGIO, &amp;saio, NULL);</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>//all process to receive SIGIO
fcntl(fd, F_SETOWN, getpid());
int flflags = fcntl(fd, F_GETFL);
fcntl(fd, F_SETFL, flflags | FNONBLOCK);</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">
  <span class="hljs-keyword">struct</span> termios options;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Set baud and other configuration.</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  tcgetattr(fd, &amp;options);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Removing check for valid BaudRates due to ticket: #140
#if not ( defined(MAC_OS_X_VERSION_10_4) &amp;&amp; (MAC_OS_X_VERSION_MIN_REQUIRED &gt;= MAC_OS_X_VERSION_10_4) )
Specify the baud rate</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>On linux you can alter the meaning of B38400 to mean a custom baudrate...</p>

        </td>
        <td class="code highlight">
          <pre class="cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__linux__) &amp;&amp; defined(ASYNC_SPD_CUST)</span>
  <span class="hljs-keyword">if</span> (baudRate == <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">struct</span> serial_struct serinfo;
    serinfo.reserved_char[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (ioctl(fd, TIOCGSERIAL, &amp;serinfo) != <span class="hljs-number">-1</span>) {
      serinfo.flags &amp;= ~ASYNC_SPD_MASK;
      serinfo.flags |= ASYNC_SPD_CUST;
      serinfo.custom_divisor = (serinfo.baud_base + (data-&gt;baudRate / <span class="hljs-number">2</span>)) / data-&gt;baudRate;
      <span class="hljs-keyword">if</span> (serinfo.custom_divisor &lt; <span class="hljs-number">1</span>)
        serinfo.custom_divisor = <span class="hljs-number">1</span>;

      ioctl(fd, TIOCSSERIAL, &amp;serinfo);
      ioctl(fd, TIOCGSERIAL, &amp;serinfo);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>if (serinfo.custom_divisor * rate != serinfo.baud_base) {
warnx(&quot;actual baudrate is %d / %d = %f&quot;,
serinfo.baud_base, serinfo.custom_divisor,
(float)serinfo.baud_base / serinfo.custom_divisor);
}</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>Now we use &quot;B38400&quot; to trigger the special baud rate.</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    baudRate = B38400;
  }
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

  <span class="hljs-keyword">if</span> (baudRate != <span class="hljs-number">-1</span>) {
    cfsetispeed(&amp;options, baudRate);
    cfsetospeed(&amp;options, baudRate);
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>Removing check for valid BaudRates due to ticket: #140
#endif</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<div class="dox">
<div class="summary">
<p>IGNPAR  : ignore bytes with parity errors</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="cpp">  options.c_iflag = IGNPAR;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<div class="dox">
<div class="summary">
<p>ICRNL   : map CR to NL (otherwise a CR input on the other computer
will not terminate input)</p>
</div>
<div class="body">
</div>
</div>
Pulling this for now. It should be an option, however. -Giseburt
options.c_iflag = ICRNL;

        </td>
        <td class="code highlight">
          <pre class="cpp">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>otherwise make device raw (no other input processing)</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>Specify data bits</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  options.c_cflag &amp;= ~CSIZE;
  options.c_cflag |= dataBits;

  options.c_cflag &amp;= ~(CRTSCTS);

  <span class="hljs-keyword">if</span> (data-&gt;rtscts) {
    options.c_cflag |= CRTSCTS;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>evaluate specific flow control options</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  }

  options.c_iflag &amp;= ~(IXON | IXOFF | IXANY);

  <span class="hljs-keyword">if</span> (data-&gt;xon) {
    options.c_iflag |= IXON;
  }

  <span class="hljs-keyword">if</span> (data-&gt;xoff) {
    options.c_iflag |= IXOFF;
  }

  <span class="hljs-keyword">if</span> (data-&gt;xany) {
    options.c_iflag |= IXANY;
  }


  <span class="hljs-keyword">switch</span> (data-&gt;parity) {
  <span class="hljs-keyword">case</span> SERIALPORT_PARITY_NONE:
    options.c_cflag &amp;= ~PARENB;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>options.c_cflag &amp;= ~CSTOPB;
options.c_cflag &amp;= ~CSIZE;
options.c_cflag |= CS8;</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    <span class="hljs-keyword">break</span>;
  <span class="hljs-keyword">case</span> SERIALPORT_PARITY_ODD:
    options.c_cflag |= PARENB;
    options.c_cflag |= PARODD;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>options.c_cflag &amp;= ~CSTOPB;
options.c_cflag &amp;= ~CSIZE;
options.c_cflag |= CS7;</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    <span class="hljs-keyword">break</span>;
  <span class="hljs-keyword">case</span> SERIALPORT_PARITY_EVEN:
    options.c_cflag |= PARENB;
    options.c_cflag &amp;= ~PARODD;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>options.c_cflag &amp;= ~CSTOPB;
options.c_cflag &amp;= ~CSIZE;
options.c_cflag |= CS7;</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    <span class="hljs-keyword">break</span>;
  <span class="hljs-keyword">default</span>:
    <span class="hljs-built_in">snprintf</span>(data-&gt;errorString, <span class="hljs-keyword">sizeof</span>(data-&gt;errorString), <span class="hljs-string">"Invalid parity setting %d"</span>, data-&gt;parity);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
  }

  <span class="hljs-keyword">switch</span> (data-&gt;stopBits) {
  <span class="hljs-keyword">case</span> SERIALPORT_STOPBITS_ONE:
    options.c_cflag &amp;= ~CSTOPB;
    <span class="hljs-keyword">break</span>;
  <span class="hljs-keyword">case</span> SERIALPORT_STOPBITS_TWO:
    options.c_cflag |= CSTOPB;
    <span class="hljs-keyword">break</span>;
  <span class="hljs-keyword">default</span>:
    <span class="hljs-built_in">snprintf</span>(data-&gt;errorString, <span class="hljs-keyword">sizeof</span>(data-&gt;errorString), <span class="hljs-string">"Invalid stop bits setting %d"</span>, data-&gt;stopBits);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
  }

  options.c_cflag |= CLOCAL;  <span class="hljs-comment">// ignore status lines</span>
  options.c_cflag |= CREAD;   <span class="hljs-comment">// enable receiver</span>
  <span class="hljs-keyword">if</span> (data-&gt;hupcl) {
    options.c_cflag |= HUPCL;  <span class="hljs-comment">// drop DTR (i.e. hangup) on close</span>
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>Raw output</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  options.c_oflag = <span class="hljs-number">0</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>ICANON makes partial lines not readable. It should be optional.
It works with ICRNL.</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  options.c_lflag = <span class="hljs-number">0</span>;  <span class="hljs-comment">// ICANON;</span>

  options.c_cc[VMIN]= platformOptions-&gt;vmin;
  options.c_cc[VTIME]= platformOptions-&gt;vtime;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>removed this unneeded sleep.
sleep(1);</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  tcflush(fd, TCIFLUSH);
  tcsetattr(fd, TCSANOW, &amp;options);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>On OS X, starting in Tiger, we can set a custom baud rate, as follows:</p>

        </td>
        <td class="code highlight">
          <pre class="cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(MAC_OS_X_VERSION_10_4) &amp;&amp; (MAC_OS_X_VERSION_MIN_REQUIRED &gt;= MAC_OS_X_VERSION_10_4)</span>
  <span class="hljs-keyword">if</span> (baudRate == <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">speed_t</span> speed = data-&gt;baudRate;
    <span class="hljs-keyword">if</span> (ioctl(fd,  IOSSIOSPEED, &amp;speed) == <span class="hljs-number">-1</span>) {
      <span class="hljs-built_in">snprintf</span>(data-&gt;errorString, <span class="hljs-keyword">sizeof</span>(data-&gt;errorString), <span class="hljs-string">"Error %s calling ioctl( ..., IOSSIOSPEED, %ld )"</span>, strerror(errno), speed );
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
  }
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">EIO_Write</span><span class="hljs-params">(<span class="hljs-keyword">uv_work_t</span>* req)</span> </span>{
  QueuedWrite* queuedWrite = <span class="hljs-keyword">static_cast</span>&lt;QueuedWrite*&gt;(req-&gt;data);
  WriteBaton* data = <span class="hljs-keyword">static_cast</span>&lt;WriteBaton*&gt;(queuedWrite-&gt;baton);

  data-&gt;result = <span class="hljs-number">0</span>;
  errno = <span class="hljs-number">0</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>We carefully <em>DON'T</em> break out of this loop.</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  <span class="hljs-keyword">do</span> {
    <span class="hljs-keyword">if</span> ((data-&gt;result = write(data-&gt;fd, data-&gt;bufferData + data-&gt;offset, data-&gt;bufferLength - data-&gt;offset)) == <span class="hljs-number">-1</span>) {
      <span class="hljs-keyword">if</span> (errno == EAGAIN || errno == EWOULDBLOCK)
        <span class="hljs-keyword">return</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>The write call might be interrupted, if it is we just try again immediately.</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">      <span class="hljs-keyword">if</span> (errno != EINTR) {
        <span class="hljs-built_in">snprintf</span>(data-&gt;errorString, <span class="hljs-keyword">sizeof</span>(data-&gt;errorString), <span class="hljs-string">"Error %s calling write(...)"</span>, strerror(errno) );
        <span class="hljs-keyword">return</span>;
      }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>try again...</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">      <span class="hljs-keyword">continue</span>;
    } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>there wasn't an error, do the math on what we actually wrote...</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">      data-&gt;offset += data-&gt;result;
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>if we get there, we really don't want to loop
break;</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  } <span class="hljs-keyword">while</span> (data-&gt;bufferLength &gt; data-&gt;offset);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">EIO_Close</span><span class="hljs-params">(<span class="hljs-keyword">uv_work_t</span>* req)</span> </span>{
  CloseBaton* data = <span class="hljs-keyword">static_cast</span>&lt;CloseBaton*&gt;(req-&gt;data);
  <span class="hljs-keyword">if</span> (<span class="hljs-number">-1</span> == close(data-&gt;fd)) {
    <span class="hljs-built_in">snprintf</span>(data-&gt;errorString, <span class="hljs-keyword">sizeof</span>(data-&gt;errorString), <span class="hljs-string">"Unable to close fd %d, errno: %d"</span>, data-&gt;fd, errno);
  }
}

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __APPLE__</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>Function prototypes</p>

        </td>
        <td class="code highlight">
          <pre class="cpp"><span class="hljs-function"><span class="hljs-keyword">static</span> kern_return_t <span class="hljs-title">FindModems</span><span class="hljs-params">(<span class="hljs-keyword">io_iterator_t</span> *matchingServices)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">static</span> io_service_t <span class="hljs-title">GetUsbDevice</span><span class="hljs-params">(<span class="hljs-keyword">io_service_t</span> service)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">static</span> stDeviceListItem* <span class="hljs-title">GetSerialDevices</span><span class="hljs-params">()</span></span>;


<span class="hljs-function"><span class="hljs-keyword">static</span> kern_return_t <span class="hljs-title">FindModems</span><span class="hljs-params">(<span class="hljs-keyword">io_iterator_t</span> *matchingServices)</span> </span>{
    <span class="hljs-keyword">kern_return_t</span>     kernResult;
    CFMutableDictionaryRef  classesToMatch;
    classesToMatch = IOServiceMatching(kIOSerialBSDServiceValue);
    <span class="hljs-keyword">if</span> (classesToMatch != <span class="hljs-literal">NULL</span>) {
        CFDictionarySetValue(classesToMatch,
                             CFSTR(kIOSerialBSDTypeKey),
                             CFSTR(kIOSerialBSDAllTypes));
    }

    kernResult = IOServiceGetMatchingServices(kIOMasterPortDefault, classesToMatch, matchingServices);

    <span class="hljs-keyword">return</span> kernResult;
}

<span class="hljs-function"><span class="hljs-keyword">static</span> io_service_t <span class="hljs-title">GetUsbDevice</span><span class="hljs-params">(<span class="hljs-keyword">io_service_t</span> service)</span> </span>{
  IOReturn status;
  <span class="hljs-keyword">io_iterator_t</span>   iterator = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">io_service_t</span>    device = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">if</span> (!service) {
    <span class="hljs-keyword">return</span> device;
  }

  status = IORegistryEntryCreateIterator(service,
                                         kIOServicePlane,
                                         (kIORegistryIterateParents | kIORegistryIterateRecursively),
                                         &amp;iterator);

  <span class="hljs-keyword">if</span> (status == kIOReturnSuccess) {
    <span class="hljs-keyword">io_service_t</span> currentService;
    <span class="hljs-keyword">while</span> ((currentService = IOIteratorNext(iterator)) &amp;&amp; device == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">io_name_t</span> serviceName;
      status = IORegistryEntryGetNameInPlane(currentService, kIOServicePlane, serviceName);
      <span class="hljs-keyword">if</span> (status == kIOReturnSuccess &amp;&amp; IOObjectConformsTo(currentService, kIOUSBDeviceClassName)) {
        device = currentService;
      } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>Release the service object which is no longer needed</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">        (<span class="hljs-keyword">void</span>) IOObjectRelease(currentService);
      }
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>Release the iterator</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    (<span class="hljs-keyword">void</span>) IOObjectRelease(iterator);
  }

  <span class="hljs-keyword">return</span> device;
}

<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ExtractUsbInformation</span><span class="hljs-params">(stSerialDevice *serialDevice, IOUSBDeviceInterface  **deviceInterface)</span> </span>{
  <span class="hljs-keyword">kern_return_t</span> kernResult;
  UInt32 locationID;
  kernResult = (*deviceInterface)-&gt;GetLocationID(deviceInterface, &amp;locationID);
  <span class="hljs-keyword">if</span> (KERN_SUCCESS == kernResult) {
    <span class="hljs-built_in">snprintf</span>(serialDevice-&gt;locationId, <span class="hljs-number">11</span>, <span class="hljs-string">"0x%08x"</span>, locationID);
  }

  UInt16 vendorID;
  kernResult = (*deviceInterface)-&gt;GetDeviceVendor(deviceInterface, &amp;vendorID);
  <span class="hljs-keyword">if</span> (KERN_SUCCESS == kernResult) {
    <span class="hljs-built_in">snprintf</span>(serialDevice-&gt;vendorId, <span class="hljs-number">7</span>, <span class="hljs-string">"0x%04x"</span>, vendorID);
  }

  UInt16 productID;
  kernResult = (*deviceInterface)-&gt;GetDeviceProduct(deviceInterface, &amp;productID);
  <span class="hljs-keyword">if</span> (KERN_SUCCESS == kernResult) {
    <span class="hljs-built_in">snprintf</span>(serialDevice-&gt;productId, <span class="hljs-number">7</span>, <span class="hljs-string">"0x%04x"</span>, productID);
  }
}

<span class="hljs-function"><span class="hljs-keyword">static</span> stDeviceListItem* <span class="hljs-title">GetSerialDevices</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">kern_return_t</span> kernResult;
  <span class="hljs-keyword">io_iterator_t</span> serialPortIterator;
  <span class="hljs-keyword">char</span> bsdPath[MAXPATHLEN];

  FindModems(&amp;serialPortIterator);

  <span class="hljs-keyword">io_service_t</span> modemService;
  kernResult = KERN_FAILURE;
  Boolean modemFound = <span class="hljs-literal">false</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>Initialize the returned path</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  *bsdPath = <span class="hljs-string">'\0'</span>;

  stDeviceListItem* devices = <span class="hljs-literal">NULL</span>;
  stDeviceListItem* lastDevice = <span class="hljs-literal">NULL</span>;
  <span class="hljs-keyword">int</span> length = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">while</span> ((modemService = IOIteratorNext(serialPortIterator))) {
    CFTypeRef bsdPathAsCFString;
    bsdPathAsCFString = IORegistryEntrySearchCFProperty(
      modemService,
      kIOServicePlane,
      CFSTR(kIOCalloutDeviceKey),
      kCFAllocatorDefault,
      kIORegistryIterateRecursively);

    <span class="hljs-keyword">if</span> (bsdPathAsCFString) {
      Boolean result;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>Convert the path from a CFString to a C (NUL-terminated)</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">      result = CFStringGetCString((CFStringRef) bsdPathAsCFString,
                    bsdPath,
                    <span class="hljs-keyword">sizeof</span>(bsdPath),
                    kCFStringEncodingUTF8);
      CFRelease(bsdPathAsCFString);

      <span class="hljs-keyword">if</span> (result) {
        stDeviceListItem *deviceListItem = (stDeviceListItem*) <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(stDeviceListItem));
        stSerialDevice *serialDevice = &amp;(deviceListItem-&gt;value);
        <span class="hljs-built_in">strcpy</span>(serialDevice-&gt;port, bsdPath);
        <span class="hljs-built_in">memset</span>(serialDevice-&gt;locationId, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(serialDevice-&gt;locationId));
        <span class="hljs-built_in">memset</span>(serialDevice-&gt;vendorId, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(serialDevice-&gt;vendorId));
        <span class="hljs-built_in">memset</span>(serialDevice-&gt;productId, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(serialDevice-&gt;productId));
        serialDevice-&gt;manufacturer[<span class="hljs-number">0</span>] = <span class="hljs-string">'\0'</span>;
        serialDevice-&gt;serialNumber[<span class="hljs-number">0</span>] = <span class="hljs-string">'\0'</span>;
        deviceListItem-&gt;next = <span class="hljs-literal">NULL</span>;
        deviceListItem-&gt;length = &amp;length;

        <span class="hljs-keyword">if</span> (devices == <span class="hljs-literal">NULL</span>) {
          devices = deviceListItem;
        } <span class="hljs-keyword">else</span> {
          lastDevice-&gt;next = deviceListItem;
        }

        lastDevice = deviceListItem;
        length++;

        modemFound = <span class="hljs-literal">true</span>;
        kernResult = KERN_SUCCESS;

        uv_mutex_lock(&amp;list_mutex);

        <span class="hljs-keyword">io_service_t</span> device = GetUsbDevice(modemService);

        <span class="hljs-keyword">if</span> (device) {
          CFStringRef manufacturerAsCFString = (CFStringRef) IORegistryEntryCreateCFProperty(device,
                      CFSTR(kUSBVendorString),
                      kCFAllocatorDefault,
                      <span class="hljs-number">0</span>);

          <span class="hljs-keyword">if</span> (manufacturerAsCFString) {
            Boolean result;
            <span class="hljs-keyword">char</span>    manufacturer[MAXPATHLEN];

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>Convert from a CFString to a C (NUL-terminated)</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">            result = CFStringGetCString(manufacturerAsCFString,
                          manufacturer,
                          <span class="hljs-keyword">sizeof</span>(manufacturer),
                          kCFStringEncodingUTF8);

            <span class="hljs-keyword">if</span> (result) {
              <span class="hljs-built_in">strcpy</span>(serialDevice-&gt;manufacturer, manufacturer);
            }

            CFRelease(manufacturerAsCFString);
          }

          CFStringRef serialNumberAsCFString = (CFStringRef) IORegistryEntrySearchCFProperty(device,
                      kIOServicePlane,
                      CFSTR(kUSBSerialNumberString),
                      kCFAllocatorDefault,
                      kIORegistryIterateRecursively);

          <span class="hljs-keyword">if</span> (serialNumberAsCFString) {
            Boolean result;
            <span class="hljs-keyword">char</span>    serialNumber[MAXPATHLEN];

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>Convert from a CFString to a C (NUL-terminated)</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">            result = CFStringGetCString(serialNumberAsCFString,
                          serialNumber,
                          <span class="hljs-keyword">sizeof</span>(serialNumber),
                          kCFStringEncodingUTF8);

            <span class="hljs-keyword">if</span> (result) {
              <span class="hljs-built_in">strcpy</span>(serialDevice-&gt;serialNumber, serialNumber);
            }

            CFRelease(serialNumberAsCFString);
          }

          IOCFPlugInInterface **plugInInterface = <span class="hljs-literal">NULL</span>;
          SInt32        score;
          HRESULT       res;

          IOUSBDeviceInterface  **deviceInterface = <span class="hljs-literal">NULL</span>;

          kernResult = IOCreatePlugInInterfaceForService(device, kIOUSBDeviceUserClientTypeID, kIOCFPlugInInterfaceID,
                               &amp;plugInInterface, &amp;score);

          <span class="hljs-keyword">if</span> ((kIOReturnSuccess != kernResult) || !plugInInterface) {
            <span class="hljs-keyword">continue</span>;
          }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>Use the plugin interface to retrieve the device interface.</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">          res = (*plugInInterface)-&gt;QueryInterface(plugInInterface, CFUUIDGetUUIDBytes(kIOUSBDeviceInterfaceID),
                               (LPVOID*) &amp;deviceInterface);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<p>Now done with the plugin interface.</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">          (*plugInInterface)-&gt;Release(plugInInterface);

          <span class="hljs-keyword">if</span> (res || deviceInterface == <span class="hljs-literal">NULL</span>) {
            <span class="hljs-keyword">continue</span>;
          }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>Extract the desired Information</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">          ExtractUsbInformation(serialDevice, deviceInterface);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<p>Release the Interface</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">          (*deviceInterface)-&gt;Release(deviceInterface);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39"></a>
</div>
<p>Release the device</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">          (<span class="hljs-keyword">void</span>) IOObjectRelease(device);
        }

        uv_mutex_unlock(&amp;list_mutex);
      }
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40"></a>
</div>
<p>Release the io_service_t now that we are done with it.</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">    (<span class="hljs-keyword">void</span>) IOObjectRelease(modemService);
  }

  IOObjectRelease(serialPortIterator);  <span class="hljs-comment">// Release the iterator.</span>

  <span class="hljs-keyword">return</span> devices;
}

<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">EIO_List</span><span class="hljs-params">(<span class="hljs-keyword">uv_work_t</span>* req)</span> </span>{
  ListBaton* data = <span class="hljs-keyword">static_cast</span>&lt;ListBaton*&gt;(req-&gt;data);

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> __APPLE__</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41"></a>
</div>
<p>This code exists in javascript for other unix platforms</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  <span class="hljs-built_in">snprintf</span>(data-&gt;errorString, <span class="hljs-keyword">sizeof</span>(data-&gt;errorString), <span class="hljs-string">"List is not Implemented"</span>);
  <span class="hljs-keyword">return</span>;
<span class="hljs-meta"># <span class="hljs-meta-keyword">else</span></span>
  <span class="hljs-keyword">if</span> (!lockInitialised) {
    uv_mutex_init(&amp;list_mutex);
    lockInitialised = TRUE;
  }

  stDeviceListItem* devices = GetSerialDevices();
  <span class="hljs-keyword">if</span> (*(devices-&gt;length) &gt; <span class="hljs-number">0</span>) {
    stDeviceListItem* next = devices;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>, len = *(devices-&gt;length); i &lt; len; i++) {
      stSerialDevice device = (* next).value;

      ListResultItem* resultItem = <span class="hljs-keyword">new</span> ListResultItem();
      resultItem-&gt;comName = device.port;

      <span class="hljs-keyword">if</span> (*device.locationId) {
        resultItem-&gt;locationId = device.locationId;
      }
      <span class="hljs-keyword">if</span> (*device.vendorId) {
        resultItem-&gt;vendorId = device.vendorId;
      }
      <span class="hljs-keyword">if</span> (*device.productId) {
        resultItem-&gt;productId = device.productId;
      }
      <span class="hljs-keyword">if</span> (*device.manufacturer) {
        resultItem-&gt;manufacturer = device.manufacturer;
      }
      <span class="hljs-keyword">if</span> (*device.serialNumber) {
        resultItem-&gt;serialNumber = device.serialNumber;
      }
      data-&gt;results.push_back(resultItem);

      stDeviceListItem* current = next;

      <span class="hljs-keyword">if</span> (next-&gt;next != <span class="hljs-literal">NULL</span>) {
        next = next-&gt;next;
      }

      <span class="hljs-built_in">free</span>(current);
    }
  }
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">EIO_Flush</span><span class="hljs-params">(<span class="hljs-keyword">uv_work_t</span>* req)</span> </span>{
  FlushBaton* data = <span class="hljs-keyword">static_cast</span>&lt;FlushBaton*&gt;(req-&gt;data);

  data-&gt;result = tcflush(data-&gt;fd, TCIFLUSH);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">EIO_Set</span><span class="hljs-params">(<span class="hljs-keyword">uv_work_t</span>* req)</span> </span>{
  SetBaton* data = <span class="hljs-keyword">static_cast</span>&lt;SetBaton*&gt;(req-&gt;data);

  <span class="hljs-keyword">int</span> bits;
  ioctl(data-&gt;fd, TIOCMGET, &amp;bits);

  bits &amp;= ~(TIOCM_RTS | TIOCM_CTS | TIOCM_DTR | TIOCM_DSR);

  <span class="hljs-keyword">if</span> (data-&gt;rts) {
    bits |= TIOCM_RTS;
  }

  <span class="hljs-keyword">if</span> (data-&gt;cts) {
    bits |= TIOCM_CTS;
  }

  <span class="hljs-keyword">if</span> (data-&gt;dtr) {
    bits |= TIOCM_DTR;
  }

  <span class="hljs-keyword">if</span> (data-&gt;dsr) {
    bits |= TIOCM_DSR;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42"></a>
</div>
<p>TODO check these returns</p>

        </td>
        <td class="code highlight">
          <pre class="cpp">  <span class="hljs-keyword">if</span> (data-&gt;brk) {
    ioctl(data-&gt;fd, TIOCSBRK, <span class="hljs-literal">NULL</span>);
  } <span class="hljs-keyword">else</span> {
    ioctl(data-&gt;fd, TIOCCBRK, <span class="hljs-literal">NULL</span>);
  }

  data-&gt;result = ioctl(data-&gt;fd, TIOCMSET, &amp;bits);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">EIO_Drain</span><span class="hljs-params">(<span class="hljs-keyword">uv_work_t</span>* req)</span> </span>{
  DrainBaton* data = <span class="hljs-keyword">static_cast</span>&lt;DrainBaton*&gt;(req-&gt;data);

  data-&gt;result = tcdrain(data-&gt;fd);
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

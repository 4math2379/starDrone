<!DOCTYPE html>
<html>
<head>
  <title>auth.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/request/lib/auth.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>auth.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">'use strict'</span>

<span class="hljs-keyword">var</span> caseless = <span class="hljs-built_in">require</span>(<span class="hljs-string">'caseless'</span>)
  , uuid = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node-uuid'</span>)
  , helpers = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./helpers'</span>)

<span class="hljs-keyword">var</span> md5 = helpers.md5
  , toBase64 = helpers.toBase64


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Auth</span> (<span class="hljs-params">request</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>define all public properties here</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>.request = request
  <span class="hljs-keyword">this</span>.hasAuth = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">this</span>.sentAuth = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">this</span>.bearerToken = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">this</span>.user = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">this</span>.pass = <span class="hljs-literal">null</span>
}

Auth.prototype.basic = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">user, pass, sendImmediately</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> user !== <span class="hljs-string">'string'</span> || (pass !== <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-keyword">typeof</span> pass !== <span class="hljs-string">'string'</span>)) {
    self.request.emit(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'auth() received invalid user or password'</span>))
  }
  self.user = user
  self.pass = pass
  self.hasAuth = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">var</span> header = user + <span class="hljs-string">':'</span> + (pass || <span class="hljs-string">''</span>)
  <span class="hljs-keyword">if</span> (sendImmediately || <span class="hljs-keyword">typeof</span> sendImmediately === <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-keyword">var</span> authHeader = <span class="hljs-string">'Basic '</span> + toBase64(header)
    self.sentAuth = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">return</span> authHeader
  }
}

Auth.prototype.bearer = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">bearer, sendImmediately</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  self.bearerToken = bearer
  self.hasAuth = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">if</span> (sendImmediately || <span class="hljs-keyword">typeof</span> sendImmediately === <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> bearer === <span class="hljs-string">'function'</span>) {
      bearer = bearer()
    }
    <span class="hljs-keyword">var</span> authHeader = <span class="hljs-string">'Bearer '</span> + (bearer || <span class="hljs-string">''</span>)
    self.sentAuth = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">return</span> authHeader
  }
}

Auth.prototype.digest = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">method, path, authHeader</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>TODO: More complete implementation of RFC 2617.</p>
<ul>
<li>handle challenge.domain</li>
<li>support qop=&quot;auth-int&quot; only</li>
<li>handle Authentication-Info (not necessarily?)</li>
<li>check challenge.stale (not necessarily?)</li>
<li>increase nc (not necessarily?)
For reference:
http://tools.ietf.org/html/rfc2617#section-3
https://github.com/bagder/curl/blob/master/lib/http_digest.c</li>
</ul>

        </td>
        <td class="code highlight">
          <pre class="javascript">
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

  <span class="hljs-keyword">var</span> challenge = {}
  <span class="hljs-keyword">var</span> re = <span class="hljs-regexp">/([a-z0-9_-]+)=(?:"([^"]+)"|([a-z0-9_-]+))/gi</span>
  <span class="hljs-keyword">for</span> (;;) {
    <span class="hljs-keyword">var</span> match = re.exec(authHeader)
    <span class="hljs-keyword">if</span> (!match) {
      <span class="hljs-keyword">break</span>
    }
    challenge[match[<span class="hljs-number">1</span>]] = match[<span class="hljs-number">2</span>] || match[<span class="hljs-number">3</span>]
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<div class="dox">
<div class="summary">
<p>RFC 2617: handle both MD5 and MD5-sess algorithms.</p>
</div>
<div class="body">
<p>If the algorithm directive's value is &quot;MD5&quot; or unspecified, then HA1 is
HA1=MD5(username:realm:password)
If the algorithm directive's value is &quot;MD5-sess&quot;, then HA1 is
HA1=MD5(MD5(username:realm:password):nonce:cnonce)</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> ha1Compute = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">algorithm, user, realm, pass, nonce, cnonce</span>) </span>{
    <span class="hljs-keyword">var</span> ha1 = md5(user + <span class="hljs-string">':'</span> + realm + <span class="hljs-string">':'</span> + pass)
    <span class="hljs-keyword">if</span> (algorithm &amp;&amp; algorithm.toLowerCase() === <span class="hljs-string">'md5-sess'</span>) {
      <span class="hljs-keyword">return</span> md5(ha1 + <span class="hljs-string">':'</span> + nonce + <span class="hljs-string">':'</span> + cnonce)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> ha1
    }
  }

  <span class="hljs-keyword">var</span> qop = <span class="hljs-regexp">/(^|,)\s*auth\s*($|,)/</span>.test(challenge.qop) &amp;&amp; <span class="hljs-string">'auth'</span>
  <span class="hljs-keyword">var</span> nc = qop &amp;&amp; <span class="hljs-string">'00000001'</span>
  <span class="hljs-keyword">var</span> cnonce = qop &amp;&amp; uuid().replace(<span class="hljs-regexp">/-/g</span>, <span class="hljs-string">''</span>)
  <span class="hljs-keyword">var</span> ha1 = ha1Compute(challenge.algorithm, self.user, challenge.realm, self.pass, challenge.nonce, cnonce)
  <span class="hljs-keyword">var</span> ha2 = md5(method + <span class="hljs-string">':'</span> + path)
  <span class="hljs-keyword">var</span> digestResponse = qop
    ? md5(ha1 + <span class="hljs-string">':'</span> + challenge.nonce + <span class="hljs-string">':'</span> + nc + <span class="hljs-string">':'</span> + cnonce + <span class="hljs-string">':'</span> + qop + <span class="hljs-string">':'</span> + ha2)
    : md5(ha1 + <span class="hljs-string">':'</span> + challenge.nonce + <span class="hljs-string">':'</span> + ha2)
  <span class="hljs-keyword">var</span> authValues = {
    <span class="hljs-attr">username</span>: self.user,
    <span class="hljs-attr">realm</span>: challenge.realm,
    <span class="hljs-attr">nonce</span>: challenge.nonce,
    <span class="hljs-attr">uri</span>: path,
    <span class="hljs-attr">qop</span>: qop,
    <span class="hljs-attr">response</span>: digestResponse,
    <span class="hljs-attr">nc</span>: nc,
    <span class="hljs-attr">cnonce</span>: cnonce,
    <span class="hljs-attr">algorithm</span>: challenge.algorithm,
    <span class="hljs-attr">opaque</span>: challenge.opaque
  }

  authHeader = []
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k <span class="hljs-keyword">in</span> authValues) {
    <span class="hljs-keyword">if</span> (authValues[k]) {
      <span class="hljs-keyword">if</span> (k === <span class="hljs-string">'qop'</span> || k === <span class="hljs-string">'nc'</span> || k === <span class="hljs-string">'algorithm'</span>) {
        authHeader.push(k + <span class="hljs-string">'='</span> + authValues[k])
      } <span class="hljs-keyword">else</span> {
        authHeader.push(k + <span class="hljs-string">'="'</span> + authValues[k] + <span class="hljs-string">'"'</span>)
      }
    }
  }
  authHeader = <span class="hljs-string">'Digest '</span> + authHeader.join(<span class="hljs-string">', '</span>)
  self.sentAuth = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">return</span> authHeader
}

Auth.prototype.onRequest = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">user, pass, sendImmediately, bearer</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    , request = self.request

  <span class="hljs-keyword">var</span> authHeader
  <span class="hljs-keyword">if</span> (bearer === <span class="hljs-literal">undefined</span> &amp;&amp; user === <span class="hljs-literal">undefined</span>) {
    self.request.emit(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'no auth mechanism defined'</span>))
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bearer !== <span class="hljs-literal">undefined</span>) {
    authHeader = self.bearer(bearer, sendImmediately)
  } <span class="hljs-keyword">else</span> {
    authHeader = self.basic(user, pass, sendImmediately)
  }
  <span class="hljs-keyword">if</span> (authHeader) {
    request.setHeader(<span class="hljs-string">'authorization'</span>, authHeader)
  }
}

Auth.prototype.onResponse = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    , request = self.request

  <span class="hljs-keyword">if</span> (!self.hasAuth || self.sentAuth) { <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> }

  <span class="hljs-keyword">var</span> c = caseless(response.headers)

  <span class="hljs-keyword">var</span> authHeader = c.get(<span class="hljs-string">'www-authenticate'</span>)
  <span class="hljs-keyword">var</span> authVerb = authHeader &amp;&amp; authHeader.split(<span class="hljs-string">' '</span>)[<span class="hljs-number">0</span>].toLowerCase()
  request.debug(<span class="hljs-string">'reauth'</span>, authVerb)

  <span class="hljs-keyword">switch</span> (authVerb) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'basic'</span>:
      <span class="hljs-keyword">return</span> self.basic(self.user, self.pass, <span class="hljs-literal">true</span>)

    <span class="hljs-keyword">case</span> <span class="hljs-string">'bearer'</span>:
      <span class="hljs-keyword">return</span> self.bearer(self.bearerToken, <span class="hljs-literal">true</span>)

    <span class="hljs-keyword">case</span> <span class="hljs-string">'digest'</span>:
      <span class="hljs-keyword">return</span> self.digest(request.method, request.path, authHeader)
  }
}

exports.Auth = Auth

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

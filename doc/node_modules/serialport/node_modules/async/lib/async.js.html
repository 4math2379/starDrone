<!DOCTYPE html>
<html>
<head>
  <title>async.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/async/lib/async.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>async.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<div class="dox">
<div class="summary">
<p>!
async
https://github.com/caolan/async</p>
</div>
<div class="body">
<p>Copyright 2010-2014 Caolan McMahon
Released under the MIT license</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">var</span> <span class="hljs-keyword">async</span> = {};
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">noop</span>(<span class="hljs-params"></span>) </span>{}
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">identity</span>(<span class="hljs-params">v</span>) </span>{
        <span class="hljs-keyword">return</span> v;
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toBool</span>(<span class="hljs-params">v</span>) </span>{
        <span class="hljs-keyword">return</span> !!v;
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">notId</span>(<span class="hljs-params">v</span>) </span>{
        <span class="hljs-keyword">return</span> !v;
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>global on the server, window in the browser</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> previous_async;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Establish the root object, <code>window</code> (<code>self</code>) in the browser, <code>global</code>
on the server, or <code>this</code> in some virtual machines. We use <code>self</code>
instead of <code>window</code> for <code>WebWorker</code> support.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> root = <span class="hljs-keyword">typeof</span> self === <span class="hljs-string">'object'</span> &amp;&amp; self.self === self &amp;&amp; self ||
            <span class="hljs-keyword">typeof</span> global === <span class="hljs-string">'object'</span> &amp;&amp; global.global === global &amp;&amp; global ||
            <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span> (root != <span class="hljs-literal">null</span>) {
        previous_async = root.async;
    }

    <span class="hljs-keyword">async</span>.noConflict = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        root.async = previous_async;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span>;
    };

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">only_once</span>(<span class="hljs-params">fn</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span> (fn === <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Callback was already called."</span>);
            fn.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
            fn = <span class="hljs-literal">null</span>;
        };
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_once</span>(<span class="hljs-params">fn</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span> (fn === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;
            fn.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
            fn = <span class="hljs-literal">null</span>;
        };
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>// cross-browser compatiblity functions ////</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> _toString = <span class="hljs-built_in">Object</span>.prototype.toString;

    <span class="hljs-keyword">var</span> _isArray = <span class="hljs-built_in">Array</span>.isArray || <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj</span>) </span>{
        <span class="hljs-keyword">return</span> _toString.call(obj) === <span class="hljs-string">'[object Array]'</span>;
    };

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Ported from underscore.js isObject</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> _isObject = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>) </span>{
        <span class="hljs-keyword">var</span> type = <span class="hljs-keyword">typeof</span> obj;
        <span class="hljs-keyword">return</span> type === <span class="hljs-string">'function'</span> || type === <span class="hljs-string">'object'</span> &amp;&amp; !!obj;
    };

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_isArrayLike</span>(<span class="hljs-params">arr</span>) </span>{
        <span class="hljs-keyword">return</span> _isArray(arr) || (
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>has a positive integer length property</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">typeof</span> arr.length === <span class="hljs-string">"number"</span> &amp;&amp;
            arr.length &gt;= <span class="hljs-number">0</span> &amp;&amp;
            arr.length % <span class="hljs-number">1</span> === <span class="hljs-number">0</span>
        );
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_arrayEach</span>(<span class="hljs-params">arr, iterator</span>) </span>{
        <span class="hljs-keyword">var</span> index = <span class="hljs-number">-1</span>,
            length = arr.length;

        <span class="hljs-keyword">while</span> (++index &lt; length) {
            iterator(arr[index], index, arr);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_map</span>(<span class="hljs-params">arr, iterator</span>) </span>{
        <span class="hljs-keyword">var</span> index = <span class="hljs-number">-1</span>,
            length = arr.length,
            result = <span class="hljs-built_in">Array</span>(length);

        <span class="hljs-keyword">while</span> (++index &lt; length) {
            result[index] = iterator(arr[index], index, arr);
        }
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_range</span>(<span class="hljs-params">count</span>) </span>{
        <span class="hljs-keyword">return</span> _map(<span class="hljs-built_in">Array</span>(count), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">v, i</span>) </span>{ <span class="hljs-keyword">return</span> i; });
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_reduce</span>(<span class="hljs-params">arr, iterator, memo</span>) </span>{
        _arrayEach(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x, i, a</span>) </span>{
            memo = iterator(memo, x, i, a);
        });
        <span class="hljs-keyword">return</span> memo;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_forEachOf</span>(<span class="hljs-params">object, iterator</span>) </span>{
        _arrayEach(_keys(object), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key</span>) </span>{
            iterator(object[key], key);
        });
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_indexOf</span>(<span class="hljs-params">arr, item</span>) </span>{
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; arr.length; i++) {
            <span class="hljs-keyword">if</span> (arr[i] === item) <span class="hljs-keyword">return</span> i;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-keyword">var</span> _keys = <span class="hljs-built_in">Object</span>.keys || <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj</span>) </span>{
        <span class="hljs-keyword">var</span> keys = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k <span class="hljs-keyword">in</span> obj) {
            <span class="hljs-keyword">if</span> (obj.hasOwnProperty(k)) {
                keys.push(k);
            }
        }
        <span class="hljs-keyword">return</span> keys;
    };

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_keyIterator</span>(<span class="hljs-params">coll</span>) </span>{
        <span class="hljs-keyword">var</span> i = <span class="hljs-number">-1</span>;
        <span class="hljs-keyword">var</span> len;
        <span class="hljs-keyword">var</span> keys;
        <span class="hljs-keyword">if</span> (_isArrayLike(coll)) {
            len = coll.length;
            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span>(<span class="hljs-params"></span>) </span>{
                i++;
                <span class="hljs-keyword">return</span> i &lt; len ? i : <span class="hljs-literal">null</span>;
            };
        } <span class="hljs-keyword">else</span> {
            keys = _keys(coll);
            len = keys.length;
            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span>(<span class="hljs-params"></span>) </span>{
                i++;
                <span class="hljs-keyword">return</span> i &lt; len ? keys[i] : <span class="hljs-literal">null</span>;
            };
        }
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Similar to ES6's rest param (http://ariya.ofilabs.com/2013/03/es6-and-rest-parameter.html)
This accumulates the arguments passed into an array, after a given index.
From underscore.js (https://github.com/jashkenas/underscore/pull/2140).</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_restParam</span>(<span class="hljs-params">func, startIndex</span>) </span>{
        startIndex = startIndex == <span class="hljs-literal">null</span> ? func.length - <span class="hljs-number">1</span> : +startIndex;
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> length = <span class="hljs-built_in">Math</span>.max(<span class="hljs-built_in">arguments</span>.length - startIndex, <span class="hljs-number">0</span>);
            <span class="hljs-keyword">var</span> rest = <span class="hljs-built_in">Array</span>(length);
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> index = <span class="hljs-number">0</span>; index &lt; length; index++) {
                rest[index] = <span class="hljs-built_in">arguments</span>[index + startIndex];
            }
            <span class="hljs-keyword">switch</span> (startIndex) {
                <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: <span class="hljs-keyword">return</span> func.call(<span class="hljs-keyword">this</span>, rest);
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-keyword">return</span> func.call(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>], rest);
            }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Currently unused but handle cases outside of the switch statement:
var args = Array(startIndex + 1);
for (index = 0; index &lt; startIndex; index++) {
args[index] = arguments[index];
}
args[startIndex] = rest;
return func.apply(this, args);</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        };
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_withoutIndex</span>(<span class="hljs-params">iterator</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value, index, callback</span>) </span>{
            <span class="hljs-keyword">return</span> iterator(value, callback);
        };
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>// exported async module functions ////</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>// nextTick implementation with browser-compatible fallback ////</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>capture the global reference to guard against fakeTimer mocks</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> _setImmediate = <span class="hljs-keyword">typeof</span> setImmediate === <span class="hljs-string">'function'</span> &amp;&amp; setImmediate;

    <span class="hljs-keyword">var</span> _delay = _setImmediate ? <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fn</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>not a direct alias for IE10 compatibility</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        _setImmediate(fn);
    } : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fn</span>) </span>{
        setTimeout(fn, <span class="hljs-number">0</span>);
    };

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> process === <span class="hljs-string">'object'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> process.nextTick === <span class="hljs-string">'function'</span>) {
        <span class="hljs-keyword">async</span>.nextTick = process.nextTick;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">async</span>.nextTick = _delay;
    }
    <span class="hljs-keyword">async</span>.setImmediate = _setImmediate ? _delay : <span class="hljs-keyword">async</span>.nextTick;


    <span class="hljs-keyword">async</span>.forEach =
    <span class="hljs-keyword">async</span>.each = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr, iterator, callback</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span>.eachOf(arr, _withoutIndex(iterator), callback);
    };

    <span class="hljs-keyword">async</span>.forEachSeries =
    <span class="hljs-keyword">async</span>.eachSeries = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr, iterator, callback</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span>.eachOfSeries(arr, _withoutIndex(iterator), callback);
    };


    <span class="hljs-keyword">async</span>.forEachLimit =
    <span class="hljs-keyword">async</span>.eachLimit = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr, limit, iterator, callback</span>) </span>{
        <span class="hljs-keyword">return</span> _eachOfLimit(limit)(arr, _withoutIndex(iterator), callback);
    };

    <span class="hljs-keyword">async</span>.forEachOf =
    <span class="hljs-keyword">async</span>.eachOf = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">object, iterator, callback</span>) </span>{
        callback = _once(callback || noop);
        object = object || [];

        <span class="hljs-keyword">var</span> iter = _keyIterator(object);
        <span class="hljs-keyword">var</span> key, completed = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">while</span> ((key = iter()) != <span class="hljs-literal">null</span>) {
            completed += <span class="hljs-number">1</span>;
            iterator(object[key], key, only_once(done));
        }

        <span class="hljs-keyword">if</span> (completed === <span class="hljs-number">0</span>) callback(<span class="hljs-literal">null</span>);

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">done</span>(<span class="hljs-params">err</span>) </span>{
            completed--;
            <span class="hljs-keyword">if</span> (err) {
                callback(err);
            }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>Check key is null in case iterator isn't exhausted
and done resolved synchronously.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-literal">null</span> &amp;&amp; completed &lt;= <span class="hljs-number">0</span>) {
                callback(<span class="hljs-literal">null</span>);
            }
        }
    };

    <span class="hljs-keyword">async</span>.forEachOfSeries =
    <span class="hljs-keyword">async</span>.eachOfSeries = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj, iterator, callback</span>) </span>{
        callback = _once(callback || noop);
        obj = obj || [];
        <span class="hljs-keyword">var</span> nextKey = _keyIterator(obj);
        <span class="hljs-keyword">var</span> key = nextKey();
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">iterate</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> sync = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">if</span> (key === <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>);
            }
            iterator(obj[key], key, only_once(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
                <span class="hljs-keyword">if</span> (err) {
                    callback(err);
                }
                <span class="hljs-keyword">else</span> {
                    key = nextKey();
                    <span class="hljs-keyword">if</span> (key === <span class="hljs-literal">null</span>) {
                        <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>);
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">if</span> (sync) {
                            <span class="hljs-keyword">async</span>.setImmediate(iterate);
                        } <span class="hljs-keyword">else</span> {
                            iterate();
                        }
                    }
                }
            }));
            sync = <span class="hljs-literal">false</span>;
        }
        iterate();
    };



    <span class="hljs-keyword">async</span>.forEachOfLimit =
    <span class="hljs-keyword">async</span>.eachOfLimit = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj, limit, iterator, callback</span>) </span>{
        _eachOfLimit(limit)(obj, iterator, callback);
    };

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_eachOfLimit</span>(<span class="hljs-params">limit</span>) </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj, iterator, callback</span>) </span>{
            callback = _once(callback || noop);
            obj = obj || [];
            <span class="hljs-keyword">var</span> nextKey = _keyIterator(obj);
            <span class="hljs-keyword">if</span> (limit &lt;= <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>);
            }
            <span class="hljs-keyword">var</span> done = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">var</span> running = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">var</span> errored = <span class="hljs-literal">false</span>;

            (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">replenish</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (done &amp;&amp; running &lt;= <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>);
                }

                <span class="hljs-keyword">while</span> (running &lt; limit &amp;&amp; !errored) {
                    <span class="hljs-keyword">var</span> key = nextKey();
                    <span class="hljs-keyword">if</span> (key === <span class="hljs-literal">null</span>) {
                        done = <span class="hljs-literal">true</span>;
                        <span class="hljs-keyword">if</span> (running &lt;= <span class="hljs-number">0</span>) {
                            callback(<span class="hljs-literal">null</span>);
                        }
                        <span class="hljs-keyword">return</span>;
                    }
                    running += <span class="hljs-number">1</span>;
                    iterator(obj[key], key, only_once(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
                        running -= <span class="hljs-number">1</span>;
                        <span class="hljs-keyword">if</span> (err) {
                            callback(err);
                            errored = <span class="hljs-literal">true</span>;
                        }
                        <span class="hljs-keyword">else</span> {
                            replenish();
                        }
                    }));
                }
            })();
        };
    }


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doParallel</span>(<span class="hljs-params">fn</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj, iterator, callback</span>) </span>{
            <span class="hljs-keyword">return</span> fn(<span class="hljs-keyword">async</span>.eachOf, obj, iterator, callback);
        };
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doParallelLimit</span>(<span class="hljs-params">fn</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj, limit, iterator, callback</span>) </span>{
            <span class="hljs-keyword">return</span> fn(_eachOfLimit(limit), obj, iterator, callback);
        };
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doSeries</span>(<span class="hljs-params">fn</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj, iterator, callback</span>) </span>{
            <span class="hljs-keyword">return</span> fn(<span class="hljs-keyword">async</span>.eachOfSeries, obj, iterator, callback);
        };
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_asyncMap</span>(<span class="hljs-params">eachfn, arr, iterator, callback</span>) </span>{
        callback = _once(callback || noop);
        arr = arr || [];
        <span class="hljs-keyword">var</span> results = _isArrayLike(arr) ? [] : {};
        eachfn(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value, index, callback</span>) </span>{
            iterator(value, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, v</span>) </span>{
                results[index] = v;
                callback(err);
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
            callback(err, results);
        });
    }

    <span class="hljs-keyword">async</span>.map = doParallel(_asyncMap);
    <span class="hljs-keyword">async</span>.mapSeries = doSeries(_asyncMap);
    <span class="hljs-keyword">async</span>.mapLimit = doParallelLimit(_asyncMap);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>reduce only has a series version, as doing reduce in parallel won't
work in many situations.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">async</span>.inject =
    <span class="hljs-keyword">async</span>.foldl =
    <span class="hljs-keyword">async</span>.reduce = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr, memo, iterator, callback</span>) </span>{
        <span class="hljs-keyword">async</span>.eachOfSeries(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x, i, callback</span>) </span>{
            iterator(memo, x, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, v</span>) </span>{
                memo = v;
                callback(err);
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
            callback(err, memo);
        });
    };

    <span class="hljs-keyword">async</span>.foldr =
    <span class="hljs-keyword">async</span>.reduceRight = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr, memo, iterator, callback</span>) </span>{
        <span class="hljs-keyword">var</span> reversed = _map(arr, identity).reverse();
        <span class="hljs-keyword">async</span>.reduce(reversed, memo, iterator, callback);
    };

    <span class="hljs-keyword">async</span>.transform = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr, memo, iterator, callback</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">3</span>) {
            callback = iterator;
            iterator = memo;
            memo = _isArray(arr) ? [] : {};
        }

        <span class="hljs-keyword">async</span>.eachOf(arr, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v, k, cb</span>) </span>{
            iterator(memo, v, k, cb);
        }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
            callback(err, memo);
        });
    };

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_filter</span>(<span class="hljs-params">eachfn, arr, iterator, callback</span>) </span>{
        <span class="hljs-keyword">var</span> results = [];
        eachfn(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x, index, callback</span>) </span>{
            iterator(x, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">v</span>) </span>{
                <span class="hljs-keyword">if</span> (v) {
                    results.push({<span class="hljs-attr">index</span>: index, <span class="hljs-attr">value</span>: x});
                }
                callback();
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            callback(_map(results.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) </span>{
                <span class="hljs-keyword">return</span> a.index - b.index;
            }), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) </span>{
                <span class="hljs-keyword">return</span> x.value;
            }));
        });
    }

    <span class="hljs-keyword">async</span>.select =
    <span class="hljs-keyword">async</span>.filter = doParallel(_filter);

    <span class="hljs-keyword">async</span>.selectLimit =
    <span class="hljs-keyword">async</span>.filterLimit = doParallelLimit(_filter);

    <span class="hljs-keyword">async</span>.selectSeries =
    <span class="hljs-keyword">async</span>.filterSeries = doSeries(_filter);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_reject</span>(<span class="hljs-params">eachfn, arr, iterator, callback</span>) </span>{
        _filter(eachfn, arr, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value, cb</span>) </span>{
            iterator(value, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>) </span>{
                cb(!v);
            });
        }, callback);
    }
    <span class="hljs-keyword">async</span>.reject = doParallel(_reject);
    <span class="hljs-keyword">async</span>.rejectLimit = doParallelLimit(_reject);
    <span class="hljs-keyword">async</span>.rejectSeries = doSeries(_reject);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_createTester</span>(<span class="hljs-params">eachfn, check, getResult</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">arr, limit, iterator, cb</span>) </span>{
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">done</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (cb) cb(getResult(<span class="hljs-literal">false</span>, <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>));
            }
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">iteratee</span>(<span class="hljs-params">x, _, callback</span>) </span>{
                <span class="hljs-keyword">if</span> (!cb) <span class="hljs-keyword">return</span> callback();
                iterator(x, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">v</span>) </span>{
                    <span class="hljs-keyword">if</span> (cb &amp;&amp; check(v)) {
                        cb(getResult(<span class="hljs-literal">true</span>, x));
                        cb = iterator = <span class="hljs-literal">false</span>;
                    }
                    callback();
                });
            }
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">3</span>) {
                eachfn(arr, limit, iteratee, done);
            } <span class="hljs-keyword">else</span> {
                cb = iterator;
                iterator = limit;
                eachfn(arr, iteratee, done);
            }
        };
    }

    <span class="hljs-keyword">async</span>.any =
    <span class="hljs-keyword">async</span>.some = _createTester(<span class="hljs-keyword">async</span>.eachOf, toBool, identity);

    <span class="hljs-keyword">async</span>.someLimit = _createTester(<span class="hljs-keyword">async</span>.eachOfLimit, toBool, identity);

    <span class="hljs-keyword">async</span>.all =
    <span class="hljs-keyword">async</span>.every = _createTester(<span class="hljs-keyword">async</span>.eachOf, notId, notId);

    <span class="hljs-keyword">async</span>.everyLimit = _createTester(<span class="hljs-keyword">async</span>.eachOfLimit, notId, notId);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_findGetResult</span>(<span class="hljs-params">v, x</span>) </span>{
        <span class="hljs-keyword">return</span> x;
    }
    <span class="hljs-keyword">async</span>.detect = _createTester(<span class="hljs-keyword">async</span>.eachOf, identity, _findGetResult);
    <span class="hljs-keyword">async</span>.detectSeries = _createTester(<span class="hljs-keyword">async</span>.eachOfSeries, identity, _findGetResult);
    <span class="hljs-keyword">async</span>.detectLimit = _createTester(<span class="hljs-keyword">async</span>.eachOfLimit, identity, _findGetResult);

    <span class="hljs-keyword">async</span>.sortBy = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr, iterator, callback</span>) </span>{
        <span class="hljs-keyword">async</span>.map(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x, callback</span>) </span>{
            iterator(x, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, criteria</span>) </span>{
                <span class="hljs-keyword">if</span> (err) {
                    callback(err);
                }
                <span class="hljs-keyword">else</span> {
                    callback(<span class="hljs-literal">null</span>, {<span class="hljs-attr">value</span>: x, <span class="hljs-attr">criteria</span>: criteria});
                }
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-keyword">return</span> callback(err);
            }
            <span class="hljs-keyword">else</span> {
                callback(<span class="hljs-literal">null</span>, _map(results.sort(comparator), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) </span>{
                    <span class="hljs-keyword">return</span> x.value;
                }));
            }

        });

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">comparator</span>(<span class="hljs-params">left, right</span>) </span>{
            <span class="hljs-keyword">var</span> a = left.criteria, b = right.criteria;
            <span class="hljs-keyword">return</span> a &lt; b ? <span class="hljs-number">-1</span> : a &gt; b ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
        }
    };

    <span class="hljs-keyword">async</span>.auto = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tasks, concurrency, callback</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">arguments</span>[<span class="hljs-number">1</span>] === <span class="hljs-string">'function'</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>concurrency is optional, shift the args.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            callback = concurrency;
            concurrency = <span class="hljs-literal">null</span>;
        }
        callback = _once(callback || noop);
        <span class="hljs-keyword">var</span> keys = _keys(tasks);
        <span class="hljs-keyword">var</span> remainingTasks = keys.length;
        <span class="hljs-keyword">if</span> (!remainingTasks) {
            <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>);
        }
        <span class="hljs-keyword">if</span> (!concurrency) {
            concurrency = remainingTasks;
        }

        <span class="hljs-keyword">var</span> results = {};
        <span class="hljs-keyword">var</span> runningTasks = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">var</span> hasError = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">var</span> listeners = [];
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addListener</span>(<span class="hljs-params">fn</span>) </span>{
            listeners.unshift(fn);
        }
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">removeListener</span>(<span class="hljs-params">fn</span>) </span>{
            <span class="hljs-keyword">var</span> idx = _indexOf(listeners, fn);
            <span class="hljs-keyword">if</span> (idx &gt;= <span class="hljs-number">0</span>) listeners.splice(idx, <span class="hljs-number">1</span>);
        }
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">taskComplete</span>(<span class="hljs-params"></span>) </span>{
            remainingTasks--;
            _arrayEach(listeners.slice(<span class="hljs-number">0</span>), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fn</span>) </span>{
                fn();
            });
        }

        addListener(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span> (!remainingTasks) {
                callback(<span class="hljs-literal">null</span>, results);
            }
        });

        _arrayEach(keys, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">k</span>) </span>{
            <span class="hljs-keyword">if</span> (hasError) <span class="hljs-keyword">return</span>;
            <span class="hljs-keyword">var</span> task = _isArray(tasks[k]) ? tasks[k]: [tasks[k]];
            <span class="hljs-keyword">var</span> taskCallback = _restParam(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, args</span>) </span>{
                runningTasks--;
                <span class="hljs-keyword">if</span> (args.length &lt;= <span class="hljs-number">1</span>) {
                    args = args[<span class="hljs-number">0</span>];
                }
                <span class="hljs-keyword">if</span> (err) {
                    <span class="hljs-keyword">var</span> safeResults = {};
                    _forEachOf(results, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val, rkey</span>) </span>{
                        safeResults[rkey] = val;
                    });
                    safeResults[k] = args;
                    hasError = <span class="hljs-literal">true</span>;

                    callback(err, safeResults);
                }
                <span class="hljs-keyword">else</span> {
                    results[k] = args;
                    <span class="hljs-keyword">async</span>.setImmediate(taskComplete);
                }
            });
            <span class="hljs-keyword">var</span> requires = task.slice(<span class="hljs-number">0</span>, task.length - <span class="hljs-number">1</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>prevent dead-locks</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">var</span> len = requires.length;
            <span class="hljs-keyword">var</span> dep;
            <span class="hljs-keyword">while</span> (len--) {
                <span class="hljs-keyword">if</span> (!(dep = tasks[requires[len]])) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Has nonexistent dependency in '</span> + requires.join(<span class="hljs-string">', '</span>));
                }
                <span class="hljs-keyword">if</span> (_isArray(dep) &amp;&amp; _indexOf(dep, k) &gt;= <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Has cyclic dependencies'</span>);
                }
            }
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ready</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> runningTasks &lt; concurrency &amp;&amp; _reduce(requires, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a, x</span>) </span>{
                    <span class="hljs-keyword">return</span> (a &amp;&amp; results.hasOwnProperty(x));
                }, <span class="hljs-literal">true</span>) &amp;&amp; !results.hasOwnProperty(k);
            }
            <span class="hljs-keyword">if</span> (ready()) {
                runningTasks++;
                task[task.length - <span class="hljs-number">1</span>](taskCallback, results);
            }
            <span class="hljs-keyword">else</span> {
                addListener(listener);
            }
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listener</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (ready()) {
                    runningTasks++;
                    removeListener(listener);
                    task[task.length - <span class="hljs-number">1</span>](taskCallback, results);
                }
            }
        });
    };



    <span class="hljs-keyword">async</span>.retry = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">times, task, callback</span>) </span>{
        <span class="hljs-keyword">var</span> DEFAULT_TIMES = <span class="hljs-number">5</span>;
        <span class="hljs-keyword">var</span> DEFAULT_INTERVAL = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">var</span> attempts = [];

        <span class="hljs-keyword">var</span> opts = {
            <span class="hljs-attr">times</span>: DEFAULT_TIMES,
            <span class="hljs-attr">interval</span>: DEFAULT_INTERVAL
        };

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseTimes</span>(<span class="hljs-params">acc, t</span>)</span>{
            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> t === <span class="hljs-string">'number'</span>){
                acc.times = <span class="hljs-built_in">parseInt</span>(t, <span class="hljs-number">10</span>) || DEFAULT_TIMES;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> t === <span class="hljs-string">'object'</span>){
                acc.times = <span class="hljs-built_in">parseInt</span>(t.times, <span class="hljs-number">10</span>) || DEFAULT_TIMES;
                acc.interval = <span class="hljs-built_in">parseInt</span>(t.interval, <span class="hljs-number">10</span>) || DEFAULT_INTERVAL;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Unsupported argument type for \'times\': '</span> + <span class="hljs-keyword">typeof</span> t);
            }
        }

        <span class="hljs-keyword">var</span> length = <span class="hljs-built_in">arguments</span>.length;
        <span class="hljs-keyword">if</span> (length &lt; <span class="hljs-number">1</span> || length &gt; <span class="hljs-number">3</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid arguments - must be either (task), (task, callback), (times, task) or (times, task, callback)'</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (length &lt;= <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-keyword">typeof</span> times === <span class="hljs-string">'function'</span>) {
            callback = task;
            task = times;
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> times !== <span class="hljs-string">'function'</span>) {
            parseTimes(opts, times);
        }
        opts.callback = callback;
        opts.task = task;

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">wrappedTask</span>(<span class="hljs-params">wrappedCallback, wrappedResults</span>) </span>{
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">retryAttempt</span>(<span class="hljs-params">task, finalAttempt</span>) </span>{
                <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">seriesCallback</span>) </span>{
                    task(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>)</span>{
                        seriesCallback(!err || finalAttempt, {<span class="hljs-attr">err</span>: err, <span class="hljs-attr">result</span>: result});
                    }, wrappedResults);
                };
            }

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">retryInterval</span>(<span class="hljs-params">interval</span>)</span>{
                <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">seriesCallback</span>)</span>{
                    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
                        seriesCallback(<span class="hljs-literal">null</span>);
                    }, interval);
                };
            }

            <span class="hljs-keyword">while</span> (opts.times) {

                <span class="hljs-keyword">var</span> finalAttempt = !(opts.times-=<span class="hljs-number">1</span>);
                attempts.push(retryAttempt(opts.task, finalAttempt));
                <span class="hljs-keyword">if</span>(!finalAttempt &amp;&amp; opts.interval &gt; <span class="hljs-number">0</span>){
                    attempts.push(retryInterval(opts.interval));
                }
            }

            <span class="hljs-keyword">async</span>.series(attempts, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">done, data</span>)</span>{
                data = data[data.length - <span class="hljs-number">1</span>];
                (wrappedCallback || opts.callback)(data.err, data.result);
            });
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>If a callback is passed, run this as a controll flow</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">return</span> opts.callback ? wrappedTask() : wrappedTask;
    };

    <span class="hljs-keyword">async</span>.waterfall = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tasks, callback</span>) </span>{
        callback = _once(callback || noop);
        <span class="hljs-keyword">if</span> (!_isArray(tasks)) {
            <span class="hljs-keyword">var</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'First argument to waterfall must be an array of functions'</span>);
            <span class="hljs-keyword">return</span> callback(err);
        }
        <span class="hljs-keyword">if</span> (!tasks.length) {
            <span class="hljs-keyword">return</span> callback();
        }
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">wrapIterator</span>(<span class="hljs-params">iterator</span>) </span>{
            <span class="hljs-keyword">return</span> _restParam(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, args</span>) </span>{
                <span class="hljs-keyword">if</span> (err) {
                    callback.apply(<span class="hljs-literal">null</span>, [err].concat(args));
                }
                <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">var</span> next = iterator.next();
                    <span class="hljs-keyword">if</span> (next) {
                        args.push(wrapIterator(next));
                    }
                    <span class="hljs-keyword">else</span> {
                        args.push(callback);
                    }
                    ensureAsync(iterator).apply(<span class="hljs-literal">null</span>, args);
                }
            });
        }
        wrapIterator(<span class="hljs-keyword">async</span>.iterator(tasks))();
    };

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_parallel</span>(<span class="hljs-params">eachfn, tasks, callback</span>) </span>{
        callback = callback || noop;
        <span class="hljs-keyword">var</span> results = _isArrayLike(tasks) ? [] : {};

        eachfn(tasks, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">task, key, callback</span>) </span>{
            task(_restParam(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, args</span>) </span>{
                <span class="hljs-keyword">if</span> (args.length &lt;= <span class="hljs-number">1</span>) {
                    args = args[<span class="hljs-number">0</span>];
                }
                results[key] = args;
                callback(err);
            }));
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
            callback(err, results);
        });
    }

    <span class="hljs-keyword">async</span>.parallel = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tasks, callback</span>) </span>{
        _parallel(<span class="hljs-keyword">async</span>.eachOf, tasks, callback);
    };

    <span class="hljs-keyword">async</span>.parallelLimit = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tasks, limit, callback</span>) </span>{
        _parallel(_eachOfLimit(limit), tasks, callback);
    };

    <span class="hljs-keyword">async</span>.series = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tasks, callback</span>) </span>{
        _parallel(<span class="hljs-keyword">async</span>.eachOfSeries, tasks, callback);
    };

    <span class="hljs-keyword">async</span>.iterator = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tasks</span>) </span>{
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeCallback</span>(<span class="hljs-params">index</span>) </span>{
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (tasks.length) {
                    tasks[index].apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>);
                }
                <span class="hljs-keyword">return</span> fn.next();
            }
            fn.next = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> (index &lt; tasks.length - <span class="hljs-number">1</span>) ? makeCallback(index + <span class="hljs-number">1</span>): <span class="hljs-literal">null</span>;
            };
            <span class="hljs-keyword">return</span> fn;
        }
        <span class="hljs-keyword">return</span> makeCallback(<span class="hljs-number">0</span>);
    };

    <span class="hljs-keyword">async</span>.apply = _restParam(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fn, args</span>) </span>{
        <span class="hljs-keyword">return</span> _restParam(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">callArgs</span>) </span>{
            <span class="hljs-keyword">return</span> fn.apply(
                <span class="hljs-literal">null</span>, args.concat(callArgs)
            );
        });
    });

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_concat</span>(<span class="hljs-params">eachfn, arr, fn, callback</span>) </span>{
        <span class="hljs-keyword">var</span> result = [];
        eachfn(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x, index, cb</span>) </span>{
            fn(x, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, y</span>) </span>{
                result = result.concat(y || []);
                cb(err);
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
            callback(err, result);
        });
    }
    <span class="hljs-keyword">async</span>.concat = doParallel(_concat);
    <span class="hljs-keyword">async</span>.concatSeries = doSeries(_concat);

    <span class="hljs-keyword">async</span>.whilst = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">test, iterator, callback</span>) </span>{
        callback = callback || noop;
        <span class="hljs-keyword">if</span> (test()) {
            <span class="hljs-keyword">var</span> next = _restParam(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, args</span>) </span>{
                <span class="hljs-keyword">if</span> (err) {
                    callback(err);
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (test.apply(<span class="hljs-keyword">this</span>, args)) {
                    iterator(next);
                } <span class="hljs-keyword">else</span> {
                    callback.apply(<span class="hljs-literal">null</span>, [<span class="hljs-literal">null</span>].concat(args));
                }
            });
            iterator(next);
        } <span class="hljs-keyword">else</span> {
            callback(<span class="hljs-literal">null</span>);
        }
    };

    <span class="hljs-keyword">async</span>.doWhilst = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">iterator, test, callback</span>) </span>{
        <span class="hljs-keyword">var</span> calls = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span>.whilst(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> ++calls &lt;= <span class="hljs-number">1</span> || test.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
        }, iterator, callback);
    };

    <span class="hljs-keyword">async</span>.until = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">test, iterator, callback</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span>.whilst(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> !test.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
        }, iterator, callback);
    };

    <span class="hljs-keyword">async</span>.doUntil = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">iterator, test, callback</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span>.doWhilst(iterator, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> !test.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
        }, callback);
    };

    <span class="hljs-keyword">async</span>.during = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">test, iterator, callback</span>) </span>{
        callback = callback || noop;

        <span class="hljs-keyword">var</span> next = _restParam(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, args</span>) </span>{
            <span class="hljs-keyword">if</span> (err) {
                callback(err);
            } <span class="hljs-keyword">else</span> {
                args.push(check);
                test.apply(<span class="hljs-keyword">this</span>, args);
            }
        });

        <span class="hljs-keyword">var</span> check = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, truth</span>) </span>{
            <span class="hljs-keyword">if</span> (err) {
                callback(err);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (truth) {
                iterator(next);
            } <span class="hljs-keyword">else</span> {
                callback(<span class="hljs-literal">null</span>);
            }
        };

        test(check);
    };

    <span class="hljs-keyword">async</span>.doDuring = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">iterator, test, callback</span>) </span>{
        <span class="hljs-keyword">var</span> calls = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">async</span>.during(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">next</span>) </span>{
            <span class="hljs-keyword">if</span> (calls++ <span class="xml"><span class="hljs-tag">&lt; <span class="hljs-attr">1</span>) {
                <span class="hljs-attr">next</span>(<span class="hljs-attr">null</span>, <span class="hljs-attr">true</span>);
            } <span class="hljs-attr">else</span> {
                <span class="hljs-attr">test.apply</span>(<span class="hljs-attr">this</span>, <span class="hljs-attr">arguments</span>);
            }
        }, <span class="hljs-attr">iterator</span>, <span class="hljs-attr">callback</span>);
    };

    <span class="hljs-attr">function</span> <span class="hljs-attr">_queue</span>(<span class="hljs-attr">worker</span>, <span class="hljs-attr">concurrency</span>, <span class="hljs-attr">payload</span>) {
        <span class="hljs-attr">if</span> (<span class="hljs-attr">concurrency</span> == <span class="hljs-string">null)</span> {
            <span class="hljs-attr">concurrency</span> = <span class="hljs-string">1;</span>
        }
        <span class="hljs-attr">else</span> <span class="hljs-attr">if</span>(<span class="hljs-attr">concurrency</span> === <span class="hljs-string">0)</span> {
            <span class="hljs-attr">throw</span> <span class="hljs-attr">new</span> <span class="hljs-attr">Error</span>('<span class="hljs-attr">Concurrency</span> <span class="hljs-attr">must</span> <span class="hljs-attr">not</span> <span class="hljs-attr">be</span> <span class="hljs-attr">zero</span>');
        }
        <span class="hljs-attr">function</span> <span class="hljs-attr">_insert</span>(<span class="hljs-attr">q</span>, <span class="hljs-attr">data</span>, <span class="hljs-attr">pos</span>, <span class="hljs-attr">callback</span>) {
            <span class="hljs-attr">if</span> (<span class="hljs-attr">callback</span> != <span class="hljs-string">null</span> &amp;&amp; <span class="hljs-attr">typeof</span> <span class="hljs-attr">callback</span> !== <span class="hljs-string">"function"</span>) {
                <span class="hljs-attr">throw</span> <span class="hljs-attr">new</span> <span class="hljs-attr">Error</span>("<span class="hljs-attr">task</span> <span class="hljs-attr">callback</span> <span class="hljs-attr">must</span> <span class="hljs-attr">be</span> <span class="hljs-attr">a</span> <span class="hljs-attr">function</span>");
            }
            <span class="hljs-attr">q.started</span> = <span class="hljs-string">true;</span>
            <span class="hljs-attr">if</span> (!<span class="hljs-attr">_isArray</span>(<span class="hljs-attr">data</span>)) {
                <span class="hljs-attr">data</span> = <span class="hljs-string">[data];</span>
            }
            <span class="hljs-attr">if</span>(<span class="hljs-attr">data.length</span> === <span class="hljs-string">0</span> &amp;&amp; <span class="hljs-attr">q.idle</span>()) {
</span></span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>call drain immediately if there are no tasks</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span>.setImmediate(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                    q.drain();
                });
            }
            _arrayEach(data, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">task</span>) </span>{
                <span class="hljs-keyword">var</span> item = {
                    <span class="hljs-attr">data</span>: task,
                    <span class="hljs-attr">callback</span>: callback || noop
                };

                <span class="hljs-keyword">if</span> (pos) {
                    q.tasks.unshift(item);
                } <span class="hljs-keyword">else</span> {
                    q.tasks.push(item);
                }

                <span class="hljs-keyword">if</span> (q.tasks.length === q.concurrency) {
                    q.saturated();
                }
            });
            <span class="hljs-keyword">async</span>.setImmediate(q.process);
        }
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_next</span>(<span class="hljs-params">q, tasks</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
                workers -= <span class="hljs-number">1</span>;

                <span class="hljs-keyword">var</span> removed = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">arguments</span>;
                _arrayEach(tasks, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">task</span>) </span>{
                    _arrayEach(workersList, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">worker, index</span>) </span>{
                        <span class="hljs-keyword">if</span> (worker === task &amp;&amp; !removed) {
                            workersList.splice(index, <span class="hljs-number">1</span>);
                            removed = <span class="hljs-literal">true</span>;
                        }
                    });

                    task.callback.apply(task, args);
                });
                <span class="hljs-keyword">if</span> (q.tasks.length + workers === <span class="hljs-number">0</span>) {
                    q.drain();
                }
                q.process();
            };
        }

        <span class="hljs-keyword">var</span> workers = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> workersList = [];
        <span class="hljs-keyword">var</span> q = {
            <span class="hljs-attr">tasks</span>: [],
            <span class="hljs-attr">concurrency</span>: concurrency,
            <span class="hljs-attr">payload</span>: payload,
            <span class="hljs-attr">saturated</span>: noop,
            <span class="hljs-attr">empty</span>: noop,
            <span class="hljs-attr">drain</span>: noop,
            <span class="hljs-attr">started</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">paused</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">push</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data, callback</span>) </span>{
                _insert(q, data, <span class="hljs-literal">false</span>, callback);
            },
            <span class="hljs-attr">kill</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                q.drain = noop;
                q.tasks = [];
            },
            <span class="hljs-attr">unshift</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data, callback</span>) </span>{
                _insert(q, data, <span class="hljs-literal">true</span>, callback);
            },
            <span class="hljs-attr">process</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">while</span>(!q.paused &amp;&amp; workers &lt; q.concurrency &amp;&amp; q.tasks.length){

                    <span class="hljs-keyword">var</span> tasks = q.payload ?
                        q.tasks.splice(<span class="hljs-number">0</span>, q.payload) :
                        q.tasks.splice(<span class="hljs-number">0</span>, q.tasks.length);

                    <span class="hljs-keyword">var</span> data = _map(tasks, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">task</span>) </span>{
                        <span class="hljs-keyword">return</span> task.data;
                    });

                    <span class="hljs-keyword">if</span> (q.tasks.length === <span class="hljs-number">0</span>) {
                        q.empty();
                    }
                    workers += <span class="hljs-number">1</span>;
                    workersList.push(tasks[<span class="hljs-number">0</span>]);
                    <span class="hljs-keyword">var</span> cb = only_once(_next(q, tasks));
                    worker(data, cb);
                }
            },
            <span class="hljs-attr">length</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> q.tasks.length;
            },
            <span class="hljs-attr">running</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> workers;
            },
            <span class="hljs-attr">workersList</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> workersList;
            },
            <span class="hljs-attr">idle</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> q.tasks.length + workers === <span class="hljs-number">0</span>;
            },
            <span class="hljs-attr">pause</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                q.paused = <span class="hljs-literal">true</span>;
            },
            <span class="hljs-attr">resume</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (q.paused === <span class="hljs-literal">false</span>) { <span class="hljs-keyword">return</span>; }
                q.paused = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">var</span> resumeCount = <span class="hljs-built_in">Math</span>.min(q.concurrency, q.tasks.length);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>Need to call q.process once per concurrent
worker to preserve full concurrency after pause</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> w = <span class="hljs-number">1</span>; w &lt;= resumeCount; w++) {
                    <span class="hljs-keyword">async</span>.setImmediate(q.process);
                }
            }
        };
        <span class="hljs-keyword">return</span> q;
    }

    <span class="hljs-keyword">async</span>.queue = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">worker, concurrency</span>) </span>{
        <span class="hljs-keyword">var</span> q = _queue(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items, cb</span>) </span>{
            worker(items[<span class="hljs-number">0</span>], cb);
        }, concurrency, <span class="hljs-number">1</span>);

        <span class="hljs-keyword">return</span> q;
    };

    <span class="hljs-keyword">async</span>.priorityQueue = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">worker, concurrency</span>) </span>{

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_compareTasks</span>(<span class="hljs-params">a, b</span>)</span>{
            <span class="hljs-keyword">return</span> a.priority - b.priority;
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_binarySearch</span>(<span class="hljs-params">sequence, item, compare</span>) </span>{
            <span class="hljs-keyword">var</span> beg = <span class="hljs-number">-1</span>,
                end = sequence.length - <span class="hljs-number">1</span>;
            <span class="hljs-keyword">while</span> (beg &lt; end) {
                <span class="hljs-keyword">var</span> mid = beg + ((end - beg + <span class="hljs-number">1</span>) &gt;&gt;&gt; <span class="hljs-number">1</span>);
                <span class="hljs-keyword">if</span> (compare(item, sequence[mid]) &gt;= <span class="hljs-number">0</span>) {
                    beg = mid;
                } <span class="hljs-keyword">else</span> {
                    end = mid - <span class="hljs-number">1</span>;
                }
            }
            <span class="hljs-keyword">return</span> beg;
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_insert</span>(<span class="hljs-params">q, data, priority, callback</span>) </span>{
            <span class="hljs-keyword">if</span> (callback != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">typeof</span> callback !== <span class="hljs-string">"function"</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"task callback must be a function"</span>);
            }
            q.started = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">if</span> (!_isArray(data)) {
                data = [data];
            }
            <span class="hljs-keyword">if</span>(data.length === <span class="hljs-number">0</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>call drain immediately if there are no tasks</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span>.setImmediate(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                    q.drain();
                });
            }
            _arrayEach(data, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">task</span>) </span>{
                <span class="hljs-keyword">var</span> item = {
                    <span class="hljs-attr">data</span>: task,
                    <span class="hljs-attr">priority</span>: priority,
                    <span class="hljs-attr">callback</span>: <span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span> ? callback : noop
                };

                q.tasks.splice(_binarySearch(q.tasks, item, _compareTasks) + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, item);

                <span class="hljs-keyword">if</span> (q.tasks.length === q.concurrency) {
                    q.saturated();
                }
                <span class="hljs-keyword">async</span>.setImmediate(q.process);
            });
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>Start with a normal queue</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">var</span> q = <span class="hljs-keyword">async</span>.queue(worker, concurrency);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>Override push to accept second parameter representing priority</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        q.push = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data, priority, callback</span>) </span>{
            _insert(q, data, priority, callback);
        };

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>Remove unshift function</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">delete</span> q.unshift;

        <span class="hljs-keyword">return</span> q;
    };

    <span class="hljs-keyword">async</span>.cargo = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">worker, payload</span>) </span>{
        <span class="hljs-keyword">return</span> _queue(worker, <span class="hljs-number">1</span>, payload);
    };

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_console_fn</span>(<span class="hljs-params">name</span>) </span>{
        <span class="hljs-keyword">return</span> _restParam(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fn, args</span>) </span>{
            fn.apply(<span class="hljs-literal">null</span>, args.concat([_restParam(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, args</span>) </span>{
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">console</span> === <span class="hljs-string">'object'</span>) {
                    <span class="hljs-keyword">if</span> (err) {
                        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">console</span>.error) {
                            <span class="hljs-built_in">console</span>.error(err);
                        }
                    }
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">console</span>[name]) {
                        _arrayEach(args, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) </span>{
                            <span class="hljs-built_in">console</span>[name](x);
                        });
                    }
                }
            })]));
        });
    }
    <span class="hljs-keyword">async</span>.log = _console_fn(<span class="hljs-string">'log'</span>);
    <span class="hljs-keyword">async</span>.dir = _console_fn(<span class="hljs-string">'dir'</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<div class="dox">
<div class="summary">
<p>async.info = _console_fn('info');
async.warn = _console_fn('warn');
async.error = _console_fn('error');</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">async</span>.memoize = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fn, hasher</span>) </span>{
        <span class="hljs-keyword">var</span> memo = {};
        <span class="hljs-keyword">var</span> queues = {};
        <span class="hljs-keyword">var</span> has = <span class="hljs-built_in">Object</span>.prototype.hasOwnProperty;
        hasher = hasher || identity;
        <span class="hljs-keyword">var</span> memoized = _restParam(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">memoized</span>(<span class="hljs-params">args</span>) </span>{
            <span class="hljs-keyword">var</span> callback = args.pop();
            <span class="hljs-keyword">var</span> key = hasher.apply(<span class="hljs-literal">null</span>, args);
            <span class="hljs-keyword">if</span> (has.call(memo, key)) {   
                <span class="hljs-keyword">async</span>.setImmediate(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                    callback.apply(<span class="hljs-literal">null</span>, memo[key]);
                });
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (has.call(queues, key)) {
                queues[key].push(callback);
            }
            <span class="hljs-keyword">else</span> {
                queues[key] = [callback];
                fn.apply(<span class="hljs-literal">null</span>, args.concat([_restParam(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>{
                    memo[key] = args;
                    <span class="hljs-keyword">var</span> q = queues[key];
                    <span class="hljs-keyword">delete</span> queues[key];
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = q.length; i &lt; l; i++) {
                        q[i].apply(<span class="hljs-literal">null</span>, args);
                    }
                })]));
            }
        });
        memoized.memo = memo;
        memoized.unmemoized = fn;
        <span class="hljs-keyword">return</span> memoized;
    };

    <span class="hljs-keyword">async</span>.unmemoize = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fn</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> (fn.unmemoized || fn).apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>);
        };
    };

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_times</span>(<span class="hljs-params">mapper</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">count, iterator, callback</span>) </span>{
            mapper(_range(count), iterator, callback);
        };
    }

    <span class="hljs-keyword">async</span>.times = _times(<span class="hljs-keyword">async</span>.map);
    <span class="hljs-keyword">async</span>.timesSeries = _times(<span class="hljs-keyword">async</span>.mapSeries);
    <span class="hljs-keyword">async</span>.timesLimit = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">count, limit, iterator, callback</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span>.mapLimit(_range(count), limit, iterator, callback);
    };

    <span class="hljs-keyword">async</span>.seq = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-regexp">/* functions... */</span></span>) </span>{
        <span class="hljs-keyword">var</span> fns = <span class="hljs-built_in">arguments</span>;
        <span class="hljs-keyword">return</span> _restParam(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>{
            <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;

            <span class="hljs-keyword">var</span> callback = args[args.length - <span class="hljs-number">1</span>];
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback == <span class="hljs-string">'function'</span>) {
                args.pop();
            } <span class="hljs-keyword">else</span> {
                callback = noop;
            }

            <span class="hljs-keyword">async</span>.reduce(fns, args, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">newargs, fn, cb</span>) </span>{
                fn.apply(that, newargs.concat([_restParam(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, nextargs</span>) </span>{
                    cb(err, nextargs);
                })]));
            },
            <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
                callback.apply(that, [err].concat(results));
            });
        });
    };

    <span class="hljs-keyword">async</span>.compose = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-regexp">/* functions... */</span></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span>.seq.apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">Array</span>.prototype.reverse.call(<span class="hljs-built_in">arguments</span>));
    };


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_applyEach</span>(<span class="hljs-params">eachfn</span>) </span>{
        <span class="hljs-keyword">return</span> _restParam(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fns, args</span>) </span>{
            <span class="hljs-keyword">var</span> go = _restParam(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) </span>{
                <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
                <span class="hljs-keyword">var</span> callback = args.pop();
                <span class="hljs-keyword">return</span> eachfn(fns, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fn, _, cb</span>) </span>{
                    fn.apply(that, args.concat([cb]));
                },
                callback);
            });
            <span class="hljs-keyword">if</span> (args.length) {
                <span class="hljs-keyword">return</span> go.apply(<span class="hljs-keyword">this</span>, args);
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> go;
            }
        });
    }

    <span class="hljs-keyword">async</span>.applyEach = _applyEach(<span class="hljs-keyword">async</span>.eachOf);
    <span class="hljs-keyword">async</span>.applyEachSeries = _applyEach(<span class="hljs-keyword">async</span>.eachOfSeries);


    <span class="hljs-keyword">async</span>.forever = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fn, callback</span>) </span>{
        <span class="hljs-keyword">var</span> done = only_once(callback || noop);
        <span class="hljs-keyword">var</span> task = ensureAsync(fn);
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span>(<span class="hljs-params">err</span>) </span>{
            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-keyword">return</span> done(err);
            }
            task(next);
        }
        next();
    };

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ensureAsync</span>(<span class="hljs-params">fn</span>) </span>{
        <span class="hljs-keyword">return</span> _restParam(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>{
            <span class="hljs-keyword">var</span> callback = args.pop();
            args.push(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">var</span> innerArgs = <span class="hljs-built_in">arguments</span>;
                <span class="hljs-keyword">if</span> (sync) {
                    <span class="hljs-keyword">async</span>.setImmediate(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                        callback.apply(<span class="hljs-literal">null</span>, innerArgs);
                    });
                } <span class="hljs-keyword">else</span> {
                    callback.apply(<span class="hljs-literal">null</span>, innerArgs);
                }
            });
            <span class="hljs-keyword">var</span> sync = <span class="hljs-literal">true</span>;
            fn.apply(<span class="hljs-keyword">this</span>, args);
            sync = <span class="hljs-literal">false</span>;
        });
    }

    <span class="hljs-keyword">async</span>.ensureAsync = ensureAsync;

    <span class="hljs-keyword">async</span>.constant = _restParam(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">values</span>) </span>{
        <span class="hljs-keyword">var</span> args = [<span class="hljs-literal">null</span>].concat(values);
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">callback</span>) </span>{
            <span class="hljs-keyword">return</span> callback.apply(<span class="hljs-keyword">this</span>, args);
        };
    });

    <span class="hljs-keyword">async</span>.wrapSync =
    <span class="hljs-keyword">async</span>.asyncify = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">asyncify</span>(<span class="hljs-params">func</span>) </span>{
        <span class="hljs-keyword">return</span> _restParam(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>{
            <span class="hljs-keyword">var</span> callback = args.pop();
            <span class="hljs-keyword">var</span> result;
            <span class="hljs-keyword">try</span> {
                result = func.apply(<span class="hljs-keyword">this</span>, args);
            } <span class="hljs-keyword">catch</span> (e) {
                <span class="hljs-keyword">return</span> callback(e);
            }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>if result is Promise object</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">if</span> (_isObject(result) &amp;&amp; <span class="hljs-keyword">typeof</span> result.then === <span class="hljs-string">"function"</span>) {
                result.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
                    callback(<span class="hljs-literal">null</span>, value);
                })[<span class="hljs-string">"catch"</span>](<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
                    callback(err.message ? err : <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(err));
                });
            } <span class="hljs-keyword">else</span> {
                callback(<span class="hljs-literal">null</span>, result);
            }
        });
    };

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>Node.js</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">module</span> === <span class="hljs-string">'object'</span> &amp;&amp; <span class="hljs-built_in">module</span>.exports) {
        <span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">async</span>;
    }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>AMD / RequireJS</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">'function'</span> &amp;&amp; define.amd) {
        define([], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span>;
        });
    }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>included directly via <script> tag</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">else</span> {
        root.async = <span class="hljs-keyword">async</span>;
    }

}());

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

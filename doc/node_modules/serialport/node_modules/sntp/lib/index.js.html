<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/sntp/lib/index.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h2">
        <a href="#timestamp-name-id-when-generated">Timestamp Name          ID   When Generated</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>Load modules</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> Dgram = <span class="hljs-built_in">require</span>(<span class="hljs-string">'dgram'</span>);
<span class="hljs-keyword">var</span> Dns = <span class="hljs-built_in">require</span>(<span class="hljs-string">'dns'</span>);
<span class="hljs-keyword">var</span> Hoek = <span class="hljs-built_in">require</span>(<span class="hljs-string">'hoek'</span>);


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Declare internals</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> internals = {};


exports.time = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">options, callback</span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length !== <span class="hljs-number">2</span>) {
        callback = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>];
        options = {};
    }

    <span class="hljs-keyword">var</span> settings = Hoek.clone(options);
    settings.host = settings.host || <span class="hljs-string">'pool.ntp.org'</span>;
    settings.port = settings.port || <span class="hljs-number">123</span>;
    settings.resolveReference = settings.resolveReference || <span class="hljs-literal">false</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Declare variables used by callback</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> timeoutId = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> sent = <span class="hljs-number">0</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>Ensure callback is only called once</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> finish = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, result</span>) </span>{

        <span class="hljs-keyword">if</span> (timeoutId) {
            clearTimeout(timeoutId);
            timeoutId = <span class="hljs-number">0</span>;
        }

        socket.removeAllListeners();
        socket.once(<span class="hljs-string">'error'</span>, internals.ignore);
        socket.close();
        <span class="hljs-keyword">return</span> callback(err, result);
    };

    finish = Hoek.once(finish);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Create UDP socket</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> socket = Dgram.createSocket(<span class="hljs-string">'udp4'</span>);

    socket.once(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{

        <span class="hljs-keyword">return</span> finish(err);
    });

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Listen to incoming messages</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    socket.on(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">buffer, rinfo</span>) </span>{

        <span class="hljs-keyword">var</span> received = <span class="hljs-built_in">Date</span>.now();

        <span class="hljs-keyword">var</span> message = <span class="hljs-keyword">new</span> internals.NtpMessage(buffer);
        <span class="hljs-keyword">if</span> (!message.isValid) {
            <span class="hljs-keyword">return</span> finish(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid server response'</span>), message);
        }

        <span class="hljs-keyword">if</span> (message.originateTimestamp !== sent) {
            <span class="hljs-keyword">return</span> finish(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Wrong originate timestamp'</span>), message);
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="timestamp-name-id-when-generated">
  <h2>
    <a href="#timestamp-name-id-when-generated" name="timestamp-name-id-when-generated" class="pilcrow"></a>
Timestamp Name          ID   When Generated
  </h2>
</div>
<p>Originate Timestamp     T1   time request sent by client
Receive Timestamp       T2   time request received by server
Transmit Timestamp      T3   time reply sent by server
Destination Timestamp   T4   time reply received by client</p>
<p>The roundtrip delay d and system clock offset t are defined as:</p>
<p>d = (T4 - T1) - (T3 - T2)     t = ((T2 - T1) + (T3 - T4)) / 2</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
        <span class="hljs-keyword">var</span> T1 = message.originateTimestamp;
        <span class="hljs-keyword">var</span> T2 = message.receiveTimestamp;
        <span class="hljs-keyword">var</span> T3 = message.transmitTimestamp;
        <span class="hljs-keyword">var</span> T4 = received;

        message.d = (T4 - T1) - (T3 - T2);
        message.t = ((T2 - T1) + (T3 - T4)) / <span class="hljs-number">2</span>;
        message.receivedLocally = received;

        <span class="hljs-keyword">if</span> (!settings.resolveReference ||
            message.stratum !== <span class="hljs-string">'secondary'</span>) {

            <span class="hljs-keyword">return</span> finish(<span class="hljs-literal">null</span>, message);
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Resolve reference IP address</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
        Dns.reverse(message.referenceId, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, domains</span>) </span>{

            <span class="hljs-keyword">if</span> (<span class="hljs-comment">/* $lab:coverage:off$ */</span> !err <span class="hljs-comment">/* $lab:coverage:on$ */</span>) {
                message.referenceHost = domains[<span class="hljs-number">0</span>];
            }

            <span class="hljs-keyword">return</span> finish(<span class="hljs-literal">null</span>, message);
        });
    });

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>Set timeout</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">if</span> (settings.timeout) {
        timeoutId = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

            timeoutId = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">return</span> finish(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Timeout'</span>));
        }, settings.timeout);
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>Construct NTP message</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> message = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">48</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">48</span>; i++) {                      <span class="hljs-comment">// Zero message</span>
        message[i] = <span class="hljs-number">0</span>;
    }

    message[<span class="hljs-number">0</span>] = (<span class="hljs-number">0</span> &lt;&lt; <span class="hljs-number">6</span>) + (<span class="hljs-number">4</span> &lt;&lt; <span class="hljs-number">3</span>) + (<span class="hljs-number">3</span> &lt;&lt; <span class="hljs-number">0</span>)         <span class="hljs-comment">// Set version number to 4 and Mode to 3 (client)</span>
    sent = <span class="hljs-built_in">Date</span>.now();
    internals.fromMsecs(sent, message, <span class="hljs-number">40</span>);               <span class="hljs-comment">// Set transmit timestamp (returns as originate)</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>Send NTP request</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    socket.send(message, <span class="hljs-number">0</span>, message.length, settings.port, settings.host, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, bytes</span>) </span>{

        <span class="hljs-keyword">if</span> (err ||
            bytes !== <span class="hljs-number">48</span>) {

            <span class="hljs-keyword">return</span> finish(err || <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Could not send entire message'</span>));
        }
    });
};


internals.NtpMessage = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">buffer</span>) </span>{

    <span class="hljs-keyword">this</span>.isValid = <span class="hljs-literal">false</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>Validate</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">if</span> (buffer.length !== <span class="hljs-number">48</span>) {
        <span class="hljs-keyword">return</span>;
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>Leap indicator</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> li = (buffer[<span class="hljs-number">0</span>] &gt;&gt; <span class="hljs-number">6</span>);
    <span class="hljs-keyword">switch</span> (li) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: <span class="hljs-keyword">this</span>.leapIndicator = <span class="hljs-string">'no-warning'</span>; <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-keyword">this</span>.leapIndicator = <span class="hljs-string">'last-minute-61'</span>; <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-keyword">this</span>.leapIndicator = <span class="hljs-string">'last-minute-59'</span>; <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-keyword">this</span>.leapIndicator = <span class="hljs-string">'alarm'</span>; <span class="hljs-keyword">break</span>;
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>Version</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> vn = ((buffer[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0x38</span>) &gt;&gt; <span class="hljs-number">3</span>);
    <span class="hljs-keyword">this</span>.version = vn;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>Mode</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> mode = (buffer[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0x7</span>);
    <span class="hljs-keyword">switch</span> (mode) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-keyword">this</span>.mode = <span class="hljs-string">'symmetric-active'</span>; <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-keyword">this</span>.mode = <span class="hljs-string">'symmetric-passive'</span>; <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-keyword">this</span>.mode = <span class="hljs-string">'client'</span>; <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: <span class="hljs-keyword">this</span>.mode = <span class="hljs-string">'server'</span>; <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>: <span class="hljs-keyword">this</span>.mode = <span class="hljs-string">'broadcast'</span>; <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
        <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:
        <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>: <span class="hljs-keyword">this</span>.mode = <span class="hljs-string">'reserved'</span>; <span class="hljs-keyword">break</span>;
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>Stratum</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> stratum = buffer[<span class="hljs-number">1</span>];
    <span class="hljs-keyword">if</span> (stratum === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">this</span>.stratum = <span class="hljs-string">'death'</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (stratum === <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">this</span>.stratum = <span class="hljs-string">'primary'</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (stratum &lt;= <span class="hljs-number">15</span>) {
        <span class="hljs-keyword">this</span>.stratum = <span class="hljs-string">'secondary'</span>;
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.stratum = <span class="hljs-string">'reserved'</span>;
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>Poll interval (msec)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">this</span>.pollInterval = <span class="hljs-built_in">Math</span>.round(<span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, buffer[<span class="hljs-number">2</span>])) * <span class="hljs-number">1000</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>Precision (msecs)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">this</span>.precision = <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, buffer[<span class="hljs-number">3</span>]) * <span class="hljs-number">1000</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>Root delay (msecs)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> rootDelay = <span class="hljs-number">256</span> * (<span class="hljs-number">256</span> * (<span class="hljs-number">256</span> * buffer[<span class="hljs-number">4</span>] + buffer[<span class="hljs-number">5</span>]) + buffer[<span class="hljs-number">6</span>]) + buffer[<span class="hljs-number">7</span>];
    <span class="hljs-keyword">this</span>.rootDelay = <span class="hljs-number">1000</span> * (rootDelay / <span class="hljs-number">0x10000</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>Root dispersion (msecs)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">this</span>.rootDispersion = ((buffer[<span class="hljs-number">8</span>] &lt;&lt; <span class="hljs-number">8</span>) + buffer[<span class="hljs-number">9</span>] + ((buffer[<span class="hljs-number">10</span>] &lt;&lt; <span class="hljs-number">8</span>) + buffer[<span class="hljs-number">11</span>]) / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, <span class="hljs-number">16</span>)) * <span class="hljs-number">1000</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>Reference identifier</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">this</span>.referenceId = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>.stratum) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'death'</span>:
        <span class="hljs-keyword">case</span> <span class="hljs-string">'primary'</span>:
            <span class="hljs-keyword">this</span>.referenceId = <span class="hljs-built_in">String</span>.fromCharCode(buffer[<span class="hljs-number">12</span>]) + <span class="hljs-built_in">String</span>.fromCharCode(buffer[<span class="hljs-number">13</span>]) + <span class="hljs-built_in">String</span>.fromCharCode(buffer[<span class="hljs-number">14</span>]) + <span class="hljs-built_in">String</span>.fromCharCode(buffer[<span class="hljs-number">15</span>]);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'secondary'</span>:
            <span class="hljs-keyword">this</span>.referenceId = <span class="hljs-string">''</span> + buffer[<span class="hljs-number">12</span>] + <span class="hljs-string">'.'</span> + buffer[<span class="hljs-number">13</span>] + <span class="hljs-string">'.'</span> + buffer[<span class="hljs-number">14</span>] + <span class="hljs-string">'.'</span> + buffer[<span class="hljs-number">15</span>];
            <span class="hljs-keyword">break</span>;
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>Reference timestamp</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">this</span>.referenceTimestamp = internals.toMsecs(buffer, <span class="hljs-number">16</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>Originate timestamp</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">this</span>.originateTimestamp = internals.toMsecs(buffer, <span class="hljs-number">24</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>Receive timestamp</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">this</span>.receiveTimestamp = internals.toMsecs(buffer, <span class="hljs-number">32</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>Transmit timestamp</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">this</span>.transmitTimestamp = internals.toMsecs(buffer, <span class="hljs-number">40</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>Validate</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.version === <span class="hljs-number">4</span> &amp;&amp;
        <span class="hljs-keyword">this</span>.stratum !== <span class="hljs-string">'reserved'</span> &amp;&amp;
        <span class="hljs-keyword">this</span>.mode === <span class="hljs-string">'server'</span> &amp;&amp;
        <span class="hljs-keyword">this</span>.originateTimestamp &amp;&amp;
        <span class="hljs-keyword">this</span>.receiveTimestamp &amp;&amp;
        <span class="hljs-keyword">this</span>.transmitTimestamp) {

        <span class="hljs-keyword">this</span>.isValid = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};


internals.toMsecs = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">buffer, offset</span>) </span>{

    <span class="hljs-keyword">var</span> seconds = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> fraction = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; ++i) {
        seconds = (seconds * <span class="hljs-number">256</span>) + buffer[offset + i];
    }

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">4</span>; i &lt; <span class="hljs-number">8</span>; ++i) {
        fraction = (fraction * <span class="hljs-number">256</span>) + buffer[offset + i];
    }

    <span class="hljs-keyword">return</span> ((seconds - <span class="hljs-number">2208988800</span> + (fraction / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>))) * <span class="hljs-number">1000</span>);
};


internals.fromMsecs = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ts, buffer, offset</span>) </span>{

    <span class="hljs-keyword">var</span> seconds = <span class="hljs-built_in">Math</span>.floor(ts / <span class="hljs-number">1000</span>) + <span class="hljs-number">2208988800</span>;
    <span class="hljs-keyword">var</span> fraction = <span class="hljs-built_in">Math</span>.round((ts % <span class="hljs-number">1000</span>) / <span class="hljs-number">1000</span> * <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>));

    buffer[offset + <span class="hljs-number">0</span>] = (seconds &amp; <span class="hljs-number">0xFF000000</span>) &gt;&gt; <span class="hljs-number">24</span>;
    buffer[offset + <span class="hljs-number">1</span>] = (seconds &amp; <span class="hljs-number">0x00FF0000</span>) &gt;&gt; <span class="hljs-number">16</span>;
    buffer[offset + <span class="hljs-number">2</span>] = (seconds &amp; <span class="hljs-number">0x0000FF00</span>) &gt;&gt; <span class="hljs-number">8</span>;
    buffer[offset + <span class="hljs-number">3</span>] = (seconds &amp; <span class="hljs-number">0x000000FF</span>);

    buffer[offset + <span class="hljs-number">4</span>] = (fraction &amp; <span class="hljs-number">0xFF000000</span>) &gt;&gt; <span class="hljs-number">24</span>;
    buffer[offset + <span class="hljs-number">5</span>] = (fraction &amp; <span class="hljs-number">0x00FF0000</span>) &gt;&gt; <span class="hljs-number">16</span>;
    buffer[offset + <span class="hljs-number">6</span>] = (fraction &amp; <span class="hljs-number">0x0000FF00</span>) &gt;&gt; <span class="hljs-number">8</span>;
    buffer[offset + <span class="hljs-number">7</span>] = (fraction &amp; <span class="hljs-number">0x000000FF</span>);
};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>Offset singleton</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
internals.last = {
    <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">expires</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">host</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">port</span>: <span class="hljs-number">0</span>
};


exports.offset = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">options, callback</span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length !== <span class="hljs-number">2</span>) {
        callback = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>];
        options = {};
    }

    <span class="hljs-keyword">var</span> now = <span class="hljs-built_in">Date</span>.now();
    <span class="hljs-keyword">var</span> clockSyncRefresh = options.clockSyncRefresh || <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;                    <span class="hljs-comment">// Daily</span>

    <span class="hljs-keyword">if</span> (internals.last.offset &amp;&amp;
        internals.last.host === options.host &amp;&amp;
        internals.last.port === options.port &amp;&amp;
        now &lt; internals.last.expires) {

        process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

            callback(<span class="hljs-literal">null</span>, internals.last.offset);
        });

        <span class="hljs-keyword">return</span>;
    }

    exports.time(options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

        <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-keyword">return</span> callback(err, <span class="hljs-number">0</span>);
        }

        internals.last = {
            <span class="hljs-attr">offset</span>: <span class="hljs-built_in">Math</span>.round(time.t),
            <span class="hljs-attr">expires</span>: now + clockSyncRefresh,
            <span class="hljs-attr">host</span>: options.host,
            <span class="hljs-attr">port</span>: options.port
        };

        <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, internals.last.offset);
    });
};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>Now singleton</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
internals.now = {
    <span class="hljs-attr">intervalId</span>: <span class="hljs-number">0</span>
};


exports.start = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">options, callback</span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length !== <span class="hljs-number">2</span>) {
        callback = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>];
        options = {};
    }

    <span class="hljs-keyword">if</span> (internals.now.intervalId) {
        process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

            callback();
        });

        <span class="hljs-keyword">return</span>;
    }

    exports.offset(options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, offset</span>) </span>{

        internals.now.intervalId = setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

            exports.offset(options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ });
        }, options.clockSyncRefresh || <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);                                <span class="hljs-comment">// Daily</span>

        <span class="hljs-keyword">return</span> callback();
    });
};


exports.stop = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">if</span> (!internals.now.intervalId) {
        <span class="hljs-keyword">return</span>;
    }

    clearInterval(internals.now.intervalId);
    internals.now.intervalId = <span class="hljs-number">0</span>;
};


exports.isLive = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> !!internals.now.intervalId;
};


exports.now = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">var</span> now = <span class="hljs-built_in">Date</span>.now();
    <span class="hljs-keyword">if</span> (!exports.isLive() ||
        now &gt;= internals.last.expires) {

        <span class="hljs-keyword">return</span> now;
    }

    <span class="hljs-keyword">return</span> now + internals.last.offset;
};


internals.ignore = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

};

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

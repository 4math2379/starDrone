<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/sntp/test/index.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>Load modules</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> Dns = <span class="hljs-built_in">require</span>(<span class="hljs-string">'dns'</span>);
<span class="hljs-keyword">var</span> Dgram = <span class="hljs-built_in">require</span>(<span class="hljs-string">'dgram'</span>);
<span class="hljs-keyword">var</span> Lab = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lab'</span>);
<span class="hljs-keyword">var</span> Sntp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib'</span>);


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Declare internals</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> internals = {};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Test shortcuts</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> lab = exports.lab = Lab.script();
<span class="hljs-keyword">var</span> before = lab.before;
<span class="hljs-keyword">var</span> after = lab.after;
<span class="hljs-keyword">var</span> describe = lab.experiment;
<span class="hljs-keyword">var</span> it = lab.test;
<span class="hljs-keyword">var</span> expect = Lab.expect;


describe(<span class="hljs-string">'SNTP'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    describe(<span class="hljs-string">'#time'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        it(<span class="hljs-string">'returns consistent result over multiple tries'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            Sntp.time(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                expect(err).to.not.exist;
                expect(time).to.exist;
                <span class="hljs-keyword">var</span> t1 = time.t;

                Sntp.time(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                    expect(err).to.not.exist;
                    expect(time).to.exist;
                    <span class="hljs-keyword">var</span> t2 = time.t;
                    expect(<span class="hljs-built_in">Math</span>.abs(t1 - t2)).is.below(<span class="hljs-number">200</span>);
                    done();
                });
            });
        });

        it(<span class="hljs-string">'resolves reference IP'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            Sntp.time({ <span class="hljs-attr">host</span>: <span class="hljs-string">'ntp.exnet.com'</span>, <span class="hljs-attr">resolveReference</span>: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                expect(err).to.not.exist;
                expect(time).to.exist;
                expect(time.referenceHost).to.exist;
                done();
            });
        });

        it(<span class="hljs-string">'times out on no response'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            Sntp.time({ <span class="hljs-attr">port</span>: <span class="hljs-number">124</span>, <span class="hljs-attr">timeout</span>: <span class="hljs-number">100</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                expect(err).to.exist;
                expect(time).to.not.exist;
                expect(err.message).to.equal(<span class="hljs-string">'Timeout'</span>);
                done();
            });
        });

        it(<span class="hljs-string">'errors on error event'</span>, { <span class="hljs-attr">parallel</span>: <span class="hljs-literal">false</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> orig = Dgram.createSocket;
            Dgram.createSocket = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">type</span>) </span>{

                Dgram.createSocket = orig;
                <span class="hljs-keyword">var</span> socket = Dgram.createSocket(type);
                setImmediate(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ socket.emit(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Fake'</span>)) });
                <span class="hljs-keyword">return</span> socket;
            };

            Sntp.time(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                expect(err).to.exist;
                expect(time).to.not.exist;
                expect(err.message).to.equal(<span class="hljs-string">'Fake'</span>);
                done();
            });
        });

        it(<span class="hljs-string">'errors on incorrect sent size'</span>, { <span class="hljs-attr">parallel</span>: <span class="hljs-literal">false</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> orig = Dgram.Socket.prototype.send;
            Dgram.Socket.prototype.send = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">buf, offset, length, port, address, callback</span>) </span>{

                Dgram.Socket.prototype.send = orig;
                <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, <span class="hljs-number">40</span>);
            };

            Sntp.time(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                expect(err).to.exist;
                expect(time).to.not.exist;
                expect(err.message).to.equal(<span class="hljs-string">'Could not send entire message'</span>);
                done();
            });
        });

        it(<span class="hljs-string">'times out on invalid host'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            Sntp.time({ <span class="hljs-attr">host</span>: <span class="hljs-string">'error'</span>, <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                expect(err).to.exist;
                expect(time).to.not.exist;
                expect(err.message).to.contain(<span class="hljs-string">'getaddrinfo'</span>);
                done();
            });
        });

        it(<span class="hljs-string">'fails on bad response buffer size'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> server = Dgram.createSocket(<span class="hljs-string">'udp4'</span>);
            server.on(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">message, remote</span>) </span>{
                <span class="hljs-keyword">var</span> message = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">10</span>);
                server.send(message, <span class="hljs-number">0</span>, message.length, remote.port, remote.address, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, bytes</span>) </span>{

                    server.close();
                });
            });

            server.bind(<span class="hljs-number">49123</span>);

            Sntp.time({ <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>, <span class="hljs-attr">port</span>: <span class="hljs-number">49123</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                expect(err).to.exist;
                expect(err.message).to.equal(<span class="hljs-string">'Invalid server response'</span>);
                done();
            });
        });

        <span class="hljs-keyword">var</span> messup = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">bytes</span>) </span>{

            <span class="hljs-keyword">var</span> server = Dgram.createSocket(<span class="hljs-string">'udp4'</span>);
            server.on(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">message, remote</span>) </span>{

                <span class="hljs-keyword">var</span> message = <span class="hljs-keyword">new</span> Buffer([
                    <span class="hljs-number">0x24</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xe3</span>,
                    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
                    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
                    <span class="hljs-number">0x41</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x53</span>,
                    <span class="hljs-number">0xd4</span>, <span class="hljs-number">0xa8</span>, <span class="hljs-number">0x2d</span>, <span class="hljs-number">0xc7</span>,
                    <span class="hljs-number">0x1c</span>, <span class="hljs-number">0x5d</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x1b</span>,
                    <span class="hljs-number">0xd4</span>, <span class="hljs-number">0xa8</span>, <span class="hljs-number">0x2d</span>, <span class="hljs-number">0xe6</span>,
                    <span class="hljs-number">0x67</span>, <span class="hljs-number">0xef</span>, <span class="hljs-number">0x9d</span>, <span class="hljs-number">0xb2</span>,
                    <span class="hljs-number">0xd4</span>, <span class="hljs-number">0xa8</span>, <span class="hljs-number">0x2d</span>, <span class="hljs-number">0xe6</span>,
                    <span class="hljs-number">0x71</span>, <span class="hljs-number">0xed</span>, <span class="hljs-number">0xb5</span>, <span class="hljs-number">0xfb</span>,
                    <span class="hljs-number">0xd4</span>, <span class="hljs-number">0xa8</span>, <span class="hljs-number">0x2d</span>, <span class="hljs-number">0xe6</span>,
                    <span class="hljs-number">0x71</span>, <span class="hljs-number">0xee</span>, <span class="hljs-number">0x6c</span>, <span class="hljs-number">0xc5</span>
                ]);

                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, il = bytes.length; i &lt; il; ++i) {
                    message[bytes[i][<span class="hljs-number">0</span>]] = bytes[i][<span class="hljs-number">1</span>];
                }

                server.send(message, <span class="hljs-number">0</span>, message.length, remote.port, remote.address, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, bytes</span>) </span>{

                    server.close();
                });
            });

            server.bind(<span class="hljs-number">49123</span>);
        };

        it(<span class="hljs-string">'fails on bad version'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            messup([[<span class="hljs-number">0</span>, (<span class="hljs-number">0</span> &lt;&lt; <span class="hljs-number">6</span>) + (<span class="hljs-number">3</span> &lt;&lt; <span class="hljs-number">3</span>) + (<span class="hljs-number">4</span> &lt;&lt; <span class="hljs-number">0</span>)]]);

            Sntp.time({ <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>, <span class="hljs-attr">port</span>: <span class="hljs-number">49123</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                expect(err).to.exist;
                expect(time.version).to.equal(<span class="hljs-number">3</span>);
                expect(err.message).to.equal(<span class="hljs-string">'Invalid server response'</span>);
                done();
            });
        });

        it(<span class="hljs-string">'fails on bad originateTimestamp'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            messup([[<span class="hljs-number">24</span>, <span class="hljs-number">0x83</span>], [<span class="hljs-number">25</span>, <span class="hljs-number">0xaa</span>], [<span class="hljs-number">26</span>, <span class="hljs-number">0x7e</span>], [<span class="hljs-number">27</span>, <span class="hljs-number">0x80</span>], [<span class="hljs-number">28</span>, <span class="hljs-number">0</span>], [<span class="hljs-number">29</span>, <span class="hljs-number">0</span>], [<span class="hljs-number">30</span>, <span class="hljs-number">0</span>], [<span class="hljs-number">31</span>, <span class="hljs-number">0</span>]]);

            Sntp.time({ <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>, <span class="hljs-attr">port</span>: <span class="hljs-number">49123</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                expect(err).to.exist;
                expect(err.message).to.equal(<span class="hljs-string">'Invalid server response'</span>);
                done();
            });
        });

        it(<span class="hljs-string">'fails on bad receiveTimestamp'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            messup([[<span class="hljs-number">32</span>, <span class="hljs-number">0x83</span>], [<span class="hljs-number">33</span>, <span class="hljs-number">0xaa</span>], [<span class="hljs-number">34</span>, <span class="hljs-number">0x7e</span>], [<span class="hljs-number">35</span>, <span class="hljs-number">0x80</span>], [<span class="hljs-number">36</span>, <span class="hljs-number">0</span>], [<span class="hljs-number">37</span>, <span class="hljs-number">0</span>], [<span class="hljs-number">38</span>, <span class="hljs-number">0</span>], [<span class="hljs-number">39</span>, <span class="hljs-number">0</span>]]);

            Sntp.time({ <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>, <span class="hljs-attr">port</span>: <span class="hljs-number">49123</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                expect(err).to.exist;
                expect(err.message).to.equal(<span class="hljs-string">'Invalid server response'</span>);
                done();
            });
        });

        it(<span class="hljs-string">'fails on bad originate timestamp and alarm li'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            messup([[<span class="hljs-number">0</span>, (<span class="hljs-number">3</span> &lt;&lt; <span class="hljs-number">6</span>) + (<span class="hljs-number">4</span> &lt;&lt; <span class="hljs-number">3</span>) + (<span class="hljs-number">4</span> &lt;&lt; <span class="hljs-number">0</span>)]]);

            Sntp.time({ <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>, <span class="hljs-attr">port</span>: <span class="hljs-number">49123</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                expect(err).to.exist;
                expect(err.message).to.equal(<span class="hljs-string">'Wrong originate timestamp'</span>);
                expect(time.leapIndicator).to.equal(<span class="hljs-string">'alarm'</span>);
                done();
            });
        });

        it(<span class="hljs-string">'returns time with death stratum and last61 li'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            messup([[<span class="hljs-number">0</span>, (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">6</span>) + (<span class="hljs-number">4</span> &lt;&lt; <span class="hljs-number">3</span>) + (<span class="hljs-number">4</span> &lt;&lt; <span class="hljs-number">0</span>)], [<span class="hljs-number">1</span>, <span class="hljs-number">0</span>]]);

            Sntp.time({ <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>, <span class="hljs-attr">port</span>: <span class="hljs-number">49123</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                expect(time.stratum).to.equal(<span class="hljs-string">'death'</span>);
                expect(time.leapIndicator).to.equal(<span class="hljs-string">'last-minute-61'</span>);
                done();
            });
        });

        it(<span class="hljs-string">'returns time with reserved stratum and last59 li'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            messup([[<span class="hljs-number">0</span>, (<span class="hljs-number">2</span> &lt;&lt; <span class="hljs-number">6</span>) + (<span class="hljs-number">4</span> &lt;&lt; <span class="hljs-number">3</span>) + (<span class="hljs-number">4</span> &lt;&lt; <span class="hljs-number">0</span>)], [<span class="hljs-number">1</span>, <span class="hljs-number">0x1f</span>]]);

            Sntp.time({ <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>, <span class="hljs-attr">port</span>: <span class="hljs-number">49123</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                expect(time.stratum).to.equal(<span class="hljs-string">'reserved'</span>);
                expect(time.leapIndicator).to.equal(<span class="hljs-string">'last-minute-59'</span>);
                done();
            });
        });

        it(<span class="hljs-string">'fails on bad mode (symmetric-active)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            messup([[<span class="hljs-number">0</span>, (<span class="hljs-number">0</span> &lt;&lt; <span class="hljs-number">6</span>) + (<span class="hljs-number">4</span> &lt;&lt; <span class="hljs-number">3</span>) + (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">0</span>)]]);

            Sntp.time({ <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>, <span class="hljs-attr">port</span>: <span class="hljs-number">49123</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                expect(err).to.exist;
                expect(time.mode).to.equal(<span class="hljs-string">'symmetric-active'</span>);
                done();
            });
        });

        it(<span class="hljs-string">'fails on bad mode (symmetric-passive)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            messup([[<span class="hljs-number">0</span>, (<span class="hljs-number">0</span> &lt;&lt; <span class="hljs-number">6</span>) + (<span class="hljs-number">4</span> &lt;&lt; <span class="hljs-number">3</span>) + (<span class="hljs-number">2</span> &lt;&lt; <span class="hljs-number">0</span>)]]);

            Sntp.time({ <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>, <span class="hljs-attr">port</span>: <span class="hljs-number">49123</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                expect(err).to.exist;
                expect(time.mode).to.equal(<span class="hljs-string">'symmetric-passive'</span>);
                done();
            });
        });

        it(<span class="hljs-string">'fails on bad mode (client)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            messup([[<span class="hljs-number">0</span>, (<span class="hljs-number">0</span> &lt;&lt; <span class="hljs-number">6</span>) + (<span class="hljs-number">4</span> &lt;&lt; <span class="hljs-number">3</span>) + (<span class="hljs-number">3</span> &lt;&lt; <span class="hljs-number">0</span>)]]);

            Sntp.time({ <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>, <span class="hljs-attr">port</span>: <span class="hljs-number">49123</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                expect(err).to.exist;
                expect(time.mode).to.equal(<span class="hljs-string">'client'</span>);
                done();
            });
        });

        it(<span class="hljs-string">'fails on bad mode (broadcast)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            messup([[<span class="hljs-number">0</span>, (<span class="hljs-number">0</span> &lt;&lt; <span class="hljs-number">6</span>) + (<span class="hljs-number">4</span> &lt;&lt; <span class="hljs-number">3</span>) + (<span class="hljs-number">5</span> &lt;&lt; <span class="hljs-number">0</span>)]]);

            Sntp.time({ <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>, <span class="hljs-attr">port</span>: <span class="hljs-number">49123</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                expect(err).to.exist;
                expect(time.mode).to.equal(<span class="hljs-string">'broadcast'</span>);
                done();
            });
        });

        it(<span class="hljs-string">'fails on bad mode (reserved)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            messup([[<span class="hljs-number">0</span>, (<span class="hljs-number">0</span> &lt;&lt; <span class="hljs-number">6</span>) + (<span class="hljs-number">4</span> &lt;&lt; <span class="hljs-number">3</span>) + (<span class="hljs-number">6</span> &lt;&lt; <span class="hljs-number">0</span>)]]);

            Sntp.time({ <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>, <span class="hljs-attr">port</span>: <span class="hljs-number">49123</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, time</span>) </span>{

                expect(err).to.exist;
                expect(time.mode).to.equal(<span class="hljs-string">'reserved'</span>);
                done();
            });
        });
    });

    describe(<span class="hljs-string">'#offset'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        it(<span class="hljs-string">'gets the current offset'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            Sntp.offset(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, offset</span>) </span>{

                expect(err).to.not.exist;
                expect(offset).to.not.equal(<span class="hljs-number">0</span>);
                done();
            });
        });

        it(<span class="hljs-string">'gets the current offset from cache'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            Sntp.offset(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, offset</span>) </span>{

                expect(err).to.not.exist;
                expect(offset).to.not.equal(<span class="hljs-number">0</span>);
                <span class="hljs-keyword">var</span> offset1 = offset;
                Sntp.offset({}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, offset</span>) </span>{

                    expect(err).to.not.exist;
                    expect(offset).to.equal(offset1);
                    done();
                });
            });
        });

        it(<span class="hljs-string">'gets the new offset on different server'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            Sntp.offset(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, offset</span>) </span>{

                expect(err).to.not.exist;
                expect(offset).to.not.equal(<span class="hljs-number">0</span>);
                <span class="hljs-keyword">var</span> offset1 = offset;
                Sntp.offset({ <span class="hljs-attr">host</span>: <span class="hljs-string">'nist1-sj.ustiming.org'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, offset</span>) </span>{

                    expect(err).to.not.exist;
                    expect(offset).to.not.equal(offset1);
                    done();
                });
            });
        });

        it(<span class="hljs-string">'gets the new offset on different server'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            Sntp.offset(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, offset</span>) </span>{

                expect(err).to.not.exist;
                expect(offset).to.not.equal(<span class="hljs-number">0</span>);
                <span class="hljs-keyword">var</span> offset1 = offset;
                Sntp.offset({ <span class="hljs-attr">port</span>: <span class="hljs-number">123</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, offset</span>) </span>{

                    expect(err).to.not.exist;
                    expect(offset).to.not.equal(offset1);
                    done();
                });
            });
        });

        it(<span class="hljs-string">'fails getting the current offset on invalid server'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            Sntp.offset({ <span class="hljs-attr">host</span>: <span class="hljs-string">'error'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, offset</span>) </span>{

                expect(err).to.exist;
                expect(offset).to.equal(<span class="hljs-number">0</span>);
                done();
            });
        });
    });

    describe(<span class="hljs-string">'#now'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        it(<span class="hljs-string">'starts auto-sync, gets now, then stops'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            Sntp.stop();

            <span class="hljs-keyword">var</span> before = Sntp.now();
            expect(before).to.equal(<span class="hljs-built_in">Date</span>.now());

            Sntp.start(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

                <span class="hljs-keyword">var</span> now = Sntp.now();
                expect(now).to.not.equal(<span class="hljs-built_in">Date</span>.now());
                Sntp.stop();

                done();
            });
        });

        it(<span class="hljs-string">'starts twice'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            Sntp.start(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

                Sntp.start(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

                    <span class="hljs-keyword">var</span> now = Sntp.now();
                    expect(now).to.not.equal(<span class="hljs-built_in">Date</span>.now());
                    Sntp.stop();

                    done();
                });
            });
        });

        it(<span class="hljs-string">'starts auto-sync, gets now, waits, gets again after timeout'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            Sntp.stop();

            <span class="hljs-keyword">var</span> before = Sntp.now();
            expect(before).to.equal(<span class="hljs-built_in">Date</span>.now());

            Sntp.start({ <span class="hljs-attr">clockSyncRefresh</span>: <span class="hljs-number">100</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

                <span class="hljs-keyword">var</span> now = Sntp.now();
                expect(now).to.not.equal(<span class="hljs-built_in">Date</span>.now());
                expect(now).to.equal(Sntp.now());

                setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

                    expect(Sntp.now()).to.not.equal(now);
                    Sntp.stop();
                    done();
                }, <span class="hljs-number">110</span>);
            });
        });
    });
});


</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

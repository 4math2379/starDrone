<!DOCTYPE html>
<html>
<head>
  <title>eddsa.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/jodid25519/lib/eddsa.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>eddsa.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<div class="dox">
<div class="summary">
<p>Copyright (c) 2011, 2012, 2014 Ron Garret
Copyright (c) 2014 Mega Limited
under the MIT License.</p>
</div>
<div class="body">
<p>Authors: Guy K. Kloss, Ron Garret</p>
<p>You should have received a copy of the license along with this program.</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> core = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./core'</span>);
<span class="hljs-keyword">var</span> curve255 = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./curve255'</span>);
<span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./utils'</span>);
<span class="hljs-keyword">var</span> BigInteger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jsbn'</span>).BigInteger;
<span class="hljs-keyword">var</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<div class="dox">
<div class="summary">
<p>Digital signature scheme based on Curve25519 (Ed25519 or EdDSA).</p>
</div>
<div class="body">
<p>
This code is adapted from fast-djbec.js, a faster but more complicated
version of the Ed25519 encryption scheme (as compared to djbec.js).
It uses two different representations for big integers: The jsbn
BigInteger class, which can represent arbitrary-length numbers, and a
special fixed-length representation optimised for 256-bit integers.
The reason both are needed is that the Ed25519 algorithm requires some
512-bit numbers.</p>
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> ns = {};

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_bi255</span>(<span class="hljs-params">value</span>) </span>{
        <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> _bi255)) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> _bi255(value);
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'undefined'</span>) {
            <span class="hljs-keyword">return</span> _ZERO;
        }
        <span class="hljs-keyword">var</span> c = value.constructor;
        <span class="hljs-keyword">if</span> ((c === <span class="hljs-built_in">Array</span> || c === <span class="hljs-built_in">Uint16Array</span> || c === <span class="hljs-built_in">Uint32Array</span>) &amp;&amp; (value.length === <span class="hljs-number">16</span>)) {
            <span class="hljs-keyword">this</span>.n = value;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((c === <span class="hljs-built_in">Array</span>) &amp;&amp; (value.length === <span class="hljs-number">32</span>)) {
            <span class="hljs-keyword">this</span>.n = _bytes2bi255(value).n;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c === <span class="hljs-built_in">String</span>) {
            <span class="hljs-keyword">this</span>.n = utils.hexDecode(value);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c === <span class="hljs-built_in">Number</span>) {
            <span class="hljs-keyword">this</span>.n = [value &amp; <span class="hljs-number">0xffff</span>,
                      value &gt;&gt; <span class="hljs-number">16</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>];
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> _bi255) {
            <span class="hljs-keyword">this</span>.n = value.n.slice(<span class="hljs-number">0</span>); <span class="hljs-comment">// Copy constructor</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-string">"Bad argument for bignum: "</span> + value;
        }
    }

   _bi255.prototype = {
        <span class="hljs-string">'toString'</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> utils.hexEncode(<span class="hljs-keyword">this</span>.n);
        },
        <span class="hljs-string">'toSource'</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-string">'_'</span> + utils.hexEncode(<span class="hljs-keyword">this</span>.n);
        },
        <span class="hljs-string">'plus'</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">n1</span>) </span>{
            <span class="hljs-keyword">return</span> _bi255(core.bigintadd(<span class="hljs-keyword">this</span>.n, n1.n));
        },
        <span class="hljs-string">'minus'</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">n1</span>) </span>{
            <span class="hljs-keyword">return</span> _bi255(core.bigintsub(<span class="hljs-keyword">this</span>.n, n1.n)).modq();
        },
        <span class="hljs-string">'times'</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">n1</span>) </span>{
            <span class="hljs-keyword">return</span> _bi255(core.mulmodp(<span class="hljs-keyword">this</span>.n, n1.n));
        },
        <span class="hljs-string">'divide'</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">n1</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.times(n1.inv());
        },
        <span class="hljs-string">'sqr'</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> _bi255(core.sqrmodp(<span class="hljs-keyword">this</span>.n));
        },
        <span class="hljs-string">'cmp'</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">n1</span>) </span>{
            <span class="hljs-keyword">return</span> core.bigintcmp(<span class="hljs-keyword">this</span>.n, n1.n);
        },
        <span class="hljs-string">'equals'</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">n1</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cmp(n1) === <span class="hljs-number">0</span>;
        },
        <span class="hljs-string">'isOdd'</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> (<span class="hljs-keyword">this</span>.n[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">1</span>) === <span class="hljs-number">1</span>;
        },
        <span class="hljs-string">'shiftLeft'</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cnt</span>) </span>{
            _shiftL(<span class="hljs-keyword">this</span>.n, cnt);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        },
        <span class="hljs-string">'shiftRight'</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cnt</span>) </span>{
            _shiftR(<span class="hljs-keyword">this</span>.n, cnt);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        },
        <span class="hljs-string">'inv'</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> _bi255(core.invmodp(<span class="hljs-keyword">this</span>.n));
        },
        <span class="hljs-string">'pow'</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
            <span class="hljs-keyword">return</span> _bi255(_pow(<span class="hljs-keyword">this</span>.n, e.n));
        },
        <span class="hljs-string">'modq'</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> _modq(<span class="hljs-keyword">this</span>);
        },
        <span class="hljs-string">'bytes'</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> _bi255_bytes(<span class="hljs-keyword">this</span>);
        }
    };

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_shiftL</span>(<span class="hljs-params">n, cnt</span>) </span>{
        <span class="hljs-keyword">var</span> lastcarry = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++) {
            <span class="hljs-keyword">var</span> carry = n[i] &gt;&gt; (<span class="hljs-number">16</span> - cnt);
            n[i] = (n[i] &lt;&lt; cnt) &amp; <span class="hljs-number">0xffff</span> | lastcarry;
            lastcarry = carry;
        }
        <span class="hljs-keyword">return</span> n;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_shiftR</span>(<span class="hljs-params">n, cnt</span>) </span>{
        <span class="hljs-keyword">var</span> lastcarry = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">15</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
            <span class="hljs-keyword">var</span> carry = n[i] &lt;&lt; (<span class="hljs-number">16</span> - cnt) &amp; <span class="hljs-number">0xffff</span>;
            n[i] = (n[i] &gt;&gt; cnt) | lastcarry;
            lastcarry = carry;
        }
        <span class="hljs-keyword">return</span> n;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_bi255_bytes</span>(<span class="hljs-params">n</span>) </span>{
        n = _bi255(n); <span class="hljs-comment">// Make a copy because shiftRight is destructive</span>
        <span class="hljs-keyword">var</span> a = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-number">32</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">31</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
            a[i] = n.n[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xff</span>;
            n.shiftRight(<span class="hljs-number">8</span>);
        }
        <span class="hljs-keyword">return</span> a;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_bytes2bi255</span>(<span class="hljs-params">a</span>) </span>{
        <span class="hljs-keyword">var</span> n = _ZERO;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">32</span>; i++) {
            n.shiftLeft(<span class="hljs-number">8</span>);
            n = n.plus(_bi255(a[i]));
        }
        <span class="hljs-keyword">return</span> n;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_pow</span>(<span class="hljs-params">n, e</span>) </span>{
        <span class="hljs-keyword">var</span> result = core.ONE();
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">256</span>; i++) {
            <span class="hljs-keyword">if</span> (core.getbit(e, i) === <span class="hljs-number">1</span>) {
                result = core.mulmodp(result, n);
            }
            n = core.sqrmodp(n);
        }
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-keyword">var</span> _ZERO = _bi255(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">var</span> _ONE = _bi255(<span class="hljs-number">1</span>);
    <span class="hljs-keyword">var</span> _TWO = _bi255(<span class="hljs-number">2</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>This is the core prime.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> _Q = _bi255([<span class="hljs-number">0xffff</span> - <span class="hljs-number">18</span>, <span class="hljs-number">0xffff</span>, <span class="hljs-number">0xffff</span>, <span class="hljs-number">0xffff</span>, <span class="hljs-number">0xffff</span>, <span class="hljs-number">0xffff</span>,
                     <span class="hljs-number">0xffff</span>, <span class="hljs-number">0xffff</span>, <span class="hljs-number">0xffff</span>, <span class="hljs-number">0xffff</span>, <span class="hljs-number">0xffff</span>, <span class="hljs-number">0xffff</span>, <span class="hljs-number">0xffff</span>,
                     <span class="hljs-number">0xffff</span>, <span class="hljs-number">0xffff</span>, <span class="hljs-number">0x7fff</span>]);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_modq</span>(<span class="hljs-params">n</span>) </span>{
        core.reduce(n.n);
        <span class="hljs-keyword">if</span> (n.cmp(_Q) &gt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> _modq(n.minus(_Q));
        }
        <span class="hljs-keyword">if</span> (n.cmp(_ZERO) === <span class="hljs-number">-1</span>) {
            <span class="hljs-keyword">return</span> _modq(n.plus(_Q));
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> n;
        }
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>_RECOVERY_EXPONENT = _Q.plus(_bi255(3)).divide(_bi255(8));</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> _RECOVERY_EXPONENT = _bi255(<span class="hljs-string">'0ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe'</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>_D = _Q.minus(_bi255(121665)).divide(_bi255(121666));</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> _D = _bi255(<span class="hljs-string">'52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3'</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>_I = _TWO.pow(_Q.minus(_ONE).divide(_bi255(4)));</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> _I = _bi255(<span class="hljs-string">'2b8324804fc1df0b2b4d00993dfbd7a72f431806ad2fe478c4ee1b274a0ea0b0'</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>_L = _TWO.pow(_bi255(252)).plus(_bi255('14def9dea2f79cd65812631a5cf5d3ed'));</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> _L = _bi255(<span class="hljs-string">'1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed'</span>);
    <span class="hljs-keyword">var</span> _L_BI = _bi(<span class="hljs-string">'1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed'</span>, <span class="hljs-number">16</span>);


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>////////////////////////////////////////////////////////////</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_isoncurve</span>(<span class="hljs-params">p</span>) </span>{
        <span class="hljs-keyword">var</span> x = p[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">var</span> y = p[<span class="hljs-number">1</span>];
        <span class="hljs-keyword">var</span> xsqr = x.sqr();
        <span class="hljs-keyword">var</span> ysqr = y.sqr();
        <span class="hljs-keyword">var</span> v = _D.times(xsqr).times(ysqr);
        <span class="hljs-keyword">return</span> ysqr.minus(xsqr).minus(_ONE).minus(v).modq().equals(_ZERO);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_xrecover</span>(<span class="hljs-params">y</span>) </span>{
        <span class="hljs-keyword">var</span> ysquared = y.sqr();
        <span class="hljs-keyword">var</span> xx = ysquared.minus(_ONE).divide(_ONE.plus(_D.times(ysquared)));
        <span class="hljs-keyword">var</span> x = xx.pow(_RECOVERY_EXPONENT);
        <span class="hljs-keyword">if</span> (!(x.times(x).minus(xx).equals(_ZERO))) {
            x = x.times(_I);
        }
        <span class="hljs-keyword">if</span> (x.isOdd()) {
            x = _Q.minus(x);
        }
        <span class="hljs-keyword">return</span> x;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_x_pt_add</span>(<span class="hljs-params">pt1, pt2</span>) </span>{
        <span class="hljs-keyword">var</span> x1 = pt1[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">var</span> y1 = pt1[<span class="hljs-number">1</span>];
        <span class="hljs-keyword">var</span> z1 = pt1[<span class="hljs-number">2</span>];
        <span class="hljs-keyword">var</span> t1 = pt1[<span class="hljs-number">3</span>];
        <span class="hljs-keyword">var</span> x2 = pt2[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">var</span> y2 = pt2[<span class="hljs-number">1</span>];
        <span class="hljs-keyword">var</span> z2 = pt2[<span class="hljs-number">2</span>];
        <span class="hljs-keyword">var</span> t2 = pt2[<span class="hljs-number">3</span>];
        <span class="hljs-keyword">var</span> A = y1.minus(x1).times(y2.plus(x2));
        <span class="hljs-keyword">var</span> B = y1.plus(x1).times(y2.minus(x2));
        <span class="hljs-keyword">var</span> C = z1.times(_TWO).times(t2);
        <span class="hljs-keyword">var</span> D = t1.times(_TWO).times(z2);
        <span class="hljs-keyword">var</span> E = D.plus(C);
        <span class="hljs-keyword">var</span> F = B.minus(A);
        <span class="hljs-keyword">var</span> G = B.plus(A);
        <span class="hljs-keyword">var</span> H = D.minus(C);
        <span class="hljs-keyword">return</span> [E.times(F), G.times(H), F.times(G), E.times(H)];
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_xpt_double</span>(<span class="hljs-params">pt1</span>) </span>{
        <span class="hljs-keyword">var</span> x1 = pt1[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">var</span> y1 = pt1[<span class="hljs-number">1</span>];
        <span class="hljs-keyword">var</span> z1 = pt1[<span class="hljs-number">2</span>];
        <span class="hljs-keyword">var</span> A = x1.times(x1);
        <span class="hljs-keyword">var</span> B = y1.times(y1);
        <span class="hljs-keyword">var</span> C = _TWO.times(z1).times(z1);
        <span class="hljs-keyword">var</span> D = _Q.minus(A);
        <span class="hljs-keyword">var</span> J = x1.plus(y1);
        <span class="hljs-keyword">var</span> E = J.times(J).minus(A).minus(B);
        <span class="hljs-keyword">var</span> G = D.plus(B);
        <span class="hljs-keyword">var</span> F = G.minus(C);
        <span class="hljs-keyword">var</span> H = D.minus(B);
        <span class="hljs-keyword">return</span> [E.times(F), G.times(H), F.times(G), E.times(H)];
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_xpt_mult</span>(<span class="hljs-params">pt, n</span>) </span>{
        <span class="hljs-keyword">if</span> (n.equals(_ZERO)) {
            <span class="hljs-keyword">return</span> [_ZERO, _ONE, _ONE, _ZERO];
        }
        <span class="hljs-keyword">var</span> odd = n.isOdd();
        n.shiftRight(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">var</span> value = _xpt_double(_xpt_mult(pt, n));
        <span class="hljs-keyword">return</span> odd ? _x_pt_add(value, pt) : value;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_pt_xform</span>(<span class="hljs-params">pt</span>) </span>{
        <span class="hljs-keyword">var</span> x = pt[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">var</span> y = pt[<span class="hljs-number">1</span>];
        <span class="hljs-keyword">return</span> [x, y, _ONE, x.times(y)];
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_pt_unxform</span>(<span class="hljs-params">pt</span>) </span>{
        <span class="hljs-keyword">var</span> x = pt[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">var</span> y = pt[<span class="hljs-number">1</span>];
        <span class="hljs-keyword">var</span> z = pt[<span class="hljs-number">2</span>];
        <span class="hljs-keyword">var</span> invz = z.inv();
        <span class="hljs-keyword">return</span> [x.times(invz), y.times(invz)];
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_scalarmult</span>(<span class="hljs-params">pt, n</span>) </span>{
        <span class="hljs-keyword">return</span> _pt_unxform(_xpt_mult(_pt_xform(pt), n));
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_bytesgetbit</span>(<span class="hljs-params">bytes, n</span>) </span>{
        <span class="hljs-keyword">return</span> (bytes[bytes.length - (n &gt;&gt;&gt; <span class="hljs-number">3</span>) - <span class="hljs-number">1</span>] &gt;&gt; (n &amp; <span class="hljs-number">7</span>)) &amp; <span class="hljs-number">1</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_xpt_mult_bytes</span>(<span class="hljs-params">pt, bytes</span>) </span>{
        <span class="hljs-keyword">var</span> r = [_ZERO, _ONE, _ONE, _ZERO];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = (bytes.length &lt;&lt; <span class="hljs-number">3</span>) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
            r = _xpt_double(r);
            <span class="hljs-keyword">if</span> (_bytesgetbit(bytes, i) === <span class="hljs-number">1</span>) {
                r = _x_pt_add(r, pt);
            }
        }
        <span class="hljs-keyword">return</span> r;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_scalarmultBytes</span>(<span class="hljs-params">pt, bytes</span>) </span>{
        <span class="hljs-keyword">return</span> _pt_unxform(_xpt_mult_bytes(_pt_xform(pt), bytes));
    }

    <span class="hljs-keyword">var</span> _by = _bi255(<span class="hljs-number">4</span>).divide(_bi255(<span class="hljs-number">5</span>));
    <span class="hljs-keyword">var</span> _bx = _xrecover(_by);
    <span class="hljs-keyword">var</span> _bp = [_bx, _by];

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_encodeint</span>(<span class="hljs-params">n</span>) </span>{
        <span class="hljs-keyword">return</span> n.bytes(<span class="hljs-number">32</span>).reverse();
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_decodeint</span>(<span class="hljs-params">b</span>) </span>{
        <span class="hljs-keyword">return</span> _bi255(b.slice(<span class="hljs-number">0</span>).reverse());
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_encodepoint</span>(<span class="hljs-params">p</span>) </span>{
        <span class="hljs-keyword">var</span> v = _encodeint(p[<span class="hljs-number">1</span>]);
        <span class="hljs-keyword">if</span> (p[<span class="hljs-number">0</span>].isOdd()) {
            v[<span class="hljs-number">31</span>] |= <span class="hljs-number">0x80</span>;
        }
        <span class="hljs-keyword">return</span> v;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_decodepoint</span>(<span class="hljs-params">v</span>) </span>{
        v = v.slice(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">var</span> signbit = v[<span class="hljs-number">31</span>] &gt;&gt; <span class="hljs-number">7</span>;
        v[<span class="hljs-number">31</span>] &amp;= <span class="hljs-number">127</span>;
        <span class="hljs-keyword">var</span> y = _decodeint(v);
        <span class="hljs-keyword">var</span> x = _xrecover(y);
        <span class="hljs-keyword">if</span> ((x.n[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">1</span>) !== signbit) {
            x = _Q.minus(x);
        }
        <span class="hljs-keyword">var</span> p = [x, y];
        <span class="hljs-keyword">if</span> (!_isoncurve(p)) {
            <span class="hljs-keyword">throw</span> (<span class="hljs-string">'Point is not on curve'</span>);
        }
        <span class="hljs-keyword">return</span> p;
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>//////////////////////////////////////////////////</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<div class="dox">
<div class="summary">
<p>Factory function to create a suitable BigInteger.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">value</span>
<span>The value for the big integer.
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">base</span>
<span>{integer}     Base of the conversion of elements in <code>value</code>.
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_bi</span>(<span class="hljs-params">value, base</span>) </span>{
        <span class="hljs-keyword">if</span> (base !== <span class="hljs-literal">undefined</span>) {
            <span class="hljs-keyword">if</span> (base === <span class="hljs-number">256</span>) {
                <span class="hljs-keyword">return</span> _bi(utils.string2bytes(value));
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BigInteger(value, base);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'string'</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BigInteger(value, <span class="hljs-number">10</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) || (value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Uint8Array</span>)
          || Buffer.isBuffer(value)) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BigInteger(value);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'number'</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BigInteger(value.toString(), <span class="hljs-number">10</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-string">"Can't convert "</span> + value + <span class="hljs-string">" to BigInteger"</span>;
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_bi2bytes</span>(<span class="hljs-params">n, cnt</span>) </span>{
        <span class="hljs-keyword">if</span> (cnt === <span class="hljs-literal">undefined</span>) {
            cnt = (n.bitLength() + <span class="hljs-number">7</span>) &gt;&gt;&gt; <span class="hljs-number">3</span>;
        }
        <span class="hljs-keyword">var</span> bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(cnt);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = cnt - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
            bytes[i] = n[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">255</span>; <span class="hljs-comment">// n.and(0xff);</span>
            n = n.shiftRight(<span class="hljs-number">8</span>);
        }
        <span class="hljs-keyword">return</span> bytes;
    }

    BigInteger.prototype.bytes = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">n</span>) </span>{
        <span class="hljs-keyword">return</span> _bi2bytes(<span class="hljs-keyword">this</span>, n);
    };

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>/////////////////////////////////////////////////////////</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_bytehash</span>(<span class="hljs-params">s</span>) </span>{
        <span class="hljs-keyword">var</span> sha = crypto.createHash(<span class="hljs-string">'sha512'</span>).update(s).digest();
        <span class="hljs-keyword">return</span> _bi2bytes(_bi(sha), <span class="hljs-number">64</span>).reverse();
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_stringhash</span>(<span class="hljs-params">s</span>) </span>{
        <span class="hljs-keyword">var</span> sha = crypto.createHash(<span class="hljs-string">'sha512'</span>).update(s).digest();
        <span class="hljs-keyword">return</span> _map(_chr, _bi2bytes(_bi(sha), <span class="hljs-number">64</span>)).join(<span class="hljs-string">''</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_inthash</span>(<span class="hljs-params">s</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>Need a leading 0 to prevent sign extension</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">return</span> _bi([<span class="hljs-number">0</span>].concat(_bytehash(s)));
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_inthash_lo</span>(<span class="hljs-params">s</span>) </span>{
        <span class="hljs-keyword">return</span> _bi255(_bytehash(s).slice(<span class="hljs-number">32</span>, <span class="hljs-number">64</span>));
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_inthash_mod_l</span>(<span class="hljs-params">s</span>) </span>{
        <span class="hljs-keyword">return</span> _inthash(s).mod(_L_BI);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_get_a</span>(<span class="hljs-params">sk</span>) </span>{
        <span class="hljs-keyword">var</span> a = _inthash_lo(sk);
        a.n[<span class="hljs-number">0</span>] &amp;= <span class="hljs-number">0xfff8</span>;
        a.n[<span class="hljs-number">15</span>] &amp;= <span class="hljs-number">0x3fff</span>;
        a.n[<span class="hljs-number">15</span>] |= <span class="hljs-number">0x4000</span>;
        <span class="hljs-keyword">return</span> a;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_publickey</span>(<span class="hljs-params">sk</span>) </span>{
        <span class="hljs-keyword">return</span> _encodepoint(_scalarmult(_bp, _get_a(sk)));
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_map</span>(<span class="hljs-params">f, l</span>) </span>{
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(l.length);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; l.length; i++) {
            result[i] = f(l[i]);
        }
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_chr</span>(<span class="hljs-params">n</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">String</span>.fromCharCode(n);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_ord</span>(<span class="hljs-params">c</span>) </span>{
        <span class="hljs-keyword">return</span> c.charCodeAt(<span class="hljs-number">0</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_pt_add</span>(<span class="hljs-params">p1, p2</span>) </span>{
        <span class="hljs-keyword">return</span> _pt_unxform(_x_pt_add(_pt_xform(p1), _pt_xform(p2)));
    }


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>Exports for the API.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<div class="dox">
<div class="summary">
<p>Checks whether a point is on the curve.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">point</span>
<span>{string}     The point to check for in a byte string representation.
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">    ns.isOnCurve = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">point</span>) </span>{
        <span class="hljs-keyword">try</span> {
            _isoncurve(_decodepoint(utils.string2bytes(point)));
        } <span class="hljs-keyword">catch</span>(e) {
            <span class="hljs-keyword">if</span> (e === <span class="hljs-string">'Point is not on curve'</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">throw</span> e;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    };


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<div class="dox">
<div class="summary">
<p>Computes the EdDSA public key.</p>
</div>
<div class="body">
<p>Note: Seeds should be a byte string, not a unicode string containing
multi-byte characters.</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">keySeed</span>
<span>{string}     Private key seed in the form of a byte string.
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">    ns.publicKey = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">keySeed</span>) </span>{
        <span class="hljs-keyword">return</span> utils.bytes2string(_publickey(keySeed));
    };


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<div class="dox">
<div class="summary">
<p>Computes an EdDSA signature of a message.</p>
</div>
<div class="body">
<p>Notes:</p>
<ul>
  <li>Unicode messages need to be converted to a byte representation
  (e. g. UTF-8).</li>
  <li>If `publicKey` is given, and it is *not* a point of the curve,
  the signature will be faulty, but no error will be thrown.</li>
</ul>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">message</span>
<span>{string}     Message in the form of a byte string.
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">keySeed</span>
<span>{string}     Private key seed in the form of a byte string.
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">publicKey</span>
<span>{string}     Public key as byte string (if not present, it will be computed from
the private key seed).
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">    ns.sign = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message, keySeed, publicKey</span>) </span>{
        <span class="hljs-keyword">if</span> (publicKey === <span class="hljs-literal">undefined</span>) {
            publicKey = _publickey(keySeed);
        } <span class="hljs-keyword">else</span> {
            publicKey = utils.string2bytes(publicKey);
        }
        <span class="hljs-keyword">var</span> a = _bi(_get_a(keySeed).toString(), <span class="hljs-number">16</span>);
        <span class="hljs-keyword">var</span> hs = _stringhash(keySeed);
        <span class="hljs-keyword">var</span> r = _bytehash(hs.slice(<span class="hljs-number">32</span>, <span class="hljs-number">64</span>) + message);
        <span class="hljs-keyword">var</span> rp = _scalarmultBytes(_bp, r);
        <span class="hljs-keyword">var</span> erp = _encodepoint(rp);
        r = _bi(r).mod(_bi(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>).shiftLeft(<span class="hljs-number">512</span>));
        <span class="hljs-keyword">var</span> s = _map(_chr, erp).join(<span class="hljs-string">''</span>) + _map(_chr, publicKey).join(<span class="hljs-string">''</span>) + message;
        s = _inthash_mod_l(s).multiply(a).add(r).mod(_L_BI);
        <span class="hljs-keyword">return</span> utils.bytes2string(erp.concat(_encodeint(s)));
    };


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<div class="dox">
<div class="summary">
<p>Verifies an EdDSA signature of a message with the public key.</p>
</div>
<div class="body">
<p>Note: Unicode messages need to be converted to a byte representation
(e. g. UTF-8).</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">signature</span>
<span>{string}     Message signature in the form of a byte string. Can be detached
(64 bytes), or attached to be sliced off.
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">message</span>
<span>{string}     Message in the form of a byte string.
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">publicKey</span>
<span>{string}     Public key as byte string (if not present, it will be computed from
the private key seed).
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">    ns.verify = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">signature, message, publicKey</span>) </span>{
        signature = utils.string2bytes(signature.slice(<span class="hljs-number">0</span>, <span class="hljs-number">64</span>));
        publicKey = utils.string2bytes(publicKey);
        <span class="hljs-keyword">var</span> rpe = signature.slice(<span class="hljs-number">0</span>, <span class="hljs-number">32</span>);
        <span class="hljs-keyword">var</span> rp = _decodepoint(rpe);
        <span class="hljs-keyword">var</span> a = _decodepoint(publicKey);
        <span class="hljs-keyword">var</span> s = _decodeint(signature.slice(<span class="hljs-number">32</span>, <span class="hljs-number">64</span>));
        <span class="hljs-keyword">var</span> h = _inthash(utils.bytes2string(rpe.concat(publicKey)) + message);
        <span class="hljs-keyword">var</span> v1 = _scalarmult(_bp, s);
        <span class="hljs-keyword">var</span> value = _scalarmultBytes(a, _bi2bytes(h));
        <span class="hljs-keyword">var</span> v2 = _pt_add(rp, value);
        <span class="hljs-keyword">return</span> v1[<span class="hljs-number">0</span>].equals(v2[<span class="hljs-number">0</span>]) &amp;&amp; v1[<span class="hljs-number">1</span>].equals(v2[<span class="hljs-number">1</span>]);
    };


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<div class="dox">
<div class="summary">
<p>Generates a new random private key seed of 32 bytes length (256 bit).</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">    ns.generateKeySeed = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> core.generateKey(<span class="hljs-literal">false</span>);
    };

<span class="hljs-built_in">module</span>.exports = ns;

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

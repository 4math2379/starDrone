<!DOCTYPE html>
<html>
<head>
  <title>ec.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/ecc-jsbn/lib/ec.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>ec.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>Basic Javascript Elliptic Curve implementation
Ported loosely from BouncyCastle's Java EC code
Only Fp curves implemented for now</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Requires jsbn.js and jsbn2.js</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> BigInteger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jsbn'</span>)
<span class="hljs-keyword">var</span> Barrett = BigInteger.prototype.Barrett

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<hr>
<p>ECFieldElementFp</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>constructor</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ECFieldElementFp</span>(<span class="hljs-params">q,x</span>) </span>{
    <span class="hljs-keyword">this</span>.x = x;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>TODO if(x.compareTo(q) &gt;= 0) error</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">this</span>.q = q;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">feFpEquals</span>(<span class="hljs-params">other</span>) </span>{
    <span class="hljs-keyword">if</span>(other == <span class="hljs-keyword">this</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">this</span>.q.equals(other.q) &amp;&amp; <span class="hljs-keyword">this</span>.x.equals(other.x));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">feFpToBigInteger</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.x;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">feFpNegate</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ECFieldElementFp(<span class="hljs-keyword">this</span>.q, <span class="hljs-keyword">this</span>.x.negate().mod(<span class="hljs-keyword">this</span>.q));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">feFpAdd</span>(<span class="hljs-params">b</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ECFieldElementFp(<span class="hljs-keyword">this</span>.q, <span class="hljs-keyword">this</span>.x.add(b.toBigInteger()).mod(<span class="hljs-keyword">this</span>.q));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">feFpSubtract</span>(<span class="hljs-params">b</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ECFieldElementFp(<span class="hljs-keyword">this</span>.q, <span class="hljs-keyword">this</span>.x.subtract(b.toBigInteger()).mod(<span class="hljs-keyword">this</span>.q));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">feFpMultiply</span>(<span class="hljs-params">b</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ECFieldElementFp(<span class="hljs-keyword">this</span>.q, <span class="hljs-keyword">this</span>.x.multiply(b.toBigInteger()).mod(<span class="hljs-keyword">this</span>.q));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">feFpSquare</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ECFieldElementFp(<span class="hljs-keyword">this</span>.q, <span class="hljs-keyword">this</span>.x.square().mod(<span class="hljs-keyword">this</span>.q));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">feFpDivide</span>(<span class="hljs-params">b</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ECFieldElementFp(<span class="hljs-keyword">this</span>.q, <span class="hljs-keyword">this</span>.x.multiply(b.toBigInteger().modInverse(<span class="hljs-keyword">this</span>.q)).mod(<span class="hljs-keyword">this</span>.q));
}

ECFieldElementFp.prototype.equals = feFpEquals;
ECFieldElementFp.prototype.toBigInteger = feFpToBigInteger;
ECFieldElementFp.prototype.negate = feFpNegate;
ECFieldElementFp.prototype.add = feFpAdd;
ECFieldElementFp.prototype.subtract = feFpSubtract;
ECFieldElementFp.prototype.multiply = feFpMultiply;
ECFieldElementFp.prototype.square = feFpSquare;
ECFieldElementFp.prototype.divide = feFpDivide;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<hr>
<p>ECPointFp</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>constructor</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ECPointFp</span>(<span class="hljs-params">curve,x,y,z</span>) </span>{
    <span class="hljs-keyword">this</span>.curve = curve;
    <span class="hljs-keyword">this</span>.x = x;
    <span class="hljs-keyword">this</span>.y = y;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Projective coordinates: either zinv == null or z * zinv == 1
z and zinv are just BigIntegers, not fieldElements</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span>(z == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">this</span>.z = BigInteger.ONE;
    }
    <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.z = z;
    }
    <span class="hljs-keyword">this</span>.zinv = <span class="hljs-literal">null</span>;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>TODO: compression flag</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pointFpGetX</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.zinv == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">this</span>.zinv = <span class="hljs-keyword">this</span>.z.modInverse(<span class="hljs-keyword">this</span>.curve.q);
    }
    <span class="hljs-keyword">var</span> r = <span class="hljs-keyword">this</span>.x.toBigInteger().multiply(<span class="hljs-keyword">this</span>.zinv);
    <span class="hljs-keyword">this</span>.curve.reduce(r);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.curve.fromBigInteger(r);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pointFpGetY</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.zinv == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">this</span>.zinv = <span class="hljs-keyword">this</span>.z.modInverse(<span class="hljs-keyword">this</span>.curve.q);
    }
    <span class="hljs-keyword">var</span> r = <span class="hljs-keyword">this</span>.y.toBigInteger().multiply(<span class="hljs-keyword">this</span>.zinv);
    <span class="hljs-keyword">this</span>.curve.reduce(r);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.curve.fromBigInteger(r);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pointFpEquals</span>(<span class="hljs-params">other</span>) </span>{
    <span class="hljs-keyword">if</span>(other == <span class="hljs-keyword">this</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.isInfinity()) <span class="hljs-keyword">return</span> other.isInfinity();
    <span class="hljs-keyword">if</span>(other.isInfinity()) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.isInfinity();
    <span class="hljs-keyword">var</span> u, v;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>u = Y2 * Z1 - Y1 * Z2</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    u = other.y.toBigInteger().multiply(<span class="hljs-keyword">this</span>.z).subtract(<span class="hljs-keyword">this</span>.y.toBigInteger().multiply(other.z)).mod(<span class="hljs-keyword">this</span>.curve.q);
    <span class="hljs-keyword">if</span>(!u.equals(BigInteger.ZERO)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>v = X2 * Z1 - X1 * Z2</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    v = other.x.toBigInteger().multiply(<span class="hljs-keyword">this</span>.z).subtract(<span class="hljs-keyword">this</span>.x.toBigInteger().multiply(other.z)).mod(<span class="hljs-keyword">this</span>.curve.q);
    <span class="hljs-keyword">return</span> v.equals(BigInteger.ZERO);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pointFpIsInfinity</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span>((<span class="hljs-keyword">this</span>.x == <span class="hljs-literal">null</span>) &amp;&amp; (<span class="hljs-keyword">this</span>.y == <span class="hljs-literal">null</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.z.equals(BigInteger.ZERO) &amp;&amp; !<span class="hljs-keyword">this</span>.y.toBigInteger().equals(BigInteger.ZERO);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pointFpNegate</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ECPointFp(<span class="hljs-keyword">this</span>.curve, <span class="hljs-keyword">this</span>.x, <span class="hljs-keyword">this</span>.y.negate(), <span class="hljs-keyword">this</span>.z);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pointFpAdd</span>(<span class="hljs-params">b</span>) </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.isInfinity()) <span class="hljs-keyword">return</span> b;
    <span class="hljs-keyword">if</span>(b.isInfinity()) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>u = Y2 * Z1 - Y1 * Z2</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> u = b.y.toBigInteger().multiply(<span class="hljs-keyword">this</span>.z).subtract(<span class="hljs-keyword">this</span>.y.toBigInteger().multiply(b.z)).mod(<span class="hljs-keyword">this</span>.curve.q);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>v = X2 * Z1 - X1 * Z2</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> v = b.x.toBigInteger().multiply(<span class="hljs-keyword">this</span>.z).subtract(<span class="hljs-keyword">this</span>.x.toBigInteger().multiply(b.z)).mod(<span class="hljs-keyword">this</span>.curve.q);

    <span class="hljs-keyword">if</span>(BigInteger.ZERO.equals(v)) {
        <span class="hljs-keyword">if</span>(BigInteger.ZERO.equals(u)) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.twice(); <span class="hljs-comment">// this == b, so double</span>
        }
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.curve.getInfinity(); <span class="hljs-comment">// this = -b, so infinity</span>
    }

    <span class="hljs-keyword">var</span> THREE = <span class="hljs-keyword">new</span> BigInteger(<span class="hljs-string">"3"</span>);
    <span class="hljs-keyword">var</span> x1 = <span class="hljs-keyword">this</span>.x.toBigInteger();
    <span class="hljs-keyword">var</span> y1 = <span class="hljs-keyword">this</span>.y.toBigInteger();
    <span class="hljs-keyword">var</span> x2 = b.x.toBigInteger();
    <span class="hljs-keyword">var</span> y2 = b.y.toBigInteger();

    <span class="hljs-keyword">var</span> v2 = v.square();
    <span class="hljs-keyword">var</span> v3 = v2.multiply(v);
    <span class="hljs-keyword">var</span> x1v2 = x1.multiply(v2);
    <span class="hljs-keyword">var</span> zu2 = u.square().multiply(<span class="hljs-keyword">this</span>.z);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>x3 = v * (z2 * (z1 * u^2 - 2 * x1 * v^2) - v^3)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> x3 = zu2.subtract(x1v2.shiftLeft(<span class="hljs-number">1</span>)).multiply(b.z).subtract(v3).multiply(v).mod(<span class="hljs-keyword">this</span>.curve.q);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>y3 = z2 * (3 * x1 * u * v^2 - y1 * v^3 - z1 * u^3) + u * v^3</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> y3 = x1v2.multiply(THREE).multiply(u).subtract(y1.multiply(v3)).subtract(zu2.multiply(u)).multiply(b.z).add(u.multiply(v3)).mod(<span class="hljs-keyword">this</span>.curve.q);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>z3 = v^3 * z1 * z2</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> z3 = v3.multiply(<span class="hljs-keyword">this</span>.z).multiply(b.z).mod(<span class="hljs-keyword">this</span>.curve.q);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ECPointFp(<span class="hljs-keyword">this</span>.curve, <span class="hljs-keyword">this</span>.curve.fromBigInteger(x3), <span class="hljs-keyword">this</span>.curve.fromBigInteger(y3), z3);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pointFpTwice</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.isInfinity()) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.y.toBigInteger().signum() == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.curve.getInfinity();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>TODO: optimized handling of constants</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> THREE = <span class="hljs-keyword">new</span> BigInteger(<span class="hljs-string">"3"</span>);
    <span class="hljs-keyword">var</span> x1 = <span class="hljs-keyword">this</span>.x.toBigInteger();
    <span class="hljs-keyword">var</span> y1 = <span class="hljs-keyword">this</span>.y.toBigInteger();

    <span class="hljs-keyword">var</span> y1z1 = y1.multiply(<span class="hljs-keyword">this</span>.z);
    <span class="hljs-keyword">var</span> y1sqz1 = y1z1.multiply(y1).mod(<span class="hljs-keyword">this</span>.curve.q);
    <span class="hljs-keyword">var</span> a = <span class="hljs-keyword">this</span>.curve.a.toBigInteger();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>w = 3 * x1^2 + a * z1^2</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> w = x1.square().multiply(THREE);
    <span class="hljs-keyword">if</span>(!BigInteger.ZERO.equals(a)) {
      w = w.add(<span class="hljs-keyword">this</span>.z.square().multiply(a));
    }
    w = w.mod(<span class="hljs-keyword">this</span>.curve.q);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>this.curve.reduce(w);
x3 = 2 * y1 * z1 * (w^2 - 8 * x1 * y1^2 * z1)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> x3 = w.square().subtract(x1.shiftLeft(<span class="hljs-number">3</span>).multiply(y1sqz1)).shiftLeft(<span class="hljs-number">1</span>).multiply(y1z1).mod(<span class="hljs-keyword">this</span>.curve.q);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>y3 = 4 * y1^2 * z1 * (3 * w * x1 - 2 * y1^2 * z1) - w^3</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> y3 = w.multiply(THREE).multiply(x1).subtract(y1sqz1.shiftLeft(<span class="hljs-number">1</span>)).shiftLeft(<span class="hljs-number">2</span>).multiply(y1sqz1).subtract(w.square().multiply(w)).mod(<span class="hljs-keyword">this</span>.curve.q);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>z3 = 8 * (y1 * z1)^3</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> z3 = y1z1.square().multiply(y1z1).shiftLeft(<span class="hljs-number">3</span>).mod(<span class="hljs-keyword">this</span>.curve.q);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ECPointFp(<span class="hljs-keyword">this</span>.curve, <span class="hljs-keyword">this</span>.curve.fromBigInteger(x3), <span class="hljs-keyword">this</span>.curve.fromBigInteger(y3), z3);
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>Simple NAF (Non-Adjacent Form) multiplication algorithm
TODO: modularize the multiplication algorithm</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pointFpMultiply</span>(<span class="hljs-params">k</span>) </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.isInfinity()) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">if</span>(k.signum() == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.curve.getInfinity();

    <span class="hljs-keyword">var</span> e = k;
    <span class="hljs-keyword">var</span> h = e.multiply(<span class="hljs-keyword">new</span> BigInteger(<span class="hljs-string">"3"</span>));

    <span class="hljs-keyword">var</span> neg = <span class="hljs-keyword">this</span>.negate();
    <span class="hljs-keyword">var</span> R = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">var</span> i;
    <span class="hljs-keyword">for</span>(i = h.bitLength() - <span class="hljs-number">2</span>; i &gt; <span class="hljs-number">0</span>; --i) {
	R = R.twice();

	<span class="hljs-keyword">var</span> hBit = h.testBit(i);
	<span class="hljs-keyword">var</span> eBit = e.testBit(i);

	<span class="hljs-keyword">if</span> (hBit != eBit) {
	    R = R.add(hBit ? <span class="hljs-keyword">this</span> : neg);
	}
    }

    <span class="hljs-keyword">return</span> R;
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>Compute this<em>j + x</em>k (simultaneous multiplication)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pointFpMultiplyTwo</span>(<span class="hljs-params">j,x,k</span>) </span>{
  <span class="hljs-keyword">var</span> i;
  <span class="hljs-keyword">if</span>(j.bitLength() &gt; k.bitLength())
    i = j.bitLength() - <span class="hljs-number">1</span>;
  <span class="hljs-keyword">else</span>
    i = k.bitLength() - <span class="hljs-number">1</span>;

  <span class="hljs-keyword">var</span> R = <span class="hljs-keyword">this</span>.curve.getInfinity();
  <span class="hljs-keyword">var</span> both = <span class="hljs-keyword">this</span>.add(x);
  <span class="hljs-keyword">while</span>(i &gt;= <span class="hljs-number">0</span>) {
    R = R.twice();
    <span class="hljs-keyword">if</span>(j.testBit(i)) {
      <span class="hljs-keyword">if</span>(k.testBit(i)) {
        R = R.add(both);
      }
      <span class="hljs-keyword">else</span> {
        R = R.add(<span class="hljs-keyword">this</span>);
      }
    }
    <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span>(k.testBit(i)) {
        R = R.add(x);
      }
    }
    --i;
  }

  <span class="hljs-keyword">return</span> R;
}

ECPointFp.prototype.getX = pointFpGetX;
ECPointFp.prototype.getY = pointFpGetY;
ECPointFp.prototype.equals = pointFpEquals;
ECPointFp.prototype.isInfinity = pointFpIsInfinity;
ECPointFp.prototype.negate = pointFpNegate;
ECPointFp.prototype.add = pointFpAdd;
ECPointFp.prototype.twice = pointFpTwice;
ECPointFp.prototype.multiply = pointFpMultiply;
ECPointFp.prototype.multiplyTwo = pointFpMultiplyTwo;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<hr>
<p>ECCurveFp</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>constructor</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ECCurveFp</span>(<span class="hljs-params">q,a,b</span>) </span>{
    <span class="hljs-keyword">this</span>.q = q;
    <span class="hljs-keyword">this</span>.a = <span class="hljs-keyword">this</span>.fromBigInteger(a);
    <span class="hljs-keyword">this</span>.b = <span class="hljs-keyword">this</span>.fromBigInteger(b);
    <span class="hljs-keyword">this</span>.infinity = <span class="hljs-keyword">new</span> ECPointFp(<span class="hljs-keyword">this</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
    <span class="hljs-keyword">this</span>.reducer = <span class="hljs-keyword">new</span> Barrett(<span class="hljs-keyword">this</span>.q);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">curveFpGetQ</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.q;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">curveFpGetA</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.a;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">curveFpGetB</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.b;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">curveFpEquals</span>(<span class="hljs-params">other</span>) </span>{
    <span class="hljs-keyword">if</span>(other == <span class="hljs-keyword">this</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span>(<span class="hljs-keyword">this</span>.q.equals(other.q) &amp;&amp; <span class="hljs-keyword">this</span>.a.equals(other.a) &amp;&amp; <span class="hljs-keyword">this</span>.b.equals(other.b));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">curveFpGetInfinity</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.infinity;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">curveFpFromBigInteger</span>(<span class="hljs-params">x</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ECFieldElementFp(<span class="hljs-keyword">this</span>.q, x);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">curveReduce</span>(<span class="hljs-params">x</span>) </span>{
    <span class="hljs-keyword">this</span>.reducer.reduce(x);
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>for now, work with hex strings because they're easier in JS</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">curveFpDecodePointHex</span>(<span class="hljs-params">s</span>) </span>{
    <span class="hljs-keyword">switch</span>(<span class="hljs-built_in">parseInt</span>(s.substr(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>), <span class="hljs-number">16</span>)) { <span class="hljs-comment">// first byte</span>
    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.infinity;
    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>point compression not supported yet</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">	<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>:
	<span class="hljs-keyword">var</span> len = (s.length - <span class="hljs-number">2</span>) / <span class="hljs-number">2</span>;
	<span class="hljs-keyword">var</span> xHex = s.substr(<span class="hljs-number">2</span>, len);
	<span class="hljs-keyword">var</span> yHex = s.substr(len+<span class="hljs-number">2</span>, len);

	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ECPointFp(<span class="hljs-keyword">this</span>,
			     <span class="hljs-keyword">this</span>.fromBigInteger(<span class="hljs-keyword">new</span> BigInteger(xHex, <span class="hljs-number">16</span>)),
			     <span class="hljs-keyword">this</span>.fromBigInteger(<span class="hljs-keyword">new</span> BigInteger(yHex, <span class="hljs-number">16</span>)));

    <span class="hljs-keyword">default</span>: <span class="hljs-comment">// unsupported</span>
	<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">curveFpEncodePointHex</span>(<span class="hljs-params">p</span>) </span>{
	<span class="hljs-keyword">if</span> (p.isInfinity()) <span class="hljs-keyword">return</span> <span class="hljs-string">"00"</span>;
	<span class="hljs-keyword">var</span> xHex = p.getX().toBigInteger().toString(<span class="hljs-number">16</span>);
	<span class="hljs-keyword">var</span> yHex = p.getY().toBigInteger().toString(<span class="hljs-number">16</span>);
	<span class="hljs-keyword">var</span> oLen = <span class="hljs-keyword">this</span>.getQ().toString(<span class="hljs-number">16</span>).length;
	<span class="hljs-keyword">if</span> ((oLen % <span class="hljs-number">2</span>) != <span class="hljs-number">0</span>) oLen++;
	<span class="hljs-keyword">while</span> (xHex.length &lt; oLen) {
		xHex = <span class="hljs-string">"0"</span> + xHex;
	}
	<span class="hljs-keyword">while</span> (yHex.length &lt; oLen) {
		yHex = <span class="hljs-string">"0"</span> + yHex;
	}
	<span class="hljs-keyword">return</span> <span class="hljs-string">"04"</span> + xHex + yHex;
}

ECCurveFp.prototype.getQ = curveFpGetQ;
ECCurveFp.prototype.getA = curveFpGetA;
ECCurveFp.prototype.getB = curveFpGetB;
ECCurveFp.prototype.equals = curveFpEquals;
ECCurveFp.prototype.getInfinity = curveFpGetInfinity;
ECCurveFp.prototype.fromBigInteger = curveFpFromBigInteger;
ECCurveFp.prototype.reduce = curveReduce;
ECCurveFp.prototype.decodePointHex = curveFpDecodePointHex;
ECCurveFp.prototype.encodePointHex = curveFpEncodePointHex;

<span class="hljs-keyword">var</span> exports = {
  <span class="hljs-attr">ECCurveFp</span>: ECCurveFp,
  <span class="hljs-attr">ECPointFp</span>: ECPointFp,
  <span class="hljs-attr">ECFieldElementFp</span>: ECFieldElementFp
}

<span class="hljs-built_in">module</span>.exports = exports

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>lines.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/recast/lib/lines.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>lines.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">"assert"</span>);
<span class="hljs-keyword">var</span> sourceMap = <span class="hljs-built_in">require</span>(<span class="hljs-string">"source-map"</span>);
<span class="hljs-keyword">var</span> normalizeOptions = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./options"</span>).normalize;
<span class="hljs-keyword">var</span> secretKey = <span class="hljs-built_in">require</span>(<span class="hljs-string">"private"</span>).makeUniqueKey();
<span class="hljs-keyword">var</span> types = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./types"</span>);
<span class="hljs-keyword">var</span> isString = types.builtInTypes.string;
<span class="hljs-keyword">var</span> comparePos = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./util"</span>).comparePos;
<span class="hljs-keyword">var</span> Mapping = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./mapping"</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Goals:</p>
<ol>
<li>Minimize new string creation.</li>
<li>Keep (de)identation O(lines) time.</li>
<li>Permit negative indentations.</li>
<li>Enforce immutability.</li>
<li>No newline characters.</li>
</ol>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSecret</span>(<span class="hljs-params">lines</span>) </span>{
    <span class="hljs-keyword">return</span> lines[secretKey];
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Lines</span>(<span class="hljs-params">infos, sourceFileName</span>) </span>{
    assert.ok(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> Lines);
    assert.ok(infos.length &gt; <span class="hljs-number">0</span>);

    <span class="hljs-keyword">if</span> (sourceFileName) {
        isString.assert(sourceFileName);
    } <span class="hljs-keyword">else</span> {
        sourceFileName = <span class="hljs-literal">null</span>;
    }

    <span class="hljs-built_in">Object</span>.defineProperty(<span class="hljs-keyword">this</span>, secretKey, {
        <span class="hljs-attr">value</span>: {
            <span class="hljs-attr">infos</span>: infos,
            <span class="hljs-attr">mappings</span>: [],
            <span class="hljs-attr">name</span>: sourceFileName,
            <span class="hljs-attr">cachedSourceMap</span>: <span class="hljs-literal">null</span>
        }
    });

    <span class="hljs-keyword">if</span> (sourceFileName) {
        getSecret(<span class="hljs-keyword">this</span>).mappings.push(<span class="hljs-keyword">new</span> Mapping(<span class="hljs-keyword">this</span>, {
            <span class="hljs-attr">start</span>: <span class="hljs-keyword">this</span>.firstPos(),
            <span class="hljs-attr">end</span>: <span class="hljs-keyword">this</span>.lastPos()
        }));
    }
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Exposed for instanceof checks. The fromString function should be used
to create new Lines objects.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">exports.Lines = Lines;
<span class="hljs-keyword">var</span> Lp = Lines.prototype;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>These properties used to be assigned to each new object in the Lines
constructor, but we can more efficiently stuff them into the secret and
let these lazy accessors compute their values on-the-fly.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-built_in">Object</span>.defineProperties(Lp, {
    <span class="hljs-attr">length</span>: {
        <span class="hljs-attr">get</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> getSecret(<span class="hljs-keyword">this</span>).infos.length;
        }
    },

    <span class="hljs-attr">name</span>: {
        <span class="hljs-attr">get</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> getSecret(<span class="hljs-keyword">this</span>).name;
        }
    }
});

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">copyLineInfo</span>(<span class="hljs-params">info</span>) </span>{
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">line</span>: info.line,
        <span class="hljs-attr">indent</span>: info.indent,
        <span class="hljs-attr">locked</span>: info.locked,
        <span class="hljs-attr">sliceStart</span>: info.sliceStart,
        <span class="hljs-attr">sliceEnd</span>: info.sliceEnd
    };
}

<span class="hljs-keyword">var</span> fromStringCache = {};
<span class="hljs-keyword">var</span> hasOwn = fromStringCache.hasOwnProperty;
<span class="hljs-keyword">var</span> maxCacheKeyLen = <span class="hljs-number">10</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">countSpaces</span>(<span class="hljs-params">spaces, tabWidth</span>) </span>{
    <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> len = spaces.length;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; len; ++i) {
        <span class="hljs-keyword">switch</span> (spaces.charCodeAt(i)) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">9</span>: <span class="hljs-comment">// '\t'</span>
            assert.strictEqual(<span class="hljs-keyword">typeof</span> tabWidth, <span class="hljs-string">"number"</span>);
            assert.ok(tabWidth &gt; <span class="hljs-number">0</span>);

            <span class="hljs-keyword">var</span> next = <span class="hljs-built_in">Math</span>.ceil(count / tabWidth) * tabWidth;
            <span class="hljs-keyword">if</span> (next === count) {
                count += tabWidth;
            } <span class="hljs-keyword">else</span> {
                count = next;
            }

            <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> <span class="hljs-number">11</span>: <span class="hljs-comment">// '\v'</span>
        <span class="hljs-keyword">case</span> <span class="hljs-number">12</span>: <span class="hljs-comment">// '\f'</span>
        <span class="hljs-keyword">case</span> <span class="hljs-number">13</span>: <span class="hljs-comment">// '\r'</span>
        <span class="hljs-keyword">case</span> <span class="hljs-number">0xfeff</span>: <span class="hljs-comment">// zero-width non-breaking space</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>These characters contribute nothing to indentation.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> <span class="hljs-number">32</span>: <span class="hljs-comment">// ' '</span>
        <span class="hljs-keyword">default</span>: <span class="hljs-comment">// Treat all other whitespace like ' '.</span>
            count += <span class="hljs-number">1</span>;
            <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-keyword">return</span> count;
}
exports.countSpaces = countSpaces;

<span class="hljs-keyword">var</span> leadingSpaceExp = <span class="hljs-regexp">/^\s*/</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>As specified here: http://www.ecma-international.org/ecma-262/6.0/#sec-line-terminators</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> lineTerminatorSeqExp =
    <span class="hljs-regexp">/\u000D\u000A|\u000D(?!\u000A)|\u000A|\u2028|\u2029/</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<div class="dox">
<div class="summary">
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">options</span>
<span class="dox_type">Object</span>
<span><ul>
<li>Options object that configures printing.</li>
</ul>
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fromString</span>(<span class="hljs-params">string, options</span>) </span>{
    <span class="hljs-keyword">if</span> (string <span class="hljs-keyword">instanceof</span> Lines)
        <span class="hljs-keyword">return</span> string;

    string += <span class="hljs-string">""</span>;

    <span class="hljs-keyword">var</span> tabWidth = options &amp;&amp; options.tabWidth;
    <span class="hljs-keyword">var</span> tabless = string.indexOf(<span class="hljs-string">"\t"</span>) &lt; <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> locked = !! (options &amp;&amp; options.locked);
    <span class="hljs-keyword">var</span> cacheable = !options &amp;&amp; tabless &amp;&amp; (string.length &lt;= maxCacheKeyLen);

    assert.ok(tabWidth || tabless, <span class="hljs-string">"No tab width specified but encountered tabs in string\n"</span> + string);

    <span class="hljs-keyword">if</span> (cacheable &amp;&amp; hasOwn.call(fromStringCache, string))
        <span class="hljs-keyword">return</span> fromStringCache[string];

    <span class="hljs-keyword">var</span> lines = <span class="hljs-keyword">new</span> Lines(string.split(lineTerminatorSeqExp).map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">line</span>) </span>{
        <span class="hljs-keyword">var</span> spaces = leadingSpaceExp.exec(line)[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">line</span>: line,
            <span class="hljs-attr">indent</span>: countSpaces(spaces, tabWidth),
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Boolean indicating whether this line can be reindented.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            locked: locked,
            <span class="hljs-attr">sliceStart</span>: spaces.length,
            <span class="hljs-attr">sliceEnd</span>: line.length
        };
    }), normalizeOptions(options).sourceFileName);

    <span class="hljs-keyword">if</span> (cacheable)
        fromStringCache[string] = lines;

    <span class="hljs-keyword">return</span> lines;
}
exports.fromString = fromString;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isOnlyWhitespace</span>(<span class="hljs-params">string</span>) </span>{
    <span class="hljs-keyword">return</span> !<span class="hljs-regexp">/\S/</span>.test(string);
}

Lp.toString = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.sliceString(<span class="hljs-keyword">this</span>.firstPos(), <span class="hljs-keyword">this</span>.lastPos(), options);
};

Lp.getSourceMap = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sourceMapName, sourceRoot</span>) </span>{
    <span class="hljs-keyword">if</span> (!sourceMapName) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>Although we could make up a name or generate an anonymous
source map, instead we assume that any consumer who does not
provide a name does not actually want a source map.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">var</span> targetLines = <span class="hljs-keyword">this</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateJSON</span>(<span class="hljs-params">json</span>) </span>{
        json = json || {};

        isString.assert(sourceMapName);
        json.file = sourceMapName;

        <span class="hljs-keyword">if</span> (sourceRoot) {
            isString.assert(sourceRoot);
            json.sourceRoot = sourceRoot;
        }

        <span class="hljs-keyword">return</span> json;
    }

    <span class="hljs-keyword">var</span> secret = getSecret(targetLines);
    <span class="hljs-keyword">if</span> (secret.cachedSourceMap) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>Since Lines objects are immutable, we can reuse any source map
that was previously generated. Nevertheless, we return a new
JSON object here to protect the cached source map from outside
modification.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">return</span> updateJSON(secret.cachedSourceMap.toJSON());
    }

    <span class="hljs-keyword">var</span> smg = <span class="hljs-keyword">new</span> sourceMap.SourceMapGenerator(updateJSON());
    <span class="hljs-keyword">var</span> sourcesToContents = {};

    secret.mappings.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">mapping</span>) </span>{
        <span class="hljs-keyword">var</span> sourceCursor = mapping.sourceLines.skipSpaces(
            mapping.sourceLoc.start
        ) || mapping.sourceLines.lastPos();

        <span class="hljs-keyword">var</span> targetCursor = targetLines.skipSpaces(
            mapping.targetLoc.start
        ) || targetLines.lastPos();

        <span class="hljs-keyword">while</span> (comparePos(sourceCursor, mapping.sourceLoc.end) &lt; <span class="hljs-number">0</span> &amp;&amp;
               comparePos(targetCursor, mapping.targetLoc.end) &lt; <span class="hljs-number">0</span>) {

            <span class="hljs-keyword">var</span> sourceChar = mapping.sourceLines.charAt(sourceCursor);
            <span class="hljs-keyword">var</span> targetChar = targetLines.charAt(targetCursor);
            assert.strictEqual(sourceChar, targetChar);

            <span class="hljs-keyword">var</span> sourceName = mapping.sourceLines.name;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>Add mappings one character at a time for maximum resolution.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            smg.addMapping({
                <span class="hljs-attr">source</span>: sourceName,
                <span class="hljs-attr">original</span>: { <span class="hljs-attr">line</span>: sourceCursor.line,
                            <span class="hljs-attr">column</span>: sourceCursor.column },
                <span class="hljs-attr">generated</span>: { <span class="hljs-attr">line</span>: targetCursor.line,
                             <span class="hljs-attr">column</span>: targetCursor.column }
            });

            <span class="hljs-keyword">if</span> (!hasOwn.call(sourcesToContents, sourceName)) {
                <span class="hljs-keyword">var</span> sourceContent = mapping.sourceLines.toString();
                smg.setSourceContent(sourceName, sourceContent);
                sourcesToContents[sourceName] = sourceContent;
            }

            targetLines.nextPos(targetCursor, <span class="hljs-literal">true</span>);
            mapping.sourceLines.nextPos(sourceCursor, <span class="hljs-literal">true</span>);
        }
    });

    secret.cachedSourceMap = smg;

    <span class="hljs-keyword">return</span> smg.toJSON();
};

Lp.bootstrapCharAt = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pos</span>) </span>{
    assert.strictEqual(<span class="hljs-keyword">typeof</span> pos, <span class="hljs-string">"object"</span>);
    assert.strictEqual(<span class="hljs-keyword">typeof</span> pos.line, <span class="hljs-string">"number"</span>);
    assert.strictEqual(<span class="hljs-keyword">typeof</span> pos.column, <span class="hljs-string">"number"</span>);

    <span class="hljs-keyword">var</span> line = pos.line,
        column = pos.column,
        strings = <span class="hljs-keyword">this</span>.toString().split(lineTerminatorSeqExp),
        string = strings[line - <span class="hljs-number">1</span>];

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> string === <span class="hljs-string">"undefined"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;

    <span class="hljs-keyword">if</span> (column === string.length &amp;&amp;
        line &lt; strings.length)
        <span class="hljs-keyword">return</span> <span class="hljs-string">"\n"</span>;

    <span class="hljs-keyword">if</span> (column &gt;= string.length)
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;

    <span class="hljs-keyword">return</span> string.charAt(column);
};

Lp.charAt = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pos</span>) </span>{
    assert.strictEqual(<span class="hljs-keyword">typeof</span> pos, <span class="hljs-string">"object"</span>);
    assert.strictEqual(<span class="hljs-keyword">typeof</span> pos.line, <span class="hljs-string">"number"</span>);
    assert.strictEqual(<span class="hljs-keyword">typeof</span> pos.column, <span class="hljs-string">"number"</span>);

    <span class="hljs-keyword">var</span> line = pos.line,
        column = pos.column,
        secret = getSecret(<span class="hljs-keyword">this</span>),
        infos = secret.infos,
        info = infos[line - <span class="hljs-number">1</span>],
        c = column;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> info === <span class="hljs-string">"undefined"</span> || c &lt; <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;

    <span class="hljs-keyword">var</span> indent = <span class="hljs-keyword">this</span>.getIndentAt(line);
    <span class="hljs-keyword">if</span> (c &lt; indent)
        <span class="hljs-keyword">return</span> <span class="hljs-string">" "</span>;

    c += info.sliceStart - indent;

    <span class="hljs-keyword">if</span> (c === info.sliceEnd &amp;&amp;
        line &lt; <span class="hljs-keyword">this</span>.length)
        <span class="hljs-keyword">return</span> <span class="hljs-string">"\n"</span>;

    <span class="hljs-keyword">if</span> (c &gt;= info.sliceEnd)
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;

    <span class="hljs-keyword">return</span> info.line.charAt(c);
};

Lp.stripMargin = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">width, skipFirstLine</span>) </span>{
    <span class="hljs-keyword">if</span> (width === <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

    assert.ok(width &gt; <span class="hljs-number">0</span>, <span class="hljs-string">"negative margin: "</span> + width);

    <span class="hljs-keyword">if</span> (skipFirstLine &amp;&amp; <span class="hljs-keyword">this</span>.length === <span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">var</span> secret = getSecret(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">var</span> lines = <span class="hljs-keyword">new</span> Lines(secret.infos.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">info, i</span>) </span>{
        <span class="hljs-keyword">if</span> (info.line &amp;&amp; (i &gt; <span class="hljs-number">0</span> || !skipFirstLine)) {
            info = copyLineInfo(info);
            info.indent = <span class="hljs-built_in">Math</span>.max(<span class="hljs-number">0</span>, info.indent - width);
        }
        <span class="hljs-keyword">return</span> info;
    }));

    <span class="hljs-keyword">if</span> (secret.mappings.length &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">var</span> newMappings = getSecret(lines).mappings;
        assert.strictEqual(newMappings.length, <span class="hljs-number">0</span>);
        secret.mappings.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">mapping</span>) </span>{
            newMappings.push(mapping.indent(width, skipFirstLine, <span class="hljs-literal">true</span>));
        });
    }

    <span class="hljs-keyword">return</span> lines;
};

Lp.indent = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">by</span>) </span>{
    <span class="hljs-keyword">if</span> (by === <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">var</span> secret = getSecret(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">var</span> lines = <span class="hljs-keyword">new</span> Lines(secret.infos.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">info</span>) </span>{
        <span class="hljs-keyword">if</span> (info.line &amp;&amp; ! info.locked) {
            info = copyLineInfo(info);
            info.indent += by;
        }
        <span class="hljs-keyword">return</span> info
    }));

    <span class="hljs-keyword">if</span> (secret.mappings.length &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">var</span> newMappings = getSecret(lines).mappings;
        assert.strictEqual(newMappings.length, <span class="hljs-number">0</span>);
        secret.mappings.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">mapping</span>) </span>{
            newMappings.push(mapping.indent(by));
        });
    }

    <span class="hljs-keyword">return</span> lines;
};

Lp.indentTail = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">by</span>) </span>{
    <span class="hljs-keyword">if</span> (by === <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.length &lt; <span class="hljs-number">2</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">var</span> secret = getSecret(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">var</span> lines = <span class="hljs-keyword">new</span> Lines(secret.infos.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">info, i</span>) </span>{
        <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span> &amp;&amp; info.line &amp;&amp; ! info.locked) {
            info = copyLineInfo(info);
            info.indent += by;
        }

        <span class="hljs-keyword">return</span> info;
    }));

    <span class="hljs-keyword">if</span> (secret.mappings.length &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">var</span> newMappings = getSecret(lines).mappings;
        assert.strictEqual(newMappings.length, <span class="hljs-number">0</span>);
        secret.mappings.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">mapping</span>) </span>{
            newMappings.push(mapping.indent(by, <span class="hljs-literal">true</span>));
        });
    }

    <span class="hljs-keyword">return</span> lines;
};

Lp.lockIndentTail = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.length &lt; <span class="hljs-number">2</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }

    <span class="hljs-keyword">var</span> infos = getSecret(<span class="hljs-keyword">this</span>).infos;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Lines(infos.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">info, i</span>) </span>{
        info = copyLineInfo(info);
        info.locked = i &gt; <span class="hljs-number">0</span>;
        <span class="hljs-keyword">return</span> info;
    }));
};

Lp.getIndentAt = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">line</span>) </span>{
    assert.ok(line &gt;= <span class="hljs-number">1</span>, <span class="hljs-string">"no line "</span> + line + <span class="hljs-string">" (line numbers start from 1)"</span>);
    <span class="hljs-keyword">var</span> secret = getSecret(<span class="hljs-keyword">this</span>),
        info = secret.infos[line - <span class="hljs-number">1</span>];
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.max(info.indent, <span class="hljs-number">0</span>);
};

Lp.guessTabWidth = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> secret = getSecret(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">if</span> (hasOwn.call(secret, <span class="hljs-string">"cachedTabWidth"</span>)) {
        <span class="hljs-keyword">return</span> secret.cachedTabWidth;
    }

    <span class="hljs-keyword">var</span> counts = []; <span class="hljs-comment">// Sparse array.</span>
    <span class="hljs-keyword">var</span> lastIndent = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> line = <span class="hljs-number">1</span>, last = <span class="hljs-keyword">this</span>.length; line &lt;= last; ++line) {
        <span class="hljs-keyword">var</span> info = secret.infos[line - <span class="hljs-number">1</span>];
        <span class="hljs-keyword">var</span> sliced = info.line.slice(info.sliceStart, info.sliceEnd);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>Whitespace-only lines don't tell us much about the likely tab
width of this code.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (isOnlyWhitespace(sliced)) {
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-keyword">var</span> diff = <span class="hljs-built_in">Math</span>.abs(info.indent - lastIndent);
        counts[diff] = ~~counts[diff] + <span class="hljs-number">1</span>;
        lastIndent = info.indent;
    }

    <span class="hljs-keyword">var</span> maxCount = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">var</span> result = <span class="hljs-number">2</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> tabWidth = <span class="hljs-number">1</span>;
         tabWidth &lt; counts.length;
         tabWidth += <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">if</span> (hasOwn.call(counts, tabWidth) &amp;&amp;
            counts[tabWidth] &gt; maxCount) {
            maxCount = counts[tabWidth];
            result = tabWidth;
        }
    }

    <span class="hljs-keyword">return</span> secret.cachedTabWidth = result;
};

Lp.isOnlyWhitespace = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> isOnlyWhitespace(<span class="hljs-keyword">this</span>.toString());
};

Lp.isPrecededOnlyByWhitespace = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pos</span>) </span>{
    <span class="hljs-keyword">var</span> secret = getSecret(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">var</span> info = secret.infos[pos.line - <span class="hljs-number">1</span>];
    <span class="hljs-keyword">var</span> indent = <span class="hljs-built_in">Math</span>.max(info.indent, <span class="hljs-number">0</span>);

    <span class="hljs-keyword">var</span> diff = pos.column - indent;
    <span class="hljs-keyword">if</span> (diff &lt;= <span class="hljs-number">0</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>If pos.column does not exceed the indentation amount, then
there must be only whitespace before it.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">var</span> start = info.sliceStart;
    <span class="hljs-keyword">var</span> end = <span class="hljs-built_in">Math</span>.min(start + diff, info.sliceEnd);
    <span class="hljs-keyword">var</span> prefix = info.line.slice(start, end);

    <span class="hljs-keyword">return</span> isOnlyWhitespace(prefix);
};

Lp.getLineLength = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">line</span>) </span>{
    <span class="hljs-keyword">var</span> secret = getSecret(<span class="hljs-keyword">this</span>),
        info = secret.infos[line - <span class="hljs-number">1</span>];
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getIndentAt(line) + info.sliceEnd - info.sliceStart;
};

Lp.nextPos = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pos, skipSpaces</span>) </span>{
    <span class="hljs-keyword">var</span> l = <span class="hljs-built_in">Math</span>.max(pos.line, <span class="hljs-number">0</span>),
        c = <span class="hljs-built_in">Math</span>.max(pos.column, <span class="hljs-number">0</span>);

    <span class="hljs-keyword">if</span> (c &lt; <span class="hljs-keyword">this</span>.getLineLength(l)) {
        pos.column += <span class="hljs-number">1</span>;

        <span class="hljs-keyword">return</span> skipSpaces
            ? !!<span class="hljs-keyword">this</span>.skipSpaces(pos, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)
            : <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">if</span> (l &lt; <span class="hljs-keyword">this</span>.length) {
        pos.line += <span class="hljs-number">1</span>;
        pos.column = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">return</span> skipSpaces
            ? !!<span class="hljs-keyword">this</span>.skipSpaces(pos, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)
            : <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};

Lp.prevPos = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pos, skipSpaces</span>) </span>{
    <span class="hljs-keyword">var</span> l = pos.line,
        c = pos.column;

    <span class="hljs-keyword">if</span> (c &lt; <span class="hljs-number">1</span>) {
        l -= <span class="hljs-number">1</span>;

        <span class="hljs-keyword">if</span> (l &lt; <span class="hljs-number">1</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

        c = <span class="hljs-keyword">this</span>.getLineLength(l);

    } <span class="hljs-keyword">else</span> {
        c = <span class="hljs-built_in">Math</span>.min(c - <span class="hljs-number">1</span>, <span class="hljs-keyword">this</span>.getLineLength(l));
    }

    pos.line = l;
    pos.column = c;

    <span class="hljs-keyword">return</span> skipSpaces
        ? !!<span class="hljs-keyword">this</span>.skipSpaces(pos, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>)
        : <span class="hljs-literal">true</span>;
};

Lp.firstPos = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>Trivial, but provided for completeness.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">return</span> { <span class="hljs-attr">line</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">column</span>: <span class="hljs-number">0</span> };
};

Lp.lastPos = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">line</span>: <span class="hljs-keyword">this</span>.length,
        <span class="hljs-attr">column</span>: <span class="hljs-keyword">this</span>.getLineLength(<span class="hljs-keyword">this</span>.length)
    };
};

Lp.skipSpaces = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pos, backward, modifyInPlace</span>) </span>{
    <span class="hljs-keyword">if</span> (pos) {
        pos = modifyInPlace ? pos : {
            <span class="hljs-attr">line</span>: pos.line,
            <span class="hljs-attr">column</span>: pos.column
        };
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (backward) {
        pos = <span class="hljs-keyword">this</span>.lastPos();
    } <span class="hljs-keyword">else</span> {
        pos = <span class="hljs-keyword">this</span>.firstPos();
    }

    <span class="hljs-keyword">if</span> (backward) {
        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">this</span>.prevPos(pos)) {
            <span class="hljs-keyword">if</span> (!isOnlyWhitespace(<span class="hljs-keyword">this</span>.charAt(pos)) &amp;&amp;
                <span class="hljs-keyword">this</span>.nextPos(pos)) {
                <span class="hljs-keyword">return</span> pos;
            }
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">while</span> (isOnlyWhitespace(<span class="hljs-keyword">this</span>.charAt(pos))) {
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.nextPos(pos)) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        }

        <span class="hljs-keyword">return</span> pos;
    }
};

Lp.trimLeft = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> pos = <span class="hljs-keyword">this</span>.skipSpaces(<span class="hljs-keyword">this</span>.firstPos(), <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> pos ? <span class="hljs-keyword">this</span>.slice(pos) : emptyLines;
};

Lp.trimRight = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> pos = <span class="hljs-keyword">this</span>.skipSpaces(<span class="hljs-keyword">this</span>.lastPos(), <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> pos ? <span class="hljs-keyword">this</span>.slice(<span class="hljs-keyword">this</span>.firstPos(), pos) : emptyLines;
};

Lp.trim = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> start = <span class="hljs-keyword">this</span>.skipSpaces(<span class="hljs-keyword">this</span>.firstPos(), <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">if</span> (start === <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">return</span> emptyLines;

    <span class="hljs-keyword">var</span> end = <span class="hljs-keyword">this</span>.skipSpaces(<span class="hljs-keyword">this</span>.lastPos(), <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);
    assert.notStrictEqual(end, <span class="hljs-literal">null</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.slice(start, end);
};

Lp.eachPos = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback, startPos, skipSpaces</span>) </span>{
    <span class="hljs-keyword">var</span> pos = <span class="hljs-keyword">this</span>.firstPos();

    <span class="hljs-keyword">if</span> (startPos) {
        pos.line = startPos.line,
        pos.column = startPos.column
    }

    <span class="hljs-keyword">if</span> (skipSpaces &amp;&amp; !<span class="hljs-keyword">this</span>.skipSpaces(pos, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">return</span>; <span class="hljs-comment">// Encountered nothing but spaces.</span>
    }

    <span class="hljs-keyword">do</span> callback.call(<span class="hljs-keyword">this</span>, pos);
    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">this</span>.nextPos(pos, skipSpaces));
};

Lp.bootstrapSlice = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">start, end</span>) </span>{
    <span class="hljs-keyword">var</span> strings = <span class="hljs-keyword">this</span>.toString().split(
        lineTerminatorSeqExp
    ).slice(
        start.line - <span class="hljs-number">1</span>,
        end.line
    );

    strings.push(strings.pop().slice(<span class="hljs-number">0</span>, end.column));
    strings[<span class="hljs-number">0</span>] = strings[<span class="hljs-number">0</span>].slice(start.column);

    <span class="hljs-keyword">return</span> fromString(strings.join(<span class="hljs-string">"\n"</span>));
};

Lp.slice = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">start, end</span>) </span>{
    <span class="hljs-keyword">if</span> (!end) {
        <span class="hljs-keyword">if</span> (!start) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>The client seems to want a copy of this Lines object, but
Lines objects are immutable, so it's perfectly adequate to
return the same object.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>Slice to the end if no end position was provided.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        end = <span class="hljs-keyword">this</span>.lastPos();
    }

    <span class="hljs-keyword">var</span> secret = getSecret(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">var</span> sliced = secret.infos.slice(start.line - <span class="hljs-number">1</span>, end.line);

    <span class="hljs-keyword">if</span> (start.line === end.line) {
        sliced[<span class="hljs-number">0</span>] = sliceInfo(sliced[<span class="hljs-number">0</span>], start.column, end.column);
    } <span class="hljs-keyword">else</span> {
        assert.ok(start.line &lt; end.line);
        sliced[<span class="hljs-number">0</span>] = sliceInfo(sliced[<span class="hljs-number">0</span>], start.column);
        sliced.push(sliceInfo(sliced.pop(), <span class="hljs-number">0</span>, end.column));
    }

    <span class="hljs-keyword">var</span> lines = <span class="hljs-keyword">new</span> Lines(sliced);

    <span class="hljs-keyword">if</span> (secret.mappings.length &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">var</span> newMappings = getSecret(lines).mappings;
        assert.strictEqual(newMappings.length, <span class="hljs-number">0</span>);
        secret.mappings.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">mapping</span>) </span>{
            <span class="hljs-keyword">var</span> sliced = mapping.slice(<span class="hljs-keyword">this</span>, start, end);
            <span class="hljs-keyword">if</span> (sliced) {
                newMappings.push(sliced);
            }
        }, <span class="hljs-keyword">this</span>);
    }

    <span class="hljs-keyword">return</span> lines;
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sliceInfo</span>(<span class="hljs-params">info, startCol, endCol</span>) </span>{
    <span class="hljs-keyword">var</span> sliceStart = info.sliceStart;
    <span class="hljs-keyword">var</span> sliceEnd = info.sliceEnd;
    <span class="hljs-keyword">var</span> indent = <span class="hljs-built_in">Math</span>.max(info.indent, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">var</span> lineLength = indent + sliceEnd - sliceStart;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> endCol === <span class="hljs-string">"undefined"</span>) {
        endCol = lineLength;
    }

    startCol = <span class="hljs-built_in">Math</span>.max(startCol, <span class="hljs-number">0</span>);
    endCol = <span class="hljs-built_in">Math</span>.min(endCol, lineLength);
    endCol = <span class="hljs-built_in">Math</span>.max(endCol, startCol);

    <span class="hljs-keyword">if</span> (endCol &lt; indent) {
        indent = endCol;
        sliceEnd = sliceStart;
    } <span class="hljs-keyword">else</span> {
        sliceEnd -= lineLength - endCol;
    }

    lineLength = endCol;
    lineLength -= startCol;

    <span class="hljs-keyword">if</span> (startCol &lt; indent) {
        indent -= startCol;
    } <span class="hljs-keyword">else</span> {
        startCol -= indent;
        indent = <span class="hljs-number">0</span>;
        sliceStart += startCol;
    }

    assert.ok(indent &gt;= <span class="hljs-number">0</span>);
    assert.ok(sliceStart &lt;= sliceEnd);
    assert.strictEqual(lineLength, indent + sliceEnd - sliceStart);

    <span class="hljs-keyword">if</span> (info.indent === indent &amp;&amp;
        info.sliceStart === sliceStart &amp;&amp;
        info.sliceEnd === sliceEnd) {
        <span class="hljs-keyword">return</span> info;
    }

    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">line</span>: info.line,
        <span class="hljs-attr">indent</span>: indent,
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>A destructive slice always unlocks indentation.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        locked: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">sliceStart</span>: sliceStart,
        <span class="hljs-attr">sliceEnd</span>: sliceEnd
    };
}

Lp.bootstrapSliceString = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">start, end, options</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.slice(start, end).toString(options);
};

Lp.sliceString = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">start, end, options</span>) </span>{
    <span class="hljs-keyword">if</span> (!end) {
        <span class="hljs-keyword">if</span> (!start) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>The client seems to want a copy of this Lines object, but
Lines objects are immutable, so it's perfectly adequate to
return the same object.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>Slice to the end if no end position was provided.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        end = <span class="hljs-keyword">this</span>.lastPos();
    }

    options = normalizeOptions(options);

    <span class="hljs-keyword">var</span> infos = getSecret(<span class="hljs-keyword">this</span>).infos;
    <span class="hljs-keyword">var</span> parts = [];
    <span class="hljs-keyword">var</span> tabWidth = options.tabWidth;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> line = start.line; line &lt;= end.line; ++line) {
        <span class="hljs-keyword">var</span> info = infos[line - <span class="hljs-number">1</span>];

        <span class="hljs-keyword">if</span> (line === start.line) {
            <span class="hljs-keyword">if</span> (line === end.line) {
                info = sliceInfo(info, start.column, end.column);
            } <span class="hljs-keyword">else</span> {
                info = sliceInfo(info, start.column);
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (line === end.line) {
            info = sliceInfo(info, <span class="hljs-number">0</span>, end.column);
        }

        <span class="hljs-keyword">var</span> indent = <span class="hljs-built_in">Math</span>.max(info.indent, <span class="hljs-number">0</span>);

        <span class="hljs-keyword">var</span> before = info.line.slice(<span class="hljs-number">0</span>, info.sliceStart);
        <span class="hljs-keyword">if</span> (options.reuseWhitespace &amp;&amp;
            isOnlyWhitespace(before) &amp;&amp;
            countSpaces(before, options.tabWidth) === indent) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>Reuse original spaces if the indentation is correct.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            parts.push(info.line.slice(<span class="hljs-number">0</span>, info.sliceEnd));
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-keyword">var</span> tabs = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> spaces = indent;

        <span class="hljs-keyword">if</span> (options.useTabs) {
            tabs = <span class="hljs-built_in">Math</span>.floor(indent / tabWidth);
            spaces -= tabs * tabWidth;
        }

        <span class="hljs-keyword">var</span> result = <span class="hljs-string">""</span>;

        <span class="hljs-keyword">if</span> (tabs &gt; <span class="hljs-number">0</span>) {
            result += <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(tabs + <span class="hljs-number">1</span>).join(<span class="hljs-string">"\t"</span>);
        }

        <span class="hljs-keyword">if</span> (spaces &gt; <span class="hljs-number">0</span>) {
            result += <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(spaces + <span class="hljs-number">1</span>).join(<span class="hljs-string">" "</span>);
        }

        result += info.line.slice(info.sliceStart, info.sliceEnd);

        parts.push(result);
    }

    <span class="hljs-keyword">return</span> parts.join(options.lineTerminator);
};

Lp.isEmpty = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.length &lt; <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-keyword">this</span>.getLineLength(<span class="hljs-number">1</span>) &lt; <span class="hljs-number">1</span>;
};

Lp.join = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">elements</span>) </span>{
    <span class="hljs-keyword">var</span> separator = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> separatorSecret = getSecret(separator);
    <span class="hljs-keyword">var</span> infos = [];
    <span class="hljs-keyword">var</span> mappings = [];
    <span class="hljs-keyword">var</span> prevInfo;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">appendSecret</span>(<span class="hljs-params">secret</span>) </span>{
        <span class="hljs-keyword">if</span> (secret === <span class="hljs-literal">null</span>)
            <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">if</span> (prevInfo) {
            <span class="hljs-keyword">var</span> info = secret.infos[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">var</span> indent = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(info.indent + <span class="hljs-number">1</span>).join(<span class="hljs-string">" "</span>);
            <span class="hljs-keyword">var</span> prevLine = infos.length;
            <span class="hljs-keyword">var</span> prevColumn = <span class="hljs-built_in">Math</span>.max(prevInfo.indent, <span class="hljs-number">0</span>) +
                prevInfo.sliceEnd - prevInfo.sliceStart;

            prevInfo.line = prevInfo.line.slice(
                <span class="hljs-number">0</span>, prevInfo.sliceEnd) + indent + info.line.slice(
                    info.sliceStart, info.sliceEnd);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>If any part of a line is indentation-locked, the whole line
will be indentation-locked.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            prevInfo.locked = prevInfo.locked || info.locked;

            prevInfo.sliceEnd = prevInfo.line.length;

            <span class="hljs-keyword">if</span> (secret.mappings.length &gt; <span class="hljs-number">0</span>) {
                secret.mappings.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">mapping</span>) </span>{
                    mappings.push(mapping.add(prevLine, prevColumn));
                });
            }

        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (secret.mappings.length &gt; <span class="hljs-number">0</span>) {
            mappings.push.apply(mappings, secret.mappings);
        }

        secret.infos.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">info, i</span>) </span>{
            <span class="hljs-keyword">if</span> (!prevInfo || i &gt; <span class="hljs-number">0</span>) {
                prevInfo = copyLineInfo(info);
                infos.push(prevInfo);
            }
        });
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">appendWithSeparator</span>(<span class="hljs-params">secret, i</span>) </span>{
        <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>)
            appendSecret(separatorSecret);
        appendSecret(secret);
    }

    elements.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">elem</span>) </span>{
        <span class="hljs-keyword">var</span> lines = fromString(elem);
        <span class="hljs-keyword">if</span> (lines.isEmpty())
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">return</span> getSecret(lines);
    }).forEach(separator.isEmpty()
               ? appendSecret
               : appendWithSeparator);

    <span class="hljs-keyword">if</span> (infos.length &lt; <span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span> emptyLines;

    <span class="hljs-keyword">var</span> lines = <span class="hljs-keyword">new</span> Lines(infos);

    getSecret(lines).mappings = mappings;

    <span class="hljs-keyword">return</span> lines;
};

exports.concat = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">elements</span>) </span>{
    <span class="hljs-keyword">return</span> emptyLines.join(elements);
};

Lp.concat = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">other</span>) </span>{
    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">arguments</span>,
        list = [<span class="hljs-keyword">this</span>];
    list.push.apply(list, args);
    assert.strictEqual(list.length, args.length + <span class="hljs-number">1</span>);
    <span class="hljs-keyword">return</span> emptyLines.join(list);
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>The emptyLines object needs to be created all the way down here so that
Lines.prototype will be fully populated.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> emptyLines = fromString(<span class="hljs-string">""</span>);

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

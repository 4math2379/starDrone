<!DOCTYPE html>
<html>
<head>
  <title>cookie.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/tough-cookie/lib/cookie.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>cookie.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<div class="dox">
<div class="summary">
<p>!
Copyright (c) 2015, Salesforce.com, Inc.
All rights reserved.</p>
</div>
<div class="body">
<p>Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:</p>
<ol>
<li>
<p>Redistributions of source code must retain the above copyright notice,
this list of conditions and the following disclaimer.</p>
</li>
<li>
<p>Redistributions in binary form must reproduce the above copyright notice,
this list of conditions and the following disclaimer in the documentation
and/or other materials provided with the distribution.</p>
</li>
<li>
<p>Neither the name of Salesforce.com nor the names of its contributors may
be used to endorse or promote products derived from this software without
specific prior written permission.</p>
</li>
</ol>
<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
POSSIBILITY OF SUCH DAMAGE.</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">'use strict'</span>;
<span class="hljs-keyword">var</span> net = <span class="hljs-built_in">require</span>(<span class="hljs-string">'net'</span>);
<span class="hljs-keyword">var</span> urlParse = <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>).parse;
<span class="hljs-keyword">var</span> pubsuffix = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./pubsuffix'</span>);
<span class="hljs-keyword">var</span> Store = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./store'</span>).Store;
<span class="hljs-keyword">var</span> MemoryCookieStore = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./memstore'</span>).MemoryCookieStore;
<span class="hljs-keyword">var</span> pathMatch = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./pathMatch'</span>).pathMatch;
<span class="hljs-keyword">var</span> VERSION = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../package.json'</span>).version;

<span class="hljs-keyword">var</span> punycode;
<span class="hljs-keyword">try</span> {
  punycode = <span class="hljs-built_in">require</span>(<span class="hljs-string">'punycode'</span>);
} <span class="hljs-keyword">catch</span>(e) {
  <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">"cookie: can't load punycode; won't use punycode for domain normalization"</span>);
}

<span class="hljs-keyword">var</span> DATE_DELIM = <span class="hljs-regexp">/[\x09\x20-\x2F\x3B-\x40\x5B-\x60\x7B-\x7E]/</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>From RFC6265 S4.1.1
note that it excludes \x3B &quot;;&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> COOKIE_OCTET  = <span class="hljs-regexp">/[\x21\x23-\x2B\x2D-\x3A\x3C-\x5B\x5D-\x7E]/</span>;
<span class="hljs-keyword">var</span> COOKIE_OCTETS = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'^'</span>+COOKIE_OCTET.source+<span class="hljs-string">'+$'</span>);

<span class="hljs-keyword">var</span> CONTROL_CHARS = <span class="hljs-regexp">/[\x00-\x1F]/</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Double quotes are part of the value (see: S4.1.1).
'\r', '\n' and '\0' should be treated as a terminator in the &quot;relaxed&quot; mode
(see: https://github.com/ChromiumWebApps/chromium/blob/b3d3b4da8bb94c1b2e061600df106d590fda3620/net/cookies/parsed_cookie.cc#L60)
'=' and ';' are attribute/values separators
(see: https://github.com/ChromiumWebApps/chromium/blob/b3d3b4da8bb94c1b2e061600df106d590fda3620/net/cookies/parsed_cookie.cc#L64)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> COOKIE_PAIR = <span class="hljs-regexp">/^(([^=;]+))\s*=\s*([^\n\r\0]*)/</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>Used to parse non-RFC-compliant cookies like '=abc' when given the <code>loose</code>
option in Cookie.parse:</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> LOOSE_COOKIE_PAIR = <span class="hljs-regexp">/^((?:=)?([^=;]*)\s*=\s*)?([^\n\r\0]*)/</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>RFC6265 S4.1.1 defines path value as 'any CHAR except CTLs or &quot;;&quot;'
Note ';' is \x3B</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> PATH_VALUE = <span class="hljs-regexp">/[\x20-\x3A\x3C-\x7E]+/</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Used for checking whether or not there is a trailing semi-colon</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> TRAILING_SEMICOLON = <span class="hljs-regexp">/;+$/</span>;

<span class="hljs-keyword">var</span> DAY_OF_MONTH = <span class="hljs-regexp">/^(\d{1,2})[^\d]*$/</span>;
<span class="hljs-keyword">var</span> TIME = <span class="hljs-regexp">/^(\d{1,2})[^\d]*:(\d{1,2})[^\d]*:(\d{1,2})[^\d]*$/</span>;
<span class="hljs-keyword">var</span> MONTH = <span class="hljs-regexp">/^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i</span>;

<span class="hljs-keyword">var</span> MONTH_TO_NUM = {
  <span class="hljs-attr">jan</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">feb</span>:<span class="hljs-number">1</span>, <span class="hljs-attr">mar</span>:<span class="hljs-number">2</span>, <span class="hljs-attr">apr</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">may</span>:<span class="hljs-number">4</span>, <span class="hljs-attr">jun</span>:<span class="hljs-number">5</span>,
  <span class="hljs-attr">jul</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">aug</span>:<span class="hljs-number">7</span>, <span class="hljs-attr">sep</span>:<span class="hljs-number">8</span>, <span class="hljs-attr">oct</span>:<span class="hljs-number">9</span>, <span class="hljs-attr">nov</span>:<span class="hljs-number">10</span>, <span class="hljs-attr">dec</span>:<span class="hljs-number">11</span>
};
<span class="hljs-keyword">var</span> NUM_TO_MONTH = [
  <span class="hljs-string">'Jan'</span>,<span class="hljs-string">'Feb'</span>,<span class="hljs-string">'Mar'</span>,<span class="hljs-string">'Apr'</span>,<span class="hljs-string">'May'</span>,<span class="hljs-string">'Jun'</span>,<span class="hljs-string">'Jul'</span>,<span class="hljs-string">'Aug'</span>,<span class="hljs-string">'Sep'</span>,<span class="hljs-string">'Oct'</span>,<span class="hljs-string">'Nov'</span>,<span class="hljs-string">'Dec'</span>
];
<span class="hljs-keyword">var</span> NUM_TO_DAY = [
  <span class="hljs-string">'Sun'</span>,<span class="hljs-string">'Mon'</span>,<span class="hljs-string">'Tue'</span>,<span class="hljs-string">'Wed'</span>,<span class="hljs-string">'Thu'</span>,<span class="hljs-string">'Fri'</span>,<span class="hljs-string">'Sat'</span>
];

<span class="hljs-keyword">var</span> YEAR = <span class="hljs-regexp">/^(\d{2}|\d{4})$/</span>; <span class="hljs-comment">// 2 to 4 digits</span>

<span class="hljs-keyword">var</span> MAX_TIME = <span class="hljs-number">2147483647000</span>; <span class="hljs-comment">// 31-bit max</span>
<span class="hljs-keyword">var</span> MIN_TIME = <span class="hljs-number">0</span>; <span class="hljs-comment">// 31-bit min</span>


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>RFC6265 S5.1.1 date parser:</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseDate</span>(<span class="hljs-params">str</span>) </span>{
  <span class="hljs-keyword">if</span> (!str) {
    <span class="hljs-keyword">return</span>;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<div class="dox">
<div class="summary">
<p>RFC6265 S5.1.1:</p>
<ol start="2">
<li>Process each date-token sequentially in the order the date-tokens
appear in the cookie-date</li>
</ol>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> tokens = str.split(DATE_DELIM);
  <span class="hljs-keyword">if</span> (!tokens) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">var</span> hour = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> minutes = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> seconds = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> day = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> month = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> year = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;tokens.length; i++) {
    <span class="hljs-keyword">var</span> token = tokens[i].trim();
    <span class="hljs-keyword">if</span> (!token.length) {
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-keyword">var</span> result;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<div class="dox">
<div class="summary">
<p>2.1. If the found-time flag is not set and the token matches the time
production, set the found-time flag and set the hour- value,
minute-value, and second-value to the numbers denoted by the digits in
the date-token, respectively.  Skip the remaining sub-steps and continue
to the next date-token.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (seconds === <span class="hljs-literal">null</span>) {
      result = TIME.exec(token);
      <span class="hljs-keyword">if</span> (result) {
        hour = <span class="hljs-built_in">parseInt</span>(result[<span class="hljs-number">1</span>], <span class="hljs-number">10</span>);
        minutes = <span class="hljs-built_in">parseInt</span>(result[<span class="hljs-number">2</span>], <span class="hljs-number">10</span>);
        seconds = <span class="hljs-built_in">parseInt</span>(result[<span class="hljs-number">3</span>], <span class="hljs-number">10</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<div class="dox">
<div class="summary">
<p>RFC6265 S5.1.1.5:
[fail if]</p>
<ul>
<li>the hour-value is greater than 23,</li>
<li>the minute-value is greater than 59, or</li>
<li>the second-value is greater than 59.</li>
</ul>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span>(hour &gt; <span class="hljs-number">23</span> || minutes &gt; <span class="hljs-number">59</span> || seconds &gt; <span class="hljs-number">59</span>) {
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">continue</span>;
      }
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<div class="dox">
<div class="summary">
<p>2.2. If the found-day-of-month flag is not set and the date-token matches
the day-of-month production, set the found-day-of- month flag and set
the day-of-month-value to the number denoted by the date-token.  Skip
the remaining sub-steps and continue to the next date-token.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (day === <span class="hljs-literal">null</span>) {
      result = DAY_OF_MONTH.exec(token);
      <span class="hljs-keyword">if</span> (result) {
        day = <span class="hljs-built_in">parseInt</span>(result, <span class="hljs-number">10</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<div class="dox">
<div class="summary">
<p>RFC6265 S5.1.1.5:
[fail if] the day-of-month-value is less than 1 or greater than 31</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span>(day &lt; <span class="hljs-number">1</span> || day &gt; <span class="hljs-number">31</span>) {
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">continue</span>;
      }
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<div class="dox">
<div class="summary">
<p>2.3. If the found-month flag is not set and the date-token matches the
month production, set the found-month flag and set the month-value to
the month denoted by the date-token.  Skip the remaining sub-steps and
continue to the next date-token.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (month === <span class="hljs-literal">null</span>) {
      result = MONTH.exec(token);
      <span class="hljs-keyword">if</span> (result) {
        month = MONTH_TO_NUM[result[<span class="hljs-number">1</span>].toLowerCase()];
        <span class="hljs-keyword">continue</span>;
      }
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<div class="dox">
<div class="summary">
<p>2.4. If the found-year flag is not set and the date-token matches the year
production, set the found-year flag and set the year-value to the number
denoted by the date-token.  Skip the remaining sub-steps and continue to
the next date-token.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (year === <span class="hljs-literal">null</span>) {
      result = YEAR.exec(token);
      <span class="hljs-keyword">if</span> (result) {
        year = <span class="hljs-built_in">parseInt</span>(result[<span class="hljs-number">0</span>], <span class="hljs-number">10</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<div class="dox">
<div class="summary">
<p>From S5.1.1:</p>
<ol start="3">
<li>If the year-value is greater than or equal to 70 and less
than or equal to 99, increment the year-value by 1900.</li>
<li>If the year-value is greater than or equal to 0 and less
than or equal to 69, increment the year-value by 2000.</li>
</ol>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (<span class="hljs-number">70</span> &lt;= year &amp;&amp; year &lt;= <span class="hljs-number">99</span>) {
          year += <span class="hljs-number">1900</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> &lt;= year &amp;&amp; year &lt;= <span class="hljs-number">69</span>) {
          year += <span class="hljs-number">2000</span>;
        }

        <span class="hljs-keyword">if</span> (year &lt; <span class="hljs-number">1601</span>) {
          <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 5. ... the year-value is less than 1601</span>
        }
      }
    }
  }

  <span class="hljs-keyword">if</span> (seconds === <span class="hljs-literal">null</span> || day === <span class="hljs-literal">null</span> || month === <span class="hljs-literal">null</span> || year === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 5. ... at least one of the found-day-of-month, found-month, found-</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>year, or found-time flags is not set,</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-built_in">Date</span>.UTC(year, month, day, hour, minutes, seconds));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">formatDate</span>(<span class="hljs-params">date</span>) </span>{
  <span class="hljs-keyword">var</span> d = date.getUTCDate(); d = d &gt;= <span class="hljs-number">10</span> ? d : <span class="hljs-string">'0'</span>+d;
  <span class="hljs-keyword">var</span> h = date.getUTCHours(); h = h &gt;= <span class="hljs-number">10</span> ? h : <span class="hljs-string">'0'</span>+h;
  <span class="hljs-keyword">var</span> m = date.getUTCMinutes(); m = m &gt;= <span class="hljs-number">10</span> ? m : <span class="hljs-string">'0'</span>+m;
  <span class="hljs-keyword">var</span> s = date.getUTCSeconds(); s = s &gt;= <span class="hljs-number">10</span> ? s : <span class="hljs-string">'0'</span>+s;
  <span class="hljs-keyword">return</span> NUM_TO_DAY[date.getUTCDay()] + <span class="hljs-string">', '</span> +
    d+<span class="hljs-string">' '</span>+ NUM_TO_MONTH[date.getUTCMonth()] +<span class="hljs-string">' '</span>+ date.getUTCFullYear() +<span class="hljs-string">' '</span>+
    h+<span class="hljs-string">':'</span>+m+<span class="hljs-string">':'</span>+s+<span class="hljs-string">' GMT'</span>;
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>S5.1.2 Canonicalized Host Names</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">canonicalDomain</span>(<span class="hljs-params">str</span>) </span>{
  <span class="hljs-keyword">if</span> (str == <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
  str = str.trim().replace(<span class="hljs-regexp">/^\./</span>,<span class="hljs-string">''</span>); <span class="hljs-comment">// S4.1.2.3 &amp; S5.2.3: ignore leading .</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>convert to IDN if any non-ASCII characters</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (punycode &amp;&amp; <span class="hljs-regexp">/[^\u0001-\u007f]/</span>.test(str)) {
    str = punycode.toASCII(str);
  }

  <span class="hljs-keyword">return</span> str.toLowerCase();
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>S5.1.3 Domain Matching</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">domainMatch</span>(<span class="hljs-params">str, domStr, canonicalize</span>) </span>{
  <span class="hljs-keyword">if</span> (str == <span class="hljs-literal">null</span> || domStr == <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
  <span class="hljs-keyword">if</span> (canonicalize !== <span class="hljs-literal">false</span>) {
    str = canonicalDomain(str);
    domStr = canonicalDomain(domStr);
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<div class="dox">
<div class="summary">
<p>&quot;The domain string and the string are identical. (Note that both the
domain string and the string will have been canonicalized to lower case at
this point)&quot;</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (str == domStr) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

  <span class="hljs-comment">/* "All of the following [three] conditions hold:" (order adjusted from the RFC) */</span>

  <span class="hljs-comment">/* "* The string is a host name (i.e., not an IP address)." */</span>
  <span class="hljs-keyword">if</span> (net.isIP(str)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">/* "* The domain string is a suffix of the string" */</span>
  <span class="hljs-keyword">var</span> idx = str.indexOf(domStr);
  <span class="hljs-keyword">if</span> (idx &lt;= <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// it's a non-match (-1) or prefix (0)</span>
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>e.g &quot;a.b.c&quot;.indexOf(&quot;b.c&quot;) === 2
5 === 3+2</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (str.length !== domStr.length + idx) { <span class="hljs-comment">// it's not a suffix</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<div class="dox">
<div class="summary">
<p>&quot;* The last character of the string that is not included in the domain
string is a %x2E (&quot;.&quot;) character.&quot;</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (str.substr(idx<span class="hljs-number">-1</span>,<span class="hljs-number">1</span>) !== <span class="hljs-string">'.'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>RFC6265 S5.1.4 Paths and Path-Match</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<div class="dox">
<div class="summary">
<p>&quot;The user agent MUST use an algorithm equivalent to the following algorithm
to compute the default-path of a cookie:&quot;</p>
</div>
<div class="body">
<p>Assumption: the path (and not query part or absolute uri) is passed in.</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">defaultPath</span>(<span class="hljs-params">path</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>&quot;2. If the uri-path is empty or if the first character of the uri-path is not
a %x2F (&quot;/&quot;) character, output %x2F (&quot;/&quot;) and skip the remaining steps.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!path || path.substr(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>) !== <span class="hljs-string">"/"</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"/"</span>;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>&quot;3. If the uri-path contains no more than one %x2F (&quot;/&quot;) character, output
%x2F (&quot;/&quot;) and skip the remaining step.&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (path === <span class="hljs-string">"/"</span>) {
    <span class="hljs-keyword">return</span> path;
  }

  <span class="hljs-keyword">var</span> rightSlash = path.lastIndexOf(<span class="hljs-string">"/"</span>);
  <span class="hljs-keyword">if</span> (rightSlash === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"/"</span>;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>&quot;4. Output the characters of the uri-path from the first character up to,
but not including, the right-most %x2F (&quot;/&quot;).&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">return</span> path.slice(<span class="hljs-number">0</span>, rightSlash);
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse</span>(<span class="hljs-params">str, options</span>) </span>{
  <span class="hljs-keyword">if</span> (!options || <span class="hljs-keyword">typeof</span> options !== <span class="hljs-string">'object'</span>) {
    options = {};
  }
  str = str.trim();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>S4.1.1 Trailing semi-colons are not part of the specification.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> semiColonCheck = TRAILING_SEMICOLON.exec(str);
  <span class="hljs-keyword">if</span> (semiColonCheck) {
    str = str.slice(<span class="hljs-number">0</span>, semiColonCheck.index);
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>We use a regex to parse the &quot;name-value-pair&quot; part of S5.2</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> firstSemi = str.indexOf(<span class="hljs-string">';'</span>); <span class="hljs-comment">// S5.2 step 1</span>
  <span class="hljs-keyword">var</span> pairRe = options.loose ? LOOSE_COOKIE_PAIR : COOKIE_PAIR;
  <span class="hljs-keyword">var</span> result = pairRe.exec(firstSemi === <span class="hljs-number">-1</span> ? str : str.substr(<span class="hljs-number">0</span>,firstSemi));

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>Rx satisfies the &quot;the name string is empty&quot; and &quot;lacks a %x3D (&quot;=&quot;)&quot;
constraints as well as trimming any whitespace.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!result) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">var</span> c = <span class="hljs-keyword">new</span> Cookie();
  <span class="hljs-keyword">if</span> (result[<span class="hljs-number">1</span>]) {
    c.key = result[<span class="hljs-number">2</span>].trim();
  } <span class="hljs-keyword">else</span> {
    c.key = <span class="hljs-string">''</span>;
  }
  c.value = result[<span class="hljs-number">3</span>].trim();
  <span class="hljs-keyword">if</span> (CONTROL_CHARS.test(c.key) || CONTROL_CHARS.test(c.value)) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">if</span> (firstSemi === <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">return</span> c;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>S5.2.3 &quot;unparsed-attributes consist of the remainder of the set-cookie-string
(including the %x3B (&quot;;&quot;) in question).&quot; plus later on in the same section
&quot;discard the first &quot;;&quot; and trim&quot;.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> unparsed = str.slice(firstSemi).replace(<span class="hljs-regexp">/^\s*;\s*/</span>,<span class="hljs-string">''</span>).trim();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>&quot;If the unparsed-attributes string is empty, skip the rest of these
steps.&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (unparsed.length === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> c;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<div class="dox">
<div class="summary">
<p>S5.2 says that when looping over the items &quot;[p]rocess the attribute-name
and attribute-value according to the requirements in the following
subsections&quot; for every item.  Plus, for many of the individual attributes
in S5.3 it says to use the &quot;attribute-value of the last attribute in the
cookie-attribute-list&quot;.  Therefore, in this implementation, we overwrite
the previous value.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> cookie_avs = unparsed.split(<span class="hljs-regexp">/\s*;\s*/</span>);
  <span class="hljs-keyword">while</span> (cookie_avs.length) {
    <span class="hljs-keyword">var</span> av = cookie_avs.shift();
    <span class="hljs-keyword">var</span> av_sep = av.indexOf(<span class="hljs-string">'='</span>);
    <span class="hljs-keyword">var</span> av_key, av_value;

    <span class="hljs-keyword">if</span> (av_sep === <span class="hljs-number">-1</span>) {
      av_key = av;
      av_value = <span class="hljs-literal">null</span>;
    } <span class="hljs-keyword">else</span> {
      av_key = av.substr(<span class="hljs-number">0</span>,av_sep);
      av_value = av.substr(av_sep+<span class="hljs-number">1</span>);
    }

    av_key = av_key.trim().toLowerCase();

    <span class="hljs-keyword">if</span> (av_value) {
      av_value = av_value.trim();
    }

    <span class="hljs-keyword">switch</span>(av_key) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'expires'</span>: <span class="hljs-comment">// S5.2.1</span>
      <span class="hljs-keyword">if</span> (av_value) {
        <span class="hljs-keyword">var</span> exp = parseDate(av_value);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>&quot;If the attribute-value failed to parse as a cookie date, ignore the
cookie-av.&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (exp) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>over and underflow not realistically a concern: V8's getTime() seems to
store something larger than a 32-bit time_t (even with 32-bit node)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          c.expires = exp;
        }
      }
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">'max-age'</span>: <span class="hljs-comment">// S5.2.2</span>
      <span class="hljs-keyword">if</span> (av_value) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<p>&quot;If the first character of the attribute-value is not a DIGIT or a &quot;-&quot;
character ...[or]... If the remainder of attribute-value contains a
non-DIGIT character, ignore the cookie-av.&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^-?[0-9]+$/</span>.test(av_value)) {
          <span class="hljs-keyword">var</span> delta = <span class="hljs-built_in">parseInt</span>(av_value, <span class="hljs-number">10</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>&quot;If delta-seconds is less than or equal to zero (0), let expiry-time
be the earliest representable date and time.&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          c.setMaxAge(delta);
        }
      }
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">'domain'</span>: <span class="hljs-comment">// S5.2.3</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<p>&quot;If the attribute-value is empty, the behavior is undefined.  However,
the user agent SHOULD ignore the cookie-av entirely.&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (av_value) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39"></a>
</div>
<p>S5.2.3 &quot;Let cookie-domain be the attribute-value without the leading %x2E
(&quot;.&quot;) character.&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">var</span> domain = av_value.trim().replace(<span class="hljs-regexp">/^\./</span>, <span class="hljs-string">''</span>);
        <span class="hljs-keyword">if</span> (domain) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40"></a>
</div>
<p>&quot;Convert the cookie-domain to lower case.&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          c.domain = domain.toLowerCase();
        }
      }
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">'path'</span>: <span class="hljs-comment">// S5.2.4</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41"></a>
</div>
<div class="dox">
<div class="summary">
<p>&quot;If the attribute-value is empty or if the first character of the
attribute-value is not %x2F (&quot;/&quot;):
Let cookie-path be the default-path.
Otherwise:
Let cookie-path be the attribute-value.&quot;</p>
</div>
<div class="body">
<p>We'll represent the default-path as null since it depends on the
context of the parsing.</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">      c.path = av_value &amp;&amp; av_value[<span class="hljs-number">0</span>] === <span class="hljs-string">"/"</span> ? av_value : <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">'secure'</span>: <span class="hljs-comment">// S5.2.5</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42"></a>
</div>
<div class="dox">
<div class="summary">
<p>&quot;If the attribute-name case-insensitively matches the string &quot;Secure&quot;,
the user agent MUST append an attribute to the cookie-attribute-list
with an attribute-name of Secure and an empty attribute-value.&quot;</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">      c.secure = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">'httponly'</span>: <span class="hljs-comment">// S5.2.6 -- effectively the same as 'secure'</span>
      c.httpOnly = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">default</span>:
      c.extensions = c.extensions || [];
      c.extensions.push(av);
      <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-keyword">return</span> c;
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43"></a>
</div>
<p>avoid the V8 deoptimization monster!</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">jsonParse</span>(<span class="hljs-params">str</span>) </span>{
  <span class="hljs-keyword">var</span> obj;
  <span class="hljs-keyword">try</span> {
    obj = <span class="hljs-built_in">JSON</span>.parse(str);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">return</span> e;
  }
  <span class="hljs-keyword">return</span> obj;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fromJSON</span>(<span class="hljs-params">str</span>) </span>{
  <span class="hljs-keyword">if</span> (!str) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  <span class="hljs-keyword">var</span> obj;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> str === <span class="hljs-string">'string'</span>) {
    obj = jsonParse(str);
    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
  } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44"></a>
</div>
<p>assume it's an Object</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    obj = str;
  }

  <span class="hljs-keyword">var</span> c = <span class="hljs-keyword">new</span> Cookie();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;Cookie.serializableProperties.length; i++) {
    <span class="hljs-keyword">var</span> prop = Cookie.serializableProperties[i];
    <span class="hljs-keyword">if</span> (obj[prop] === <span class="hljs-literal">undefined</span> ||
        obj[prop] === Cookie.prototype[prop])
    {
      <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// leave as prototype default</span>
    }

    <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">'expires'</span> ||
        prop === <span class="hljs-string">'creation'</span> ||
        prop === <span class="hljs-string">'lastAccessed'</span>)
    {
      <span class="hljs-keyword">if</span> (obj[prop] === <span class="hljs-literal">null</span>) {
        c[prop] = <span class="hljs-literal">null</span>;
      } <span class="hljs-keyword">else</span> {
        c[prop] = obj[prop] == <span class="hljs-string">"Infinity"</span> ?
          <span class="hljs-string">"Infinity"</span> : <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(obj[prop]);
      }
    } <span class="hljs-keyword">else</span> {
      c[prop] = obj[prop];
    }
  }

  <span class="hljs-keyword">return</span> c;
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45"></a>
</div>
<div class="dox">
<div class="summary">
<p>Section 5.4 part 2:
&quot;*  Cookies with longer paths are listed before cookies with
shorter paths.</p>
</div>
<div class="body">
<ul>
<li>Among cookies that have equal-length path fields, cookies with
earlier creation-times are listed before cookies with later
creation-times.&quot;</li>
</ul>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cookieCompare</span>(<span class="hljs-params">a,b</span>) </span>{
  <span class="hljs-keyword">var</span> cmp = <span class="hljs-number">0</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46"></a>
</div>
<p>descending for length: b CMP a</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> aPathLen = a.path ? a.path.length : <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> bPathLen = b.path ? b.path.length : <span class="hljs-number">0</span>;
  cmp = bPathLen - aPathLen;
  <span class="hljs-keyword">if</span> (cmp !== <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> cmp;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47"></a>
</div>
<p>ascending for time: a CMP b</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> aTime = a.creation ? a.creation.getTime() : MAX_TIME;
  <span class="hljs-keyword">var</span> bTime = b.creation ? b.creation.getTime() : MAX_TIME;
  cmp = aTime - bTime;
  <span class="hljs-keyword">if</span> (cmp !== <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> cmp;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48"></a>
</div>
<p>break ties for the same millisecond (precision of JavaScript's clock)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  cmp = a.creationIndex - b.creationIndex;

  <span class="hljs-keyword">return</span> cmp;
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49"></a>
</div>
<p>Gives the permutation of all possible pathMatch()es of a given path. The
array is in longest-to-shortest order.  Handy for indexing.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">permutePath</span>(<span class="hljs-params">path</span>) </span>{
  <span class="hljs-keyword">if</span> (path === <span class="hljs-string">'/'</span>) {
    <span class="hljs-keyword">return</span> [<span class="hljs-string">'/'</span>];
  }
  <span class="hljs-keyword">if</span> (path.lastIndexOf(<span class="hljs-string">'/'</span>) === path.length<span class="hljs-number">-1</span>) {
    path = path.substr(<span class="hljs-number">0</span>,path.length<span class="hljs-number">-1</span>);
  }
  <span class="hljs-keyword">var</span> permutations = [path];
  <span class="hljs-keyword">while</span> (path.length &gt; <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">var</span> lindex = path.lastIndexOf(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">if</span> (lindex === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">break</span>;
    }
    path = path.substr(<span class="hljs-number">0</span>,lindex);
    permutations.push(path);
  }
  permutations.push(<span class="hljs-string">'/'</span>);
  <span class="hljs-keyword">return</span> permutations;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCookieContext</span>(<span class="hljs-params">url</span>) </span>{
  <span class="hljs-keyword">if</span> (url <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Object</span>) {
    <span class="hljs-keyword">return</span> url;
  }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50"></a>
</div>
<p>NOTE: decodeURI will throw on malformed URIs (see GH-32).
Therefore, we will just skip decoding for such URIs.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">try</span> {
    url = <span class="hljs-built_in">decodeURI</span>(url);
  }
  <span class="hljs-keyword">catch</span>(err) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51"></a>
</div>
<p>Silently swallow error</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  }

  <span class="hljs-keyword">return</span> urlParse(url);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Cookie</span>(<span class="hljs-params">options</span>) </span>{
  options = options || {};

  <span class="hljs-built_in">Object</span>.keys(options).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">prop</span>) </span>{
    <span class="hljs-keyword">if</span> (Cookie.prototype.hasOwnProperty(prop) &amp;&amp;
        Cookie.prototype[prop] !== options[prop] &amp;&amp;
        prop.substr(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>) !== <span class="hljs-string">'_'</span>)
    {
      <span class="hljs-keyword">this</span>[prop] = options[prop];
    }
  }, <span class="hljs-keyword">this</span>);

  <span class="hljs-keyword">this</span>.creation = <span class="hljs-keyword">this</span>.creation || <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52"></a>
</div>
<p>used to break creation ties in cookieCompare():</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-built_in">Object</span>.defineProperty(<span class="hljs-keyword">this</span>, <span class="hljs-string">'creationIndex'</span>, {
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// important for assert.deepEqual checks</span>
    writable: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">value</span>: ++Cookie.cookiesCreated
  });
}

Cookie.cookiesCreated = <span class="hljs-number">0</span>; <span class="hljs-comment">// incremented each time a cookie is created</span>

Cookie.parse = parse;
Cookie.fromJSON = fromJSON;

Cookie.prototype.key = <span class="hljs-string">""</span>;
Cookie.prototype.value = <span class="hljs-string">""</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53"></a>
</div>
<p>the order in which the RFC has them:</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">Cookie.prototype.expires = <span class="hljs-string">"Infinity"</span>; <span class="hljs-comment">// coerces to literal Infinity</span>
Cookie.prototype.maxAge = <span class="hljs-literal">null</span>; <span class="hljs-comment">// takes precedence over expires for TTL</span>
Cookie.prototype.domain = <span class="hljs-literal">null</span>;
Cookie.prototype.path = <span class="hljs-literal">null</span>;
Cookie.prototype.secure = <span class="hljs-literal">false</span>;
Cookie.prototype.httpOnly = <span class="hljs-literal">false</span>;
Cookie.prototype.extensions = <span class="hljs-literal">null</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54"></a>
</div>
<p>set by the CookieJar:</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">Cookie.prototype.hostOnly = <span class="hljs-literal">null</span>; <span class="hljs-comment">// boolean when set</span>
Cookie.prototype.pathIsDefault = <span class="hljs-literal">null</span>; <span class="hljs-comment">// boolean when set</span>
Cookie.prototype.creation = <span class="hljs-literal">null</span>; <span class="hljs-comment">// Date when set; defaulted by Cookie.parse</span>
Cookie.prototype.lastAccessed = <span class="hljs-literal">null</span>; <span class="hljs-comment">// Date when set</span>
<span class="hljs-built_in">Object</span>.defineProperty(Cookie.prototype, <span class="hljs-string">'creationIndex'</span>, {
  <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">value</span>: <span class="hljs-number">0</span>
});

Cookie.serializableProperties = <span class="hljs-built_in">Object</span>.keys(Cookie.prototype)
  .filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">prop</span>) </span>{
    <span class="hljs-keyword">return</span> !(
      Cookie.prototype[prop] <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Function</span> ||
      prop === <span class="hljs-string">'creationIndex'</span> ||
      prop.substr(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>) === <span class="hljs-string">'_'</span>
    );
  });

Cookie.prototype.inspect = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">inspect</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> now = <span class="hljs-built_in">Date</span>.now();
  <span class="hljs-keyword">return</span> <span class="hljs-string">'Cookie="'</span>+<span class="hljs-keyword">this</span>.toString() +
    <span class="hljs-string">'; hostOnly='</span>+(<span class="hljs-keyword">this</span>.hostOnly != <span class="hljs-literal">null</span> ? <span class="hljs-keyword">this</span>.hostOnly : <span class="hljs-string">'?'</span>) +
    <span class="hljs-string">'; aAge='</span>+(<span class="hljs-keyword">this</span>.lastAccessed ? (now-<span class="hljs-keyword">this</span>.lastAccessed.getTime())+<span class="hljs-string">'ms'</span> : <span class="hljs-string">'?'</span>) +
    <span class="hljs-string">'; cAge='</span>+(<span class="hljs-keyword">this</span>.creation ? (now-<span class="hljs-keyword">this</span>.creation.getTime())+<span class="hljs-string">'ms'</span> : <span class="hljs-string">'?'</span>) +
    <span class="hljs-string">'"'</span>;
};

Cookie.prototype.toJSON = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> obj = {};

  <span class="hljs-keyword">var</span> props = Cookie.serializableProperties;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;props.length; i++) {
    <span class="hljs-keyword">var</span> prop = props[i];
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>[prop] === Cookie.prototype[prop]) {
      <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// leave as prototype default</span>
    }

    <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">'expires'</span> ||
        prop === <span class="hljs-string">'creation'</span> ||
        prop === <span class="hljs-string">'lastAccessed'</span>)
    {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>[prop] === <span class="hljs-literal">null</span>) {
        obj[prop] = <span class="hljs-literal">null</span>;
      } <span class="hljs-keyword">else</span> {
        obj[prop] = <span class="hljs-keyword">this</span>[prop] == <span class="hljs-string">"Infinity"</span> ? <span class="hljs-comment">// intentionally not ===</span>
          <span class="hljs-string">"Infinity"</span> : <span class="hljs-keyword">this</span>[prop].toISOString();
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">'maxAge'</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>[prop] !== <span class="hljs-literal">null</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55"></a>
</div>
<p>again, intentionally not ===</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        obj[prop] = (<span class="hljs-keyword">this</span>[prop] == <span class="hljs-literal">Infinity</span> || <span class="hljs-keyword">this</span>[prop] == -<span class="hljs-literal">Infinity</span>) ?
          <span class="hljs-keyword">this</span>[prop].toString() : <span class="hljs-keyword">this</span>[prop];
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>[prop] !== Cookie.prototype[prop]) {
        obj[prop] = <span class="hljs-keyword">this</span>[prop];
      }
    }
  }

  <span class="hljs-keyword">return</span> obj;
};

Cookie.prototype.clone = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> fromJSON(<span class="hljs-keyword">this</span>.toJSON());
};

Cookie.prototype.validate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validate</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (!COOKIE_OCTETS.test(<span class="hljs-keyword">this</span>.value)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.expires != <span class="hljs-literal">Infinity</span> &amp;&amp; !(<span class="hljs-keyword">this</span>.expires <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Date</span>) &amp;&amp; !parseDate(<span class="hljs-keyword">this</span>.expires)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.maxAge != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">this</span>.maxAge &lt;= <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// "Max-Age=" non-zero-digit *DIGIT</span>
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.path != <span class="hljs-literal">null</span> &amp;&amp; !PATH_VALUE.test(<span class="hljs-keyword">this</span>.path)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">var</span> cdomain = <span class="hljs-keyword">this</span>.cdomain();
  <span class="hljs-keyword">if</span> (cdomain) {
    <span class="hljs-keyword">if</span> (cdomain.match(<span class="hljs-regexp">/\.$/</span>)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// S4.1.2.3 suggests that this is bad. domainMatch() tests confirm this</span>
    }
    <span class="hljs-keyword">var</span> suffix = pubsuffix.getPublicSuffix(cdomain);
    <span class="hljs-keyword">if</span> (suffix == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// it's a public suffix</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};

Cookie.prototype.setExpires = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setExpires</span>(<span class="hljs-params">exp</span>) </span>{
  <span class="hljs-keyword">if</span> (exp <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Date</span>) {
    <span class="hljs-keyword">this</span>.expires = exp;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>.expires = parseDate(exp) || <span class="hljs-string">"Infinity"</span>;
  }
};

Cookie.prototype.setMaxAge = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setMaxAge</span>(<span class="hljs-params">age</span>) </span>{
  <span class="hljs-keyword">if</span> (age === <span class="hljs-literal">Infinity</span> || age === -<span class="hljs-literal">Infinity</span>) {
    <span class="hljs-keyword">this</span>.maxAge = age.toString(); <span class="hljs-comment">// so JSON.stringify() works</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>.maxAge = age;
  }
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56"></a>
</div>
<p>gives Cookie header format</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">Cookie.prototype.cookieString = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cookieString</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> val = <span class="hljs-keyword">this</span>.value;
  <span class="hljs-keyword">if</span> (val == <span class="hljs-literal">null</span>) {
    val = <span class="hljs-string">''</span>;
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.key === <span class="hljs-string">''</span>) {
    <span class="hljs-keyword">return</span> val;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.key+<span class="hljs-string">'='</span>+val;
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57"></a>
</div>
<p>gives Set-Cookie header format</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">Cookie.prototype.toString = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toString</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> str = <span class="hljs-keyword">this</span>.cookieString();

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.expires != <span class="hljs-literal">Infinity</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.expires <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Date</span>) {
      str += <span class="hljs-string">'; Expires='</span>+formatDate(<span class="hljs-keyword">this</span>.expires);
    } <span class="hljs-keyword">else</span> {
      str += <span class="hljs-string">'; Expires='</span>+<span class="hljs-keyword">this</span>.expires;
    }
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.maxAge != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">this</span>.maxAge != <span class="hljs-literal">Infinity</span>) {
    str += <span class="hljs-string">'; Max-Age='</span>+<span class="hljs-keyword">this</span>.maxAge;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.domain &amp;&amp; !<span class="hljs-keyword">this</span>.hostOnly) {
    str += <span class="hljs-string">'; Domain='</span>+<span class="hljs-keyword">this</span>.domain;
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.path) {
    str += <span class="hljs-string">'; Path='</span>+<span class="hljs-keyword">this</span>.path;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.secure) {
    str += <span class="hljs-string">'; Secure'</span>;
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.httpOnly) {
    str += <span class="hljs-string">'; HttpOnly'</span>;
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.extensions) {
    <span class="hljs-keyword">this</span>.extensions.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ext</span>) </span>{
      str += <span class="hljs-string">'; '</span>+ext;
    });
  }

  <span class="hljs-keyword">return</span> str;
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-58" id="section-58"></a>
</div>
<p>TTL() partially replaces the &quot;expiry-time&quot; parts of S5.3 step 3 (setCookie()
elsewhere)
S5.3 says to give the &quot;latest representable date&quot; for which we use Infinity
For &quot;expired&quot; we use 0</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">Cookie.prototype.TTL = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TTL</span>(<span class="hljs-params">now</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59"></a>
</div>
<div class="dox">
<div class="summary">
<p>RFC6265 S4.1.2.2 If a cookie has both the Max-Age and the Expires
attribute, the Max-Age attribute has precedence and controls the
expiration date of the cookie.
(Concurs with S5.3 step 3)</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.maxAge != <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.maxAge&lt;=<span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-keyword">this</span>.maxAge*<span class="hljs-number">1000</span>;
  }

  <span class="hljs-keyword">var</span> expires = <span class="hljs-keyword">this</span>.expires;
  <span class="hljs-keyword">if</span> (expires != <span class="hljs-literal">Infinity</span>) {
    <span class="hljs-keyword">if</span> (!(expires <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Date</span>)) {
      expires = parseDate(expires) || <span class="hljs-literal">Infinity</span>;
    }

    <span class="hljs-keyword">if</span> (expires == <span class="hljs-literal">Infinity</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">Infinity</span>;
    }

    <span class="hljs-keyword">return</span> expires.getTime() - (now || <span class="hljs-built_in">Date</span>.now());
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">Infinity</span>;
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60"></a>
</div>
<p>expiryTime() replaces the &quot;expiry-time&quot; parts of S5.3 step 3 (setCookie()
elsewhere)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">Cookie.prototype.expiryTime = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">expiryTime</span>(<span class="hljs-params">now</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.maxAge != <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">var</span> relativeTo = now || <span class="hljs-keyword">this</span>.creation || <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
    <span class="hljs-keyword">var</span> age = (<span class="hljs-keyword">this</span>.maxAge &lt;= <span class="hljs-number">0</span>) ? -<span class="hljs-literal">Infinity</span> : <span class="hljs-keyword">this</span>.maxAge*<span class="hljs-number">1000</span>;
    <span class="hljs-keyword">return</span> relativeTo.getTime() + age;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.expires == <span class="hljs-literal">Infinity</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">Infinity</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.expires.getTime();
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61"></a>
</div>
<p>expiryDate() replaces the &quot;expiry-time&quot; parts of S5.3 step 3 (setCookie()
elsewhere), except it returns a Date</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">Cookie.prototype.expiryDate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">expiryDate</span>(<span class="hljs-params">now</span>) </span>{
  <span class="hljs-keyword">var</span> millisec = <span class="hljs-keyword">this</span>.expiryTime(now);
  <span class="hljs-keyword">if</span> (millisec == <span class="hljs-literal">Infinity</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(MAX_TIME);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (millisec == -<span class="hljs-literal">Infinity</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(MIN_TIME);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(millisec);
  }
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62"></a>
</div>
<p>This replaces the &quot;persistent-flag&quot; parts of S5.3 step 3</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">Cookie.prototype.isPersistent = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isPersistent</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">this</span>.maxAge != <span class="hljs-literal">null</span> || <span class="hljs-keyword">this</span>.expires != <span class="hljs-literal">Infinity</span>);
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63"></a>
</div>
<p>Mostly S5.1.2 and S5.2.3:</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">Cookie.prototype.cdomain =
Cookie.prototype.canonicalizedDomain = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">canonicalizedDomain</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.domain == <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
  <span class="hljs-keyword">return</span> canonicalDomain(<span class="hljs-keyword">this</span>.domain);
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">CookieJar</span>(<span class="hljs-params">store, options</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">"boolean"</span>) {
    options = {<span class="hljs-attr">rejectPublicSuffixes</span>: options};
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options == <span class="hljs-literal">null</span>) {
    options = {};
  }
  <span class="hljs-keyword">if</span> (options.rejectPublicSuffixes != <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">this</span>.rejectPublicSuffixes = options.rejectPublicSuffixes;
  }
  <span class="hljs-keyword">if</span> (options.looseMode != <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">this</span>.enableLooseMode = options.looseMode;
  }

  <span class="hljs-keyword">if</span> (!store) {
    store = <span class="hljs-keyword">new</span> MemoryCookieStore();
  }
  <span class="hljs-keyword">this</span>.store = store;
}
CookieJar.prototype.store = <span class="hljs-literal">null</span>;
CookieJar.prototype.rejectPublicSuffixes = <span class="hljs-literal">true</span>;
CookieJar.prototype.enableLooseMode = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">var</span> CAN_BE_SYNC = [];

CAN_BE_SYNC.push(<span class="hljs-string">'setCookie'</span>);
CookieJar.prototype.setCookie = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cookie, url, options, cb</span>) </span>{
  <span class="hljs-keyword">var</span> err;
  <span class="hljs-keyword">var</span> context = getCookieContext(url);
  <span class="hljs-keyword">if</span> (options <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Function</span>) {
    cb = options;
    options = {};
  }

  <span class="hljs-keyword">var</span> host = canonicalDomain(context.hostname);
  <span class="hljs-keyword">var</span> loose = <span class="hljs-keyword">this</span>.enableLooseMode;
  <span class="hljs-keyword">if</span> (options.loose != <span class="hljs-literal">null</span>) {
    loose = options.loose;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-64" id="section-64"></a>
</div>
<p>S5.3 step 1</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!(cookie <span class="hljs-keyword">instanceof</span> Cookie)) {
    cookie = Cookie.parse(cookie, { <span class="hljs-attr">loose</span>: loose });
  }
  <span class="hljs-keyword">if</span> (!cookie) {
    err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cookie failed to parse"</span>);
    <span class="hljs-keyword">return</span> cb(options.ignoreError ? <span class="hljs-literal">null</span> : err);
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-65" id="section-65"></a>
</div>
<p>S5.3 step 2</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> now = options.now || <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(); <span class="hljs-comment">// will assign later to save effort in the face of errors</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66"></a>
</div>
<p>S5.3 step 3: NOOP; persistent-flag and expiry-time is handled by getCookie()</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67"></a>
</div>
<p>S5.3 step 4: NOOP; domain is null by default</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-68" id="section-68"></a>
</div>
<p>S5.3 step 5: public suffixes</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.rejectPublicSuffixes &amp;&amp; cookie.domain) {
    <span class="hljs-keyword">var</span> suffix = pubsuffix.getPublicSuffix(cookie.cdomain());
    <span class="hljs-keyword">if</span> (suffix == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// e.g. "com"</span>
      err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cookie has domain set to a public suffix"</span>);
      <span class="hljs-keyword">return</span> cb(options.ignoreError ? <span class="hljs-literal">null</span> : err);
    }
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-69" id="section-69"></a>
</div>
<p>S5.3 step 6:</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (cookie.domain) {
    <span class="hljs-keyword">if</span> (!domainMatch(host, cookie.cdomain(), <span class="hljs-literal">false</span>)) {
      err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cookie not in this host's domain. Cookie:"</span>+cookie.cdomain()+<span class="hljs-string">" Request:"</span>+host);
      <span class="hljs-keyword">return</span> cb(options.ignoreError ? <span class="hljs-literal">null</span> : err);
    }

    <span class="hljs-keyword">if</span> (cookie.hostOnly == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// don't reset if already set</span>
      cookie.hostOnly = <span class="hljs-literal">false</span>;
    }

  } <span class="hljs-keyword">else</span> {
    cookie.hostOnly = <span class="hljs-literal">true</span>;
    cookie.domain = host;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-70" id="section-70"></a>
</div>
<p>S5.2.4 If the attribute-value is empty or if the first character of the
attribute-value is not %x2F (&quot;/&quot;):
Let cookie-path be the default-path.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!cookie.path || cookie.path[<span class="hljs-number">0</span>] !== <span class="hljs-string">'/'</span>) {
    cookie.path = defaultPath(context.pathname);
    cookie.pathIsDefault = <span class="hljs-literal">true</span>;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-71" id="section-71"></a>
</div>
<p>S5.3 step 8: NOOP; secure attribute
S5.3 step 9: NOOP; httpOnly attribute</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-72" id="section-72"></a>
</div>
<p>S5.3 step 10</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (options.http === <span class="hljs-literal">false</span> &amp;&amp; cookie.httpOnly) {
    err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cookie is HttpOnly and this isn't an HTTP API"</span>);
    <span class="hljs-keyword">return</span> cb(options.ignoreError ? <span class="hljs-literal">null</span> : err);
  }

  <span class="hljs-keyword">var</span> store = <span class="hljs-keyword">this</span>.store;

  <span class="hljs-keyword">if</span> (!store.updateCookie) {
    store.updateCookie = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">oldCookie, newCookie, cb</span>) </span>{
      <span class="hljs-keyword">this</span>.putCookie(newCookie, cb);
    };
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">withCookie</span>(<span class="hljs-params">err, oldCookie</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-keyword">return</span> cb(err);
    }

    <span class="hljs-keyword">var</span> next = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">return</span> cb(err);
      } <span class="hljs-keyword">else</span> {
        cb(<span class="hljs-literal">null</span>, cookie);
      }
    };

    <span class="hljs-keyword">if</span> (oldCookie) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-73" id="section-73"></a>
</div>
<p>S5.3 step 11 - &quot;If the cookie store contains a cookie with the same name,
domain, and path as the newly created cookie:&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (options.http === <span class="hljs-literal">false</span> &amp;&amp; oldCookie.httpOnly) { <span class="hljs-comment">// step 11.2</span>
        err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"old Cookie is HttpOnly and this isn't an HTTP API"</span>);
        <span class="hljs-keyword">return</span> cb(options.ignoreError ? <span class="hljs-literal">null</span> : err);
      }
      cookie.creation = oldCookie.creation; <span class="hljs-comment">// step 11.3</span>
      cookie.creationIndex = oldCookie.creationIndex; <span class="hljs-comment">// preserve tie-breaker</span>
      cookie.lastAccessed = now;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-74" id="section-74"></a>
</div>
<p>Step 11.4 (delete cookie) is implied by just setting the new one:</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      store.updateCookie(oldCookie, cookie, next); <span class="hljs-comment">// step 12</span>

    } <span class="hljs-keyword">else</span> {
      cookie.creation = cookie.lastAccessed = now;
      store.putCookie(cookie, next); <span class="hljs-comment">// step 12</span>
    }
  }

  store.findCookie(cookie.domain, cookie.path, cookie.key, withCookie);
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-75" id="section-75"></a>
</div>
<p>RFC6365 S5.4</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">CAN_BE_SYNC.push(<span class="hljs-string">'getCookies'</span>);
CookieJar.prototype.getCookies = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">url, options, cb</span>) </span>{
  <span class="hljs-keyword">var</span> context = getCookieContext(url);
  <span class="hljs-keyword">if</span> (options <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Function</span>) {
    cb = options;
    options = {};
  }

  <span class="hljs-keyword">var</span> host = canonicalDomain(context.hostname);
  <span class="hljs-keyword">var</span> path = context.pathname || <span class="hljs-string">'/'</span>;

  <span class="hljs-keyword">var</span> secure = options.secure;
  <span class="hljs-keyword">if</span> (secure == <span class="hljs-literal">null</span> &amp;&amp; context.protocol &amp;&amp;
      (context.protocol == <span class="hljs-string">'https:'</span> || context.protocol == <span class="hljs-string">'wss:'</span>))
  {
    secure = <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">var</span> http = options.http;
  <span class="hljs-keyword">if</span> (http == <span class="hljs-literal">null</span>) {
    http = <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">var</span> now = options.now || <span class="hljs-built_in">Date</span>.now();
  <span class="hljs-keyword">var</span> expireCheck = options.expire !== <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> allPaths = !!options.allPaths;
  <span class="hljs-keyword">var</span> store = <span class="hljs-keyword">this</span>.store;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">matchingCookie</span>(<span class="hljs-params">c</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-76" id="section-76"></a>
</div>
<p>&quot;Either:
The cookie's host-only-flag is true and the canonicalized
request-host is identical to the cookie's domain.
Or:
The cookie's host-only-flag is false and the canonicalized
request-host domain-matches the cookie's domain.&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (c.hostOnly) {
      <span class="hljs-keyword">if</span> (c.domain != host) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (!domainMatch(host, c.domain, <span class="hljs-literal">false</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-77" id="section-77"></a>
</div>
<p>&quot;The request-uri's path path-matches the cookie's path.&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (!allPaths &amp;&amp; !pathMatch(path, c.path)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-78" id="section-78"></a>
</div>
<p>&quot;If the cookie's secure-only-flag is true, then the request-uri's
scheme must denote a &quot;secure&quot; protocol&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (c.secure &amp;&amp; !secure) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-79" id="section-79"></a>
</div>
<p>&quot;If the cookie's http-only-flag is true, then exclude the cookie if the
cookie-string is being generated for a &quot;non-HTTP&quot; API&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (c.httpOnly &amp;&amp; !http) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-80" id="section-80"></a>
</div>
<p>deferred from S5.3
non-RFC: allow retention of expired cookies by choice</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (expireCheck &amp;&amp; c.expiryTime() &lt;= now) {
      store.removeCookie(c.domain, c.path, c.key, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{}); <span class="hljs-comment">// result ignored</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

  store.findCookies(host, allPaths ? <span class="hljs-literal">null</span> : path, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,cookies</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-keyword">return</span> cb(err);
    }

    cookies = cookies.filter(matchingCookie);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-81" id="section-81"></a>
</div>
<p>sorting of S5.4 part 2</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (options.sort !== <span class="hljs-literal">false</span>) {
      cookies = cookies.sort(cookieCompare);
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-82" id="section-82"></a>
</div>
<p>S5.4 part 3</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
    cookies.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>{
      c.lastAccessed = now;
    });
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-83" id="section-83"></a>
</div>
<p>TODO persist lastAccessed</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    cb(<span class="hljs-literal">null</span>,cookies);
  });
};

CAN_BE_SYNC.push(<span class="hljs-string">'getCookieString'</span>);
CookieJar.prototype.getCookieString = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-regexp">/*..., cb*/</span></span>) </span>{
  <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">0</span>);
  <span class="hljs-keyword">var</span> cb = args.pop();
  <span class="hljs-keyword">var</span> next = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,cookies</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      cb(err);
    } <span class="hljs-keyword">else</span> {
      cb(<span class="hljs-literal">null</span>, cookies
        .sort(cookieCompare)
        .map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>)</span>{
          <span class="hljs-keyword">return</span> c.cookieString();
        })
        .join(<span class="hljs-string">'; '</span>));
    }
  };
  args.push(next);
  <span class="hljs-keyword">this</span>.getCookies.apply(<span class="hljs-keyword">this</span>,args);
};

CAN_BE_SYNC.push(<span class="hljs-string">'getSetCookieStrings'</span>);
CookieJar.prototype.getSetCookieStrings = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-regexp">/*..., cb*/</span></span>) </span>{
  <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">0</span>);
  <span class="hljs-keyword">var</span> cb = args.pop();
  <span class="hljs-keyword">var</span> next = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,cookies</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      cb(err);
    } <span class="hljs-keyword">else</span> {
      cb(<span class="hljs-literal">null</span>, cookies.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>)</span>{
        <span class="hljs-keyword">return</span> c.toString();
      }));
    }
  };
  args.push(next);
  <span class="hljs-keyword">this</span>.getCookies.apply(<span class="hljs-keyword">this</span>,args);
};

CAN_BE_SYNC.push(<span class="hljs-string">'serialize'</span>);
CookieJar.prototype.serialize = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>) </span>{
  <span class="hljs-keyword">var</span> type = <span class="hljs-keyword">this</span>.store.constructor.name;
  <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'Object'</span>) {
    type = <span class="hljs-literal">null</span>;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-84" id="section-84"></a>
</div>
<p>update README.md &quot;Serialization Format&quot; if you change this, please!</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> serialized = {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-85" id="section-85"></a>
</div>
<p>The version of tough-cookie that serialized this jar. Generally a good
practice since future versions can make data import decisions based on
known past behavior. When/if this matters, use <code>semver</code>.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    version: <span class="hljs-string">'tough-cookie@'</span>+VERSION,

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-86" id="section-86"></a>
</div>
<p>add the store type, to make humans happy:</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    storeType: type,

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-87" id="section-87"></a>
</div>
<p>CookieJar configuration:</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    rejectPublicSuffixes: !!<span class="hljs-keyword">this</span>.rejectPublicSuffixes,

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-88" id="section-88"></a>
</div>
<p>this gets filled from getAllCookies:</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    cookies: []
  };

  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span>.store.getAllCookies &amp;&amp;
        <span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.store.getAllCookies === <span class="hljs-string">'function'</span>))
  {
    <span class="hljs-keyword">return</span> cb(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'store does not support getAllCookies and cannot be serialized'</span>));
  }

  <span class="hljs-keyword">this</span>.store.getAllCookies(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,cookies</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-keyword">return</span> cb(err);
    }

    serialized.cookies = cookies.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cookie</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-89" id="section-89"></a>
</div>
<p>convert to serialized 'raw' cookies</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      cookie = (cookie <span class="hljs-keyword">instanceof</span> Cookie) ? cookie.toJSON() : cookie;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-90" id="section-90"></a>
</div>
<p>Remove the index so new ones get assigned during deserialization</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">delete</span> cookie.creationIndex;

      <span class="hljs-keyword">return</span> cookie;
    });

    <span class="hljs-keyword">return</span> cb(<span class="hljs-literal">null</span>, serialized);
  });
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-91" id="section-91"></a>
</div>
<p>well-known name that JSON.stringify calls</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">CookieJar.prototype.toJSON = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.serializeSync();
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-92" id="section-92"></a>
</div>
<p>use the class method CookieJar.deserialize instead of calling this directly</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">CAN_BE_SYNC.push(<span class="hljs-string">'_importCookies'</span>);
CookieJar.prototype._importCookies = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">serialized, cb</span>) </span>{
  <span class="hljs-keyword">var</span> jar = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> cookies = serialized.cookies;
  <span class="hljs-keyword">if</span> (!cookies || !<span class="hljs-built_in">Array</span>.isArray(cookies)) {
    <span class="hljs-keyword">return</span> cb(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'serialized jar has no cookies array'</span>));
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">putNext</span>(<span class="hljs-params">err</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-keyword">return</span> cb(err);
    }

    <span class="hljs-keyword">if</span> (!cookies.length) {
      <span class="hljs-keyword">return</span> cb(err, jar);
    }

    <span class="hljs-keyword">var</span> cookie;
    <span class="hljs-keyword">try</span> {
      cookie = fromJSON(cookies.shift());
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> cb(e);
    }

    <span class="hljs-keyword">if</span> (cookie === <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> putNext(<span class="hljs-literal">null</span>); <span class="hljs-comment">// skip this cookie</span>
    }

    jar.store.putCookie(cookie, putNext);
  }

  putNext();
};

CookieJar.deserialize = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">strOrObj, store, cb</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length !== <span class="hljs-number">3</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-93" id="section-93"></a>
</div>
<p>store is optional</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    cb = store;
    store = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-keyword">var</span> serialized;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> strOrObj === <span class="hljs-string">'string'</span>) {
    serialized = jsonParse(strOrObj);
    <span class="hljs-keyword">if</span> (serialized <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>) {
      <span class="hljs-keyword">return</span> cb(serialized);
    }
  } <span class="hljs-keyword">else</span> {
    serialized = strOrObj;
  }

  <span class="hljs-keyword">var</span> jar = <span class="hljs-keyword">new</span> CookieJar(store, serialized.rejectPublicSuffixes);
  jar._importCookies(serialized, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-keyword">return</span> cb(err);
    }
    cb(<span class="hljs-literal">null</span>, jar);
  });
};

CookieJar.deserializeSync = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">strOrObj, store</span>) </span>{
  <span class="hljs-keyword">var</span> serialized = <span class="hljs-keyword">typeof</span> strOrObj === <span class="hljs-string">'string'</span> ?
    <span class="hljs-built_in">JSON</span>.parse(strOrObj) : strOrObj;
  <span class="hljs-keyword">var</span> jar = <span class="hljs-keyword">new</span> CookieJar(store, serialized.rejectPublicSuffixes);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-94" id="section-94"></a>
</div>
<p>catch this mistake early:</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!jar.store.synchronous) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'CookieJar store is not synchronous; use async API instead.'</span>);
  }

  jar._importCookiesSync(serialized);
  <span class="hljs-keyword">return</span> jar;
};
CookieJar.fromJSON = CookieJar.deserializeSync;

CAN_BE_SYNC.push(<span class="hljs-string">'clone'</span>);
CookieJar.prototype.clone = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newStore, cb</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">1</span>) {
    cb = newStore;
    newStore = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-keyword">this</span>.serialize(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,serialized</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-keyword">return</span> cb(err);
    }
    CookieJar.deserialize(newStore, serialized, cb);
  });
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-95" id="section-95"></a>
</div>
<p>Use a closure to provide a true imperative API for synchronous stores.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">syncWrap</span>(<span class="hljs-params">method</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.store.synchronous) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'CookieJar store is not synchronous; use async API instead.'</span>);
    }

    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> syncErr, syncResult;
    args.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">syncCb</span>(<span class="hljs-params">err, result</span>) </span>{
      syncErr = err;
      syncResult = result;
    });
    <span class="hljs-keyword">this</span>[method].apply(<span class="hljs-keyword">this</span>, args);

    <span class="hljs-keyword">if</span> (syncErr) {
      <span class="hljs-keyword">throw</span> syncErr;
    }
    <span class="hljs-keyword">return</span> syncResult;
  };
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-96" id="section-96"></a>
</div>
<p>wrap all declared CAN_BE_SYNC methods in the sync wrapper</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">CAN_BE_SYNC.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">method</span>) </span>{
  CookieJar.prototype[method+<span class="hljs-string">'Sync'</span>] = syncWrap(method);
});

<span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-attr">CookieJar</span>: CookieJar,
  <span class="hljs-attr">Cookie</span>: Cookie,
  <span class="hljs-attr">Store</span>: Store,
  <span class="hljs-attr">MemoryCookieStore</span>: MemoryCookieStore,
  <span class="hljs-attr">parseDate</span>: parseDate,
  <span class="hljs-attr">formatDate</span>: formatDate,
  <span class="hljs-attr">parse</span>: parse,
  <span class="hljs-attr">fromJSON</span>: fromJSON,
  <span class="hljs-attr">domainMatch</span>: domainMatch,
  <span class="hljs-attr">defaultPath</span>: defaultPath,
  <span class="hljs-attr">pathMatch</span>: pathMatch,
  <span class="hljs-attr">getPublicSuffix</span>: pubsuffix.getPublicSuffix,
  <span class="hljs-attr">cookieCompare</span>: cookieCompare,
  <span class="hljs-attr">permuteDomain</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'./permuteDomain'</span>).permuteDomain,
  <span class="hljs-attr">permutePath</span>: permutePath,
  <span class="hljs-attr">canonicalDomain</span>: canonicalDomain
};

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

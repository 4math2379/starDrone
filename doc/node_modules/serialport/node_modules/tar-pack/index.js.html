<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../";
    var thisFile = "node_modules/serialport/node_modules/tar-pack/index.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>

<span class="hljs-keyword">var</span> debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'tar-pack'</span>)
<span class="hljs-keyword">var</span> uidNumber = <span class="hljs-built_in">require</span>(<span class="hljs-string">'uid-number'</span>)
<span class="hljs-keyword">var</span> rm = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rimraf'</span>)
<span class="hljs-keyword">var</span> tar = <span class="hljs-built_in">require</span>(<span class="hljs-string">'tar'</span>)
<span class="hljs-keyword">var</span> once = <span class="hljs-built_in">require</span>(<span class="hljs-string">'once'</span>)
<span class="hljs-keyword">var</span> fstream = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fstream'</span>)
<span class="hljs-keyword">var</span> packer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fstream-ignore'</span>)

<span class="hljs-keyword">var</span> PassThrough = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>).PassThrough || <span class="hljs-built_in">require</span>(<span class="hljs-string">'readable-stream'</span>).PassThrough
<span class="hljs-keyword">var</span> zlib = <span class="hljs-built_in">require</span>(<span class="hljs-string">'zlib'</span>)
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)

<span class="hljs-keyword">var</span> win32 = process.platform === <span class="hljs-string">'win32'</span>
<span class="hljs-keyword">var</span> myUid = process.getuid &amp;&amp; process.getuid()
<span class="hljs-keyword">var</span> myGid = process.getgid &amp;&amp; process.getgid()

<span class="hljs-keyword">if</span> (process.env.SUDO_UID &amp;&amp; myUid === <span class="hljs-number">0</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isNaN</span>(process.env.SUDO_UID)) myUid = +process.env.SUDO_UID
  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isNaN</span>(process.env.SUDO_GID)) myGid = +process.env.SUDO_GID
}

exports.pack = pack
exports.unpack = unpack

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pack</span>(<span class="hljs-params">folder, options</span>) </span>{
  options = options || {}
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> folder === <span class="hljs-string">'string'</span>) {

    <span class="hljs-keyword">var</span> filter = options.filter || <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry</span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; }

    folder = packer({
      <span class="hljs-attr">path</span>: folder,
      <span class="hljs-attr">type</span>: <span class="hljs-string">'Directory'</span>,
      <span class="hljs-attr">isDirectory</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">ignoreFiles</span>: options.ignoreFiles || [<span class="hljs-string">'.gitignore'</span>],
      <span class="hljs-attr">filter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry</span>) </span>{ <span class="hljs-comment">// {path, basename, dirname, type} (type is "Directory" or "File")</span>
        <span class="hljs-keyword">var</span> basename = entry.basename
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>some files are <em>never</em> allowed under any circumstances
these files should always be either temporary files or
version control related files</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (basename === <span class="hljs-string">'.git'</span> || basename === <span class="hljs-string">'.lock-wscript'</span> || basename.match(<span class="hljs-regexp">/^\.wafpickle-[0-9]+$/</span>) ||
            basename === <span class="hljs-string">'CVS'</span> || basename === <span class="hljs-string">'.svn'</span> || basename === <span class="hljs-string">'.hg'</span> || basename.match(<span class="hljs-regexp">/^\..*\.swp$/</span>) ||
            basename === <span class="hljs-string">'.DS_Store'</span> ||  basename.match(<span class="hljs-regexp">/^\._/</span>)) {
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>custom excludes</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">return</span> filter(entry)
      }
    })
  }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>By default, npm includes some proprietary attributes in the
package tarball.  This is sane, and allowed by the spec.
However, npm <em>itself</em> excludes these from its own package,
so that it can be more easily bootstrapped using old and
non-compliant tar implementations.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> tarPack = tar.Pack({ <span class="hljs-attr">noProprietary</span>: options.noProprietary || <span class="hljs-literal">false</span> })
  <span class="hljs-keyword">var</span> gzip = zlib.Gzip()

  folder
    .on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
      <span class="hljs-keyword">if</span> (er) debug(<span class="hljs-string">'Error reading folder'</span>)
      <span class="hljs-keyword">return</span> gzip.emit(<span class="hljs-string">'error'</span>, er)
    })
  tarPack
    .on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
      <span class="hljs-keyword">if</span> (er) debug(<span class="hljs-string">'tar creation error'</span>)
      gzip.emit(<span class="hljs-string">'error'</span>, er)
    })
  <span class="hljs-keyword">return</span> folder.pipe(tarPack).pipe(gzip)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unpack</span>(<span class="hljs-params">unpackTarget, options, cb</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'function'</span> &amp;&amp; cb === <span class="hljs-literal">undefined</span>) cb = options, options = <span class="hljs-literal">undefined</span>

  <span class="hljs-keyword">var</span> tarball = <span class="hljs-keyword">new</span> PassThrough()
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> cb === <span class="hljs-string">'function'</span>) {
    cb = once(cb)
    tarball.on(<span class="hljs-string">'error'</span>, cb)
    tarball.on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      cb()
    })
  }

  <span class="hljs-keyword">var</span> parent = path.dirname(unpackTarget)
  <span class="hljs-keyword">var</span> base = path.basename(unpackTarget)

  options = options || {}
  <span class="hljs-keyword">var</span> gid = options.gid || <span class="hljs-literal">null</span>
  <span class="hljs-keyword">var</span> uid = options.uid || <span class="hljs-literal">null</span>
  <span class="hljs-keyword">var</span> dMode = options.dmode || <span class="hljs-number">0x0777</span> <span class="hljs-comment">//npm.modes.exec</span>
  <span class="hljs-keyword">var</span> fMode = options.fmode || <span class="hljs-number">0x0666</span> <span class="hljs-comment">//npm.modes.file</span>
  <span class="hljs-keyword">var</span> defaultName = options.defaultName || (options.defaultName === <span class="hljs-literal">false</span> ? <span class="hljs-literal">false</span> : <span class="hljs-string">'index.js'</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>figure out who we're supposed to be, if we're not pretending
to be a specific user.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (options.unsafe &amp;&amp; !win32) {
    uid = myUid
    gid = myGid
  }

  <span class="hljs-keyword">var</span> pending = <span class="hljs-number">2</span>
  uidNumber(uid, gid, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er, uid, gid</span>) </span>{
    <span class="hljs-keyword">if</span> (er) {
      tarball.emit(<span class="hljs-string">'error'</span>, er)
      <span class="hljs-keyword">return</span> tarball.end()
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> === --pending) next()
  })
  rm(unpackTarget, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
    <span class="hljs-keyword">if</span> (er) {
      tarball.emit(<span class="hljs-string">'error'</span>, er)
      <span class="hljs-keyword">return</span> tarball.end()
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> === --pending) next()
  })
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>gzip {tarball} --decompress --stdout <br>
| tar -mvxpf - --strip-components=1 -C {unpackTarget}</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    gunzTarPerm(tarball, unpackTarget, dMode, fMode, uid, gid, defaultName)
  }
  <span class="hljs-keyword">return</span> tarball
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gunzTarPerm</span>(<span class="hljs-params">tarball, target, dMode, fMode, uid, gid, defaultName</span>) </span>{
  debug(<span class="hljs-string">'modes %j'</span>, [dMode.toString(<span class="hljs-number">8</span>), fMode.toString(<span class="hljs-number">8</span>)])

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fixEntry</span>(<span class="hljs-params">entry</span>) </span>{
    debug(<span class="hljs-string">'fixEntry %j'</span>, entry.path)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>never create things that are user-unreadable,
or dirs that are user-un-listable. Only leads to headaches.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> originalMode = entry.mode = entry.mode || entry.props.mode
    entry.mode = entry.mode | (entry.type === <span class="hljs-string">'Directory'</span> ? dMode : fMode)
    entry.props.mode = entry.mode
    <span class="hljs-keyword">if</span> (originalMode !== entry.mode) {
      debug(<span class="hljs-string">'modified mode %j'</span>, [entry.path, originalMode, entry.mode])
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>if there's a specific owner uid/gid that we want, then set that</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (!win32 &amp;&amp;  <span class="hljs-keyword">typeof</span> uid === <span class="hljs-string">'number'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> gid === <span class="hljs-string">'number'</span>) {
      entry.props.uid = entry.uid = uid
      entry.props.gid = entry.gid = gid
    }
  }

  <span class="hljs-keyword">var</span> extractOpts = { <span class="hljs-attr">type</span>: <span class="hljs-string">'Directory'</span>, <span class="hljs-attr">path</span>: target, <span class="hljs-attr">strip</span>: <span class="hljs-number">1</span> }

  <span class="hljs-keyword">if</span> (!win32 &amp;&amp; <span class="hljs-keyword">typeof</span> uid === <span class="hljs-string">'number'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> gid === <span class="hljs-string">'number'</span>) {
    extractOpts.uid = uid
    extractOpts.gid = gid
  }

  extractOpts.filter = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>symbolic links are not allowed in packages.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.type.match(<span class="hljs-regexp">/^.*Link$/</span>)) {
      debug(<span class="hljs-string">'excluding symbolic link: '</span> + <span class="hljs-keyword">this</span>.path.substr(target.length + <span class="hljs-number">1</span>) + <span class="hljs-string">' -&gt; '</span> + <span class="hljs-keyword">this</span>.linkpath)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  }


  type(tarball, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, type</span>) </span>{
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> tarball.emit(<span class="hljs-string">'error'</span>, err)
    <span class="hljs-keyword">var</span> strm = tarball
    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'gzip'</span>) {
      strm = strm.pipe(zlib.Unzip())
      strm.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
          <span class="hljs-keyword">if</span> (er) debug(<span class="hljs-string">'unzip error'</span>)
          tarball.emit(<span class="hljs-string">'error'</span>, er)
        })
      type = <span class="hljs-string">'tar'</span>
    }
    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'tar'</span>) {
      strm
        .pipe(tar.Extract(extractOpts))
        .on(<span class="hljs-string">'entry'</span>, fixEntry)
        .on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
          <span class="hljs-keyword">if</span> (er) debug(<span class="hljs-string">'untar error'</span>)
          tarball.emit(<span class="hljs-string">'error'</span>, er)
        })
        .on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
          tarball.emit(<span class="hljs-string">'close'</span>)
        })
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'naked-file'</span> &amp;&amp; defaultName) {
      <span class="hljs-keyword">var</span> jsOpts = { <span class="hljs-attr">path</span>: path.resolve(target, defaultName) }

      <span class="hljs-keyword">if</span> (!win32 &amp;&amp; <span class="hljs-keyword">typeof</span> uid === <span class="hljs-string">'number'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> gid === <span class="hljs-string">'number'</span>) {
        jsOpts.uid = uid
        jsOpts.gid = gid
      }

      strm
        .pipe(fstream.Writer(jsOpts))
        .on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
          <span class="hljs-keyword">if</span> (er) debug(<span class="hljs-string">'copy error'</span>)
          tarball.emit(<span class="hljs-string">'error'</span>, er)
        })
        .on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
          tarball.emit(<span class="hljs-string">'close'</span>)
        })
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">return</span> cb(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Unrecognised package type'</span>));
  })
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">type</span>(<span class="hljs-params">stream, callback</span>) </span>{
  stream.on(<span class="hljs-string">'error'</span>, handle)
  stream.on(<span class="hljs-string">'data'</span>, parse)
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">err</span>) </span>{
    stream.removeListener(<span class="hljs-string">'data'</span>, parse)
    stream.removeListener(<span class="hljs-string">'error'</span>, handle)
  }
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse</span>(<span class="hljs-params">chunk</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>detect what it is.
Then, depending on that, we'll figure out whether it's
a single-file module, gzipped tarball, or naked tarball.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>gzipped files all start with 1f8b08</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (chunk[<span class="hljs-number">0</span>] === <span class="hljs-number">0x1F</span> &amp;&amp; chunk[<span class="hljs-number">1</span>] === <span class="hljs-number">0x8B</span> &amp;&amp; chunk[<span class="hljs-number">2</span>] === <span class="hljs-number">0x08</span>) {
      callback(<span class="hljs-literal">null</span>, <span class="hljs-string">'gzip'</span>)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (chunk.toString().match(<span class="hljs-regexp">/^package\/\u0000/</span>)) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>note, this will only pick up on tarballs with a root directory called package</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      callback(<span class="hljs-literal">null</span>, <span class="hljs-string">'tar'</span>)
    } <span class="hljs-keyword">else</span> {
      callback(<span class="hljs-literal">null</span>, <span class="hljs-string">'naked-file'</span>)
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>now un-hook, and re-emit the chunk</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    stream.removeListener(<span class="hljs-string">'data'</span>, parse)
    stream.removeListener(<span class="hljs-string">'error'</span>, handle)
    stream.unshift(chunk)
  }
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>rimraf.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../";
    var thisFile = "node_modules/serialport/node_modules/rimraf/rimraf.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>rimraf.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-built_in">module</span>.exports = rimraf
rimraf.sync = rimrafSync

<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">"assert"</span>)
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>)
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>)
<span class="hljs-keyword">var</span> glob = <span class="hljs-built_in">require</span>(<span class="hljs-string">"glob"</span>)

<span class="hljs-keyword">var</span> defaultGlobOpts = {
  <span class="hljs-attr">nosort</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">silent</span>: <span class="hljs-literal">true</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>for EMFILE handling</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> timeout = <span class="hljs-number">0</span>

<span class="hljs-keyword">var</span> isWindows = (process.platform === <span class="hljs-string">"win32"</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">defaults</span> (<span class="hljs-params">options</span>) </span>{
  <span class="hljs-keyword">var</span> methods = [
    <span class="hljs-string">'unlink'</span>,
    <span class="hljs-string">'chmod'</span>,
    <span class="hljs-string">'stat'</span>,
    <span class="hljs-string">'lstat'</span>,
    <span class="hljs-string">'rmdir'</span>,
    <span class="hljs-string">'readdir'</span>
  ]
  methods.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">m</span>) </span>{
    options[m] = options[m] || fs[m]
    m = m + <span class="hljs-string">'Sync'</span>
    options[m] = options[m] || fs[m]
  })

  options.maxBusyTries = options.maxBusyTries || <span class="hljs-number">3</span>
  options.emfileWait = options.emfileWait || <span class="hljs-number">1000</span>
  <span class="hljs-keyword">if</span> (options.glob === <span class="hljs-literal">false</span>) {
    options.disableGlob = <span class="hljs-literal">true</span>
  }
  options.disableGlob = options.disableGlob || <span class="hljs-literal">false</span>
  options.glob = options.glob || defaultGlobOpts
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rimraf</span> (<span class="hljs-params">p, options, cb</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'function'</span>) {
    cb = options
    options = {}
  }

  assert(p, <span class="hljs-string">'rimraf: missing path'</span>)
  assert.equal(<span class="hljs-keyword">typeof</span> p, <span class="hljs-string">'string'</span>, <span class="hljs-string">'rimraf: path should be a string'</span>)
  assert(options, <span class="hljs-string">'rimraf: missing options'</span>)
  assert.equal(<span class="hljs-keyword">typeof</span> options, <span class="hljs-string">'object'</span>, <span class="hljs-string">'rimraf: options should be object'</span>)
  assert.equal(<span class="hljs-keyword">typeof</span> cb, <span class="hljs-string">'function'</span>, <span class="hljs-string">'rimraf: callback function required'</span>)

  defaults(options)

  <span class="hljs-keyword">var</span> busyTries = <span class="hljs-number">0</span>
  <span class="hljs-keyword">var</span> errState = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">var</span> n = <span class="hljs-number">0</span>

  <span class="hljs-keyword">if</span> (options.disableGlob || !glob.hasMagic(p))
    <span class="hljs-keyword">return</span> afterGlob(<span class="hljs-literal">null</span>, [p])

  fs.lstat(p, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er, stat</span>) </span>{
    <span class="hljs-keyword">if</span> (!er)
      <span class="hljs-keyword">return</span> afterGlob(<span class="hljs-literal">null</span>, [p])

    glob(p, options.glob, afterGlob)
  })

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span> (<span class="hljs-params">er</span>) </span>{
    errState = errState || er
    <span class="hljs-keyword">if</span> (--n === <span class="hljs-number">0</span>)
      cb(errState)
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">afterGlob</span> (<span class="hljs-params">er, results</span>) </span>{
    <span class="hljs-keyword">if</span> (er)
      <span class="hljs-keyword">return</span> cb(er)

    n = results.length
    <span class="hljs-keyword">if</span> (n === <span class="hljs-number">0</span>)
      <span class="hljs-keyword">return</span> cb()

    results.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">p</span>) </span>{
      rimraf_(p, options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">CB</span> (<span class="hljs-params">er</span>) </span>{
        <span class="hljs-keyword">if</span> (er) {
          <span class="hljs-keyword">if</span> (isWindows &amp;&amp; (er.code === <span class="hljs-string">"EBUSY"</span> || er.code === <span class="hljs-string">"ENOTEMPTY"</span> || er.code === <span class="hljs-string">"EPERM"</span>) &amp;&amp;
              busyTries &lt; options.maxBusyTries) {
            busyTries ++
            <span class="hljs-keyword">var</span> time = busyTries * <span class="hljs-number">100</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>try again, with the same exact callback as this one.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">return</span> setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
              rimraf_(p, options, CB)
            }, time)
          }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>this one won't happen if graceful-fs is used.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">if</span> (er.code === <span class="hljs-string">"EMFILE"</span> &amp;&amp; timeout &lt; options.emfileWait) {
            <span class="hljs-keyword">return</span> setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
              rimraf_(p, options, CB)
            }, timeout ++)
          }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>already gone</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">if</span> (er.code === <span class="hljs-string">"ENOENT"</span>) er = <span class="hljs-literal">null</span>
        }

        timeout = <span class="hljs-number">0</span>
        next(er)
      })
    })
  }
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Two possible strategies.</p>
<ol>
<li>Assume it's a file.  unlink it, then do the dir stuff on EPERM or EISDIR</li>
<li>Assume it's a directory.  readdir, then do the file stuff on ENOTDIR</li>
</ol>
<p>Both result in an extra syscall when you guess wrong.  However, there
are likely far more normal files in the world than directories.  This
is based on the assumption that a the average number of files per
directory is &gt;= 1.</p>
<p>If anyone ever complains about this, then I guess the strategy could
be made configurable somehow.  But until then, YAGNI.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rimraf_</span> (<span class="hljs-params">p, options, cb</span>) </span>{
  assert(p)
  assert(options)
  assert(<span class="hljs-keyword">typeof</span> cb === <span class="hljs-string">'function'</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>sunos lets the root user unlink directories, which is... weird.
so we have to lstat here and make sure it's not a dir.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  options.lstat(p, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er, st</span>) </span>{
    <span class="hljs-keyword">if</span> (er &amp;&amp; er.code === <span class="hljs-string">"ENOENT"</span>)
      <span class="hljs-keyword">return</span> cb(<span class="hljs-literal">null</span>)

    <span class="hljs-keyword">if</span> (st &amp;&amp; st.isDirectory())
      <span class="hljs-keyword">return</span> rmdir(p, options, er, cb)

    options.unlink(p, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
      <span class="hljs-keyword">if</span> (er) {
        <span class="hljs-keyword">if</span> (er.code === <span class="hljs-string">"ENOENT"</span>)
          <span class="hljs-keyword">return</span> cb(<span class="hljs-literal">null</span>)
        <span class="hljs-keyword">if</span> (er.code === <span class="hljs-string">"EPERM"</span>)
          <span class="hljs-keyword">return</span> (isWindows)
            ? fixWinEPERM(p, options, er, cb)
            : rmdir(p, options, er, cb)
        <span class="hljs-keyword">if</span> (er.code === <span class="hljs-string">"EISDIR"</span>)
          <span class="hljs-keyword">return</span> rmdir(p, options, er, cb)
      }
      <span class="hljs-keyword">return</span> cb(er)
    })
  })
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fixWinEPERM</span> (<span class="hljs-params">p, options, er, cb</span>) </span>{
  assert(p)
  assert(options)
  assert(<span class="hljs-keyword">typeof</span> cb === <span class="hljs-string">'function'</span>)
  <span class="hljs-keyword">if</span> (er)
    assert(er <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>)

  options.chmod(p, <span class="hljs-number">666</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er2</span>) </span>{
    <span class="hljs-keyword">if</span> (er2)
      cb(er2.code === <span class="hljs-string">"ENOENT"</span> ? <span class="hljs-literal">null</span> : er)
    <span class="hljs-keyword">else</span>
      options.stat(p, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">er3, stats</span>) </span>{
        <span class="hljs-keyword">if</span> (er3)
          cb(er3.code === <span class="hljs-string">"ENOENT"</span> ? <span class="hljs-literal">null</span> : er)
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (stats.isDirectory())
          rmdir(p, options, er, cb)
        <span class="hljs-keyword">else</span>
          options.unlink(p, cb)
      })
  })
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fixWinEPERMSync</span> (<span class="hljs-params">p, options, er</span>) </span>{
  assert(p)
  assert(options)
  <span class="hljs-keyword">if</span> (er)
    assert(er <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>)

  <span class="hljs-keyword">try</span> {
    options.chmodSync(p, <span class="hljs-number">666</span>)
  } <span class="hljs-keyword">catch</span> (er2) {
    <span class="hljs-keyword">if</span> (er2.code === <span class="hljs-string">"ENOENT"</span>)
      <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">throw</span> er
  }

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">var</span> stats = options.statSync(p)
  } <span class="hljs-keyword">catch</span> (er3) {
    <span class="hljs-keyword">if</span> (er3.code === <span class="hljs-string">"ENOENT"</span>)
      <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">throw</span> er
  }

  <span class="hljs-keyword">if</span> (stats.isDirectory())
    rmdirSync(p, options, er)
  <span class="hljs-keyword">else</span>
    options.unlinkSync(p)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rmdir</span> (<span class="hljs-params">p, options, originalEr, cb</span>) </span>{
  assert(p)
  assert(options)
  <span class="hljs-keyword">if</span> (originalEr)
    assert(originalEr <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>)
  assert(<span class="hljs-keyword">typeof</span> cb === <span class="hljs-string">'function'</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>try to rmdir first, and only readdir on ENOTEMPTY or EEXIST (SunOS)
if we guessed wrong, and it's not a directory, then
raise the original error.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  options.rmdir(p, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
    <span class="hljs-keyword">if</span> (er &amp;&amp; (er.code === <span class="hljs-string">"ENOTEMPTY"</span> || er.code === <span class="hljs-string">"EEXIST"</span> || er.code === <span class="hljs-string">"EPERM"</span>))
      rmkids(p, options, cb)
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (er &amp;&amp; er.code === <span class="hljs-string">"ENOTDIR"</span>)
      cb(originalEr)
    <span class="hljs-keyword">else</span>
      cb(er)
  })
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rmkids</span>(<span class="hljs-params">p, options, cb</span>) </span>{
  assert(p)
  assert(options)
  assert(<span class="hljs-keyword">typeof</span> cb === <span class="hljs-string">'function'</span>)

  options.readdir(p, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er, files</span>) </span>{
    <span class="hljs-keyword">if</span> (er)
      <span class="hljs-keyword">return</span> cb(er)
    <span class="hljs-keyword">var</span> n = files.length
    <span class="hljs-keyword">if</span> (n === <span class="hljs-number">0</span>)
      <span class="hljs-keyword">return</span> options.rmdir(p, cb)
    <span class="hljs-keyword">var</span> errState
    files.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">f</span>) </span>{
      rimraf(path.join(p, f), options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
        <span class="hljs-keyword">if</span> (errState)
          <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">if</span> (er)
          <span class="hljs-keyword">return</span> cb(errState = er)
        <span class="hljs-keyword">if</span> (--n === <span class="hljs-number">0</span>)
          options.rmdir(p, cb)
      })
    })
  })
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>this looks simpler, and is strictly <em>faster</em>, but will
tie up the JavaScript thread and fail on excessively
deep directory trees.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rimrafSync</span> (<span class="hljs-params">p, options</span>) </span>{
  options = options || {}
  defaults(options)

  assert(p, <span class="hljs-string">'rimraf: missing path'</span>)
  assert.equal(<span class="hljs-keyword">typeof</span> p, <span class="hljs-string">'string'</span>, <span class="hljs-string">'rimraf: path should be a string'</span>)
  assert(options, <span class="hljs-string">'rimraf: missing options'</span>)
  assert.equal(<span class="hljs-keyword">typeof</span> options, <span class="hljs-string">'object'</span>, <span class="hljs-string">'rimraf: options should be object'</span>)

  <span class="hljs-keyword">var</span> results

  <span class="hljs-keyword">if</span> (options.disableGlob || !glob.hasMagic(p)) {
    results = [p]
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">try</span> {
      fs.lstatSync(p)
      results = [p]
    } <span class="hljs-keyword">catch</span> (er) {
      results = glob.sync(p, options.glob)
    }
  }

  <span class="hljs-keyword">if</span> (!results.length)
    <span class="hljs-keyword">return</span>

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; results.length; i++) {
    <span class="hljs-keyword">var</span> p = results[i]

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">var</span> st = options.lstatSync(p)
    } <span class="hljs-keyword">catch</span> (er) {
      <span class="hljs-keyword">if</span> (er.code === <span class="hljs-string">"ENOENT"</span>)
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">try</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>sunos lets the root user unlink directories, which is... weird.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (st &amp;&amp; st.isDirectory())
        rmdirSync(p, options, <span class="hljs-literal">null</span>)
      <span class="hljs-keyword">else</span>
        options.unlinkSync(p)
    } <span class="hljs-keyword">catch</span> (er) {
      <span class="hljs-keyword">if</span> (er.code === <span class="hljs-string">"ENOENT"</span>)
        <span class="hljs-keyword">return</span>
      <span class="hljs-keyword">if</span> (er.code === <span class="hljs-string">"EPERM"</span>)
        <span class="hljs-keyword">return</span> isWindows ? fixWinEPERMSync(p, options, er) : rmdirSync(p, options, er)
      <span class="hljs-keyword">if</span> (er.code !== <span class="hljs-string">"EISDIR"</span>)
        <span class="hljs-keyword">throw</span> er
      rmdirSync(p, options, er)
    }
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rmdirSync</span> (<span class="hljs-params">p, options, originalEr</span>) </span>{
  assert(p)
  assert(options)
  <span class="hljs-keyword">if</span> (originalEr)
    assert(originalEr <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>)

  <span class="hljs-keyword">try</span> {
    options.rmdirSync(p)
  } <span class="hljs-keyword">catch</span> (er) {
    <span class="hljs-keyword">if</span> (er.code === <span class="hljs-string">"ENOENT"</span>)
      <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">if</span> (er.code === <span class="hljs-string">"ENOTDIR"</span>)
      <span class="hljs-keyword">throw</span> originalEr
    <span class="hljs-keyword">if</span> (er.code === <span class="hljs-string">"ENOTEMPTY"</span> || er.code === <span class="hljs-string">"EEXIST"</span> || er.code === <span class="hljs-string">"EPERM"</span>)
      rmkidsSync(p, options)
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rmkidsSync</span> (<span class="hljs-params">p, options</span>) </span>{
  assert(p)
  assert(options)
  options.readdirSync(p).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">f</span>) </span>{
    rimrafSync(path.join(p, f), options)
  })
  options.rmdirSync(p, options)
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

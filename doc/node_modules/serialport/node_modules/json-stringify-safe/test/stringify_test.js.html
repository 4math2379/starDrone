<!DOCTYPE html>
<html>
<head>
  <title>stringify_test.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/json-stringify-safe/test/stringify_test.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>stringify_test.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> Sinon = <span class="hljs-built_in">require</span>(<span class="hljs-string">"sinon"</span>)
<span class="hljs-keyword">var</span> stringify = <span class="hljs-built_in">require</span>(<span class="hljs-string">".."</span>)
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">jsonify</span>(<span class="hljs-params">obj</span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.stringify(obj, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>) }

describe(<span class="hljs-string">"Stringify"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  it(<span class="hljs-string">"must stringify circular objects"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> obj = {<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>}
    obj.self = obj
    <span class="hljs-keyword">var</span> json = stringify(obj, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)
    json.must.eql(jsonify({<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">self</span>: <span class="hljs-string">"[Circular ~]"</span>}))
  })

  it(<span class="hljs-string">"must stringify circular objects with intermediaries"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> obj = {<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>}
    obj.identity = {<span class="hljs-attr">self</span>: obj}
    <span class="hljs-keyword">var</span> json = stringify(obj, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)
    json.must.eql(jsonify({<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">identity</span>: {<span class="hljs-attr">self</span>: <span class="hljs-string">"[Circular ~]"</span>}}))
  })

  it(<span class="hljs-string">"must stringify circular objects deeper"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> obj = {<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">child</span>: {<span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span>}}
    obj.child.self = obj.child

    stringify(obj, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>).must.eql(jsonify({
      <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>,
      <span class="hljs-attr">child</span>: {<span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span>, <span class="hljs-attr">self</span>: <span class="hljs-string">"[Circular ~.child]"</span>}
    }))
  })

  it(<span class="hljs-string">"must stringify circular objects deeper with intermediaries"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> obj = {<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">child</span>: {<span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span>}}
    obj.child.identity = {<span class="hljs-attr">self</span>: obj.child}

    stringify(obj, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>).must.eql(jsonify({
      <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>,
      <span class="hljs-attr">child</span>: {<span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span>, <span class="hljs-attr">identity</span>: {<span class="hljs-attr">self</span>: <span class="hljs-string">"[Circular ~.child]"</span>}}
    }))
  })

  it(<span class="hljs-string">"must stringify circular objects in an array"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> obj = {<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>}
    obj.self = [obj, obj]

    stringify(obj, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>).must.eql(jsonify({
      <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">self</span>: [<span class="hljs-string">"[Circular ~]"</span>, <span class="hljs-string">"[Circular ~]"</span>]
    }))
  })

  it(<span class="hljs-string">"must stringify circular objects deeper in an array"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> obj = {<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">children</span>: [{<span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span>}, {<span class="hljs-attr">name</span>: <span class="hljs-string">"Eve"</span>}]}
    obj.children[<span class="hljs-number">0</span>].self = obj.children[<span class="hljs-number">0</span>]
    obj.children[<span class="hljs-number">1</span>].self = obj.children[<span class="hljs-number">1</span>]

    stringify(obj, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>).must.eql(jsonify({
      <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>,
      <span class="hljs-attr">children</span>: [
        {<span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span>, <span class="hljs-attr">self</span>: <span class="hljs-string">"[Circular ~.children.0]"</span>},
        {<span class="hljs-attr">name</span>: <span class="hljs-string">"Eve"</span>, <span class="hljs-attr">self</span>: <span class="hljs-string">"[Circular ~.children.1]"</span>}
      ]
    }))
  })

  it(<span class="hljs-string">"must stringify circular arrays"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> obj = []
    obj.push(obj)
    obj.push(obj)
    <span class="hljs-keyword">var</span> json = stringify(obj, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)
    json.must.eql(jsonify([<span class="hljs-string">"[Circular ~]"</span>, <span class="hljs-string">"[Circular ~]"</span>]))
  })

  it(<span class="hljs-string">"must stringify circular arrays with intermediaries"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> obj = []
    obj.push({<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">self</span>: obj})
    obj.push({<span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span>, <span class="hljs-attr">self</span>: obj})

    stringify(obj, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>).must.eql(jsonify([
      {<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">self</span>: <span class="hljs-string">"[Circular ~]"</span>},
      {<span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span>, <span class="hljs-attr">self</span>: <span class="hljs-string">"[Circular ~]"</span>}
    ]))
  })

  it(<span class="hljs-string">"must stringify repeated objects in objects"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> obj = {}
    <span class="hljs-keyword">var</span> alice = {<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>}
    obj.alice1 = alice
    obj.alice2 = alice

    stringify(obj, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>).must.eql(jsonify({
      <span class="hljs-attr">alice1</span>: {<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>},
      <span class="hljs-attr">alice2</span>: {<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>}
    }))
  })

  it(<span class="hljs-string">"must stringify repeated objects in arrays"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> alice = {<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>}
    <span class="hljs-keyword">var</span> obj = [alice, alice]
    <span class="hljs-keyword">var</span> json = stringify(obj, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)
    json.must.eql(jsonify([{<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>}, {<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>}]))
  })

  it(<span class="hljs-string">"must call given decycler and use its output"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> obj = {}
    obj.a = obj
    obj.b = obj

    <span class="hljs-keyword">var</span> decycle = Sinon.spy(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> decycle.callCount })
    <span class="hljs-keyword">var</span> json = stringify(obj, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>, decycle)
    json.must.eql(jsonify({<span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>}, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>))

    decycle.callCount.must.equal(<span class="hljs-number">2</span>)
    decycle.thisValues[<span class="hljs-number">0</span>].must.equal(obj)
    decycle.args[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].must.equal(<span class="hljs-string">"a"</span>)
    decycle.args[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>].must.equal(obj)
    decycle.thisValues[<span class="hljs-number">1</span>].must.equal(obj)
    decycle.args[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>].must.equal(<span class="hljs-string">"b"</span>)
    decycle.args[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>].must.equal(obj)
  })

  it(<span class="hljs-string">"must call replacer and use its output"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> obj = {<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">child</span>: {<span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span>}}

    <span class="hljs-keyword">var</span> replacer = Sinon.spy(bangString)
    <span class="hljs-keyword">var</span> json = stringify(obj, replacer, <span class="hljs-number">2</span>)
    json.must.eql(jsonify({<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice!"</span>, <span class="hljs-attr">child</span>: {<span class="hljs-attr">name</span>: <span class="hljs-string">"Bob!"</span>}}))

    replacer.callCount.must.equal(<span class="hljs-number">4</span>)
    replacer.args[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].must.equal(<span class="hljs-string">""</span>)
    replacer.args[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>].must.equal(obj)
    replacer.thisValues[<span class="hljs-number">1</span>].must.equal(obj)
    replacer.args[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>].must.equal(<span class="hljs-string">"name"</span>)
    replacer.args[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>].must.equal(<span class="hljs-string">"Alice"</span>)
    replacer.thisValues[<span class="hljs-number">2</span>].must.equal(obj)
    replacer.args[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>].must.equal(<span class="hljs-string">"child"</span>)
    replacer.args[<span class="hljs-number">2</span>][<span class="hljs-number">1</span>].must.equal(obj.child)
    replacer.thisValues[<span class="hljs-number">3</span>].must.equal(obj.child)
    replacer.args[<span class="hljs-number">3</span>][<span class="hljs-number">0</span>].must.equal(<span class="hljs-string">"name"</span>)
    replacer.args[<span class="hljs-number">3</span>][<span class="hljs-number">1</span>].must.equal(<span class="hljs-string">"Bob"</span>)
  })

  it(<span class="hljs-string">"must call replacer after describing circular references"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> obj = {<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>}
    obj.self = obj

    <span class="hljs-keyword">var</span> replacer = Sinon.spy(bangString)
    <span class="hljs-keyword">var</span> json = stringify(obj, replacer, <span class="hljs-number">2</span>)
    json.must.eql(jsonify({<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice!"</span>, <span class="hljs-attr">self</span>: <span class="hljs-string">"[Circular ~]!"</span>}))

    replacer.callCount.must.equal(<span class="hljs-number">3</span>)
    replacer.args[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].must.equal(<span class="hljs-string">""</span>)
    replacer.args[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>].must.equal(obj)
    replacer.thisValues[<span class="hljs-number">1</span>].must.equal(obj)
    replacer.args[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>].must.equal(<span class="hljs-string">"name"</span>)
    replacer.args[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>].must.equal(<span class="hljs-string">"Alice"</span>)
    replacer.thisValues[<span class="hljs-number">2</span>].must.equal(obj)
    replacer.args[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>].must.equal(<span class="hljs-string">"self"</span>)
    replacer.args[<span class="hljs-number">2</span>][<span class="hljs-number">1</span>].must.equal(<span class="hljs-string">"[Circular ~]"</span>)
  })

  it(<span class="hljs-string">"must call given decycler and use its output for nested objects"</span>,
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> obj = {}
    obj.a = obj
    obj.b = {<span class="hljs-attr">self</span>: obj}

    <span class="hljs-keyword">var</span> decycle = Sinon.spy(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> decycle.callCount })
    <span class="hljs-keyword">var</span> json = stringify(obj, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>, decycle)
    json.must.eql(jsonify({<span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: {<span class="hljs-attr">self</span>: <span class="hljs-number">2</span>}}))

    decycle.callCount.must.equal(<span class="hljs-number">2</span>)
    decycle.args[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].must.equal(<span class="hljs-string">"a"</span>)
    decycle.args[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>].must.equal(obj)
    decycle.args[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>].must.equal(<span class="hljs-string">"self"</span>)
    decycle.args[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>].must.equal(obj)
  })

  it(<span class="hljs-string">"must use decycler's output when it returned null"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> obj = {<span class="hljs-attr">a</span>: <span class="hljs-string">"b"</span>}
    obj.self = obj
    obj.selves = [obj, obj]

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">decycle</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> }
    stringify(obj, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>, decycle).must.eql(jsonify({
      <span class="hljs-attr">a</span>: <span class="hljs-string">"b"</span>,
      <span class="hljs-attr">self</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">selves</span>: [<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>]
    }))
  })

  it(<span class="hljs-string">"must use decycler's output when it returned undefined"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> obj = {<span class="hljs-attr">a</span>: <span class="hljs-string">"b"</span>}
    obj.self = obj
    obj.selves = [obj, obj]

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">decycle</span>(<span class="hljs-params"></span>) </span>{}
    stringify(obj, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>, decycle).must.eql(jsonify({
      <span class="hljs-attr">a</span>: <span class="hljs-string">"b"</span>,
      <span class="hljs-attr">selves</span>: [<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>]
    }))
  })

  it(<span class="hljs-string">"must throw given a decycler that returns a cycle"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> obj = {}
    obj.self = obj
    <span class="hljs-keyword">var</span> err
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">identity</span>(<span class="hljs-params">key, value</span>) </span>{ <span class="hljs-keyword">return</span> value }
    <span class="hljs-keyword">try</span> { stringify(obj, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>, identity) } <span class="hljs-keyword">catch</span> (ex) { err = ex }
    err.must.be.an.instanceof(<span class="hljs-built_in">TypeError</span>)
  })

  describe(<span class="hljs-string">".getSerialize"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    it(<span class="hljs-string">"must stringify circular objects"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> obj = {<span class="hljs-attr">a</span>: <span class="hljs-string">"b"</span>}
      obj.circularRef = obj
      obj.list = [obj, obj]

      <span class="hljs-keyword">var</span> json = <span class="hljs-built_in">JSON</span>.stringify(obj, stringify.getSerialize(), <span class="hljs-number">2</span>)
      json.must.eql(jsonify({
        <span class="hljs-string">"a"</span>: <span class="hljs-string">"b"</span>,
        <span class="hljs-string">"circularRef"</span>: <span class="hljs-string">"[Circular ~]"</span>,
        <span class="hljs-string">"list"</span>: [<span class="hljs-string">"[Circular ~]"</span>, <span class="hljs-string">"[Circular ~]"</span>]
      }))
    })

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>This is the behavior as of Mar 3, 2015.
The serializer function keeps state inside the returned function and
so far I'm not sure how to not do that. JSON.stringify's replacer is not
called <em>after</em> serialization.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    xit(<span class="hljs-string">"must return a function that could be called twice"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> obj = {<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>}
      obj.self = obj

      <span class="hljs-keyword">var</span> json
      <span class="hljs-keyword">var</span> serializer = stringify.getSerialize()

      json = <span class="hljs-built_in">JSON</span>.stringify(obj, serializer, <span class="hljs-number">2</span>)
      json.must.eql(jsonify({<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">self</span>: <span class="hljs-string">"[Circular ~]"</span>}))

      json = <span class="hljs-built_in">JSON</span>.stringify(obj, serializer, <span class="hljs-number">2</span>)
      json.must.eql(jsonify({<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">self</span>: <span class="hljs-string">"[Circular ~]"</span>}))
    })
  })
})

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bangString</span>(<span class="hljs-params">key, value</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value == <span class="hljs-string">"string"</span> ? value + <span class="hljs-string">"!"</span> : value
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>parser.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/http-signature/lib/parser.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>parser.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>Copyright 2012 Joyent, Inc.  All rights reserved.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert-plus'</span>);
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>);
<span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./utils'</span>);



</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>/--- Globals</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> HASH_ALGOS = utils.HASH_ALGOS;
<span class="hljs-keyword">var</span> PK_ALGOS = utils.PK_ALGOS;
<span class="hljs-keyword">var</span> HttpSignatureError = utils.HttpSignatureError;
<span class="hljs-keyword">var</span> InvalidAlgorithmError = utils.InvalidAlgorithmError;
<span class="hljs-keyword">var</span> validateAlgorithm = utils.validateAlgorithm;

<span class="hljs-keyword">var</span> State = {
  <span class="hljs-attr">New</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">Params</span>: <span class="hljs-number">1</span>
};

<span class="hljs-keyword">var</span> ParamsState = {
  <span class="hljs-attr">Name</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">Quote</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">Value</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">Comma</span>: <span class="hljs-number">3</span>
};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>/--- Specific Errors</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ExpiredRequestError</span>(<span class="hljs-params">message</span>) </span>{
  HttpSignatureError.call(<span class="hljs-keyword">this</span>, message, ExpiredRequestError);
}
util.inherits(ExpiredRequestError, HttpSignatureError);


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">InvalidHeaderError</span>(<span class="hljs-params">message</span>) </span>{
  HttpSignatureError.call(<span class="hljs-keyword">this</span>, message, InvalidHeaderError);
}
util.inherits(InvalidHeaderError, HttpSignatureError);


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">InvalidParamsError</span>(<span class="hljs-params">message</span>) </span>{
  HttpSignatureError.call(<span class="hljs-keyword">this</span>, message, InvalidParamsError);
}
util.inherits(InvalidParamsError, HttpSignatureError);


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">MissingHeaderError</span>(<span class="hljs-params">message</span>) </span>{
  HttpSignatureError.call(<span class="hljs-keyword">this</span>, message, MissingHeaderError);
}
util.inherits(MissingHeaderError, HttpSignatureError);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">StrictParsingError</span>(<span class="hljs-params">message</span>) </span>{
  HttpSignatureError.call(<span class="hljs-keyword">this</span>, message, StrictParsingError);
}
util.inherits(StrictParsingError, HttpSignatureError);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>/--- Exported API</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-built_in">module</span>.exports = {

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<div class="dox">
<div class="summary">
<p>Parses the 'Authorization' header out of an http.ServerRequest object.</p>
</div>
<div class="body">
<p>Note that this API will fully validate the Authorization header, and throw
on any error.  It will not however check the signature, or the keyId format
as those are specific to your environment.  You can use the options object
to pass in extra constraints.</p>
<p>As a response object you can expect this:</p>
<pre><code>{
  &quot;scheme&quot;: &quot;Signature&quot;,
  &quot;params&quot;: {
    &quot;keyId&quot;: &quot;foo&quot;,
    &quot;algorithm&quot;: &quot;rsa-sha256&quot;,
    &quot;headers&quot;: [
      &quot;date&quot; or &quot;x-date&quot;,
      &quot;digest&quot;
    ],
    &quot;signature&quot;: &quot;base64&quot;
  },
  &quot;signingString&quot;: &quot;ready to be passed to crypto.verify()&quot;
}</code></pre>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">request</span>
<span class="dox_type">Object</span>
<span>an http.ServerRequest.
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">options</span>
<span class="dox_type">Object</span>
<span>an optional options object with:                   - clockSkew: allowed clock skew in seconds (default 300).
- headers: required header names (def: date or x-date)
- algorithms: algorithms to support (default: all).
- strict: should enforce latest spec parsing
(default: false).
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">Object</span>
<span>parsed out object (see above).
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  parseRequest: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseRequest</span>(<span class="hljs-params">request, options</span>) </span>{
    assert.object(request, <span class="hljs-string">'request'</span>);
    assert.object(request.headers, <span class="hljs-string">'request.headers'</span>);
    <span class="hljs-keyword">if</span> (options === <span class="hljs-literal">undefined</span>) {
      options = {};
    }
    <span class="hljs-keyword">if</span> (options.headers === <span class="hljs-literal">undefined</span>) {
      options.headers = [request.headers[<span class="hljs-string">'x-date'</span>] ? <span class="hljs-string">'x-date'</span> : <span class="hljs-string">'date'</span>];
    }
    assert.object(options, <span class="hljs-string">'options'</span>);
    assert.arrayOfString(options.headers, <span class="hljs-string">'options.headers'</span>);
    assert.optionalNumber(options.clockSkew, <span class="hljs-string">'options.clockSkew'</span>);

    <span class="hljs-keyword">if</span> (!request.headers.authorization)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> MissingHeaderError(<span class="hljs-string">'no authorization header present in '</span> +
                                   <span class="hljs-string">'the request'</span>);

    options.clockSkew = options.clockSkew || <span class="hljs-number">300</span>;


    <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> state = State.New;
    <span class="hljs-keyword">var</span> substate = ParamsState.Name;
    <span class="hljs-keyword">var</span> tmpName = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">var</span> tmpValue = <span class="hljs-string">''</span>;

    <span class="hljs-keyword">var</span> parsed = {
      <span class="hljs-attr">scheme</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">params</span>: {},
      <span class="hljs-attr">signingString</span>: <span class="hljs-string">''</span>,

      get algorithm() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.params.algorithm.toUpperCase();
      },

      get keyId() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.params.keyId;
      }
    };

    <span class="hljs-keyword">var</span> authz = request.headers.authorization;
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; authz.length; i++) {
      <span class="hljs-keyword">var</span> c = authz.charAt(i);

      <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">Number</span>(state)) {

      <span class="hljs-keyword">case</span> State.New:
        <span class="hljs-keyword">if</span> (c !== <span class="hljs-string">' '</span>) parsed.scheme += c;
        <span class="hljs-keyword">else</span> state = State.Params;
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">case</span> State.Params:
        <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">Number</span>(substate)) {

        <span class="hljs-keyword">case</span> ParamsState.Name:
          <span class="hljs-keyword">var</span> code = c.charCodeAt(<span class="hljs-number">0</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>restricted name of A-Z / a-z</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">if</span> ((code &gt;= <span class="hljs-number">0x41</span> &amp;&amp; code &lt;= <span class="hljs-number">0x5a</span>) || <span class="hljs-comment">// A-Z</span>
              (code &gt;= <span class="hljs-number">0x61</span> &amp;&amp; code &lt;= <span class="hljs-number">0x7a</span>)) { <span class="hljs-comment">// a-z</span>
            tmpName += c;
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c === <span class="hljs-string">'='</span>) {
            <span class="hljs-keyword">if</span> (tmpName.length === <span class="hljs-number">0</span>)
              <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidHeaderError(<span class="hljs-string">'bad param format'</span>);
            substate = ParamsState.Quote;
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidHeaderError(<span class="hljs-string">'bad param format'</span>);
          }
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> ParamsState.Quote:
          <span class="hljs-keyword">if</span> (c === <span class="hljs-string">'"'</span>) {
            tmpValue = <span class="hljs-string">''</span>;
            substate = ParamsState.Value;
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidHeaderError(<span class="hljs-string">'bad param format'</span>);
          }
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> ParamsState.Value:
          <span class="hljs-keyword">if</span> (c === <span class="hljs-string">'"'</span>) {
            parsed.params[tmpName] = tmpValue;
            substate = ParamsState.Comma;
          } <span class="hljs-keyword">else</span> {
            tmpValue += c;
          }
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> ParamsState.Comma:
          <span class="hljs-keyword">if</span> (c === <span class="hljs-string">','</span>) {
            tmpName = <span class="hljs-string">''</span>;
            substate = ParamsState.Name;
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidHeaderError(<span class="hljs-string">'bad param format'</span>);
          }
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">default</span>:
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid substate'</span>);
        }
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid substate'</span>);
      }

    }

    <span class="hljs-keyword">if</span> (!parsed.params.headers || parsed.params.headers === <span class="hljs-string">''</span>) {
      <span class="hljs-keyword">if</span> (request.headers[<span class="hljs-string">'x-date'</span>]) {
        parsed.params.headers = [<span class="hljs-string">'x-date'</span>];
      } <span class="hljs-keyword">else</span> {
        parsed.params.headers = [<span class="hljs-string">'date'</span>];
      }
    } <span class="hljs-keyword">else</span> {
      parsed.params.headers = parsed.params.headers.split(<span class="hljs-string">' '</span>);
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Minimally validate the parsed object</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (!parsed.scheme || parsed.scheme !== <span class="hljs-string">'Signature'</span>)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidHeaderError(<span class="hljs-string">'scheme was not "Signature"'</span>);

    <span class="hljs-keyword">if</span> (!parsed.params.keyId)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidHeaderError(<span class="hljs-string">'keyId was not specified'</span>);

    <span class="hljs-keyword">if</span> (!parsed.params.algorithm)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidHeaderError(<span class="hljs-string">'algorithm was not specified'</span>);

    <span class="hljs-keyword">if</span> (!parsed.params.signature)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidHeaderError(<span class="hljs-string">'signature was not specified'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Check the algorithm against the official list</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    parsed.params.algorithm = parsed.params.algorithm.toLowerCase();
    <span class="hljs-keyword">try</span> {
      validateAlgorithm(parsed.params.algorithm);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> InvalidAlgorithmError)
        <span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> InvalidParamsError(parsed.params.algorithm + <span class="hljs-string">' is not '</span> +
          <span class="hljs-string">'supported'</span>));
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">throw</span> (e);
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>Build the signingString</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; parsed.params.headers.length; i++) {
      <span class="hljs-keyword">var</span> h = parsed.params.headers[i].toLowerCase();
      parsed.params.headers[i] = h;

      <span class="hljs-keyword">if</span> (h === <span class="hljs-string">'request-line'</span>) {
        <span class="hljs-keyword">if</span> (!options.strict) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<div class="dox">
<div class="summary">
<p>We allow headers from the older spec drafts if strict parsing isn't
specified in options.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">          parsed.signingString +=
            request.method + <span class="hljs-string">' '</span> + request.url + <span class="hljs-string">' HTTP/'</span> + request.httpVersion;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">/* Strict parsing doesn't allow older draft headers. */</span>
          <span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> StrictParsingError(<span class="hljs-string">'request-line is not a valid header '</span> +
            <span class="hljs-string">'with strict parsing enabled.'</span>));
        }
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (h === <span class="hljs-string">'(request-target)'</span>) {
        parsed.signingString +=
          <span class="hljs-string">'(request-target): '</span> + request.method.toLowerCase() + <span class="hljs-string">' '</span> +
          request.url;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> value = request.headers[h];
        <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>)
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> MissingHeaderError(h + <span class="hljs-string">' was not in the request'</span>);
        parsed.signingString += h + <span class="hljs-string">': '</span> + value;
      }

      <span class="hljs-keyword">if</span> ((i + <span class="hljs-number">1</span>) &lt; parsed.params.headers.length)
        parsed.signingString += <span class="hljs-string">'\n'</span>;
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>Check against the constraints</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> date;
    <span class="hljs-keyword">if</span> (request.headers.date || request.headers[<span class="hljs-string">'x-date'</span>]) {
        <span class="hljs-keyword">if</span> (request.headers[<span class="hljs-string">'x-date'</span>]) {
          date = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(request.headers[<span class="hljs-string">'x-date'</span>]);
        } <span class="hljs-keyword">else</span> {
          date = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(request.headers.date);
        }
      <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
      <span class="hljs-keyword">var</span> skew = <span class="hljs-built_in">Math</span>.abs(now.getTime() - date.getTime());

      <span class="hljs-keyword">if</span> (skew &gt; options.clockSkew * <span class="hljs-number">1000</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ExpiredRequestError(<span class="hljs-string">'clock skew of '</span> +
                                      (skew / <span class="hljs-number">1000</span>) +
                                      <span class="hljs-string">'s was greater than '</span> +
                                      options.clockSkew + <span class="hljs-string">'s'</span>);
      }
    }

    options.headers.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">hdr</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>Remember that we already checked any headers in the params
were in the request, so if this passes we're good.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (parsed.params.headers.indexOf(hdr) &lt; <span class="hljs-number">0</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> MissingHeaderError(hdr + <span class="hljs-string">' was not a signed header'</span>);
    });

    <span class="hljs-keyword">if</span> (options.algorithms) {
      <span class="hljs-keyword">if</span> (options.algorithms.indexOf(parsed.params.algorithm) === <span class="hljs-number">-1</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidParamsError(parsed.params.algorithm +
                                     <span class="hljs-string">' is not a supported algorithm'</span>);
    }

    <span class="hljs-keyword">return</span> parsed;
  }

};

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

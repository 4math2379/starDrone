<!DOCTYPE html>
<html>
<head>
  <title>extract-move.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/tar/test/extract-move.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>extract-move.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>Set the umask, so that it works the same everywhere.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">process.umask(<span class="hljs-built_in">parseInt</span>(<span class="hljs-string">'22'</span>, <span class="hljs-number">8</span>))

<span class="hljs-keyword">var</span> tap = <span class="hljs-built_in">require</span>(<span class="hljs-string">"tap"</span>)
  , tar = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../tar.js"</span>)
  , fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>)
  , gfs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"graceful-fs"</span>)
  , path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>)
  , file = path.resolve(__dirname, <span class="hljs-string">"fixtures/dir.tar"</span>)
  , target = path.resolve(__dirname, <span class="hljs-string">"tmp/extract-test"</span>)
  , index = <span class="hljs-number">0</span>
  , fstream = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fstream"</span>)
  , rimraf = <span class="hljs-built_in">require</span>(<span class="hljs-string">"rimraf"</span>)
  , mkdirp = <span class="hljs-built_in">require</span>(<span class="hljs-string">"mkdirp"</span>)

  , ee = <span class="hljs-number">0</span>
  , expectEntries = [
      {
        <span class="hljs-string">"path"</span> : <span class="hljs-string">"dir/"</span>,
        <span class="hljs-string">"mode"</span> : <span class="hljs-string">"750"</span>,
        <span class="hljs-string">"type"</span> : <span class="hljs-string">"5"</span>,
        <span class="hljs-string">"depth"</span> : <span class="hljs-literal">undefined</span>,
        <span class="hljs-string">"size"</span> : <span class="hljs-number">0</span>,
        <span class="hljs-string">"linkpath"</span> : <span class="hljs-string">""</span>,
        <span class="hljs-string">"nlink"</span> : <span class="hljs-literal">undefined</span>,
        <span class="hljs-string">"dev"</span> : <span class="hljs-literal">undefined</span>,
        <span class="hljs-string">"ino"</span> : <span class="hljs-literal">undefined</span>
      },
      {
        <span class="hljs-string">"path"</span> : <span class="hljs-string">"dir/sub/"</span>,
        <span class="hljs-string">"mode"</span> : <span class="hljs-string">"750"</span>,
        <span class="hljs-string">"type"</span> : <span class="hljs-string">"5"</span>,
        <span class="hljs-string">"depth"</span> : <span class="hljs-literal">undefined</span>,
        <span class="hljs-string">"size"</span> : <span class="hljs-number">0</span>,
        <span class="hljs-string">"linkpath"</span> : <span class="hljs-string">""</span>,
        <span class="hljs-string">"nlink"</span> : <span class="hljs-literal">undefined</span>,
        <span class="hljs-string">"dev"</span> : <span class="hljs-literal">undefined</span>,
        <span class="hljs-string">"ino"</span> : <span class="hljs-literal">undefined</span>
      } ]

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">slow</span> (<span class="hljs-params">fs, method, t1, t2</span>) </span>{
  <span class="hljs-keyword">var</span> orig = fs[method]
  <span class="hljs-keyword">if</span> (!orig) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
  fs[method] = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>)
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"slow"</span>, method, args[<span class="hljs-number">0</span>])
    <span class="hljs-keyword">var</span> cb = args.pop()

    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      orig.apply(fs, args.concat(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">er, data</span>) </span>{
        setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          cb(er, data)
        }, t2)
      }))
    }, t1)
  }
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Make sure we get the graceful-fs that fstream is using.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> gfs2
<span class="hljs-keyword">try</span> {
  gfs2 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fstream/node_modules/graceful-fs"</span>)
} <span class="hljs-keyword">catch</span> (er) {}

<span class="hljs-keyword">var</span> slowMethods = [<span class="hljs-string">"chown"</span>, <span class="hljs-string">"chmod"</span>, <span class="hljs-string">"utimes"</span>, <span class="hljs-string">"lutimes"</span>]
slowMethods.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">method</span>) </span>{
  <span class="hljs-keyword">var</span> t1 = <span class="hljs-number">500</span>
  <span class="hljs-keyword">var</span> t2 = <span class="hljs-number">0</span>
  slow(fs, method, t1, t2)
  slow(gfs, method, t1, t2)
  <span class="hljs-keyword">if</span> (gfs2) {
    slow(gfs2, method, t1, t2)
  }
})



</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>The extract class basically just pipes the input
to a Reader, and then to a fstream.DirWriter</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>So, this is as much a test of fstream.Reader and fstream.Writer
as it is of tar.Extract, but it sort of makes sense.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
tap.test(<span class="hljs-string">"preclean"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  rimraf.sync(target)
  /mkdirp.sync(target)
  t.pass(<span class="hljs-string">"cleaned!"</span>)
  t.end()
})

tap.test(<span class="hljs-string">"extract test"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  <span class="hljs-keyword">var</span> extract = tar.Extract(target)
  <span class="hljs-keyword">var</span> inp = fs.createReadStream(file)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>give it a weird buffer size to try to break in odd places</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  inp.bufferSize = <span class="hljs-number">1234</span>

  inp.pipe(extract)

  extract.on(<span class="hljs-string">"end"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    rimraf.sync(target)

    t.equal(ee, expectEntries.length, <span class="hljs-string">"should see "</span>+ee+<span class="hljs-string">" entries"</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>should get no more entries after end</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    extract.removeAllListeners(<span class="hljs-string">"entry"</span>)
    extract.on(<span class="hljs-string">"entry"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{
      t.fail(<span class="hljs-string">"Should not get entries after end!"</span>)
    })

    t.end()
  })


  extract.on(<span class="hljs-string">"entry"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry</span>) </span>{
    <span class="hljs-keyword">var</span> found =
      { <span class="hljs-attr">path</span>: entry.path
      , <span class="hljs-attr">mode</span>: entry.props.mode.toString(<span class="hljs-number">8</span>)
      , <span class="hljs-attr">type</span>: entry.props.type
      , <span class="hljs-attr">depth</span>: entry.props.depth
      , <span class="hljs-attr">size</span>: entry.props.size
      , <span class="hljs-attr">linkpath</span>: entry.props.linkpath
      , <span class="hljs-attr">nlink</span>: entry.props.nlink
      , <span class="hljs-attr">dev</span>: entry.props.dev
      , <span class="hljs-attr">ino</span>: entry.props.ino
      }

    <span class="hljs-keyword">var</span> wanted = expectEntries[ee ++]

    t.equivalent(found, wanted, <span class="hljs-string">"tar entry "</span> + ee + <span class="hljs-string">" "</span> + wanted.path)
  })
})

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>entry-writer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/tar/lib/entry-writer.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>entry-writer.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-built_in">module</span>.exports = EntryWriter

<span class="hljs-keyword">var</span> tar = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../tar.js"</span>)
  , TarHeader = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./header.js"</span>)
  , Entry = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./entry.js"</span>)
  , inherits = <span class="hljs-built_in">require</span>(<span class="hljs-string">"inherits"</span>)
  , BlockStream = <span class="hljs-built_in">require</span>(<span class="hljs-string">"block-stream"</span>)
  , ExtendedHeaderWriter
  , Stream = <span class="hljs-built_in">require</span>(<span class="hljs-string">"stream"</span>).Stream
  , EOF = {}

inherits(EntryWriter, Stream)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EntryWriter</span> (<span class="hljs-params">props</span>) </span>{
  <span class="hljs-keyword">var</span> me = <span class="hljs-keyword">this</span>

  <span class="hljs-keyword">if</span> (!(me <span class="hljs-keyword">instanceof</span> EntryWriter)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> EntryWriter(props)
  }

  Stream.apply(<span class="hljs-keyword">this</span>)

  me.writable = <span class="hljs-literal">true</span>
  me.readable = <span class="hljs-literal">true</span>

  me._stream = <span class="hljs-keyword">new</span> BlockStream(<span class="hljs-number">512</span>)

  me._stream.on(<span class="hljs-string">"data"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
    me.emit(<span class="hljs-string">"data"</span>, c)
  })

  me._stream.on(<span class="hljs-string">"drain"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    me.emit(<span class="hljs-string">"drain"</span>)
  })

  me._stream.on(<span class="hljs-string">"end"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    me.emit(<span class="hljs-string">"end"</span>)
    me.emit(<span class="hljs-string">"close"</span>)
  })

  me.props = props
  <span class="hljs-keyword">if</span> (props.type === <span class="hljs-string">"Directory"</span>) {
    props.size = <span class="hljs-number">0</span>
  }
  props.ustar = <span class="hljs-string">"ustar\0"</span>
  props.ustarver = <span class="hljs-string">"00"</span>
  me.path = props.path

  me._buffer = []
  me._didHeader = <span class="hljs-literal">false</span>
  me._meta = <span class="hljs-literal">false</span>

  me.on(<span class="hljs-string">"pipe"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    me._process()
  })
}

EntryWriter.prototype.write = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>console.error(&quot;.. ew write&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._ended) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"error"</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"write after end"</span>))
  <span class="hljs-keyword">this</span>._buffer.push(c)
  <span class="hljs-keyword">this</span>._process()
  <span class="hljs-keyword">this</span>._needDrain = <span class="hljs-keyword">this</span>._buffer.length &gt; <span class="hljs-number">0</span>
  <span class="hljs-keyword">return</span> !<span class="hljs-keyword">this</span>._needDrain
}

EntryWriter.prototype.end = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>console.error(&quot;.. ew end&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (c) <span class="hljs-keyword">this</span>._buffer.push(c)
  <span class="hljs-keyword">this</span>._buffer.push(EOF)
  <span class="hljs-keyword">this</span>._ended = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">this</span>._process()
  <span class="hljs-keyword">this</span>._needDrain = <span class="hljs-keyword">this</span>._buffer.length &gt; <span class="hljs-number">0</span>
}

EntryWriter.prototype.pause = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>console.error(&quot;.. ew pause&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>._paused = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"pause"</span>)
}

EntryWriter.prototype.resume = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>console.error(&quot;.. ew resume&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>._paused = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"resume"</span>)
  <span class="hljs-keyword">this</span>._process()
}

EntryWriter.prototype.add = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>console.error(&quot;.. ew add&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.parent) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"error"</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"no parent"</span>))

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>make sure that the _header and such is emitted, and clear out
the _currentEntry link on the parent.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._ended) <span class="hljs-keyword">this</span>.end()

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.parent.add(entry)
}

EntryWriter.prototype._header = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>console.error(&quot;.. ew header&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._didHeader) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">this</span>._didHeader = <span class="hljs-literal">true</span>

  <span class="hljs-keyword">var</span> headerBlock = TarHeader.encode(<span class="hljs-keyword">this</span>.props)

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.props.needExtended &amp;&amp; !<span class="hljs-keyword">this</span>._meta) {
    <span class="hljs-keyword">var</span> me = <span class="hljs-keyword">this</span>

    ExtendedHeaderWriter = ExtendedHeaderWriter ||
      <span class="hljs-built_in">require</span>(<span class="hljs-string">"./extended-header-writer.js"</span>)

    ExtendedHeaderWriter(<span class="hljs-keyword">this</span>.props)
      .on(<span class="hljs-string">"data"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
        me.emit(<span class="hljs-string">"data"</span>, c)
      })
      .on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
        me.emit(<span class="hljs-string">"error"</span>, er)
      })
      .end()
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>console.error(&quot;.. .. ew headerBlock emitting&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"data"</span>, headerBlock)
  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"header"</span>)
}

EntryWriter.prototype._process = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>console.error(&quot;.. .. ew process&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._didHeader &amp;&amp; !<span class="hljs-keyword">this</span>._meta) {
    <span class="hljs-keyword">this</span>._header()
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._paused || <span class="hljs-keyword">this</span>._processing) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>console.error(&quot;.. .. .. paused=%j, processing=%j&quot;, this._paused, this._processing)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">this</span>._processing = <span class="hljs-literal">true</span>

  <span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">this</span>._buffer
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; buf.length; i ++) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>console.error(&quot;.. .. .. i=%d&quot;, i)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> c = buf[i]

    <span class="hljs-keyword">if</span> (c === EOF) <span class="hljs-keyword">this</span>._stream.end()
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>._stream.write(c)

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._paused) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>console.error(&quot;.. .. .. paused mid-emission&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">this</span>._processing = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">if</span> (i &lt; buf.length) {
        <span class="hljs-keyword">this</span>._needDrain = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">this</span>._buffer = buf.slice(i + <span class="hljs-number">1</span>)
      }
      <span class="hljs-keyword">return</span>
    }
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>console.error(&quot;.. .. .. emitted&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>._buffer.length = <span class="hljs-number">0</span>
  <span class="hljs-keyword">this</span>._processing = <span class="hljs-literal">false</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>console.error(&quot;.. .. .. emitting drain&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"drain"</span>)
}

EntryWriter.prototype.destroy = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

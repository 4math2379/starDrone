<!DOCTYPE html>
<html>
<head>
  <title>parse.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/tar/lib/parse.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>parse.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>A writable stream.
It emits &quot;entry&quot; events, which provide a readable stream that has
header info attached.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-built_in">module</span>.exports = Parse.create = Parse

<span class="hljs-keyword">var</span> stream = <span class="hljs-built_in">require</span>(<span class="hljs-string">"stream"</span>)
  , Stream = stream.Stream
  , BlockStream = <span class="hljs-built_in">require</span>(<span class="hljs-string">"block-stream"</span>)
  , tar = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../tar.js"</span>)
  , TarHeader = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./header.js"</span>)
  , Entry = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./entry.js"</span>)
  , BufferEntry = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./buffer-entry.js"</span>)
  , ExtendedHeader = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./extended-header.js"</span>)
  , assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">"assert"</span>).ok
  , inherits = <span class="hljs-built_in">require</span>(<span class="hljs-string">"inherits"</span>)
  , fstream = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fstream"</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>reading a tar is a lot like reading a directory
However, we're actually not going to run the ctor,
since it does a stat and various other stuff.
This inheritance gives us the pause/resume/pipe
behavior that is desired.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">inherits(Parse, fstream.Reader)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Parse</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> me = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">if</span> (!(me <span class="hljs-keyword">instanceof</span> Parse)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Parse()

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>doesn't apply fstream.Reader ctor?
no, becasue we don't want to stat/etc, we just
want to get the entry/add logic from .pipe()</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  Stream.apply(me)

  me.writable = <span class="hljs-literal">true</span>
  me.readable = <span class="hljs-literal">true</span>
  me._stream = <span class="hljs-keyword">new</span> BlockStream(<span class="hljs-number">512</span>)
  me.position = <span class="hljs-number">0</span>
  me._ended = <span class="hljs-literal">false</span>

  me._stream.on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{
    me.emit(<span class="hljs-string">"error"</span>, e)
  })

  me._stream.on(<span class="hljs-string">"data"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
    me._process(c)
  })

  me._stream.on(<span class="hljs-string">"end"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    me._streamEnd()
  })

  me._stream.on(<span class="hljs-string">"drain"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    me.emit(<span class="hljs-string">"drain"</span>)
  })
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>overridden in Extract class, since it needs to
wait for its DirWriter part to finish before
emitting &quot;end&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">Parse.prototype._streamEnd = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> me = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">if</span> (!me._ended || me._entry) me.error(<span class="hljs-string">"unexpected eof"</span>)
  me.emit(<span class="hljs-string">"end"</span>)
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>a tar reader is actually a filter, not just a readable stream.
So, you should pipe a tarball stream into it, and it needs these
write/end methods to do that.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">Parse.prototype.write = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._ended) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>gnutar puts a LOT of nulls at the end.
you can keep writing these things forever.
Just ignore them.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = c.length; i &gt; l; i ++) {
      <span class="hljs-keyword">if</span> (c[i] !== <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.error(<span class="hljs-string">"write() after end()"</span>)
    }
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._stream.write(c)
}

Parse.prototype.end = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
  <span class="hljs-keyword">this</span>._ended = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._stream.end(c)
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>don't need to do anything, since we're just
proxying the data up from the _stream.
Just need to override the parent's &quot;Not Implemented&quot;
error-thrower.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">Parse.prototype._read = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{}

Parse.prototype._process = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
  assert(c &amp;&amp; c.length === <span class="hljs-number">512</span>, <span class="hljs-string">"block size should be 512"</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>one of three cases.</p>
<ol>
<li>A new header</li>
<li>A part of a file/extended header</li>
<li>One of two or more EOF null blocks</li>
</ol>

        </td>
        <td class="code highlight">
          <pre class="javascript">
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._entry) {
    <span class="hljs-keyword">var</span> entry = <span class="hljs-keyword">this</span>._entry
    <span class="hljs-keyword">if</span>(!entry._abort) entry.write(c)
    <span class="hljs-keyword">else</span> {
      entry._remaining -= c.length
      <span class="hljs-keyword">if</span>(entry._remaining &lt; <span class="hljs-number">0</span>) entry._remaining = <span class="hljs-number">0</span>
    }
    <span class="hljs-keyword">if</span> (entry._remaining === <span class="hljs-number">0</span>) {
      entry.end()
      <span class="hljs-keyword">this</span>._entry = <span class="hljs-literal">null</span>
    }
  } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>either zeroes or a header</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> zero = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">512</span> &amp;&amp; zero; i ++) {
      zero = c[i] === <span class="hljs-number">0</span>
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>eof is <em>at least</em> 2 blocks of nulls, and then the end of the
file.  you can put blocks of nulls between entries anywhere,
so appending one tarball to another is technically valid.
ending without the eof null blocks is not allowed, however.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (zero) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._eofStarted)
        <span class="hljs-keyword">this</span>._ended = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">this</span>._eofStarted = <span class="hljs-literal">true</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>._eofStarted = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">this</span>._startEntry(c)
    }
  }

  <span class="hljs-keyword">this</span>.position += <span class="hljs-number">512</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>take a header chunk, start the right kind of entry.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">Parse.prototype._startEntry = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
  <span class="hljs-keyword">var</span> header = <span class="hljs-keyword">new</span> TarHeader(c)
    , self = <span class="hljs-keyword">this</span>
    , entry
    , ev
    , EntryType
    , onend
    , meta = <span class="hljs-literal">false</span>

  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> === header.size || !header.cksumValid) {
    <span class="hljs-keyword">var</span> e = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"invalid tar file"</span>)
    e.header = header
    e.tar_file_offset = <span class="hljs-keyword">this</span>.position
    e.tar_block = <span class="hljs-keyword">this</span>.position / <span class="hljs-number">512</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"error"</span>, e)
  }

  <span class="hljs-keyword">switch</span> (tar.types[header.type]) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"File"</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">"OldFile"</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">"Link"</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">"SymbolicLink"</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">"CharacterDevice"</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">"BlockDevice"</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">"Directory"</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">"FIFO"</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">"ContiguousFile"</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">"GNUDumpDir"</span>:
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>start a file.
pass in any extended headers
These ones consumers are typically most interested in.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      EntryType = Entry
      ev = <span class="hljs-string">"entry"</span>
      <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">case</span> <span class="hljs-string">"GlobalExtendedHeader"</span>:
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>extended headers that apply to the rest of the tarball</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      EntryType = ExtendedHeader
      onend = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        self._global = self._global || {}
        <span class="hljs-built_in">Object</span>.keys(entry.fields).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">k</span>) </span>{
          self._global[k] = entry.fields[k]
        })
      }
      ev = <span class="hljs-string">"globalExtendedHeader"</span>
      meta = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">case</span> <span class="hljs-string">"ExtendedHeader"</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">"OldExtendedHeader"</span>:
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>extended headers that apply to the next entry</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      EntryType = ExtendedHeader
      onend = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        self._extended = entry.fields
      }
      ev = <span class="hljs-string">"extendedHeader"</span>
      meta = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">case</span> <span class="hljs-string">"NextFileHasLongLinkpath"</span>:
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>set linkpath=<contents> in extended header</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      EntryType = BufferEntry
      onend = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        self._extended = self._extended || {}
        self._extended.linkpath = entry.body
      }
      ev = <span class="hljs-string">"longLinkpath"</span>
      meta = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">case</span> <span class="hljs-string">"NextFileHasLongPath"</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">"OldGnuLongPath"</span>:
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>set path=<contents> in file-extended header</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      EntryType = BufferEntry
      onend = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        self._extended = self._extended || {}
        self._extended.path = entry.body
      }
      ev = <span class="hljs-string">"longPath"</span>
      meta = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">default</span>:
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>all the rest we skip, but still set the _entry
member, so that we can skip over their data appropriately.
emit an event to say that this is an ignored entry type?</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      EntryType = Entry
      ev = <span class="hljs-string">"ignoredEntry"</span>
      <span class="hljs-keyword">break</span>
  }

  <span class="hljs-keyword">var</span> global, extended
  <span class="hljs-keyword">if</span> (meta) {
    global = extended = <span class="hljs-literal">null</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">var</span> global = <span class="hljs-keyword">this</span>._global
    <span class="hljs-keyword">var</span> extended = <span class="hljs-keyword">this</span>._extended

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>extendedHeader only applies to one entry, so once we start
an entry, it's over.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">this</span>._extended = <span class="hljs-literal">null</span>
  }
  entry = <span class="hljs-keyword">new</span> EntryType(header, extended, global)
  entry.meta = meta

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>only proxy data events of normal files.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!meta) {
    entry.on(<span class="hljs-string">"data"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
      me.emit(<span class="hljs-string">"data"</span>, c)
    })
  }

  <span class="hljs-keyword">if</span> (onend) entry.on(<span class="hljs-string">"end"</span>, onend)

  <span class="hljs-keyword">this</span>._entry = entry
  <span class="hljs-keyword">var</span> me = <span class="hljs-keyword">this</span>

  entry.on(<span class="hljs-string">"pause"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    me.pause()
  })

  entry.on(<span class="hljs-string">"resume"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    me.resume()
  })

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.listeners(<span class="hljs-string">"*"</span>).length) {
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"*"</span>, ev, entry)
  }

  <span class="hljs-keyword">this</span>.emit(ev, entry)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>Zero-byte entry.  End immediately.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (entry.props.size === <span class="hljs-number">0</span>) {
    entry.end()
    <span class="hljs-keyword">this</span>._entry = <span class="hljs-literal">null</span>
  }
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

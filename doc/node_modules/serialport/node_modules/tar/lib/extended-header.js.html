<!DOCTYPE html>
<html>
<head>
  <title>extended-header.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/tar/lib/extended-header.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>extended-header.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>An Entry consisting of:</p>
<p>&quot;%d %s=%s\n&quot;, <length>, <keyword>, <value></p>
<p>The length is a decimal number, and includes itself and the \n
\0 does not terminate anything.  Only the length terminates the string.
Numeric values are decimal strings.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-built_in">module</span>.exports = ExtendedHeader

<span class="hljs-keyword">var</span> Entry = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./entry.js"</span>)
  , inherits = <span class="hljs-built_in">require</span>(<span class="hljs-string">"inherits"</span>)
  , tar = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../tar.js"</span>)
  , numeric = tar.numeric
  , keyTrans = { <span class="hljs-string">"SCHILY.dev"</span>: <span class="hljs-string">"dev"</span>
               , <span class="hljs-string">"SCHILY.ino"</span>: <span class="hljs-string">"ino"</span>
               , <span class="hljs-string">"SCHILY.nlink"</span>: <span class="hljs-string">"nlink"</span> }

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ExtendedHeader</span> (<span class="hljs-params"></span>) </span>{
  Entry.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>)
  <span class="hljs-keyword">this</span>.on(<span class="hljs-string">"data"</span>, <span class="hljs-keyword">this</span>._parse)
  <span class="hljs-keyword">this</span>.fields = {}
  <span class="hljs-keyword">this</span>._position = <span class="hljs-number">0</span>
  <span class="hljs-keyword">this</span>._fieldPos = <span class="hljs-number">0</span>
  <span class="hljs-keyword">this</span>._state = SIZE
  <span class="hljs-keyword">this</span>._sizeBuf = []
  <span class="hljs-keyword">this</span>._keyBuf = []
  <span class="hljs-keyword">this</span>._valBuf = []
  <span class="hljs-keyword">this</span>._size = <span class="hljs-number">-1</span>
  <span class="hljs-keyword">this</span>._key = <span class="hljs-string">""</span>
}

inherits(ExtendedHeader, Entry)
ExtendedHeader.prototype._parse = parse

<span class="hljs-keyword">var</span> s = <span class="hljs-number">0</span>
  , states = ExtendedHeader.states = {}
  , SIZE = states.SIZE = s++
  , KEY  = states.KEY  = s++
  , VAL  = states.VAL  = s++
  , ERR  = states.ERR  = s++

<span class="hljs-built_in">Object</span>.keys(states).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">s</span>) </span>{
  states[states[s]] = states[s]
})

states[s] = <span class="hljs-literal">null</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>char code values for comparison</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> _0 = <span class="hljs-string">"0"</span>.charCodeAt(<span class="hljs-number">0</span>)
  , _9 = <span class="hljs-string">"9"</span>.charCodeAt(<span class="hljs-number">0</span>)
  , point = <span class="hljs-string">"."</span>.charCodeAt(<span class="hljs-number">0</span>)
  , a = <span class="hljs-string">"a"</span>.charCodeAt(<span class="hljs-number">0</span>)
  , Z = <span class="hljs-string">"Z"</span>.charCodeAt(<span class="hljs-number">0</span>)
  , a = <span class="hljs-string">"a"</span>.charCodeAt(<span class="hljs-number">0</span>)
  , z = <span class="hljs-string">"z"</span>.charCodeAt(<span class="hljs-number">0</span>)
  , space = <span class="hljs-string">" "</span>.charCodeAt(<span class="hljs-number">0</span>)
  , eq = <span class="hljs-string">"="</span>.charCodeAt(<span class="hljs-number">0</span>)
  , cr = <span class="hljs-string">"\n"</span>.charCodeAt(<span class="hljs-number">0</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse</span> (<span class="hljs-params">c</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._state === ERR) <span class="hljs-keyword">return</span>

  <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = c.length
      ; i &lt; l
      ; <span class="hljs-keyword">this</span>._position++, <span class="hljs-keyword">this</span>._fieldPos++, i++) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>console.error(&quot;top of loop, size=&quot;+this._size)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> b = c[i]

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._size &gt;= <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">this</span>._fieldPos &gt; <span class="hljs-keyword">this</span>._size) {
      error(<span class="hljs-keyword">this</span>, <span class="hljs-string">"field exceeds length="</span>+<span class="hljs-keyword">this</span>._size)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>._state) {
      <span class="hljs-keyword">case</span> ERR: <span class="hljs-keyword">return</span>

      <span class="hljs-keyword">case</span> SIZE:
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>console.error(&quot;parsing size, b=%d, rest=%j&quot;, b, c.slice(i).toString())</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (b === space) {
          <span class="hljs-keyword">this</span>._state = KEY
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>this._fieldPos = this._sizeBuf.length</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">this</span>._size = <span class="hljs-built_in">parseInt</span>(<span class="hljs-keyword">new</span> Buffer(<span class="hljs-keyword">this</span>._sizeBuf).toString(), <span class="hljs-number">10</span>)
          <span class="hljs-keyword">this</span>._sizeBuf.length = <span class="hljs-number">0</span>
          <span class="hljs-keyword">continue</span>
        }
        <span class="hljs-keyword">if</span> (b &lt; _0 || b &gt; _9) {
          error(<span class="hljs-keyword">this</span>, <span class="hljs-string">"expected ["</span> + _0 + <span class="hljs-string">".."</span> + _9 + <span class="hljs-string">"], got "</span> + b)
          <span class="hljs-keyword">return</span>
        }
        <span class="hljs-keyword">this</span>._sizeBuf.push(b)
        <span class="hljs-keyword">continue</span>

      <span class="hljs-keyword">case</span> KEY:
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>can be any char except =, not &gt; size.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (b === eq) {
          <span class="hljs-keyword">this</span>._state = VAL
          <span class="hljs-keyword">this</span>._key = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-keyword">this</span>._keyBuf).toString()
          <span class="hljs-keyword">if</span> (keyTrans[<span class="hljs-keyword">this</span>._key]) <span class="hljs-keyword">this</span>._key = keyTrans[<span class="hljs-keyword">this</span>._key]
          <span class="hljs-keyword">this</span>._keyBuf.length = <span class="hljs-number">0</span>
          <span class="hljs-keyword">continue</span>
        }
        <span class="hljs-keyword">this</span>._keyBuf.push(b)
        <span class="hljs-keyword">continue</span>

      <span class="hljs-keyword">case</span> VAL:
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>field must end with cr</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._fieldPos === <span class="hljs-keyword">this</span>._size - <span class="hljs-number">1</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>console.error(&quot;finished with &quot;+this._key)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">if</span> (b !== cr) {
            error(<span class="hljs-keyword">this</span>, <span class="hljs-string">"expected \\n at end of field"</span>)
            <span class="hljs-keyword">return</span>
          }
          <span class="hljs-keyword">var</span> val = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-keyword">this</span>._valBuf).toString()
          <span class="hljs-keyword">if</span> (numeric[<span class="hljs-keyword">this</span>._key]) {
            val = <span class="hljs-built_in">parseFloat</span>(val)
          }
          <span class="hljs-keyword">this</span>.fields[<span class="hljs-keyword">this</span>._key] = val

          <span class="hljs-keyword">this</span>._valBuf.length = <span class="hljs-number">0</span>
          <span class="hljs-keyword">this</span>._state = SIZE
          <span class="hljs-keyword">this</span>._size = <span class="hljs-number">-1</span>
          <span class="hljs-keyword">this</span>._fieldPos = <span class="hljs-number">-1</span>
          <span class="hljs-keyword">continue</span>
        }
        <span class="hljs-keyword">this</span>._valBuf.push(b)
        <span class="hljs-keyword">continue</span>
    }
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">error</span> (<span class="hljs-params">me, msg</span>) </span>{
  msg = <span class="hljs-string">"invalid header: "</span> + msg
      + <span class="hljs-string">"\nposition="</span> + me._position
      + <span class="hljs-string">"\nfield position="</span> + me._fieldPos

  me.error(msg)
  me.state = ERR
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

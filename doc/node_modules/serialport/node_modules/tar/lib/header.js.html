<!DOCTYPE html>
<html>
<head>
  <title>header.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/tar/lib/header.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>header.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>parse a 512-byte header block to a data object, or vice-versa
If the data won't fit nicely in a simple header, then generate
the appropriate extended header file, and return that.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-built_in">module</span>.exports = TarHeader

<span class="hljs-keyword">var</span> tar = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../tar.js"</span>)
  , fields = tar.fields
  , fieldOffs = tar.fieldOffs
  , fieldEnds = tar.fieldEnds
  , fieldSize = tar.fieldSize
  , numeric = tar.numeric
  , assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">"assert"</span>).ok
  , space = <span class="hljs-string">" "</span>.charCodeAt(<span class="hljs-number">0</span>)
  , slash = <span class="hljs-string">"/"</span>.charCodeAt(<span class="hljs-number">0</span>)
  , bslash = process.platform === <span class="hljs-string">"win32"</span> ? <span class="hljs-string">"\\"</span>.charCodeAt(<span class="hljs-number">0</span>) : <span class="hljs-literal">null</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TarHeader</span> (<span class="hljs-params">block</span>) </span>{
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> TarHeader)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TarHeader(block)
  <span class="hljs-keyword">if</span> (block) <span class="hljs-keyword">this</span>.decode(block)
}

TarHeader.prototype =
  { <span class="hljs-attr">decode</span> : decode
  , <span class="hljs-attr">encode</span>: encode
  , <span class="hljs-attr">calcSum</span>: calcSum
  , <span class="hljs-attr">checkSum</span>: checkSum
  }

TarHeader.parseNumeric = parseNumeric
TarHeader.encode = encode
TarHeader.decode = decode

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>note that this will only do the normal ustar header, not any kind
of extended posix header file.  If something doesn't fit comfortably,
then it will set obj.needExtended = true, and set the block to
the closest approximation.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encode</span> (<span class="hljs-params">obj</span>) </span>{
  <span class="hljs-keyword">if</span> (!obj &amp;&amp; !(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> TarHeader)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(
    <span class="hljs-string">"encode must be called on a TarHeader, or supplied an object"</span>)

  obj = obj || <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">var</span> block = obj.block = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">512</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>if the object has a &quot;prefix&quot;, then that's actually an extension of
the path field.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (obj.prefix) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>console.error(&quot;%% header encoding, got a prefix&quot;, obj.prefix)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    obj.path = obj.prefix + <span class="hljs-string">"/"</span> + obj.path
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>console.error(&quot;%% header encoding, prefixed path&quot;, obj.path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    obj.prefix = <span class="hljs-string">""</span>
  }

  obj.needExtended = <span class="hljs-literal">false</span>

  <span class="hljs-keyword">if</span> (obj.mode) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj.mode === <span class="hljs-string">"string"</span>) obj.mode = <span class="hljs-built_in">parseInt</span>(obj.mode, <span class="hljs-number">8</span>)
    obj.mode = obj.mode &amp; <span class="hljs-number">0777</span>
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> f = <span class="hljs-number">0</span>; fields[f] !== <span class="hljs-literal">null</span>; f ++) {
    <span class="hljs-keyword">var</span> field = fields[f]
      , off = fieldOffs[f]
      , end = fieldEnds[f]
      , ret

    <span class="hljs-keyword">switch</span> (field) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"cksum"</span>:
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>special, done below, after all the others</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">break</span>

      <span class="hljs-keyword">case</span> <span class="hljs-string">"prefix"</span>:
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>special, this is an extension of the &quot;path&quot; field.
console.error(&quot;%% header encoding, skip prefix later&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">break</span>

      <span class="hljs-keyword">case</span> <span class="hljs-string">"type"</span>:
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>convert from long name to a single char.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">var</span> type = obj.type || <span class="hljs-string">"0"</span>
        <span class="hljs-keyword">if</span> (type.length &gt; <span class="hljs-number">1</span>) {
          type = tar.types[obj.type]
          <span class="hljs-keyword">if</span> (!type) type = <span class="hljs-string">"0"</span>
        }
        writeText(block, off, end, type)
        <span class="hljs-keyword">break</span>

      <span class="hljs-keyword">case</span> <span class="hljs-string">"path"</span>:
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>uses the &quot;prefix&quot; field if &gt; 100 bytes, but &lt;= 255</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">var</span> pathLen = Buffer.byteLength(obj.path)
          , pathFSize = fieldSize[fields.path]
          , prefFSize = fieldSize[fields.prefix]

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>paths between 100 and 255 should use the prefix field.
longer than 255</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (pathLen &gt; pathFSize &amp;&amp;
            pathLen &lt;= pathFSize + prefFSize) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>need to find a slash somewhere in the middle so that
path and prefix both fit in their respective fields</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">var</span> searchStart = pathLen - <span class="hljs-number">1</span> - pathFSize
            , searchEnd = prefFSize
            , found = <span class="hljs-literal">false</span>
            , pathBuf = <span class="hljs-keyword">new</span> Buffer(obj.path)

          <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> s = searchStart
              ; (s &lt;= searchEnd)
              ; s ++ ) {
            <span class="hljs-keyword">if</span> (pathBuf[s] === slash || pathBuf[s] === bslash) {
              found = s
              <span class="hljs-keyword">break</span>
            }
          }

          <span class="hljs-keyword">if</span> (found !== <span class="hljs-literal">false</span>) {
            prefix = pathBuf.slice(<span class="hljs-number">0</span>, found).toString(<span class="hljs-string">"utf8"</span>)
            path = pathBuf.slice(found + <span class="hljs-number">1</span>).toString(<span class="hljs-string">"utf8"</span>)

            ret = writeText(block, off, end, path)
            off = fieldOffs[fields.prefix]
            end = fieldEnds[fields.prefix]
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>console.error(&quot;%% header writing prefix&quot;, off, end, prefix)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            ret = writeText(block, off, end, prefix) || ret
            <span class="hljs-keyword">break</span>
          }
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>paths less than 100 chars don't need a prefix
and paths longer than 255 need an extended header and will fail
on old implementations no matter what we do here.
Null out the prefix, and fallthrough to default.
console.error(&quot;%% header writing no prefix&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">var</span> poff = fieldOffs[fields.prefix]
          , pend = fieldEnds[fields.prefix]
        writeText(block, poff, pend, <span class="hljs-string">""</span>)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>fallthrough</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>all other fields are numeric or text</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">default</span>:
        ret = numeric[field]
            ? writeNumeric(block, off, end, obj[field])
            : writeText(block, off, end, obj[field] || <span class="hljs-string">""</span>)
        <span class="hljs-keyword">break</span>
    }
    obj.needExtended = obj.needExtended || ret
  }

  <span class="hljs-keyword">var</span> off = fieldOffs[fields.cksum]
    , end = fieldEnds[fields.cksum]

  writeNumeric(block, off, end, calcSum.call(<span class="hljs-keyword">this</span>, block))

  <span class="hljs-keyword">return</span> block
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>if it's a negative number, or greater than will fit,
then use write256.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> MAXNUM = { <span class="hljs-number">12</span>: <span class="hljs-number">077777777777</span>
             , <span class="hljs-number">11</span>: <span class="hljs-number">07777777777</span>
             , <span class="hljs-number">8</span> : <span class="hljs-number">07777777</span>
             , <span class="hljs-number">7</span> : <span class="hljs-number">0777777</span> }
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeNumeric</span> (<span class="hljs-params">block, off, end, num</span>) </span>{
  <span class="hljs-keyword">var</span> writeLen = end - off
    , maxNum = MAXNUM[writeLen] || <span class="hljs-number">0</span>

  num = num || <span class="hljs-number">0</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>console.error(&quot;  numeric&quot;, num)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
  <span class="hljs-keyword">if</span> (num <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Date</span> ||
      <span class="hljs-built_in">Object</span>.prototype.toString.call(num) === <span class="hljs-string">"[object Date]"</span>) {
    num = num.getTime() / <span class="hljs-number">1000</span>
  }

  <span class="hljs-keyword">if</span> (num &gt; maxNum || num &lt; <span class="hljs-number">0</span>) {
    write256(block, off, end, num)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>need an extended header if negative or too big.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>god, tar is so annoying
if the string is small enough, you should put a space
between the octal string and the \0, but if it doesn't
fit, then don't.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> numStr = <span class="hljs-built_in">Math</span>.floor(num).toString(<span class="hljs-number">8</span>)
  <span class="hljs-keyword">if</span> (num &lt; MAXNUM[writeLen - <span class="hljs-number">1</span>]) numStr += <span class="hljs-string">" "</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>pad with &quot;0&quot; chars</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (numStr.length &lt; writeLen) {
    numStr = (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(writeLen - numStr.length).join(<span class="hljs-string">"0"</span>)) + numStr
  }

  <span class="hljs-keyword">if</span> (numStr.length !== writeLen - <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"invalid length: "</span> + <span class="hljs-built_in">JSON</span>.stringify(numStr) + <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"expected: "</span>+writeLen)
  }
  block.write(numStr, off, writeLen, <span class="hljs-string">"utf8"</span>)
  block[end - <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write256</span> (<span class="hljs-params">block, off, end, num</span>) </span>{
  <span class="hljs-keyword">var</span> buf = block.slice(off, end)
  <span class="hljs-keyword">var</span> positive = num &gt;= <span class="hljs-number">0</span>
  buf[<span class="hljs-number">0</span>] = positive ? <span class="hljs-number">0x80</span> : <span class="hljs-number">0xFF</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>get the number as a base-256 tuple</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!positive) num *= <span class="hljs-number">-1</span>
  <span class="hljs-keyword">var</span> tuple = []
  <span class="hljs-keyword">do</span> {
    <span class="hljs-keyword">var</span> n = num % <span class="hljs-number">256</span>
    tuple.push(n)
    num = (num - n) / <span class="hljs-number">256</span>
  } <span class="hljs-keyword">while</span> (num)

  <span class="hljs-keyword">var</span> bytes = tuple.length

  <span class="hljs-keyword">var</span> fill = buf.length - bytes
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>; i &lt; fill; i ++) {
    buf[i] = positive ? <span class="hljs-number">0</span> : <span class="hljs-number">0xFF</span>
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>tuple is a base256 number, with [0] as the <em>least</em> significant byte
if it's negative, then we need to flip all the bits once we hit the
first non-zero bit.  The 2's-complement is (0x100 - n), and the 1's-
complement is (0xFF - n).</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> zero = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">for</span> (i = bytes; i &gt; <span class="hljs-number">0</span>; i --) {
    <span class="hljs-keyword">var</span> byte = tuple[bytes - i]
    <span class="hljs-keyword">if</span> (positive) buf[fill + i] = byte
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (zero &amp;&amp; byte === <span class="hljs-number">0</span>) buf[fill + i] = <span class="hljs-number">0</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (zero) {
      zero = <span class="hljs-literal">false</span>
      buf[fill + i] = <span class="hljs-number">0x100</span> - byte
    } <span class="hljs-keyword">else</span> buf[fill + i] = <span class="hljs-number">0xFF</span> - byte
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeText</span> (<span class="hljs-params">block, off, end, str</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>strings are written as utf8, then padded with \0</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> strLen = Buffer.byteLength(str)
    , writeLen = <span class="hljs-built_in">Math</span>.min(strLen, end - off)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>non-ascii fields need extended headers
long fields get truncated</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    , needExtended = strLen !== str.length || strLen &gt; writeLen

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>write the string, and null-pad</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (writeLen &gt; <span class="hljs-number">0</span>) block.write(str, off, writeLen, <span class="hljs-string">"utf8"</span>)
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = off + writeLen; i &lt; end; i ++) block[i] = <span class="hljs-number">0</span>

  <span class="hljs-keyword">return</span> needExtended
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">calcSum</span> (<span class="hljs-params">block</span>) </span>{
  block = block || <span class="hljs-keyword">this</span>.block
  assert(Buffer.isBuffer(block) &amp;&amp; block.length === <span class="hljs-number">512</span>)

  <span class="hljs-keyword">if</span> (!block) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Need block to checksum"</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>now figure out what it would be if the cksum was &quot;        &quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> sum = <span class="hljs-number">0</span>
    , start = fieldOffs[fields.cksum]
    , end = fieldEnds[fields.cksum]

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; fieldOffs[fields.cksum]; i ++) {
    sum += block[i]
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = start; i &lt; end; i ++) {
    sum += space
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = end; i &lt; <span class="hljs-number">512</span>; i ++) {
    sum += block[i]
  }

  <span class="hljs-keyword">return</span> sum
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkSum</span> (<span class="hljs-params">block</span>) </span>{
  <span class="hljs-keyword">var</span> sum = calcSum.call(<span class="hljs-keyword">this</span>, block)
  block = block || <span class="hljs-keyword">this</span>.block

  <span class="hljs-keyword">var</span> cksum = block.slice(fieldOffs[fields.cksum], fieldEnds[fields.cksum])
  cksum = parseNumeric(cksum)

  <span class="hljs-keyword">return</span> cksum === sum
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">decode</span> (<span class="hljs-params">block</span>) </span>{
  block = block || <span class="hljs-keyword">this</span>.block
  assert(Buffer.isBuffer(block) &amp;&amp; block.length === <span class="hljs-number">512</span>)

  <span class="hljs-keyword">this</span>.block = block
  <span class="hljs-keyword">this</span>.cksumValid = <span class="hljs-keyword">this</span>.checkSum()

  <span class="hljs-keyword">var</span> prefix = <span class="hljs-literal">null</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>slice off each field.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> f = <span class="hljs-number">0</span>; fields[f] !== <span class="hljs-literal">null</span>; f ++) {
    <span class="hljs-keyword">var</span> field = fields[f]
      , val = block.slice(fieldOffs[f], fieldEnds[f])

    <span class="hljs-keyword">switch</span> (field) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"ustar"</span>:
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>if not ustar, then everything after that is just padding.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (val.toString() !== <span class="hljs-string">"ustar\0"</span>) {
          <span class="hljs-keyword">this</span>.ustar = <span class="hljs-literal">false</span>
          <span class="hljs-keyword">return</span>
        } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>console.error(&quot;ustar:&quot;, val, val.toString())</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">this</span>.ustar = val.toString()
        }
        <span class="hljs-keyword">break</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>prefix is special, since it might signal the xstar header</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">case</span> <span class="hljs-string">"prefix"</span>:
        <span class="hljs-keyword">var</span> atime = parseNumeric(val.slice(<span class="hljs-number">131</span>, <span class="hljs-number">131</span> + <span class="hljs-number">12</span>))
          , ctime = parseNumeric(val.slice(<span class="hljs-number">131</span> + <span class="hljs-number">12</span>, <span class="hljs-number">131</span> + <span class="hljs-number">12</span> + <span class="hljs-number">12</span>))
        <span class="hljs-keyword">if</span> ((val[<span class="hljs-number">130</span>] === <span class="hljs-number">0</span> || val[<span class="hljs-number">130</span>] === space) &amp;&amp;
            <span class="hljs-keyword">typeof</span> atime === <span class="hljs-string">"number"</span> &amp;&amp;
            <span class="hljs-keyword">typeof</span> ctime === <span class="hljs-string">"number"</span> &amp;&amp;
            val[<span class="hljs-number">131</span> + <span class="hljs-number">12</span>] === space &amp;&amp;
            val[<span class="hljs-number">131</span> + <span class="hljs-number">12</span> + <span class="hljs-number">12</span>] === space) {
          <span class="hljs-keyword">this</span>.atime = atime
          <span class="hljs-keyword">this</span>.ctime = ctime
          val = val.slice(<span class="hljs-number">0</span>, <span class="hljs-number">130</span>)
        }
        prefix = val.toString(<span class="hljs-string">"utf8"</span>).replace(<span class="hljs-regexp">/\0+$/</span>, <span class="hljs-string">""</span>)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>console.error(&quot;%% header reading prefix&quot;, prefix)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">break</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>all other fields are null-padding text
or a number.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">if</span> (numeric[field]) {
          <span class="hljs-keyword">this</span>[field] = parseNumeric(val)
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">this</span>[field] = val.toString(<span class="hljs-string">"utf8"</span>).replace(<span class="hljs-regexp">/\0+$/</span>, <span class="hljs-string">""</span>)
        }
        <span class="hljs-keyword">break</span>
    }
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>if we got a prefix, then prepend it to the path.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (prefix) {
    <span class="hljs-keyword">this</span>.path = prefix + <span class="hljs-string">"/"</span> + <span class="hljs-keyword">this</span>.path
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>console.error(&quot;%% header got a prefix&quot;, this.path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse256</span> (<span class="hljs-params">buf</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>first byte MUST be either 80 or FF
80 for positive, FF for 2's comp</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> positive
  <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] === <span class="hljs-number">0x80</span>) positive = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] === <span class="hljs-number">0xFF</span>) positive = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<p>build up a base-256 tuple from the least sig to the highest</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> zero = <span class="hljs-literal">false</span>
    , tuple = []
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = buf.length - <span class="hljs-number">1</span>; i &gt; <span class="hljs-number">0</span>; i --) {
    <span class="hljs-keyword">var</span> byte = buf[i]
    <span class="hljs-keyword">if</span> (positive) tuple.push(byte)
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (zero &amp;&amp; byte === <span class="hljs-number">0</span>) tuple.push(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (zero) {
      zero = <span class="hljs-literal">false</span>
      tuple.push(<span class="hljs-number">0x100</span> - byte)
    } <span class="hljs-keyword">else</span> tuple.push(<span class="hljs-number">0xFF</span> - byte)
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> sum = <span class="hljs-number">0</span>, i = <span class="hljs-number">0</span>, l = tuple.length; i &lt; l; i ++) {
    sum += tuple[i] * <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">256</span>, i)
  }

  <span class="hljs-keyword">return</span> positive ? sum : <span class="hljs-number">-1</span> * sum
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseNumeric</span> (<span class="hljs-params">f</span>) </span>{
  <span class="hljs-keyword">if</span> (f[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0x80</span>) <span class="hljs-keyword">return</span> parse256(f)

  <span class="hljs-keyword">var</span> str = f.toString(<span class="hljs-string">"utf8"</span>).split(<span class="hljs-string">"\0"</span>)[<span class="hljs-number">0</span>].trim()
    , res = <span class="hljs-built_in">parseInt</span>(str, <span class="hljs-number">8</span>)

  <span class="hljs-keyword">return</span> <span class="hljs-built_in">isNaN</span>(res) ? <span class="hljs-literal">null</span> : res
}


</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

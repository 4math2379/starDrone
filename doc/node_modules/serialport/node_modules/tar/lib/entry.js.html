<!DOCTYPE html>
<html>
<head>
  <title>entry.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/tar/lib/entry.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>entry.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>A passthrough read/write stream that sets its properties
based on a header, extendedHeader, and globalHeader</p>
<p>Can be either a file system object of some sort, or
a pax/ustar metadata entry.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-built_in">module</span>.exports = Entry

<span class="hljs-keyword">var</span> TarHeader = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./header.js"</span>)
  , tar = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../tar"</span>)
  , assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">"assert"</span>).ok
  , Stream = <span class="hljs-built_in">require</span>(<span class="hljs-string">"stream"</span>).Stream
  , inherits = <span class="hljs-built_in">require</span>(<span class="hljs-string">"inherits"</span>)
  , fstream = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fstream"</span>).Abstract

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Entry</span> (<span class="hljs-params">header, extended, global</span>) </span>{
  Stream.call(<span class="hljs-keyword">this</span>)
  <span class="hljs-keyword">this</span>.readable = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">this</span>.writable = <span class="hljs-literal">true</span>

  <span class="hljs-keyword">this</span>._needDrain = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">this</span>._paused = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">this</span>._reading = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">this</span>._ending = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">this</span>._ended = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">this</span>._remaining = <span class="hljs-number">0</span>
  <span class="hljs-keyword">this</span>._abort = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">this</span>._queue = []
  <span class="hljs-keyword">this</span>._index = <span class="hljs-number">0</span>
  <span class="hljs-keyword">this</span>._queueLen = <span class="hljs-number">0</span>

  <span class="hljs-keyword">this</span>._read = <span class="hljs-keyword">this</span>._read.bind(<span class="hljs-keyword">this</span>)

  <span class="hljs-keyword">this</span>.props = {}
  <span class="hljs-keyword">this</span>._header = header
  <span class="hljs-keyword">this</span>._extended = extended || {}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>globals can change throughout the course of
a file parse operation.  Freeze it at its current state.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>._global = {}
  <span class="hljs-keyword">var</span> me = <span class="hljs-keyword">this</span>
  <span class="hljs-built_in">Object</span>.keys(global || {}).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">g</span>) </span>{
    me._global[g] = global[g]
  })

  <span class="hljs-keyword">this</span>._setProps()
}

inherits(Entry, Stream)

Entry.prototype.write = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._ending) <span class="hljs-keyword">this</span>.error(<span class="hljs-string">"write() after end()"</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>)
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._remaining === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">this</span>.error(<span class="hljs-string">"invalid bytes past eof"</span>)
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>often we'll get a bunch of \0 at the end of the last write,
since chunks will always be 512 bytes when reading a tarball.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (c.length &gt; <span class="hljs-keyword">this</span>._remaining) {
    c = c.slice(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>._remaining)
  }
  <span class="hljs-keyword">this</span>._remaining -= c.length

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>put it on the stack.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> ql = <span class="hljs-keyword">this</span>._queueLen
  <span class="hljs-keyword">this</span>._queue.push(c)
  <span class="hljs-keyword">this</span>._queueLen ++

  <span class="hljs-keyword">this</span>._read()

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>either paused, or buffered</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._paused || ql &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">this</span>._needDrain = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

Entry.prototype.end = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
  <span class="hljs-keyword">if</span> (c) <span class="hljs-keyword">this</span>.write(c)
  <span class="hljs-keyword">this</span>._ending = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">this</span>._read()
}

Entry.prototype.pause = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>._paused = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"pause"</span>)
}

Entry.prototype.resume = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>console.error(&quot;    Tar Entry resume&quot;, this.path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"resume"</span>)
  <span class="hljs-keyword">this</span>._paused = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">this</span>._read()
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._queueLen - <span class="hljs-keyword">this</span>._index &gt; <span class="hljs-number">1</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>This is bound to the instance</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">Entry.prototype._read = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>console.error(&quot;    Tar Entry _read&quot;, this.path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._paused || <span class="hljs-keyword">this</span>._reading || <span class="hljs-keyword">this</span>._ended) <span class="hljs-keyword">return</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>set this flag so that event handlers don't inadvertently
get multiple _read() calls running.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>._reading = <span class="hljs-literal">true</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>have any data to emit?</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">while</span> (<span class="hljs-keyword">this</span>._index &lt; <span class="hljs-keyword">this</span>._queueLen &amp;&amp; !<span class="hljs-keyword">this</span>._paused) {
    <span class="hljs-keyword">var</span> chunk = <span class="hljs-keyword">this</span>._queue[<span class="hljs-keyword">this</span>._index ++]
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"data"</span>, chunk)
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>check if we're drained</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._index &gt;= <span class="hljs-keyword">this</span>._queueLen) {
    <span class="hljs-keyword">this</span>._queue.length = <span class="hljs-keyword">this</span>._queueLen = <span class="hljs-keyword">this</span>._index = <span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._needDrain) {
      <span class="hljs-keyword">this</span>._needDrain = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"drain"</span>)
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._ending) {
      <span class="hljs-keyword">this</span>._ended = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"end"</span>)
    }
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>if the queue gets too big, then pluck off whatever we can.
this should be fairly rare.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> mql = <span class="hljs-keyword">this</span>._maxQueueLen
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._queueLen &gt; mql &amp;&amp; <span class="hljs-keyword">this</span>._index &gt; <span class="hljs-number">0</span>) {
    mql = <span class="hljs-built_in">Math</span>.min(<span class="hljs-keyword">this</span>._index, mql)
    <span class="hljs-keyword">this</span>._index -= mql
    <span class="hljs-keyword">this</span>._queueLen -= mql
    <span class="hljs-keyword">this</span>._queue = <span class="hljs-keyword">this</span>._queue.slice(mql)
  }

  <span class="hljs-keyword">this</span>._reading = <span class="hljs-literal">false</span>
}

Entry.prototype._setProps = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>props = extended-&gt;global-&gt;header-&gt;{}</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> header = <span class="hljs-keyword">this</span>._header
    , extended = <span class="hljs-keyword">this</span>._extended
    , global = <span class="hljs-keyword">this</span>._global
    , props = <span class="hljs-keyword">this</span>.props

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>first get the values from the normal header.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> fields = tar.fields
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> f = <span class="hljs-number">0</span>; fields[f] !== <span class="hljs-literal">null</span>; f ++) {
    <span class="hljs-keyword">var</span> field = fields[f]
      , val = header[field]
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> val !== <span class="hljs-string">"undefined"</span>) props[field] = val
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>next, the global header for this file.
numeric values, etc, will have already been parsed.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  ;[global, extended].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">p</span>) </span>{
    <span class="hljs-built_in">Object</span>.keys(p).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">f</span>) </span>{
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> p[f] !== <span class="hljs-string">"undefined"</span>) props[f] = p[f]
    })
  })

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>no nulls allowed in path or linkpath</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  ;[<span class="hljs-string">"path"</span>, <span class="hljs-string">"linkpath"</span>].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">p</span>) </span>{
    <span class="hljs-keyword">if</span> (props.hasOwnProperty(p)) {
      props[p] = props[p].split(<span class="hljs-string">"\0"</span>)[<span class="hljs-number">0</span>]
    }
  })


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>set date fields to be a proper date</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  ;[<span class="hljs-string">"mtime"</span>, <span class="hljs-string">"ctime"</span>, <span class="hljs-string">"atime"</span>].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">p</span>) </span>{
    <span class="hljs-keyword">if</span> (props.hasOwnProperty(p)) {
      props[p] = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(props[p] * <span class="hljs-number">1000</span>)
    }
  })

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>set the type so that we know what kind of file to create</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> type
  <span class="hljs-keyword">switch</span> (tar.types[props.type]) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"OldFile"</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">"ContiguousFile"</span>:
      type = <span class="hljs-string">"File"</span>
      <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">case</span> <span class="hljs-string">"GNUDumpDir"</span>:
      type = <span class="hljs-string">"Directory"</span>
      <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">case</span> <span class="hljs-literal">undefined</span>:
      type = <span class="hljs-string">"Unknown"</span>
      <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">case</span> <span class="hljs-string">"Link"</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">"SymbolicLink"</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">"CharacterDevice"</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">"BlockDevice"</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">"Directory"</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">"FIFO"</span>:
    <span class="hljs-keyword">default</span>:
      type = tar.types[props.type]
  }

  <span class="hljs-keyword">this</span>.type = type
  <span class="hljs-keyword">this</span>.path = props.path
  <span class="hljs-keyword">this</span>.size = props.size

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>size is special, since it signals when the file needs to end.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>._remaining = props.size
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>the parser may not call write if _abort is true.
useful for skipping data from some files quickly.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">Entry.prototype.abort = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">this</span>._abort = <span class="hljs-literal">true</span>
}

Entry.prototype.warn = fstream.warn
Entry.prototype.error = fstream.error

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

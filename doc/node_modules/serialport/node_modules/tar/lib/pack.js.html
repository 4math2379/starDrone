<!DOCTYPE html>
<html>
<head>
  <title>pack.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/tar/lib/pack.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>pack.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>pipe in an fstream, and it'll make a tarball.
key-value pair argument is global extended header props.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-built_in">module</span>.exports = Pack

<span class="hljs-keyword">var</span> EntryWriter = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./entry-writer.js"</span>)
  , Stream = <span class="hljs-built_in">require</span>(<span class="hljs-string">"stream"</span>).Stream
  , path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>)
  , inherits = <span class="hljs-built_in">require</span>(<span class="hljs-string">"inherits"</span>)
  , GlobalHeaderWriter = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./global-header-writer.js"</span>)
  , collect = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fstream"</span>).collect
  , eof = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">512</span>)

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">512</span>; i ++) eof[i] = <span class="hljs-number">0</span>

inherits(Pack, Stream)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Pack</span> (<span class="hljs-params">props</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>console.error(&quot;-- p ctor&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> me = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">if</span> (!(me <span class="hljs-keyword">instanceof</span> Pack)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Pack(props)

  <span class="hljs-keyword">if</span> (props) me._noProprietary = props.noProprietary
  <span class="hljs-keyword">else</span> me._noProprietary = <span class="hljs-literal">false</span>

  me._global = props

  me.readable = <span class="hljs-literal">true</span>
  me.writable = <span class="hljs-literal">true</span>
  me._buffer = []
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>console.error(&quot;-- -- set current to null in ctor&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  me._currentEntry = <span class="hljs-literal">null</span>
  me._processing = <span class="hljs-literal">false</span>

  me._pipeRoot = <span class="hljs-literal">null</span>
  me.on(<span class="hljs-string">"pipe"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">src</span>) </span>{
    <span class="hljs-keyword">if</span> (src.root === me._pipeRoot) <span class="hljs-keyword">return</span>
    me._pipeRoot = src
    src.on(<span class="hljs-string">"end"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      me._pipeRoot = <span class="hljs-literal">null</span>
    })
    me.add(src)
  })
}

Pack.prototype.addGlobal = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">props</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>console.error(&quot;-- p addGlobal&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._didGlobal) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">this</span>._didGlobal = <span class="hljs-literal">true</span>

  <span class="hljs-keyword">var</span> me = <span class="hljs-keyword">this</span>
  GlobalHeaderWriter(props)
    .on(<span class="hljs-string">"data"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
      me.emit(<span class="hljs-string">"data"</span>, c)
    })
    .end()
}

Pack.prototype.add = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">stream</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._global &amp;&amp; !<span class="hljs-keyword">this</span>._didGlobal) <span class="hljs-keyword">this</span>.addGlobal(<span class="hljs-keyword">this</span>._global)

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._ended) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"error"</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"add after end"</span>))

  collect(stream)
  <span class="hljs-keyword">this</span>._buffer.push(stream)
  <span class="hljs-keyword">this</span>._process()
  <span class="hljs-keyword">this</span>._needDrain = <span class="hljs-keyword">this</span>._buffer.length &gt; <span class="hljs-number">0</span>
  <span class="hljs-keyword">return</span> !<span class="hljs-keyword">this</span>._needDrain
}

Pack.prototype.pause = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>._paused = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._currentEntry) <span class="hljs-keyword">this</span>._currentEntry.pause()
  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"pause"</span>)
}

Pack.prototype.resume = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>._paused = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._currentEntry) <span class="hljs-keyword">this</span>._currentEntry.resume()
  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"resume"</span>)
  <span class="hljs-keyword">this</span>._process()
}

Pack.prototype.end = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>._ended = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">this</span>._buffer.push(eof)
  <span class="hljs-keyword">this</span>._process()
}

Pack.prototype._process = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> me = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">if</span> (me._paused || me._processing) {
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">var</span> entry = me._buffer.shift()

  <span class="hljs-keyword">if</span> (!entry) {
    <span class="hljs-keyword">if</span> (me._needDrain) {
      me.emit(<span class="hljs-string">"drain"</span>)
    }
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">if</span> (entry.ready === <span class="hljs-literal">false</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>console.error(&quot;-- entry is not ready&quot;, entry)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    me._buffer.unshift(entry)
    entry.on(<span class="hljs-string">"ready"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>console.error(&quot;-- -- ready!&quot;, entry)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      me._process()
    })
    <span class="hljs-keyword">return</span>
  }

  me._processing = <span class="hljs-literal">true</span>

  <span class="hljs-keyword">if</span> (entry === eof) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>need 2 ending null blocks.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    me.emit(<span class="hljs-string">"data"</span>, eof)
    me.emit(<span class="hljs-string">"data"</span>, eof)
    me.emit(<span class="hljs-string">"end"</span>)
    me.emit(<span class="hljs-string">"close"</span>)
    <span class="hljs-keyword">return</span>
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Change the path to be relative to the root dir that was
added to the tarball.</p>
<p>XXX This should be more like how -C works, so you can
explicitly set a root dir, and also explicitly set a pathname
in the tarball to use.  That way we can skip a lot of extra
work when resolving symlinks for bundled dependencies in npm.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
  <span class="hljs-keyword">var</span> root = path.dirname((entry.root || entry).path);
  <span class="hljs-keyword">if</span> (me._global &amp;&amp; me._global.fromBase &amp;&amp; entry.root &amp;&amp; entry.root.path) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>user set 'fromBase: true' indicating tar root should be directory itself</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    root = entry.root.path;
  }

  <span class="hljs-keyword">var</span> wprops = {}

  <span class="hljs-built_in">Object</span>.keys(entry.props || {}).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">k</span>) </span>{
    wprops[k] = entry.props[k]
  })

  <span class="hljs-keyword">if</span> (me._noProprietary) wprops.noProprietary = <span class="hljs-literal">true</span>

  wprops.path = path.relative(root, entry.path || <span class="hljs-string">''</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>actually not a matter of opinion or taste.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (process.platform === <span class="hljs-string">"win32"</span>) {
    wprops.path = wprops.path.replace(<span class="hljs-regexp">/\\/g</span>, <span class="hljs-string">"/"</span>)
  }

  <span class="hljs-keyword">if</span> (!wprops.type)
    wprops.type = <span class="hljs-string">'Directory'</span>

  <span class="hljs-keyword">switch</span> (wprops.type) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>sockets not supported</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">case</span> <span class="hljs-string">"Socket"</span>:
      <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">case</span> <span class="hljs-string">"Directory"</span>:
      wprops.path += <span class="hljs-string">"/"</span>
      wprops.size = <span class="hljs-number">0</span>
      <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">case</span> <span class="hljs-string">"Link"</span>:
      <span class="hljs-keyword">var</span> lp = path.resolve(path.dirname(entry.path), entry.linkpath)
      wprops.linkpath = path.relative(root, lp) || <span class="hljs-string">"."</span>
      wprops.size = <span class="hljs-number">0</span>
      <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">case</span> <span class="hljs-string">"SymbolicLink"</span>:
      <span class="hljs-keyword">var</span> lp = path.resolve(path.dirname(entry.path), entry.linkpath)
      wprops.linkpath = path.relative(path.dirname(entry.path), lp) || <span class="hljs-string">"."</span>
      wprops.size = <span class="hljs-number">0</span>
      <span class="hljs-keyword">break</span>
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>console.error(&quot;-- new writer&quot;, wprops)
if (!wprops.type) {
// console.error(&quot;-- no type?&quot;, entry.constructor.name, entry)
}</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>console.error(&quot;-- -- set current to new writer&quot;, wprops.path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> writer = me._currentEntry = EntryWriter(wprops)

  writer.parent = me

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>writer.on(&quot;end&quot;, function () {
// console.error(&quot;-- -- writer end&quot;, writer.path)
})</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
  writer.on(<span class="hljs-string">"data"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
    me.emit(<span class="hljs-string">"data"</span>, c)
  })

  writer.on(<span class="hljs-string">"header"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    Buffer.prototype.toJSON = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toString().split(<span class="hljs-regexp">/\0/</span>).join(<span class="hljs-string">"."</span>)
    }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>console.error(&quot;-- -- writer header %j&quot;, writer.props)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (writer.props.size === <span class="hljs-number">0</span>) nextEntry()
  })
  writer.on(<span class="hljs-string">"close"</span>, nextEntry)

  <span class="hljs-keyword">var</span> ended = <span class="hljs-literal">false</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nextEntry</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (ended) <span class="hljs-keyword">return</span>
    ended = <span class="hljs-literal">true</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>console.error(&quot;-- -- writer close&quot;, writer.path)
console.error(&quot;-- -- set current to null&quot;, wprops.path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    me._currentEntry = <span class="hljs-literal">null</span>
    me._processing = <span class="hljs-literal">false</span>
    me._process()
  }

  writer.on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>console.error(&quot;-- -- writer error&quot;, writer.path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    me.emit(<span class="hljs-string">"error"</span>, er)
  })

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>if it's the root, then there's no need to add its entries,
or data, since they'll be added directly.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (entry === me._pipeRoot) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>console.error(&quot;-- is the root, don't auto-add&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    writer.add = <span class="hljs-literal">null</span>
  }

  entry.pipe(writer)
}

Pack.prototype.destroy = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{}
Pack.prototype.write = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

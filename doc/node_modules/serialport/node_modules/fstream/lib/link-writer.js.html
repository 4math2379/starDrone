<!DOCTYPE html>
<html>
<head>
  <title>link-writer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/fstream/lib/link-writer.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>link-writer.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-built_in">module</span>.exports = LinkWriter

<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'graceful-fs'</span>)
<span class="hljs-keyword">var</span> Writer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./writer.js'</span>)
<span class="hljs-keyword">var</span> inherits = <span class="hljs-built_in">require</span>(<span class="hljs-string">'inherits'</span>)
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">var</span> rimraf = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rimraf'</span>)

inherits(LinkWriter, Writer)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">LinkWriter</span> (<span class="hljs-params">props</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">if</span> (!(self <span class="hljs-keyword">instanceof</span> LinkWriter)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'LinkWriter must be called as constructor.'</span>)
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>should already be established as a Link type</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!((props.type === <span class="hljs-string">'Link'</span> &amp;&amp; props.Link) ||
    (props.type === <span class="hljs-string">'SymbolicLink'</span> &amp;&amp; props.SymbolicLink))) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Non-link type '</span> + props.type)
  }

  <span class="hljs-keyword">if</span> (props.linkpath === <span class="hljs-string">''</span>) props.linkpath = <span class="hljs-string">'.'</span>
  <span class="hljs-keyword">if</span> (!props.linkpath) {
    self.error(<span class="hljs-string">'Need linkpath property to create '</span> + props.type)
  }

  Writer.call(<span class="hljs-keyword">this</span>, props)
}

LinkWriter.prototype._create = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>console.error(&quot; LW _create&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">var</span> hard = self.type === <span class="hljs-string">'Link'</span> || process.platform === <span class="hljs-string">'win32'</span>
  <span class="hljs-keyword">var</span> link = hard ? <span class="hljs-string">'link'</span> : <span class="hljs-string">'symlink'</span>
  <span class="hljs-keyword">var</span> lp = hard ? path.resolve(self.dirname, self.linkpath) : self.linkpath

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>can only change the link path by clobbering
For hard links, let's just assume that's always the case, since
there's no good way to read them if we don't already know.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (hard) <span class="hljs-keyword">return</span> clobber(self, lp, link)

  fs.readlink(self._path, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er, p</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>only skip creation if it's exactly the same link</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (p &amp;&amp; p === lp) <span class="hljs-keyword">return</span> finish(self)
    clobber(self, lp, link)
  })
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clobber</span> (<span class="hljs-params">self, lp, link</span>) </span>{
  rimraf(self._path, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
    <span class="hljs-keyword">if</span> (er) <span class="hljs-keyword">return</span> self.error(er)
    create(self, lp, link)
  })
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span> (<span class="hljs-params">self, lp, link</span>) </span>{
  fs[link](lp, self._path, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>if this is a hard link, and we're in the process of writing out a
directory, it's very possible that the thing we're linking to
doesn't exist yet (especially if it was intended as a symlink),
so swallow ENOENT errors here and just soldier in.
Additionally, an EPERM or EACCES can happen on win32 if it's trying
to make a link to a directory.  Again, just skip it.
A better solution would be to have fs.symlink be supported on
windows in some nice fashion.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (er) {
      <span class="hljs-keyword">if</span> ((er.code === <span class="hljs-string">'ENOENT'</span> ||
        er.code === <span class="hljs-string">'EACCES'</span> ||
        er.code === <span class="hljs-string">'EPERM'</span>) &amp;&amp; process.platform === <span class="hljs-string">'win32'</span>) {
        self.ready = <span class="hljs-literal">true</span>
        self.emit(<span class="hljs-string">'ready'</span>)
        self.emit(<span class="hljs-string">'end'</span>)
        self.emit(<span class="hljs-string">'close'</span>)
        self.end = self._finish = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{}
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> self.error(er)
    }
    finish(self)
  })
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">finish</span> (<span class="hljs-params">self</span>) </span>{
  self.ready = <span class="hljs-literal">true</span>
  self.emit(<span class="hljs-string">'ready'</span>)
  <span class="hljs-keyword">if</span> (self._ended &amp;&amp; !self._finished) self._finish()
}

LinkWriter.prototype.end = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>console.error(&quot;LW finish in end&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>._ended = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.ready) {
    <span class="hljs-keyword">this</span>._finished = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">this</span>._finish()
  }
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

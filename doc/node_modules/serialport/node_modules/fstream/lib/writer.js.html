<!DOCTYPE html>
<html>
<head>
  <title>writer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/fstream/lib/writer.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>writer.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-built_in">module</span>.exports = Writer

<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'graceful-fs'</span>)
<span class="hljs-keyword">var</span> inherits = <span class="hljs-built_in">require</span>(<span class="hljs-string">'inherits'</span>)
<span class="hljs-keyword">var</span> rimraf = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rimraf'</span>)
<span class="hljs-keyword">var</span> mkdir = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mkdirp'</span>)
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">var</span> umask = process.platform === <span class="hljs-string">'win32'</span> ? <span class="hljs-number">0</span> : process.umask()
<span class="hljs-keyword">var</span> getType = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./get-type.js'</span>)
<span class="hljs-keyword">var</span> Abstract = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./abstract.js'</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Must do this <em>before</em> loading the child classes</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">inherits(Writer, Abstract)

Writer.dirmode = <span class="hljs-built_in">parseInt</span>(<span class="hljs-string">'0777'</span>, <span class="hljs-number">8</span>) &amp; (~umask)
Writer.filemode = <span class="hljs-built_in">parseInt</span>(<span class="hljs-string">'0666'</span>, <span class="hljs-number">8</span>) &amp; (~umask)

<span class="hljs-keyword">var</span> DirWriter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./dir-writer.js'</span>)
<span class="hljs-keyword">var</span> LinkWriter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./link-writer.js'</span>)
<span class="hljs-keyword">var</span> FileWriter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./file-writer.js'</span>)
<span class="hljs-keyword">var</span> ProxyWriter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./proxy-writer.js'</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>props is the desired state.  current is optionally the current stat,
provided here so that subclasses can avoid statting the target
more than necessary.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Writer</span> (<span class="hljs-params">props, current</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> props === <span class="hljs-string">'string'</span>) {
    props = { <span class="hljs-attr">path</span>: props }
  }

  <span class="hljs-keyword">if</span> (!props.path) self.error(<span class="hljs-string">'Must provide a path'</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>polymorphism.
call fstream.Writer(dir) to get a DirWriter object, etc.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> type = getType(props)
  <span class="hljs-keyword">var</span> ClassType = Writer

  <span class="hljs-keyword">switch</span> (type) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'Directory'</span>:
      ClassType = DirWriter
      <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'File'</span>:
      ClassType = FileWriter
      <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'Link'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'SymbolicLink'</span>:
      ClassType = LinkWriter
      <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-literal">null</span>:
    <span class="hljs-keyword">default</span>:
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Don't know yet what type to create, so we wrap in a proxy.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      ClassType = ProxyWriter
      <span class="hljs-keyword">break</span>
  }

  <span class="hljs-keyword">if</span> (!(self <span class="hljs-keyword">instanceof</span> ClassType)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ClassType(props)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>now get down to business.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
  Abstract.call(self)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>props is what we want to set.
set some convenience properties as well.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  self.type = props.type
  self.props = props
  self.depth = props.depth || <span class="hljs-number">0</span>
  self.clobber = props.clobber === <span class="hljs-literal">false</span> ? props.clobber : <span class="hljs-literal">true</span>
  self.parent = props.parent || <span class="hljs-literal">null</span>
  self.root = props.root || (props.parent &amp;&amp; props.parent.root) || self

  self._path = self.path = path.resolve(props.path)
  <span class="hljs-keyword">if</span> (process.platform === <span class="hljs-string">'win32'</span>) {
    self.path = self._path = self.path.replace(<span class="hljs-regexp">/\?/g</span>, <span class="hljs-string">'_'</span>)
    <span class="hljs-keyword">if</span> (self._path.length &gt;= <span class="hljs-number">260</span>) {
      self._swallowErrors = <span class="hljs-literal">true</span>
      self._path = <span class="hljs-string">'\\\\?\\'</span> + self.path.replace(<span class="hljs-regexp">/\//g</span>, <span class="hljs-string">'\\'</span>)
    }
  }
  self.basename = path.basename(props.path)
  self.dirname = path.dirname(props.path)
  self.linkpath = props.linkpath || <span class="hljs-literal">null</span>

  props.parent = props.root = <span class="hljs-literal">null</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>console.error(&quot;\n\n\n%s setting size to&quot;, props.path, props.size)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  self.size = props.size

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> props.mode === <span class="hljs-string">'string'</span>) {
    props.mode = <span class="hljs-built_in">parseInt</span>(props.mode, <span class="hljs-number">8</span>)
  }

  self.readable = <span class="hljs-literal">false</span>
  self.writable = <span class="hljs-literal">true</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>buffer until ready, or while handling another entry</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  self._buffer = []
  self.ready = <span class="hljs-literal">false</span>

  self.filter = <span class="hljs-keyword">typeof</span> props.filter === <span class="hljs-string">'function'</span> ? props.filter : <span class="hljs-literal">null</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>start the ball rolling.
this checks what's there already, and then calls
self._create() to call the impl-specific creation stuff.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  self._stat(current)
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>Calling this means that it's something we can't create.
Just assert that it's already there, otherwise raise a warning.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">Writer.prototype._create = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  fs[self.props.follow ? <span class="hljs-string">'stat'</span> : <span class="hljs-string">'lstat'</span>](self._path, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
    <span class="hljs-keyword">if</span> (er) {
      <span class="hljs-keyword">return</span> self.warn(<span class="hljs-string">'Cannot create '</span> + self._path + <span class="hljs-string">'\n'</span> +
        <span class="hljs-string">'Unsupported type: '</span> + self.type, <span class="hljs-string">'ENOTSUP'</span>)
    }
    self._finish()
  })
}

Writer.prototype._stat = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">current</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">var</span> props = self.props
  <span class="hljs-keyword">var</span> stat = props.follow ? <span class="hljs-string">'stat'</span> : <span class="hljs-string">'lstat'</span>
  <span class="hljs-keyword">var</span> who = self._proxy || self

  <span class="hljs-keyword">if</span> (current) statCb(<span class="hljs-literal">null</span>, current)
  <span class="hljs-keyword">else</span> fs[stat](self._path, statCb)

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">statCb</span> (<span class="hljs-params">er, current</span>) </span>{
    <span class="hljs-keyword">if</span> (self.filter &amp;&amp; !self.filter.call(who, who, current)) {
      self._aborted = <span class="hljs-literal">true</span>
      self.emit(<span class="hljs-string">'end'</span>)
      self.emit(<span class="hljs-string">'close'</span>)
      <span class="hljs-keyword">return</span>
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>if it's not there, great.  We'll just create it.
if it is there, then we'll need to change whatever differs</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (er || !current) {
      <span class="hljs-keyword">return</span> create(self)
    }

    self._old = current
    <span class="hljs-keyword">var</span> currentType = getType(current)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>if it's a type change, then we need to clobber or error.
if it's not a type change, then let the impl take care of it.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (currentType !== self.type) {
      <span class="hljs-keyword">return</span> rimraf(self._path, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
        <span class="hljs-keyword">if</span> (er) <span class="hljs-keyword">return</span> self.error(er)
        self._old = <span class="hljs-literal">null</span>
        create(self)
      })
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>otherwise, just handle in the app-specific way
this creates a fs.WriteStream, or mkdir's, or whatever</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    create(self)
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span> (<span class="hljs-params">self</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>console.error(&quot;W create&quot;, self._path, Writer.dirmode)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>XXX Need to clobber non-dirs that are in the way,
unless { clobber: false } in the props.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  mkdir(path.dirname(self._path), Writer.dirmode, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er, made</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>console.error(&quot;W created&quot;, path.dirname(self._path), er)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (er) <span class="hljs-keyword">return</span> self.error(er)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>later on, we have to set the mode and owner for these</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    self._madeDir = made
    <span class="hljs-keyword">return</span> self._create()
  })
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">endChmod</span> (<span class="hljs-params">self, want, current, path, cb</span>) </span>{
  <span class="hljs-keyword">var</span> wantMode = want.mode
  <span class="hljs-keyword">var</span> chmod = want.follow || self.type !== <span class="hljs-string">'SymbolicLink'</span>
    ? <span class="hljs-string">'chmod'</span> : <span class="hljs-string">'lchmod'</span>

  <span class="hljs-keyword">if</span> (!fs[chmod]) <span class="hljs-keyword">return</span> cb()
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> wantMode !== <span class="hljs-string">'number'</span>) <span class="hljs-keyword">return</span> cb()

  <span class="hljs-keyword">var</span> curMode = current.mode &amp; <span class="hljs-built_in">parseInt</span>(<span class="hljs-string">'0777'</span>, <span class="hljs-number">8</span>)
  wantMode = wantMode &amp; <span class="hljs-built_in">parseInt</span>(<span class="hljs-string">'0777'</span>, <span class="hljs-number">8</span>)
  <span class="hljs-keyword">if</span> (wantMode === curMode) <span class="hljs-keyword">return</span> cb()

  fs[chmod](path, wantMode, cb)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">endChown</span> (<span class="hljs-params">self, want, current, path, cb</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>Don't even try it unless root.  Too easy to EPERM.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (process.platform === <span class="hljs-string">'win32'</span>) <span class="hljs-keyword">return</span> cb()
  <span class="hljs-keyword">if</span> (!process.getuid || process.getuid() !== <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> cb()
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> want.uid !== <span class="hljs-string">'number'</span> &amp;&amp;
    <span class="hljs-keyword">typeof</span> want.gid !== <span class="hljs-string">'number'</span>) <span class="hljs-keyword">return</span> cb()

  <span class="hljs-keyword">if</span> (current.uid === want.uid &amp;&amp;
    current.gid === want.gid) <span class="hljs-keyword">return</span> cb()

  <span class="hljs-keyword">var</span> chown = (self.props.follow || self.type !== <span class="hljs-string">'SymbolicLink'</span>)
    ? <span class="hljs-string">'chown'</span> : <span class="hljs-string">'lchown'</span>
  <span class="hljs-keyword">if</span> (!fs[chown]) <span class="hljs-keyword">return</span> cb()

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> want.uid !== <span class="hljs-string">'number'</span>) want.uid = current.uid
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> want.gid !== <span class="hljs-string">'number'</span>) want.gid = current.gid

  fs[chown](path, want.uid, want.gid, cb)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">endUtimes</span> (<span class="hljs-params">self, want, current, path, cb</span>) </span>{
  <span class="hljs-keyword">if</span> (!fs.utimes || process.platform === <span class="hljs-string">'win32'</span>) <span class="hljs-keyword">return</span> cb()

  <span class="hljs-keyword">var</span> utimes = (want.follow || self.type !== <span class="hljs-string">'SymbolicLink'</span>)
    ? <span class="hljs-string">'utimes'</span> : <span class="hljs-string">'lutimes'</span>

  <span class="hljs-keyword">if</span> (utimes === <span class="hljs-string">'lutimes'</span> &amp;&amp; !fs[utimes]) {
    utimes = <span class="hljs-string">'utimes'</span>
  }

  <span class="hljs-keyword">if</span> (!fs[utimes]) <span class="hljs-keyword">return</span> cb()

  <span class="hljs-keyword">var</span> curA = current.atime
  <span class="hljs-keyword">var</span> curM = current.mtime
  <span class="hljs-keyword">var</span> meA = want.atime
  <span class="hljs-keyword">var</span> meM = want.mtime

  <span class="hljs-keyword">if</span> (meA === <span class="hljs-literal">undefined</span>) meA = curA
  <span class="hljs-keyword">if</span> (meM === <span class="hljs-literal">undefined</span>) meM = curM

  <span class="hljs-keyword">if</span> (!isDate(meA)) meA = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(meA)
  <span class="hljs-keyword">if</span> (!isDate(meM)) meA = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(meM)

  <span class="hljs-keyword">if</span> (meA.getTime() === curA.getTime() &amp;&amp;
    meM.getTime() === curM.getTime()) <span class="hljs-keyword">return</span> cb()

  fs[utimes](path, meA, meM, cb)
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>XXX This function is beastly.  Break it up!</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">Writer.prototype._finish = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

  <span class="hljs-keyword">if</span> (self._finishing) <span class="hljs-keyword">return</span>
  self._finishing = <span class="hljs-literal">true</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>console.error(&quot; W Finish&quot;, self._path, self.size)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>set up all the things.
At this point, we're already done writing whatever we've gotta write,
adding files to the dir, etc.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> todo = <span class="hljs-number">0</span>
  <span class="hljs-keyword">var</span> errState = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">var</span> done = <span class="hljs-literal">false</span>

  <span class="hljs-keyword">if</span> (self._old) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>the times will almost <em>certainly</em> have changed.
adds the utimes syscall, but remove another stat.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    self._old.atime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">0</span>)
    self._old.mtime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">0</span>)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>console.error(&quot; W Finish Stale Stat&quot;, self._path, self.size)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    setProps(self._old)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">var</span> stat = self.props.follow ? <span class="hljs-string">'stat'</span> : <span class="hljs-string">'lstat'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>console.error(&quot; W Finish Stating&quot;, self._path, self.size)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    fs[stat](self._path, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er, current</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>console.error(&quot; W Finish Stated&quot;, self._path, self.size, current)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (er) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>if we're in the process of writing out a
directory, it's very possible that the thing we're linking to
doesn't exist yet (especially if it was intended as a symlink),
so swallow ENOENT errors here and just soldier on.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (er.code === <span class="hljs-string">'ENOENT'</span> &amp;&amp;
          (self.type === <span class="hljs-string">'Link'</span> || self.type === <span class="hljs-string">'SymbolicLink'</span>) &amp;&amp;
          process.platform === <span class="hljs-string">'win32'</span>) {
          self.ready = <span class="hljs-literal">true</span>
          self.emit(<span class="hljs-string">'ready'</span>)
          self.emit(<span class="hljs-string">'end'</span>)
          self.emit(<span class="hljs-string">'close'</span>)
          self.end = self._finish = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{}
          <span class="hljs-keyword">return</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> self.error(er)
      }
      setProps(self._old = current)
    })
  }

  <span class="hljs-keyword">return</span>

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setProps</span> (<span class="hljs-params">current</span>) </span>{
    todo += <span class="hljs-number">3</span>
    endChmod(self, self.props, current, self._path, next(<span class="hljs-string">'chmod'</span>))
    endChown(self, self.props, current, self._path, next(<span class="hljs-string">'chown'</span>))
    endUtimes(self, self.props, current, self._path, next(<span class="hljs-string">'utimes'</span>))
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span> (<span class="hljs-params">what</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>console.error(&quot;   W Finish&quot;, what, todo)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (errState) <span class="hljs-keyword">return</span>
      <span class="hljs-keyword">if</span> (er) {
        er.fstream_finish_call = what
        <span class="hljs-keyword">return</span> self.error(errState = er)
      }
      <span class="hljs-keyword">if</span> (--todo &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>
      <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">return</span>
      done = <span class="hljs-literal">true</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>we may still need to set the mode/etc. on some parent dirs
that were created previously.  delay end/close until then.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (!self._madeDir) <span class="hljs-keyword">return</span> end()
      <span class="hljs-keyword">else</span> endMadeDir(self, self._path, end)

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">end</span> (<span class="hljs-params">er</span>) </span>{
        <span class="hljs-keyword">if</span> (er) {
          er.fstream_finish_call = <span class="hljs-string">'setupMadeDir'</span>
          <span class="hljs-keyword">return</span> self.error(er)
        }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>all the props have been set, so we're completely done.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        self.emit(<span class="hljs-string">'end'</span>)
        self.emit(<span class="hljs-string">'close'</span>)
      }
    }
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">endMadeDir</span> (<span class="hljs-params">self, p, cb</span>) </span>{
  <span class="hljs-keyword">var</span> made = self._madeDir
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>everything <em>between</em> made and path.dirname(self._path)
needs to be set up.  Note that this may just be one dir.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> d = path.dirname(p)

  endMadeDir_(self, d, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
    <span class="hljs-keyword">if</span> (er) <span class="hljs-keyword">return</span> cb(er)
    <span class="hljs-keyword">if</span> (d === made) {
      <span class="hljs-keyword">return</span> cb()
    }
    endMadeDir(self, d, cb)
  })
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">endMadeDir_</span> (<span class="hljs-params">self, p, cb</span>) </span>{
  <span class="hljs-keyword">var</span> dirProps = {}
  <span class="hljs-built_in">Object</span>.keys(self.props).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">k</span>) </span>{
    dirProps[k] = self.props[k]

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>only make non-readable dirs if explicitly requested.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (k === <span class="hljs-string">'mode'</span> &amp;&amp; self.type !== <span class="hljs-string">'Directory'</span>) {
      dirProps[k] = dirProps[k] | <span class="hljs-built_in">parseInt</span>(<span class="hljs-string">'0111'</span>, <span class="hljs-number">8</span>)
    }
  })

  <span class="hljs-keyword">var</span> todo = <span class="hljs-number">3</span>
  <span class="hljs-keyword">var</span> errState = <span class="hljs-literal">null</span>
  fs.stat(p, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er, current</span>) </span>{
    <span class="hljs-keyword">if</span> (er) <span class="hljs-keyword">return</span> cb(errState = er)
    endChmod(self, dirProps, current, p, next)
    endChown(self, dirProps, current, p, next)
    endUtimes(self, dirProps, current, p, next)
  })

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span> (<span class="hljs-params">er</span>) </span>{
    <span class="hljs-keyword">if</span> (errState) <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">if</span> (er) <span class="hljs-keyword">return</span> cb(errState = er)
    <span class="hljs-keyword">if</span> (--todo === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> cb()
  }
}

Writer.prototype.pipe = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>.error(<span class="hljs-string">"Can't pipe from writable stream"</span>)
}

Writer.prototype.add = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>.error(<span class="hljs-string">"Can't add to non-Directory type"</span>)
}

Writer.prototype.write = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">objectToString</span> (<span class="hljs-params">d</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.prototype.toString.call(d)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isDate</span> (<span class="hljs-params">d</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> d === <span class="hljs-string">'object'</span> &amp;&amp; objectToString(d) === <span class="hljs-string">'[object Date]'</span>
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

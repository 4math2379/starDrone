<!DOCTYPE html>
<html>
<head>
  <title>proxy-writer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/fstream/lib/proxy-writer.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>proxy-writer.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>A writer for when we don't know what kind of thing
the thing is.  That is, it's not explicitly set,
so we're going to make it whatever the thing already
is, or &quot;File&quot;</p>
<p>Until then, collect all events.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-built_in">module</span>.exports = ProxyWriter

<span class="hljs-keyword">var</span> Writer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./writer.js'</span>)
<span class="hljs-keyword">var</span> getType = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./get-type.js'</span>)
<span class="hljs-keyword">var</span> inherits = <span class="hljs-built_in">require</span>(<span class="hljs-string">'inherits'</span>)
<span class="hljs-keyword">var</span> collect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./collect.js'</span>)
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)

inherits(ProxyWriter, Writer)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ProxyWriter</span> (<span class="hljs-params">props</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">if</span> (!(self <span class="hljs-keyword">instanceof</span> ProxyWriter)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'ProxyWriter must be called as constructor.'</span>)
  }

  self.props = props
  self._needDrain = <span class="hljs-literal">false</span>

  Writer.call(self, props)
}

ProxyWriter.prototype._stat = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">var</span> props = self.props
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>stat the thing to see what the proxy should be.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> stat = props.follow ? <span class="hljs-string">'stat'</span> : <span class="hljs-string">'lstat'</span>

  fs[stat](props.path, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er, current</span>) </span>{
    <span class="hljs-keyword">var</span> type
    <span class="hljs-keyword">if</span> (er || !current) {
      type = <span class="hljs-string">'File'</span>
    } <span class="hljs-keyword">else</span> {
      type = getType(current)
    }

    props[type] = <span class="hljs-literal">true</span>
    props.type = self.type = type

    self._old = current
    self._addProxy(Writer(props, current))
  })
}

ProxyWriter.prototype._addProxy = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">proxy</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>console.error(&quot;~~ set proxy&quot;, this.path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">if</span> (self._proxy) {
    <span class="hljs-keyword">return</span> self.error(<span class="hljs-string">'proxy already set'</span>)
  }

  self._proxy = proxy
  ;[
    <span class="hljs-string">'ready'</span>,
    <span class="hljs-string">'error'</span>,
    <span class="hljs-string">'close'</span>,
    <span class="hljs-string">'pipe'</span>,
    <span class="hljs-string">'drain'</span>,
    <span class="hljs-string">'warn'</span>
  ].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ev</span>) </span>{
    proxy.on(ev, self.emit.bind(self, ev))
  })

  self.emit(<span class="hljs-string">'proxy'</span>, proxy)

  <span class="hljs-keyword">var</span> calls = self._buffer
  calls.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>console.error(&quot;~~ ~~ proxy buffered call&quot;, c[0], c[1])</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    proxy[c[<span class="hljs-number">0</span>]].apply(proxy, c[<span class="hljs-number">1</span>])
  })
  self._buffer.length = <span class="hljs-number">0</span>
  <span class="hljs-keyword">if</span> (self._needsDrain) self.emit(<span class="hljs-string">'drain'</span>)
}

ProxyWriter.prototype.add = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>console.error(&quot;~~ proxy add&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  collect(entry)

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._proxy) {
    <span class="hljs-keyword">this</span>._buffer.push([<span class="hljs-string">'add'</span>, [entry]])
    <span class="hljs-keyword">this</span>._needDrain = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._proxy.add(entry)
}

ProxyWriter.prototype.write = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>console.error('~~ proxy write')</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._proxy) {
    <span class="hljs-keyword">this</span>._buffer.push([<span class="hljs-string">'write'</span>, [c]])
    <span class="hljs-keyword">this</span>._needDrain = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._proxy.write(c)
}

ProxyWriter.prototype.end = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>console.error('~~ proxy end')</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._proxy) {
    <span class="hljs-keyword">this</span>._buffer.push([<span class="hljs-string">'end'</span>, [c]])
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._proxy.end(c)
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

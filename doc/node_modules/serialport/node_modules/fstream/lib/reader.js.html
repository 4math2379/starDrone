<!DOCTYPE html>
<html>
<head>
  <title>reader.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/fstream/lib/reader.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>reader.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-built_in">module</span>.exports = Reader

<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'graceful-fs'</span>)
<span class="hljs-keyword">var</span> Stream = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>).Stream
<span class="hljs-keyword">var</span> inherits = <span class="hljs-built_in">require</span>(<span class="hljs-string">'inherits'</span>)
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">var</span> getType = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./get-type.js'</span>)
<span class="hljs-keyword">var</span> hardLinks = Reader.hardLinks = {}
<span class="hljs-keyword">var</span> Abstract = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./abstract.js'</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Must do this <em>before</em> loading the child classes</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">inherits(Reader, Abstract)

<span class="hljs-keyword">var</span> LinkReader = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./link-reader.js'</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Reader</span> (<span class="hljs-params">props, currentStat</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">if</span> (!(self <span class="hljs-keyword">instanceof</span> Reader)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Reader(props, currentStat)

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> props === <span class="hljs-string">'string'</span>) {
    props = { <span class="hljs-attr">path</span>: props }
  }

  <span class="hljs-keyword">if</span> (!props.path) {
    self.error(<span class="hljs-string">'Must provide a path'</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>)
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>polymorphism.
call fstream.Reader(dir) to get a DirReader object, etc.
Note that, unlike in the Writer case, ProxyReader is going
to be the <em>normal</em> state of affairs, since we rarely know
the type of a file prior to reading it.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
  <span class="hljs-keyword">var</span> type
  <span class="hljs-keyword">var</span> ClassType

  <span class="hljs-keyword">if</span> (props.type &amp;&amp; <span class="hljs-keyword">typeof</span> props.type === <span class="hljs-string">'function'</span>) {
    type = props.type
    ClassType = type
  } <span class="hljs-keyword">else</span> {
    type = getType(props)
    ClassType = Reader
  }

  <span class="hljs-keyword">if</span> (currentStat &amp;&amp; !type) {
    type = getType(currentStat)
    props[type] = <span class="hljs-literal">true</span>
    props.type = type
  }

  <span class="hljs-keyword">switch</span> (type) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'Directory'</span>:
      ClassType = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./dir-reader.js'</span>)
      <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">case</span> <span class="hljs-string">'Link'</span>:
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>XXX hard links are just files.
However, it would be good to keep track of files' dev+inode
and nlink values, and create a HardLinkReader that emits
a linkpath value of the original copy, so that the tar
writer can preserve them.
ClassType = HardLinkReader
break</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">case</span> <span class="hljs-string">'File'</span>:
      ClassType = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./file-reader.js'</span>)
      <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">case</span> <span class="hljs-string">'SymbolicLink'</span>:
      ClassType = LinkReader
      <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">case</span> <span class="hljs-string">'Socket'</span>:
      ClassType = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./socket-reader.js'</span>)
      <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">case</span> <span class="hljs-literal">null</span>:
      ClassType = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./proxy-reader.js'</span>)
      <span class="hljs-keyword">break</span>
  }

  <span class="hljs-keyword">if</span> (!(self <span class="hljs-keyword">instanceof</span> ClassType)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ClassType(props)
  }

  Abstract.call(self)

  self.readable = <span class="hljs-literal">true</span>
  self.writable = <span class="hljs-literal">false</span>

  self.type = type
  self.props = props
  self.depth = props.depth = props.depth || <span class="hljs-number">0</span>
  self.parent = props.parent || <span class="hljs-literal">null</span>
  self.root = props.root || (props.parent &amp;&amp; props.parent.root) || self

  self._path = self.path = path.resolve(props.path)
  <span class="hljs-keyword">if</span> (process.platform === <span class="hljs-string">'win32'</span>) {
    self.path = self._path = self.path.replace(<span class="hljs-regexp">/\?/g</span>, <span class="hljs-string">'_'</span>)
    <span class="hljs-keyword">if</span> (self._path.length &gt;= <span class="hljs-number">260</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>how DOES one create files on the moon?
if the path has spaces in it, then UNC will fail.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      self._swallowErrors = <span class="hljs-literal">true</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>if (self._path.indexOf(&quot; &quot;) === -1) {</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      self._path = <span class="hljs-string">'\\\\?\\'</span> + self.path.replace(<span class="hljs-regexp">/\//g</span>, <span class="hljs-string">'\\'</span>)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>}</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    }
  }
  self.basename = props.basename = path.basename(self.path)
  self.dirname = props.dirname = path.dirname(self.path)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>these have served their purpose, and are now just noisy clutter</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  props.parent = props.root = <span class="hljs-literal">null</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>console.error(&quot;\n\n\n%s setting size to&quot;, props.path, props.size)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  self.size = props.size
  self.filter = <span class="hljs-keyword">typeof</span> props.filter === <span class="hljs-string">'function'</span> ? props.filter : <span class="hljs-literal">null</span>
  <span class="hljs-keyword">if</span> (props.sort === <span class="hljs-string">'alpha'</span>) props.sort = alphasort

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>start the ball rolling.
this will stat the thing, and then call self._read()
to start reading whatever it is.
console.error(&quot;calling stat&quot;, props.path, currentStat)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  self._stat(currentStat)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">alphasort</span> (<span class="hljs-params">a, b</span>) </span>{
  <span class="hljs-keyword">return</span> a === b ? <span class="hljs-number">0</span>
    : a.toLowerCase() &gt; b.toLowerCase() ? <span class="hljs-number">1</span>
      : a.toLowerCase() &lt; b.toLowerCase() ? <span class="hljs-number">-1</span>
        : a &gt; b ? <span class="hljs-number">1</span>
          : <span class="hljs-number">-1</span>
}

Reader.prototype._stat = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">currentStat</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">var</span> props = self.props
  <span class="hljs-keyword">var</span> stat = props.follow ? <span class="hljs-string">'stat'</span> : <span class="hljs-string">'lstat'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>console.error(&quot;Reader._stat&quot;, self._path, currentStat)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (currentStat) process.nextTick(statCb.bind(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, currentStat))
  <span class="hljs-keyword">else</span> fs[stat](self._path, statCb)

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">statCb</span> (<span class="hljs-params">er, props_</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>console.error(&quot;Reader.<em>stat, statCb&quot;, self.<em>path, props</em>, props</em>.nlink)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (er) <span class="hljs-keyword">return</span> self.error(er)

    <span class="hljs-built_in">Object</span>.keys(props_).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">k</span>) </span>{
      props[k] = props_[k]
    })

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>if it's not the expected size, then abort here.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (<span class="hljs-literal">undefined</span> !== self.size &amp;&amp; props.size !== self.size) {
      <span class="hljs-keyword">return</span> self.error(<span class="hljs-string">'incorrect size'</span>)
    }
    self.size = props.size

    <span class="hljs-keyword">var</span> type = getType(props)
    <span class="hljs-keyword">var</span> handleHardlinks = props.hardlinks !== <span class="hljs-literal">false</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>special little thing for handling hardlinks.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (handleHardlinks &amp;&amp; type !== <span class="hljs-string">'Directory'</span> &amp;&amp; props.nlink &amp;&amp; props.nlink &gt; <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">var</span> k = props.dev + <span class="hljs-string">':'</span> + props.ino
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>console.error(&quot;Reader has nlink&quot;, self._path, k)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (hardLinks[k] === self._path || !hardLinks[k]) {
        hardLinks[k] = self._path
      } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>switch into hardlink mode.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        type = self.type = self.props.type = <span class="hljs-string">'Link'</span>
        self.Link = self.props.Link = <span class="hljs-literal">true</span>
        self.linkpath = self.props.linkpath = hardLinks[k]
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>console.error(&quot;Hardlink detected, switching mode&quot;, self._path, self.linkpath)
Setting <strong>proto</strong> would arguably be the &quot;correct&quot;
approach here, but that just seems too wrong.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        self._stat = self._read = LinkReader.prototype._read
      }
    }

    <span class="hljs-keyword">if</span> (self.type &amp;&amp; self.type !== type) {
      self.error(<span class="hljs-string">'Unexpected type: '</span> + type)
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>if the filter doesn't pass, then just skip over this one.
still have to emit end so that dir-walking can move on.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (self.filter) {
      <span class="hljs-keyword">var</span> who = self._proxy || self
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>special handling for ProxyReaders</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (!self.filter.call(who, who, props)) {
        <span class="hljs-keyword">if</span> (!self._disowned) {
          self.abort()
          self.emit(<span class="hljs-string">'end'</span>)
          self.emit(<span class="hljs-string">'close'</span>)
        }
        <span class="hljs-keyword">return</span>
      }
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>last chance to abort or disown before the flow starts!</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> events = [<span class="hljs-string">'_stat'</span>, <span class="hljs-string">'stat'</span>, <span class="hljs-string">'ready'</span>]
    <span class="hljs-keyword">var</span> e = <span class="hljs-number">0</span>
    ;(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (self._aborted) {
        self.emit(<span class="hljs-string">'end'</span>)
        self.emit(<span class="hljs-string">'close'</span>)
        <span class="hljs-keyword">return</span>
      }

      <span class="hljs-keyword">if</span> (self._paused &amp;&amp; self.type !== <span class="hljs-string">'Directory'</span>) {
        self.once(<span class="hljs-string">'resume'</span>, go)
        <span class="hljs-keyword">return</span>
      }

      <span class="hljs-keyword">var</span> ev = events[e++]
      <span class="hljs-keyword">if</span> (!ev) {
        <span class="hljs-keyword">return</span> self._read()
      }
      self.emit(ev, props)
      go()
    })()
  }
}

Reader.prototype.pipe = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">dest</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> dest.add === <span class="hljs-string">'function'</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>piping to a multi-compatible, and we've got directory entries.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    self.on(<span class="hljs-string">'entry'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry</span>) </span>{
      <span class="hljs-keyword">var</span> ret = dest.add(entry)
      <span class="hljs-keyword">if</span> (ret === <span class="hljs-literal">false</span>) {
        self.pause()
      }
    })
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>console.error(&quot;R Pipe apply Stream Pipe&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">return</span> Stream.prototype.pipe.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>)
}

Reader.prototype.pause = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">who</span>) </span>{
  <span class="hljs-keyword">this</span>._paused = <span class="hljs-literal">true</span>
  who = who || <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'pause'</span>, who)
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._stream) <span class="hljs-keyword">this</span>._stream.pause(who)
}

Reader.prototype.resume = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">who</span>) </span>{
  <span class="hljs-keyword">this</span>._paused = <span class="hljs-literal">false</span>
  who = who || <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'resume'</span>, who)
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._stream) <span class="hljs-keyword">this</span>._stream.resume(who)
  <span class="hljs-keyword">this</span>._read()
}

Reader.prototype._read = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>.error(<span class="hljs-string">'Cannot read unknown type: '</span> + <span class="hljs-keyword">this</span>.type)
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

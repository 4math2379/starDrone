<!DOCTYPE html>
<html>
<head>
  <title>dir-writer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/fstream/lib/dir-writer.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>dir-writer.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>It is expected that, when .add() returns false, the consumer
of the DirWriter will pause until a &quot;drain&quot; event occurs. Note
that this is <em>almost always going to be the case</em>, unless the
thing being written is some sort of unsupported type, and thus
skipped over.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-built_in">module</span>.exports = DirWriter

<span class="hljs-keyword">var</span> Writer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./writer.js'</span>)
<span class="hljs-keyword">var</span> inherits = <span class="hljs-built_in">require</span>(<span class="hljs-string">'inherits'</span>)
<span class="hljs-keyword">var</span> mkdir = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mkdirp'</span>)
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">var</span> collect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./collect.js'</span>)

inherits(DirWriter, Writer)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DirWriter</span> (<span class="hljs-params">props</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">if</span> (!(self <span class="hljs-keyword">instanceof</span> DirWriter)) {
    self.error(<span class="hljs-string">'DirWriter must be called as constructor.'</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>)
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>should already be established as a Directory type</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (props.type !== <span class="hljs-string">'Directory'</span> || !props.Directory) {
    self.error(<span class="hljs-string">'Non-directory type '</span> + props.type + <span class="hljs-string">' '</span> +
      <span class="hljs-built_in">JSON</span>.stringify(props), <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>)
  }

  Writer.call(<span class="hljs-keyword">this</span>, props)
}

DirWriter.prototype._create = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  mkdir(self._path, Writer.dirmode, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
    <span class="hljs-keyword">if</span> (er) <span class="hljs-keyword">return</span> self.error(er)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>ready to start getting entries!</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    self.ready = <span class="hljs-literal">true</span>
    self.emit(<span class="hljs-string">'ready'</span>)
    self._process()
  })
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>a DirWriter has an add(entry) method, but its .write() doesn't
do anything.  Why a no-op rather than a throw?  Because this
leaves open the door for writing directory metadata for
gnu/solaris style dumpdirs.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">DirWriter.prototype.write = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

DirWriter.prototype.end = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>._ended = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">this</span>._process()
}

DirWriter.prototype.add = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>console.error('\tadd', entry._path, '-&gt;', self._path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  collect(entry)
  <span class="hljs-keyword">if</span> (!self.ready || self._currentEntry) {
    self._buffer.push(entry)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>create a new writer, and pipe the incoming entry into it.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (self._ended) {
    <span class="hljs-keyword">return</span> self.error(<span class="hljs-string">'add after end'</span>)
  }

  self._buffer.push(entry)
  self._process()

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._buffer.length === <span class="hljs-number">0</span>
}

DirWriter.prototype._process = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>console.error('DW Process p=%j', self._processing, self.basename)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
  <span class="hljs-keyword">if</span> (self._processing) <span class="hljs-keyword">return</span>

  <span class="hljs-keyword">var</span> entry = self._buffer.shift()
  <span class="hljs-keyword">if</span> (!entry) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>console.error(&quot;DW Drain&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    self.emit(<span class="hljs-string">'drain'</span>)
    <span class="hljs-keyword">if</span> (self._ended) self._finish()
    <span class="hljs-keyword">return</span>
  }

  self._processing = <span class="hljs-literal">true</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>console.error(&quot;DW Entry&quot;, entry._path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
  self.emit(<span class="hljs-string">'entry'</span>, entry)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>ok, add this entry</p>
<p>don't allow recursive copying</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> p = entry
  <span class="hljs-keyword">var</span> pp
  <span class="hljs-keyword">do</span> {
    pp = p._path || p.path
    <span class="hljs-keyword">if</span> (pp === self.root._path || pp === self._path ||
      (pp &amp;&amp; pp.indexOf(self._path) === <span class="hljs-number">0</span>)) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>console.error('DW Exit (recursive)', entry.basename, self._path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      self._processing = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">if</span> (entry._collected) entry.pipe()
      <span class="hljs-keyword">return</span> self._process()
    }
    p = p.parent
  } <span class="hljs-keyword">while</span> (p)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>console.error(&quot;DW not recursive&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>chop off the entry's root dir, replace with ours</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> props = {
    <span class="hljs-attr">parent</span>: self,
    <span class="hljs-attr">root</span>: self.root || self,
    <span class="hljs-attr">type</span>: entry.type,
    <span class="hljs-attr">depth</span>: self.depth + <span class="hljs-number">1</span>
  }

  pp = entry._path || entry.path || entry.props.path
  <span class="hljs-keyword">if</span> (entry.parent) {
    pp = pp.substr(entry.parent._path.length + <span class="hljs-number">1</span>)
  }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>get rid of any ../../ shenanigans</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  props.path = path.join(self.path, path.join(<span class="hljs-string">'/'</span>, pp))

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>if i have a filter, the child should inherit it.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  props.filter = self.filter

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>all the rest of the stuff, copy over from the source.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-built_in">Object</span>.keys(entry.props).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">k</span>) </span>{
    <span class="hljs-keyword">if</span> (!props.hasOwnProperty(k)) {
      props[k] = entry.props[k]
    }
  })

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>not sure at this point what kind of writer this is.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> child = self._currentChild = <span class="hljs-keyword">new</span> Writer(props)
  child.on(<span class="hljs-string">'ready'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>console.error(&quot;DW Child Ready&quot;, child.type, child._path)
console.error(&quot;  resuming&quot;, entry._path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    entry.pipe(child)
    entry.resume()
  })

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>XXX Make this work in node.
Long filenames should not break stuff.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  child.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
    <span class="hljs-keyword">if</span> (child._swallowErrors) {
      self.warn(er)
      child.emit(<span class="hljs-string">'end'</span>)
      child.emit(<span class="hljs-string">'close'</span>)
    } <span class="hljs-keyword">else</span> {
      self.emit(<span class="hljs-string">'error'</span>, er)
    }
  })

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>we fire _end internally <em>after</em> end, so that we don't move on
until any &quot;end&quot; listeners have had their chance to do stuff.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  child.on(<span class="hljs-string">'close'</span>, onend)
  <span class="hljs-keyword">var</span> ended = <span class="hljs-literal">false</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onend</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (ended) <span class="hljs-keyword">return</span>
    ended = <span class="hljs-literal">true</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>console.error(&quot;* DW Child end&quot;, child.basename)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    self._currentChild = <span class="hljs-literal">null</span>
    self._processing = <span class="hljs-literal">false</span>
    self._process()
  }
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>file-reader.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/fstream/lib/file-reader.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>file-reader.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>Basically just a wrapper around an fs.ReadStream</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-built_in">module</span>.exports = FileReader

<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'graceful-fs'</span>)
<span class="hljs-keyword">var</span> inherits = <span class="hljs-built_in">require</span>(<span class="hljs-string">'inherits'</span>)
<span class="hljs-keyword">var</span> Reader = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./reader.js'</span>)
<span class="hljs-keyword">var</span> EOF = {<span class="hljs-attr">EOF</span>: <span class="hljs-literal">true</span>}
<span class="hljs-keyword">var</span> CLOSE = {<span class="hljs-attr">CLOSE</span>: <span class="hljs-literal">true</span>}

inherits(FileReader, Reader)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">FileReader</span> (<span class="hljs-params">props</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>console.error(&quot;    FR create&quot;, props.path, props.size, new Error().stack)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">if</span> (!(self <span class="hljs-keyword">instanceof</span> FileReader)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'FileReader must be called as constructor.'</span>)
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>should already be established as a File type
XXX Todo: preserve hardlinks by tracking dev+inode+nlink,
with a HardLinkReader class.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!((props.type === <span class="hljs-string">'Link'</span> &amp;&amp; props.Link) ||
    (props.type === <span class="hljs-string">'File'</span> &amp;&amp; props.File))) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Non-file type '</span> + props.type)
  }

  self._buffer = []
  self._bytesEmitted = <span class="hljs-number">0</span>
  Reader.call(self, props)
}

FileReader.prototype._getStream = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">var</span> stream = self._stream = fs.createReadStream(self._path, self.props)

  <span class="hljs-keyword">if</span> (self.props.blksize) {
    stream.bufferSize = self.props.blksize
  }

  stream.on(<span class="hljs-string">'open'</span>, self.emit.bind(self, <span class="hljs-string">'open'</span>))

  stream.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>console.error('\t\t%d %s', c.length, self.basename)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    self._bytesEmitted += c.length
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>no point saving empty chunks</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (!c.length) {
      <span class="hljs-keyword">return</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (self._paused || self._buffer.length) {
      self._buffer.push(c)
      self._read()
    } <span class="hljs-keyword">else</span> self.emit(<span class="hljs-string">'data'</span>, c)
  })

  stream.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (self._paused || self._buffer.length) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>console.error('FR Buffering End', self._path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      self._buffer.push(EOF)
      self._read()
    } <span class="hljs-keyword">else</span> {
      self.emit(<span class="hljs-string">'end'</span>)
    }

    <span class="hljs-keyword">if</span> (self._bytesEmitted !== self.props.size) {
      self.error(<span class="hljs-string">"Didn't get expected byte count\n"</span> +
        <span class="hljs-string">'expect: '</span> + self.props.size + <span class="hljs-string">'\n'</span> +
        <span class="hljs-string">'actual: '</span> + self._bytesEmitted)
    }
  })

  stream.on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (self._paused || self._buffer.length) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>console.error('FR Buffering Close', self._path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      self._buffer.push(CLOSE)
      self._read()
    } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>console.error('FR close 1', self._path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      self.emit(<span class="hljs-string">'close'</span>)
    }
  })

  stream.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{
    self.emit(<span class="hljs-string">'error'</span>, e)
  })

  self._read()
}

FileReader.prototype._read = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>console.error('FR _read', self._path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (self._paused) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>console.error('FR _read paused', self._path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">if</span> (!self._stream) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>console.error('FR _getStream calling', self._path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">return</span> self._getStream()
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>clear out the buffer, if there is one.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (self._buffer.length) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>console.error('FR _read has buffer', self._buffer.length, self._path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> buf = self._buffer
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = buf.length; i &lt; l; i++) {
      <span class="hljs-keyword">var</span> c = buf[i]
      <span class="hljs-keyword">if</span> (c === EOF) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>console.error('FR Read emitting buffered end', self._path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        self.emit(<span class="hljs-string">'end'</span>)
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c === CLOSE) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>console.error('FR Read emitting buffered close', self._path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        self.emit(<span class="hljs-string">'close'</span>)
      } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>console.error('FR Read emitting buffered data', self._path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        self.emit(<span class="hljs-string">'data'</span>, c)
      }

      <span class="hljs-keyword">if</span> (self._paused) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>console.error('FR Read Re-pausing at '+i, self._path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        self._buffer = buf.slice(i)
        <span class="hljs-keyword">return</span>
      }
    }
    self._buffer.length = <span class="hljs-number">0</span>
  }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>console.error(&quot;FR _read done&quot;)
that's about all there is to it.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">}

FileReader.prototype.pause = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">who</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>console.error('FR Pause', self._path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (self._paused) <span class="hljs-keyword">return</span>
  who = who || self
  self._paused = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">if</span> (self._stream) self._stream.pause()
  self.emit(<span class="hljs-string">'pause'</span>, who)
}

FileReader.prototype.resume = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">who</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>console.error('FR Resume', self._path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!self._paused) <span class="hljs-keyword">return</span>
  who = who || self
  self.emit(<span class="hljs-string">'resume'</span>, who)
  self._paused = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> (self._stream) self._stream.resume()
  self._read()
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

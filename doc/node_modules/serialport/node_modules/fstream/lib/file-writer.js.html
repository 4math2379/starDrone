<!DOCTYPE html>
<html>
<head>
  <title>file-writer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/fstream/lib/file-writer.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>file-writer.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-built_in">module</span>.exports = FileWriter

<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'graceful-fs'</span>)
<span class="hljs-keyword">var</span> Writer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./writer.js'</span>)
<span class="hljs-keyword">var</span> inherits = <span class="hljs-built_in">require</span>(<span class="hljs-string">'inherits'</span>)
<span class="hljs-keyword">var</span> EOF = {}

inherits(FileWriter, Writer)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">FileWriter</span> (<span class="hljs-params">props</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">if</span> (!(self <span class="hljs-keyword">instanceof</span> FileWriter)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'FileWriter must be called as constructor.'</span>)
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>should already be established as a File type</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (props.type !== <span class="hljs-string">'File'</span> || !props.File) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Non-file type '</span> + props.type)
  }

  self._buffer = []
  self._bytesWritten = <span class="hljs-number">0</span>

  Writer.call(<span class="hljs-keyword">this</span>, props)
}

FileWriter.prototype._create = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">if</span> (self._stream) <span class="hljs-keyword">return</span>

  <span class="hljs-keyword">var</span> so = {}
  <span class="hljs-keyword">if</span> (self.props.flags) so.flags = self.props.flags
  so.mode = Writer.filemode
  <span class="hljs-keyword">if</span> (self._old &amp;&amp; self._old.blksize) so.bufferSize = self._old.blksize

  self._stream = fs.createWriteStream(self._path, so)

  self._stream.on(<span class="hljs-string">'open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>console.error(&quot;FW open&quot;, self._buffer, self._path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    self.ready = <span class="hljs-literal">true</span>
    self._buffer.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
      <span class="hljs-keyword">if</span> (c === EOF) self._stream.end()
      <span class="hljs-keyword">else</span> self._stream.write(c)
    })
    self.emit(<span class="hljs-string">'ready'</span>)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>give this a kick just in case it needs it.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    self.emit(<span class="hljs-string">'drain'</span>)
  })

  self._stream.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{ self.emit(<span class="hljs-string">'error'</span>, er) })

  self._stream.on(<span class="hljs-string">'drain'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ self.emit(<span class="hljs-string">'drain'</span>) })

  self._stream.on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>console.error('\n\nFW Stream Close', self._path, self.size)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    self._finish()
  })
}

FileWriter.prototype.write = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

  self._bytesWritten += c.length

  <span class="hljs-keyword">if</span> (!self.ready) {
    <span class="hljs-keyword">if</span> (!Buffer.isBuffer(c) &amp;&amp; <span class="hljs-keyword">typeof</span> c !== <span class="hljs-string">'string'</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'invalid write data'</span>)
    }
    self._buffer.push(c)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }

  <span class="hljs-keyword">var</span> ret = self._stream.write(c)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>console.error('\t-- fw wrote, _stream says', ret, self._stream._queue.length)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>allow 2 buffered writes, because otherwise there's just too
much stop and go bs.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (ret === <span class="hljs-literal">false</span> &amp;&amp; self._stream._queue) {
    <span class="hljs-keyword">return</span> self._stream._queue.length &lt;= <span class="hljs-number">2</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> ret
  }
}

FileWriter.prototype.end = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

  <span class="hljs-keyword">if</span> (c) self.write(c)

  <span class="hljs-keyword">if</span> (!self.ready) {
    self._buffer.push(EOF)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }

  <span class="hljs-keyword">return</span> self._stream.end()
}

FileWriter.prototype._finish = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> self.size === <span class="hljs-string">'number'</span> &amp;&amp; self._bytesWritten !== self.size) {
    self.error(
      <span class="hljs-string">'Did not get expected byte count.\n'</span> +
      <span class="hljs-string">'expect: '</span> + self.size + <span class="hljs-string">'\n'</span> +
      <span class="hljs-string">'actual: '</span> + self._bytesWritten)
  }
  Writer.prototype._finish.call(self)
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../";
    var thisFile = "node_modules/serialport/node_modules/is-my-json-valid/index.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> genobj = <span class="hljs-built_in">require</span>(<span class="hljs-string">'generate-object-property'</span>)
<span class="hljs-keyword">var</span> genfun = <span class="hljs-built_in">require</span>(<span class="hljs-string">'generate-function'</span>)
<span class="hljs-keyword">var</span> jsonpointer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jsonpointer'</span>)
<span class="hljs-keyword">var</span> xtend = <span class="hljs-built_in">require</span>(<span class="hljs-string">'xtend'</span>)
<span class="hljs-keyword">var</span> formats = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./formats'</span>)

<span class="hljs-keyword">var</span> get = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj, additionalSchemas, ptr</span>) </span>{

  <span class="hljs-keyword">var</span> visit = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sub</span>) </span>{
    <span class="hljs-keyword">if</span> (sub &amp;&amp; sub.id === ptr) <span class="hljs-keyword">return</span> sub
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> sub !== <span class="hljs-string">'object'</span> || !sub) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(sub).reduce(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">res, k</span>) </span>{
      <span class="hljs-keyword">return</span> res || visit(sub[k])
    }, <span class="hljs-literal">null</span>)
  }

  <span class="hljs-keyword">var</span> res = visit(obj)
  <span class="hljs-keyword">if</span> (res) <span class="hljs-keyword">return</span> res

  ptr = ptr.replace(<span class="hljs-regexp">/^#/</span>, <span class="hljs-string">''</span>)
  ptr = ptr.replace(<span class="hljs-regexp">/\/$/</span>, <span class="hljs-string">''</span>)

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> jsonpointer.get(obj, <span class="hljs-built_in">decodeURI</span>(ptr))
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-keyword">var</span> end = ptr.indexOf(<span class="hljs-string">'#'</span>)
    <span class="hljs-keyword">var</span> other
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>external reference</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (end !== <span class="hljs-number">0</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>fragment doesn't exist.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (end === <span class="hljs-number">-1</span>) {
        other = additionalSchemas[ptr]
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> ext = ptr.slice(<span class="hljs-number">0</span>, end)
        other = additionalSchemas[ext]
        <span class="hljs-keyword">var</span> fragment = ptr.slice(end).replace(<span class="hljs-regexp">/^#/</span>, <span class="hljs-string">''</span>)
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">return</span> jsonpointer.get(other, fragment)
        } <span class="hljs-keyword">catch</span> (err) {}
      }
    } <span class="hljs-keyword">else</span> {
      other = additionalSchemas[ptr]
    }
    <span class="hljs-keyword">return</span> other || <span class="hljs-literal">null</span>
  }
}

<span class="hljs-keyword">var</span> formatName = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">field</span>) </span>{
  field = <span class="hljs-built_in">JSON</span>.stringify(field)
  <span class="hljs-keyword">var</span> pattern = <span class="hljs-regexp">/\[([^\[\]"]+)\]/</span>
  <span class="hljs-keyword">while</span> (pattern.test(field)) field = field.replace(pattern, <span class="hljs-string">'."+$1+"'</span>)
  <span class="hljs-keyword">return</span> field
}

<span class="hljs-keyword">var</span> types = {}

types.any = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">'true'</span>
}

types.null = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
  <span class="hljs-keyword">return</span> name+<span class="hljs-string">' === null'</span>
}

types.boolean = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">'typeof '</span>+name+<span class="hljs-string">' === "boolean"'</span>
}

types.array = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">'Array.isArray('</span>+name+<span class="hljs-string">')'</span>
}

types.object = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">'typeof '</span>+name+<span class="hljs-string">' === "object" &amp;&amp; '</span>+name+<span class="hljs-string">' &amp;&amp; !Array.isArray('</span>+name+<span class="hljs-string">')'</span>
}

types.number = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">'typeof '</span>+name+<span class="hljs-string">' === "number"'</span>
}

types.integer = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">'typeof '</span>+name+<span class="hljs-string">' === "number" &amp;&amp; (Math.floor('</span>+name+<span class="hljs-string">') === '</span>+name+<span class="hljs-string">' || '</span>+name+<span class="hljs-string">' &gt; 9007199254740992 || '</span>+name+<span class="hljs-string">' &lt; -9007199254740992)'</span>
}

types.string = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">'typeof '</span>+name+<span class="hljs-string">' === "string"'</span>
}

<span class="hljs-keyword">var</span> unique = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">array</span>) </span>{
  <span class="hljs-keyword">var</span> list = []
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; array.length; i++) {
    list.push(<span class="hljs-keyword">typeof</span> array[i] === <span class="hljs-string">'object'</span> ? <span class="hljs-built_in">JSON</span>.stringify(array[i]) : array[i])
  }
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>; i &lt; list.length; i++) {
    <span class="hljs-keyword">if</span> (list.indexOf(list[i]) !== i) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-keyword">var</span> isMultipleOf = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, multipleOf</span>) </span>{
  <span class="hljs-keyword">var</span> res;
  <span class="hljs-keyword">var</span> factor = ((multipleOf | <span class="hljs-number">0</span>) !== multipleOf) ? <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, multipleOf.toString().split(<span class="hljs-string">'.'</span>).pop().length) : <span class="hljs-number">1</span>
  <span class="hljs-keyword">if</span> (factor &gt; <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">var</span> factorName = ((name | <span class="hljs-number">0</span>) !== name) ? <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, name.toString().split(<span class="hljs-string">'.'</span>).pop().length) : <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> (factorName &gt; factor) res = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">else</span> res = <span class="hljs-built_in">Math</span>.round(factor * name) % (factor * multipleOf)
  }
  <span class="hljs-keyword">else</span> res = name % multipleOf;
  <span class="hljs-keyword">return</span> !res;
}

<span class="hljs-keyword">var</span> toType = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">node</span>) </span>{
  <span class="hljs-keyword">return</span> node.type
}

<span class="hljs-keyword">var</span> compile = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">schema, cache, root, reporter, opts</span>) </span>{
  <span class="hljs-keyword">var</span> fmts = opts ? xtend(formats, opts.formats) : formats
  <span class="hljs-keyword">var</span> scope = {<span class="hljs-attr">unique</span>:unique, <span class="hljs-attr">formats</span>:fmts, <span class="hljs-attr">isMultipleOf</span>:isMultipleOf}
  <span class="hljs-keyword">var</span> verbose = opts ? !!opts.verbose : <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> greedy = opts &amp;&amp; opts.greedy !== <span class="hljs-literal">undefined</span> ?
    opts.greedy : <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">var</span> syms = {}
  <span class="hljs-keyword">var</span> gensym = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
    <span class="hljs-keyword">return</span> name+(syms[name] = (syms[name] || <span class="hljs-number">0</span>)+<span class="hljs-number">1</span>)
  }

  <span class="hljs-keyword">var</span> reversePatterns = {}
  <span class="hljs-keyword">var</span> patterns = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p</span>) </span>{
    <span class="hljs-keyword">if</span> (reversePatterns[p]) <span class="hljs-keyword">return</span> reversePatterns[p]
    <span class="hljs-keyword">var</span> n = gensym(<span class="hljs-string">'pattern'</span>)
    scope[n] = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(p)
    reversePatterns[p] = n
    <span class="hljs-keyword">return</span> n
  }

  <span class="hljs-keyword">var</span> vars = [<span class="hljs-string">'i'</span>,<span class="hljs-string">'j'</span>,<span class="hljs-string">'k'</span>,<span class="hljs-string">'l'</span>,<span class="hljs-string">'m'</span>,<span class="hljs-string">'n'</span>,<span class="hljs-string">'o'</span>,<span class="hljs-string">'p'</span>,<span class="hljs-string">'q'</span>,<span class="hljs-string">'r'</span>,<span class="hljs-string">'s'</span>,<span class="hljs-string">'t'</span>,<span class="hljs-string">'u'</span>,<span class="hljs-string">'v'</span>,<span class="hljs-string">'x'</span>,<span class="hljs-string">'y'</span>,<span class="hljs-string">'z'</span>]
  <span class="hljs-keyword">var</span> genloop = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> v = vars.shift()
    vars.push(v+v[<span class="hljs-number">0</span>])
    <span class="hljs-keyword">return</span> v
  }

  <span class="hljs-keyword">var</span> visit = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, node, reporter, filter</span>) </span>{
    <span class="hljs-keyword">var</span> properties = node.properties
    <span class="hljs-keyword">var</span> type = node.type
    <span class="hljs-keyword">var</span> tuple = <span class="hljs-literal">false</span>

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(node.items)) { <span class="hljs-comment">// tuple type</span>
      properties = {}
      node.items.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item, i</span>) </span>{
        properties[i] = item
      })
      type = <span class="hljs-string">'array'</span>
      tuple = <span class="hljs-literal">true</span>
    }

    <span class="hljs-keyword">var</span> indent = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> error = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msg, prop, value</span>) </span>{
      validate(<span class="hljs-string">'errors++'</span>)
      <span class="hljs-keyword">if</span> (reporter === <span class="hljs-literal">true</span>) {
        validate(<span class="hljs-string">'if (validate.errors === null) validate.errors = []'</span>)
        <span class="hljs-keyword">if</span> (verbose) {
          validate(<span class="hljs-string">'validate.errors.push({field:%s,message:%s,value:%s,type:%s})'</span>, formatName(prop || name), <span class="hljs-built_in">JSON</span>.stringify(msg), value || name, <span class="hljs-built_in">JSON</span>.stringify(type))
        } <span class="hljs-keyword">else</span> {
          validate(<span class="hljs-string">'validate.errors.push({field:%s,message:%s})'</span>, formatName(prop || name), <span class="hljs-built_in">JSON</span>.stringify(msg))
        }
      }
    }

    <span class="hljs-keyword">if</span> (node.required === <span class="hljs-literal">true</span>) {
      indent++
      validate(<span class="hljs-string">'if (%s === undefined) {'</span>, name)
      error(<span class="hljs-string">'is required'</span>)
      validate(<span class="hljs-string">'} else {'</span>)
    } <span class="hljs-keyword">else</span> {
      indent++
      validate(<span class="hljs-string">'if (%s !== undefined) {'</span>, name)
    }

    <span class="hljs-keyword">var</span> valid = [].concat(type)
      .map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">t</span>) </span>{
        <span class="hljs-keyword">return</span> types[t || <span class="hljs-string">'any'</span>](name)
      })
      .join(<span class="hljs-string">' || '</span>) || <span class="hljs-string">'true'</span>

    <span class="hljs-keyword">if</span> (valid !== <span class="hljs-string">'true'</span>) {
      indent++
      validate(<span class="hljs-string">'if (!(%s)) {'</span>, valid)
      error(<span class="hljs-string">'is the wrong type'</span>)
      validate(<span class="hljs-string">'} else {'</span>)
    }

    <span class="hljs-keyword">if</span> (tuple) {
      <span class="hljs-keyword">if</span> (node.additionalItems === <span class="hljs-literal">false</span>) {
        validate(<span class="hljs-string">'if (%s.length &gt; %d) {'</span>, name, node.items.length)
        error(<span class="hljs-string">'has additional items'</span>)
        validate(<span class="hljs-string">'}'</span>)
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (node.additionalItems) {
        <span class="hljs-keyword">var</span> i = genloop()
        validate(<span class="hljs-string">'for (var %s = %d; %s &lt; %s.length; %s++) {'</span>, i, node.items.length, i, name, i)
        visit(name+<span class="hljs-string">'['</span>+i+<span class="hljs-string">']'</span>, node.additionalItems, reporter, filter)
        validate(<span class="hljs-string">'}'</span>)
      }
    }

    <span class="hljs-keyword">if</span> (node.format &amp;&amp; fmts[node.format]) {
      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'string'</span> &amp;&amp; formats[node.format]) validate(<span class="hljs-string">'if (%s) {'</span>, types.string(name))
      <span class="hljs-keyword">var</span> n = gensym(<span class="hljs-string">'format'</span>)
      scope[n] = fmts[node.format]

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> scope[n] === <span class="hljs-string">'function'</span>) validate(<span class="hljs-string">'if (!%s(%s)) {'</span>, n, name)
      <span class="hljs-keyword">else</span> validate(<span class="hljs-string">'if (!%s.test(%s)) {'</span>, n, name)
      error(<span class="hljs-string">'must be '</span>+node.format+<span class="hljs-string">' format'</span>)
      validate(<span class="hljs-string">'}'</span>)
      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'string'</span> &amp;&amp; formats[node.format]) validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(node.required)) {
      <span class="hljs-keyword">var</span> isUndefined = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req</span>) </span>{
        <span class="hljs-keyword">return</span> genobj(name, req) + <span class="hljs-string">' === undefined'</span>
      }

      <span class="hljs-keyword">var</span> checkRequired = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req</span>) </span>{
        <span class="hljs-keyword">var</span> prop = genobj(name, req);
        validate(<span class="hljs-string">'if (%s === undefined) {'</span>, prop)
        error(<span class="hljs-string">'is required'</span>, prop)
        validate(<span class="hljs-string">'missing++'</span>)
        validate(<span class="hljs-string">'}'</span>)
      }
      validate(<span class="hljs-string">'if ((%s)) {'</span>, type !== <span class="hljs-string">'object'</span> ? types.object(name) : <span class="hljs-string">'true'</span>)
      validate(<span class="hljs-string">'var missing = 0'</span>)
      node.required.map(checkRequired)
      validate(<span class="hljs-string">'}'</span>);
      <span class="hljs-keyword">if</span> (!greedy) {
        validate(<span class="hljs-string">'if (missing === 0) {'</span>)
        indent++
      }
    }

    <span class="hljs-keyword">if</span> (node.uniqueItems) {
      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'array'</span>) validate(<span class="hljs-string">'if (%s) {'</span>, types.array(name))
      validate(<span class="hljs-string">'if (!(unique(%s))) {'</span>, name)
      error(<span class="hljs-string">'must be unique'</span>)
      validate(<span class="hljs-string">'}'</span>)
      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'array'</span>) validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (node.enum) {
      <span class="hljs-keyword">var</span> complex = node.enum.some(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> e === <span class="hljs-string">'object'</span>
      })

      <span class="hljs-keyword">var</span> compare = complex ?
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
          <span class="hljs-keyword">return</span> <span class="hljs-string">'JSON.stringify('</span>+name+<span class="hljs-string">')'</span>+<span class="hljs-string">' !== JSON.stringify('</span>+<span class="hljs-built_in">JSON</span>.stringify(e)+<span class="hljs-string">')'</span>
        } :
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
          <span class="hljs-keyword">return</span> name+<span class="hljs-string">' !== '</span>+<span class="hljs-built_in">JSON</span>.stringify(e)
        }

      validate(<span class="hljs-string">'if (%s) {'</span>, node.enum.map(compare).join(<span class="hljs-string">' &amp;&amp; '</span>) || <span class="hljs-string">'false'</span>)
      error(<span class="hljs-string">'must be an enum value'</span>)
      validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (node.dependencies) {
      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'object'</span>) validate(<span class="hljs-string">'if (%s) {'</span>, types.object(name))

      <span class="hljs-built_in">Object</span>.keys(node.dependencies).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key</span>) </span>{
        <span class="hljs-keyword">var</span> deps = node.dependencies[key]
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> deps === <span class="hljs-string">'string'</span>) deps = [deps]

        <span class="hljs-keyword">var</span> exists = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">k</span>) </span>{
          <span class="hljs-keyword">return</span> genobj(name, k) + <span class="hljs-string">' !== undefined'</span>
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(deps)) {
          validate(<span class="hljs-string">'if (%s !== undefined &amp;&amp; !(%s)) {'</span>, genobj(name, key), deps.map(exists).join(<span class="hljs-string">' &amp;&amp; '</span>) || <span class="hljs-string">'true'</span>)
          error(<span class="hljs-string">'dependencies not set'</span>)
          validate(<span class="hljs-string">'}'</span>)
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> deps === <span class="hljs-string">'object'</span>) {
          validate(<span class="hljs-string">'if (%s !== undefined) {'</span>, genobj(name, key))
          visit(name, deps, reporter, filter)
          validate(<span class="hljs-string">'}'</span>)
        }
      })

      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'object'</span>) validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (node.additionalProperties || node.additionalProperties === <span class="hljs-literal">false</span>) {
      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'object'</span>) validate(<span class="hljs-string">'if (%s) {'</span>, types.object(name))

      <span class="hljs-keyword">var</span> i = genloop()
      <span class="hljs-keyword">var</span> keys = gensym(<span class="hljs-string">'keys'</span>)

      <span class="hljs-keyword">var</span> toCompare = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p</span>) </span>{
        <span class="hljs-keyword">return</span> keys+<span class="hljs-string">'['</span>+i+<span class="hljs-string">'] !== '</span>+<span class="hljs-built_in">JSON</span>.stringify(p)
      }

      <span class="hljs-keyword">var</span> toTest = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">'!'</span>+patterns(p)+<span class="hljs-string">'.test('</span>+keys+<span class="hljs-string">'['</span>+i+<span class="hljs-string">'])'</span>
      }

      <span class="hljs-keyword">var</span> additionalProp = <span class="hljs-built_in">Object</span>.keys(properties || {}).map(toCompare)
        .concat(<span class="hljs-built_in">Object</span>.keys(node.patternProperties || {}).map(toTest))
        .join(<span class="hljs-string">' &amp;&amp; '</span>) || <span class="hljs-string">'true'</span>

      validate(<span class="hljs-string">'var %s = Object.keys(%s)'</span>, keys, name)
        (<span class="hljs-string">'for (var %s = 0; %s &lt; %s.length; %s++) {'</span>, i, i, keys, i)
          (<span class="hljs-string">'if (%s) {'</span>, additionalProp)

      <span class="hljs-keyword">if</span> (node.additionalProperties === <span class="hljs-literal">false</span>) {
        <span class="hljs-keyword">if</span> (filter) validate(<span class="hljs-string">'delete %s'</span>, name+<span class="hljs-string">'['</span>+keys+<span class="hljs-string">'['</span>+i+<span class="hljs-string">']]'</span>)
        error(<span class="hljs-string">'has additional properties'</span>, <span class="hljs-literal">null</span>, <span class="hljs-built_in">JSON</span>.stringify(name+<span class="hljs-string">'.'</span>) + <span class="hljs-string">' + '</span> + keys + <span class="hljs-string">'['</span>+i+<span class="hljs-string">']'</span>)
      } <span class="hljs-keyword">else</span> {
        visit(name+<span class="hljs-string">'['</span>+keys+<span class="hljs-string">'['</span>+i+<span class="hljs-string">']]'</span>, node.additionalProperties, reporter, filter)
      }

      validate
          (<span class="hljs-string">'}'</span>)
        (<span class="hljs-string">'}'</span>)

      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'object'</span>) validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (node.$ref) {
      <span class="hljs-keyword">var</span> sub = get(root, opts &amp;&amp; opts.schemas || {}, node.$ref)
      <span class="hljs-keyword">if</span> (sub) {
        <span class="hljs-keyword">var</span> fn = cache[node.$ref]
        <span class="hljs-keyword">if</span> (!fn) {
          cache[node.$ref] = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">proxy</span>(<span class="hljs-params">data</span>) </span>{
            <span class="hljs-keyword">return</span> fn(data)
          }
          fn = compile(sub, cache, root, <span class="hljs-literal">false</span>, opts)
        }
        <span class="hljs-keyword">var</span> n = gensym(<span class="hljs-string">'ref'</span>)
        scope[n] = fn
        validate(<span class="hljs-string">'if (!(%s(%s))) {'</span>, n, name)
        error(<span class="hljs-string">'referenced schema does not match'</span>)
        validate(<span class="hljs-string">'}'</span>)
      }
    }

    <span class="hljs-keyword">if</span> (node.not) {
      <span class="hljs-keyword">var</span> prev = gensym(<span class="hljs-string">'prev'</span>)
      validate(<span class="hljs-string">'var %s = errors'</span>, prev)
      visit(name, node.not, <span class="hljs-literal">false</span>, filter)
      validate(<span class="hljs-string">'if (%s === errors) {'</span>, prev)
      error(<span class="hljs-string">'negative schema matches'</span>)
      validate(<span class="hljs-string">'} else {'</span>)
        (<span class="hljs-string">'errors = %s'</span>, prev)
      (<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (node.items &amp;&amp; !tuple) {
      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'array'</span>) validate(<span class="hljs-string">'if (%s) {'</span>, types.array(name))

      <span class="hljs-keyword">var</span> i = genloop()
      validate(<span class="hljs-string">'for (var %s = 0; %s &lt; %s.length; %s++) {'</span>, i, i, name, i)
      visit(name+<span class="hljs-string">'['</span>+i+<span class="hljs-string">']'</span>, node.items, reporter, filter)
      validate(<span class="hljs-string">'}'</span>)

      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'array'</span>) validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (node.patternProperties) {
      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'object'</span>) validate(<span class="hljs-string">'if (%s) {'</span>, types.object(name))
      <span class="hljs-keyword">var</span> keys = gensym(<span class="hljs-string">'keys'</span>)
      <span class="hljs-keyword">var</span> i = genloop()
      validate
        (<span class="hljs-string">'var %s = Object.keys(%s)'</span>, keys, name)
        (<span class="hljs-string">'for (var %s = 0; %s &lt; %s.length; %s++) {'</span>, i, i, keys, i)

      <span class="hljs-built_in">Object</span>.keys(node.patternProperties).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key</span>) </span>{
        <span class="hljs-keyword">var</span> p = patterns(key)
        validate(<span class="hljs-string">'if (%s.test(%s)) {'</span>, p, keys+<span class="hljs-string">'['</span>+i+<span class="hljs-string">']'</span>)
        visit(name+<span class="hljs-string">'['</span>+keys+<span class="hljs-string">'['</span>+i+<span class="hljs-string">']]'</span>, node.patternProperties[key], reporter, filter)
        validate(<span class="hljs-string">'}'</span>)
      })

      validate(<span class="hljs-string">'}'</span>)
      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'object'</span>) validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (node.pattern) {
      <span class="hljs-keyword">var</span> p = patterns(node.pattern)
      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'string'</span>) validate(<span class="hljs-string">'if (%s) {'</span>, types.string(name))
      validate(<span class="hljs-string">'if (!(%s.test(%s))) {'</span>, p, name)
      error(<span class="hljs-string">'pattern mismatch'</span>)
      validate(<span class="hljs-string">'}'</span>)
      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'string'</span>) validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (node.allOf) {
      node.allOf.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sch</span>) </span>{
        visit(name, sch, reporter, filter)
      })
    }

    <span class="hljs-keyword">if</span> (node.anyOf &amp;&amp; node.anyOf.length) {
      <span class="hljs-keyword">var</span> prev = gensym(<span class="hljs-string">'prev'</span>)

      node.anyOf.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sch, i</span>) </span>{
        <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span>) {
          validate(<span class="hljs-string">'var %s = errors'</span>, prev)
        } <span class="hljs-keyword">else</span> {
          validate(<span class="hljs-string">'if (errors !== %s) {'</span>, prev)
            (<span class="hljs-string">'errors = %s'</span>, prev)
        }
        visit(name, sch, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>)
      })
      node.anyOf.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sch, i</span>) </span>{
        <span class="hljs-keyword">if</span> (i) validate(<span class="hljs-string">'}'</span>)
      })
      validate(<span class="hljs-string">'if (%s !== errors) {'</span>, prev)
      error(<span class="hljs-string">'no schemas match'</span>)
      validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (node.oneOf &amp;&amp; node.oneOf.length) {
      <span class="hljs-keyword">var</span> prev = gensym(<span class="hljs-string">'prev'</span>)
      <span class="hljs-keyword">var</span> passes = gensym(<span class="hljs-string">'passes'</span>)

      validate
        (<span class="hljs-string">'var %s = errors'</span>, prev)
        (<span class="hljs-string">'var %s = 0'</span>, passes)

      node.oneOf.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sch, i</span>) </span>{
        visit(name, sch, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>)
        validate(<span class="hljs-string">'if (%s === errors) {'</span>, prev)
          (<span class="hljs-string">'%s++'</span>, passes)
        (<span class="hljs-string">'} else {'</span>)
          (<span class="hljs-string">'errors = %s'</span>, prev)
        (<span class="hljs-string">'}'</span>)
      })

      validate(<span class="hljs-string">'if (%s !== 1) {'</span>, passes)
      error(<span class="hljs-string">'no (or more than one) schemas match'</span>)
      validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (node.multipleOf !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'number'</span> &amp;&amp; type !== <span class="hljs-string">'integer'</span>) validate(<span class="hljs-string">'if (%s) {'</span>, types.number(name))

      validate(<span class="hljs-string">'if (!isMultipleOf(%s, %d)) {'</span>, name, node.multipleOf)

      error(<span class="hljs-string">'has a remainder'</span>)
      validate(<span class="hljs-string">'}'</span>)

      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'number'</span> &amp;&amp; type !== <span class="hljs-string">'integer'</span>) validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (node.maxProperties !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'object'</span>) validate(<span class="hljs-string">'if (%s) {'</span>, types.object(name))

      validate(<span class="hljs-string">'if (Object.keys(%s).length &gt; %d) {'</span>, name, node.maxProperties)
      error(<span class="hljs-string">'has more properties than allowed'</span>)
      validate(<span class="hljs-string">'}'</span>)

      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'object'</span>) validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (node.minProperties !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'object'</span>) validate(<span class="hljs-string">'if (%s) {'</span>, types.object(name))

      validate(<span class="hljs-string">'if (Object.keys(%s).length &lt; %d) {'</span>, name, node.minProperties)
      error(<span class="hljs-string">'has less properties than allowed'</span>)
      validate(<span class="hljs-string">'}'</span>)

      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'object'</span>) validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (node.maxItems !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'array'</span>) validate(<span class="hljs-string">'if (%s) {'</span>, types.array(name))

      validate(<span class="hljs-string">'if (%s.length &gt; %d) {'</span>, name, node.maxItems)
      error(<span class="hljs-string">'has more items than allowed'</span>)
      validate(<span class="hljs-string">'}'</span>)

      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'array'</span>) validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (node.minItems !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'array'</span>) validate(<span class="hljs-string">'if (%s) {'</span>, types.array(name))

      validate(<span class="hljs-string">'if (%s.length &lt; %d) {'</span>, name, node.minItems)
      error(<span class="hljs-string">'has less items than allowed'</span>)
      validate(<span class="hljs-string">'}'</span>)

      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'array'</span>) validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (node.maxLength !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'string'</span>) validate(<span class="hljs-string">'if (%s) {'</span>, types.string(name))

      validate(<span class="hljs-string">'if (%s.length &gt; %d) {'</span>, name, node.maxLength)
      error(<span class="hljs-string">'has longer length than allowed'</span>)
      validate(<span class="hljs-string">'}'</span>)

      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'string'</span>) validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (node.minLength !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'string'</span>) validate(<span class="hljs-string">'if (%s) {'</span>, types.string(name))

      validate(<span class="hljs-string">'if (%s.length &lt; %d) {'</span>, name, node.minLength)
      error(<span class="hljs-string">'has less length than allowed'</span>)
      validate(<span class="hljs-string">'}'</span>)

      <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'string'</span>) validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (node.minimum !== <span class="hljs-literal">undefined</span>) {
      validate(<span class="hljs-string">'if (%s %s %d) {'</span>, name, node.exclusiveMinimum ? <span class="hljs-string">'&lt;='</span> : <span class="hljs-string">'&lt;'</span>, node.minimum)
      error(<span class="hljs-string">'is less than minimum'</span>)
      validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (node.maximum !== <span class="hljs-literal">undefined</span>) {
      validate(<span class="hljs-string">'if (%s %s %d) {'</span>, name, node.exclusiveMaximum ? <span class="hljs-string">'&gt;='</span> : <span class="hljs-string">'&gt;'</span>, node.maximum)
      error(<span class="hljs-string">'is more than maximum'</span>)
      validate(<span class="hljs-string">'}'</span>)
    }

    <span class="hljs-keyword">if</span> (properties) {
      <span class="hljs-built_in">Object</span>.keys(properties).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(type) &amp;&amp; type.indexOf(<span class="hljs-string">'null'</span>) !== <span class="hljs-number">-1</span>) validate(<span class="hljs-string">'if (%s !== null) {'</span>, name)

        visit(genobj(name, p), properties[p], reporter, filter)

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(type) &amp;&amp; type.indexOf(<span class="hljs-string">'null'</span>) !== <span class="hljs-number">-1</span>) validate(<span class="hljs-string">'}'</span>)
      })
    }

    <span class="hljs-keyword">while</span> (indent--) validate(<span class="hljs-string">'}'</span>)
  }

  <span class="hljs-keyword">var</span> validate = genfun
    (<span class="hljs-string">'function validate(data) {'</span>)
      (<span class="hljs-string">'validate.errors = null'</span>)
      (<span class="hljs-string">'var errors = 0'</span>)

  visit(<span class="hljs-string">'data'</span>, schema, reporter, opts &amp;&amp; opts.filter)

  validate
      (<span class="hljs-string">'return errors === 0'</span>)
    (<span class="hljs-string">'}'</span>)

  validate = validate.toFunction(scope)
  validate.errors = <span class="hljs-literal">null</span>

  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.defineProperty) {
    <span class="hljs-built_in">Object</span>.defineProperty(validate, <span class="hljs-string">'error'</span>, {
      <span class="hljs-attr">get</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (!validate.errors) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
        <span class="hljs-keyword">return</span> validate.errors.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
          <span class="hljs-keyword">return</span> err.field + <span class="hljs-string">' '</span> + err.message;
        }).join(<span class="hljs-string">'\n'</span>)
      }
    })
  }

  validate.toJSON = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> schema
  }

  <span class="hljs-keyword">return</span> validate
}

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">schema, opts</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema === <span class="hljs-string">'string'</span>) schema = <span class="hljs-built_in">JSON</span>.parse(schema)
  <span class="hljs-keyword">return</span> compile(schema, {}, schema, <span class="hljs-literal">true</span>, opts)
}

<span class="hljs-built_in">module</span>.exports.filter = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">schema, opts</span>) </span>{
  <span class="hljs-keyword">var</span> validate = <span class="hljs-built_in">module</span>.exports(schema, xtend(opts, {<span class="hljs-attr">filter</span>: <span class="hljs-literal">true</span>}))
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sch</span>) </span>{
    validate(sch)
    <span class="hljs-keyword">return</span> sch
  }
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

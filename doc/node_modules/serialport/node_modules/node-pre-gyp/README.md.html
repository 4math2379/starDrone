<!DOCTYPE html>
<html>
<head>
  <title>README.md</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../";
    var thisFile = "node_modules/serialport/node_modules/node-pre-gyp/README.md";
    var defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#node-pre-gyp">node-pre-gyp</a>
      </div>

      <div class="heading h4">
        <a href="#node-pre-gyp-makes-it-easy-to-publish-and-install-node.js-c++-addons-from-binaries">node-pre-gyp makes it easy to publish and install Node.js C++ addons from binaries</a>
      </div>

      <div class="heading h3">
        <a href="#features">Features</a>
      </div>

      <div class="heading h2">
        <a href="#credits">Credits</a>
      </div>

      <div class="heading h2">
        <a href="#faq">FAQ</a>
      </div>

      <div class="heading h2">
        <a href="#depends">Depends</a>
      </div>

      <div class="heading h2">
        <a href="#install">Install</a>
      </div>

      <div class="heading h2">
        <a href="#usage">Usage</a>
      </div>

      <div class="heading h3">
        <a href="#commands">Commands</a>
      </div>

      <div class="heading h3">
        <a href="#options">Options</a>
      </div>

      <div class="heading h3">
        <a href="#configuring">Configuring</a>
      </div>

      <div class="heading h4">
        <a href="#1-add-new-entries-to-your-package.json">1) Add new entries to your package.json</a>
      </div>

      <div class="heading h5">
        <a href="#the-binary-object-has-three-required-properties">The binary object has three required properties</a>
      </div>

      <div class="heading h6">
        <a href="#module_name">module_name</a>
      </div>

      <div class="heading h6">
        <a href="#module_path">module_path</a>
      </div>

      <div class="heading h6">
        <a href="#host">host</a>
      </div>

      <div class="heading h5">
        <a href="#the-binary-object-has-two-optional-properties">The binary object has two optional properties</a>
      </div>

      <div class="heading h6">
        <a href="#remote_path">remote_path</a>
      </div>

      <div class="heading h6">
        <a href="#package_name">package_name</a>
      </div>

      <div class="heading h4">
        <a href="#2-add-a-new-target-to-binding.gyp">2) Add a new target to binding.gyp</a>
      </div>

      <div class="heading h4">
        <a href="#3-dynamically-require-your.node">3) Dynamically require your .node</a>
      </div>

      <div class="heading h4">
        <a href="#4-build-and-package-your-app">4) Build and package your app</a>
      </div>

      <div class="heading h4">
        <a href="#5-test">5) Test</a>
      </div>

      <div class="heading h4">
        <a href="#6-publish-the-tarball">6) Publish the tarball</a>
      </div>

      <div class="heading h4">
        <a href="#7-automate-builds">7) Automate builds</a>
      </div>

      <div class="heading h4">
        <a href="#8-youre-done">8) You&#39;re done!</a>
      </div>

      <div class="heading h2">
        <a href="#s3-hosting">S3 Hosting</a>
      </div>

      <div class="heading h4">
        <a href="#1-create-an-s3-bucket">1) Create an S3 bucket</a>
      </div>

      <div class="heading h4">
        <a href="#2-install-node-pre-gyp">2) Install node-pre-gyp</a>
      </div>

      <div class="heading h4">
        <a href="#3-configure-aws-credentials">3) Configure AWS credentials</a>
      </div>

      <div class="heading h4">
        <a href="#4-package-and-publish-your-build">4) Package and publish your build</a>
      </div>

      <div class="heading h2">
        <a href="#appveyor-automation">Appveyor Automation</a>
      </div>

      <div class="heading h4">
        <a href="#1-create-a-free-appveyor-account">1) Create a free Appveyor account</a>
      </div>

      <div class="heading h4">
        <a href="#2-create-a-new-project">2) Create a new project</a>
      </div>

      <div class="heading h4">
        <a href="#3-add-appveyor.yml-and-push-it">3) Add appveyor.yml and push it</a>
      </div>

      <div class="heading h4">
        <a href="#4-create-secure-variables">4) Create secure variables</a>
      </div>

      <div class="heading h4">
        <a href="#5-hook-up-publishing">5) Hook up publishing</a>
      </div>

      <div class="heading h4">
        <a href="#6-publish-when-you-want">6) Publish when you want</a>
      </div>

      <div class="heading h2">
        <a href="#travis-automation">Travis Automation</a>
      </div>

      <div class="heading h4">
        <a href="#1-install-the-travis-gem">1) Install the Travis gem</a>
      </div>

      <div class="heading h4">
        <a href="#2-create-secure-variables">2) Create secure variables</a>
      </div>

      <div class="heading h4">
        <a href="#3-hook-up-publishing">3) Hook up publishing</a>
      </div>

      <div class="heading h5">
        <a href="#os-x-publishing">OS X publishing</a>
      </div>

      <div class="heading h5">
        <a href="#travis-os-x-gochas">Travis OS X Gochas</a>
      </div>

      <div class="heading h4">
        <a href="#4-publish-when-you-want">4) Publish when you want</a>
      </div>

      <div class="heading h1">
        <a href="#versioning">Versioning</a>
      </div>

      <div class="heading h1">
        <a href="#download-binary-files-from-a-mirror">Download binary files from a mirror</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="docs markdown"><div class="pilwrap" id="node-pre-gyp">
  <h1>
    <a href="#node-pre-gyp" name="node-pre-gyp" class="pilcrow"></a>
node-pre-gyp
  </h1>
</div>
<div class="pilwrap" id="node-pre-gyp-makes-it-easy-to-publish-and-install-node.js-c++-addons-from-binaries">
  <h4>
    <a href="#node-pre-gyp-makes-it-easy-to-publish-and-install-node.js-c++-addons-from-binaries" name="node-pre-gyp-makes-it-easy-to-publish-and-install-node.js-c++-addons-from-binaries" class="pilcrow"></a>
node-pre-gyp makes it easy to publish and install Node.js C++ addons from binaries
  </h4>
</div>
<p><a href="https://nodei.co/npm/node-pre-gyp/"><img src="https://nodei.co/npm/node-pre-gyp.png?downloads=true&amp;downloadRank=true" alt="NPM"></a></p>
<p><a href="https://travis-ci.org/mapbox/node-pre-gyp"><img src="https://api.travis-ci.org/mapbox/node-pre-gyp.svg" alt="Build Status"></a>
<a href="https://ci.appveyor.com/project/Mapbox/node-pre-gyp"><img src="https://ci.appveyor.com/api/projects/status/3nxewb425y83c0gv" alt="Build status"></a>
<a href="https://david-dm.org/mapbox/node-pre-gyp"><img src="https://david-dm.org/mapbox/node-pre-gyp.svg" alt="Dependencies"></a></p>
<p><code>node-pre-gyp</code> stands between <a href="https://github.com/npm/npm">npm</a> and <a href="https://github.com/Tootallnate/node-gyp">node-gyp</a> and offers a cross-platform method of binary deployment.</p>
<div class="pilwrap" id="features">
  <h3>
    <a href="#features" name="features" class="pilcrow"></a>
Features
  </h3>
</div>
<ul>
<li>A command line tool called <code>node-pre-gyp</code> that can install your package's C++ module from a binary.</li>
<li>A variety of developer targeted commands for packaging, testing, and publishing binaries.</li>
<li>A Javascript module that can dynamically require your installed binary: <code>require('node-pre-gyp').find</code></li>
</ul>
<p>For a hello world example of a module packaged with <code>node-pre-gyp</code> see <a href="https://github.com/springmeyer/node-addon-example">https://github.com/springmeyer/node-addon-example</a> and <a href="https://github.com/mapbox/node-pre-gyp/wiki/Modules-using-node-pre-gyp">the wiki </a> for real world examples.</p>
<div class="pilwrap" id="credits">
  <h2>
    <a href="#credits" name="credits" class="pilcrow"></a>
Credits
  </h2>
</div>
<ul>
<li>The module is modeled after <a href="https://github.com/Tootallnate/node-gyp">node-gyp</a> by <a href="https://github.com/Tootallnate">@Tootallnate</a></li>
<li>Motivation for initial development came from <a href="https://github.com/ErisDS">@ErisDS</a> and the <a href="https://github.com/TryGhost/Ghost">Ghost Project</a>.</li>
<li>Development is sponsored by <a href="https://www.mapbox.com/">Mapbox</a></li>
</ul>
<div class="pilwrap" id="faq">
  <h2>
    <a href="#faq" name="faq" class="pilcrow"></a>
FAQ
  </h2>
</div>
<p>See the <a href="https://github.com/mapbox/node-pre-gyp/wiki/FAQ">Frequently Ask Questions</a>.</p>
<div class="pilwrap" id="depends">
  <h2>
    <a href="#depends" name="depends" class="pilcrow"></a>
Depends
  </h2>
</div>
<ul>
<li>Node.js 0.12.x -&gt; 0.8.x</li>
</ul>
<div class="pilwrap" id="install">
  <h2>
    <a href="#install" name="install" class="pilcrow"></a>
Install
  </h2>
</div>
<p><code>node-pre-gyp</code> is designed to be installed as a local dependency of your Node.js C++ addon and accessed like:</p>
<pre><code>./node_modules/.bin/node-pre-gyp --help
</code></pre>
<p>But you can also install it globally:</p>
<pre><code>npm install node-pre-gyp -g
</code></pre>
<div class="pilwrap" id="usage">
  <h2>
    <a href="#usage" name="usage" class="pilcrow"></a>
Usage
  </h2>
</div>
<div class="pilwrap" id="commands">
  <h3>
    <a href="#commands" name="commands" class="pilcrow"></a>
Commands
  </h3>
</div>
<p>View all possible commands:</p>
<pre><code>node-pre-gyp --help
</code></pre>
<ul>
<li>clean - Remove the entire folder containing the compiled .node module</li>
<li>install - Install pre-built binary for module</li>
<li>reinstall - Run &quot;clean&quot; and &quot;install&quot; at once</li>
<li>build - Compile the module by dispatching to node-gyp or nw-gyp</li>
<li>rebuild - Run &quot;clean&quot; and &quot;build&quot; at once</li>
<li>package - Pack binary into tarball</li>
<li>testpackage - Test that the staged package is valid</li>
<li>publish - Publish pre-built binary</li>
<li>unpublish - Unpublish pre-built binary</li>
<li>info - Fetch info on published binaries</li>
</ul>
<p>You can also chain commands:</p>
<pre><code>node-pre-gyp clean build unpublish publish info
</code></pre>
<div class="pilwrap" id="options">
  <h3>
    <a href="#options" name="options" class="pilcrow"></a>
Options
  </h3>
</div>
<p>Options include:</p>
<ul>
<li><code>-C/--directory</code>: run the command in this directory</li>
<li><code>--build-from-source</code>: build from source instead of using pre-built binary</li>
<li><code>--update-binary</code>: reinstall by replacing previously installed local binary with remote binary</li>
<li><code>--runtime=node-webkit</code>: customize the runtime: <code>node</code>, <code>electron</code> and <code>node-webkit</code> are the valid options</li>
<li><code>--fallback-to-build</code>: fallback to building from source if pre-built binary is not available</li>
<li><code>--target=0.10.25</code>: Pass the target node or node-webkit version to compile against</li>
<li><code>--target_arch=ia32</code>: Pass the target arch and override the host <code>arch</code>. Valid values are 'ia32','x64', or <code>arm</code>.</li>
<li><code>--target_platform=win32</code>: Pass the target platform and override the host <code>platform</code>. Valid values are <code>linux</code>, <code>darwin</code>, <code>win32</code>, <code>sunos</code>, <code>freebsd</code>, <code>openbsd</code>, and <code>aix</code>.</li>
</ul>
<p>Both <code>--build-from-source</code> and <code>--fallback-to-build</code> can be passed alone or they can provide values. You can pass <code>--fallback-to-build=false</code> to override the option as declared in package.json. In addition to being able to pass <code>--build-from-source</code> you can also pass <code>--build-from-source=myapp</code> where <code>myapp</code> is the name of your module.</p>
<p>For example: <code>npm install --build-from-source=myapp</code>. This is useful if:</p>
<ul>
<li><code>myapp</code> is referenced in the package.json of a larger app and therefore <code>myapp</code> is being installed as a dependent with <code>npm install</code>.</li>
<li>The larger app also depends on other modules installed with <code>node-pre-gyp</code></li>
<li>You only want to trigger a source compile for <code>myapp</code> and the other modules.</li>
</ul>
<div class="pilwrap" id="configuring">
  <h3>
    <a href="#configuring" name="configuring" class="pilcrow"></a>
Configuring
  </h3>
</div>
<p>This is a guide to configuring your module to use node-pre-gyp.</p>
<div class="pilwrap" id="1-add-new-entries-to-your-package.json">
  <h4>
    <a href="#1-add-new-entries-to-your-package.json" name="1-add-new-entries-to-your-package.json" class="pilcrow"></a>
1) Add new entries to your <code>package.json</code>
  </h4>
</div>
<ul>
<li>Add <code>node-pre-gyp</code> to <code>dependencies</code></li>
<li>Add <code>aws-sdk</code> as a <code>devDependency</code></li>
<li>Add a custom <code>install</code> script</li>
<li>Declare a <code>binary</code> object</li>
</ul>
<p>This looks like:</p>
<pre><code class="js">    <span class="hljs-string">"dependencies"</span>  : {
      <span class="hljs-string">"node-pre-gyp"</span>: <span class="hljs-string">"0.6.x"</span>
    },
    <span class="hljs-string">"devDependencies"</span>: {
      <span class="hljs-string">"aws-sdk"</span>: <span class="hljs-string">"2.x"</span>
    }
    <span class="hljs-string">"scripts"</span>: {
        <span class="hljs-string">"preinstall"</span>: <span class="hljs-string">"npm install node-pre-gyp"</span>,
        <span class="hljs-string">"install"</span>: <span class="hljs-string">"node-pre-gyp install --fallback-to-build"</span>
    },
    <span class="hljs-string">"binary"</span>: {
        <span class="hljs-string">"module_name"</span>: <span class="hljs-string">"your_module"</span>,
        <span class="hljs-string">"module_path"</span>: <span class="hljs-string">"./lib/binding/"</span>,
        <span class="hljs-string">"host"</span>: <span class="hljs-string">"https://your_module.s3-us-west-1.amazonaws.com"</span>
    }
</code></pre>
<p>For a full example see <a href="https://github.com/springmeyer/node-addon-example/blob/master/package.json">node-addon-examples's package.json</a>.</p>
<div class="pilwrap" id="the-binary-object-has-three-required-properties">
  <h5>
    <a href="#the-binary-object-has-three-required-properties" name="the-binary-object-has-three-required-properties" class="pilcrow"></a>
The <code>binary</code> object has three required properties
  </h5>
</div>
<div class="pilwrap" id="module_name">
  <h6>
    <a href="#module_name" name="module_name" class="pilcrow"></a>
module_name
  </h6>
</div>
<p>The name of your native node module. This value must:</p>
<ul>
<li>Match the name passed to <a href="http://nodejs.org/api/addons.html#addons_hello_world">the NODE_MODULE macro</a></li>
<li>Must be a valid C variable name (e.g. it cannot contain <code>-</code>)</li>
<li>Should not include the <code>.node</code> extension.</li>
</ul>
<div class="pilwrap" id="module_path">
  <h6>
    <a href="#module_path" name="module_path" class="pilcrow"></a>
module_path
  </h6>
</div>
<p>The location your native module is placed after a build. This should be an empty directory without other Javascript files. This entire directory will be packaged in the binary tarball. When installing from a remote package this directory will be overwritten with the contents of the tarball.</p>
<p>Note: This property supports variables based on <a href="#versioning.html">Versioning</a>.</p>
<div class="pilwrap" id="host">
  <h6>
    <a href="#host" name="host" class="pilcrow"></a>
host
  </h6>
</div>
<p>A url to the remote location where you've published tarball binaries (must be <code>https</code> not <code>http</code>).</p>
<p>It is highly recommended that you use Amazon S3. The reasons are:</p>
<ul>
<li>Various node-pre-gyp commands like <code>publish</code> and <code>info</code> only work with an S3 host.</li>
<li>S3 is a very solid hosting platform for distributing large files.</li>
<li>We provide detail documentation for using <a href="#s3-hosting.html">S3 hosting</a> with node-pre-gyp.</li>
</ul>
<p>Why then not require S3? Because while some applications using node-pre-gyp need to distribute binaries as large as 20-30 MB, others might have very small binaries and might wish to store them in a github repo. This is not recommended, but if an author really wants to host in a non-s3 location then it should be possible.</p>
<div class="pilwrap" id="the-binary-object-has-two-optional-properties">
  <h5>
    <a href="#the-binary-object-has-two-optional-properties" name="the-binary-object-has-two-optional-properties" class="pilcrow"></a>
The <code>binary</code> object has two optional properties
  </h5>
</div>
<div class="pilwrap" id="remote_path">
  <h6>
    <a href="#remote_path" name="remote_path" class="pilcrow"></a>
remote_path
  </h6>
</div>
<p>It <strong>is recommended</strong> that you customize this property. This is an extra path to use for publishing and finding remote tarballs. The default value for <code>remote_path</code> is <code>&quot;&quot;</code> meaning that if you do not provide it then all packages will be published at the base of the <code>host</code>. It is recommended to provide a value like <code>./{name}/v{version}</code> to help organize remote packages in the case that you choose to publish multiple node addons to the same <code>host</code>.</p>
<p>Note: This property supports variables based on <a href="#versioning.html">Versioning</a>.</p>
<div class="pilwrap" id="package_name">
  <h6>
    <a href="#package_name" name="package_name" class="pilcrow"></a>
package_name
  </h6>
</div>
<p>It is <strong>not recommended</strong> to override this property unless you are also overriding the <code>remote_path</code>. This is the versioned name of the remote tarball containing the binary <code>.node</code> module and any supporting files you've placed inside the <code>module_path</code> directory. Unless you specify <code>package_name</code> in your <code>package.json</code> then it defaults to <code>{module_name}-v{version}-{node_abi}-{platform}-{arch}.tar.gz</code> which allows your binary to work across node versions, platforms, and architectures. If you are using <code>remote_path</code> that is also versioned by <code>./{module_name}/v{version}</code> then you could remove these variables from the <code>package_name</code> and just use: <code>{node_abi}-{platform}-{arch}.tar.gz</code>. Then your remote tarball will be looked up at, for example, <code>https://example.com/your-module/v0.1.0/node-v11-linux-x64.tar.gz</code>.</p>
<p>Avoiding the version of your module in the <code>package_name</code> and instead only embedding in a directory name can be useful when you want to make a quick tag of your module that does not change any C++ code. In this case you can just copy binaries to the new version behind the scenes like:</p>
<pre><code class="sh">aws s3 sync --acl public-read s3://mapbox-node-binary/sqlite3/v3.0.3/ s3://mapbox-node-binary/sqlite3/v3.0.4/
</code></pre>
<p>Note: This property supports variables based on <a href="#versioning.html">Versioning</a>.</p>
<div class="pilwrap" id="2-add-a-new-target-to-binding.gyp">
  <h4>
    <a href="#2-add-a-new-target-to-binding.gyp" name="2-add-a-new-target-to-binding.gyp" class="pilcrow"></a>
2) Add a new target to binding.gyp
  </h4>
</div>
<p><code>node-pre-gyp</code> calls out to <code>node-gyp</code> to compile the module and passes variables along like <a href="#module_name.html">module_name</a> and <a href="#module_path.html">module_path</a>.</p>
<p>A new target must be added to <code>binding.gyp</code> that moves the compiled <code>.node</code> module from <code>./build/Release/module_name.node</code> into the directory specified by <code>module_path</code>.</p>
<p>Add a target like this at the end of your <code>targets</code> list:</p>
<pre><code class="js">    {
      <span class="hljs-string">"target_name"</span>: <span class="hljs-string">"action_after_build"</span>,
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"none"</span>,
      <span class="hljs-string">"dependencies"</span>: [ <span class="hljs-string">"&lt;(module_name)"</span> ],
      <span class="hljs-string">"copies"</span>: [
        {
          <span class="hljs-string">"files"</span>: [ <span class="hljs-string">"&lt;(PRODUCT_DIR)/&lt;(module_name).node"</span> ],
          <span class="hljs-string">"destination"</span>: <span class="hljs-string">"&lt;(module_path)"</span>
        }
      ]
    }
</code></pre>
<p>For a full example see <a href="https://github.com/springmeyer/node-addon-example/blob/2ff60a8ded7f042864ad21db00c3a5a06cf47075/binding.gyp">node-addon-example's binding.gyp</a>.</p>
<div class="pilwrap" id="3-dynamically-require-your.node">
  <h4>
    <a href="#3-dynamically-require-your.node" name="3-dynamically-require-your.node" class="pilcrow"></a>
3) Dynamically require your <code>.node</code>
  </h4>
</div>
<p>Inside the main js file that requires your addon module you are likely currently doing:</p>
<pre><code class="js"><span class="hljs-keyword">var</span> binding = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../build/Release/binding.node'</span>);
</code></pre>
<p>or:</p>
<pre><code class="js"><span class="hljs-keyword">var</span> bindings = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./bindings'</span>)
</code></pre>
<p>Change those lines to:</p>
<pre><code class="js"><span class="hljs-keyword">var</span> binary = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node-pre-gyp'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> binding_path = binary.find(path.resolve(path.join(__dirname,<span class="hljs-string">'./package.json'</span>)));
<span class="hljs-keyword">var</span> binding = <span class="hljs-built_in">require</span>(binding_path);
</code></pre>
<p>For a full example see <a href="https://github.com/springmeyer/node-addon-example/blob/2ff60a8ded7f042864ad21db00c3a5a06cf47075/index.js#L1-L4">node-addon-example's index.js</a></p>
<div class="pilwrap" id="4-build-and-package-your-app">
  <h4>
    <a href="#4-build-and-package-your-app" name="4-build-and-package-your-app" class="pilcrow"></a>
4) Build and package your app
  </h4>
</div>
<p>Now build your module from source:</p>
<pre><code>npm install --build-from-source
</code></pre>
<p>The <code>--build-from-source</code> tells <code>node-pre-gyp</code> to not look for a remote package and instead dispatch to node-gyp to build.</p>
<p>Now <code>node-pre-gyp</code> should now also be installed as a local dependency so the command line tool it offers can be found at <code>./node_modules/.bin/node-pre-gyp</code>.</p>
<div class="pilwrap" id="5-test">
  <h4>
    <a href="#5-test" name="5-test" class="pilcrow"></a>
5) Test
  </h4>
</div>
<p>Now <code>npm test</code> should work just as it did before.</p>
<div class="pilwrap" id="6-publish-the-tarball">
  <h4>
    <a href="#6-publish-the-tarball" name="6-publish-the-tarball" class="pilcrow"></a>
6) Publish the tarball
  </h4>
</div>
<p>Then package your app:</p>
<pre><code>./node_modules/.bin/node-pre-gyp package
</code></pre>
<p>Once packaged, now you can publish:</p>
<pre><code>./node_modules/.bin/node-pre-gyp publish
</code></pre>
<p>Currently the <code>publish</code> command pushes your binary to S3. This requires:</p>
<ul>
<li>You have installed <code>aws-sdk</code> with <code>npm install aws-sdk</code></li>
<li>You have created a bucket already.</li>
<li>The <code>host</code> points to an S3 http or https endpoint.</li>
<li>You have configured node-pre-gyp to read your S3 credentials (see <a href="#s3-hosting.html">S3 hosting</a> for details).</li>
</ul>
<p>You can also host your binaries elsewhere. To do this requires:</p>
<ul>
<li>You manually publish the binary created by the <code>package</code> command to an <code>https</code> endpoint</li>
<li>Ensure that the <code>host</code> value points to your custom <code>https</code> endpoint.</li>
</ul>
<div class="pilwrap" id="7-automate-builds">
  <h4>
    <a href="#7-automate-builds" name="7-automate-builds" class="pilcrow"></a>
7) Automate builds
  </h4>
</div>
<p>Now you need to publish builds for all the platforms and node versions you wish to support. This is best automated.</p>
<ul>
<li>See <a href="#appveyor-automation.html">Appveyor Automation</a> for how to auto-publish builds on Windows.</li>
<li>See <a href="#travis-automation.html">Travis Automation</a> for how to auto-publish builds on OS X and Linux.</li>
</ul>
<div class="pilwrap" id="8-youre-done">
  <h4>
    <a href="#8-youre-done" name="8-youre-done" class="pilcrow"></a>
8) You're done!
  </h4>
</div>
<p>Now publish your module to the npm registry. Users will now be able to install your module from a binary.</p>
<p>What will happen is this:</p>
<ol>
<li><code>npm install &lt;your package&gt;</code> will pull from the npm registry</li>
<li>npm will run the <code>install</code> script which will call out to <code>node-pre-gyp</code></li>
<li><code>node-pre-gyp</code> will fetch the binary <code>.node</code> module and unpack in the right place</li>
<li>Assuming that all worked, you are done</li>
</ol>
<p>If a a binary was not available for a given platform and <code>--fallback-to-build</code> was used then <code>node-gyp rebuild</code> will be called to try to source compile the module.</p>
<div class="pilwrap" id="s3-hosting">
  <h2>
    <a href="#s3-hosting" name="s3-hosting" class="pilcrow"></a>
S3 Hosting
  </h2>
</div>
<p>You can host wherever you choose but S3 is cheap, <code>node-pre-gyp publish</code> expects it, and S3 can be integrated well with <a href="http://travis-ci.org">Travis.ci</a> to automate builds for OS X and Ubuntu, and with <a href="http://appveyor.com">Appveyor</a> to automate builds for Windows. Here is an approach to do this:</p>
<p>First, get setup locally and test the workflow:</p>
<div class="pilwrap" id="1-create-an-s3-bucket">
  <h4>
    <a href="#1-create-an-s3-bucket" name="1-create-an-s3-bucket" class="pilcrow"></a>
1) Create an S3 bucket
  </h4>
</div>
<p>And have your <strong>key</strong> and <strong>secret key</strong> ready for writing to the bucket.</p>
<p>It is recommended to create a IAM user with a policy that only gives permissions to the specific bucket you plan to publish to. This can be done in the <a href="https://console.aws.amazon.com/iam/">IAM console</a> by: 1) adding a new user, 2) choosing <code>Attach User Policy</code>, 3) Using the <code>Policy Generator</code>, 4) selecting <code>Amazon S3</code> for the service, 5) adding the actions: <code>DeleteObject</code>, <code>GetObject</code>, <code>GetObjectAcl</code>, <code>ListBucket</code>, <code>PutObject</code>, <code>PutObjectAcl</code>, 6) adding an ARN of <code>arn:aws:s3:::bucket/*</code> (replacing <code>bucket</code> with your bucket name), and finally 7) clicking <code>Add Statement</code> and saving the policy. It should generate a policy like:</p>
<pre><code class="js">{
  <span class="hljs-string">"Version"</span>: <span class="hljs-string">"2012-10-17"</span>,
  <span class="hljs-string">"Statement"</span>: [
    {
      <span class="hljs-string">"Sid"</span>: <span class="hljs-string">"Stmt1394587197000"</span>,
      <span class="hljs-string">"Effect"</span>: <span class="hljs-string">"Allow"</span>,
      <span class="hljs-string">"Action"</span>: [
        <span class="hljs-string">"s3:DeleteObject"</span>,
        <span class="hljs-string">"s3:GetObject"</span>,
        <span class="hljs-string">"s3:GetObjectAcl"</span>,
        <span class="hljs-string">"s3:ListBucket"</span>,
        <span class="hljs-string">"s3:PutObject"</span>,
        <span class="hljs-string">"s3:PutObjectAcl"</span>
      ],
      <span class="hljs-string">"Resource"</span>: [
        <span class="hljs-string">"arn:aws:s3:::node-pre-gyp-tests/*"</span>
      ]
    }
  ]
}
</code></pre>
<div class="pilwrap" id="2-install-node-pre-gyp">
  <h4>
    <a href="#2-install-node-pre-gyp" name="2-install-node-pre-gyp" class="pilcrow"></a>
2) Install node-pre-gyp
  </h4>
</div>
<p>Either install it globally:</p>
<pre><code>npm install node-pre-gyp -g
</code></pre>
<p>Or put the local version on your PATH</p>
<pre><code>export PATH=`pwd`/node_modules/.bin/:$PATH
</code></pre>
<div class="pilwrap" id="3-configure-aws-credentials">
  <h4>
    <a href="#3-configure-aws-credentials" name="3-configure-aws-credentials" class="pilcrow"></a>
3) Configure AWS credentials
  </h4>
</div>
<p>There are several ways to do this.</p>
<p>You can use any of the methods described at http://docs.aws.amazon.com/AWSJavaScriptSDK/guide/node-configuring.html.</p>
<p>Or you can create a <code>~/.node_pre_gyprc</code></p>
<p>Or pass options in any way supported by <a href="https://github.com/dominictarr/rc#standards">RC</a></p>
<p>A <code>~/.node_pre_gyprc</code> looks like:</p>
<pre><code class="js">{
    <span class="hljs-string">"accessKeyId"</span>: <span class="hljs-string">"xxx"</span>,
    <span class="hljs-string">"secretAccessKey"</span>: <span class="hljs-string">"xxx"</span>
}
</code></pre>
<p>Another way is to use your environment:</p>
<pre><code>export node_pre_gyp_accessKeyId=xxx
export node_pre_gyp_secretAccessKey=xxx
</code></pre>
<p>You may also need to specify the <code>region</code> if it is not explicit in the <code>host</code> value you use. The <code>bucket</code> can also be specified but it is optional because <code>node-pre-gyp</code> will detect it from the <code>host</code> value.</p>
<div class="pilwrap" id="4-package-and-publish-your-build">
  <h4>
    <a href="#4-package-and-publish-your-build" name="4-package-and-publish-your-build" class="pilcrow"></a>
4) Package and publish your build
  </h4>
</div>
<p>Install the <code>aws-sdk</code>:</p>
<pre><code>npm install aws-sdk
</code></pre>
<p>Then publish:</p>
<pre><code>node-pre-gyp package publish
</code></pre>
<p>Note: if you hit an error like <code>Hostname/IP doesn't match certificate's altnames</code> it may mean that you need to provide the <code>region</code> option in your config.</p>
<div class="pilwrap" id="appveyor-automation">
  <h2>
    <a href="#appveyor-automation" name="appveyor-automation" class="pilcrow"></a>
Appveyor Automation
  </h2>
</div>
<p><a href="http://www.appveyor.com/">Appveyor</a> can build binaries and publish the results per commit and supports:</p>
<ul>
<li>Windows Visual Studio 2013 and related compilers</li>
<li>Both 64 bit (x64) and 32 bit (x86) build configurations</li>
<li>Multiple Node.js versions</li>
</ul>
<p>For an example of doing this see <a href="https://github.com/mapbox/node-sqlite3/blob/master/appveyor.yml">node-sqlite3's appveyor.yml</a>.</p>
<p>Below is a guide to getting set up:</p>
<div class="pilwrap" id="1-create-a-free-appveyor-account">
  <h4>
    <a href="#1-create-a-free-appveyor-account" name="1-create-a-free-appveyor-account" class="pilcrow"></a>
1) Create a free Appveyor account
  </h4>
</div>
<p>Go to https://ci.appveyor.com/signup/free and sign in with your github account.</p>
<div class="pilwrap" id="2-create-a-new-project">
  <h4>
    <a href="#2-create-a-new-project" name="2-create-a-new-project" class="pilcrow"></a>
2) Create a new project
  </h4>
</div>
<p>Go to https://ci.appveyor.com/projects/new and select the github repo for your module</p>
<div class="pilwrap" id="3-add-appveyor.yml-and-push-it">
  <h4>
    <a href="#3-add-appveyor.yml-and-push-it" name="3-add-appveyor.yml-and-push-it" class="pilcrow"></a>
3) Add appveyor.yml and push it
  </h4>
</div>
<p>Once you have committed an <code>appveyor.yml</code> (<a href="http://www.appveyor.com/docs/appveyor-yml">appveyor.yml reference</a>) to your github repo and pushed it appveyor should automatically start building your project.</p>
<div class="pilwrap" id="4-create-secure-variables">
  <h4>
    <a href="#4-create-secure-variables" name="4-create-secure-variables" class="pilcrow"></a>
4) Create secure variables
  </h4>
</div>
<p>Encrypt your S3 AWS keys by going to <a href="https://ci.appveyor.com/tools/encrypt">https://ci.appveyor.com/tools/encrypt</a> and hitting the <code>encrypt</code> button.</p>
<p>Then paste the result into your <code>appveyor.yml</code></p>
<pre><code class="yml"><span class="hljs-attr">environment:</span>
<span class="hljs-attr">  node_pre_gyp_accessKeyId:</span>
<span class="hljs-attr">    secure:</span> Dn9HKdLNYvDgPdQOzRq/DqZ/MPhjknRHB1o+/lVU8MA=
<span class="hljs-attr">  node_pre_gyp_secretAccessKey:</span>
<span class="hljs-attr">    secure:</span> W1rwNoSnOku1r+<span class="hljs-number">28</span>gnoufO8UA8iWADmL1LiiwH9IOkIVhDTNGdGPJqAlLjNqwLnL
</code></pre>
<p>NOTE: keys are per account but not per repo (this is difference than Travis where keys are per repo but not related to the account used to encrypt them).</p>
<div class="pilwrap" id="5-hook-up-publishing">
  <h4>
    <a href="#5-hook-up-publishing" name="5-hook-up-publishing" class="pilcrow"></a>
5) Hook up publishing
  </h4>
</div>
<p>Just put <code>node-pre-gyp package publish</code> in your <code>appveyor.yml</code> after <code>npm install</code>.</p>
<div class="pilwrap" id="6-publish-when-you-want">
  <h4>
    <a href="#6-publish-when-you-want" name="6-publish-when-you-want" class="pilcrow"></a>
6) Publish when you want
  </h4>
</div>
<p>You might wish to publish binaries only on a specific commit. To do this you could borrow from the <a href="http://about.travis-ci.org/docs/user/how-to-skip-a-build/">Travis.ci idea of commit keywords</a> and add special handling for commit messages with <code>[publish binary]</code>:</p>
<pre><code>SET CM=%APPVEYOR_REPO_COMMIT_MESSAGE%
if not &quot;%CM%&quot; == &quot;%CM:[publish binary]=%&quot; node-pre-gyp --msvs_version=2013 publish
</code></pre>
<p>If your commit message contains special characters (e.g. <code>&amp;</code>) this method might fail. An alternative is to use PowerShell, which gives you additional possibilities, like ignoring case by using <code>ToLower()</code>:</p>
<pre><code>ps: if($env:APPVEYOR_REPO_COMMIT_MESSAGE.ToLower().Contains('[publish binary]')) { node-pre-gyp --msvs_version=2013 publish }
</code></pre>
<p>Remember this publishing is not the same as <code>npm publish</code>. We're just talking about the binary module here and not your entire npm package.</p>
<div class="pilwrap" id="travis-automation">
  <h2>
    <a href="#travis-automation" name="travis-automation" class="pilcrow"></a>
Travis Automation
  </h2>
</div>
<p><a href="https://travis-ci.org/">Travis</a> can push to S3 after a successful build and supports both:</p>
<ul>
<li>Ubuntu Precise and OS X (64 bit)</li>
<li>Multiple Node.js versions</li>
</ul>
<p>For an example of doing this see <a href="https://github.com/springmeyer/node-addon-example/blob/2ff60a8ded7f042864ad21db00c3a5a06cf47075/.travis.yml">node-add-example's .travis.yml</a>.</p>
<p>Note: if you need 32 bit binaries, this can be done from a 64 bit Travis machine. See <a href="https://github.com/mapbox/node-sqlite3/blob/bae122aa6a2b8a45f6b717fab24e207740e32b5d/scripts/build_against_node.sh#L54-L74">the node-sqlite3 scripts for an example of doing this</a>.</p>
<p>Below is a guide to getting set up:</p>
<div class="pilwrap" id="1-install-the-travis-gem">
  <h4>
    <a href="#1-install-the-travis-gem" name="1-install-the-travis-gem" class="pilcrow"></a>
1) Install the Travis gem
  </h4>
</div>
<pre><code>gem install travis
</code></pre>
<div class="pilwrap" id="2-create-secure-variables">
  <h4>
    <a href="#2-create-secure-variables" name="2-create-secure-variables" class="pilcrow"></a>
2) Create secure variables
  </h4>
</div>
<p>Make sure you run this command from within the directory of your module.</p>
<p>Use <code>travis-encrypt</code> like:</p>
<pre><code>travis encrypt node_pre_gyp_accessKeyId=${node_pre_gyp_accessKeyId}
travis encrypt node_pre_gyp_secretAccessKey=${node_pre_gyp_secretAccessKey}
</code></pre>
<p>Then put those values in your <code>.travis.yml</code> like:</p>
<pre><code class="yaml"><span class="hljs-attr">env:</span>
<span class="hljs-attr">  global:</span>
<span class="hljs-attr">    - secure:</span> F+sEL/v56CzHqmCSSES4pEyC9NeQlkoR0Gs/ZuZxX1ytrj8SKtp3MKqBj7zhIclSdXBz4Ev966Da5ctmcTd410p0b240MV6BVOkLUtkjZJyErMBOkeb8n8yVfSoeMx8RiIhBmIvEn+rlQq+bSFis61/JkE9rxsjkGRZi14hHr4M=
<span class="hljs-attr">    - secure:</span> o2nkUQIiABD139XS6L8pxq3XO5gch27hvm/gOdV+dzNKc/s2KomVPWcOyXNxtJGhtecAkABzaW8KHDDi5QL1kNEFx6BxFVMLO8rjFPsMVaBG9Ks6JiDQkkmrGNcnVdxI/<span class="hljs-number">6</span>EKTLHTH5WLsz8+J7caDBzvKbEfTux5EamEhxIWgrI=
</code></pre>
<p>More details on Travis encryption at http://about.travis-ci.org/docs/user/encryption-keys/.</p>
<div class="pilwrap" id="3-hook-up-publishing">
  <h4>
    <a href="#3-hook-up-publishing" name="3-hook-up-publishing" class="pilcrow"></a>
3) Hook up publishing
  </h4>
</div>
<p>Just put <code>node-pre-gyp package publish</code> in your <code>.travis.yml</code> after <code>npm install</code>.</p>
<div class="pilwrap" id="os-x-publishing">
  <h5>
    <a href="#os-x-publishing" name="os-x-publishing" class="pilcrow"></a>
OS X publishing
  </h5>
</div>
<p>If you want binaries for OS X in addition to linux you can enable <a href="http://docs.travis-ci.com/user/multi-os/#Setting-.travis.yml">multi-os for travis</a></p>
<p>Use a configuration like:</p>
<pre><code class="yml">
<span class="hljs-attr">language:</span> cpp

<span class="hljs-attr">os:</span>
<span class="hljs-bullet">-</span> linux
<span class="hljs-bullet">-</span> osx

<span class="hljs-attr">env:</span>
<span class="hljs-attr">  matrix:</span>
<span class="hljs-bullet">    -</span> NODE_VERSION=<span class="hljs-string">"0.10"</span>
<span class="hljs-bullet">    -</span> NODE_VERSION=<span class="hljs-string">"0.11.14"</span>

<span class="hljs-attr">before_install:</span>
<span class="hljs-bullet">-</span> rm -rf ~/.nvm/ &amp;&amp; git clone --depth <span class="hljs-number">1</span> https://github.com/creationix/nvm.git ~/.nvm
<span class="hljs-bullet">-</span> source ~/.nvm/nvm.sh
<span class="hljs-bullet">-</span> nvm install $NODE_VERSION
<span class="hljs-bullet">-</span> nvm use $NODE_VERSION
</code></pre>
<p>See <a href="#travis-os-x-gochas.html">Travis OS X Gochas</a> for why we replace <code>language: node_js</code> and <code>node_js:</code> sections with <code>language: cpp</code> and a custom matrix.</p>
<p>Also create platform specific sections for any deps that need install. For example if you need libpng:</p>
<pre><code class="yml"><span class="hljs-bullet">-</span> if [ $(uname -s) == <span class="hljs-string">'Linux'</span> ]; then apt-get install libpng-dev; fi;
<span class="hljs-bullet">-</span> if [ $(uname -s) == <span class="hljs-string">'Darwin'</span> ]; then brew install libpng; fi;
</code></pre>
<p>For detailed multi-OS examples see <a href="https://github.com/mapnik/node-mapnik/blob/master/.travis.yml">node-mapnik</a> and <a href="https://github.com/mapbox/node-sqlite3/blob/master/.travis.yml">node-sqlite3</a>.</p>
<div class="pilwrap" id="travis-os-x-gochas">
  <h5>
    <a href="#travis-os-x-gochas" name="travis-os-x-gochas" class="pilcrow"></a>
Travis OS X Gochas
  </h5>
</div>
<p>First, unlike the Travis linux machines the OS X machines do not put <code>node-pre-gyp</code> on PATH by default. So to you will need to:</p>
<pre><code class="sh"><span class="hljs-built_in">export</span> PATH=$(<span class="hljs-built_in">pwd</span>)/node_modules/.bin:<span class="hljs-variable">${PATH}</span>
</code></pre>
<p>Second, the OS X machines doe not support using a matrix for installing node.js different versions. So you need to bootstrap the installation of node.js in a cross platform way.</p>
<p>By doing:</p>
<pre><code class="yml"><span class="hljs-attr">env:</span>
<span class="hljs-attr">  matrix:</span>
<span class="hljs-bullet">    -</span> NODE_VERSION=<span class="hljs-string">"0.10"</span>
<span class="hljs-bullet">    -</span> NODE_VERSION=<span class="hljs-string">"0.11.14"</span>

<span class="hljs-attr">before_install:</span>
<span class="hljs-bullet"> -</span> rm -rf ~/.nvm/ &amp;&amp; git clone --depth <span class="hljs-number">1</span> https://github.com/creationix/nvm.git ~/.nvm
<span class="hljs-bullet"> -</span> source ~/.nvm/nvm.sh
<span class="hljs-bullet"> -</span> nvm install $NODE_VERSION
<span class="hljs-bullet"> -</span> nvm use $NODE_VERSION
</code></pre>
<p>You can easily recreate the previous behavior of this matrix:</p>
<pre><code class="yml"><span class="hljs-attr">node_js:</span>
<span class="hljs-bullet">  -</span> <span class="hljs-string">"0.10"</span>
<span class="hljs-bullet">  -</span> <span class="hljs-string">"0.11.14"</span>
</code></pre>
<div class="pilwrap" id="4-publish-when-you-want">
  <h4>
    <a href="#4-publish-when-you-want" name="4-publish-when-you-want" class="pilcrow"></a>
4) Publish when you want
  </h4>
</div>
<p>You might wish to publish binaries only on a specific commit. To do this you could borrow from the <a href="http://about.travis-ci.org/docs/user/how-to-skip-a-build/">Travis.ci idea of commit keywords</a> and add special handling for commit messages with <code>[publish binary]</code>:</p>
<pre><code>COMMIT_MESSAGE=$(git log --format=%B --no-merges -n 1 | tr -d '\n')
if [[ ${COMMIT_MESSAGE} =~ &quot;[publish binary]&quot; ]]; then node-pre-gyp publish; fi;
</code></pre>
<p>Then you can trigger new binaries to be built like:</p>
<pre><code>git commit -a -m &quot;[publish binary]&quot;
</code></pre>
<p>Or, if you don't have any changes to make simply run:</p>
<pre><code>git commit --allow-empty -m &quot;[publish binary]&quot;
</code></pre>
<p>WARNING: if you are working in a pull request and publishing binaries from there then you will want to avoid double publishing when Travis.ci builds both the <code>push</code> and <code>pr</code>. You only want to run the publish on the <code>push</code> commit. See https://github.com/Project-OSRM/node-osrm/blob/8eb837abe2e2e30e595093d16e5354bc5c573575/scripts/is_pr_merge.sh which is called from https://github.com/Project-OSRM/node-osrm/blob/8eb837abe2e2e30e595093d16e5354bc5c573575/scripts/publish.sh for an example of how to do this.</p>
<p>Remember this publishing is not the same as <code>npm publish</code>. We're just talking about the binary module here and not your entire npm package. To automate the publishing of your entire package to npm on Travis see http://about.travis-ci.org/docs/user/deployment/npm/</p>
<div class="pilwrap" id="versioning">
  <h1>
    <a href="#versioning" name="versioning" class="pilcrow"></a>
Versioning
  </h1>
</div>
<p>The <code>binary</code> properties of <code>module_path</code>, <code>remote_path</code>, and <code>package_name</code> support variable substitution. The strings are evaluated by <code>node-pre-gyp</code> depending on your system and any custom build flags you passed.</p>
<ul>
<li><code>node_abi</code>: The node C++ <code>ABI</code> number. This value is available in Javascript as <code>process.versions.modules</code> as of <a href="https://github.com/joyent/node/commit/ccabd4a6fa8a6eb79d29bc3bbe9fe2b6531c2d8e"><code>&gt;= v0.10.4 &gt;= v0.11.7</code></a> and in C++ as the <code>NODE_MODULE_VERSION</code> define much earlier. For versions of Node before this was available we fallback to the V8 major and minor version.</li>
<li><code>platform</code> matches node's <code>process.platform</code> like <code>linux</code>, <code>darwin</code>, and <code>win32</code> unless the user passed the <code>--target_platform</code> option to override.</li>
<li><code>arch</code> matches node's <code>process.arch</code> like <code>x64</code> or <code>ia32</code> unless the user passes the <code>--target_arch</code> option to override.</li>
<li><code>configuration</code> - Either 'Release' or 'Debug' depending on if <code>--debug</code> is passed during the build.</li>
<li><code>module_name</code> - the <code>binary.module_name</code> attribute from <code>package.json</code>.</li>
<li><code>version</code> - the semver <code>version</code> value for your module from <code>package.json</code> (NOTE: ignores the <code>semver.build</code> property).</li>
<li><code>major</code>, <code>minor</code>, <code>patch</code>, and <code>prelease</code> match the individual semver values for your module's <code>version</code></li>
<li><code>build</code> - the sevmer <code>build</code> value. For example it would be <code>this.that</code> if your package.json <code>version</code> was <code>v1.0.0+this.that</code></li>
<li><code>prerelease</code> - the semver <code>prerelease</code> value. For example it would be <code>alpha.beta</code> if your package.json <code>version</code> was <code>v1.0.0-alpha.beta</code></li>
</ul>
<p>The options are visible in the code at <a href="https://github.com/mapbox/node-pre-gyp/blob/612b7bca2604508d881e1187614870ba19a7f0c5/lib/util/versioning.js#L114-L127">https://github.com/mapbox/node-pre-gyp/blob/612b7bca2604508d881e1187614870ba19a7f0c5/lib/util/versioning.js#L114-L127</a></p>
<div class="pilwrap" id="download-binary-files-from-a-mirror">
  <h1>
    <a href="#download-binary-files-from-a-mirror" name="download-binary-files-from-a-mirror" class="pilcrow"></a>
Download binary files from a mirror
  </h1>
</div>
<p>S3 is broken in China for the well known reason.</p>
<p>Using the <code>npm</code> config argument: <code>--{module_name}_binary_host_mirror</code> can download binary files through a mirror.</p>
<p>e.g.: Install <a href="https://www.npmjs.com/package/v8-profiler">v8-profiler</a> from <code>npm</code>.</p>
<pre><code class="bash">$ npm install v8-profiler --profiler_binary_host_mirror=https://npm.taobao.org/mirrors/node-inspector/
</code></pre>
</div>
  </div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>install.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/node-pre-gyp/lib/install.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>install.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-built_in">module</span>.exports = exports = install;

exports.usage = <span class="hljs-string">'Attempts to install pre-built binary for module'</span>;

<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> zlib = <span class="hljs-built_in">require</span>(<span class="hljs-string">'zlib'</span>);
<span class="hljs-keyword">var</span> log = <span class="hljs-built_in">require</span>(<span class="hljs-string">'npmlog'</span>);
<span class="hljs-keyword">var</span> existsAsync = fs.exists || path.exists;
<span class="hljs-keyword">var</span> versioning = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util/versioning.js'</span>);
<span class="hljs-keyword">var</span> testbinary = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./testbinary.js'</span>);
<span class="hljs-keyword">var</span> clean = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./clean.js'</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">download</span>(<span class="hljs-params">uri,opts,callback</span>) </span>{
    log.http(<span class="hljs-string">'GET'</span>, uri);

    <span class="hljs-keyword">var</span> req = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">var</span> requestOpts = {
        <span class="hljs-attr">uri</span>: uri.replace(<span class="hljs-string">'+'</span>,<span class="hljs-string">'%2B'</span>),
        <span class="hljs-attr">headers</span>: {
          <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'node-pre-gyp (node '</span> + process.version + <span class="hljs-string">')'</span>
        }
    };

    <span class="hljs-keyword">var</span> proxyUrl = opts.proxy ||
                    process.env.http_proxy ||
                    process.env.HTTP_PROXY ||
                    process.env.npm_config_proxy;
    <span class="hljs-keyword">if</span> (proxyUrl) {
      <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^https?:\/\//i</span>.test(proxyUrl)) {
        log.verbose(<span class="hljs-string">'download'</span>, <span class="hljs-string">'using proxy url: "%s"'</span>, proxyUrl);
        requestOpts.proxy = proxyUrl;
      } <span class="hljs-keyword">else</span> {
        log.warn(<span class="hljs-string">'download'</span>, <span class="hljs-string">'ignoring invalid "proxy" config setting: "%s"'</span>, proxyUrl);
      }
    }
    <span class="hljs-keyword">try</span> {
        req = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>)(requestOpts);
    } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-keyword">return</span> callback(e);
    }
    <span class="hljs-keyword">if</span> (req) {
      req.on(<span class="hljs-string">'response'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) </span>{
        log.http(res.statusCode, uri);
      });
    }
    <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>,req);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">place_binary</span>(<span class="hljs-params">from,to,opts,callback</span>) </span>{
    download(<span class="hljs-keyword">from</span>,opts,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,req</span>) </span>{
        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> callback(err);
        <span class="hljs-keyword">if</span> (!req) <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"empty req"</span>));
        <span class="hljs-keyword">var</span> badDownload = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">var</span> extractCount = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> gunzip = zlib.createGunzip();
        <span class="hljs-keyword">var</span> extracter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'tar'</span>).Extract({ <span class="hljs-attr">path</span>: to, <span class="hljs-attr">strip</span>: <span class="hljs-number">1</span>});

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">afterTarball</span>(<span class="hljs-params">err</span>) </span>{
            <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> callback(err);
            <span class="hljs-keyword">if</span> (badDownload) <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"bad download"</span>));
            <span class="hljs-keyword">if</span> (extractCount === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'There was a fatal problem while downloading/extracting the tarball'</span>));
            }
            log.info(<span class="hljs-string">'tarball'</span>, <span class="hljs-string">'done parsing tarball'</span>);
            callback();
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter_func</span>(<span class="hljs-params">entry</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>ensure directories are +x
https://github.com/mapnik/node-mapnik/issues/262</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            entry.props.mode |= (entry.props.mode &gt;&gt;&gt; <span class="hljs-number">2</span>) &amp; <span class="hljs-built_in">parseInt</span>(<span class="hljs-string">'0111'</span>,<span class="hljs-number">8</span>);
            log.info(<span class="hljs-string">'install'</span>,<span class="hljs-string">'unpacking '</span> + entry.path);
            extractCount++;
        }

        gunzip.on(<span class="hljs-string">'error'</span>, callback);
        extracter.on(<span class="hljs-string">'entry'</span>, filter_func);
        extracter.on(<span class="hljs-string">'error'</span>, callback);
        extracter.on(<span class="hljs-string">'end'</span>, afterTarball);

        req.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
            badDownload = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">return</span> callback(err);
        });

        req.on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span> (extractCount === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Connection closed while downloading tarball file'</span>));
            }
        });

        req.on(<span class="hljs-string">'response'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>) </span>{
            <span class="hljs-keyword">if</span> (res.statusCode !== <span class="hljs-number">200</span>) {
                badDownload = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">if</span> (res.statusCode == <span class="hljs-number">404</span>) {
                    <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Pre-built binary not available for your system, looked for '</span> + <span class="hljs-keyword">from</span>));
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(res.statusCode + <span class="hljs-string">' status code downloading tarball '</span> + <span class="hljs-keyword">from</span>));
                }
            }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>start unzipping and untaring</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            req.pipe(gunzip).pipe(extracter);
        });
    });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_build</span>(<span class="hljs-params">gyp,argv,callback</span>) </span>{
  gyp.todo.push( { <span class="hljs-attr">name</span>: <span class="hljs-string">'build'</span>, <span class="hljs-attr">args</span>: [<span class="hljs-string">'rebuild'</span>] } );
  process.nextTick(callback);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">install</span>(<span class="hljs-params">gyp, argv, callback</span>) </span>{
    <span class="hljs-keyword">var</span> package_json = <span class="hljs-built_in">JSON</span>.parse(fs.readFileSync(<span class="hljs-string">'./package.json'</span>));
    <span class="hljs-keyword">var</span> source_build = gyp.opts[<span class="hljs-string">'build-from-source'</span>] || gyp.opts.build_from_source;
    <span class="hljs-keyword">var</span> update_binary = gyp.opts[<span class="hljs-string">'update-binary'</span>] || gyp.opts.update_binary;
    <span class="hljs-keyword">var</span> should_do_source_build = source_build === package_json.name || (source_build === <span class="hljs-literal">true</span> || source_build === <span class="hljs-string">'true'</span>);
    <span class="hljs-keyword">var</span> no_rollback = gyp.opts.hasOwnProperty(<span class="hljs-string">'rollback'</span>) &amp;&amp; gyp.opts.rollback === <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (should_do_source_build) {
        log.info(<span class="hljs-string">'build'</span>,<span class="hljs-string">'requesting source compile'</span>);
        <span class="hljs-keyword">return</span> do_build(gyp,argv,callback);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> fallback_to_build = gyp.opts[<span class="hljs-string">'fallback-to-build'</span>] || gyp.opts.fallback_to_build;
        <span class="hljs-keyword">var</span> should_do_fallback_build = fallback_to_build === package_json.name || (fallback_to_build === <span class="hljs-literal">true</span> || fallback_to_build === <span class="hljs-string">'true'</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>but allow override from npm</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (process.env.npm_config_argv) {
            <span class="hljs-keyword">var</span> cooked = <span class="hljs-built_in">JSON</span>.parse(process.env.npm_config_argv).cooked;
            <span class="hljs-keyword">var</span> match = cooked.indexOf(<span class="hljs-string">"--fallback-to-build"</span>);
            <span class="hljs-keyword">if</span> (match &gt; <span class="hljs-number">-1</span> &amp;&amp; cooked.length &gt; match &amp;&amp; cooked[match+<span class="hljs-number">1</span>] == <span class="hljs-string">"false"</span>) {
                should_do_fallback_build = <span class="hljs-literal">false</span>;
                log.info(<span class="hljs-string">'install'</span>,<span class="hljs-string">'Build fallback disabled via npm flag: --fallback-to-build=false'</span>);
            }
        }
        <span class="hljs-keyword">var</span> opts;
        <span class="hljs-keyword">try</span> {
            opts = versioning.evaluate(package_json, gyp.opts);
        } <span class="hljs-keyword">catch</span> (err) {
            <span class="hljs-keyword">return</span> callback(err);
        }
        <span class="hljs-keyword">var</span> <span class="hljs-keyword">from</span> = opts.hosted_tarball;
        <span class="hljs-keyword">var</span> to = opts.module_path;
        <span class="hljs-keyword">var</span> binary_module = path.join(to,opts.module_name + <span class="hljs-string">'.node'</span>);
        <span class="hljs-keyword">if</span> (existsAsync(binary_module,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">found</span>) </span>{
            <span class="hljs-keyword">if</span> (found &amp;&amp; !update_binary) {
                testbinary(gyp, argv, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
                    <span class="hljs-keyword">if</span> (err) {
                        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'['</span>+package_json.name+<span class="hljs-string">'] '</span> + err.message);
                        log.error(<span class="hljs-string">"Testing local pre-built binary failed, attempting to re-download"</span>);
                        place_binary(<span class="hljs-keyword">from</span>,to,opts,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
                            <span class="hljs-keyword">if</span> (err) {
                                <span class="hljs-keyword">if</span> (should_do_fallback_build) {
                                    log.http(err.message + <span class="hljs-string">' (falling back to source compile with node-gyp)'</span>);
                                    <span class="hljs-keyword">return</span> do_build(gyp,argv,callback);
                                } <span class="hljs-keyword">else</span> {
                                    <span class="hljs-keyword">return</span> callback(err);
                                }
                            } <span class="hljs-keyword">else</span> {
                                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'['</span>+package_json.name+<span class="hljs-string">'] Success: "'</span> + binary_module + <span class="hljs-string">'" is reinstalled via remote'</span>);
                                <span class="hljs-keyword">return</span> callback();
                            }
                        });
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'['</span>+package_json.name+<span class="hljs-string">'] Success: "'</span> + binary_module + <span class="hljs-string">'" already installed'</span>);
                        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Pass --update-binary to reinstall or --build-from-source to recompile'</span>);
                        <span class="hljs-keyword">return</span> callback();
                    }
                });
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (!update_binary) log.info(<span class="hljs-string">'check'</span>,<span class="hljs-string">'checked for "'</span> + binary_module + <span class="hljs-string">'" (not found)'</span>);
                place_binary(<span class="hljs-keyword">from</span>,to,opts,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
                    <span class="hljs-keyword">if</span> (err &amp;&amp; should_do_fallback_build) {
                        log.http(err.message + <span class="hljs-string">' (falling back to source compile with node-gyp)'</span>);
                        <span class="hljs-keyword">return</span> do_build(gyp,argv,callback);
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (err) {
                        <span class="hljs-keyword">return</span> callback(err);
                    } <span class="hljs-keyword">else</span> {
                        testbinary(gyp, argv, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
                            <span class="hljs-keyword">if</span> (err) {
                                <span class="hljs-keyword">if</span> (no_rollback) {
                                    <span class="hljs-keyword">return</span> callback(err);
                                }
                                gyp.opts.silent_clean = <span class="hljs-literal">true</span>;
                                clean(gyp, argv, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
                                    <span class="hljs-keyword">if</span> (error) <span class="hljs-built_in">console</span>.log(error);
                                    <span class="hljs-keyword">if</span> (should_do_fallback_build) {
                                        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'['</span>+package_json.name+<span class="hljs-string">'] '</span> + err.message);
                                        log.error(<span class="hljs-string">"Testing pre-built binary failed, attempting to source compile"</span>);
                                        <span class="hljs-keyword">return</span> do_build(gyp,argv,callback);
                                    } <span class="hljs-keyword">else</span> {
                                        <span class="hljs-keyword">return</span> callback(err);
                                    }
                                });
                            } <span class="hljs-keyword">else</span> {
                                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'['</span>+package_json.name+<span class="hljs-string">'] Success: "'</span> + binary_module + <span class="hljs-string">'" is installed via remote'</span>);
                                <span class="hljs-keyword">return</span> callback();
                            }
                        });
                    }
                });
            }
        }));
    }
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

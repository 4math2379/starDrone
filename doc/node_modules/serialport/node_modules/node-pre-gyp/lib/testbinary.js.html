<!DOCTYPE html>
<html>
<head>
  <title>testbinary.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/node-pre-gyp/lib/testbinary.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>testbinary.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-built_in">module</span>.exports = exports = testbinary;

exports.usage = <span class="hljs-string">'Tests that the binary.node can be required'</span>;

<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> log = <span class="hljs-built_in">require</span>(<span class="hljs-string">'npmlog'</span>);
<span class="hljs-keyword">var</span> cp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>);
<span class="hljs-keyword">var</span> versioning = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util/versioning.js'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testbinary</span>(<span class="hljs-params">gyp, argv, callback</span>) </span>{
    <span class="hljs-keyword">var</span> args = [];
    <span class="hljs-keyword">var</span> options = {};
    <span class="hljs-keyword">var</span> shell_cmd = process.execPath;
    <span class="hljs-keyword">var</span> package_json = <span class="hljs-built_in">JSON</span>.parse(fs.readFileSync(<span class="hljs-string">'./package.json'</span>));
    <span class="hljs-keyword">var</span> opts = versioning.evaluate(package_json, gyp.opts);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>ensure on windows that / are used for require path</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> binary_module = opts.module.replace(<span class="hljs-regexp">/\\/g</span>, <span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">var</span> nw = (opts.runtime &amp;&amp; opts.runtime === <span class="hljs-string">'node-webkit'</span>);
    <span class="hljs-keyword">if</span> ((process.arch != opts.target_arch) ||
        (process.platform != opts.target_platform)) {
        <span class="hljs-keyword">var</span> msg = <span class="hljs-string">"skipping validation since host platform/arch ("</span>;
        msg += process.platform+<span class="hljs-string">'/'</span>+process.arch+<span class="hljs-string">")"</span>;
        msg += <span class="hljs-string">" does not match target ("</span>;
        msg += opts.target_platform+<span class="hljs-string">'/'</span>+opts.target_arch+<span class="hljs-string">")"</span>;
        log.info(<span class="hljs-string">'validate'</span>, msg);
        <span class="hljs-keyword">return</span> callback();
    }
    <span class="hljs-keyword">if</span> (nw) {
        options.timeout = <span class="hljs-number">5000</span>;
        <span class="hljs-keyword">if</span> (process.platform === <span class="hljs-string">'darwin'</span>) {
            shell_cmd = <span class="hljs-string">'node-webkit'</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (process.platform === <span class="hljs-string">'win32'</span>) {
            shell_cmd = <span class="hljs-string">'nw.exe'</span>;
        } <span class="hljs-keyword">else</span> {
            shell_cmd = <span class="hljs-string">'nw'</span>;
        }
        <span class="hljs-keyword">var</span> modulePath = path.resolve(binary_module);
        <span class="hljs-keyword">var</span> appDir = path.join(__dirname, <span class="hljs-string">'util'</span>, <span class="hljs-string">'nw-pre-gyp'</span>);
        args.push(appDir);
        args.push(modulePath);
        log.info(<span class="hljs-string">"validate"</span>,<span class="hljs-string">"Running test command: '"</span> + shell_cmd + <span class="hljs-string">' '</span> + args.join(<span class="hljs-string">' '</span>) + <span class="hljs-string">"'"</span>);
        cp.execFile(shell_cmd, args, options, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, stdout, stderr</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>check for normal timeout for node-webkit</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-keyword">if</span> (err.killed === <span class="hljs-literal">true</span> &amp;&amp; err.signal &amp;&amp; err.signal.indexOf(<span class="hljs-string">'SIG'</span>) &gt; <span class="hljs-number">-1</span>) {
                    <span class="hljs-keyword">return</span> callback();
                }
                <span class="hljs-keyword">var</span> stderrLog = stderr.toString();
                log.info(<span class="hljs-string">'stderr'</span>, stderrLog);
                <span class="hljs-keyword">if</span>( <span class="hljs-regexp">/^\s*Xlib:\s*extension\s*"RANDR"\s*missing\s*on\s*display\s*":\d+\.\d+"\.\s*$/</span>.test(stderrLog) ){
                    log.info(<span class="hljs-string">'RANDR'</span>, <span class="hljs-string">'stderr contains only RANDR error, ignored'</span>);
                    <span class="hljs-keyword">return</span> callback();
                }
                <span class="hljs-keyword">return</span> callback(err);
            }
            <span class="hljs-keyword">return</span> callback();
        });
        <span class="hljs-keyword">return</span>;
    }
    args.push(<span class="hljs-string">'--eval'</span>);
    args.push(<span class="hljs-string">"'require(\\'"</span> + binary_module.replace(<span class="hljs-regexp">/\'/g</span>, <span class="hljs-string">'\\\''</span>) +<span class="hljs-string">"\\')'"</span>);
    log.info(<span class="hljs-string">"validate"</span>,<span class="hljs-string">"Running test command: '"</span> + shell_cmd + <span class="hljs-string">' '</span> + args.join(<span class="hljs-string">' '</span>) + <span class="hljs-string">"'"</span>);
    cp.execFile(shell_cmd, args, options, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, stdout, stderr</span>) </span>{
        <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-keyword">return</span> callback(err, { <span class="hljs-attr">stdout</span>:stdout, <span class="hljs-attr">stderr</span>:stderr});
        }
        <span class="hljs-keyword">return</span> callback();
    });
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

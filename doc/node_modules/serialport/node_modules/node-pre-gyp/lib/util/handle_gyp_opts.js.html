<!DOCTYPE html>
<html>
<head>
  <title>handle_gyp_opts.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../../doc-style.css" />
  <script src="../../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../../";
    var thisFile = "node_modules/serialport/node_modules/node-pre-gyp/lib/util/handle_gyp_opts.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>handle_gyp_opts.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-built_in">module</span>.exports = exports = handle_gyp_opts;

<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> versioning = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./versioning.js'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>Here we gather node-pre-gyp generated options (from versioning) and pass them along to node-gyp.</p>
</div>
<div class="body">
<p>We massage the args and options slightly to account for differences in what commands mean between
node-pre-gyp and node-gyp (e.g. see the difference between &quot;build&quot; and &quot;rebuild&quot; below)</p>
<p>Keep in mind: the values inside <code>argv</code> and <code>gyp.opts</code> below are different depending on whether
node-pre-gyp is called directory, or if it is called in a <code>run-script</code> phase of npm.</p>
<p>We also try to preserve any command line options that might have been passed to npm or node-pre-gyp.
But this is fairly difficult without passing way to much through. For example <code>gyp.opts</code> contains all
the process.env and npm pushes a lot of variables into process.env which node-pre-gyp inherits. So we have
to be very selective about what we pass through.</p>
<p>For example:</p>
<p><code>npm install --build-from-source</code> will give:</p>
<p>argv == [ 'rebuild' ]
gyp.opts.argv == { remain: [ 'install' ],
cooked: [ 'install', '--fallback-to-build' ],
original: [ 'install', '--fallback-to-build' ] }</p>
<p><code>./bin/node-pre-gyp build</code> will give:</p>
<p>argv == []
gyp.opts.argv == { remain: [ 'build' ],
cooked: [ 'build' ],
original: [ '-C', 'test/app1', 'build' ] }</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>select set of node-pre-gyp versioning info
to share with node-gyp</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> share_with_node_gyp = [
  <span class="hljs-string">'module'</span>,
  <span class="hljs-string">'module_name'</span>,
  <span class="hljs-string">'module_path'</span>,
];

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle_gyp_opts</span>(<span class="hljs-params">gyp, argv, callback</span>) </span>{

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>Collect node-pre-gyp specific variables to pass to node-gyp</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> node_pre_gyp_options = [];
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>generate custom node-pre-gyp versioning info</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> opts = versioning.evaluate(<span class="hljs-built_in">JSON</span>.parse(fs.readFileSync(<span class="hljs-string">'./package.json'</span>)), gyp.opts);
    share_with_node_gyp.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key</span>) </span>{
        <span class="hljs-keyword">var</span> val = opts[key];
        <span class="hljs-keyword">if</span> (val) {
            node_pre_gyp_options.push(<span class="hljs-string">'--'</span> + key + <span class="hljs-string">'='</span> + val);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Option "</span> + key + <span class="hljs-string">" required but not found by node-pre-gyp"</span>));
        }
    });

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Collect options that follow the special -- which disables nopt parsing</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> unparsed_options = [];
    <span class="hljs-keyword">var</span> double_hyphen_found = <span class="hljs-literal">false</span>;
    gyp.opts.argv.original.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">opt</span>) </span>{
        <span class="hljs-keyword">if</span> (double_hyphen_found) {
            unparsed_options.push(opt);
        }
        <span class="hljs-keyword">if</span> (opt == <span class="hljs-string">'--'</span>) {
            double_hyphen_found = <span class="hljs-literal">true</span>;
        }
    });

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>We try respect and pass through remaining command
line options (like --foo=bar) to node-gyp</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> cooked = gyp.opts.argv.cooked;
    <span class="hljs-keyword">var</span> node_gyp_options = [];
    cooked.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
        <span class="hljs-keyword">if</span> (value.length &gt; <span class="hljs-number">2</span> &amp;&amp; value.slice(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>) == <span class="hljs-string">'--'</span>) {
            <span class="hljs-keyword">var</span> key = value.slice(<span class="hljs-number">2</span>);
            <span class="hljs-keyword">var</span> val = cooked[cooked.indexOf(value)+<span class="hljs-number">1</span>];
            <span class="hljs-keyword">if</span> (val &amp;&amp; val.indexOf(<span class="hljs-string">'--'</span>) === <span class="hljs-number">-1</span>) { <span class="hljs-comment">// handle '--foo=bar' or ['--foo','bar']</span>
                node_gyp_options.push(<span class="hljs-string">'--'</span> + key + <span class="hljs-string">'='</span> + val);
            } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// pass through --foo</span>
                node_gyp_options.push(value);
            }
        }
    });

    <span class="hljs-keyword">var</span> result = {<span class="hljs-string">'opts'</span>:opts,<span class="hljs-string">'gyp'</span>:node_gyp_options,<span class="hljs-string">'pre'</span>:node_pre_gyp_options,<span class="hljs-string">'unparsed'</span>:unparsed_options};
    <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>,result);
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

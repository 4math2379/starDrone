<!DOCTYPE html>
<html>
<head>
  <title>compile.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../../doc-style.css" />
  <script src="../../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../../";
    var thisFile = "node_modules/serialport/node_modules/node-pre-gyp/lib/util/compile.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>compile.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-built_in">module</span>.exports = exports;

<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> win = process.platform == <span class="hljs-string">'win32'</span>;
<span class="hljs-keyword">var</span> existsSync = fs.existsSync || path.existsSync;
<span class="hljs-keyword">var</span> cp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>try to build up the complete path to node-gyp</p>
<div class="dox">
<div class="summary">
<p>priority:</p>
<ul>
<li>node-gyp on ENV:npm_config_node_gyp (https://github.com/npm/npm/pull/4887)</li>
<li>node-gyp on NODE_PATH</li>
<li>node-gyp inside npm on NODE_PATH (ignore on iojs)</li>
<li>node-gyp inside npm beside node exe</li>
</ul>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">which_node_gyp</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> node_gyp_bin;
    <span class="hljs-keyword">if</span> (process.env.npm_config_node_gyp) {
      <span class="hljs-keyword">try</span> {
          node_gyp_bin = process.env.npm_config_node_gyp;
          <span class="hljs-keyword">if</span> (existsSync(node_gyp_bin)) {
              <span class="hljs-keyword">return</span> node_gyp_bin;
          }
      } <span class="hljs-keyword">catch</span> (err) { }
    }
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">var</span> node_gyp_main = <span class="hljs-built_in">require</span>.resolve(<span class="hljs-string">'node-gyp'</span>);
        node_gyp_bin = path.join(path.dirname(
                                     path.dirname(node_gyp_main)),
                                     <span class="hljs-string">'bin/node-gyp.js'</span>);
        <span class="hljs-keyword">if</span> (existsSync(node_gyp_bin)) {
            <span class="hljs-keyword">return</span> node_gyp_bin;
        }
    } <span class="hljs-keyword">catch</span> (err) { }
    <span class="hljs-keyword">if</span> (process.execPath.indexOf(<span class="hljs-string">'iojs'</span>) === <span class="hljs-number">-1</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">var</span> npm_main = <span class="hljs-built_in">require</span>.resolve(<span class="hljs-string">'npm'</span>);
            node_gyp_bin = path.join(path.dirname(
                                         path.dirname(npm_main)),
                                         <span class="hljs-string">'node_modules/node-gyp/bin/node-gyp.js'</span>);
            <span class="hljs-keyword">if</span> (existsSync(node_gyp_bin)) {
                <span class="hljs-keyword">return</span> node_gyp_bin;
            }
        } <span class="hljs-keyword">catch</span> (err) { }
    }
    <span class="hljs-keyword">var</span> npm_base = path.join(path.dirname(
                             path.dirname(process.execPath)),
                             <span class="hljs-string">'lib/node_modules/npm/'</span>);
    node_gyp_bin = path.join(npm_base, <span class="hljs-string">'node_modules/node-gyp/bin/node-gyp.js'</span>);
    <span class="hljs-keyword">if</span> (existsSync(node_gyp_bin)) {
        <span class="hljs-keyword">return</span> node_gyp_bin;
    }
}

<span class="hljs-built_in">module</span>.exports.run_gyp = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args,opts,callback</span>) </span>{
    <span class="hljs-keyword">var</span> shell_cmd = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">var</span> cmd_args = [];
    <span class="hljs-keyword">if</span> (opts.runtime &amp;&amp; opts.runtime == <span class="hljs-string">'node-webkit'</span>) {
        shell_cmd = <span class="hljs-string">'nw-gyp'</span>;
        <span class="hljs-keyword">if</span> (win) shell_cmd += <span class="hljs-string">'.cmd'</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> node_gyp_path = which_node_gyp();
        <span class="hljs-keyword">if</span> (node_gyp_path) {
            shell_cmd = process.execPath;
            cmd_args.push(node_gyp_path);
        } <span class="hljs-keyword">else</span> {
            shell_cmd = <span class="hljs-string">'node-gyp'</span>;
            <span class="hljs-keyword">if</span> (win) shell_cmd += <span class="hljs-string">'.cmd'</span>;
        }
    }
    <span class="hljs-keyword">var</span> final_args = cmd_args.concat(args);
    <span class="hljs-keyword">var</span> cmd = cp.spawn(shell_cmd, final_args, {<span class="hljs-attr">cwd</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-attr">env</span>: process.env, <span class="hljs-attr">stdio</span>: [ <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>]});
    cmd.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Failed to execute '"</span> + shell_cmd + <span class="hljs-string">' '</span> + final_args.join(<span class="hljs-string">' '</span>) + <span class="hljs-string">"' ("</span> + err + <span class="hljs-string">")"</span>));
        }
        callback(<span class="hljs-literal">null</span>,opts);
    });
    cmd.on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">code</span>) </span>{
        <span class="hljs-keyword">if</span> (code &amp;&amp; code !== <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Failed to execute '"</span> + shell_cmd + <span class="hljs-string">' '</span> + final_args.join(<span class="hljs-string">' '</span>) + <span class="hljs-string">"' ("</span> + code + <span class="hljs-string">")"</span>));
        }
        callback(<span class="hljs-literal">null</span>,opts);
    });
};

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

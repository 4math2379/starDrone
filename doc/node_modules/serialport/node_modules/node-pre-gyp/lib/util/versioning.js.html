<!DOCTYPE html>
<html>
<head>
  <title>versioning.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../../doc-style.css" />
  <script src="../../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../../";
    var thisFile = "node_modules/serialport/node_modules/node-pre-gyp/lib/util/versioning.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>versioning.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-built_in">module</span>.exports = exports;

<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> semver = <span class="hljs-built_in">require</span>(<span class="hljs-string">'semver'</span>);
<span class="hljs-keyword">var</span> url = <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>);

<span class="hljs-keyword">var</span> abi_crosswalk;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>This is used for unit testing to provide a fake
ABI crosswalk that emulates one that is not updated
for the current version</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">if</span> (process.env.NODE_PRE_GYP_ABI_CROSSWALK) {
    abi_crosswalk = <span class="hljs-built_in">require</span>(process.env.NODE_PRE_GYP_ABI_CROSSWALK);
} <span class="hljs-keyword">else</span> {
    abi_crosswalk = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./abi_crosswalk.json'</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_electron_abi</span>(<span class="hljs-params">runtime, target_version</span>) </span>{
    <span class="hljs-keyword">if</span> (!runtime) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"get_electron_abi requires valid runtime arg"</span>);
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> target_version === <span class="hljs-string">'undefined'</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>erroneous CLI call</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Empty target version is not supported if electron is the target."</span>);
    }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>Electron guarantees that patch version update won't break native modules.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> sem_ver = semver.parse(target_version);
    <span class="hljs-keyword">return</span> runtime + <span class="hljs-string">'-v'</span> + sem_ver.major + <span class="hljs-string">'.'</span> + sem_ver.minor;
}
<span class="hljs-built_in">module</span>.exports.get_electron_abi = get_electron_abi;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_node_webkit_abi</span>(<span class="hljs-params">runtime, target_version</span>) </span>{
    <span class="hljs-keyword">if</span> (!runtime) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"get_node_webkit_abi requires valid runtime arg"</span>);
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> target_version === <span class="hljs-string">'undefined'</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>erroneous CLI call</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Empty target version is not supported if node-webkit is the target."</span>);
    }
    <span class="hljs-keyword">return</span> runtime + <span class="hljs-string">'-v'</span> + target_version;
}
<span class="hljs-built_in">module</span>.exports.get_node_webkit_abi = get_node_webkit_abi;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_node_abi</span>(<span class="hljs-params">runtime, versions</span>) </span>{
    <span class="hljs-keyword">if</span> (!runtime) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"get_node_abi requires valid runtime arg"</span>);
    }
    <span class="hljs-keyword">if</span> (!versions) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"get_node_abi requires valid process.versions object"</span>);
    }
    <span class="hljs-keyword">var</span> sem_ver = semver.parse(versions.node);
    <span class="hljs-keyword">if</span> (sem_ver.major === <span class="hljs-number">0</span> &amp;&amp; sem_ver.minor % <span class="hljs-number">2</span>) { <span class="hljs-comment">// odd series</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>https://github.com/mapbox/node-pre-gyp/issues/124</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">return</span> runtime+<span class="hljs-string">'-v'</span>+versions.node;
    } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>process.versions.modules added in &gt;= v0.10.4 and v0.11.7
https://github.com/joyent/node/commit/ccabd4a6fa8a6eb79d29bc3bbe9fe2b6531c2d8e</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">return</span> versions.modules ? runtime+<span class="hljs-string">'-v'</span> + (+versions.modules) :
            <span class="hljs-string">'v8-'</span> + versions.v8.split(<span class="hljs-string">'.'</span>).slice(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>).join(<span class="hljs-string">'.'</span>);
    }
}
<span class="hljs-built_in">module</span>.exports.get_node_abi = get_node_abi;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_runtime_abi</span>(<span class="hljs-params">runtime, target_version</span>) </span>{
    <span class="hljs-keyword">if</span> (!runtime) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"get_runtime_abi requires valid runtime arg"</span>);
    }
    <span class="hljs-keyword">if</span> (runtime === <span class="hljs-string">'node-webkit'</span>) {
        <span class="hljs-keyword">return</span> get_node_webkit_abi(runtime, target_version || process.versions[<span class="hljs-string">'node-webkit'</span>]);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (runtime === <span class="hljs-string">'electron'</span>) {
        <span class="hljs-keyword">return</span> get_electron_abi(runtime, target_version || process.versions.electron);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (runtime != <span class="hljs-string">'node'</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Unknown Runtime: '"</span> + runtime + <span class="hljs-string">"'"</span>);
        }
        <span class="hljs-keyword">if</span> (!target_version) {
            <span class="hljs-keyword">return</span> get_node_abi(runtime,process.versions);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> cross_obj;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>abi_crosswalk generated with ./scripts/abi_crosswalk.js</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">if</span> (abi_crosswalk[target_version]) {
                cross_obj = abi_crosswalk[target_version];
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> target_parts = target_version.split(<span class="hljs-string">'.'</span>).map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">i</span>) </span>{ <span class="hljs-keyword">return</span> +i; });
                <span class="hljs-keyword">if</span> (target_parts.length != <span class="hljs-number">3</span>) { <span class="hljs-comment">// parse failed</span>
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Unknown target version: "</span> + target_version);
                }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<div class="dox">
<div class="summary">
<p>The below code tries to infer the last known ABI compatible version
that we have recorded in the abi_crosswalk.json when an exact match
is not possible. The reasons for this to exist are complicated:</p>
</div>
<div class="body">
<ul>
<li>We support passing --target to be able to allow developers to package binaries for versions of node
that are not the same one as they are running. This might also be used in combination with the
--target_arch or --target_platform flags to also package binaries for alternative platforms</li>
<li>When --target is passed we can't therefore determine the ABI (process.versions.modules) from the node
version that is running in memory</li>
<li>So, therefore node-pre-gyp keeps an &quot;ABI crosswalk&quot; (lib/util/abi_crosswalk.json) to be able to look
this info up for all versions</li>
<li>But we cannot easily predict what the future ABI will be for released versions</li>
<li>And node-pre-gyp needs to be a <code>bundledDependency</code> in apps that depend on it in order to work correctly
by being fully available at install time.</li>
<li>So, the speed of node releases and the bundled nature of node-pre-gyp mean that a new node-pre-gyp release
need to happen for every node.js/io.js/node-webkit/nw.js/atom-shell/etc release that might come online if
you want the <code>--target</code> flag to keep working for the latest version</li>
<li>Which is impractical ^^</li>
<li>Hence the below code guesses about future ABI to make the need to update node-pre-gyp less demanding.</li>
</ul>
<p>In practice then you can have a dependency of your app like <code>node-sqlite3</code> that bundles a <code>node-pre-gyp</code> that
only knows about node v0.10.33 in the <code>abi_crosswalk.json</code> but target node v0.10.34 (which is assumed to be
ABI compatible with v0.10.33).</p>
<p>TODO: use semver module instead of custom version parsing</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">                <span class="hljs-keyword">var</span> major = target_parts[<span class="hljs-number">0</span>];
                <span class="hljs-keyword">var</span> minor = target_parts[<span class="hljs-number">1</span>];
                <span class="hljs-keyword">var</span> patch = target_parts[<span class="hljs-number">2</span>];
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>io.js: yeah if node.js ever releases 1.x this will break
but that is unlikely to happen: https://github.com/iojs/io.js/pull/253#issuecomment-69432616</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                <span class="hljs-keyword">if</span> (major === <span class="hljs-number">1</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>look for last release that is the same major version
e.g. we assume io.js 1.x is ABI compatible with &gt;= 1.0.0</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                        <span class="hljs-keyword">if</span> (minor &gt; <span class="hljs-number">0</span>) --minor;
                        <span class="hljs-keyword">if</span> (patch &gt; <span class="hljs-number">0</span>) --patch;
                        <span class="hljs-keyword">var</span> new_iojs_target = <span class="hljs-string">''</span> + major + <span class="hljs-string">'.'</span> + minor + <span class="hljs-string">'.'</span> + patch;
                        <span class="hljs-keyword">if</span> (abi_crosswalk[new_iojs_target]) {
                            cross_obj = abi_crosswalk[new_iojs_target];
                            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Warning: node-pre-gyp could not find exact match for '</span> + target_version);
                            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Warning: but node-pre-gyp successfully choose '</span> + new_iojs_target + <span class="hljs-string">' as ABI compatible target'</span>);
                            <span class="hljs-keyword">break</span>;
                        }
                        <span class="hljs-keyword">if</span> (minor === <span class="hljs-number">0</span> &amp;&amp; patch === <span class="hljs-number">0</span>) {
                            <span class="hljs-keyword">break</span>;
                        }
                    }
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (major === <span class="hljs-number">0</span>) { <span class="hljs-comment">// node.js</span>
                    <span class="hljs-keyword">if</span> (target_parts[<span class="hljs-number">1</span>] % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>) { <span class="hljs-comment">// for stable/even node.js series</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>look for the last release that is the same minor release
e.g. we assume node 0.10.x is ABI compatible with &gt;= 0.10.0</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                        <span class="hljs-keyword">while</span> (--patch &gt; <span class="hljs-number">0</span>) {
                            <span class="hljs-keyword">var</span> new_node_target = <span class="hljs-string">''</span> + major + <span class="hljs-string">'.'</span> + minor + <span class="hljs-string">'.'</span> + patch;
                            <span class="hljs-keyword">if</span> (abi_crosswalk[new_node_target]) {
                                cross_obj = abi_crosswalk[new_node_target];
                                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Warning: node-pre-gyp could not find exact match for '</span> + target_version);
                                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Warning: but node-pre-gyp successfully choose '</span> + new_node_target + <span class="hljs-string">' as ABI compatible target'</span>);
                                <span class="hljs-keyword">break</span>;
                            }
                        }
                    }
                }
            }
            <span class="hljs-keyword">if</span> (!cross_obj) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Unsupported target version: "</span> + target_version);
            }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>emulate process.versions</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">var</span> versions_obj = {
                <span class="hljs-attr">node</span>: target_version,
                <span class="hljs-attr">v8</span>: cross_obj.v8+<span class="hljs-string">'.0'</span>,
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>abi_crosswalk uses 1 for node versions lacking process.versions.modules
process.versions.modules added in &gt;= v0.10.4 and v0.11.7</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                modules: cross_obj.node_abi &gt; <span class="hljs-number">1</span> ? cross_obj.node_abi : <span class="hljs-literal">undefined</span>
            };
            <span class="hljs-keyword">return</span> get_node_abi(runtime, versions_obj);
        }
    }
}
<span class="hljs-built_in">module</span>.exports.get_runtime_abi = get_runtime_abi;

<span class="hljs-keyword">var</span> required_parameters = [
    <span class="hljs-string">'module_name'</span>,
    <span class="hljs-string">'module_path'</span>,
    <span class="hljs-string">'host'</span>
];

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validate_config</span>(<span class="hljs-params">package_json</span>) </span>{
    <span class="hljs-keyword">var</span> msg = package_json.name + <span class="hljs-string">' package.json is not node-pre-gyp ready:\n'</span>;
    <span class="hljs-keyword">var</span> missing = [];
    <span class="hljs-keyword">if</span> (!package_json.main) {
        missing.push(<span class="hljs-string">'main'</span>);
    }
    <span class="hljs-keyword">if</span> (!package_json.version) {
        missing.push(<span class="hljs-string">'version'</span>);
    }
    <span class="hljs-keyword">if</span> (!package_json.name) {
        missing.push(<span class="hljs-string">'name'</span>);
    }
    <span class="hljs-keyword">if</span> (!package_json.binary) {
        missing.push(<span class="hljs-string">'binary'</span>);
    }
    <span class="hljs-keyword">var</span> o = package_json.binary;
    required_parameters.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p</span>) </span>{
        <span class="hljs-keyword">if</span> (missing.indexOf(<span class="hljs-string">'binary'</span>) &gt; <span class="hljs-number">-1</span>) {
            missing.pop(<span class="hljs-string">'binary'</span>);
        }
        <span class="hljs-keyword">if</span> (!o || o[p] === <span class="hljs-literal">undefined</span>) {
            missing.push(<span class="hljs-string">'binary.'</span> + p);
        }
    });
    <span class="hljs-keyword">if</span> (missing.length &gt;= <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(msg+<span class="hljs-string">"package.json must declare these properties: \n"</span> + missing.join(<span class="hljs-string">'\n'</span>));
    }
    <span class="hljs-keyword">if</span> (o) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>enforce https over http</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">var</span> protocol = url.parse(o.host).protocol;
        <span class="hljs-keyword">if</span> (protocol === <span class="hljs-string">'http:'</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"'host' protocol ("</span>+protocol+<span class="hljs-string">") is invalid - only 'https:' is accepted"</span>);
        }
    }
}

<span class="hljs-built_in">module</span>.exports.validate_config = validate_config;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eval_template</span>(<span class="hljs-params">template,opts</span>) </span>{
    <span class="hljs-built_in">Object</span>.keys(opts).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key</span>) </span>{
        <span class="hljs-keyword">var</span> pattern = <span class="hljs-string">'{'</span>+key+<span class="hljs-string">'}'</span>;
        <span class="hljs-keyword">while</span> (template.indexOf(pattern) &gt; <span class="hljs-number">-1</span>) {
            template = template.replace(pattern,opts[key]);
        }
    });
    <span class="hljs-keyword">return</span> template;
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>url.resolve needs single trailing slash
to behave correctly, otherwise a double slash
may end up in the url which breaks requests
and a lacking slash may not lead to proper joining</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fix_slashes</span>(<span class="hljs-params">pathname</span>) </span>{
    <span class="hljs-keyword">if</span> (pathname.slice(<span class="hljs-number">-1</span>) != <span class="hljs-string">'/'</span>) {
        <span class="hljs-keyword">return</span> pathname + <span class="hljs-string">'/'</span>;
    }
    <span class="hljs-keyword">return</span> pathname;
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>remove double slashes
note: path.normalize will not work because
it will convert forward to back slashes</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">drop_double_slashes</span>(<span class="hljs-params">pathname</span>) </span>{
    <span class="hljs-keyword">return</span> pathname.replace(<span class="hljs-regexp">/\/\//g</span>,<span class="hljs-string">'/'</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_process_runtime</span>(<span class="hljs-params">versions</span>) </span>{
    <span class="hljs-keyword">var</span> runtime = <span class="hljs-string">'node'</span>;
    <span class="hljs-keyword">if</span> (versions[<span class="hljs-string">'node-webkit'</span>]) {
        runtime = <span class="hljs-string">'node-webkit'</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (versions.electron) {
        runtime = <span class="hljs-string">'electron'</span>;
    }
    <span class="hljs-keyword">return</span> runtime;
}

<span class="hljs-built_in">module</span>.exports.get_process_runtime = get_process_runtime;

<span class="hljs-keyword">var</span> default_package_name = <span class="hljs-string">'{module_name}-v{version}-{node_abi}-{platform}-{arch}.tar.gz'</span>;
<span class="hljs-keyword">var</span> default_remote_path = <span class="hljs-string">''</span>;

<span class="hljs-built_in">module</span>.exports.evaluate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">package_json,options</span>) </span>{
    options = options || {};
    validate_config(package_json);
    <span class="hljs-keyword">var</span> v = package_json.version;
    <span class="hljs-keyword">var</span> module_version = semver.parse(v);
    <span class="hljs-keyword">var</span> runtime = options.runtime || get_process_runtime(process.versions);
    <span class="hljs-keyword">var</span> opts = {
        <span class="hljs-attr">name</span>: package_json.name,
        <span class="hljs-attr">configuration</span>: <span class="hljs-built_in">Boolean</span>(options.debug) ? <span class="hljs-string">'Debug'</span> : <span class="hljs-string">'Release'</span>,
        <span class="hljs-attr">debug</span>: options.debug,
        <span class="hljs-attr">module_name</span>: package_json.binary.module_name,
        <span class="hljs-attr">version</span>: module_version.version,
        <span class="hljs-attr">prerelease</span>: module_version.prerelease.length ? module_version.prerelease.join(<span class="hljs-string">'.'</span>) : <span class="hljs-string">''</span>,
        <span class="hljs-attr">build</span>: module_version.build.length ? module_version.build.join(<span class="hljs-string">'.'</span>) : <span class="hljs-string">''</span>,
        <span class="hljs-attr">major</span>: module_version.major,
        <span class="hljs-attr">minor</span>: module_version.minor,
        <span class="hljs-attr">patch</span>: module_version.patch,
        <span class="hljs-attr">runtime</span>: runtime,
        <span class="hljs-attr">node_abi</span>: get_runtime_abi(runtime,options.target),
        <span class="hljs-attr">target</span>: options.target || <span class="hljs-string">''</span>,
        <span class="hljs-attr">platform</span>: options.target_platform || process.platform,
        <span class="hljs-attr">target_platform</span>: options.target_platform || process.platform,
        <span class="hljs-attr">arch</span>: options.target_arch || process.arch,
        <span class="hljs-attr">target_arch</span>: options.target_arch || process.arch,
        <span class="hljs-attr">module_main</span>: package_json.main,
        <span class="hljs-attr">toolset</span> : options.toolset || <span class="hljs-string">''</span> <span class="hljs-comment">// address https://github.com/mapbox/node-pre-gyp/issues/119</span>
    };
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>support host mirror with npm config <code>--{module_name}_binary_host_mirror</code>
e.g.: https://github.com/node-inspector/v8-profiler/blob/master/package.json#L25</p>
<blockquote>
<p>npm install v8-profiler --profiler_binary_host_mirror=https://npm.taobao.org/mirrors/node-inspector/</p>
</blockquote>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> host = process.env[<span class="hljs-string">'npm_config_'</span> + opts.module_name + <span class="hljs-string">'_binary_host_mirror'</span>] || package_json.binary.host;
    opts.host = fix_slashes(eval_template(host,opts));
    opts.module_path = eval_template(package_json.binary.module_path,opts);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>now we resolve the module_path to ensure it is absolute so that binding.gyp variables work predictably</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (options.module_root) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>resolve relative to known module root: works for pre-binding require</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        opts.module_path = path.join(options.module_root,opts.module_path);
    } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>resolve relative to current working directory: works for node-pre-gyp commands</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        opts.module_path = path.resolve(opts.module_path);
    }
    opts.module = path.join(opts.module_path,opts.module_name + <span class="hljs-string">'.node'</span>);
    opts.remote_path = package_json.binary.remote_path ? drop_double_slashes(fix_slashes(eval_template(package_json.binary.remote_path,opts))) : default_remote_path;
    <span class="hljs-keyword">var</span> package_name = package_json.binary.package_name ? package_json.binary.package_name : default_package_name;
    opts.package_name = eval_template(package_name,opts);
    opts.staged_tarball = path.join(<span class="hljs-string">'build/stage'</span>,opts.remote_path,opts.package_name);
    opts.hosted_path = url.resolve(opts.host,opts.remote_path);
    opts.hosted_tarball = url.resolve(opts.hosted_path,opts.package_name);
    <span class="hljs-keyword">return</span> opts;
};

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

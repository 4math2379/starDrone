<!DOCTYPE html>
<html>
<head>
  <title>key.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/sshpk/lib/key.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>key.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>Copyright 2015 Joyent, Inc.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-built_in">module</span>.exports = Key;

<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert-plus'</span>);
<span class="hljs-keyword">var</span> algs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./algs'</span>);
<span class="hljs-keyword">var</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);
<span class="hljs-keyword">var</span> Fingerprint = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./fingerprint'</span>);
<span class="hljs-keyword">var</span> Signature = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./signature'</span>);
<span class="hljs-keyword">var</span> DiffieHellman = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./dhe'</span>);
<span class="hljs-keyword">var</span> errs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./errors'</span>);
<span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./utils'</span>);
<span class="hljs-keyword">var</span> PrivateKey = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./private-key'</span>);
<span class="hljs-keyword">var</span> edCompat;

<span class="hljs-keyword">try</span> {
	edCompat = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./ed-compat'</span>);
} <span class="hljs-keyword">catch</span> (e) {
	<span class="hljs-comment">/* Just continue through, and bail out if we try to use it. */</span>
}

<span class="hljs-keyword">var</span> InvalidAlgorithmError = errs.InvalidAlgorithmError;
<span class="hljs-keyword">var</span> KeyParseError = errs.KeyParseError;

<span class="hljs-keyword">var</span> formats = {};
formats[<span class="hljs-string">'auto'</span>] = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./formats/auto'</span>);
formats[<span class="hljs-string">'pem'</span>] = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./formats/pem'</span>);
formats[<span class="hljs-string">'pkcs1'</span>] = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./formats/pkcs1'</span>);
formats[<span class="hljs-string">'pkcs8'</span>] = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./formats/pkcs8'</span>);
formats[<span class="hljs-string">'rfc4253'</span>] = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./formats/rfc4253'</span>);
formats[<span class="hljs-string">'ssh'</span>] = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./formats/ssh'</span>);
formats[<span class="hljs-string">'ssh-private'</span>] = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./formats/ssh-private'</span>);
formats[<span class="hljs-string">'openssh'</span>] = formats[<span class="hljs-string">'ssh-private'</span>];

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Key</span>(<span class="hljs-params">opts</span>) </span>{
	assert.object(opts, <span class="hljs-string">'options'</span>);
	assert.arrayOfObject(opts.parts, <span class="hljs-string">'options.parts'</span>);
	assert.string(opts.type, <span class="hljs-string">'options.type'</span>);
	assert.optionalString(opts.comment, <span class="hljs-string">'options.comment'</span>);

	<span class="hljs-keyword">var</span> algInfo = algs.info[opts.type];
	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> (algInfo) !== <span class="hljs-string">'object'</span>)
		<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> InvalidAlgorithmError(opts.type));

	<span class="hljs-keyword">var</span> partLookup = {};
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; opts.parts.length; ++i) {
		<span class="hljs-keyword">var</span> part = opts.parts[i];
		partLookup[part.name] = part;
	}

	<span class="hljs-keyword">this</span>.type = opts.type;
	<span class="hljs-keyword">this</span>.parts = opts.parts;
	<span class="hljs-keyword">this</span>.part = partLookup;
	<span class="hljs-keyword">this</span>.comment = <span class="hljs-literal">undefined</span>;
	<span class="hljs-keyword">this</span>.source = opts.source;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>for speeding up hashing/fingerprint operations<br>
this._rfc4253Cache = opts._rfc4253Cache;
this._hashCache = {};</p>
</div>
<div class="body">
<p>var sz;
this.curve = undefined;
if (this.type === 'ecdsa') {
var curve = this.part.curve.data.toString();
this.curve = curve;
sz = algs.curves[curve].size;
} else if (this.type === 'ed25519') {
sz = 256;
this.curve = 'curve25519';
} else {
var szPart = this.part[algInfo.sizePart];
sz = szPart.data.length;
sz = sz * 8 - utils.countZeros(szPart.data);
}
this.size = sz;
}</p>
<p>Key.formats = formats;</p>
<p>Key.prototype.toBuffer = function (format, options) {
if (format === undefined)
format = 'ssh';
assert.string(format, 'format');
assert.object(formats[format], 'formats[format]');
assert.optionalObject(options, 'options');</p>
<p>if (format === 'rfc4253') {
if (this._rfc4253Cache === undefined)
this._rfc4253Cache = formats['rfc4253'].write(this);
return (this._rfc4253Cache);
}</p>
<p>return (formats[format].write(this, options));
};</p>
<p>Key.prototype.toString = function (format, options) {
return (this.toBuffer(format, options).toString());
};</p>
<p>Key.prototype.hash = function (algo) {
assert.string(algo, 'algorithm');
algo = algo.toLowerCase();
if (algs.hashAlgs[algo] === undefined)
throw (new InvalidAlgorithmError(algo));</p>
<p>if (this._hashCache[algo])
return (this._hashCache[algo]);</p>
<p>var hash = crypto.createHash(algo).
update(this.toBuffer('rfc4253')).digest();
this._hashCache[algo] = hash;
return (hash);
};</p>
<p>Key.prototype.fingerprint = function (algo) {
if (algo === undefined)
algo = 'sha256';
assert.string(algo, 'algorithm');
var opts = {
hash: this.hash(algo),
algorithm: algo
};
return (new Fingerprint(opts));
};</p>
<p>Key.prototype.defaultHashAlgorithm = function () {
var hashAlgo = 'sha1';
if (this.type === 'rsa')
hashAlgo = 'sha256';
if (this.type === 'dsa' &amp;&amp; this.size &gt; 1024)
hashAlgo = 'sha256';
if (this.type === 'ed25519')
hashAlgo = 'sha512';
if (this.type === 'ecdsa') {
if (this.size &lt;= 256)
hashAlgo = 'sha256';
else if (this.size &lt;= 384)
hashAlgo = 'sha384';
else
hashAlgo = 'sha512';
}
return (hashAlgo);
};</p>
<p>Key.prototype.createVerify = function (hashAlgo) {
if (hashAlgo === undefined)
hashAlgo = this.defaultHashAlgorithm();
assert.string(hashAlgo, 'hash algorithm');</p>
<p>/* ED25519 is not supported by OpenSSL, use a javascript impl. */</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.type === <span class="hljs-string">'ed25519'</span> &amp;&amp; edCompat !== <span class="hljs-literal">undefined</span>)
		<span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> edCompat.Verifier(<span class="hljs-keyword">this</span>, hashAlgo));
	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.type === <span class="hljs-string">'curve25519'</span>)
		<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Curve25519 keys are not suitable for '</span> +
		    <span class="hljs-string">'signing or verification'</span>));

	<span class="hljs-keyword">var</span> v, nm, err;
	<span class="hljs-keyword">try</span> {
		nm = <span class="hljs-keyword">this</span>.type.toUpperCase() + <span class="hljs-string">'-'</span>;
		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.type === <span class="hljs-string">'ecdsa'</span>)
			nm = <span class="hljs-string">'ecdsa-with-'</span>;
		nm += hashAlgo.toUpperCase();
		v = crypto.createVerify(nm);
	} <span class="hljs-keyword">catch</span> (e) {
		err = e;
	}
	<span class="hljs-keyword">if</span> (v === <span class="hljs-literal">undefined</span> || (err <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span> &amp;&amp;
	    err.message.match(<span class="hljs-regexp">/Unknown message digest/</span>))) {
		nm = <span class="hljs-string">'RSA-'</span>;
		nm += hashAlgo.toUpperCase();
		v = crypto.createVerify(nm);
	}
	assert.ok(v, <span class="hljs-string">'failed to create verifier'</span>);
	<span class="hljs-keyword">var</span> oldVerify = v.verify.bind(v);
	<span class="hljs-keyword">var</span> key = <span class="hljs-keyword">this</span>.toBuffer(<span class="hljs-string">'pkcs8'</span>);
	<span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
	v.verify = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">signature, fmt</span>) </span>{
		<span class="hljs-keyword">if</span> (Signature.isSignature(signature, [<span class="hljs-number">2</span>, <span class="hljs-number">0</span>])) {
			<span class="hljs-keyword">if</span> (signature.type !== self.type)
				<span class="hljs-keyword">return</span> (<span class="hljs-literal">false</span>);
			<span class="hljs-keyword">if</span> (signature.hashAlgorithm &amp;&amp;
			    signature.hashAlgorithm !== hashAlgo)
				<span class="hljs-keyword">return</span> (<span class="hljs-literal">false</span>);
			<span class="hljs-keyword">return</span> (oldVerify(key, signature.toBuffer(<span class="hljs-string">'asn1'</span>)));

		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> (signature) === <span class="hljs-string">'string'</span> ||
		    Buffer.isBuffer(signature)) {
			<span class="hljs-keyword">return</span> (oldVerify(key, signature, fmt));

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<div class="dox">
<div class="summary">
<p>Avoid doing this on valid arguments, walking the prototype
chain can be quite slow.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Signature.isSignature(signature, [<span class="hljs-number">1</span>, <span class="hljs-number">0</span>])) {
			<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'signature was created by too old '</span> +
			    <span class="hljs-string">'a version of sshpk and cannot be verified'</span>));

		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'signature must be a string, '</span> +
			    <span class="hljs-string">'Buffer, or Signature object'</span>));
		}
	};
	<span class="hljs-keyword">return</span> (v);
};

Key.prototype.createDiffieHellman = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.type === <span class="hljs-string">'rsa'</span>)
		<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'RSA keys do not support Diffie-Hellman'</span>));

	<span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> DiffieHellman(<span class="hljs-keyword">this</span>));
};
Key.prototype.createDH = Key.prototype.createDiffieHellman;

Key.parse = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data, format, options</span>) </span>{
	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> (data) !== <span class="hljs-string">'string'</span>)
		assert.buffer(data, <span class="hljs-string">'data'</span>);
	<span class="hljs-keyword">if</span> (format === <span class="hljs-literal">undefined</span>)
		format = <span class="hljs-string">'auto'</span>;
	assert.string(format, <span class="hljs-string">'format'</span>);
	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> (options) === <span class="hljs-string">'string'</span>)
		options = { <span class="hljs-attr">filename</span>: options };
	assert.optionalObject(options, <span class="hljs-string">'options'</span>);
	<span class="hljs-keyword">if</span> (options === <span class="hljs-literal">undefined</span>)
		options = {};
	assert.optionalString(options.filename, <span class="hljs-string">'options.filename'</span>);
	<span class="hljs-keyword">if</span> (options.filename === <span class="hljs-literal">undefined</span>)
		options.filename = <span class="hljs-string">'(unnamed)'</span>;

	assert.object(formats[format], <span class="hljs-string">'formats[format]'</span>);

	<span class="hljs-keyword">try</span> {
		<span class="hljs-keyword">var</span> k = formats[format].read(data, options);
		<span class="hljs-keyword">if</span> (k <span class="hljs-keyword">instanceof</span> PrivateKey)
			k = k.toPublic();
		<span class="hljs-keyword">if</span> (!k.comment)
			k.comment = options.filename;
		<span class="hljs-keyword">return</span> (k);
	} <span class="hljs-keyword">catch</span> (e) {
		<span class="hljs-keyword">if</span> (e.name === <span class="hljs-string">'KeyEncryptedError'</span>)
			<span class="hljs-keyword">throw</span> (e);
		<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> KeyParseError(options.filename, format, e));
	}
};

Key.isKey = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj, ver</span>) </span>{
	<span class="hljs-keyword">return</span> (utils.isCompatible(obj, Key, ver));
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<div class="dox">
<div class="summary">
<p>API versions for Key:
[1,0] -- initial ver, may take Signature for createVerify or may not
[1,1] -- added pkcs1, pkcs8 formats
[1,2] -- added auto, ssh-private, openssh formats
[1,3] -- added defaultHashAlgorithm
[1,4] -- added ed support, createDH
[1,5] -- first explicitly tagged version</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">Key.prototype._sshpkApiVersion = [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>];

Key._oldVersionDetect = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj</span>) </span>{
	assert.func(obj.toBuffer);
	assert.func(obj.fingerprint);
	<span class="hljs-keyword">if</span> (obj.createDH)
		<span class="hljs-keyword">return</span> ([<span class="hljs-number">1</span>, <span class="hljs-number">4</span>]);
	<span class="hljs-keyword">if</span> (obj.defaultHashAlgorithm)
		<span class="hljs-keyword">return</span> ([<span class="hljs-number">1</span>, <span class="hljs-number">3</span>]);
	<span class="hljs-keyword">if</span> (obj.formats[<span class="hljs-string">'auto'</span>])
		<span class="hljs-keyword">return</span> ([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]);
	<span class="hljs-keyword">if</span> (obj.formats[<span class="hljs-string">'pkcs1'</span>])
		<span class="hljs-keyword">return</span> ([<span class="hljs-number">1</span>, <span class="hljs-number">1</span>]);
	<span class="hljs-keyword">return</span> ([<span class="hljs-number">1</span>, <span class="hljs-number">0</span>]);
};

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

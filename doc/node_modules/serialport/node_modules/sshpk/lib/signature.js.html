<!DOCTYPE html>
<html>
<head>
  <title>signature.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/sshpk/lib/signature.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>signature.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>Copyright 2015 Joyent, Inc.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-built_in">module</span>.exports = Signature;

<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert-plus'</span>);
<span class="hljs-keyword">var</span> algs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./algs'</span>);
<span class="hljs-keyword">var</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);
<span class="hljs-keyword">var</span> errs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./errors'</span>);
<span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./utils'</span>);
<span class="hljs-keyword">var</span> asn1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">'asn1'</span>);
<span class="hljs-keyword">var</span> SSHBuffer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./ssh-buffer'</span>);

<span class="hljs-keyword">var</span> InvalidAlgorithmError = errs.InvalidAlgorithmError;
<span class="hljs-keyword">var</span> SignatureParseError = errs.SignatureParseError;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Signature</span>(<span class="hljs-params">opts</span>) </span>{
	assert.object(opts, <span class="hljs-string">'options'</span>);
	assert.arrayOfObject(opts.parts, <span class="hljs-string">'options.parts'</span>);
	assert.string(opts.type, <span class="hljs-string">'options.type'</span>);

	<span class="hljs-keyword">var</span> partLookup = {};
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; opts.parts.length; ++i) {
		<span class="hljs-keyword">var</span> part = opts.parts[i];
		partLookup[part.name] = part;
	}

	<span class="hljs-keyword">this</span>.type = opts.type;
	<span class="hljs-keyword">this</span>.hashAlgorithm = opts.hashAlgo;
	<span class="hljs-keyword">this</span>.parts = opts.parts;
	<span class="hljs-keyword">this</span>.part = partLookup;
}

Signature.prototype.toBuffer = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">format</span>) </span>{
	<span class="hljs-keyword">if</span> (format === <span class="hljs-literal">undefined</span>)
		format = <span class="hljs-string">'asn1'</span>;
	assert.string(format, <span class="hljs-string">'format'</span>);

	<span class="hljs-keyword">var</span> buf;

	<span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>.type) {
	<span class="hljs-keyword">case</span> <span class="hljs-string">'rsa'</span>:
	<span class="hljs-keyword">case</span> <span class="hljs-string">'ed25519'</span>:
		<span class="hljs-keyword">if</span> (format === <span class="hljs-string">'ssh'</span>) {
			buf = <span class="hljs-keyword">new</span> SSHBuffer({});
			buf.writeString(<span class="hljs-string">'ssh-'</span> + <span class="hljs-keyword">this</span>.type);
			buf.writePart(<span class="hljs-keyword">this</span>.part.sig);
			<span class="hljs-keyword">return</span> (buf.toBuffer());
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">return</span> (<span class="hljs-keyword">this</span>.part.sig.data);
		}

	<span class="hljs-keyword">case</span> <span class="hljs-string">'dsa'</span>:
	<span class="hljs-keyword">case</span> <span class="hljs-string">'ecdsa'</span>:
		<span class="hljs-keyword">var</span> r, s;
		<span class="hljs-keyword">if</span> (format === <span class="hljs-string">'asn1'</span>) {
			<span class="hljs-keyword">var</span> der = <span class="hljs-keyword">new</span> asn1.BerWriter();
			der.startSequence();
			r = utils.mpNormalize(<span class="hljs-keyword">this</span>.part.r.data);
			s = utils.mpNormalize(<span class="hljs-keyword">this</span>.part.s.data);
			der.writeBuffer(r, asn1.Ber.Integer);
			der.writeBuffer(s, asn1.Ber.Integer);
			der.endSequence();
			<span class="hljs-keyword">return</span> (der.buffer);
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (format === <span class="hljs-string">'ssh'</span> &amp;&amp; <span class="hljs-keyword">this</span>.type === <span class="hljs-string">'dsa'</span>) {
			buf = <span class="hljs-keyword">new</span> SSHBuffer({});
			buf.writeString(<span class="hljs-string">'ssh-dss'</span>);
			r = <span class="hljs-keyword">this</span>.part.r.data;
			<span class="hljs-keyword">if</span> (r[<span class="hljs-number">0</span>] === <span class="hljs-number">0x00</span>)
				r = r.slice(<span class="hljs-number">1</span>);
			s = <span class="hljs-keyword">this</span>.part.s.data;
			buf.writeBuffer(Buffer.concat([r, s]));
			<span class="hljs-keyword">return</span> (buf.toBuffer());
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (format === <span class="hljs-string">'ssh'</span> &amp;&amp; <span class="hljs-keyword">this</span>.type === <span class="hljs-string">'ecdsa'</span>) {
			<span class="hljs-keyword">var</span> inner = <span class="hljs-keyword">new</span> SSHBuffer({});
			r = <span class="hljs-keyword">this</span>.part.r;
			<span class="hljs-keyword">if</span> (r[<span class="hljs-number">0</span>] === <span class="hljs-number">0x00</span>)
				r = r.slice(<span class="hljs-number">1</span>);
			inner.writePart(r);
			inner.writePart(<span class="hljs-keyword">this</span>.part.s);

			buf = <span class="hljs-keyword">new</span> SSHBuffer({});
			<span class="hljs-comment">/* <span class="hljs-doctag">XXX:</span> find a more proper way to do this? */</span>
			<span class="hljs-keyword">var</span> curve;
			<span class="hljs-keyword">var</span> sz = <span class="hljs-keyword">this</span>.part.r.data.length * <span class="hljs-number">8</span>;
			<span class="hljs-keyword">if</span> (sz === <span class="hljs-number">256</span>)
				curve = <span class="hljs-string">'nistp256'</span>;
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sz === <span class="hljs-number">384</span>)
				curve = <span class="hljs-string">'nistp384'</span>;
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sz === <span class="hljs-number">528</span>)
				curve = <span class="hljs-string">'nistp521'</span>;
			buf.writeString(<span class="hljs-string">'ecdsa-sha2-'</span> + curve);
			buf.writeBuffer(inner.toBuffer());
			<span class="hljs-keyword">return</span> (buf.toBuffer());
		}
		<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid signature format'</span>));
	<span class="hljs-keyword">default</span>:
		<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid signature data'</span>));
	}
};

Signature.prototype.toString = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">format</span>) </span>{
	assert.optionalString(format, <span class="hljs-string">'format'</span>);
	<span class="hljs-keyword">return</span> (<span class="hljs-keyword">this</span>.toBuffer(format).toString(<span class="hljs-string">'base64'</span>));
};

Signature.parse = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data, type, format</span>) </span>{
	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> (data) === <span class="hljs-string">'string'</span>)
		data = <span class="hljs-keyword">new</span> Buffer(data, <span class="hljs-string">'base64'</span>);
	assert.buffer(data, <span class="hljs-string">'data'</span>);
	assert.string(format, <span class="hljs-string">'format'</span>);
	assert.string(type, <span class="hljs-string">'type'</span>);

	<span class="hljs-keyword">var</span> opts = {};
	opts.type = type.toLowerCase();
	opts.parts = [];

	<span class="hljs-keyword">try</span> {
		assert.ok(data.length &gt; <span class="hljs-number">0</span>, <span class="hljs-string">'signature must not be empty'</span>);
		<span class="hljs-keyword">switch</span> (opts.type) {
		<span class="hljs-keyword">case</span> <span class="hljs-string">'rsa'</span>:
			<span class="hljs-keyword">return</span> (parseOneNum(data, type, format, opts,
			    <span class="hljs-string">'ssh-rsa'</span>));
		<span class="hljs-keyword">case</span> <span class="hljs-string">'ed25519'</span>:
			<span class="hljs-keyword">return</span> (parseOneNum(data, type, format, opts,
			    <span class="hljs-string">'ssh-ed25519'</span>));

		<span class="hljs-keyword">case</span> <span class="hljs-string">'dsa'</span>:
		<span class="hljs-keyword">case</span> <span class="hljs-string">'ecdsa'</span>:
			<span class="hljs-keyword">if</span> (format === <span class="hljs-string">'asn1'</span>)
				<span class="hljs-keyword">return</span> (parseDSAasn1(data, type, format, opts));
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (opts.type === <span class="hljs-string">'dsa'</span>)
				<span class="hljs-keyword">return</span> (parseDSA(data, type, format, opts));
			<span class="hljs-keyword">else</span>
				<span class="hljs-keyword">return</span> (parseECDSA(data, type, format, opts));

		<span class="hljs-keyword">default</span>:
			<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> InvalidAlgorithmError(type));
		}

	} <span class="hljs-keyword">catch</span> (e) {
		<span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> InvalidAlgorithmError)
			<span class="hljs-keyword">throw</span> (e);
		<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> SignatureParseError(type, format, e));
	}
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseOneNum</span>(<span class="hljs-params">data, type, format, opts, headType</span>) </span>{
	<span class="hljs-keyword">if</span> (format === <span class="hljs-string">'ssh'</span>) {
		<span class="hljs-keyword">try</span> {
			<span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">new</span> SSHBuffer({<span class="hljs-attr">buffer</span>: data});
			<span class="hljs-keyword">var</span> head = buf.readString();
		} <span class="hljs-keyword">catch</span> (e) {
			<span class="hljs-comment">/* fall through */</span>
		}
		<span class="hljs-keyword">if</span> (head === headType) {
			<span class="hljs-keyword">var</span> sig = buf.readPart();
			assert.ok(buf.atEnd(), <span class="hljs-string">'extra trailing bytes'</span>);
			sig.name = <span class="hljs-string">'sig'</span>;
			opts.parts.push(sig);
			<span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> Signature(opts));
		}
	}
	opts.parts.push({<span class="hljs-attr">name</span>: <span class="hljs-string">'sig'</span>, <span class="hljs-attr">data</span>: data});
	<span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> Signature(opts));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseDSAasn1</span>(<span class="hljs-params">data, type, format, opts</span>) </span>{
	<span class="hljs-keyword">var</span> der = <span class="hljs-keyword">new</span> asn1.BerReader(data);
	der.readSequence();
	<span class="hljs-keyword">var</span> r = der.readString(asn1.Ber.Integer, <span class="hljs-literal">true</span>);
	<span class="hljs-keyword">var</span> s = der.readString(asn1.Ber.Integer, <span class="hljs-literal">true</span>);

	opts.parts.push({<span class="hljs-attr">name</span>: <span class="hljs-string">'r'</span>, <span class="hljs-attr">data</span>: utils.mpNormalize(r)});
	opts.parts.push({<span class="hljs-attr">name</span>: <span class="hljs-string">'s'</span>, <span class="hljs-attr">data</span>: utils.mpNormalize(s)});

	<span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> Signature(opts));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseDSA</span>(<span class="hljs-params">data, type, format, opts</span>) </span>{
	<span class="hljs-keyword">if</span> (data.length != <span class="hljs-number">40</span>) {
		<span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">new</span> SSHBuffer({<span class="hljs-attr">buffer</span>: data});
		<span class="hljs-keyword">var</span> d = buf.readBuffer();
		<span class="hljs-keyword">if</span> (d.toString(<span class="hljs-string">'ascii'</span>) === <span class="hljs-string">'ssh-dss'</span>)
			d = buf.readBuffer();
		assert.ok(buf.atEnd(), <span class="hljs-string">'extra trailing bytes'</span>);
		assert.strictEqual(d.length, <span class="hljs-number">40</span>, <span class="hljs-string">'invalid inner length'</span>);
		data = d;
	}
	opts.parts.push({<span class="hljs-attr">name</span>: <span class="hljs-string">'r'</span>, <span class="hljs-attr">data</span>: data.slice(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>)});
	opts.parts.push({<span class="hljs-attr">name</span>: <span class="hljs-string">'s'</span>, <span class="hljs-attr">data</span>: data.slice(<span class="hljs-number">20</span>, <span class="hljs-number">40</span>)});
	<span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> Signature(opts));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseECDSA</span>(<span class="hljs-params">data, type, format, opts</span>) </span>{
	<span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">new</span> SSHBuffer({<span class="hljs-attr">buffer</span>: data});

	<span class="hljs-keyword">var</span> r, s;
	<span class="hljs-keyword">var</span> inner = buf.readBuffer();
	<span class="hljs-keyword">if</span> (inner.toString(<span class="hljs-string">'ascii'</span>).match(<span class="hljs-regexp">/^ecdsa-/</span>)) {
		inner = buf.readBuffer();
		assert.ok(buf.atEnd(), <span class="hljs-string">'extra trailing bytes on outer'</span>);
		buf = <span class="hljs-keyword">new</span> SSHBuffer({<span class="hljs-attr">buffer</span>: inner});
		r = buf.readPart();
	} <span class="hljs-keyword">else</span> {
		r = {<span class="hljs-attr">data</span>: inner};
	}

	s = buf.readPart();
	assert.ok(buf.atEnd(), <span class="hljs-string">'extra trailing bytes'</span>);

	r.name = <span class="hljs-string">'r'</span>;
	s.name = <span class="hljs-string">'s'</span>;

	opts.parts.push(r);
	opts.parts.push(s);
	<span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> Signature(opts));
}

Signature.isSignature = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj, ver</span>) </span>{
	<span class="hljs-keyword">return</span> (utils.isCompatible(obj, Signature, ver));
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>API versions for Signature:
[1,0] -- initial ver
[2,0] -- support for rsa in full ssh format, compat with sshpk-agent
hashAlgorithm property
[2,1] -- first tagged version</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">Signature.prototype._sshpkApiVersion = [<span class="hljs-number">2</span>, <span class="hljs-number">1</span>];

Signature._oldVersionDetect = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj</span>) </span>{
	assert.func(obj.toBuffer);
	<span class="hljs-keyword">if</span> (obj.hasOwnProperty(<span class="hljs-string">'hashAlgorithm'</span>))
		<span class="hljs-keyword">return</span> ([<span class="hljs-number">2</span>, <span class="hljs-number">0</span>]);
	<span class="hljs-keyword">return</span> ([<span class="hljs-number">1</span>, <span class="hljs-number">0</span>]);
};

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>fingerprint.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/sshpk/lib/fingerprint.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>fingerprint.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>Copyright 2015 Joyent, Inc.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-built_in">module</span>.exports = Fingerprint;

<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert-plus'</span>);
<span class="hljs-keyword">var</span> algs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./algs'</span>);
<span class="hljs-keyword">var</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);
<span class="hljs-keyword">var</span> errs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./errors'</span>);
<span class="hljs-keyword">var</span> Key = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./key'</span>);
<span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./utils'</span>);

<span class="hljs-keyword">var</span> FingerprintFormatError = errs.FingerprintFormatError;
<span class="hljs-keyword">var</span> InvalidAlgorithmError = errs.InvalidAlgorithmError;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Fingerprint</span>(<span class="hljs-params">opts</span>) </span>{
	assert.object(opts, <span class="hljs-string">'options'</span>);
	assert.buffer(opts.hash, <span class="hljs-string">'options.hash'</span>);
	assert.string(opts.algorithm, <span class="hljs-string">'options.algorithm'</span>);

	<span class="hljs-keyword">this</span>.algorithm = opts.algorithm.toLowerCase();
	<span class="hljs-keyword">if</span> (algs.hashAlgs[<span class="hljs-keyword">this</span>.algorithm] !== <span class="hljs-literal">true</span>)
		<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> InvalidAlgorithmError(<span class="hljs-keyword">this</span>.algorithm));

	<span class="hljs-keyword">this</span>.hash = opts.hash;
}

Fingerprint.prototype.toString = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">format</span>) </span>{
	<span class="hljs-keyword">if</span> (format === <span class="hljs-literal">undefined</span>) {
		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.algorithm === <span class="hljs-string">'md5'</span>)
			format = <span class="hljs-string">'hex'</span>;
		<span class="hljs-keyword">else</span>
			format = <span class="hljs-string">'base64'</span>;
	}
	assert.string(format);

	<span class="hljs-keyword">switch</span> (format) {
	<span class="hljs-keyword">case</span> <span class="hljs-string">'hex'</span>:
		<span class="hljs-keyword">return</span> (addColons(<span class="hljs-keyword">this</span>.hash.toString(<span class="hljs-string">'hex'</span>)));
	<span class="hljs-keyword">case</span> <span class="hljs-string">'base64'</span>:
		<span class="hljs-keyword">return</span> (sshBase64Format(<span class="hljs-keyword">this</span>.algorithm,
		    <span class="hljs-keyword">this</span>.hash.toString(<span class="hljs-string">'base64'</span>)));
	<span class="hljs-keyword">default</span>:
		<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> FingerprintFormatError(<span class="hljs-literal">undefined</span>, format));
	}
};

Fingerprint.prototype.matches = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key</span>) </span>{
	assert.object(key, <span class="hljs-string">'key'</span>);
	utils.assertCompatible(key, Key, [<span class="hljs-number">1</span>, <span class="hljs-number">0</span>], <span class="hljs-string">'key'</span>);

	<span class="hljs-keyword">var</span> theirHash = key.hash(<span class="hljs-keyword">this</span>.algorithm);
	<span class="hljs-keyword">var</span> theirHash2 = crypto.createHash(<span class="hljs-keyword">this</span>.algorithm).
	    update(theirHash).digest(<span class="hljs-string">'base64'</span>);

	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hash2 === <span class="hljs-literal">undefined</span>)
		<span class="hljs-keyword">this</span>.hash2 = crypto.createHash(<span class="hljs-keyword">this</span>.algorithm).
		    update(<span class="hljs-keyword">this</span>.hash).digest(<span class="hljs-string">'base64'</span>);

	<span class="hljs-keyword">return</span> (<span class="hljs-keyword">this</span>.hash2 === theirHash2);
};

Fingerprint.parse = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fp, enAlgs</span>) </span>{
	assert.string(fp, <span class="hljs-string">'fingerprint'</span>);

	<span class="hljs-keyword">var</span> alg, hash;
	assert.optionalArrayOfString(enAlgs, <span class="hljs-string">'algorithms'</span>);

	<span class="hljs-keyword">var</span> parts = fp.split(<span class="hljs-string">':'</span>);
	<span class="hljs-keyword">if</span> (parts.length == <span class="hljs-number">2</span>) {
		alg = parts[<span class="hljs-number">0</span>].toLowerCase();
		<span class="hljs-comment">/*JSSTYLED*/</span>
		<span class="hljs-keyword">var</span> base64RE = <span class="hljs-regexp">/^[A-Za-z0-9+\/=]+$/</span>;
		<span class="hljs-keyword">if</span> (!base64RE.test(parts[<span class="hljs-number">1</span>]))
			<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> FingerprintFormatError(fp));
		<span class="hljs-keyword">try</span> {
			hash = <span class="hljs-keyword">new</span> Buffer(parts[<span class="hljs-number">1</span>], <span class="hljs-string">'base64'</span>);
		} <span class="hljs-keyword">catch</span> (e) {
			<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> FingerprintFormatError(fp));
		}
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parts.length &gt; <span class="hljs-number">2</span>) {
		alg = <span class="hljs-string">'md5'</span>;
		<span class="hljs-keyword">if</span> (parts[<span class="hljs-number">0</span>].toLowerCase() === <span class="hljs-string">'md5'</span>)
			parts = parts.slice(<span class="hljs-number">1</span>);
		parts = parts.join(<span class="hljs-string">''</span>);
		<span class="hljs-comment">/*JSSTYLED*/</span>
		<span class="hljs-keyword">var</span> md5RE = <span class="hljs-regexp">/^[a-fA-F0-9]+$/</span>;
		<span class="hljs-keyword">if</span> (!md5RE.test(parts))
			<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> FingerprintFormatError(fp));
		<span class="hljs-keyword">try</span> {
			hash = <span class="hljs-keyword">new</span> Buffer(parts, <span class="hljs-string">'hex'</span>);
		} <span class="hljs-keyword">catch</span> (e) {
			<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> FingerprintFormatError(fp));
		}
	}

	<span class="hljs-keyword">if</span> (alg === <span class="hljs-literal">undefined</span>)
		<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> FingerprintFormatError(fp));

	<span class="hljs-keyword">if</span> (algs.hashAlgs[alg] === <span class="hljs-literal">undefined</span>)
		<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> InvalidAlgorithmError(alg));

	<span class="hljs-keyword">if</span> (enAlgs !== <span class="hljs-literal">undefined</span>) {
		enAlgs = enAlgs.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a</span>) </span>{ <span class="hljs-keyword">return</span> a.toLowerCase(); });
		<span class="hljs-keyword">if</span> (enAlgs.indexOf(alg) === <span class="hljs-number">-1</span>)
			<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> InvalidAlgorithmError(alg));
	}

	<span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> Fingerprint({<span class="hljs-attr">algorithm</span>: alg, <span class="hljs-attr">hash</span>: hash}));
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addColons</span>(<span class="hljs-params">s</span>) </span>{
	<span class="hljs-comment">/*JSSTYLED*/</span>
	<span class="hljs-keyword">return</span> (s.replace(<span class="hljs-regexp">/(.{2})(?=.)/g</span>, <span class="hljs-string">'$1:'</span>));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">base64Strip</span>(<span class="hljs-params">s</span>) </span>{
	<span class="hljs-comment">/*JSSTYLED*/</span>
	<span class="hljs-keyword">return</span> (s.replace(<span class="hljs-regexp">/=*$/</span>, <span class="hljs-string">''</span>));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sshBase64Format</span>(<span class="hljs-params">alg, h</span>) </span>{
	<span class="hljs-keyword">return</span> (alg.toUpperCase() + <span class="hljs-string">':'</span> + base64Strip(h));
}

Fingerprint.isFingerprint = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj, ver</span>) </span>{
	<span class="hljs-keyword">return</span> (utils.isCompatible(obj, Fingerprint, ver));
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>API versions for Fingerprint:
[1,0] -- initial ver
[1,1] -- first tagged ver</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">Fingerprint.prototype._sshpkApiVersion = [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>];

Fingerprint._oldVersionDetect = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj</span>) </span>{
	assert.func(obj.toString);
	assert.func(obj.matches);
	<span class="hljs-keyword">return</span> ([<span class="hljs-number">1</span>, <span class="hljs-number">0</span>]);
};

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>ssh.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../../doc-style.css" />
  <script src="../../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../../";
    var thisFile = "node_modules/serialport/node_modules/sshpk/lib/formats/ssh.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>ssh.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>Copyright 2015 Joyent, Inc.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-built_in">module</span>.exports = {
	<span class="hljs-attr">read</span>: read,
	<span class="hljs-attr">write</span>: write
};

<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert-plus'</span>);
<span class="hljs-keyword">var</span> rfc4253 = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./rfc4253'</span>);
<span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../utils'</span>);
<span class="hljs-keyword">var</span> Key = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../key'</span>);
<span class="hljs-keyword">var</span> PrivateKey = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../private-key'</span>);

<span class="hljs-keyword">var</span> sshpriv = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./ssh-private'</span>);

<span class="hljs-comment">/*JSSTYLED*/</span>
<span class="hljs-keyword">var</span> SSHKEY_RE = <span class="hljs-regexp">/^([a-z0-9-]+)[ \t]+([a-zA-Z0-9+\/]+[=]*)([\n \t]+([^\n]+))?$/</span>;
<span class="hljs-comment">/*JSSTYLED*/</span>
<span class="hljs-keyword">var</span> SSHKEY_RE2 = <span class="hljs-regexp">/^([a-z0-9-]+)[ \t]+([a-zA-Z0-9+\/ \t\n]+[=]*)(.*)$/</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span>(<span class="hljs-params">buf, options</span>) </span>{
	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> (buf) !== <span class="hljs-string">'string'</span>) {
		assert.buffer(buf, <span class="hljs-string">'buf'</span>);
		buf = buf.toString(<span class="hljs-string">'ascii'</span>);
	}

	<span class="hljs-keyword">var</span> trimmed = buf.trim().replace(<span class="hljs-regexp">/[\\\r]/g</span>, <span class="hljs-string">''</span>);
	<span class="hljs-keyword">var</span> m = trimmed.match(SSHKEY_RE);
	<span class="hljs-keyword">if</span> (!m)
		m = trimmed.match(SSHKEY_RE2);
	assert.ok(m, <span class="hljs-string">'key must match regex'</span>);

	<span class="hljs-keyword">var</span> type = rfc4253.algToKeyType(m[<span class="hljs-number">1</span>]);
	<span class="hljs-keyword">var</span> kbuf = <span class="hljs-keyword">new</span> Buffer(m[<span class="hljs-number">2</span>], <span class="hljs-string">'base64'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>This is a bit tricky. If we managed to parse the key and locate the
key comment with the regex, then do a non-partial read and assert
that we have consumed all bytes. If we couldn't locate the key
comment, though, there may be whitespace shenanigans going on that
have conjoined the comment to the rest of the key. We do a partial
read in this case to try to make the best out of a sorry situation.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">	<span class="hljs-keyword">var</span> key;
	<span class="hljs-keyword">var</span> ret = {};
	<span class="hljs-keyword">if</span> (m[<span class="hljs-number">4</span>]) {
		<span class="hljs-keyword">try</span> {
			key = rfc4253.read(kbuf);

		} <span class="hljs-keyword">catch</span> (e) {
			m = trimmed.match(SSHKEY_RE2);
			assert.ok(m, <span class="hljs-string">'key must match regex'</span>);
			kbuf = <span class="hljs-keyword">new</span> Buffer(m[<span class="hljs-number">2</span>], <span class="hljs-string">'base64'</span>);
			key = rfc4253.readInternal(ret, <span class="hljs-string">'public'</span>, kbuf);
		}
	} <span class="hljs-keyword">else</span> {
		key = rfc4253.readInternal(ret, <span class="hljs-string">'public'</span>, kbuf);
	}

	assert.strictEqual(type, key.type);

	<span class="hljs-keyword">if</span> (m[<span class="hljs-number">4</span>] &amp;&amp; m[<span class="hljs-number">4</span>].length &gt; <span class="hljs-number">0</span>) {
		key.comment = m[<span class="hljs-number">4</span>];

	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ret.consumed) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<div class="dox">
<div class="summary">
<p>Now the magic: trying to recover the key comment when it's
gotten conjoined to the key or otherwise shenanigan'd.</p>
</div>
<div class="body">
<p>Work out how much base64 we used, then drop all non-base64
chars from the beginning up to this point in the the string.
Then offset in this and try to make up for missing = chars.</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">		<span class="hljs-keyword">var</span> data = m[<span class="hljs-number">2</span>] + m[<span class="hljs-number">3</span>];
		<span class="hljs-keyword">var</span> realOffset = <span class="hljs-built_in">Math</span>.ceil(ret.consumed / <span class="hljs-number">3</span>) * <span class="hljs-number">4</span>;
		data = data.slice(<span class="hljs-number">0</span>, realOffset - <span class="hljs-number">2</span>). <span class="hljs-comment">/*JSSTYLED*/</span>
		    replace(<span class="hljs-regexp">/[^a-zA-Z0-9+\/=]/g</span>, <span class="hljs-string">''</span>) +
		    data.slice(realOffset - <span class="hljs-number">2</span>);

		<span class="hljs-keyword">var</span> padding = ret.consumed % <span class="hljs-number">3</span>;
		<span class="hljs-keyword">if</span> (padding &gt; <span class="hljs-number">0</span> &amp;&amp;
		    data.slice(realOffset - <span class="hljs-number">1</span>, realOffset) !== <span class="hljs-string">'='</span>)
			realOffset--;
		<span class="hljs-keyword">while</span> (data.slice(realOffset, realOffset + <span class="hljs-number">1</span>) === <span class="hljs-string">'='</span>)
			realOffset++;

		<span class="hljs-comment">/* Finally, grab what we think is the comment &amp; clean it up. */</span>
		<span class="hljs-keyword">var</span> trailer = data.slice(realOffset);
		trailer = trailer.replace(<span class="hljs-regexp">/[\r\n]/g</span>, <span class="hljs-string">' '</span>).
		    replace(<span class="hljs-regexp">/^\s+/</span>, <span class="hljs-string">''</span>);
		<span class="hljs-keyword">if</span> (trailer.match(<span class="hljs-regexp">/^[a-zA-Z0-9]/</span>))
			key.comment = trailer;
	}

	<span class="hljs-keyword">return</span> (key);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params">key, options</span>) </span>{
	assert.object(key);
	<span class="hljs-keyword">if</span> (!Key.isKey(key))
		<span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Must be a public key'</span>));

	<span class="hljs-keyword">var</span> parts = [];
	<span class="hljs-keyword">var</span> alg = rfc4253.keyTypeToAlg(key);
	parts.push(alg);

	<span class="hljs-keyword">var</span> buf = rfc4253.write(key);
	parts.push(buf.toString(<span class="hljs-string">'base64'</span>));

	<span class="hljs-keyword">if</span> (key.comment)
		parts.push(key.comment);

	<span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> Buffer(parts.join(<span class="hljs-string">' '</span>)));
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

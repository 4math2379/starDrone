<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../";
    var thisFile = "node_modules/serialport/node_modules/tunnel-agent/index.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">'use strict'</span>

<span class="hljs-keyword">var</span> net = <span class="hljs-built_in">require</span>(<span class="hljs-string">'net'</span>)
  , tls = <span class="hljs-built_in">require</span>(<span class="hljs-string">'tls'</span>)
  , http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>)
  , https = <span class="hljs-built_in">require</span>(<span class="hljs-string">'https'</span>)
  , events = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>)
  , assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>)
  , util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)
  ;

exports.httpOverHttp = httpOverHttp
exports.httpsOverHttp = httpsOverHttp
exports.httpOverHttps = httpOverHttps
exports.httpsOverHttps = httpsOverHttps


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">httpOverHttp</span>(<span class="hljs-params">options</span>) </span>{
  <span class="hljs-keyword">var</span> agent = <span class="hljs-keyword">new</span> TunnelingAgent(options)
  agent.request = http.request
  <span class="hljs-keyword">return</span> agent
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">httpsOverHttp</span>(<span class="hljs-params">options</span>) </span>{
  <span class="hljs-keyword">var</span> agent = <span class="hljs-keyword">new</span> TunnelingAgent(options)
  agent.request = http.request
  agent.createSocket = createSecureSocket
  agent.defaultPort = <span class="hljs-number">443</span>
  <span class="hljs-keyword">return</span> agent
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">httpOverHttps</span>(<span class="hljs-params">options</span>) </span>{
  <span class="hljs-keyword">var</span> agent = <span class="hljs-keyword">new</span> TunnelingAgent(options)
  agent.request = https.request
  <span class="hljs-keyword">return</span> agent
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">httpsOverHttps</span>(<span class="hljs-params">options</span>) </span>{
  <span class="hljs-keyword">var</span> agent = <span class="hljs-keyword">new</span> TunnelingAgent(options)
  agent.request = https.request
  agent.createSocket = createSecureSocket
  agent.defaultPort = <span class="hljs-number">443</span>
  <span class="hljs-keyword">return</span> agent
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TunnelingAgent</span>(<span class="hljs-params">options</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  self.options = options || {}
  self.proxyOptions = self.options.proxy || {}
  self.maxSockets = self.options.maxSockets || http.Agent.defaultMaxSockets
  self.requests = []
  self.sockets = []

  self.on(<span class="hljs-string">'free'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onFree</span>(<span class="hljs-params">socket, host, port</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = self.requests.length; i &lt; len; ++i) {
      <span class="hljs-keyword">var</span> pending = self.requests[i]
      <span class="hljs-keyword">if</span> (pending.host === host &amp;&amp; pending.port === port) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Detect the request to connect same origin server,
reuse the connection.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        self.requests.splice(i, <span class="hljs-number">1</span>)
        pending.request.onSocket(socket)
        <span class="hljs-keyword">return</span>
      }
    }
    socket.destroy()
    self.removeSocket(socket)
  })
}
util.inherits(TunnelingAgent, events.EventEmitter)

TunnelingAgent.prototype.addRequest = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addRequest</span>(<span class="hljs-params">req, options</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Legacy API: addRequest(req, host, port, path)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'string'</span>) {
    options = {
      <span class="hljs-attr">host</span>: options,
      <span class="hljs-attr">port</span>: <span class="hljs-built_in">arguments</span>[<span class="hljs-number">2</span>],
      <span class="hljs-attr">path</span>: <span class="hljs-built_in">arguments</span>[<span class="hljs-number">3</span>]
    };
  }

  <span class="hljs-keyword">if</span> (self.sockets.length &gt;= <span class="hljs-keyword">this</span>.maxSockets) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>We are over limit so we'll add it to the queue.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    self.requests.push({<span class="hljs-attr">host</span>: options.host, <span class="hljs-attr">port</span>: options.port, <span class="hljs-attr">request</span>: req})
    <span class="hljs-keyword">return</span>
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>If we are under maxSockets create a new one.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  self.createConnection({<span class="hljs-attr">host</span>: options.host, <span class="hljs-attr">port</span>: options.port, <span class="hljs-attr">request</span>: req})
}

TunnelingAgent.prototype.createConnection = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createConnection</span>(<span class="hljs-params">pending</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

  self.createSocket(pending, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">socket</span>) </span>{
    socket.on(<span class="hljs-string">'free'</span>, onFree)
    socket.on(<span class="hljs-string">'close'</span>, onCloseOrRemove)
    socket.on(<span class="hljs-string">'agentRemove'</span>, onCloseOrRemove)
    pending.request.onSocket(socket)

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onFree</span>(<span class="hljs-params"></span>) </span>{
      self.emit(<span class="hljs-string">'free'</span>, socket, pending.host, pending.port)
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onCloseOrRemove</span>(<span class="hljs-params">err</span>) </span>{
      self.removeSocket(socket)
      socket.removeListener(<span class="hljs-string">'free'</span>, onFree)
      socket.removeListener(<span class="hljs-string">'close'</span>, onCloseOrRemove)
      socket.removeListener(<span class="hljs-string">'agentRemove'</span>, onCloseOrRemove)
    }
  })
}

TunnelingAgent.prototype.createSocket = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createSocket</span>(<span class="hljs-params">options, cb</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">var</span> placeholder = {}
  self.sockets.push(placeholder)

  <span class="hljs-keyword">var</span> connectOptions = mergeOptions({}, self.proxyOptions, 
    { <span class="hljs-attr">method</span>: <span class="hljs-string">'CONNECT'</span>
    , <span class="hljs-attr">path</span>: options.host + <span class="hljs-string">':'</span> + options.port
    , <span class="hljs-attr">agent</span>: <span class="hljs-literal">false</span>
    }
  )
  <span class="hljs-keyword">if</span> (connectOptions.proxyAuth) {
    connectOptions.headers = connectOptions.headers || {}
    connectOptions.headers[<span class="hljs-string">'Proxy-Authorization'</span>] = <span class="hljs-string">'Basic '</span> +
        <span class="hljs-keyword">new</span> Buffer(connectOptions.proxyAuth).toString(<span class="hljs-string">'base64'</span>)
  }

  debug(<span class="hljs-string">'making CONNECT request'</span>)
  <span class="hljs-keyword">var</span> connectReq = self.request(connectOptions)
  connectReq.useChunkedEncodingByDefault = <span class="hljs-literal">false</span> <span class="hljs-comment">// for v0.6</span>
  connectReq.once(<span class="hljs-string">'response'</span>, onResponse) <span class="hljs-comment">// for v0.6</span>
  connectReq.once(<span class="hljs-string">'upgrade'</span>, onUpgrade)   <span class="hljs-comment">// for v0.6</span>
  connectReq.once(<span class="hljs-string">'connect'</span>, onConnect)   <span class="hljs-comment">// for v0.7 or later</span>
  connectReq.once(<span class="hljs-string">'error'</span>, onError)
  connectReq.end()

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onResponse</span>(<span class="hljs-params">res</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Very hacky. This is necessary to avoid http-parser leaks.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    res.upgrade = <span class="hljs-literal">true</span>
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onUpgrade</span>(<span class="hljs-params">res, socket, head</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Hacky.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      onConnect(res, socket, head)
    })
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onConnect</span>(<span class="hljs-params">res, socket, head</span>) </span>{
    connectReq.removeAllListeners()
    socket.removeAllListeners()

    <span class="hljs-keyword">if</span> (res.statusCode === <span class="hljs-number">200</span>) {
      assert.equal(head.length, <span class="hljs-number">0</span>)
      debug(<span class="hljs-string">'tunneling connection has established'</span>)
      self.sockets[self.sockets.indexOf(placeholder)] = socket
      cb(socket)
    } <span class="hljs-keyword">else</span> {
      debug(<span class="hljs-string">'tunneling socket could not be established, statusCode=%d'</span>, res.statusCode)
      <span class="hljs-keyword">var</span> error = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'tunneling socket could not be established, '</span> + <span class="hljs-string">'statusCode='</span> + res.statusCode)
      error.code = <span class="hljs-string">'ECONNRESET'</span>
      options.request.emit(<span class="hljs-string">'error'</span>, error)
      self.removeSocket(placeholder)
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onError</span>(<span class="hljs-params">cause</span>) </span>{
    connectReq.removeAllListeners()

    debug(<span class="hljs-string">'tunneling socket could not be established, cause=%s\n'</span>, cause.message, cause.stack)
    <span class="hljs-keyword">var</span> error = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'tunneling socket could not be established, '</span> + <span class="hljs-string">'cause='</span> + cause.message)
    error.code = <span class="hljs-string">'ECONNRESET'</span>
    options.request.emit(<span class="hljs-string">'error'</span>, error)
    self.removeSocket(placeholder)
  }
}

TunnelingAgent.prototype.removeSocket = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">removeSocket</span>(<span class="hljs-params">socket</span>) </span>{
  <span class="hljs-keyword">var</span> pos = <span class="hljs-keyword">this</span>.sockets.indexOf(socket)
  <span class="hljs-keyword">if</span> (pos === <span class="hljs-number">-1</span>) <span class="hljs-keyword">return</span>
  
  <span class="hljs-keyword">this</span>.sockets.splice(pos, <span class="hljs-number">1</span>)

  <span class="hljs-keyword">var</span> pending = <span class="hljs-keyword">this</span>.requests.shift()
  <span class="hljs-keyword">if</span> (pending) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>If we have pending requests and a socket gets closed a new one
needs to be created to take over in the pool for the one that closed.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">this</span>.createConnection(pending)
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createSecureSocket</span>(<span class="hljs-params">options, cb</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
  TunnelingAgent.prototype.createSocket.call(self, options, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">socket</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>0 is dummy port for v0.6</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> secureSocket = tls.connect(<span class="hljs-number">0</span>, mergeOptions({}, self.options, 
      { <span class="hljs-attr">servername</span>: options.host
      , <span class="hljs-attr">socket</span>: socket
      }
    ))
    self.sockets[self.sockets.indexOf(socket)] = secureSocket
    cb(secureSocket)
  })
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mergeOptions</span>(<span class="hljs-params">target</span>) </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>, len = <span class="hljs-built_in">arguments</span>.length; i &lt; len; ++i) {
    <span class="hljs-keyword">var</span> overrides = <span class="hljs-built_in">arguments</span>[i]
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> overrides === <span class="hljs-string">'object'</span>) {
      <span class="hljs-keyword">var</span> keys = <span class="hljs-built_in">Object</span>.keys(overrides)
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>, keyLen = keys.length; j &lt; keyLen; ++j) {
        <span class="hljs-keyword">var</span> k = keys[j]
        <span class="hljs-keyword">if</span> (overrides[k] !== <span class="hljs-literal">undefined</span>) {
          target[k] = overrides[k]
        }
      }
    }
  }
  <span class="hljs-keyword">return</span> target
}


<span class="hljs-keyword">var</span> debug
<span class="hljs-keyword">if</span> (process.env.NODE_DEBUG &amp;&amp; <span class="hljs-regexp">/\btunnel\b/</span>.test(process.env.NODE_DEBUG)) {
  debug = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>)
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> args[<span class="hljs-number">0</span>] === <span class="hljs-string">'string'</span>) {
      args[<span class="hljs-number">0</span>] = <span class="hljs-string">'TUNNEL: '</span> + args[<span class="hljs-number">0</span>]
    } <span class="hljs-keyword">else</span> {
      args.unshift(<span class="hljs-string">'TUNNEL:'</span>)
    }
    <span class="hljs-built_in">console</span>.error.apply(<span class="hljs-built_in">console</span>, args)
  }
} <span class="hljs-keyword">else</span> {
  debug = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{}
}
exports.debug = debug <span class="hljs-comment">// for test</span>

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>browser.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/hawk/test/browser.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>browser.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>Load modules</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> Url = <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>);
<span class="hljs-keyword">var</span> Code = <span class="hljs-built_in">require</span>(<span class="hljs-string">'code'</span>);
<span class="hljs-keyword">var</span> Hawk = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib'</span>);
<span class="hljs-keyword">var</span> Hoek = <span class="hljs-built_in">require</span>(<span class="hljs-string">'hoek'</span>);
<span class="hljs-keyword">var</span> Lab = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lab'</span>);
<span class="hljs-keyword">var</span> Browser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/browser'</span>);


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Declare internals</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> internals = {};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Test shortcuts</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> lab = exports.lab = Lab.script();
<span class="hljs-keyword">var</span> describe = lab.experiment;
<span class="hljs-keyword">var</span> it = lab.test;
<span class="hljs-keyword">var</span> expect = Code.expect;


describe(<span class="hljs-string">'Browser'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">var</span> credentialsFunc = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id, callback</span>) </span>{

        <span class="hljs-keyword">var</span> credentials = {
            <span class="hljs-attr">id</span>: id,
            <span class="hljs-attr">key</span>: <span class="hljs-string">'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn'</span>,
            <span class="hljs-attr">algorithm</span>: (id === <span class="hljs-string">'1'</span> ? <span class="hljs-string">'sha1'</span> : <span class="hljs-string">'sha256'</span>),
            <span class="hljs-attr">user</span>: <span class="hljs-string">'steve'</span>
        };

        <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, credentials);
    };

    it(<span class="hljs-string">'should generate a bewit then successfully authenticate it'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?a=1&amp;b=2'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">80</span>
        };

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            <span class="hljs-keyword">var</span> bewit = Browser.client.bewit(<span class="hljs-string">'http://example.com/resource/4?a=1&amp;b=2'</span>, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span> * <span class="hljs-number">365</span> * <span class="hljs-number">100</span>, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span> });
            req.url += <span class="hljs-string">'&amp;bewit='</span> + bewit;

            Hawk.uri.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, attributes</span>) </span>{

                expect(err).to.not.exist();
                expect(credentials2.user).to.equal(<span class="hljs-string">'steve'</span>);
                expect(attributes.ext).to.equal(<span class="hljs-string">'some-app-data'</span>);
                done();
            });
        });
    });

    it(<span class="hljs-string">'should generate a bewit then successfully authenticate it (no ext)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?a=1&amp;b=2'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">80</span>
        };

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            <span class="hljs-keyword">var</span> bewit = Browser.client.bewit(<span class="hljs-string">'http://example.com/resource/4?a=1&amp;b=2'</span>, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span> * <span class="hljs-number">365</span> * <span class="hljs-number">100</span> });
            req.url += <span class="hljs-string">'&amp;bewit='</span> + bewit;

            Hawk.uri.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, attributes</span>) </span>{

                expect(err).to.not.exist();
                expect(credentials2.user).to.equal(<span class="hljs-string">'steve'</span>);
                done();
            });
        });
    });

    describe(<span class="hljs-string">'bewit()'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        it(<span class="hljs-string">'returns a valid bewit value'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Browser.client.bewit(<span class="hljs-string">'https://example.com/somewhere/over/the/rainbow'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">localtimeOffsetMsec</span>: <span class="hljs-number">1356420407232</span> - Hawk.utils.now(), <span class="hljs-attr">ext</span>: <span class="hljs-string">'xandyandz'</span> });
            expect(bewit).to.equal(<span class="hljs-string">'MTIzNDU2XDEzNTY0MjA3MDdca3NjeHdOUjJ0SnBQMVQxekRMTlBiQjVVaUtJVTl0T1NKWFRVZEc3WDloOD1ceGFuZHlhbmR6'</span>);
            done();
        });

        it(<span class="hljs-string">'returns a valid bewit value (explicit HTTP port)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Browser.client.bewit(<span class="hljs-string">'http://example.com:8080/somewhere/over/the/rainbow'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">localtimeOffsetMsec</span>: <span class="hljs-number">1356420407232</span> - Hawk.utils.now(), <span class="hljs-attr">ext</span>: <span class="hljs-string">'xandyandz'</span> });
            expect(bewit).to.equal(<span class="hljs-string">'MTIzNDU2XDEzNTY0MjA3MDdcaFpiSjNQMmNLRW80a3kwQzhqa1pBa1J5Q1p1ZWc0V1NOYnhWN3ZxM3hIVT1ceGFuZHlhbmR6'</span>);
            done();
        });

        it(<span class="hljs-string">'returns a valid bewit value (explicit HTTPS port)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Browser.client.bewit(<span class="hljs-string">'https://example.com:8043/somewhere/over/the/rainbow'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">localtimeOffsetMsec</span>: <span class="hljs-number">1356420407232</span> - Hawk.utils.now(), <span class="hljs-attr">ext</span>: <span class="hljs-string">'xandyandz'</span> });
            expect(bewit).to.equal(<span class="hljs-string">'MTIzNDU2XDEzNTY0MjA3MDdcL2t4UjhwK0xSaTdvQTRnUXc3cWlxa3BiVHRKYkR4OEtRMC9HRUwvVytTUT1ceGFuZHlhbmR6'</span>);
            done();
        });

        it(<span class="hljs-string">'returns a valid bewit value (null ext)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Browser.client.bewit(<span class="hljs-string">'https://example.com/somewhere/over/the/rainbow'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">localtimeOffsetMsec</span>: <span class="hljs-number">1356420407232</span> - Hawk.utils.now(), <span class="hljs-attr">ext</span>: <span class="hljs-literal">null</span> });
            expect(bewit).to.equal(<span class="hljs-string">'MTIzNDU2XDEzNTY0MjA3MDdcSUdZbUxnSXFMckNlOEN4dktQczRKbFdJQStValdKSm91d2dBUmlWaENBZz1c'</span>);
            done();
        });

        it(<span class="hljs-string">'errors on invalid options'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Browser.client.bewit(<span class="hljs-string">'https://example.com/somewhere/over/the/rainbow'</span>, <span class="hljs-number">4</span>);
            expect(bewit).to.equal(<span class="hljs-string">''</span>);
            done();
        });

        it(<span class="hljs-string">'errors on missing uri'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Browser.client.bewit(<span class="hljs-string">''</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">localtimeOffsetMsec</span>: <span class="hljs-number">1356420407232</span> - Hawk.utils.now(), <span class="hljs-attr">ext</span>: <span class="hljs-string">'xandyandz'</span> });
            expect(bewit).to.equal(<span class="hljs-string">''</span>);
            done();
        });

        it(<span class="hljs-string">'errors on invalid uri'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Browser.client.bewit(<span class="hljs-number">5</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">localtimeOffsetMsec</span>: <span class="hljs-number">1356420407232</span> - Hawk.utils.now(), <span class="hljs-attr">ext</span>: <span class="hljs-string">'xandyandz'</span> });
            expect(bewit).to.equal(<span class="hljs-string">''</span>);
            done();
        });

        it(<span class="hljs-string">'errors on invalid credentials (id)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Browser.client.bewit(<span class="hljs-string">'https://example.com/somewhere/over/the/rainbow'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">3000</span>, <span class="hljs-attr">ext</span>: <span class="hljs-string">'xandyandz'</span> });
            expect(bewit).to.equal(<span class="hljs-string">''</span>);
            done();
        });

        it(<span class="hljs-string">'errors on missing credentials'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> bewit = Browser.client.bewit(<span class="hljs-string">'https://example.com/somewhere/over/the/rainbow'</span>, { <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">3000</span>, <span class="hljs-attr">ext</span>: <span class="hljs-string">'xandyandz'</span> });
            expect(bewit).to.equal(<span class="hljs-string">''</span>);
            done();
        });

        it(<span class="hljs-string">'errors on invalid credentials (key)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Browser.client.bewit(<span class="hljs-string">'https://example.com/somewhere/over/the/rainbow'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">3000</span>, <span class="hljs-attr">ext</span>: <span class="hljs-string">'xandyandz'</span> });
            expect(bewit).to.equal(<span class="hljs-string">''</span>);
            done();
        });

        it(<span class="hljs-string">'errors on invalid algorithm'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'hmac-sha-0'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Browser.client.bewit(<span class="hljs-string">'https://example.com/somewhere/over/the/rainbow'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">ext</span>: <span class="hljs-string">'xandyandz'</span> });
            expect(bewit).to.equal(<span class="hljs-string">''</span>);
            done();
        });

        it(<span class="hljs-string">'errors on missing options'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'hmac-sha-0'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Browser.client.bewit(<span class="hljs-string">'https://example.com/somewhere/over/the/rainbow'</span>);
            expect(bewit).to.equal(<span class="hljs-string">''</span>);
            done();
        });
    });

    it(<span class="hljs-string">'generates a header then successfully parse it (configuration)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            req.authorization = Browser.client.header(<span class="hljs-string">'http://example.com:8080/resource/4?filter=a'</span>, req.method, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span> }).field;
            expect(req.authorization).to.exist();

            Hawk.server.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, artifacts</span>) </span>{

                expect(err).to.not.exist();
                expect(credentials2.user).to.equal(<span class="hljs-string">'steve'</span>);
                expect(artifacts.ext).to.equal(<span class="hljs-string">'some-app-data'</span>);
                done();
            });
        });
    });

    it(<span class="hljs-string">'generates a header then successfully parse it (node request)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
            <span class="hljs-attr">headers</span>: {
                <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com:8080'</span>,
                <span class="hljs-string">'content-type'</span>: <span class="hljs-string">'text/plain;x=y'</span>
            }
        };

        <span class="hljs-keyword">var</span> payload = <span class="hljs-string">'some not so random text'</span>;

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            <span class="hljs-keyword">var</span> reqHeader = Browser.client.header(<span class="hljs-string">'http://example.com:8080/resource/4?filter=a'</span>, req.method, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span>, <span class="hljs-attr">payload</span>: payload, <span class="hljs-attr">contentType</span>: req.headers[<span class="hljs-string">'content-type'</span>] });
            req.headers.authorization = reqHeader.field;

            Hawk.server.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, artifacts</span>) </span>{

                expect(err).to.not.exist();
                expect(credentials2.user).to.equal(<span class="hljs-string">'steve'</span>);
                expect(artifacts.ext).to.equal(<span class="hljs-string">'some-app-data'</span>);
                expect(Hawk.server.authenticatePayload(payload, credentials2, artifacts, req.headers[<span class="hljs-string">'content-type'</span>])).to.equal(<span class="hljs-literal">true</span>);

                <span class="hljs-keyword">var</span> res = {
                    <span class="hljs-attr">headers</span>: {
                        <span class="hljs-string">'content-type'</span>: <span class="hljs-string">'text/plain'</span>
                    },
                    <span class="hljs-attr">getResponseHeader</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">header</span>) </span>{

                        <span class="hljs-keyword">return</span> res.headers[header.toLowerCase()];
                    }
                };

                res.headers[<span class="hljs-string">'server-authorization'</span>] = Hawk.server.header(credentials2, artifacts, { <span class="hljs-attr">payload</span>: <span class="hljs-string">'some reply'</span>, <span class="hljs-attr">contentType</span>: <span class="hljs-string">'text/plain'</span>, <span class="hljs-attr">ext</span>: <span class="hljs-string">'response-specific'</span> });
                expect(res.headers[<span class="hljs-string">'server-authorization'</span>]).to.exist();

                expect(Browser.client.authenticate(res, credentials2, artifacts, { <span class="hljs-attr">payload</span>: <span class="hljs-string">'some reply'</span> })).to.equal(<span class="hljs-literal">true</span>);
                done();
            });
        });
    });

    it(<span class="hljs-string">'generates a header then successfully parse it (browserify)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
            <span class="hljs-attr">headers</span>: {
                <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com:8080'</span>,
                <span class="hljs-string">'content-type'</span>: <span class="hljs-string">'text/plain;x=y'</span>
            }
        };

        <span class="hljs-keyword">var</span> payload = <span class="hljs-string">'some not so random text'</span>;

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            <span class="hljs-keyword">var</span> reqHeader = Browser.client.header(<span class="hljs-string">'http://example.com:8080/resource/4?filter=a'</span>, req.method, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span>, <span class="hljs-attr">payload</span>: payload, <span class="hljs-attr">contentType</span>: req.headers[<span class="hljs-string">'content-type'</span>] });
            req.headers.authorization = reqHeader.field;

            Hawk.server.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, artifacts</span>) </span>{

                expect(err).to.not.exist();
                expect(credentials2.user).to.equal(<span class="hljs-string">'steve'</span>);
                expect(artifacts.ext).to.equal(<span class="hljs-string">'some-app-data'</span>);
                expect(Hawk.server.authenticatePayload(payload, credentials2, artifacts, req.headers[<span class="hljs-string">'content-type'</span>])).to.equal(<span class="hljs-literal">true</span>);

                <span class="hljs-keyword">var</span> res = {
                    <span class="hljs-attr">headers</span>: {
                        <span class="hljs-string">'content-type'</span>: <span class="hljs-string">'text/plain'</span>
                    },
                    <span class="hljs-attr">getHeader</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">header</span>) </span>{

                        <span class="hljs-keyword">return</span> res.headers[header.toLowerCase()];
                    }
                };

                res.headers[<span class="hljs-string">'server-authorization'</span>] = Hawk.server.header(credentials2, artifacts, { <span class="hljs-attr">payload</span>: <span class="hljs-string">'some reply'</span>, <span class="hljs-attr">contentType</span>: <span class="hljs-string">'text/plain'</span>, <span class="hljs-attr">ext</span>: <span class="hljs-string">'response-specific'</span> });
                expect(res.headers[<span class="hljs-string">'server-authorization'</span>]).to.exist();

                expect(Browser.client.authenticate(res, credentials2, artifacts, { <span class="hljs-attr">payload</span>: <span class="hljs-string">'some reply'</span> })).to.equal(<span class="hljs-literal">true</span>);
                done();
            });
        });
    });

    it(<span class="hljs-string">'generates a header then successfully parse it (time offset)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            req.authorization = Browser.client.header(<span class="hljs-string">'http://example.com:8080/resource/4?filter=a'</span>, req.method, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span>, <span class="hljs-attr">localtimeOffsetMsec</span>: <span class="hljs-number">100000</span> }).field;
            expect(req.authorization).to.exist();

            Hawk.server.authenticate(req, credentialsFunc, { <span class="hljs-attr">localtimeOffsetMsec</span>: <span class="hljs-number">100000</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, artifacts</span>) </span>{

                expect(err).to.not.exist();
                expect(credentials2.user).to.equal(<span class="hljs-string">'steve'</span>);
                expect(artifacts.ext).to.equal(<span class="hljs-string">'some-app-data'</span>);
                done();
            });
        });
    });

    it(<span class="hljs-string">'generates a header then successfully parse it (no server header options)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
            <span class="hljs-attr">headers</span>: {
                <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com:8080'</span>,
                <span class="hljs-string">'content-type'</span>: <span class="hljs-string">'text/plain;x=y'</span>
            }
        };

        <span class="hljs-keyword">var</span> payload = <span class="hljs-string">'some not so random text'</span>;

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            <span class="hljs-keyword">var</span> reqHeader = Browser.client.header(<span class="hljs-string">'http://example.com:8080/resource/4?filter=a'</span>, req.method, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span>, <span class="hljs-attr">payload</span>: payload, <span class="hljs-attr">contentType</span>: req.headers[<span class="hljs-string">'content-type'</span>] });
            req.headers.authorization = reqHeader.field;

            Hawk.server.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, artifacts</span>) </span>{

                expect(err).to.not.exist();
                expect(credentials2.user).to.equal(<span class="hljs-string">'steve'</span>);
                expect(artifacts.ext).to.equal(<span class="hljs-string">'some-app-data'</span>);
                expect(Hawk.server.authenticatePayload(payload, credentials2, artifacts, req.headers[<span class="hljs-string">'content-type'</span>])).to.equal(<span class="hljs-literal">true</span>);

                <span class="hljs-keyword">var</span> res = {
                    <span class="hljs-attr">headers</span>: {
                        <span class="hljs-string">'content-type'</span>: <span class="hljs-string">'text/plain'</span>
                    },
                    <span class="hljs-attr">getResponseHeader</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">header</span>) </span>{

                        <span class="hljs-keyword">return</span> res.headers[header.toLowerCase()];
                    }
                };

                res.headers[<span class="hljs-string">'server-authorization'</span>] = Hawk.server.header(credentials2, artifacts);
                expect(res.headers[<span class="hljs-string">'server-authorization'</span>]).to.exist();

                expect(Browser.client.authenticate(res, credentials2, artifacts)).to.equal(<span class="hljs-literal">true</span>);
                done();
            });
        });
    });

    it(<span class="hljs-string">'generates a header then successfully parse it (no server header)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
            <span class="hljs-attr">headers</span>: {
                <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com:8080'</span>,
                <span class="hljs-string">'content-type'</span>: <span class="hljs-string">'text/plain;x=y'</span>
            }
        };

        <span class="hljs-keyword">var</span> payload = <span class="hljs-string">'some not so random text'</span>;

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            <span class="hljs-keyword">var</span> reqHeader = Browser.client.header(<span class="hljs-string">'http://example.com:8080/resource/4?filter=a'</span>, req.method, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span>, <span class="hljs-attr">payload</span>: payload, <span class="hljs-attr">contentType</span>: req.headers[<span class="hljs-string">'content-type'</span>] });
            req.headers.authorization = reqHeader.field;

            Hawk.server.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, artifacts</span>) </span>{

                expect(err).to.not.exist();
                expect(credentials2.user).to.equal(<span class="hljs-string">'steve'</span>);
                expect(artifacts.ext).to.equal(<span class="hljs-string">'some-app-data'</span>);
                expect(Hawk.server.authenticatePayload(payload, credentials2, artifacts, req.headers[<span class="hljs-string">'content-type'</span>])).to.equal(<span class="hljs-literal">true</span>);

                <span class="hljs-keyword">var</span> res = {
                    <span class="hljs-attr">headers</span>: {
                        <span class="hljs-string">'content-type'</span>: <span class="hljs-string">'text/plain'</span>
                    },
                    <span class="hljs-attr">getResponseHeader</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">header</span>) </span>{

                        <span class="hljs-keyword">return</span> res.headers[header.toLowerCase()];
                    }
                };

                expect(Browser.client.authenticate(res, credentials2, artifacts)).to.equal(<span class="hljs-literal">true</span>);
                done();
            });
        });
    });

    it(<span class="hljs-string">'generates a header with stale ts and successfully authenticate on second call'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            Browser.utils.setNtpOffset(<span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);
            <span class="hljs-keyword">var</span> header = Browser.client.header(<span class="hljs-string">'http://example.com:8080/resource/4?filter=a'</span>, req.method, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span> });
            req.authorization = header.field;
            expect(req.authorization).to.exist();

            Hawk.server.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, artifacts2</span>) </span>{

                expect(err).to.exist();
                expect(err.message).to.equal(<span class="hljs-string">'Stale timestamp'</span>);

                <span class="hljs-keyword">var</span> res = {
                    <span class="hljs-attr">headers</span>: {
                        <span class="hljs-string">'www-authenticate'</span>: err.output.headers[<span class="hljs-string">'WWW-Authenticate'</span>]
                    },
                    <span class="hljs-attr">getResponseHeader</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">lookup</span>) </span>{

                        <span class="hljs-keyword">return</span> res.headers[lookup.toLowerCase()];
                    }
                };

                expect(Browser.utils.getNtpOffset()).to.equal(<span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);
                expect(Browser.client.authenticate(res, credentials2, header.artifacts)).to.equal(<span class="hljs-literal">true</span>);
                expect(Browser.utils.getNtpOffset()).to.equal(<span class="hljs-number">0</span>);

                req.authorization = Browser.client.header(<span class="hljs-string">'http://example.com:8080/resource/4?filter=a'</span>, req.method, { <span class="hljs-attr">credentials</span>: credentials2, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span> }).field;
                expect(req.authorization).to.exist();

                Hawk.server.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials3, artifacts3</span>) </span>{

                    expect(err).to.not.exist();
                    expect(credentials3.user).to.equal(<span class="hljs-string">'steve'</span>);
                    expect(artifacts3.ext).to.equal(<span class="hljs-string">'some-app-data'</span>);
                    done();
                });
            });
        });
    });

    it(<span class="hljs-string">'generates a header with stale ts and successfully authenticate on second call (manual localStorage)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            <span class="hljs-keyword">var</span> localStorage = <span class="hljs-keyword">new</span> Browser.internals.LocalStorage();

            Browser.utils.setStorage(localStorage);

            Browser.utils.setNtpOffset(<span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);
            <span class="hljs-keyword">var</span> header = Browser.client.header(<span class="hljs-string">'http://example.com:8080/resource/4?filter=a'</span>, req.method, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span> });
            req.authorization = header.field;
            expect(req.authorization).to.exist();

            Hawk.server.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, artifacts2</span>) </span>{

                expect(err).to.exist();
                expect(err.message).to.equal(<span class="hljs-string">'Stale timestamp'</span>);

                <span class="hljs-keyword">var</span> res = {
                    <span class="hljs-attr">headers</span>: {
                        <span class="hljs-string">'www-authenticate'</span>: err.output.headers[<span class="hljs-string">'WWW-Authenticate'</span>]
                    },
                    <span class="hljs-attr">getResponseHeader</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">lookup</span>) </span>{

                        <span class="hljs-keyword">return</span> res.headers[lookup.toLowerCase()];
                    }
                };

                expect(<span class="hljs-built_in">parseInt</span>(localStorage.getItem(<span class="hljs-string">'hawk_ntp_offset'</span>))).to.equal(<span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);
                expect(Browser.utils.getNtpOffset()).to.equal(<span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);
                expect(Browser.client.authenticate(res, credentials2, header.artifacts)).to.equal(<span class="hljs-literal">true</span>);
                expect(Browser.utils.getNtpOffset()).to.equal(<span class="hljs-number">0</span>);
                expect(<span class="hljs-built_in">parseInt</span>(localStorage.getItem(<span class="hljs-string">'hawk_ntp_offset'</span>))).to.equal(<span class="hljs-number">0</span>);

                req.authorization = Browser.client.header(<span class="hljs-string">'http://example.com:8080/resource/4?filter=a'</span>, req.method, { <span class="hljs-attr">credentials</span>: credentials2, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span> }).field;
                expect(req.authorization).to.exist();

                Hawk.server.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials3, artifacts3</span>) </span>{

                    expect(err).to.not.exist();
                    expect(credentials3.user).to.equal(<span class="hljs-string">'steve'</span>);
                    expect(artifacts3.ext).to.equal(<span class="hljs-string">'some-app-data'</span>);
                    done();
                });
            });
        });
    });

    it(<span class="hljs-string">'generates a header then fails to parse it (missing server header hash)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
            <span class="hljs-attr">headers</span>: {
                <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com:8080'</span>,
                <span class="hljs-string">'content-type'</span>: <span class="hljs-string">'text/plain;x=y'</span>
            }
        };

        <span class="hljs-keyword">var</span> payload = <span class="hljs-string">'some not so random text'</span>;

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            <span class="hljs-keyword">var</span> reqHeader = Browser.client.header(<span class="hljs-string">'http://example.com:8080/resource/4?filter=a'</span>, req.method, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span>, <span class="hljs-attr">payload</span>: payload, <span class="hljs-attr">contentType</span>: req.headers[<span class="hljs-string">'content-type'</span>] });
            req.headers.authorization = reqHeader.field;

            Hawk.server.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, artifacts</span>) </span>{

                expect(err).to.not.exist();
                expect(credentials2.user).to.equal(<span class="hljs-string">'steve'</span>);
                expect(artifacts.ext).to.equal(<span class="hljs-string">'some-app-data'</span>);
                expect(Hawk.server.authenticatePayload(payload, credentials2, artifacts, req.headers[<span class="hljs-string">'content-type'</span>])).to.equal(<span class="hljs-literal">true</span>);

                <span class="hljs-keyword">var</span> res = {
                    <span class="hljs-attr">headers</span>: {
                        <span class="hljs-string">'content-type'</span>: <span class="hljs-string">'text/plain'</span>
                    },
                    <span class="hljs-attr">getResponseHeader</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">header</span>) </span>{

                        <span class="hljs-keyword">return</span> res.headers[header.toLowerCase()];
                    }
                };

                res.headers[<span class="hljs-string">'server-authorization'</span>] = Hawk.server.header(credentials2, artifacts);
                expect(res.headers[<span class="hljs-string">'server-authorization'</span>]).to.exist();

                expect(Browser.client.authenticate(res, credentials2, artifacts, { <span class="hljs-attr">payload</span>: <span class="hljs-string">'some reply'</span> })).to.equal(<span class="hljs-literal">false</span>);
                done();
            });
        });
    });

    it(<span class="hljs-string">'generates a header then successfully parse it (with hash)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            req.authorization = Browser.client.header(<span class="hljs-string">'http://example.com:8080/resource/4?filter=a'</span>, req.method, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">payload</span>: <span class="hljs-string">'hola!'</span>, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span> }).field;
            Hawk.server.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, artifacts</span>) </span>{

                expect(err).to.not.exist();
                expect(credentials2.user).to.equal(<span class="hljs-string">'steve'</span>);
                expect(artifacts.ext).to.equal(<span class="hljs-string">'some-app-data'</span>);
                done();
            });
        });
    });

    it(<span class="hljs-string">'generates a header then successfully parse it then validate payload'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            req.authorization = Browser.client.header(<span class="hljs-string">'http://example.com:8080/resource/4?filter=a'</span>, req.method, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">payload</span>: <span class="hljs-string">'hola!'</span>, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span> }).field;
            Hawk.server.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, artifacts</span>) </span>{

                expect(err).to.not.exist();
                expect(credentials2.user).to.equal(<span class="hljs-string">'steve'</span>);
                expect(artifacts.ext).to.equal(<span class="hljs-string">'some-app-data'</span>);
                expect(Hawk.server.authenticatePayload(<span class="hljs-string">'hola!'</span>, credentials2, artifacts)).to.be.true();
                expect(Hawk.server.authenticatePayload(<span class="hljs-string">'hello!'</span>, credentials2, artifacts)).to.be.false();
                done();
            });
        });
    });

    it(<span class="hljs-string">'generates a header then successfully parse it (app)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            req.authorization = Browser.client.header(<span class="hljs-string">'http://example.com:8080/resource/4?filter=a'</span>, req.method, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span>, <span class="hljs-attr">app</span>: <span class="hljs-string">'asd23ased'</span> }).field;
            Hawk.server.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, artifacts</span>) </span>{

                expect(err).to.not.exist();
                expect(credentials2.user).to.equal(<span class="hljs-string">'steve'</span>);
                expect(artifacts.ext).to.equal(<span class="hljs-string">'some-app-data'</span>);
                expect(artifacts.app).to.equal(<span class="hljs-string">'asd23ased'</span>);
                done();
            });
        });
    });

    it(<span class="hljs-string">'generates a header then successfully parse it (app, dlg)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            req.authorization = Browser.client.header(<span class="hljs-string">'http://example.com:8080/resource/4?filter=a'</span>, req.method, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span>, <span class="hljs-attr">app</span>: <span class="hljs-string">'asd23ased'</span>, <span class="hljs-attr">dlg</span>: <span class="hljs-string">'23434szr3q4d'</span> }).field;
            Hawk.server.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, artifacts</span>) </span>{

                expect(err).to.not.exist();
                expect(credentials2.user).to.equal(<span class="hljs-string">'steve'</span>);
                expect(artifacts.ext).to.equal(<span class="hljs-string">'some-app-data'</span>);
                expect(artifacts.app).to.equal(<span class="hljs-string">'asd23ased'</span>);
                expect(artifacts.dlg).to.equal(<span class="hljs-string">'23434szr3q4d'</span>);
                done();
            });
        });
    });

    it(<span class="hljs-string">'generates a header then fail authentication due to bad hash'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            req.authorization = Browser.client.header(<span class="hljs-string">'http://example.com:8080/resource/4?filter=a'</span>, req.method, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">payload</span>: <span class="hljs-string">'hola!'</span>, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span> }).field;
            Hawk.server.authenticate(req, credentialsFunc, { <span class="hljs-attr">payload</span>: <span class="hljs-string">'byebye!'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, artifacts</span>) </span>{

                expect(err).to.exist();
                expect(err.output.payload.message).to.equal(<span class="hljs-string">'Bad payload hash'</span>);
                done();
            });
        });
    });

    it(<span class="hljs-string">'generates a header for one resource then fail to authenticate another'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            req.authorization = Browser.client.header(<span class="hljs-string">'http://example.com:8080/resource/4?filter=a'</span>, req.method, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span> }).field;
            req.url = <span class="hljs-string">'/something/else'</span>;

            Hawk.server.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, artifacts</span>) </span>{

                expect(err).to.exist();
                expect(credentials2).to.exist();
                done();
            });
        });
    });

    describe(<span class="hljs-string">'client'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        describe(<span class="hljs-string">'header()'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

            it(<span class="hljs-string">'returns a valid authorization header (sha1)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> credentials = {
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                    <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha1'</span>
                };

                <span class="hljs-keyword">var</span> header = Browser.client.header(<span class="hljs-string">'http://example.net/somewhere/over/the/rainbow'</span>, <span class="hljs-string">'POST'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ext</span>: <span class="hljs-string">'Bazinga!'</span>, <span class="hljs-attr">timestamp</span>: <span class="hljs-number">1353809207</span>, <span class="hljs-attr">nonce</span>: <span class="hljs-string">'Ygvqdz'</span>, <span class="hljs-attr">payload</span>: <span class="hljs-string">'something to write about'</span> }).field;
                expect(header).to.equal(<span class="hljs-string">'Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="bsvY3IfUllw6V5rvk4tStEvpBhE=", ext="Bazinga!", mac="qbf1ZPG/r/e06F4ht+T77LXi5vw="'</span>);
                done();
            });

            it(<span class="hljs-string">'returns a valid authorization header (sha256)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> credentials = {
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                    <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
                };

                <span class="hljs-keyword">var</span> header = Browser.client.header(<span class="hljs-string">'https://example.net/somewhere/over/the/rainbow'</span>, <span class="hljs-string">'POST'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ext</span>: <span class="hljs-string">'Bazinga!'</span>, <span class="hljs-attr">timestamp</span>: <span class="hljs-number">1353809207</span>, <span class="hljs-attr">nonce</span>: <span class="hljs-string">'Ygvqdz'</span>, <span class="hljs-attr">payload</span>: <span class="hljs-string">'something to write about'</span>, <span class="hljs-attr">contentType</span>: <span class="hljs-string">'text/plain'</span> }).field;
                expect(header).to.equal(<span class="hljs-string">'Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=", ext="Bazinga!", mac="q1CwFoSHzPZSkbIvl0oYlD+91rBUEvFk763nMjMndj8="'</span>);
                done();
            });

            it(<span class="hljs-string">'returns a valid authorization header (empty payload)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> credentials = {
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                    <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha1'</span>
                };

                <span class="hljs-keyword">var</span> header = Browser.client.header(<span class="hljs-string">'http://example.net/somewhere/over/the/rainbow'</span>, <span class="hljs-string">'POST'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ext</span>: <span class="hljs-string">'Bazinga!'</span>, <span class="hljs-attr">timestamp</span>: <span class="hljs-number">1353809207</span>, <span class="hljs-attr">nonce</span>: <span class="hljs-string">'Ygvqdz'</span>, <span class="hljs-attr">payload</span>: <span class="hljs-string">''</span> }).field;
                expect(header).to.equal(<span class="hljs-string">'Hawk id=\"123456\", ts=\"1353809207\", nonce=\"Ygvqdz\", hash=\"404ghL7K+hfyhByKKejFBRGgTjU=\", ext=\"Bazinga!\", mac=\"Bh1sj1DOfFRWOdi3ww52nLCJdBE=\"'</span>);
                done();
            });

            it(<span class="hljs-string">'returns a valid authorization header (no ext)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> credentials = {
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                    <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
                };

                <span class="hljs-keyword">var</span> header = Browser.client.header(<span class="hljs-string">'https://example.net/somewhere/over/the/rainbow'</span>, <span class="hljs-string">'POST'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">timestamp</span>: <span class="hljs-number">1353809207</span>, <span class="hljs-attr">nonce</span>: <span class="hljs-string">'Ygvqdz'</span>, <span class="hljs-attr">payload</span>: <span class="hljs-string">'something to write about'</span>, <span class="hljs-attr">contentType</span>: <span class="hljs-string">'text/plain'</span> }).field;
                expect(header).to.equal(<span class="hljs-string">'Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=", mac="HTgtd0jPI6E4izx8e4OHdO36q00xFCU0FolNq3RiCYs="'</span>);
                done();
            });

            it(<span class="hljs-string">'returns a valid authorization header (null ext)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> credentials = {
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                    <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
                };

                <span class="hljs-keyword">var</span> header = Browser.client.header(<span class="hljs-string">'https://example.net/somewhere/over/the/rainbow'</span>, <span class="hljs-string">'POST'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">timestamp</span>: <span class="hljs-number">1353809207</span>, <span class="hljs-attr">nonce</span>: <span class="hljs-string">'Ygvqdz'</span>, <span class="hljs-attr">payload</span>: <span class="hljs-string">'something to write about'</span>, <span class="hljs-attr">contentType</span>: <span class="hljs-string">'text/plain'</span>, <span class="hljs-attr">ext</span>: <span class="hljs-literal">null</span> }).field;
                expect(header).to.equal(<span class="hljs-string">'Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=", mac="HTgtd0jPI6E4izx8e4OHdO36q00xFCU0FolNq3RiCYs="'</span>);
                done();
            });

            it(<span class="hljs-string">'returns a valid authorization header (uri object)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> credentials = {
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                    <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
                };

                <span class="hljs-keyword">var</span> uri = Browser.utils.parseUri(<span class="hljs-string">'https://example.net/somewhere/over/the/rainbow'</span>);
                <span class="hljs-keyword">var</span> header = Browser.client.header(uri, <span class="hljs-string">'POST'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">timestamp</span>: <span class="hljs-number">1353809207</span>, <span class="hljs-attr">nonce</span>: <span class="hljs-string">'Ygvqdz'</span>, <span class="hljs-attr">payload</span>: <span class="hljs-string">'something to write about'</span>, <span class="hljs-attr">contentType</span>: <span class="hljs-string">'text/plain'</span> }).field;
                expect(header).to.equal(<span class="hljs-string">'Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=", mac="HTgtd0jPI6E4izx8e4OHdO36q00xFCU0FolNq3RiCYs="'</span>);
                done();
            });

            it(<span class="hljs-string">'errors on missing options'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> header = Browser.client.header(<span class="hljs-string">'https://example.net/somewhere/over/the/rainbow'</span>, <span class="hljs-string">'POST'</span>);
                expect(header.field).to.equal(<span class="hljs-string">''</span>);
                expect(header.err).to.equal(<span class="hljs-string">'Invalid argument type'</span>);
                done();
            });

            it(<span class="hljs-string">'errors on empty uri'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> credentials = {
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                    <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
                };

                <span class="hljs-keyword">var</span> header = Browser.client.header(<span class="hljs-string">''</span>, <span class="hljs-string">'POST'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">timestamp</span>: <span class="hljs-number">1353809207</span>, <span class="hljs-attr">nonce</span>: <span class="hljs-string">'Ygvqdz'</span>, <span class="hljs-attr">payload</span>: <span class="hljs-string">'something to write about'</span>, <span class="hljs-attr">contentType</span>: <span class="hljs-string">'text/plain'</span> });
                expect(header.field).to.equal(<span class="hljs-string">''</span>);
                expect(header.err).to.equal(<span class="hljs-string">'Invalid argument type'</span>);
                done();
            });

            it(<span class="hljs-string">'errors on invalid uri'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> credentials = {
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                    <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
                };

                <span class="hljs-keyword">var</span> header = Browser.client.header(<span class="hljs-number">4</span>, <span class="hljs-string">'POST'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">timestamp</span>: <span class="hljs-number">1353809207</span>, <span class="hljs-attr">nonce</span>: <span class="hljs-string">'Ygvqdz'</span>, <span class="hljs-attr">payload</span>: <span class="hljs-string">'something to write about'</span>, <span class="hljs-attr">contentType</span>: <span class="hljs-string">'text/plain'</span> });
                expect(header.field).to.equal(<span class="hljs-string">''</span>);
                expect(header.err).to.equal(<span class="hljs-string">'Invalid argument type'</span>);
                done();
            });

            it(<span class="hljs-string">'errors on missing method'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> credentials = {
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                    <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
                };

                <span class="hljs-keyword">var</span> header = Browser.client.header(<span class="hljs-string">'https://example.net/somewhere/over/the/rainbow'</span>, <span class="hljs-string">''</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">timestamp</span>: <span class="hljs-number">1353809207</span>, <span class="hljs-attr">nonce</span>: <span class="hljs-string">'Ygvqdz'</span>, <span class="hljs-attr">payload</span>: <span class="hljs-string">'something to write about'</span>, <span class="hljs-attr">contentType</span>: <span class="hljs-string">'text/plain'</span> });
                expect(header.field).to.equal(<span class="hljs-string">''</span>);
                expect(header.err).to.equal(<span class="hljs-string">'Invalid argument type'</span>);
                done();
            });

            it(<span class="hljs-string">'errors on invalid method'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> credentials = {
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                    <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
                };

                <span class="hljs-keyword">var</span> header = Browser.client.header(<span class="hljs-string">'https://example.net/somewhere/over/the/rainbow'</span>, <span class="hljs-number">5</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">timestamp</span>: <span class="hljs-number">1353809207</span>, <span class="hljs-attr">nonce</span>: <span class="hljs-string">'Ygvqdz'</span>, <span class="hljs-attr">payload</span>: <span class="hljs-string">'something to write about'</span>, <span class="hljs-attr">contentType</span>: <span class="hljs-string">'text/plain'</span> });
                expect(header.field).to.equal(<span class="hljs-string">''</span>);
                expect(header.err).to.equal(<span class="hljs-string">'Invalid argument type'</span>);
                done();
            });

            it(<span class="hljs-string">'errors on missing credentials'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> header = Browser.client.header(<span class="hljs-string">'https://example.net/somewhere/over/the/rainbow'</span>, <span class="hljs-string">'POST'</span>, { <span class="hljs-attr">ext</span>: <span class="hljs-string">'Bazinga!'</span>, <span class="hljs-attr">timestamp</span>: <span class="hljs-number">1353809207</span> });
                expect(header.field).to.equal(<span class="hljs-string">''</span>);
                expect(header.err).to.equal(<span class="hljs-string">'Invalid credentials object'</span>);
                done();
            });

            it(<span class="hljs-string">'errors on invalid credentials (id)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> credentials = {
                    <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
                };

                <span class="hljs-keyword">var</span> header = Browser.client.header(<span class="hljs-string">'https://example.net/somewhere/over/the/rainbow'</span>, <span class="hljs-string">'POST'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ext</span>: <span class="hljs-string">'Bazinga!'</span>, <span class="hljs-attr">timestamp</span>: <span class="hljs-number">1353809207</span> });
                expect(header.field).to.equal(<span class="hljs-string">''</span>);
                expect(header.err).to.equal(<span class="hljs-string">'Invalid credentials object'</span>);
                done();
            });

            it(<span class="hljs-string">'errors on invalid credentials (key)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> credentials = {
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
                };

                <span class="hljs-keyword">var</span> header = Browser.client.header(<span class="hljs-string">'https://example.net/somewhere/over/the/rainbow'</span>, <span class="hljs-string">'POST'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ext</span>: <span class="hljs-string">'Bazinga!'</span>, <span class="hljs-attr">timestamp</span>: <span class="hljs-number">1353809207</span> });
                expect(header.field).to.equal(<span class="hljs-string">''</span>);
                expect(header.err).to.equal(<span class="hljs-string">'Invalid credentials object'</span>);
                done();
            });

            it(<span class="hljs-string">'errors on invalid algorithm'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> credentials = {
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                    <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'hmac-sha-0'</span>
                };

                <span class="hljs-keyword">var</span> header = Browser.client.header(<span class="hljs-string">'https://example.net/somewhere/over/the/rainbow'</span>, <span class="hljs-string">'POST'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">payload</span>: <span class="hljs-string">'something, anything!'</span>, <span class="hljs-attr">ext</span>: <span class="hljs-string">'Bazinga!'</span>, <span class="hljs-attr">timestamp</span>: <span class="hljs-number">1353809207</span> });
                expect(header.field).to.equal(<span class="hljs-string">''</span>);
                expect(header.err).to.equal(<span class="hljs-string">'Unknown algorithm'</span>);
                done();
            });

            it(<span class="hljs-string">'uses a pre-calculated payload hash'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> credentials = {
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                    <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
                };

                <span class="hljs-keyword">var</span> options = { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ext</span>: <span class="hljs-string">'Bazinga!'</span>, <span class="hljs-attr">timestamp</span>: <span class="hljs-number">1353809207</span>, <span class="hljs-attr">nonce</span>: <span class="hljs-string">'Ygvqdz'</span>, <span class="hljs-attr">payload</span>: <span class="hljs-string">'something to write about'</span>, <span class="hljs-attr">contentType</span>: <span class="hljs-string">'text/plain'</span> };
                options.hash = Browser.crypto.calculatePayloadHash(options.payload, credentials.algorithm, options.contentType);
                <span class="hljs-keyword">var</span> header = Browser.client.header(<span class="hljs-string">'https://example.net/somewhere/over/the/rainbow'</span>, <span class="hljs-string">'POST'</span>, options).field;
                expect(header).to.equal(<span class="hljs-string">'Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=", ext="Bazinga!", mac="q1CwFoSHzPZSkbIvl0oYlD+91rBUEvFk763nMjMndj8="'</span>);
                done();
            });
        });

        describe(<span class="hljs-string">'authenticate()'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

            it(<span class="hljs-string">'skips tsm validation when missing ts'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> res = {
                    <span class="hljs-attr">headers</span>: {
                        <span class="hljs-string">'www-authenticate'</span>: <span class="hljs-string">'Hawk error="Stale timestamp"'</span>
                    },
                    <span class="hljs-attr">getResponseHeader</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">header</span>) </span>{

                        <span class="hljs-keyword">return</span> res.headers[header.toLowerCase()];
                    }
                };

                <span class="hljs-keyword">var</span> credentials = {
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                    <span class="hljs-attr">key</span>: <span class="hljs-string">'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn'</span>,
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>,
                    <span class="hljs-attr">user</span>: <span class="hljs-string">'steve'</span>
                };

                <span class="hljs-keyword">var</span> artifacts = {
                    <span class="hljs-attr">ts</span>: <span class="hljs-number">1402135580</span>,
                    <span class="hljs-attr">nonce</span>: <span class="hljs-string">'iBRB6t'</span>,
                    <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
                    <span class="hljs-attr">resource</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
                    <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
                    <span class="hljs-attr">port</span>: <span class="hljs-string">'8080'</span>,
                    <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span>
                };

                expect(Browser.client.authenticate(res, credentials, artifacts)).to.equal(<span class="hljs-literal">true</span>);
                done();
            });

            it(<span class="hljs-string">'returns false on invalid header'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> res = {
                    <span class="hljs-attr">headers</span>: {
                        <span class="hljs-string">'server-authorization'</span>: <span class="hljs-string">'Hawk mac="abc", bad="xyz"'</span>
                    },
                    <span class="hljs-attr">getResponseHeader</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">header</span>) </span>{

                        <span class="hljs-keyword">return</span> res.headers[header.toLowerCase()];
                    }
                };

                expect(Browser.client.authenticate(res, {})).to.equal(<span class="hljs-literal">false</span>);
                done();
            });

            it(<span class="hljs-string">'returns false on invalid mac'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> res = {
                    <span class="hljs-attr">headers</span>: {
                        <span class="hljs-string">'content-type'</span>: <span class="hljs-string">'text/plain'</span>,
                        <span class="hljs-string">'server-authorization'</span>: <span class="hljs-string">'Hawk mac="_IJRsMl/4oL+nn+vKoeVZPdCHXB4yJkNnBbTbHFZUYE=", hash="f9cDF/TDm7TkYRLnGwRMfeDzT6LixQVLvrIKhh0vgmM=", ext="response-specific"'</span>
                    },
                    <span class="hljs-attr">getResponseHeader</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">header</span>) </span>{

                        <span class="hljs-keyword">return</span> res.headers[header.toLowerCase()];
                    }
                };

                <span class="hljs-keyword">var</span> artifacts = {
                    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
                    <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
                    <span class="hljs-attr">port</span>: <span class="hljs-string">'8080'</span>,
                    <span class="hljs-attr">resource</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
                    <span class="hljs-attr">ts</span>: <span class="hljs-string">'1362336900'</span>,
                    <span class="hljs-attr">nonce</span>: <span class="hljs-string">'eb5S_L'</span>,
                    <span class="hljs-attr">hash</span>: <span class="hljs-string">'nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk='</span>,
                    <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span>,
                    <span class="hljs-attr">app</span>: <span class="hljs-literal">undefined</span>,
                    <span class="hljs-attr">dlg</span>: <span class="hljs-literal">undefined</span>,
                    <span class="hljs-attr">mac</span>: <span class="hljs-string">'BlmSe8K+pbKIb6YsZCnt4E1GrYvY1AaYayNR82dGpIk='</span>,
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>
                };

                <span class="hljs-keyword">var</span> credentials = {
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                    <span class="hljs-attr">key</span>: <span class="hljs-string">'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn'</span>,
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>,
                    <span class="hljs-attr">user</span>: <span class="hljs-string">'steve'</span>
                };

                expect(Browser.client.authenticate(res, credentials, artifacts)).to.equal(<span class="hljs-literal">false</span>);
                done();
            });

            it(<span class="hljs-string">'returns true on ignoring hash'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> res = {
                    <span class="hljs-attr">headers</span>: {
                        <span class="hljs-string">'content-type'</span>: <span class="hljs-string">'text/plain'</span>,
                        <span class="hljs-string">'server-authorization'</span>: <span class="hljs-string">'Hawk mac="XIJRsMl/4oL+nn+vKoeVZPdCHXB4yJkNnBbTbHFZUYE=", hash="f9cDF/TDm7TkYRLnGwRMfeDzT6LixQVLvrIKhh0vgmM=", ext="response-specific"'</span>
                    },
                    <span class="hljs-attr">getResponseHeader</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">header</span>) </span>{

                        <span class="hljs-keyword">return</span> res.headers[header.toLowerCase()];
                    }
                };

                <span class="hljs-keyword">var</span> artifacts = {
                    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
                    <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
                    <span class="hljs-attr">port</span>: <span class="hljs-string">'8080'</span>,
                    <span class="hljs-attr">resource</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
                    <span class="hljs-attr">ts</span>: <span class="hljs-string">'1362336900'</span>,
                    <span class="hljs-attr">nonce</span>: <span class="hljs-string">'eb5S_L'</span>,
                    <span class="hljs-attr">hash</span>: <span class="hljs-string">'nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk='</span>,
                    <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span>,
                    <span class="hljs-attr">app</span>: <span class="hljs-literal">undefined</span>,
                    <span class="hljs-attr">dlg</span>: <span class="hljs-literal">undefined</span>,
                    <span class="hljs-attr">mac</span>: <span class="hljs-string">'BlmSe8K+pbKIb6YsZCnt4E1GrYvY1AaYayNR82dGpIk='</span>,
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>
                };

                <span class="hljs-keyword">var</span> credentials = {
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                    <span class="hljs-attr">key</span>: <span class="hljs-string">'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn'</span>,
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>,
                    <span class="hljs-attr">user</span>: <span class="hljs-string">'steve'</span>
                };

                expect(Browser.client.authenticate(res, credentials, artifacts)).to.equal(<span class="hljs-literal">true</span>);
                done();
            });

            it(<span class="hljs-string">'errors on invalid WWW-Authenticate header format'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> res = {
                    <span class="hljs-attr">headers</span>: {
                        <span class="hljs-string">'www-authenticate'</span>: <span class="hljs-string">'Hawk ts="1362346425875", tsm="PhwayS28vtnn3qbv0mqRBYSXebN/zggEtucfeZ620Zo=", x="Stale timestamp"'</span>
                    },
                    <span class="hljs-attr">getResponseHeader</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">header</span>) </span>{

                        <span class="hljs-keyword">return</span> res.headers[header.toLowerCase()];
                    }
                };

                expect(Browser.client.authenticate(res, {})).to.equal(<span class="hljs-literal">false</span>);
                done();
            });

            it(<span class="hljs-string">'errors on invalid WWW-Authenticate header format'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> credentials = {
                    <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                    <span class="hljs-attr">key</span>: <span class="hljs-string">'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn'</span>,
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>,
                    <span class="hljs-attr">user</span>: <span class="hljs-string">'steve'</span>
                };

                <span class="hljs-keyword">var</span> res = {
                    <span class="hljs-attr">headers</span>: {
                        <span class="hljs-string">'www-authenticate'</span>: <span class="hljs-string">'Hawk ts="1362346425875", tsm="hwayS28vtnn3qbv0mqRBYSXebN/zggEtucfeZ620Zo=", error="Stale timestamp"'</span>
                    },
                    <span class="hljs-attr">getResponseHeader</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">header</span>) </span>{

                        <span class="hljs-keyword">return</span> res.headers[header.toLowerCase()];
                    }
                };

                expect(Browser.client.authenticate(res, credentials)).to.equal(<span class="hljs-literal">false</span>);
                done();
            });
        });

        describe(<span class="hljs-string">'message()'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

            it(<span class="hljs-string">'generates an authorization then successfully parse it'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

                    <span class="hljs-keyword">var</span> auth = Browser.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: credentials1 });
                    expect(auth).to.exist();

                    Hawk.server.authenticateMessage(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, auth, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2</span>) </span>{

                        expect(err).to.not.exist();
                        expect(credentials2.user).to.equal(<span class="hljs-string">'steve'</span>);
                        done();
                    });
                });
            });

            it(<span class="hljs-string">'generates an authorization using custom nonce/timestamp'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials</span>) </span>{

                    <span class="hljs-keyword">var</span> auth = Browser.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">nonce</span>: <span class="hljs-string">'abc123'</span>, <span class="hljs-attr">timestamp</span>: <span class="hljs-number">1398536270957</span> });
                    expect(auth).to.exist();
                    expect(auth.nonce).to.equal(<span class="hljs-string">'abc123'</span>);
                    expect(auth.ts).to.equal(<span class="hljs-number">1398536270957</span>);
                    done();
                });
            });

            it(<span class="hljs-string">'errors on missing host'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials</span>) </span>{

                    <span class="hljs-keyword">var</span> auth = Browser.client.message(<span class="hljs-literal">null</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: credentials });
                    expect(auth).to.not.exist();
                    done();
                });
            });

            it(<span class="hljs-string">'errors on invalid host'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials</span>) </span>{

                    <span class="hljs-keyword">var</span> auth = Browser.client.message(<span class="hljs-number">5</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: credentials });
                    expect(auth).to.not.exist();
                    done();
                });
            });

            it(<span class="hljs-string">'errors on missing port'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials</span>) </span>{

                    <span class="hljs-keyword">var</span> auth = Browser.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: credentials });
                    expect(auth).to.not.exist();
                    done();
                });
            });

            it(<span class="hljs-string">'errors on invalid port'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials</span>) </span>{

                    <span class="hljs-keyword">var</span> auth = Browser.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: credentials });
                    expect(auth).to.not.exist();
                    done();
                });
            });

            it(<span class="hljs-string">'errors on missing message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials</span>) </span>{

                    <span class="hljs-keyword">var</span> auth = Browser.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-literal">undefined</span>, { <span class="hljs-attr">credentials</span>: credentials });
                    expect(auth).to.not.exist();
                    done();
                });
            });

            it(<span class="hljs-string">'errors on null message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials</span>) </span>{

                    <span class="hljs-keyword">var</span> auth = Browser.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-literal">null</span>, { <span class="hljs-attr">credentials</span>: credentials });
                    expect(auth).to.not.exist();
                    done();
                });
            });

            it(<span class="hljs-string">'errors on invalid message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials</span>) </span>{

                    <span class="hljs-keyword">var</span> auth = Browser.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-number">5</span>, { <span class="hljs-attr">credentials</span>: credentials });
                    expect(auth).to.not.exist();
                    done();
                });
            });

            it(<span class="hljs-string">'errors on missing credentials'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> auth = Browser.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, {});
                expect(auth).to.not.exist();
                done();
            });

            it(<span class="hljs-string">'errors on missing options'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> auth = Browser.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>);
                expect(auth).to.not.exist();
                done();
            });

            it(<span class="hljs-string">'errors on invalid credentials (id)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials</span>) </span>{

                    <span class="hljs-keyword">var</span> creds = Hoek.clone(credentials);
                    <span class="hljs-keyword">delete</span> creds.id;
                    <span class="hljs-keyword">var</span> auth = Browser.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: creds });
                    expect(auth).to.not.exist();
                    done();
                });
            });

            it(<span class="hljs-string">'errors on invalid credentials (key)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials</span>) </span>{

                    <span class="hljs-keyword">var</span> creds = Hoek.clone(credentials);
                    <span class="hljs-keyword">delete</span> creds.key;
                    <span class="hljs-keyword">var</span> auth = Browser.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: creds });
                    expect(auth).to.not.exist();
                    done();
                });
            });

            it(<span class="hljs-string">'errors on invalid algorithm'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials</span>) </span>{

                    <span class="hljs-keyword">var</span> creds = Hoek.clone(credentials);
                    creds.algorithm = <span class="hljs-string">'blah'</span>;
                    <span class="hljs-keyword">var</span> auth = Browser.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: creds });
                    expect(auth).to.not.exist();
                    done();
                });
            });
        });

        describe(<span class="hljs-string">'authenticateTimestamp()'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            it(<span class="hljs-string">'validates a timestamp'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials</span>) </span>{

                    <span class="hljs-keyword">var</span> tsm = Hawk.crypto.timestampMessage(credentials);
                    expect(Browser.client.authenticateTimestamp(tsm, credentials)).to.equal(<span class="hljs-literal">true</span>);
                    done();
                });
            });

            it(<span class="hljs-string">'validates a timestamp without updating local time'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials</span>) </span>{

                    <span class="hljs-keyword">var</span> offset = Browser.utils.getNtpOffset();
                    <span class="hljs-keyword">var</span> tsm = Hawk.crypto.timestampMessage(credentials, <span class="hljs-number">10000</span>);
                    expect(Browser.client.authenticateTimestamp(tsm, credentials, <span class="hljs-literal">false</span>)).to.equal(<span class="hljs-literal">true</span>);
                    expect(offset).to.equal(Browser.utils.getNtpOffset());
                    done();
                });
            });

            it(<span class="hljs-string">'detects a bad timestamp'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials</span>) </span>{

                    <span class="hljs-keyword">var</span> tsm = Hawk.crypto.timestampMessage(credentials);
                    tsm.ts = <span class="hljs-number">4</span>;
                    expect(Browser.client.authenticateTimestamp(tsm, credentials)).to.equal(<span class="hljs-literal">false</span>);
                    done();
                });
            });
        });
    });

    describe(<span class="hljs-string">'internals'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        describe(<span class="hljs-string">'LocalStorage'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

            it(<span class="hljs-string">'goes through the full lifecycle'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> storage = <span class="hljs-keyword">new</span> Browser.internals.LocalStorage();
                expect(storage.length).to.equal(<span class="hljs-number">0</span>);
                expect(storage.getItem(<span class="hljs-string">'a'</span>)).to.equal(<span class="hljs-literal">null</span>);
                storage.setItem(<span class="hljs-string">'a'</span>, <span class="hljs-number">5</span>);
                expect(storage.length).to.equal(<span class="hljs-number">1</span>);
                expect(storage.key()).to.equal(<span class="hljs-string">'a'</span>);
                expect(storage.key(<span class="hljs-number">0</span>)).to.equal(<span class="hljs-string">'a'</span>);
                expect(storage.getItem(<span class="hljs-string">'a'</span>)).to.equal(<span class="hljs-string">'5'</span>);
                storage.setItem(<span class="hljs-string">'b'</span>, <span class="hljs-string">'test'</span>);
                expect(storage.key()).to.equal(<span class="hljs-string">'a'</span>);
                expect(storage.key(<span class="hljs-number">0</span>)).to.equal(<span class="hljs-string">'a'</span>);
                expect(storage.key(<span class="hljs-number">1</span>)).to.equal(<span class="hljs-string">'b'</span>);
                expect(storage.length).to.equal(<span class="hljs-number">2</span>);
                expect(storage.getItem(<span class="hljs-string">'b'</span>)).to.equal(<span class="hljs-string">'test'</span>);
                storage.removeItem(<span class="hljs-string">'a'</span>);
                expect(storage.length).to.equal(<span class="hljs-number">1</span>);
                expect(storage.getItem(<span class="hljs-string">'a'</span>)).to.equal(<span class="hljs-literal">null</span>);
                expect(storage.getItem(<span class="hljs-string">'b'</span>)).to.equal(<span class="hljs-string">'test'</span>);
                storage.clear();
                expect(storage.length).to.equal(<span class="hljs-number">0</span>);
                expect(storage.getItem(<span class="hljs-string">'a'</span>)).to.equal(<span class="hljs-literal">null</span>);
                expect(storage.getItem(<span class="hljs-string">'b'</span>)).to.equal(<span class="hljs-literal">null</span>);
                done();
            });
        });
    });

    describe(<span class="hljs-string">'utils'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        describe(<span class="hljs-string">'setStorage()'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

            it(<span class="hljs-string">'sets storage for the first time'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                Browser.utils.storage = <span class="hljs-keyword">new</span> Browser.internals.LocalStorage();        <span class="hljs-comment">// Reset state</span>

                expect(Browser.utils.storage.getItem(<span class="hljs-string">'hawk_ntp_offset'</span>)).to.not.exist();
                Browser.utils.storage.setItem(<span class="hljs-string">'test'</span>, <span class="hljs-string">'1'</span>);
                Browser.utils.setStorage(<span class="hljs-keyword">new</span> Browser.internals.LocalStorage());
                expect(Browser.utils.storage.getItem(<span class="hljs-string">'test'</span>)).to.not.exist();
                Browser.utils.storage.setItem(<span class="hljs-string">'test'</span>, <span class="hljs-string">'2'</span>);
                expect(Browser.utils.storage.getItem(<span class="hljs-string">'test'</span>)).to.equal(<span class="hljs-string">'2'</span>);
                done();
            });
        });

        describe(<span class="hljs-string">'setNtpOffset()'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            it(<span class="hljs-string">'catches localStorage errors'</span>, { <span class="hljs-attr">parallel</span>: <span class="hljs-literal">false</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> orig = Browser.utils.storage.setItem;
                <span class="hljs-keyword">var</span> consoleOrig = <span class="hljs-built_in">console</span>.error;
                <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>;
                <span class="hljs-built_in">console</span>.error = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

                    <span class="hljs-keyword">if</span> (count++ === <span class="hljs-number">2</span>) {

                        <span class="hljs-built_in">console</span>.error = consoleOrig;
                    }
                };

                Browser.utils.storage.setItem = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

                    Browser.utils.storage.setItem = orig;
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>();
                };

                expect(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

                    Browser.utils.setNtpOffset(<span class="hljs-number">100</span>);
                }).not.to.throw();

                done();
            });
        });

        describe(<span class="hljs-string">'parseAuthorizationHeader()'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            it(<span class="hljs-string">'returns null on missing header'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                expect(Browser.utils.parseAuthorizationHeader()).to.equal(<span class="hljs-literal">null</span>);
                done();
            });

            it(<span class="hljs-string">'returns null on bad header syntax (structure)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                expect(Browser.utils.parseAuthorizationHeader(<span class="hljs-string">'Hawk'</span>)).to.equal(<span class="hljs-literal">null</span>);
                done();
            });

            it(<span class="hljs-string">'returns null on bad header syntax (parts)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                expect(Browser.utils.parseAuthorizationHeader(<span class="hljs-string">' '</span>)).to.equal(<span class="hljs-literal">null</span>);
                done();
            });

            it(<span class="hljs-string">'returns null on bad scheme name'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                expect(Browser.utils.parseAuthorizationHeader(<span class="hljs-string">'Basic asdasd'</span>)).to.equal(<span class="hljs-literal">null</span>);
                done();
            });

            it(<span class="hljs-string">'returns null on bad attribute value'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                expect(Browser.utils.parseAuthorizationHeader(<span class="hljs-string">'Hawk test="\t"'</span>, [<span class="hljs-string">'test'</span>])).to.equal(<span class="hljs-literal">null</span>);
                done();
            });

            it(<span class="hljs-string">'returns null on duplicated attribute'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                expect(Browser.utils.parseAuthorizationHeader(<span class="hljs-string">'Hawk test="a", test="b"'</span>, [<span class="hljs-string">'test'</span>])).to.equal(<span class="hljs-literal">null</span>);
                done();
            });
        });

        describe(<span class="hljs-string">'parseUri()'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

            it(<span class="hljs-string">'returns empty object on invalid'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> uri = Browser.utils.parseUri(<span class="hljs-string">'ftp'</span>);
                expect(uri).to.deep.equal({ <span class="hljs-attr">host</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">port</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">resource</span>: <span class="hljs-string">''</span> });
                done();
            });

            it(<span class="hljs-string">'returns empty port when unknown scheme'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> uri = Browser.utils.parseUri(<span class="hljs-string">'ftp://example.com'</span>);
                expect(uri.port).to.equal(<span class="hljs-string">''</span>);
                done();
            });

            it(<span class="hljs-string">'returns default port when missing'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> uri = Browser.utils.parseUri(<span class="hljs-string">'http://example.com'</span>);
                expect(uri.port).to.equal(<span class="hljs-string">'80'</span>);
                done();
            });

            it(<span class="hljs-string">'handles unusual characters correctly'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                <span class="hljs-keyword">var</span> parts = {
                    <span class="hljs-attr">protocol</span>: <span class="hljs-string">'http+vnd.my-extension'</span>,
                    <span class="hljs-attr">user</span>: <span class="hljs-string">'user!$&amp;\'()*+,;=%40my-domain.com'</span>,
                    <span class="hljs-attr">password</span>: <span class="hljs-string">'pass!$&amp;\'()*+,;=%40:word'</span>,
                    <span class="hljs-attr">hostname</span>: <span class="hljs-string">'foo-bar.com'</span>,
                    <span class="hljs-attr">port</span>: <span class="hljs-string">'99'</span>,
                    <span class="hljs-attr">pathname</span>: <span class="hljs-string">'/path/%40/!$&amp;\'()*+,;=:@/'</span>,
                    <span class="hljs-attr">query</span>: <span class="hljs-string">'query%40/!$&amp;\'()*+,;=:@/?'</span>,
                    <span class="hljs-attr">fragment</span>: <span class="hljs-string">'fragm%40/!$&amp;\'()*+,;=:@/?'</span>
                };

                parts.userInfo = parts.user + <span class="hljs-string">':'</span> + parts.password;
                parts.authority = parts.userInfo + <span class="hljs-string">'@'</span> + parts.hostname + <span class="hljs-string">':'</span> + parts.port;
                parts.relative = parts.pathname + <span class="hljs-string">'?'</span> + parts.query;
                parts.resource = parts.relative + <span class="hljs-string">'#'</span> + parts.fragment;
                parts.source = parts.protocol + <span class="hljs-string">'://'</span> + parts.authority + parts.resource;

                <span class="hljs-keyword">var</span> uri = Browser.utils.parseUri(parts.source);
                expect(uri.host).to.equal(<span class="hljs-string">'foo-bar.com'</span>);
                expect(uri.port).to.equal(<span class="hljs-string">'99'</span>);
                expect(uri.resource).to.equal(parts.pathname + <span class="hljs-string">'?'</span> + parts.query);
                done();
            });
        });

        <span class="hljs-keyword">var</span> str = <span class="hljs-string">'https://www.google.ca/webhp?sourceid=chrome-instant&amp;ion=1&amp;espv=2&amp;ie=UTF-8#q=url'</span>;
        <span class="hljs-keyword">var</span> base64str = <span class="hljs-string">'aHR0cHM6Ly93d3cuZ29vZ2xlLmNhL3dlYmhwP3NvdXJjZWlkPWNocm9tZS1pbnN0YW50Jmlvbj0xJmVzcHY9MiZpZT1VVEYtOCNxPXVybA'</span>;

        describe(<span class="hljs-string">'base64urlEncode()'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

            it(<span class="hljs-string">'should base64 URL-safe decode a string'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

                expect(Browser.utils.base64urlEncode(str)).to.equal(base64str);
                done();
            });
        });
    });
});

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>uri.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/hawk/test/uri.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>uri.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>Load modules</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> Http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);
<span class="hljs-keyword">var</span> Url = <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>);
<span class="hljs-keyword">var</span> Code = <span class="hljs-built_in">require</span>(<span class="hljs-string">'code'</span>);
<span class="hljs-keyword">var</span> Hawk = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib'</span>);
<span class="hljs-keyword">var</span> Hoek = <span class="hljs-built_in">require</span>(<span class="hljs-string">'hoek'</span>);
<span class="hljs-keyword">var</span> Lab = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lab'</span>);


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Declare internals</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> internals = {};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Test shortcuts</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> lab = exports.lab = Lab.script();
<span class="hljs-keyword">var</span> describe = lab.experiment;
<span class="hljs-keyword">var</span> it = lab.test;
<span class="hljs-keyword">var</span> expect = Code.expect;


describe(<span class="hljs-string">'Uri'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">var</span> credentialsFunc = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id, callback</span>) </span>{

        <span class="hljs-keyword">var</span> credentials = {
            <span class="hljs-attr">id</span>: id,
            <span class="hljs-attr">key</span>: <span class="hljs-string">'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn'</span>,
            <span class="hljs-attr">algorithm</span>: (id === <span class="hljs-string">'1'</span> ? <span class="hljs-string">'sha1'</span> : <span class="hljs-string">'sha256'</span>),
            <span class="hljs-attr">user</span>: <span class="hljs-string">'steve'</span>
        };

        <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, credentials);
    };

    it(<span class="hljs-string">'should generate a bewit then successfully authenticate it'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?a=1&amp;b=2'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">80</span>
        };

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            <span class="hljs-keyword">var</span> bewit = Hawk.uri.getBewit(<span class="hljs-string">'http://example.com/resource/4?a=1&amp;b=2'</span>, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span> * <span class="hljs-number">365</span> * <span class="hljs-number">100</span>, <span class="hljs-attr">ext</span>: <span class="hljs-string">'some-app-data'</span> });
            req.url += <span class="hljs-string">'&amp;bewit='</span> + bewit;

            Hawk.uri.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, attributes</span>) </span>{

                expect(err).to.not.exist();
                expect(credentials2.user).to.equal(<span class="hljs-string">'steve'</span>);
                expect(attributes.ext).to.equal(<span class="hljs-string">'some-app-data'</span>);
                done();
            });
        });
    });

    it(<span class="hljs-string">'should generate a bewit then successfully authenticate it (no ext)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?a=1&amp;b=2'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">80</span>
        };

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            <span class="hljs-keyword">var</span> bewit = Hawk.uri.getBewit(<span class="hljs-string">'http://example.com/resource/4?a=1&amp;b=2'</span>, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span> * <span class="hljs-number">365</span> * <span class="hljs-number">100</span> });
            req.url += <span class="hljs-string">'&amp;bewit='</span> + bewit;

            Hawk.uri.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, attributes</span>) </span>{

                expect(err).to.not.exist();
                expect(credentials2.user).to.equal(<span class="hljs-string">'steve'</span>);
                done();
            });
        });
    });

    it(<span class="hljs-string">'should successfully authenticate a request (last param)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?a=1&amp;b=2&amp;bewit=MTIzNDU2XDQ1MTE0ODQ2MjFcMzFjMmNkbUJFd1NJRVZDOVkva1NFb2c3d3YrdEVNWjZ3RXNmOGNHU2FXQT1cc29tZS1hcHAtZGF0YQ'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        Hawk.uri.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials, attributes</span>) </span>{

            expect(err).to.not.exist();
            expect(credentials.user).to.equal(<span class="hljs-string">'steve'</span>);
            expect(attributes.ext).to.equal(<span class="hljs-string">'some-app-data'</span>);
            done();
        });
    });

    it(<span class="hljs-string">'should successfully authenticate a request (first param)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?bewit=MTIzNDU2XDQ1MTE0ODQ2MjFcMzFjMmNkbUJFd1NJRVZDOVkva1NFb2c3d3YrdEVNWjZ3RXNmOGNHU2FXQT1cc29tZS1hcHAtZGF0YQ&amp;a=1&amp;b=2'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        Hawk.uri.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials, attributes</span>) </span>{

            expect(err).to.not.exist();
            expect(credentials.user).to.equal(<span class="hljs-string">'steve'</span>);
            expect(attributes.ext).to.equal(<span class="hljs-string">'some-app-data'</span>);
            done();
        });
    });

    it(<span class="hljs-string">'should successfully authenticate a request (only param)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?bewit=MTIzNDU2XDQ1MTE0ODQ2NDFcZm1CdkNWT3MvcElOTUUxSTIwbWhrejQ3UnBwTmo4Y1VrSHpQd3Q5OXJ1cz1cc29tZS1hcHAtZGF0YQ'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        Hawk.uri.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials, attributes</span>) </span>{

            expect(err).to.not.exist();
            expect(credentials.user).to.equal(<span class="hljs-string">'steve'</span>);
            expect(attributes.ext).to.equal(<span class="hljs-string">'some-app-data'</span>);
            done();
        });
    });

    it(<span class="hljs-string">'should fail on multiple authentication'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?bewit=MTIzNDU2XDQ1MTE0ODQ2NDFcZm1CdkNWT3MvcElOTUUxSTIwbWhrejQ3UnBwTmo4Y1VrSHpQd3Q5OXJ1cz1cc29tZS1hcHAtZGF0YQ'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>,
            <span class="hljs-attr">authorization</span>: <span class="hljs-string">'Basic asdasdasdasd'</span>
        };

        Hawk.uri.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials, attributes</span>) </span>{

            expect(err).to.exist();
            expect(err.output.payload.message).to.equal(<span class="hljs-string">'Multiple authentications'</span>);
            done();
        });
    });

    it(<span class="hljs-string">'should fail on method other than GET'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

            <span class="hljs-keyword">var</span> req = {
                <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
                <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?filter=a'</span>,
                <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
                <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
            };

            <span class="hljs-keyword">var</span> exp = <span class="hljs-built_in">Math</span>.floor(Hawk.utils.now() / <span class="hljs-number">1000</span>) + <span class="hljs-number">60</span>;
            <span class="hljs-keyword">var</span> ext = <span class="hljs-string">'some-app-data'</span>;
            <span class="hljs-keyword">var</span> mac = Hawk.crypto.calculateMac(<span class="hljs-string">'bewit'</span>, credentials1, {
                <span class="hljs-attr">timestamp</span>: exp,
                <span class="hljs-attr">nonce</span>: <span class="hljs-string">''</span>,
                <span class="hljs-attr">method</span>: req.method,
                <span class="hljs-attr">resource</span>: req.url,
                <span class="hljs-attr">host</span>: req.host,
                <span class="hljs-attr">port</span>: req.port,
                <span class="hljs-attr">ext</span>: ext
            });

            <span class="hljs-keyword">var</span> bewit = credentials1.id + <span class="hljs-string">'\\'</span> + exp + <span class="hljs-string">'\\'</span> + mac + <span class="hljs-string">'\\'</span> + ext;

            req.url += <span class="hljs-string">'&amp;bewit='</span> + Hoek.base64urlEncode(bewit);

            Hawk.uri.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2, attributes</span>) </span>{

                expect(err).to.exist();
                expect(err.output.payload.message).to.equal(<span class="hljs-string">'Invalid method'</span>);
                done();
            });
        });
    });

    it(<span class="hljs-string">'should fail on invalid host header'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ'</span>,
            <span class="hljs-attr">headers</span>: {
                <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com:something'</span>
            }
        };

        Hawk.uri.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials, attributes</span>) </span>{

            expect(err).to.exist();
            expect(err.output.payload.message).to.equal(<span class="hljs-string">'Invalid Host header'</span>);
            done();
        });
    });

    it(<span class="hljs-string">'should fail on empty bewit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?bewit='</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        Hawk.uri.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials, attributes</span>) </span>{

            expect(err).to.exist();
            expect(err.output.payload.message).to.equal(<span class="hljs-string">'Empty bewit'</span>);
            expect(err.isMissing).to.not.exist();
            done();
        });
    });

    it(<span class="hljs-string">'should fail on invalid bewit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?bewit=*'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        Hawk.uri.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials, attributes</span>) </span>{

            expect(err).to.exist();
            expect(err.output.payload.message).to.equal(<span class="hljs-string">'Invalid bewit encoding'</span>);
            expect(err.isMissing).to.not.exist();
            done();
        });
    });

    it(<span class="hljs-string">'should fail on missing bewit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        Hawk.uri.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials, attributes</span>) </span>{

            expect(err).to.exist();
            expect(err.output.payload.message).to.not.exist();
            expect(err.isMissing).to.equal(<span class="hljs-literal">true</span>);
            done();
        });
    });

    it(<span class="hljs-string">'should fail on invalid bewit structure'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?bewit=abc'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        Hawk.uri.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials, attributes</span>) </span>{

            expect(err).to.exist();
            expect(err.output.payload.message).to.equal(<span class="hljs-string">'Invalid bewit structure'</span>);
            done();
        });
    });

    it(<span class="hljs-string">'should fail on empty bewit attribute'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?bewit=YVxcY1xk'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        Hawk.uri.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials, attributes</span>) </span>{

            expect(err).to.exist();
            expect(err.output.payload.message).to.equal(<span class="hljs-string">'Missing bewit attributes'</span>);
            done();
        });
    });

    it(<span class="hljs-string">'should fail on missing bewit id attribute'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?bewit=XDQ1NTIxNDc2MjJcK0JFbFhQMXhuWjcvd1Nrbm1ldGhlZm5vUTNHVjZNSlFVRHk4NWpTZVJ4VT1cc29tZS1hcHAtZGF0YQ'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        Hawk.uri.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials, attributes</span>) </span>{

            expect(err).to.exist();
            expect(err.output.payload.message).to.equal(<span class="hljs-string">'Missing bewit attributes'</span>);
            done();
        });
    });

    it(<span class="hljs-string">'should fail on expired access'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?a=1&amp;b=2&amp;bewit=MTIzNDU2XDEzNTY0MTg1ODNcWk1wZlMwWU5KNHV0WHpOMmRucTRydEk3NXNXTjFjeWVITTcrL0tNZFdVQT1cc29tZS1hcHAtZGF0YQ'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        Hawk.uri.authenticate(req, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials, attributes</span>) </span>{

            expect(err).to.exist();
            expect(err.output.payload.message).to.equal(<span class="hljs-string">'Access expired'</span>);
            done();
        });
    });

    it(<span class="hljs-string">'should fail on credentials function error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        Hawk.uri.authenticate(req, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id, callback</span>) </span>{

            callback(Hawk.error.badRequest(<span class="hljs-string">'Boom'</span>));
        }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials, attributes</span>) </span>{

            expect(err).to.exist();
            expect(err.output.payload.message).to.equal(<span class="hljs-string">'Boom'</span>);
            done();
        });
    });

    it(<span class="hljs-string">'should fail on credentials function error with credentials'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        Hawk.uri.authenticate(req, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id, callback</span>) </span>{

            callback(Hawk.error.badRequest(<span class="hljs-string">'Boom'</span>), { <span class="hljs-attr">some</span>: <span class="hljs-string">'value'</span> });
        }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials, attributes</span>) </span>{

            expect(err).to.exist();
            expect(err.output.payload.message).to.equal(<span class="hljs-string">'Boom'</span>);
            expect(credentials.some).to.equal(<span class="hljs-string">'value'</span>);
            done();
        });
    });

    it(<span class="hljs-string">'should fail on null credentials function response'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        Hawk.uri.authenticate(req, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id, callback</span>) </span>{

            callback(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
        }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials, attributes</span>) </span>{

            expect(err).to.exist();
            expect(err.output.payload.message).to.equal(<span class="hljs-string">'Unknown credentials'</span>);
            done();
        });
    });

    it(<span class="hljs-string">'should fail on invalid credentials function response'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        Hawk.uri.authenticate(req, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id, callback</span>) </span>{

            callback(<span class="hljs-literal">null</span>, {});
        }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials, attributes</span>) </span>{

            expect(err).to.exist();
            expect(err.message).to.equal(<span class="hljs-string">'Invalid credentials'</span>);
            done();
        });
    });

    it(<span class="hljs-string">'should fail on invalid credentials function response (unknown algorithm)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        Hawk.uri.authenticate(req, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id, callback</span>) </span>{

            callback(<span class="hljs-literal">null</span>, { <span class="hljs-attr">key</span>: <span class="hljs-string">'xxx'</span>, <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'xxx'</span> });
        }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials, attributes</span>) </span>{

            expect(err).to.exist();
            expect(err.message).to.equal(<span class="hljs-string">'Unknown algorithm'</span>);
            done();
        });
    });

    it(<span class="hljs-string">'should fail on expired access'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

        <span class="hljs-keyword">var</span> req = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ'</span>,
            <span class="hljs-attr">host</span>: <span class="hljs-string">'example.com'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>
        };

        Hawk.uri.authenticate(req, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id, callback</span>) </span>{

            callback(<span class="hljs-literal">null</span>, { <span class="hljs-attr">key</span>: <span class="hljs-string">'xxx'</span>, <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span> });
        }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials, attributes</span>) </span>{

            expect(err).to.exist();
            expect(err.output.payload.message).to.equal(<span class="hljs-string">'Bad mac'</span>);
            done();
        });
    });

    describe(<span class="hljs-string">'getBewit()'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        it(<span class="hljs-string">'returns a valid bewit value'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Hawk.uri.getBewit(<span class="hljs-string">'https://example.com/somewhere/over/the/rainbow'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">localtimeOffsetMsec</span>: <span class="hljs-number">1356420407232</span> - Hawk.utils.now(), <span class="hljs-attr">ext</span>: <span class="hljs-string">'xandyandz'</span> });
            expect(bewit).to.equal(<span class="hljs-string">'MTIzNDU2XDEzNTY0MjA3MDdca3NjeHdOUjJ0SnBQMVQxekRMTlBiQjVVaUtJVTl0T1NKWFRVZEc3WDloOD1ceGFuZHlhbmR6'</span>);
            done();
        });

        it(<span class="hljs-string">'returns a valid bewit value (explicit port)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Hawk.uri.getBewit(<span class="hljs-string">'https://example.com:8080/somewhere/over/the/rainbow'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">localtimeOffsetMsec</span>: <span class="hljs-number">1356420407232</span> - Hawk.utils.now(), <span class="hljs-attr">ext</span>: <span class="hljs-string">'xandyandz'</span> });
            expect(bewit).to.equal(<span class="hljs-string">'MTIzNDU2XDEzNTY0MjA3MDdcaFpiSjNQMmNLRW80a3kwQzhqa1pBa1J5Q1p1ZWc0V1NOYnhWN3ZxM3hIVT1ceGFuZHlhbmR6'</span>);
            done();
        });

        it(<span class="hljs-string">'returns a valid bewit value (null ext)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Hawk.uri.getBewit(<span class="hljs-string">'https://example.com/somewhere/over/the/rainbow'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">localtimeOffsetMsec</span>: <span class="hljs-number">1356420407232</span> - Hawk.utils.now(), <span class="hljs-attr">ext</span>: <span class="hljs-literal">null</span> });
            expect(bewit).to.equal(<span class="hljs-string">'MTIzNDU2XDEzNTY0MjA3MDdcSUdZbUxnSXFMckNlOEN4dktQczRKbFdJQStValdKSm91d2dBUmlWaENBZz1c'</span>);
            done();
        });

        it(<span class="hljs-string">'returns a valid bewit value (parsed uri)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Hawk.uri.getBewit(Url.parse(<span class="hljs-string">'https://example.com/somewhere/over/the/rainbow'</span>), { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">localtimeOffsetMsec</span>: <span class="hljs-number">1356420407232</span> - Hawk.utils.now(), <span class="hljs-attr">ext</span>: <span class="hljs-string">'xandyandz'</span> });
            expect(bewit).to.equal(<span class="hljs-string">'MTIzNDU2XDEzNTY0MjA3MDdca3NjeHdOUjJ0SnBQMVQxekRMTlBiQjVVaUtJVTl0T1NKWFRVZEc3WDloOD1ceGFuZHlhbmR6'</span>);
            done();
        });

        it(<span class="hljs-string">'errors on invalid options'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Hawk.uri.getBewit(<span class="hljs-string">'https://example.com/somewhere/over/the/rainbow'</span>, <span class="hljs-number">4</span>);
            expect(bewit).to.equal(<span class="hljs-string">''</span>);
            done();
        });

        it(<span class="hljs-string">'errors on missing uri'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Hawk.uri.getBewit(<span class="hljs-string">''</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">localtimeOffsetMsec</span>: <span class="hljs-number">1356420407232</span> - Hawk.utils.now(), <span class="hljs-attr">ext</span>: <span class="hljs-string">'xandyandz'</span> });
            expect(bewit).to.equal(<span class="hljs-string">''</span>);
            done();
        });

        it(<span class="hljs-string">'errors on invalid uri'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Hawk.uri.getBewit(<span class="hljs-number">5</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">localtimeOffsetMsec</span>: <span class="hljs-number">1356420407232</span> - Hawk.utils.now(), <span class="hljs-attr">ext</span>: <span class="hljs-string">'xandyandz'</span> });
            expect(bewit).to.equal(<span class="hljs-string">''</span>);
            done();
        });

        it(<span class="hljs-string">'errors on invalid credentials (id)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Hawk.uri.getBewit(<span class="hljs-string">'https://example.com/somewhere/over/the/rainbow'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">3000</span>, <span class="hljs-attr">ext</span>: <span class="hljs-string">'xandyandz'</span> });
            expect(bewit).to.equal(<span class="hljs-string">''</span>);
            done();
        });

        it(<span class="hljs-string">'errors on missing credentials'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> bewit = Hawk.uri.getBewit(<span class="hljs-string">'https://example.com/somewhere/over/the/rainbow'</span>, { <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">3000</span>, <span class="hljs-attr">ext</span>: <span class="hljs-string">'xandyandz'</span> });
            expect(bewit).to.equal(<span class="hljs-string">''</span>);
            done();
        });

        it(<span class="hljs-string">'errors on invalid credentials (key)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'sha256'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Hawk.uri.getBewit(<span class="hljs-string">'https://example.com/somewhere/over/the/rainbow'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">3000</span>, <span class="hljs-attr">ext</span>: <span class="hljs-string">'xandyandz'</span> });
            expect(bewit).to.equal(<span class="hljs-string">''</span>);
            done();
        });

        it(<span class="hljs-string">'errors on invalid algorithm'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'hmac-sha-0'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Hawk.uri.getBewit(<span class="hljs-string">'https://example.com/somewhere/over/the/rainbow'</span>, { <span class="hljs-attr">credentials</span>: credentials, <span class="hljs-attr">ttlSec</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">ext</span>: <span class="hljs-string">'xandyandz'</span> });
            expect(bewit).to.equal(<span class="hljs-string">''</span>);
            done();
        });

        it(<span class="hljs-string">'errors on missing options'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> credentials = {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'123456'</span>,
                <span class="hljs-attr">key</span>: <span class="hljs-string">'2983d45yun89q'</span>,
                <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'hmac-sha-0'</span>
            };

            <span class="hljs-keyword">var</span> bewit = Hawk.uri.getBewit(<span class="hljs-string">'https://example.com/somewhere/over/the/rainbow'</span>);
            expect(bewit).to.equal(<span class="hljs-string">''</span>);
            done();
        });
    });

    describe(<span class="hljs-string">'authenticateMessage()'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        it(<span class="hljs-string">'should generate an authorization then successfully parse it'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

                <span class="hljs-keyword">var</span> auth = Hawk.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: credentials1 });
                expect(auth).to.exist();

                Hawk.server.authenticateMessage(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, auth, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2</span>) </span>{

                    expect(err).to.not.exist();
                    expect(credentials2.user).to.equal(<span class="hljs-string">'steve'</span>);
                    done();
                });
            });
        });

        it(<span class="hljs-string">'should fail authorization on mismatching host'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

                <span class="hljs-keyword">var</span> auth = Hawk.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: credentials1 });
                expect(auth).to.exist();

                Hawk.server.authenticateMessage(<span class="hljs-string">'example1.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, auth, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2</span>) </span>{

                    expect(err).to.exist();
                    expect(err.message).to.equal(<span class="hljs-string">'Bad mac'</span>);
                    done();
                });
            });
        });

        it(<span class="hljs-string">'should fail authorization on stale timestamp'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

                <span class="hljs-keyword">var</span> auth = Hawk.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: credentials1 });
                expect(auth).to.exist();

                Hawk.server.authenticateMessage(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, auth, credentialsFunc, { <span class="hljs-attr">localtimeOffsetMsec</span>: <span class="hljs-number">100000</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2</span>) </span>{

                    expect(err).to.exist();
                    expect(err.message).to.equal(<span class="hljs-string">'Stale timestamp'</span>);
                    done();
                });
            });
        });

        it(<span class="hljs-string">'overrides timestampSkewSec'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

                <span class="hljs-keyword">var</span> auth = Hawk.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: credentials1, <span class="hljs-attr">localtimeOffsetMsec</span>: <span class="hljs-number">100000</span> });
                expect(auth).to.exist();

                Hawk.server.authenticateMessage(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, auth, credentialsFunc, { <span class="hljs-attr">timestampSkewSec</span>: <span class="hljs-number">500</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2</span>) </span>{

                    expect(err).to.not.exist();
                    done();
                });
            });
        });

        it(<span class="hljs-string">'should fail authorization on invalid authorization'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

                <span class="hljs-keyword">var</span> auth = Hawk.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: credentials1 });
                expect(auth).to.exist();
                <span class="hljs-keyword">delete</span> auth.id;

                Hawk.server.authenticateMessage(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, auth, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2</span>) </span>{

                    expect(err).to.exist();
                    expect(err.message).to.equal(<span class="hljs-string">'Invalid authorization'</span>);
                    done();
                });
            });
        });

        it(<span class="hljs-string">'should fail authorization on bad hash'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

                <span class="hljs-keyword">var</span> auth = Hawk.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: credentials1 });
                expect(auth).to.exist();

                Hawk.server.authenticateMessage(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message1'</span>, auth, credentialsFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2</span>) </span>{

                    expect(err).to.exist();
                    expect(err.message).to.equal(<span class="hljs-string">'Bad message hash'</span>);
                    done();
                });
            });
        });

        it(<span class="hljs-string">'should fail authorization on nonce error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

                <span class="hljs-keyword">var</span> auth = Hawk.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: credentials1 });
                expect(auth).to.exist();

                Hawk.server.authenticateMessage(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, auth, credentialsFunc, {
                    <span class="hljs-attr">nonceFunc</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, nonce, ts, callback</span>) </span>{

                        callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'kaboom'</span>));
                    }
                }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2</span>) </span>{

                    expect(err).to.exist();
                    expect(err.message).to.equal(<span class="hljs-string">'Invalid nonce'</span>);
                    done();
                });
            });
        });

        it(<span class="hljs-string">'should fail authorization on credentials error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

                <span class="hljs-keyword">var</span> auth = Hawk.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: credentials1 });
                expect(auth).to.exist();

                <span class="hljs-keyword">var</span> errFunc = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id, callback</span>) </span>{

                    callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'kablooey'</span>));
                };

                Hawk.server.authenticateMessage(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, auth, errFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2</span>) </span>{

                    expect(err).to.exist();
                    expect(err.message).to.equal(<span class="hljs-string">'kablooey'</span>);
                    done();
                });
            });
        });

        it(<span class="hljs-string">'should fail authorization on missing credentials'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

                <span class="hljs-keyword">var</span> auth = Hawk.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: credentials1 });
                expect(auth).to.exist();

                <span class="hljs-keyword">var</span> errFunc = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id, callback</span>) </span>{

                    callback();
                };

                Hawk.server.authenticateMessage(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, auth, errFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2</span>) </span>{

                    expect(err).to.exist();
                    expect(err.message).to.equal(<span class="hljs-string">'Unknown credentials'</span>);
                    done();
                });
            });
        });

        it(<span class="hljs-string">'should fail authorization on invalid credentials'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

                <span class="hljs-keyword">var</span> auth = Hawk.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: credentials1 });
                expect(auth).to.exist();

                <span class="hljs-keyword">var</span> errFunc = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id, callback</span>) </span>{

                    callback(<span class="hljs-literal">null</span>, {});
                };

                Hawk.server.authenticateMessage(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, auth, errFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2</span>) </span>{

                    expect(err).to.exist();
                    expect(err.message).to.equal(<span class="hljs-string">'Invalid credentials'</span>);
                    done();
                });
            });
        });

        it(<span class="hljs-string">'should fail authorization on invalid credentials algorithm'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

                <span class="hljs-keyword">var</span> auth = Hawk.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: credentials1 });
                expect(auth).to.exist();

                <span class="hljs-keyword">var</span> errFunc = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id, callback</span>) </span>{

                    callback(<span class="hljs-literal">null</span>, { <span class="hljs-attr">key</span>: <span class="hljs-string">'123'</span>, <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'456'</span> });
                };

                Hawk.server.authenticateMessage(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, auth, errFunc, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials2</span>) </span>{

                    expect(err).to.exist();
                    expect(err.message).to.equal(<span class="hljs-string">'Unknown algorithm'</span>);
                    done();
                });
            });
        });

        it(<span class="hljs-string">'should fail on missing host'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

                <span class="hljs-keyword">var</span> auth = Hawk.client.message(<span class="hljs-literal">null</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: credentials1 });
                expect(auth).to.not.exist();
                done();
            });
        });

        it(<span class="hljs-string">'should fail on missing credentials'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            <span class="hljs-keyword">var</span> auth = Hawk.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, {});
            expect(auth).to.not.exist();
            done();
        });

        it(<span class="hljs-string">'should fail on invalid algorithm'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{

            credentialsFunc(<span class="hljs-string">'123456'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials1</span>) </span>{

                <span class="hljs-keyword">var</span> creds = Hoek.clone(credentials1);
                creds.algorithm = <span class="hljs-string">'blah'</span>;
                <span class="hljs-keyword">var</span> auth = Hawk.client.message(<span class="hljs-string">'example.com'</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">'some message'</span>, { <span class="hljs-attr">credentials</span>: creds });
                expect(auth).to.not.exist();
                done();
            });
        });
    });
});


</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

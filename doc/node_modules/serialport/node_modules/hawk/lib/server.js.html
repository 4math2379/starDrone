<!DOCTYPE html>
<html>
<head>
  <title>server.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/hawk/lib/server.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>server.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>Load modules</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> Boom = <span class="hljs-built_in">require</span>(<span class="hljs-string">'boom'</span>);
<span class="hljs-keyword">var</span> Hoek = <span class="hljs-built_in">require</span>(<span class="hljs-string">'hoek'</span>);
<span class="hljs-keyword">var</span> Cryptiles = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cryptiles'</span>);
<span class="hljs-keyword">var</span> Crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./crypto'</span>);
<span class="hljs-keyword">var</span> Utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./utils'</span>);


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Declare internals</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> internals = {};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Hawk authentication</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<div class="dox">
<div class="summary">
<p>req:                 node's HTTP request object or an object as follows:</p>
<p>var request = {
method: 'GET',
url: '/resource/4?a=1&amp;b=2',
host: 'example.com',
port: 8080,
authorization: 'Hawk id=&quot;dh37fgj492je&quot;, ts=&quot;1353832234&quot;, nonce=&quot;j4h3g2&quot;, ext=&quot;some-app-ext-data&quot;, mac=&quot;6R4rV5iE+NPoym+WwjeHzjAGXUtLNIxmo1vpMofpLAE=&quot;'
};</p>
<p>credentialsFunc:     required function to lookup the set of Hawk credentials based on the provided credentials id.
The credentials include the MAC key, MAC algorithm, and other attributes (such as username)
needed by the application. This function is the equivalent of verifying the username and
password in Basic authentication.</p>
<p>var credentialsFunc = function (id, callback) {</p>
<p>// Lookup credentials in database
db.lookup(id, function (err, item) {</p>
<p>if (err || !item) {
return callback(err);
}</p>
<p>var credentials = {
// Required
key: item.key,
algorithm: item.algorithm,
// Application specific
user: item.user
};</p>
<p>return callback(null, credentials);
});
};</p>
<p>options: {</p>
<p>hostHeaderName:        optional header field name, used to override the default 'Host' header when used
behind a cache of a proxy. Apache2 changes the value of the 'Host' header while preserving
the original (which is what the module must verify) in the 'x-forwarded-host' header field.
Only used when passed a node Http.ServerRequest object.</p>
<p>nonceFunc:             optional nonce validation function. The function signature is function(key, nonce, ts, callback)
where 'callback' must be called using the signature function(err).</p>
<p>timestampSkewSec:      optional number of seconds of permitted clock skew for incoming timestamps. Defaults to 60 seconds.
Provides a +/- skew which means actual allowed window is double the number of seconds.</p>
<p>localtimeOffsetMsec:   optional local clock time offset express in a number of milliseconds (positive or negative).
Defaults to 0.</p>
<p>payload:               optional payload for validation. The client calculates the hash value and includes it via the 'hash'
header attribute. The server always ensures the value provided has been included in the request
MAC. When this option is provided, it validates the hash value itself. Validation is done by calculating
a hash value over the entire payload (assuming it has already be normalized to the same format and
encoding used by the client to calculate the hash on request). If the payload is not available at the time
of authentication, the authenticatePayload() method can be used by passing it the credentials and
attributes.hash returned in the authenticate callback.</p>
<p>host:                  optional host name override. Only used when passed a node request object.
port:                  optional port override. Only used when passed a node request object.
}</p>
<p>callback: function (err, credentials, artifacts) { }</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
exports.authenticate = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, credentialsFunc, options, callback</span>) </span>{

    callback = Hoek.nextTick(callback);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Default options</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    options.nonceFunc = options.nonceFunc || internals.nonceFunc;
    options.timestampSkewSec = options.timestampSkewSec || <span class="hljs-number">60</span>;                                                  <span class="hljs-comment">// 60 seconds</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Application time</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> now = Utils.now(options.localtimeOffsetMsec);                           <span class="hljs-comment">// Measure now before any other processing</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Convert node Http request object to a request configuration object</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> request = Utils.parseRequest(req, options);
    <span class="hljs-keyword">if</span> (request <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>) {
        <span class="hljs-keyword">return</span> callback(Boom.badRequest(request.message));
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Parse HTTP Authorization header</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> attributes = Utils.parseAuthorizationHeader(request.authorization);
    <span class="hljs-keyword">if</span> (attributes <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>) {
        <span class="hljs-keyword">return</span> callback(attributes);
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>Construct artifacts container</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> artifacts = {
        <span class="hljs-attr">method</span>: request.method,
        <span class="hljs-attr">host</span>: request.host,
        <span class="hljs-attr">port</span>: request.port,
        <span class="hljs-attr">resource</span>: request.url,
        <span class="hljs-attr">ts</span>: attributes.ts,
        <span class="hljs-attr">nonce</span>: attributes.nonce,
        <span class="hljs-attr">hash</span>: attributes.hash,
        <span class="hljs-attr">ext</span>: attributes.ext,
        <span class="hljs-attr">app</span>: attributes.app,
        <span class="hljs-attr">dlg</span>: attributes.dlg,
        <span class="hljs-attr">mac</span>: attributes.mac,
        <span class="hljs-attr">id</span>: attributes.id
    };

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>Verify required header attributes</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">if</span> (!attributes.id ||
        !attributes.ts ||
        !attributes.nonce ||
        !attributes.mac) {

        <span class="hljs-keyword">return</span> callback(Boom.badRequest(<span class="hljs-string">'Missing attributes'</span>), <span class="hljs-literal">null</span>, artifacts);
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>Fetch Hawk credentials</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    credentialsFunc(attributes.id, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials</span>) </span>{

        <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-keyword">return</span> callback(err, credentials || <span class="hljs-literal">null</span>, artifacts);
        }

        <span class="hljs-keyword">if</span> (!credentials) {
            <span class="hljs-keyword">return</span> callback(Boom.unauthorized(<span class="hljs-string">'Unknown credentials'</span>, <span class="hljs-string">'Hawk'</span>), <span class="hljs-literal">null</span>, artifacts);
        }

        <span class="hljs-keyword">if</span> (!credentials.key ||
            !credentials.algorithm) {

            <span class="hljs-keyword">return</span> callback(Boom.internal(<span class="hljs-string">'Invalid credentials'</span>), credentials, artifacts);
        }

        <span class="hljs-keyword">if</span> (Crypto.algorithms.indexOf(credentials.algorithm) === <span class="hljs-number">-1</span>) {
            <span class="hljs-keyword">return</span> callback(Boom.internal(<span class="hljs-string">'Unknown algorithm'</span>), credentials, artifacts);
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>Calculate MAC</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
        <span class="hljs-keyword">var</span> mac = Crypto.calculateMac(<span class="hljs-string">'header'</span>, credentials, artifacts);
        <span class="hljs-keyword">if</span> (!Cryptiles.fixedTimeComparison(mac, attributes.mac)) {
            <span class="hljs-keyword">return</span> callback(Boom.unauthorized(<span class="hljs-string">'Bad mac'</span>, <span class="hljs-string">'Hawk'</span>), credentials, artifacts);
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>Check payload hash</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
        <span class="hljs-keyword">if</span> (options.payload ||
            options.payload === <span class="hljs-string">''</span>) {

            <span class="hljs-keyword">if</span> (!attributes.hash) {
                <span class="hljs-keyword">return</span> callback(Boom.unauthorized(<span class="hljs-string">'Missing required payload hash'</span>, <span class="hljs-string">'Hawk'</span>), credentials, artifacts);
            }

            <span class="hljs-keyword">var</span> hash = Crypto.calculatePayloadHash(options.payload, credentials.algorithm, request.contentType);
            <span class="hljs-keyword">if</span> (!Cryptiles.fixedTimeComparison(hash, attributes.hash)) {
                <span class="hljs-keyword">return</span> callback(Boom.unauthorized(<span class="hljs-string">'Bad payload hash'</span>, <span class="hljs-string">'Hawk'</span>), credentials, artifacts);
            }
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>Check nonce</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
        options.nonceFunc(credentials.key, attributes.nonce, attributes.ts, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{

            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-keyword">return</span> callback(Boom.unauthorized(<span class="hljs-string">'Invalid nonce'</span>, <span class="hljs-string">'Hawk'</span>), credentials, artifacts);
            }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>Check timestamp staleness</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.abs((attributes.ts * <span class="hljs-number">1000</span>) - now) &gt; (options.timestampSkewSec * <span class="hljs-number">1000</span>)) {
                <span class="hljs-keyword">var</span> tsm = Crypto.timestampMessage(credentials, options.localtimeOffsetMsec);
                <span class="hljs-keyword">return</span> callback(Boom.unauthorized(<span class="hljs-string">'Stale timestamp'</span>, <span class="hljs-string">'Hawk'</span>, tsm), credentials, artifacts);
            }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>Successful authentication</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
            <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, credentials, artifacts);
        });
    });
};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>Authenticate payload hash - used when payload cannot be provided during authenticate()</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<div class="dox">
<div class="summary">
<p>payload:        raw request payload
credentials:    from authenticate callback
artifacts:      from authenticate callback
contentType:    req.headers['content-type']</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
exports.authenticatePayload = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">payload, credentials, artifacts, contentType</span>) </span>{

    <span class="hljs-keyword">var</span> calculatedHash = Crypto.calculatePayloadHash(payload, credentials.algorithm, contentType);
    <span class="hljs-keyword">return</span> Cryptiles.fixedTimeComparison(calculatedHash, artifacts.hash);
};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>Authenticate payload hash - used when payload cannot be provided during authenticate()</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<div class="dox">
<div class="summary">
<p>calculatedHash: the payload hash calculated using Crypto.calculatePayloadHash()
artifacts:      from authenticate callback</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
exports.authenticatePayloadHash = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">calculatedHash, artifacts</span>) </span>{

    <span class="hljs-keyword">return</span> Cryptiles.fixedTimeComparison(calculatedHash, artifacts.hash);
};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>Generate a Server-Authorization header for a given response</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<div class="dox">
<div class="summary">
<p>credentials: {},                                        // Object received from authenticate()
artifacts: {}                                           // Object received from authenticate(); 'mac', 'hash', and 'ext' - ignored
options: {
ext: 'application-specific',                        // Application specific data sent via the ext attribute
payload: '{&quot;some&quot;:&quot;payload&quot;}',                      // UTF-8 encoded string for body hash generation (ignored if hash provided)
contentType: 'application/json',                    // Payload content-type (ignored if hash provided)
hash: 'U4MKKSmiVxk37JCCrAVIjV='                     // Pre-calculated payload hash
}</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
exports.header = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">credentials, artifacts, options</span>) </span>{

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>Prepare inputs</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    options = options || {};

    <span class="hljs-keyword">if</span> (!artifacts ||
        <span class="hljs-keyword">typeof</span> artifacts !== <span class="hljs-string">'object'</span> ||
        <span class="hljs-keyword">typeof</span> options !== <span class="hljs-string">'object'</span>) {

        <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    }

    artifacts = Hoek.clone(artifacts);
    <span class="hljs-keyword">delete</span> artifacts.mac;
    artifacts.hash = options.hash;
    artifacts.ext = options.ext;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>Validate credentials</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">if</span> (!credentials ||
        !credentials.key ||
        !credentials.algorithm) {

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>Invalid credential object</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    }

    <span class="hljs-keyword">if</span> (Crypto.algorithms.indexOf(credentials.algorithm) === <span class="hljs-number">-1</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>Calculate payload hash</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">if</span> (!artifacts.hash &amp;&amp;
        (options.payload || options.payload === <span class="hljs-string">''</span>)) {

        artifacts.hash = Crypto.calculatePayloadHash(options.payload, credentials.algorithm, options.contentType);
    }

    <span class="hljs-keyword">var</span> mac = Crypto.calculateMac(<span class="hljs-string">'response'</span>, credentials, artifacts);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>Construct header</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> header = <span class="hljs-string">'Hawk mac="'</span> + mac + <span class="hljs-string">'"'</span> +
                 (artifacts.hash ? <span class="hljs-string">', hash="'</span> + artifacts.hash + <span class="hljs-string">'"'</span> : <span class="hljs-string">''</span>);

    <span class="hljs-keyword">if</span> (artifacts.ext !== <span class="hljs-literal">null</span> &amp;&amp;
        artifacts.ext !== <span class="hljs-literal">undefined</span> &amp;&amp;
        artifacts.ext !== <span class="hljs-string">''</span>) {                       <span class="hljs-comment">// Other falsey values allowed</span>

        header += <span class="hljs-string">', ext="'</span> + Hoek.escapeHeaderAttribute(artifacts.ext) + <span class="hljs-string">'"'</span>;
    }

    <span class="hljs-keyword">return</span> header;
};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<div class="dox">
<div class="summary">
<p>Arguments and options are the same as authenticate() with the exception that the only supported options are:
'hostHeaderName', 'localtimeOffsetMsec', 'host', 'port'</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<pre><code>                  1     2             3           4
</code></pre>

        </td>
        <td class="code highlight">
          <pre class="javascript">internals.bewitRegex = <span class="hljs-regexp">/^(\/.*)([\?&amp;])bewit\=([^&amp;$]*)(?:&amp;(.+))?$/</span>;


exports.authenticateBewit = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, credentialsFunc, options, callback</span>) </span>{

    callback = Hoek.nextTick(callback);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>Application time</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> now = Utils.now(options.localtimeOffsetMsec);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>Convert node Http request object to a request configuration object</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> request = Utils.parseRequest(req, options);
    <span class="hljs-keyword">if</span> (request <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>) {
        <span class="hljs-keyword">return</span> callback(Boom.badRequest(request.message));
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>Extract bewit</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">if</span> (request.url.length &gt; Utils.limits.maxMatchLength) {
        <span class="hljs-keyword">return</span> callback(Boom.badRequest(<span class="hljs-string">'Resource path exceeds max length'</span>));
    }

    <span class="hljs-keyword">var</span> resource = request.url.match(internals.bewitRegex);
    <span class="hljs-keyword">if</span> (!resource) {
        <span class="hljs-keyword">return</span> callback(Boom.unauthorized(<span class="hljs-literal">null</span>, <span class="hljs-string">'Hawk'</span>));
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>Bewit not empty</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">if</span> (!resource[<span class="hljs-number">3</span>]) {
        <span class="hljs-keyword">return</span> callback(Boom.unauthorized(<span class="hljs-string">'Empty bewit'</span>, <span class="hljs-string">'Hawk'</span>));
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>Verify method is GET</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">if</span> (request.method !== <span class="hljs-string">'GET'</span> &amp;&amp;
        request.method !== <span class="hljs-string">'HEAD'</span>) {

        <span class="hljs-keyword">return</span> callback(Boom.unauthorized(<span class="hljs-string">'Invalid method'</span>, <span class="hljs-string">'Hawk'</span>));
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>No other authentication</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">if</span> (request.authorization) {
        <span class="hljs-keyword">return</span> callback(Boom.badRequest(<span class="hljs-string">'Multiple authentications'</span>));
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<p>Parse bewit</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> bewitString = Hoek.base64urlDecode(resource[<span class="hljs-number">3</span>]);
    <span class="hljs-keyword">if</span> (bewitString <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>) {
        <span class="hljs-keyword">return</span> callback(Boom.badRequest(<span class="hljs-string">'Invalid bewit encoding'</span>));
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>Bewit format: id\exp\mac\ext ('' is used because it is a reserved header attribute character)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> bewitParts = bewitString.split(<span class="hljs-string">'\\'</span>);
    <span class="hljs-keyword">if</span> (bewitParts.length !== <span class="hljs-number">4</span>) {
        <span class="hljs-keyword">return</span> callback(Boom.badRequest(<span class="hljs-string">'Invalid bewit structure'</span>));
    }

    <span class="hljs-keyword">var</span> bewit = {
        <span class="hljs-attr">id</span>: bewitParts[<span class="hljs-number">0</span>],
        <span class="hljs-attr">exp</span>: <span class="hljs-built_in">parseInt</span>(bewitParts[<span class="hljs-number">1</span>], <span class="hljs-number">10</span>),
        <span class="hljs-attr">mac</span>: bewitParts[<span class="hljs-number">2</span>],
        <span class="hljs-attr">ext</span>: bewitParts[<span class="hljs-number">3</span>] || <span class="hljs-string">''</span>
    };

    <span class="hljs-keyword">if</span> (!bewit.id ||
        !bewit.exp ||
        !bewit.mac) {

        <span class="hljs-keyword">return</span> callback(Boom.badRequest(<span class="hljs-string">'Missing bewit attributes'</span>));
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<p>Construct URL without bewit</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> url = resource[<span class="hljs-number">1</span>];
    <span class="hljs-keyword">if</span> (resource[<span class="hljs-number">4</span>]) {
        url += resource[<span class="hljs-number">2</span>] + resource[<span class="hljs-number">4</span>];
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39"></a>
</div>
<p>Check expiration</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">if</span> (bewit.exp * <span class="hljs-number">1000</span> &lt;= now) {
        <span class="hljs-keyword">return</span> callback(Boom.unauthorized(<span class="hljs-string">'Access expired'</span>, <span class="hljs-string">'Hawk'</span>), <span class="hljs-literal">null</span>, bewit);
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40"></a>
</div>
<p>Fetch Hawk credentials</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    credentialsFunc(bewit.id, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials</span>) </span>{

        <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-keyword">return</span> callback(err, credentials || <span class="hljs-literal">null</span>, bewit.ext);
        }

        <span class="hljs-keyword">if</span> (!credentials) {
            <span class="hljs-keyword">return</span> callback(Boom.unauthorized(<span class="hljs-string">'Unknown credentials'</span>, <span class="hljs-string">'Hawk'</span>), <span class="hljs-literal">null</span>, bewit);
        }

        <span class="hljs-keyword">if</span> (!credentials.key ||
            !credentials.algorithm) {

            <span class="hljs-keyword">return</span> callback(Boom.internal(<span class="hljs-string">'Invalid credentials'</span>), credentials, bewit);
        }

        <span class="hljs-keyword">if</span> (Crypto.algorithms.indexOf(credentials.algorithm) === <span class="hljs-number">-1</span>) {
            <span class="hljs-keyword">return</span> callback(Boom.internal(<span class="hljs-string">'Unknown algorithm'</span>), credentials, bewit);
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41"></a>
</div>
<p>Calculate MAC</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
        <span class="hljs-keyword">var</span> mac = Crypto.calculateMac(<span class="hljs-string">'bewit'</span>, credentials, {
            <span class="hljs-attr">ts</span>: bewit.exp,
            <span class="hljs-attr">nonce</span>: <span class="hljs-string">''</span>,
            <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
            <span class="hljs-attr">resource</span>: url,
            <span class="hljs-attr">host</span>: request.host,
            <span class="hljs-attr">port</span>: request.port,
            <span class="hljs-attr">ext</span>: bewit.ext
        });

        <span class="hljs-keyword">if</span> (!Cryptiles.fixedTimeComparison(mac, bewit.mac)) {
            <span class="hljs-keyword">return</span> callback(Boom.unauthorized(<span class="hljs-string">'Bad mac'</span>, <span class="hljs-string">'Hawk'</span>), credentials, bewit);
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42"></a>
</div>
<p>Successful authentication</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
        <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, credentials, bewit);
    });
};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43"></a>
</div>
<div class="dox">
<div class="summary">
<p>options are the same as authenticate() with the exception that the only supported options are:
'nonceFunc', 'timestampSkewSec', 'localtimeOffsetMsec'</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
exports.authenticateMessage = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">host, port, message, authorization, credentialsFunc, options, callback</span>) </span>{

    callback = Hoek.nextTick(callback);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44"></a>
</div>
<p>Default options</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    options.nonceFunc = options.nonceFunc || internals.nonceFunc;
    options.timestampSkewSec = options.timestampSkewSec || <span class="hljs-number">60</span>;                                                  <span class="hljs-comment">// 60 seconds</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45"></a>
</div>
<p>Application time</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> now = Utils.now(options.localtimeOffsetMsec);                       <span class="hljs-comment">// Measure now before any other processing</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46"></a>
</div>
<p>Validate authorization</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">if</span> (!authorization.id ||
        !authorization.ts ||
        !authorization.nonce ||
        !authorization.hash ||
        !authorization.mac) {

        <span class="hljs-keyword">return</span> callback(Boom.badRequest(<span class="hljs-string">'Invalid authorization'</span>));
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47"></a>
</div>
<p>Fetch Hawk credentials</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    credentialsFunc(authorization.id, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, credentials</span>) </span>{

        <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-keyword">return</span> callback(err, credentials || <span class="hljs-literal">null</span>);
        }

        <span class="hljs-keyword">if</span> (!credentials) {
            <span class="hljs-keyword">return</span> callback(Boom.unauthorized(<span class="hljs-string">'Unknown credentials'</span>, <span class="hljs-string">'Hawk'</span>));
        }

        <span class="hljs-keyword">if</span> (!credentials.key ||
            !credentials.algorithm) {

            <span class="hljs-keyword">return</span> callback(Boom.internal(<span class="hljs-string">'Invalid credentials'</span>), credentials);
        }

        <span class="hljs-keyword">if</span> (Crypto.algorithms.indexOf(credentials.algorithm) === <span class="hljs-number">-1</span>) {
            <span class="hljs-keyword">return</span> callback(Boom.internal(<span class="hljs-string">'Unknown algorithm'</span>), credentials);
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48"></a>
</div>
<p>Construct artifacts container</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
        <span class="hljs-keyword">var</span> artifacts = {
            <span class="hljs-attr">ts</span>: authorization.ts,
            <span class="hljs-attr">nonce</span>: authorization.nonce,
            <span class="hljs-attr">host</span>: host,
            <span class="hljs-attr">port</span>: port,
            <span class="hljs-attr">hash</span>: authorization.hash
        };

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49"></a>
</div>
<p>Calculate MAC</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
        <span class="hljs-keyword">var</span> mac = Crypto.calculateMac(<span class="hljs-string">'message'</span>, credentials, artifacts);
        <span class="hljs-keyword">if</span> (!Cryptiles.fixedTimeComparison(mac, authorization.mac)) {
            <span class="hljs-keyword">return</span> callback(Boom.unauthorized(<span class="hljs-string">'Bad mac'</span>, <span class="hljs-string">'Hawk'</span>), credentials);
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50"></a>
</div>
<p>Check payload hash</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
        <span class="hljs-keyword">var</span> hash = Crypto.calculatePayloadHash(message, credentials.algorithm);
        <span class="hljs-keyword">if</span> (!Cryptiles.fixedTimeComparison(hash, authorization.hash)) {
            <span class="hljs-keyword">return</span> callback(Boom.unauthorized(<span class="hljs-string">'Bad message hash'</span>, <span class="hljs-string">'Hawk'</span>), credentials);
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51"></a>
</div>
<p>Check nonce</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
        options.nonceFunc(credentials.key, authorization.nonce, authorization.ts, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{

            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-keyword">return</span> callback(Boom.unauthorized(<span class="hljs-string">'Invalid nonce'</span>, <span class="hljs-string">'Hawk'</span>), credentials);
            }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52"></a>
</div>
<p>Check timestamp staleness</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.abs((authorization.ts * <span class="hljs-number">1000</span>) - now) &gt; (options.timestampSkewSec * <span class="hljs-number">1000</span>)) {
                <span class="hljs-keyword">return</span> callback(Boom.unauthorized(<span class="hljs-string">'Stale timestamp'</span>), credentials);
            }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53"></a>
</div>
<p>Successful authentication</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
            <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, credentials);
        });
    });
};


internals.nonceFunc = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, nonce, ts, nonceCallback</span>) </span>{

    <span class="hljs-keyword">return</span> nonceCallback();         <span class="hljs-comment">// No validation</span>
};

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

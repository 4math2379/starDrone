<!DOCTYPE html>
<html>
<head>
  <title>crypto.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../doc-style.css" />
  <script src="../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../";
    var thisFile = "node_modules/serialport/node_modules/hawk/lib/crypto.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>crypto.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>Load modules</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> Crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);
<span class="hljs-keyword">var</span> Url = <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>);
<span class="hljs-keyword">var</span> Utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./utils'</span>);


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Declare internals</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> internals = {};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>MAC normalization format version</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
exports.headerVersion = <span class="hljs-string">'1'</span>;                        <span class="hljs-comment">// Prevent comparison of mac values generated with different normalized string formats</span>


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>Supported HMAC algorithms</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
exports.algorithms = [<span class="hljs-string">'sha1'</span>, <span class="hljs-string">'sha256'</span>];


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Calculate the request MAC</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<div class="dox">
<div class="summary">
<p>type: 'header',                                 // 'header', 'bewit', 'response'
credentials: {
key: 'aoijedoaijsdlaksjdl',
algorithm: 'sha256'                         // 'sha1', 'sha256'
},
options: {
method: 'GET',
resource: '/resource?a=1&amp;b=2',
host: 'example.com',
port: 8080,
ts: 1357718381034,
nonce: 'd3d345f',
hash: 'U4MKKSmiVxk37JCCrAVIjV/OhB3y+NdwoCr6RShbVkE=',
ext: 'app-specific-data',
app: 'hf48hd83qwkj',                        // Application id (Oz)
dlg: 'd8djwekds9cj'                         // Delegated by application id (Oz), requires options.app
}</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
exports.calculateMac = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">type, credentials, options</span>) </span>{

    <span class="hljs-keyword">var</span> normalized = exports.generateNormalizedString(type, options);

    <span class="hljs-keyword">var</span> hmac = Crypto.createHmac(credentials.algorithm, credentials.key).update(normalized);
    <span class="hljs-keyword">var</span> digest = hmac.digest(<span class="hljs-string">'base64'</span>);
    <span class="hljs-keyword">return</span> digest;
};


exports.generateNormalizedString = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">type, options</span>) </span>{

    <span class="hljs-keyword">var</span> resource = options.resource || <span class="hljs-string">''</span>;
    <span class="hljs-keyword">if</span> (resource &amp;&amp;
        resource[<span class="hljs-number">0</span>] !== <span class="hljs-string">'/'</span>) {

        <span class="hljs-keyword">var</span> url = Url.parse(resource, <span class="hljs-literal">false</span>);
        resource = url.path;                        <span class="hljs-comment">// Includes query</span>
    }

    <span class="hljs-keyword">var</span> normalized = <span class="hljs-string">'hawk.'</span> + exports.headerVersion + <span class="hljs-string">'.'</span> + type + <span class="hljs-string">'\n'</span> +
                     options.ts + <span class="hljs-string">'\n'</span> +
                     options.nonce + <span class="hljs-string">'\n'</span> +
                     (options.method || <span class="hljs-string">''</span>).toUpperCase() + <span class="hljs-string">'\n'</span> +
                     resource + <span class="hljs-string">'\n'</span> +
                     options.host.toLowerCase() + <span class="hljs-string">'\n'</span> +
                     options.port + <span class="hljs-string">'\n'</span> +
                     (options.hash || <span class="hljs-string">''</span>) + <span class="hljs-string">'\n'</span>;

    <span class="hljs-keyword">if</span> (options.ext) {
        normalized += options.ext.replace(<span class="hljs-string">'\\'</span>, <span class="hljs-string">'\\\\'</span>).replace(<span class="hljs-string">'\n'</span>, <span class="hljs-string">'\\n'</span>);
    }

    normalized += <span class="hljs-string">'\n'</span>;

    <span class="hljs-keyword">if</span> (options.app) {
        normalized += options.app + <span class="hljs-string">'\n'</span> +
                      (options.dlg || <span class="hljs-string">''</span>) + <span class="hljs-string">'\n'</span>;
    }

    <span class="hljs-keyword">return</span> normalized;
};


exports.calculatePayloadHash = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">payload, algorithm, contentType</span>) </span>{

    <span class="hljs-keyword">var</span> hash = exports.initializePayloadHash(algorithm, contentType);
    hash.update(payload || <span class="hljs-string">''</span>);
    <span class="hljs-keyword">return</span> exports.finalizePayloadHash(hash);
};


exports.initializePayloadHash = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">algorithm, contentType</span>) </span>{

    <span class="hljs-keyword">var</span> hash = Crypto.createHash(algorithm);
    hash.update(<span class="hljs-string">'hawk.'</span> + exports.headerVersion + <span class="hljs-string">'.payload\n'</span>);
    hash.update(Utils.parseContentType(contentType) + <span class="hljs-string">'\n'</span>);
    <span class="hljs-keyword">return</span> hash;
};


exports.finalizePayloadHash = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">hash</span>) </span>{

    hash.update(<span class="hljs-string">'\n'</span>);
    <span class="hljs-keyword">return</span> hash.digest(<span class="hljs-string">'base64'</span>);
};


exports.calculateTsMac = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ts, credentials</span>) </span>{

    <span class="hljs-keyword">var</span> hmac = Crypto.createHmac(credentials.algorithm, credentials.key);
    hmac.update(<span class="hljs-string">'hawk.'</span> + exports.headerVersion + <span class="hljs-string">'.ts\n'</span> + ts + <span class="hljs-string">'\n'</span>);
    <span class="hljs-keyword">return</span> hmac.digest(<span class="hljs-string">'base64'</span>);
};


exports.timestampMessage = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">credentials, localtimeOffsetMsec</span>) </span>{

    <span class="hljs-keyword">var</span> now = Utils.nowSecs(localtimeOffsetMsec);
    <span class="hljs-keyword">var</span> tsm = exports.calculateTsMac(now, credentials);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ts</span>: now, <span class="hljs-attr">tsm</span>: tsm };
};

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>ignore.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../";
    var thisFile = "node_modules/serialport/node_modules/fstream-ignore/ignore.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>ignore.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>Essentially, this is a fstream.DirReader class, but with a
bit of special logic to read the specified sort of ignore files,
and a filter that prevents it from picking up anything excluded
by those files.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> Minimatch = <span class="hljs-built_in">require</span>(<span class="hljs-string">"minimatch"</span>).Minimatch
, fstream = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fstream"</span>)
, DirReader = fstream.DirReader
, inherits = <span class="hljs-built_in">require</span>(<span class="hljs-string">"inherits"</span>)
, path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>)
, fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>)

<span class="hljs-built_in">module</span>.exports = IgnoreReader

inherits(IgnoreReader, DirReader)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">IgnoreReader</span> (<span class="hljs-params">props</span>) </span>{
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> IgnoreReader)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> IgnoreReader(props)
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>must be a Directory type</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> props === <span class="hljs-string">"string"</span>) {
    props = { <span class="hljs-attr">path</span>: path.resolve(props) }
  }

  props.type = <span class="hljs-string">"Directory"</span>
  props.Directory = <span class="hljs-literal">true</span>

  <span class="hljs-keyword">if</span> (!props.ignoreFiles) props.ignoreFiles = [<span class="hljs-string">".ignore"</span>]
  <span class="hljs-keyword">this</span>.ignoreFiles = props.ignoreFiles

  <span class="hljs-keyword">this</span>.ignoreRules = <span class="hljs-literal">null</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>ensure that .ignore files always show up at the top of the list
that way, they can be read before proceeding to handle other
entries in that same folder</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (props.sort) {
    <span class="hljs-keyword">this</span>._sort = props.sort === <span class="hljs-string">"alpha"</span> ? alphasort : props.sort
    props.sort = <span class="hljs-literal">null</span>
  }

  <span class="hljs-keyword">this</span>.on(<span class="hljs-string">"entries"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>if there are any ignore files in the list, then
pause and add them.
then, filter the list based on our ignoreRules</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">var</span> hasIg = <span class="hljs-keyword">this</span>.entries.some(<span class="hljs-keyword">this</span>.isIgnoreFile, <span class="hljs-keyword">this</span>)

    <span class="hljs-keyword">if</span> (!hasIg) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.filterEntries()

    <span class="hljs-keyword">this</span>.addIgnoreFiles()
  })

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>we filter entries before we know what they are.
however, directories have to be re-tested against
rules with a &quot;/&quot; appended, because &quot;a/b/&quot; will only
match if &quot;a/b&quot; is a dir, and not otherwise.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>.on(<span class="hljs-string">"_entryStat"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry, props</span>) </span>{
    <span class="hljs-keyword">var</span> t = entry.basename
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.applyIgnores(entry.basename,
                           entry.type === <span class="hljs-string">"Directory"</span>,
                           entry)) {
      entry.abort()
    }
  }.bind(<span class="hljs-keyword">this</span>))

  DirReader.call(<span class="hljs-keyword">this</span>, props)
}


IgnoreReader.prototype.addIgnoreFiles = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._paused) {
    <span class="hljs-keyword">this</span>.once(<span class="hljs-string">"resume"</span>, <span class="hljs-keyword">this</span>.addIgnoreFiles)
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._ignoreFilesAdded) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">this</span>._ignoreFilesAdded = <span class="hljs-literal">true</span>

  <span class="hljs-keyword">var</span> newIg = <span class="hljs-keyword">this</span>.entries.filter(<span class="hljs-keyword">this</span>.isIgnoreFile, <span class="hljs-keyword">this</span>)
  , count = newIg.length
  , errState = <span class="hljs-literal">null</span>

  <span class="hljs-keyword">if</span> (!count) <span class="hljs-keyword">return</span>

  <span class="hljs-keyword">this</span>.pause()

  <span class="hljs-keyword">var</span> then = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
    <span class="hljs-keyword">if</span> (errState) <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">if</span> (er) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"error"</span>, errState = er)
    <span class="hljs-keyword">if</span> (-- count === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">this</span>.filterEntries()
      <span class="hljs-keyword">this</span>.resume()
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.addIgnoreFile(newIg[newIg.length - count], then)
    }
  }.bind(<span class="hljs-keyword">this</span>)

  <span class="hljs-keyword">this</span>.addIgnoreFile(newIg[<span class="hljs-number">0</span>], then)
}


IgnoreReader.prototype.isIgnoreFile = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{
  <span class="hljs-keyword">return</span> e !== <span class="hljs-string">"."</span> &amp;&amp;
         e !== <span class="hljs-string">".."</span> &amp;&amp;
         <span class="hljs-number">-1</span> !== <span class="hljs-keyword">this</span>.ignoreFiles.indexOf(e)
}


IgnoreReader.prototype.getChildProps = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">stat</span>) </span>{
  <span class="hljs-keyword">var</span> props = DirReader.prototype.getChildProps.call(<span class="hljs-keyword">this</span>, stat)
  props.ignoreFiles = <span class="hljs-keyword">this</span>.ignoreFiles

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Directories have to be read as IgnoreReaders
otherwise fstream.Reader will create a DirReader instead.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (stat.isDirectory()) {
    props.type = <span class="hljs-keyword">this</span>.constructor
  }
  <span class="hljs-keyword">return</span> props
}


IgnoreReader.prototype.addIgnoreFile = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e, cb</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>read the file, and then call addIgnoreRules
if there's an error, then tell the cb about it.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
  <span class="hljs-keyword">var</span> ig = path.resolve(<span class="hljs-keyword">this</span>.path, e)
  fs.readFile(ig, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er, data</span>) </span>{
    <span class="hljs-keyword">if</span> (er) <span class="hljs-keyword">return</span> cb(er)

    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"ignoreFile"</span>, e, data)
    <span class="hljs-keyword">var</span> rules = <span class="hljs-keyword">this</span>.readRules(data, e)
    <span class="hljs-keyword">this</span>.addIgnoreRules(rules, e)
    cb()
  }.bind(<span class="hljs-keyword">this</span>))
}


IgnoreReader.prototype.readRules = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">buf, e</span>) </span>{
  <span class="hljs-keyword">return</span> buf.toString().split(<span class="hljs-regexp">/\r?\n/</span>)
}


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Override this to do fancier things, like read the
&quot;files&quot; array from a package.json file or something.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">IgnoreReader.prototype.addIgnoreRules = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">set, e</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>filter out anything obvious</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  set = set.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">s</span>) </span>{
    s = s.trim()
    <span class="hljs-keyword">return</span> s &amp;&amp; !s.match(<span class="hljs-regexp">/^#/</span>)
  })

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>no rules to add!</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!set.length) <span class="hljs-keyword">return</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>now get a minimatch object for each one of these.
Note that we need to allow dot files by default, and
not switch the meaning of their exclusion</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> mmopt = { <span class="hljs-attr">matchBase</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">dot</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">flipNegate</span>: <span class="hljs-literal">true</span> }
  , mm = set.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">s</span>) </span>{
    <span class="hljs-keyword">var</span> m = <span class="hljs-keyword">new</span> Minimatch(s, mmopt)
    m.ignoreFile = e
    <span class="hljs-keyword">return</span> m
  })

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.ignoreRules) <span class="hljs-keyword">this</span>.ignoreRules = []
  <span class="hljs-keyword">this</span>.ignoreRules.push.apply(<span class="hljs-keyword">this</span>.ignoreRules, mm)
}


IgnoreReader.prototype.filterEntries = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>this exclusion is at the point where we know the list of
entries in the dir, but don't know what they are.  since
some of them <em>might</em> be directories, we have to run the
match in dir-mode as well, so that we'll pick up partials
of files that will be included later.  Anything included
at this point will be checked again later once we know
what it is.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>.entries = <span class="hljs-keyword">this</span>.entries.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>at this point, we don't know if it's a dir or not.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.applyIgnores(entry) || <span class="hljs-keyword">this</span>.applyIgnores(entry, <span class="hljs-literal">true</span>)
  }, <span class="hljs-keyword">this</span>)
}


IgnoreReader.prototype.applyIgnores = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry, partial, obj</span>) </span>{
  <span class="hljs-keyword">var</span> included = <span class="hljs-literal">true</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>this = /a/b/c
entry = d
parent /a/b sees c/d</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.parent &amp;&amp; <span class="hljs-keyword">this</span>.parent.applyIgnores) {
    <span class="hljs-keyword">var</span> pt = <span class="hljs-keyword">this</span>.basename + <span class="hljs-string">"/"</span> + entry
    included = <span class="hljs-keyword">this</span>.parent.applyIgnores(pt, partial)
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>Negated Rules
Since we're <em>ignoring</em> things here, negating means that a file
is re-included, if it would have been excluded by a previous
rule.  So, negated rules are only relevant if the file
has been excluded.</p>
<p>Similarly, if a file has been excluded, then there's no point
trying it against rules that have already been applied</p>
<p>We're using the &quot;flipnegate&quot; flag here, which tells minimatch
to set the &quot;negate&quot; for our information, but still report
whether the core pattern was a hit or a miss.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.ignoreRules) {
    <span class="hljs-keyword">return</span> included
  }

  <span class="hljs-keyword">this</span>.ignoreRules.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">rule</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>negation means inclusion</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (rule.negate &amp;&amp; included ||
        !rule.negate &amp;&amp; !included) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>unnecessary</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">return</span>
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>first, match against /foo/bar</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> match = rule.match(<span class="hljs-string">"/"</span> + entry)

    <span class="hljs-keyword">if</span> (!match) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>try with the leading / trimmed off the test
eg: foo/bar instead of /foo/bar</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      match = rule.match(entry)
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>if the entry is a directory, then it will match
with a trailing slash. eg: /foo/bar/ or foo/bar/</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (!match &amp;&amp; partial) {
      match = rule.match(<span class="hljs-string">"/"</span> + entry + <span class="hljs-string">"/"</span>) ||
              rule.match(entry + <span class="hljs-string">"/"</span>)
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>When including a file with a negated rule, it's
relevant if a directory partially matches, since
it may then match a file within it.
Eg, if you ignore /a, but !/a/b/c</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (!match &amp;&amp; rule.negate &amp;&amp; partial) {
      match = rule.match(<span class="hljs-string">"/"</span> + entry, <span class="hljs-literal">true</span>) ||
              rule.match(entry, <span class="hljs-literal">true</span>)
    }

    <span class="hljs-keyword">if</span> (match) {
      included = rule.negate
    }
  }, <span class="hljs-keyword">this</span>)

  <span class="hljs-keyword">return</span> included
}


IgnoreReader.prototype.sort = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) </span>{
  <span class="hljs-keyword">var</span> aig = <span class="hljs-keyword">this</span>.ignoreFiles.indexOf(a) !== <span class="hljs-number">-1</span>
  , big = <span class="hljs-keyword">this</span>.ignoreFiles.indexOf(b) !== <span class="hljs-number">-1</span>

  <span class="hljs-keyword">if</span> (aig &amp;&amp; !big) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>
  <span class="hljs-keyword">if</span> (big &amp;&amp; !aig) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._sort(a, b)
}

IgnoreReader.prototype._sort = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">alphasort</span> (<span class="hljs-params">a, b</span>) </span>{
  <span class="hljs-keyword">return</span> a === b ? <span class="hljs-number">0</span>
       : a.toLowerCase() &gt; b.toLowerCase() ? <span class="hljs-number">1</span>
       : a.toLowerCase() &lt; b.toLowerCase() ? <span class="hljs-number">-1</span>
       : a &gt; b ? <span class="hljs-number">1</span>
       : <span class="hljs-number">-1</span>
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>serialport.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "node_modules/serialport/lib/serialport.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>serialport.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">'use strict'</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Copyright 2011 Chris Williams <a href="mailto:chris@iterativedesigns.com.html">chris@iterativedesigns.com</a></p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Require serialport binding from pre-compiled binaries using
node-pre-gyp, if something fails or package not available fallback
to regular build from source.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>3rd Party Dependencies</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'serialport'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>shims</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> assign = <span class="hljs-built_in">require</span>(<span class="hljs-string">'object.assign'</span>).getPolyfill();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Internal Dependencies</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> SerialPortBinding = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./bindings'</span>);
<span class="hljs-keyword">var</span> parsers = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./parsers'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Built-ins Dependencies</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>).EventEmitter;
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> stream = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>);
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Setup the factory</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> factory = <span class="hljs-keyword">new</span> EventEmitter();
factory.parsers = parsers;
factory.list = SerialPortBinding.list;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>VALIDATION ARRAYS</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> DATABITS = [<span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>];
<span class="hljs-keyword">var</span> STOPBITS = [<span class="hljs-number">1</span>, <span class="hljs-number">1.5</span>, <span class="hljs-number">2</span>];
<span class="hljs-keyword">var</span> PARITY = [<span class="hljs-string">'none'</span>, <span class="hljs-string">'even'</span>, <span class="hljs-string">'mark'</span>, <span class="hljs-string">'odd'</span>, <span class="hljs-string">'space'</span>];
<span class="hljs-keyword">var</span> FLOWCONTROLS = [<span class="hljs-string">'xon'</span>, <span class="hljs-string">'xoff'</span>, <span class="hljs-string">'xany'</span>, <span class="hljs-string">'rtscts'</span>];
<span class="hljs-keyword">var</span> SET_OPTIONS = [<span class="hljs-string">'brk'</span>, <span class="hljs-string">'cts'</span>, <span class="hljs-string">'dtr'</span>, <span class="hljs-string">'dts'</span>, <span class="hljs-string">'rts'</span>];

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>Stuff from ReadStream, refactored for our usage:</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> kPoolSize = <span class="hljs-number">40</span> * <span class="hljs-number">1024</span>;
<span class="hljs-keyword">var</span> kMinPoolSpace = <span class="hljs-number">128</span>;

<span class="hljs-keyword">var</span> defaultSettings = {
  <span class="hljs-attr">baudRate</span>: <span class="hljs-number">9600</span>,
  <span class="hljs-attr">parity</span>: <span class="hljs-string">'none'</span>,
  <span class="hljs-attr">xon</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">xoff</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">xany</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">rtscts</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">hupcl</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">dataBits</span>: <span class="hljs-number">8</span>,
  <span class="hljs-attr">stopBits</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">bufferSize</span>: <span class="hljs-number">64</span> * <span class="hljs-number">1024</span>,
  <span class="hljs-attr">parser</span>: parsers.raw,
  <span class="hljs-attr">platformOptions</span>: SerialPortBinding.platformOptions
};

<span class="hljs-keyword">var</span> defaultSetFlags = {
  <span class="hljs-attr">brk</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">cts</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">dtr</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">dts</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">rts</span>: <span class="hljs-literal">true</span>
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>deprecate the lowercase version of these options next major release</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> LOWERCASE_OPTIONS = [
  <span class="hljs-string">'baudRate'</span>,
  <span class="hljs-string">'dataBits'</span>,
  <span class="hljs-string">'stopBits'</span>,
  <span class="hljs-string">'bufferSize'</span>,
  <span class="hljs-string">'platformOptions'</span>,
  <span class="hljs-string">'flowControl'</span>
];

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">correctOptions</span>(<span class="hljs-params">options</span>) </span>{
  LOWERCASE_OPTIONS.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
    <span class="hljs-keyword">var</span> lowerName = name.toLowerCase();
    <span class="hljs-keyword">if</span> (options.hasOwnProperty(lowerName)) {
      <span class="hljs-keyword">var</span> value = options[lowerName];
      <span class="hljs-keyword">delete</span> options[lowerName];
      options[name] = value;
    }
  });
  <span class="hljs-keyword">return</span> options;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SerialPort</span>(<span class="hljs-params">path, options, openImmediately, callback</span>) </span>{
  <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
  callback = args.pop();
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback !== <span class="hljs-string">'function'</span>) {
    callback = <span class="hljs-literal">null</span>;
  }

  options = (<span class="hljs-keyword">typeof</span> options !== <span class="hljs-string">'function'</span>) &amp;&amp; options || {};

  <span class="hljs-keyword">if</span> (openImmediately === <span class="hljs-literal">undefined</span> || openImmediately === <span class="hljs-literal">null</span>) {
    openImmediately = <span class="hljs-literal">true</span>;
  }

  stream.Stream.call(<span class="hljs-keyword">this</span>);
  callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._events.error) {
        <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, err);
      } <span class="hljs-keyword">else</span> {
        factory.emit(<span class="hljs-string">'error'</span>, err);
      }
    }
  }.bind(<span class="hljs-keyword">this</span>);

  <span class="hljs-keyword">if</span> (!path) {
    <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid port specified: '</span> + path));
  }
  <span class="hljs-keyword">this</span>.path = path;

  <span class="hljs-keyword">var</span> correctedOptions = correctOptions(options);
  <span class="hljs-keyword">var</span> settings = assign({}, defaultSettings, correctedOptions);

  <span class="hljs-keyword">if</span> (DATABITS.indexOf(settings.dataBits) === <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid "databits": '</span> + settings.dataBits));
  }

  <span class="hljs-keyword">if</span> (STOPBITS.indexOf(settings.stopBits) === <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid "stopbits": '</span> + settings.stopbits));
  }

  <span class="hljs-keyword">if</span> (PARITY.indexOf(settings.parity) === <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid "parity": '</span> + settings.parity));
  }

  <span class="hljs-keyword">var</span> fc = settings.flowControl;
  <span class="hljs-keyword">if</span> (fc === <span class="hljs-literal">true</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>Why!?</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    settings.rtscts = <span class="hljs-literal">true</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(fc)) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = fc.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
      <span class="hljs-keyword">var</span> fcSetting = fc[i].toLowerCase();
      <span class="hljs-keyword">if</span> (FLOWCONTROLS.indexOf(fcSetting) &gt; <span class="hljs-number">-1</span>) {
        settings[fcSetting] = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid flowControl option: '</span> + fcSetting));
      }
    }
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>TODO remove this option</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  settings.dataCallback = options.dataCallback || <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
    settings.parser(<span class="hljs-keyword">this</span>, data);
  }.bind(<span class="hljs-keyword">this</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>TODO remove this option</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  settings.disconnectedCallback = options.disconnectedCallback || <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.closing) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (!err) {
      err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Disconnected'</span>);
    }
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'disconnect'</span>, err);
  }.bind(<span class="hljs-keyword">this</span>);

  <span class="hljs-keyword">this</span>.fd = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">this</span>.paused = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">this</span>.opening = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">this</span>.closing = <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">if</span> (process.platform !== <span class="hljs-string">'win32'</span>) {
    <span class="hljs-keyword">this</span>.bufferSize = settings.bufferSize;
    <span class="hljs-keyword">this</span>.readable = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.reading = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">this</span>.options = settings;

  <span class="hljs-keyword">if</span> (openImmediately) {
    process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">this</span>.open(callback);
    }.bind(<span class="hljs-keyword">this</span>));
  }
}

factory.SerialPort = SerialPort;
util.inherits(SerialPort, stream.Stream);

SerialPort.prototype._error = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, callback</span>) </span>{
  <span class="hljs-keyword">if</span> (callback) {
    callback(error);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, error);
  }
};

SerialPort.prototype.open = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">callback</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isOpen()) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._error(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Port is already open'</span>), callback);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.opening) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._error(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Port is opening'</span>), callback);
  }

  <span class="hljs-keyword">this</span>.paused = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">this</span>.readable = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">this</span>.reading = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">this</span>.opening = <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  SerialPortBinding.open(<span class="hljs-keyword">this</span>.path, <span class="hljs-keyword">this</span>.options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, fd</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      debug(<span class="hljs-string">'SerialPortBinding.open had an error'</span>, err);
      <span class="hljs-keyword">return</span> self._error(err, callback);
    }
    self.fd = fd;
    self.paused = <span class="hljs-literal">false</span>;
    self.opening = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (process.platform !== <span class="hljs-string">'win32'</span>) {
      self.serialPoller = <span class="hljs-keyword">new</span> SerialPortBinding.SerialportPoller(self.fd, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        <span class="hljs-keyword">if</span> (!err) {
          self._read();
        } <span class="hljs-keyword">else</span> {
          self.disconnected(err);
        }
      });
      self.serialPoller.start();
    }

    self.emit(<span class="hljs-string">'open'</span>);
    <span class="hljs-keyword">if</span> (callback) { callback() }
  });
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>underlying code is written to update all options, but for now
only baud is respected as I don't want to duplicate all the option
verification code above</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">SerialPort.prototype.update = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">options, callback</span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isOpen()) {
    debug(<span class="hljs-string">'update attempted, but port is not open'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._error(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Port is not open'</span>), callback);
  }

  <span class="hljs-keyword">var</span> correctedOptions = correctOptions(options);
  <span class="hljs-keyword">var</span> settings = assign({}, defaultSettings, correctedOptions);
  <span class="hljs-keyword">this</span>.options.baudRate = settings.baudRate;

  SerialPortBinding.update(<span class="hljs-keyword">this</span>.fd, <span class="hljs-keyword">this</span>.options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._error(err, callback);
    }
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'open'</span>);
    <span class="hljs-keyword">if</span> (callback) { callback() }
  }.bind(<span class="hljs-keyword">this</span>));
};

SerialPort.prototype.isOpen = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fd !== <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-keyword">this</span>.closing;
};

SerialPort.prototype.write = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">buffer, callback</span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isOpen()) {
    debug(<span class="hljs-string">'write attempted, but port is not open'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._error(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Port is not open'</span>), callback);
  }

  <span class="hljs-keyword">if</span> (!Buffer.isBuffer(buffer)) {
    buffer = <span class="hljs-keyword">new</span> Buffer(buffer);
  }
  debug(<span class="hljs-string">'write data: '</span> + <span class="hljs-built_in">JSON</span>.stringify(buffer));

  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  SerialPortBinding.write(<span class="hljs-keyword">this</span>.fd, buffer, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
    <span class="hljs-keyword">if</span> (callback) {
      callback(err, results);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (err) {
        self.emit(<span class="hljs-string">'error'</span>, err);
      }
    }
  });
};

<span class="hljs-keyword">if</span> (process.platform !== <span class="hljs-string">'win32'</span>) {
  SerialPort.prototype._read = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">if</span> (!self.readable || self.paused || self.reading || <span class="hljs-keyword">this</span>.closing) {
      <span class="hljs-keyword">return</span>;
    }

    self.reading = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">if</span> (!self.pool || self.pool.length - self.pool.used &lt; kMinPoolSpace) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>discard the old pool. Can't add to the free list because
users might have references to slices on it.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      self.pool = <span class="hljs-keyword">new</span> Buffer(kPoolSize);
      self.pool.used = <span class="hljs-number">0</span>;
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>Grab another reference to the pool in the case that while we're in the
thread pool another read() finishes up the pool, and allocates a new
one.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> toRead = <span class="hljs-built_in">Math</span>.min(self.pool.length - self.pool.used, ~~self.bufferSize);
    <span class="hljs-keyword">var</span> start = self.pool.used;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">afterRead</span>(<span class="hljs-params">err, bytesRead, readPool, bytesRequested</span>) </span>{
      self.reading = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">if</span> (err.code &amp;&amp; err.code === <span class="hljs-string">'EAGAIN'</span>) {
          <span class="hljs-keyword">if</span> (!self.closing &amp;&amp; self.isOpen()) {
            self.serialPoller.start();
          }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>handle edge case were mac/unix doesn't clearly know the error.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (err.code &amp;&amp; (err.code === <span class="hljs-string">'EBADF'</span> || err.code === <span class="hljs-string">'ENXIO'</span> || (err.errno === <span class="hljs-number">-1</span> || err.code === <span class="hljs-string">'UNKNOWN'</span>))) {
          self.disconnected(err);
        } <span class="hljs-keyword">else</span> {
          self.fd = <span class="hljs-literal">null</span>;
          self.readable = <span class="hljs-literal">false</span>;
          self.emit(<span class="hljs-string">'error'</span>, err);
        }
      } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>Since we will often not read the number of bytes requested,
let's mark the ones we didn't need as available again.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        self.pool.used -= bytesRequested - bytesRead;

        <span class="hljs-keyword">if</span> (bytesRead === <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">if</span> (self.isOpen()) {
            self.serialPoller.start();
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">var</span> b = self.pool.slice(start, start + bytesRead);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>do not emit events if the stream is paused</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">if</span> (self.paused) {
            self.buffer = Buffer.concat([self.buffer, b]);
            <span class="hljs-keyword">return</span>;
          }
          self._emitData(b);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>do not emit events anymore after we declared the stream unreadable</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">if</span> (!self.readable) {
            <span class="hljs-keyword">return</span>;
          }
          self._read();
        }
      }
    }

    fs.read(self.fd, self.pool, self.pool.used, toRead, <span class="hljs-literal">null</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, bytesRead</span>) </span>{
      <span class="hljs-keyword">var</span> readPool = self.pool;
      <span class="hljs-keyword">var</span> bytesRequested = toRead;
      afterRead(err, bytesRead, readPool, bytesRequested);
    });

    self.pool.used += toRead;
  };

  SerialPort.prototype._emitData = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
    <span class="hljs-keyword">this</span>.options.dataCallback(data);
  };

  SerialPort.prototype.pause = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    self.paused = <span class="hljs-literal">true</span>;
  };

  SerialPort.prototype.resume = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    self.paused = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (self.buffer) {
      <span class="hljs-keyword">var</span> buffer = self.buffer;
      self.buffer = <span class="hljs-literal">null</span>;
      self._emitData(buffer);
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>No longer open?</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isOpen()) {
      <span class="hljs-keyword">return</span>;
    }

    self._read();
  };
} <span class="hljs-comment">// if !'win32'</span>

SerialPort.prototype.disconnected = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> fd = self.fd;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>send notification of disconnect</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (self.options.disconnectedCallback) {
    self.options.disconnectedCallback(err);
  } <span class="hljs-keyword">else</span> {
    self.emit(<span class="hljs-string">'disconnect'</span>, err);
  }
  self.paused = <span class="hljs-literal">true</span>;
  self.closing = <span class="hljs-literal">true</span>;

  self.emit(<span class="hljs-string">'close'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>clean up all other items</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  fd = self.fd;

  <span class="hljs-keyword">try</span> {
    SerialPortBinding.close(fd, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        debug(<span class="hljs-string">'Disconnect completed with error: '</span> + <span class="hljs-built_in">JSON</span>.stringify(err));
      } <span class="hljs-keyword">else</span> {
        debug(<span class="hljs-string">'Disconnect completed.'</span>);
      }
    });
  } <span class="hljs-keyword">catch</span> (e) {
    debug(<span class="hljs-string">'Disconnect completed with an exception: '</span> + <span class="hljs-built_in">JSON</span>.stringify(e));
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>TODO THIS IS CRAZY TOWN</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  self.removeAllListeners();

  self.closing = <span class="hljs-literal">false</span>;
  self.fd = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">if</span> (process.platform !== <span class="hljs-string">'win32'</span>) {
    self.readable = <span class="hljs-literal">false</span>;
    self.serialPoller.close();
  }
};

SerialPort.prototype.close = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">callback</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> fd = self.fd;

  <span class="hljs-keyword">if</span> (self.closing) {
    debug(<span class="hljs-string">'close attempted, but port is already closing'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._error(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Port is not open'</span>), callback);
  }

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isOpen()) {
    debug(<span class="hljs-string">'close attempted, but port is not open'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._error(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Port is not open'</span>), callback);
  }

  self.closing = <span class="hljs-literal">true</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>Stop polling before closing the port.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (process.platform !== <span class="hljs-string">'win32'</span>) {
    self.readable = <span class="hljs-literal">false</span>;
    self.serialPoller.close();
  }

  <span class="hljs-keyword">try</span> {
    SerialPortBinding.close(fd, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
      self.closing = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span> (err) {
        debug(<span class="hljs-string">'SerialPortBinding.close had an error'</span>, err);
        <span class="hljs-keyword">return</span> self._error(err, callback);
      }

      self.fd = <span class="hljs-literal">null</span>;
      self.emit(<span class="hljs-string">'close'</span>);
      <span class="hljs-keyword">if</span> (callback) { callback() }
      self.removeAllListeners();
    });
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-keyword">this</span>.closing = <span class="hljs-literal">false</span>;
    debug(<span class="hljs-string">'SerialPortBinding.close had an throwing error'</span>, err);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._error(err, callback);
  }
};

SerialPort.prototype.flush = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">callback</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> fd = self.fd;

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isOpen()) {
    debug(<span class="hljs-string">'flush attempted, but port is not open'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._error(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Port is not open'</span>), callback);
  }

  SerialPortBinding.flush(fd, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, result</span>) </span>{
    <span class="hljs-keyword">if</span> (callback) {
      callback(err, result);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (err) {
      self.emit(<span class="hljs-string">'error'</span>, err);
    }
  });
};

SerialPort.prototype.set = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">options, callback</span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isOpen()) {
    debug(<span class="hljs-string">'set attempted, but port is not open'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._error(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Port is not open'</span>), callback);
  }

  options = options || {};
  <span class="hljs-keyword">if</span> (!callback &amp;&amp; <span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'function'</span>) {
    callback = options;
    options = {};
  }

  <span class="hljs-keyword">var</span> settings = {};
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = SET_OPTIONS.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
    <span class="hljs-keyword">var</span> flag = SET_OPTIONS[i];
    <span class="hljs-keyword">if</span> (options[flag] !== <span class="hljs-literal">undefined</span>) {
      settings[flag] = options[flag];
    } <span class="hljs-keyword">else</span> {
      settings[flag] = defaultSetFlags[flag];
    }
  }

  SerialPortBinding.set(<span class="hljs-keyword">this</span>.fd, settings, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, result</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      debug(<span class="hljs-string">'SerialPortBinding.set had an error'</span>, err);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._error(err, callback);
    }
    <span class="hljs-keyword">if</span> (callback) { callback(<span class="hljs-literal">null</span>, result) }
  }.bind(<span class="hljs-keyword">this</span>));
};

SerialPort.prototype.drain = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">callback</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> fd = <span class="hljs-keyword">this</span>.fd;

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isOpen()) {
    debug(<span class="hljs-string">'drain attempted, but port is not open'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._error(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Port is not open'</span>), callback);
  }

  SerialPortBinding.drain(fd, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, result</span>) </span>{
    <span class="hljs-keyword">if</span> (callback) {
      callback(err, result);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (err) {
      self.emit(<span class="hljs-string">'error'</span>, err);
    }
  });
};

<span class="hljs-built_in">module</span>.exports = factory;

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>serialport-basic.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "node_modules/browser-serialport/test/serialport-basic.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>serialport-basic.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">'use strict'</span>;

<span class="hljs-keyword">var</span> sinon = <span class="hljs-built_in">require</span>(<span class="hljs-string">'sinon'</span>);
<span class="hljs-keyword">var</span> chai = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>);
<span class="hljs-keyword">var</span> without = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash/array/without'</span>);
<span class="hljs-keyword">var</span> expect = chai.expect;

<span class="hljs-keyword">var</span> MockedSerialPort = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../'</span>);
<span class="hljs-keyword">var</span> SerialPort = MockedSerialPort.SerialPort;

<span class="hljs-keyword">var</span> options;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unset</span>(<span class="hljs-params">msg</span>)</span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(msg);
  };
}

<span class="hljs-keyword">var</span> serialListeners = [];

<span class="hljs-keyword">var</span> hardware = {
  <span class="hljs-attr">ports</span>: {},
  <span class="hljs-attr">createPort</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">path</span>)</span>{
    <span class="hljs-keyword">this</span>.ports[path] = <span class="hljs-literal">true</span>;
  },
  <span class="hljs-attr">reset</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">this</span>.ports = {};
    <span class="hljs-keyword">this</span>.onReceive = unset(<span class="hljs-string">'onreceive unset'</span>);
    <span class="hljs-keyword">this</span>.onReceiveError = unset(<span class="hljs-string">'onReceiveError unset'</span>);
  },
  <span class="hljs-attr">onReceive</span>: unset(<span class="hljs-string">'onReceive unset'</span>),
  <span class="hljs-attr">onReceiveError</span>: unset(<span class="hljs-string">'onReceiveError unset'</span>),
  <span class="hljs-attr">emitData</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">buffer</span>)</span>{
    process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
      <span class="hljs-keyword">var</span> readInfo = {<span class="hljs-attr">data</span>: MockedSerialPort.buffer2ArrayBuffer(buffer), <span class="hljs-attr">connectionId</span>: <span class="hljs-number">1</span>};
      serialListeners.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>)</span>{
        cb(readInfo);
      });
    });
  },
  <span class="hljs-attr">disconnect</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">path</span>)</span>{
    <span class="hljs-keyword">this</span>.ports[path] = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> info = {<span class="hljs-attr">error</span>: <span class="hljs-string">'disconnected'</span>, <span class="hljs-attr">connectionId</span>: <span class="hljs-number">1</span>};
    <span class="hljs-keyword">this</span>.onReceiveError(info);
  },
  <span class="hljs-attr">timeout</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">path</span>)</span>{
    <span class="hljs-keyword">this</span>.ports[path] = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> info = {<span class="hljs-attr">error</span>: <span class="hljs-string">'timeout'</span>, <span class="hljs-attr">connectionId</span>: <span class="hljs-number">1</span>};
    <span class="hljs-keyword">this</span>.onReceiveError(info);
  },
  <span class="hljs-attr">loseDevice</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">path</span>)</span>{
    <span class="hljs-keyword">this</span>.ports[path] = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> info = {<span class="hljs-attr">error</span>: <span class="hljs-string">'device_lost'</span>, <span class="hljs-attr">connectionId</span>: <span class="hljs-number">1</span>};
    <span class="hljs-keyword">this</span>.onReceiveError(info);
  },
  <span class="hljs-attr">systemError</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">path</span>)</span>{
    <span class="hljs-keyword">this</span>.ports[path] = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> info = {<span class="hljs-attr">error</span>: <span class="hljs-string">'system_error'</span>, <span class="hljs-attr">connectionId</span>: <span class="hljs-number">1</span>};
    <span class="hljs-keyword">this</span>.onReceiveError(info);
  }
};

describe(<span class="hljs-string">'SerialPort'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> sandbox;

  beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    sandbox = sinon.sandbox.create();

    global.chrome = { <span class="hljs-attr">runtime</span>: { <span class="hljs-attr">lastError</span>: <span class="hljs-literal">null</span> } };

    serialListeners = [];

    options = {
      <span class="hljs-attr">serial</span>: {
        <span class="hljs-attr">connect</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">path, options, cb</span>)</span>{
          <span class="hljs-keyword">if</span> (!hardware.ports[path]) {
            global.chrome.runtime.lastError = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>({<span class="hljs-attr">message</span>: <span class="hljs-string">'Failed to connect to the port.'</span>});
          }

          chai.assert.ok(options.bitrate, <span class="hljs-string">'baudrate not set'</span>);
          chai.assert.ok(options.dataBits, <span class="hljs-string">'databits not set'</span>);
          chai.assert.ok(options.parityBit, <span class="hljs-string">'parity not set'</span>);
          chai.assert.ok(options.stopBits, <span class="hljs-string">'stopbits not set'</span>);
          chai.assert.isBoolean(options.ctsFlowControl, <span class="hljs-string">'flowcontrol not set'</span>);

          cb({
            <span class="hljs-attr">bitrate</span>: <span class="hljs-number">9600</span>,
            <span class="hljs-attr">bufferSize</span>: <span class="hljs-number">4096</span>,
            <span class="hljs-attr">connectionId</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">ctsFlowControl</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">dataBits</span>: <span class="hljs-string">'eight'</span>,
            <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>,
            <span class="hljs-attr">parityBit</span>: <span class="hljs-string">'no'</span>,
            <span class="hljs-attr">paused</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">persistent</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">receiveTimeout</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">sendTimeout</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">stopBits</span>: <span class="hljs-string">'one'</span>
           });
        },
        <span class="hljs-attr">onReceive</span>: {
          <span class="hljs-attr">addListener</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>)</span>{
            serialListeners.push(cb);
          },
          <span class="hljs-attr">removeListener</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>)</span>{
            serialListeners = without(serialListeners, cb);
          }
        },
        <span class="hljs-attr">onReceiveError</span>: {
          <span class="hljs-attr">addListener</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>)</span>{
            hardware.onReceiveError = cb;
          }
        },
        <span class="hljs-attr">send</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">connectionId, buffer, cb</span>)</span>{

        },
        <span class="hljs-attr">disconnect</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">connectionId, cb</span>)</span>{
          cb();
        },
        <span class="hljs-attr">setControlSignals</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">connectionId, options, cb</span>)</span>{
          cb();
        }
      }
    };
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Create a port for fun and profit</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    hardware.reset();
    hardware.createPort(<span class="hljs-string">'/dev/exists'</span>);
  });

  afterEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    options = <span class="hljs-literal">null</span>;

    sandbox.restore();
  });

  describe(<span class="hljs-string">'Constructor'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    it(<span class="hljs-string">'opens the port immediately'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        expect(err).to.not.be.ok;
        done();
      });
    });

    it(<span class="hljs-string">'emits the open event'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options);
      port.on(<span class="hljs-string">'open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        done();
      });
    });

    it.skip(<span class="hljs-string">'emits an error on the factory when erroring without a callback'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>finish the test on error</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      MockedSerialPort.once(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        chai.assert.isDefined(err, <span class="hljs-string">'didn\'t get an error'</span>);
        done();
      });

      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/johnJacobJingleheimerSchmidt'</span>);
    });

    it(<span class="hljs-string">'emits an error on the serialport when explicit error handler present'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/johnJacobJingleheimerSchmidt'</span>, options);

      port.once(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
        chai.assert.isDefined(err);
        done();
      });
    });

    it(<span class="hljs-string">'errors with invalid databits'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> errorCallback = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        chai.assert.isDefined(err, <span class="hljs-string">'err is not defined'</span>);
        done();
      };

      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, { <span class="hljs-attr">databits</span> : <span class="hljs-number">19</span> }, <span class="hljs-literal">false</span>, errorCallback);
    });

    it(<span class="hljs-string">'errors with invalid stopbits'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> errorCallback = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        chai.assert.isDefined(err, <span class="hljs-string">'err is not defined'</span>);
        done();
      };

      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, { <span class="hljs-attr">stopbits</span> : <span class="hljs-number">19</span> }, <span class="hljs-literal">false</span>, errorCallback);
    });

    it(<span class="hljs-string">'errors with invalid parity'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> errorCallback = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        chai.assert.isDefined(err, <span class="hljs-string">'err is not defined'</span>);
        done();
      };

      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, { <span class="hljs-attr">parity</span> : <span class="hljs-string">'pumpkins'</span> }, <span class="hljs-literal">false</span>, errorCallback);
    });

    it(<span class="hljs-string">'errors with invalid flow control'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> errorCallback = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        chai.assert.isDefined(err, <span class="hljs-string">'err is not defined'</span>);
        done();
      };

      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, { <span class="hljs-attr">flowcontrol</span> : [<span class="hljs-string">'pumpkins'</span>] }, <span class="hljs-literal">false</span>, errorCallback);
    });

    it(<span class="hljs-string">'errors with invalid path'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> errorCallback = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        chai.assert.isDefined(err, <span class="hljs-string">'err is not defined'</span>);
        done();
      };

      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>, errorCallback);
    });

    it(<span class="hljs-string">'allows optional options'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      global.chrome.serial = options.serial;
      <span class="hljs-keyword">var</span> cb = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{};
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, cb);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>console.log(port);</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      expect(<span class="hljs-keyword">typeof</span> port.options).to.eq(<span class="hljs-string">'object'</span>);
      <span class="hljs-keyword">delete</span> global.chrome.serial;
      done();
    });

  });

  describe(<span class="hljs-string">'Functions'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    it(<span class="hljs-string">'write errors when serialport not open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> cb = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{};
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options, <span class="hljs-literal">false</span>, cb);
      port.write(<span class="hljs-literal">null</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
        chai.assert.isDefined(err, <span class="hljs-string">'err is not defined'</span>);
        done();
      });
    });

    it(<span class="hljs-string">'close errors when serialport not open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> cb = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{};
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options, <span class="hljs-literal">false</span>, cb);
      port.close(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
        chai.assert.isDefined(err, <span class="hljs-string">'err is not defined'</span>);
        done();
      });
    });

    it(<span class="hljs-string">'flush errors when serialport not open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> cb = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{};
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options, <span class="hljs-literal">false</span>, cb);
      port.flush(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
        chai.assert.isDefined(err, <span class="hljs-string">'err is not defined'</span>);
        done();
      });
    });

    it(<span class="hljs-string">'set errors when serialport not open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> cb = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{};
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options, <span class="hljs-literal">false</span>, cb);
      port.set({}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
        chai.assert.isDefined(err, <span class="hljs-string">'err is not defined'</span>);
        done();
      });
    });

    it(<span class="hljs-string">'drain errors when serialport not open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> cb = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{};
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options, <span class="hljs-literal">false</span>, cb);
      port.drain(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
        chai.assert.isDefined(err, <span class="hljs-string">'err is not defined'</span>);
        done();
      });
    });

  });

  describe(<span class="hljs-string">'reading data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    it(<span class="hljs-string">'emits data events by default'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> testData = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-string">'I am a really short string'</span>);
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        port.once(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">recvData</span>) </span>{
          expect(recvData).to.eql(testData);
          done();
        });
        hardware.emitData(testData);
      });
    });

    it(<span class="hljs-string">'calls the dataCallback if set'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> testData = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-string">'I am a really short string'</span>);
      options.dataCallback = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">recvData</span>) </span>{
        expect(recvData).to.eql(testData);
        done();
      };

      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        hardware.emitData(testData);
      });
    });

  });

  describe(<span class="hljs-string">'#open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    it(<span class="hljs-string">'passes the port to the bindings'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> openSpy = sandbox.spy(options.serial, <span class="hljs-string">'connect'</span>);
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options, <span class="hljs-literal">false</span>);
      port.open(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        expect(err).to.not.be.ok;
        expect(openSpy.calledWith(<span class="hljs-string">'/dev/exists'</span>));
        done();
      });
    });

    it(<span class="hljs-string">'calls back an error when opening an invalid port'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/unhappy'</span>, options, <span class="hljs-literal">false</span>);
      port.open(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        expect(err).to.be.ok;
        done();
      });
    });

    it(<span class="hljs-string">'emits data after being reopened'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> data = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-string">'Howdy!'</span>);
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        port.close(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
          port.open(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            port.once(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) </span>{
              expect(res).to.eql(data);
              done();
            });
            hardware.emitData(data);
          });
        });
      });
    });

    it(<span class="hljs-string">'does not emit data twice if reopened'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> data = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-string">'Howdy!'</span>);
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        port.close(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
          port.open(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>;
            port.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) </span>{
              count++;
            });
            hardware.emitData(data);

            setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
              expect(count).to.equal(<span class="hljs-number">1</span>);
              done();
            }, <span class="hljs-number">200</span>);
          });
        });
      });
    });
  });

  describe(<span class="hljs-string">'#send'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    it(<span class="hljs-string">'errors when writing a closed port'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options, <span class="hljs-literal">false</span>);
      port.write(<span class="hljs-keyword">new</span> Buffer(<span class="hljs-string">''</span>), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
        expect(err).to.be.ok;
        done();
      });
    });

  });

  describe(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    it(<span class="hljs-string">'fires a close event when it\'s closed'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> closeSpy = sandbox.spy();
        port.on(<span class="hljs-string">'close'</span>, closeSpy);
        port.close();
        expect(closeSpy.calledOnce);
        done();
      });
    });

    it(<span class="hljs-string">'fires a close event after being reopened'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> closeSpy = sandbox.spy();
        port.on(<span class="hljs-string">'close'</span>, closeSpy);
        port.close();
        port.open();
        port.close();
        expect(closeSpy.calledTwice);
        done();
      });
    });

    it(<span class="hljs-string">'errors when closing an invalid port'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options, <span class="hljs-literal">false</span>);
      port.close(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
        expect(err).to.be.ok;
        done();
      });
    });

    it(<span class="hljs-string">'emits a close event'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        port.on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
          done();
        });
        port.close();
      });
    });
  });

  describe(<span class="hljs-string">'disconnect'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    it(<span class="hljs-string">'fires a disconnect event'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      options.disconnectedCallback = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
          expect(err).to.be.ok;
          done();
        };
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        hardware.disconnect(<span class="hljs-string">'/dev/exists'</span>);
      });
    });

    it(<span class="hljs-string">'emits a disconnect event'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
      <span class="hljs-keyword">var</span> port = <span class="hljs-keyword">new</span> SerialPort(<span class="hljs-string">'/dev/exists'</span>, options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        port.on(<span class="hljs-string">'disconnect'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
          done();
        });
        hardware.disconnect(<span class="hljs-string">'/dev/exists'</span>);
      });
    });
  });

});


</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

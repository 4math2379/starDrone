<!DOCTYPE html>
<html>
<head>
  <title>nan_object_wrap.h</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/nan/nan_object_wrap.h";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>nan_object_wrap.h</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<div class="dox">
<div class="summary">
<hr>
<p>NAN - Native Abstractions for Node.js</p>
</div>
<div class="body">
<p>Copyright (c) 2016 NAN contributors</p>
<p>MIT License <a href="https://github.com/nodejs/nan/blob/master/LICENSE.md">https://github.com/nodejs/nan/blob/master/LICENSE.md</a></p>
<hr>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="c">
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> NAN_OBJECT_WRAP_H_</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NAN_OBJECT_WRAP_H_</span>

<span class="hljs-keyword">class</span> ObjectWrap {
 <span class="hljs-keyword">public</span>:
  ObjectWrap() {
    refs_ = <span class="hljs-number">0</span>;
  }


  <span class="hljs-keyword">virtual</span> ~ObjectWrap() {
    <span class="hljs-keyword">if</span> (persistent().IsEmpty()) {
      <span class="hljs-keyword">return</span>;
    }

    assert(persistent().IsNearDeath());
    persistent().ClearWeak();
    persistent().Reset();
  }


  <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> T&gt;
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> T* <span class="hljs-title">Unwrap</span><span class="hljs-params">(v8::Local&lt;v8::Object&gt; object)</span> </span>{
    assert(!object.IsEmpty());
    assert(object-&gt;InternalFieldCount() &gt; <span class="hljs-number">0</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Cast to ObjectWrap before casting to T.  A direct cast from void
to T won't work right when T has more than one base class.</p>

        </td>
        <td class="code highlight">
          <pre class="c">    <span class="hljs-keyword">void</span>* ptr = GetInternalFieldPointer(object, <span class="hljs-number">0</span>);
    ObjectWrap* wrap = <span class="hljs-keyword">static_cast</span>&lt;ObjectWrap*&gt;(ptr);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">static_cast</span>&lt;T*&gt;(wrap);
  }


  <span class="hljs-keyword">inline</span> v8::Local&lt;v8::Object&gt; handle() {
    <span class="hljs-keyword">return</span> New(persistent());
  }


  <span class="hljs-keyword">inline</span> Persistent&lt;v8::Object&gt;&amp; persistent() {
    <span class="hljs-keyword">return</span> handle_;
  }


 <span class="hljs-keyword">protected</span>:
  <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Wrap</span><span class="hljs-params">(v8::Local&lt;v8::Object&gt; object)</span> </span>{
    assert(persistent().IsEmpty());
    assert(object-&gt;InternalFieldCount() &gt; <span class="hljs-number">0</span>);
    SetInternalFieldPointer(object, <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>);
    persistent().Reset(object);
    MakeWeak();
  }

<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(V8_MAJOR_VERSION) &amp;&amp; (V8_MAJOR_VERSION &gt; 4 ||                      \
  (V8_MAJOR_VERSION == 4 &amp;&amp; defined(V8_MINOR_VERSION) &amp;&amp; V8_MINOR_VERSION &gt;= 3))</span>

  <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">MakeWeak</span><span class="hljs-params">()</span> </span>{
    persistent().v8::PersistentBase&lt;v8::Object&gt;::SetWeak(
        <span class="hljs-keyword">this</span>, WeakCallback, v8::WeakCallbackType::kParameter);
    persistent().MarkIndependent();
  }

<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> NODE_MODULE_VERSION &gt; NODE_0_10_MODULE_VERSION</span>

  <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">MakeWeak</span><span class="hljs-params">()</span> </span>{
    persistent().v8::PersistentBase&lt;v8::Object&gt;::SetWeak(<span class="hljs-keyword">this</span>, WeakCallback);
    persistent().MarkIndependent();
  }

<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>

  <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">MakeWeak</span><span class="hljs-params">()</span> </span>{
    persistent().persistent.MakeWeak(<span class="hljs-keyword">this</span>, WeakCallback);
    persistent().MarkIndependent();
  }

<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<div class="dox">
<div class="summary">
<p>Ref() marks the object as being attached to an event loop.
Refed objects will not be garbage collected, even if
all references are lost.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="c">  <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Ref</span><span class="hljs-params">()</span> </span>{
    assert(!persistent().IsEmpty());
    persistent().ClearWeak();
    refs_++;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<div class="dox">
<div class="summary">
<p>Unref() marks an object as detached from the event loop.  This is its
default state.  When an object with a &quot;weak&quot; reference changes from
attached to detached state it will be freed. Be careful not to access
the object after making this call as it might be gone!
(A &quot;weak reference&quot; means an object that only has a
persistant handle.)</p>
</div>
<div class="body">
<p>DO NOT CALL THIS FROM DESTRUCTOR</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="c">  <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Unref</span><span class="hljs-params">()</span> </span>{
    assert(!persistent().IsEmpty());
    assert(!persistent().IsWeak());
    assert(refs_ &gt; <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (--refs_ == <span class="hljs-number">0</span>)
      MakeWeak();
  }

  <span class="hljs-keyword">int</span> refs_;  <span class="hljs-comment">// ro</span>

 <span class="hljs-keyword">private</span>:
  NAN_DISALLOW_ASSIGN_COPY_MOVE(ObjectWrap)
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(V8_MAJOR_VERSION) &amp;&amp; (V8_MAJOR_VERSION &gt; 4 ||                      \
  (V8_MAJOR_VERSION == 4 &amp;&amp; defined(V8_MINOR_VERSION) &amp;&amp; V8_MINOR_VERSION &gt;= 3))</span>

  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
  <span class="hljs-title">WeakCallback</span><span class="hljs-params">(v8::WeakCallbackInfo&lt;ObjectWrap&gt; <span class="hljs-keyword">const</span>&amp; info)</span> </span>{
    ObjectWrap* wrap = info.GetParameter();
    assert(wrap-&gt;refs_ == <span class="hljs-number">0</span>);
    assert(wrap-&gt;handle_.IsNearDeath());
    wrap-&gt;handle_.Reset();
    <span class="hljs-keyword">delete</span> wrap;
  }

<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> NODE_MODULE_VERSION &gt; NODE_0_10_MODULE_VERSION</span>

  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
  <span class="hljs-title">WeakCallback</span><span class="hljs-params">(v8::WeakCallbackData&lt;v8::Object, ObjectWrap&gt; <span class="hljs-keyword">const</span>&amp; data)</span> </span>{
    ObjectWrap* wrap = data.GetParameter();
    assert(wrap-&gt;refs_ == <span class="hljs-number">0</span>);
    assert(wrap-&gt;handle_.IsNearDeath());
    wrap-&gt;handle_.Reset();
    <span class="hljs-keyword">delete</span> wrap;
  }

<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>

  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WeakCallback</span><span class="hljs-params">(v8::Persistent&lt;v8::Value&gt; value, <span class="hljs-keyword">void</span> *data)</span> </span>{
    ObjectWrap *wrap = <span class="hljs-keyword">static_cast</span>&lt;ObjectWrap*&gt;(data);
    assert(wrap-&gt;refs_ == <span class="hljs-number">0</span>);
    assert(wrap-&gt;handle_.IsNearDeath());
    wrap-&gt;handle_.Reset();
    <span class="hljs-keyword">delete</span> wrap;
  }

<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
  Persistent&lt;v8::Object&gt; handle_;
};


<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  <span class="hljs-comment">// NAN_OBJECT_WRAP_H_</span></span>

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
